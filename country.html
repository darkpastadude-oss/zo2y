<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex">
  <title>Zo2y - Country</title>
  <meta name="description" content="Country details, travel lists, and travel reviews.">
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --white: #fff;
      --border: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      padding: 0 12px 24px;
    }
    a { color: inherit; text-decoration: none; }
    .top {
      max-width: 1100px;
      margin: 0 auto;
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(11,22,51,0.9);
      backdrop-filter: blur(8px);
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .top img { height: 34px; border-radius: 8px; }
    .pill {
      border: 1px solid var(--border);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill.active { color: var(--accent); }
    .acct {
      margin-left: auto;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .hero, .reviews {
      max-width: 1100px;
      margin: 14px auto 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(160deg, rgba(23,43,88,0.92), rgba(19,35,71,0.95));
    }
    .hero {
      padding: 14px;
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 14px;
      align-items: start;
    }
    .hero-left {
      display: grid;
      gap: 10px;
    }
    .photo-wrap {
      width: 100%;
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #10224a;
    }
    .photo-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .flag-wrap {
      width: 104px;
      height: 104px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(245, 158, 11, 0.7);
      background: rgba(9, 20, 44, 0.9);
      padding: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .flag-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      display: block;
    }
    h1 { margin: 0 0 6px; font-size: 30px; }
    .meta {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
    }
    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .chip {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: #dce8ff;
    }
    .acts {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .btn {
      height: 38px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: var(--white);
      padding: 0 12px;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn.active {
      border-color: rgba(34,197,94,0.6);
      color: #86efac;
      background: rgba(22,163,74,0.2);
    }
    .reviews { padding: 14px; }
    .stats {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .s {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      min-width: 120px;
    }
    .sv { font-size: 22px; font-weight: 800; }
    .sl { font-size: 12px; color: var(--muted); }
    .list { display: grid; gap: 8px; }
    .r {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.03);
    }
    .rh { display: flex; justify-content: space-between; gap: 8px; }
    .ru { font-weight: 700; }
    .rd { color: var(--muted); font-size: 12px; }
    .rs { color: #ffbf3f; font-size: 13px; margin-top: 4px; }
    .rc { margin-top: 8px; font-size: 14px; line-height: 1.45; }
    .ra { margin-top: 8px; display: flex; gap: 6px; }
    .ra button {
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
    }
    .form {
      margin-top: 14px;
      border-top: 1px solid var(--border);
      padding-top: 12px;
    }
    .stars { display: flex; gap: 4px; margin: 8px 0; }
    .star {
      font-size: 22px;
      color: #516b9b;
      cursor: pointer;
      user-select: none;
    }
    .star.on { color: #ffbf3f; }
    textarea {
      width: 100%;
      min-height: 90px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #10224a;
      color: #fff;
      padding: 10px;
      resize: vertical;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .empty { color: var(--muted); text-align: center; padding: 14px; }
    .toast {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 10px;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
    }
    .ok { background: #10b981; }
    .err { background: #ef4444; }
    .inf { background: #3b82f6; }
    @media (max-width: 760px) {
      .hero {
        grid-template-columns: 1fr;
      }
      h1 { font-size: 24px; }
      .flag-wrap {
        width: 88px;
        height: 88px;
      }
    }
  </style>
</head>
<body>
  <header class="top">
    <a href="index.html"><img src="images/logo.png" alt="Zo2y"></a>
    <a class="pill" href="travel.html"><i class="fas fa-chevron-left"></i> Back</a>
    <a class="pill active" href="#">Country</a>
    <button id="acctBtn" class="acct"><i class="fas fa-user"></i> Account</button>
  </header>

  <section class="hero">
    <div class="hero-left">
      <div class="photo-wrap">
        <img id="photo" src="images/logo.png" alt="Country photo">
      </div>
      <div class="flag-wrap">
        <img id="flag" src="images/logo.png" alt="Country flag">
      </div>
    </div>
    <div>
      <h1 id="title">Loading...</h1>
      <div id="meta" class="meta"></div>
      <div id="chips" class="chips"></div>
      <div class="acts">
        <button class="btn" data-list="favorites">Favorites</button>
        <button class="btn" data-list="visited">Visited</button>
        <button class="btn" data-list="bucketlist">Bucket List</button>
        <a id="mapBtn" class="btn" href="travel.html"><i class="fas fa-map-location-dot"></i> Open in Maps</a>
      </div>
    </div>
  </section>

  <section class="reviews">
    <h2 style="margin:0 0 8px">Travel Reviews</h2>
    <div class="stats">
      <div class="s"><div id="avg" class="sv">-</div><div class="sl">Average</div></div>
      <div class="s"><div id="count" class="sv">0</div><div class="sl">Reviews</div></div>
    </div>
    <div id="reviewList" class="list"><div class="empty">Loading reviews...</div></div>
    <div class="form">
      <div id="authMsg" class="empty" style="display:none">Please <a href="login.html">sign in</a> to leave a review.</div>
      <form id="reviewForm" style="display:none">
        <div style="font-size:13px;color:var(--muted)">Your rating</div>
        <div class="stars" id="stars"></div>
        <textarea id="comment" maxlength="500" placeholder="Share your travel experience..."></textarea>
        <div class="row">
          <button class="btn" type="submit" id="saveBtn">Submit Review</button>
          <button class="btn" type="button" id="cancelBtn" style="display:none">Cancel Edit</button>
        </div>
      </form>
    </div>
  </section>

  <script>
  (() => {
    const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';

    let client = null;
    const formatter = new Intl.NumberFormat('en-US');
    const params = new URLSearchParams(window.location.search);
    const state = {
      code: String(params.get('code') || '').trim().toUpperCase(),
      user: null,
      reviews: [],
      users: new Map(),
      rating: 0,
      editId: null,
      status: { favorites: false, visited: false, bucketlist: false }
    };

    const ESCAPE_MAP = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };

    function escapeHtml(value) {
      return String(value || '').replace(/[&<>"']/g, (ch) => ESCAPE_MAP[ch] || ch);
    }

    function safeCode(value) {
      return String(value || '').trim().toUpperCase();
    }

    function buildCountryPhotoUrl(name, code) {
      const safeName = String(name || '').trim().replace(/\s+/g, ',');
      const safeCountryCode = safeCode(code) || 'XX';
      if (!safeName) return '';
      return `https://loremflickr.com/1200/1200/${encodeURIComponent(safeName)},country,landscape?lock=${encodeURIComponent(safeCountryCode)}`;
    }

    function showToast(message, type = 'inf') {
      const node = document.createElement('div');
      node.className = `toast ${type}`;
      node.textContent = message;
      document.body.appendChild(node);
      window.setTimeout(() => node.remove(), 1800);
    }

    function renderStars(ratingValue) {
      const safe = Math.max(1, Math.min(5, Number(ratingValue || 0)));
      return '&#9733;'.repeat(safe) + '&#9734;'.repeat(5 - safe);
    }

    async function ensureClient() {
      if (client) return client;
      for (let i = 0; i < 20; i += 1) {
        if (window.supabase && typeof window.supabase.createClient === 'function') {
          client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
          });
          return client;
        }
        await new Promise((resolve) => setTimeout(resolve, 120));
      }
      return null;
    }

    function updateAccountButton() {
      const btn = document.getElementById('acctBtn');
      if (!btn) return;
      if (state.user) {
        btn.innerHTML = '<i class="fas fa-user"></i> Profile';
        btn.onclick = () => { window.location.href = 'profile.html'; };
        return;
      }
      btn.innerHTML = '<i class="fas fa-user"></i> Account';
      btn.onclick = () => { window.location.href = 'login.html'; };
    }

    function syncReviewFormVisibility() {
      const form = document.getElementById('reviewForm');
      const authMsg = document.getElementById('authMsg');
      form.style.display = state.user ? 'block' : 'none';
      authMsg.style.display = state.user ? 'none' : 'block';
    }

    async function syncAuth() {
      const sb = await ensureClient();
      if (!sb) {
        updateAccountButton();
        return;
      }
      try {
        const { data } = await sb.auth.getUser();
        state.user = data && data.user ? data.user : null;
      } catch (_error) {
        state.user = null;
      }
      updateAccountButton();
      syncReviewFormVisibility();
      await loadListStatus();
      sb.auth.onAuthStateChange((_event, session) => {
        state.user = session && session.user ? session.user : null;
        updateAccountButton();
        syncReviewFormVisibility();
        void loadListStatus();
      });
    }

    async function loadCountry() {
      if (!state.code) {
        window.location.href = 'travel.html';
        return;
      }
      const response = await fetch(`https://restcountries.com/v3.1/alpha/${encodeURIComponent(state.code)}?fields=name,cca2,cca3,capital,region,subregion,population,flags,languages,currencies,maps`);
      if (!response.ok) {
        document.getElementById('title').textContent = 'Country unavailable';
        return;
      }
      const payload = await response.json();
      const row = Array.isArray(payload) ? payload[0] : payload;
      const code = safeCode(row && (row.cca2 || row.cca3 || state.code));
      state.code = code;

      const name = String(row && row.name && (row.name.common || row.name.official) || code).trim();
      const capital = Array.isArray(row && row.capital)
        ? String(row.capital[0] || '').trim()
        : String(row && row.capital || '').trim();
      const region = String(row && row.region || '').trim();
      const subregion = String(row && row.subregion || '').trim();
      const population = Number(row && row.population || 0);
      const flag = String(row && row.flags && (row.flags.png || row.flags.svg) || '').trim() || `https://flagcdn.com/w640/${code.toLowerCase()}.png`;
      const photo = buildCountryPhotoUrl(name, code) || flag;
      const mapsUrl = String(row && row.maps && row.maps.googleMaps || '').trim();

      const languages = row && row.languages && typeof row.languages === 'object'
        ? Object.values(row.languages).slice(0, 4).join(', ')
        : '';
      const currencies = row && row.currencies && typeof row.currencies === 'object'
        ? Object.keys(row.currencies).slice(0, 3).join(', ')
        : '';

      document.getElementById('title').textContent = name;
      document.getElementById('meta').innerHTML = `${escapeHtml(capital ? `Capital: ${capital}` : 'Capital: N/A')}<br>${escapeHtml([region, subregion].filter(Boolean).join(' | ') || 'Region unavailable')}<br>Population: ${escapeHtml(formatter.format(Number.isFinite(population) ? population : 0))}`;
      document.getElementById('photo').src = photo;
      document.getElementById('photo').alt = `${name} photo`;
      document.getElementById('flag').src = flag;
      document.getElementById('flag').alt = `${name} flag`;

      const chips = [];
      if (languages) chips.push(`Languages: ${languages}`);
      if (currencies) chips.push(`Currencies: ${currencies}`);
      document.getElementById('chips').innerHTML = chips
        .map((value) => `<span class="chip">${escapeHtml(value)}</span>`)
        .join('');

      const mapBtn = document.getElementById('mapBtn');
      if (mapsUrl) {
        mapBtn.href = mapsUrl;
        mapBtn.target = '_blank';
        mapBtn.rel = 'noopener';
      } else {
        mapBtn.href = 'travel.html';
      }
    }

    function syncListButtons() {
      document.querySelectorAll('button[data-list]').forEach((button) => {
        const key = button.getAttribute('data-list');
        button.classList.toggle('active', !!state.status[key]);
      });
    }

    async function loadListStatus() {
      state.status = { favorites: false, visited: false, bucketlist: false };
      const sb = await ensureClient();
      if (!sb || !state.user || !state.user.id || !state.code) {
        syncListButtons();
        return;
      }
      const { data, error } = await sb
        .from('travel_list_items')
        .select('list_type')
        .eq('user_id', state.user.id)
        .eq('country_code', state.code)
        .in('list_type', ['favorites', 'visited', 'bucketlist']);
      if (!error && Array.isArray(data)) {
        data.forEach((row) => {
          const key = String(row && row.list_type || '').toLowerCase();
          if (key in state.status) state.status[key] = true;
        });
      }
      syncListButtons();
    }

    async function toggleList(listType) {
      if (!(listType in state.status)) return;
      if (!state.user || !state.user.id) {
        showToast('Please sign in', 'inf');
        return;
      }
      const sb = await ensureClient();
      if (!sb) return;

      const next = !state.status[listType];
      state.status[listType] = next;
      syncListButtons();

      try {
        if (next) {
          const { error } = await sb
            .from('travel_list_items')
            .insert({ user_id: state.user.id, country_code: state.code, list_type: listType });
          if (error && error.code !== '23505') throw error;
          showToast('Saved', 'ok');
        } else {
          const { error } = await sb
            .from('travel_list_items')
            .delete()
            .eq('user_id', state.user.id)
            .eq('country_code', state.code)
            .eq('list_type', listType);
          if (error) throw error;
          showToast('Removed', 'inf');
        }
      } catch (_error) {
        state.status[listType] = !next;
        syncListButtons();
        showToast('Could not update list', 'err');
      }
    }

    async function loadUsers(userIds) {
      const sb = await ensureClient();
      if (!sb || !Array.isArray(userIds) || !userIds.length) return;
      const { data, error } = await sb
        .from('user_profiles')
        .select('id,username,full_name')
        .in('id', userIds);
      if (error || !Array.isArray(data)) return;
      data.forEach((row) => {
        const id = String(row && row.id || '').trim();
        if (!id) return;
        state.users.set(id, {
          username: String(row && row.username || '').trim(),
          fullName: String(row && row.full_name || '').trim()
        });
      });
    }

    function resolveUsername(userId) {
      const record = state.users.get(String(userId || '').trim());
      if (!record) return 'User';
      if (record.username) return `@${record.username}`;
      return record.fullName || 'User';
    }

    async function loadReviews() {
      const list = document.getElementById('reviewList');
      list.innerHTML = '<div class="empty">Loading reviews...</div>';
      const sb = await ensureClient();
      if (!sb) {
        list.innerHTML = '<div class="empty">Review service unavailable.</div>';
        return;
      }
      const { data, error } = await sb
        .from('travel_reviews')
        .select('id,user_id,rating,comment,created_at')
        .eq('country_code', state.code)
        .order('created_at', { ascending: false });
      if (error) {
        list.innerHTML = '<div class="empty">Could not load reviews.</div>';
        return;
      }
      state.reviews = Array.isArray(data) ? data : [];
      const userIds = [...new Set(state.reviews.map((row) => String(row && row.user_id || '').trim()).filter(Boolean))];
      await loadUsers(userIds);

      const count = state.reviews.length;
      const avg = count
        ? state.reviews.reduce((acc, row) => acc + Number(row && row.rating || 0), 0) / count
        : 0;
      document.getElementById('count').textContent = String(count);
      document.getElementById('avg').textContent = count ? avg.toFixed(1) : '-';

      if (!count) {
        list.innerHTML = '<div class="empty">No reviews yet.</div>';
        return;
      }

      list.innerHTML = state.reviews.map((review) => {
        const mine = state.user && String(state.user.id) === String(review && review.user_id);
        const createdAt = new Date(review && review.created_at || '');
        const dateText = Number.isFinite(createdAt.getTime())
          ? createdAt.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })
          : 'Unknown date';

        return `
          <article class="r" data-id="${escapeHtml(review.id)}">
            <div class="rh">
              <div>
                <div class="ru">${escapeHtml(resolveUsername(review.user_id))}</div>
                <div class="rd">${escapeHtml(dateText)}</div>
              </div>
              <div class="rs">${renderStars(Math.max(1, Math.min(5, Number(review.rating || 0))))}</div>
            </div>
            <div class="rc">${escapeHtml(review.comment || 'No comment.')}</div>
            ${mine ? `<div class="ra"><button data-act="edit" data-id="${escapeHtml(review.id)}">Edit</button><button data-act="del" data-id="${escapeHtml(review.id)}">Delete</button></div>` : ''}
          </article>
        `;
      }).join('');
    }

    function drawRatingStars() {
      const host = document.getElementById('stars');
      host.innerHTML = '';
      for (let i = 1; i <= 5; i += 1) {
        const star = document.createElement('span');
        star.className = `star${i <= state.rating ? ' on' : ''}`;
        star.innerHTML = '&#9733;';
        star.dataset.v = String(i);
        host.appendChild(star);
      }
    }

    function resetReviewForm() {
      state.editId = null;
      state.rating = 0;
      drawRatingStars();
      document.getElementById('comment').value = '';
      document.getElementById('saveBtn').textContent = 'Submit Review';
      document.getElementById('cancelBtn').style.display = 'none';
    }

    async function saveReview(event) {
      event.preventDefault();
      if (!state.user || !state.user.id) {
        showToast('Please sign in', 'inf');
        return;
      }
      if (!state.rating) {
        showToast('Select rating', 'inf');
        return;
      }
      const comment = document.getElementById('comment').value.trim();
      const sb = await ensureClient();
      if (!sb) return;

      let error = null;
      if (state.editId) {
        ({ error } = await sb
          .from('travel_reviews')
          .update({
            rating: state.rating,
            comment,
            updated_at: new Date().toISOString()
          })
          .eq('id', state.editId));
      } else {
        ({ error } = await sb
          .from('travel_reviews')
          .upsert({
            country_code: state.code,
            user_id: state.user.id,
            rating: state.rating,
            comment,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'user_id,country_code'
          }));
      }

      if (error) {
        showToast('Could not save review', 'err');
        return;
      }

      resetReviewForm();
      await loadReviews();
      showToast('Review saved', 'ok');
    }

    async function editReview(id) {
      const review = state.reviews.find((row) => String(row && row.id) === String(id));
      if (!review) return;
      state.editId = id;
      state.rating = Math.max(1, Math.min(5, Number(review.rating || 0)));
      drawRatingStars();
      document.getElementById('comment').value = String(review.comment || '');
      document.getElementById('saveBtn').textContent = 'Update Review';
      document.getElementById('cancelBtn').style.display = 'inline-flex';
      document.getElementById('comment').focus();
    }

    async function deleteReview(id) {
      if (!state.user || !state.user.id) {
        showToast('Please sign in', 'inf');
        return;
      }
      if (!window.confirm('Delete this review?')) return;
      const sb = await ensureClient();
      if (!sb) return;
      const { error } = await sb
        .from('travel_reviews')
        .delete()
        .eq('id', id)
        .eq('user_id', state.user.id);
      if (error) {
        showToast('Could not delete review', 'err');
        return;
      }
      await loadReviews();
      showToast('Review deleted', 'ok');
    }

    function wireEvents() {
      document.querySelectorAll('button[data-list]').forEach((button) => {
        button.addEventListener('click', () => { void toggleList(button.getAttribute('data-list')); });
      });
      document.getElementById('reviewForm').addEventListener('submit', (event) => { void saveReview(event); });
      document.getElementById('cancelBtn').addEventListener('click', resetReviewForm);
      document.getElementById('stars').addEventListener('click', (event) => {
        const star = event.target && event.target.closest('.star');
        if (!star) return;
        state.rating = Number(star.dataset.v || 0) || 0;
        drawRatingStars();
      });
      document.getElementById('reviewList').addEventListener('click', (event) => {
        const button = event.target && event.target.closest('button[data-act]');
        if (!button) return;
        const id = button.getAttribute('data-id');
        if (!id) return;
        const action = button.getAttribute('data-act');
        if (action === 'edit') void editReview(id);
        if (action === 'del') void deleteReview(id);
      });
    }

    async function init() {
      if (!state.code) {
        window.location.href = 'travel.html';
        return;
      }
      drawRatingStars();
      wireEvents();
      await ensureClient();
      await loadCountry();
      await syncAuth();
      await loadReviews();
    }

    document.addEventListener('DOMContentLoaded', () => { void init(); });
  })();
  </script>
</body>
</html>
