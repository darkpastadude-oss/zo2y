<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zo2y - Full Profile</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* =========================================
           1. CORE VARIABLES & RESET
           ========================================= */
        :root {
            /* Colors */
            --bg: #0b1633;
            --card: #132347;
            --card-hover: #1c2e55;
            --muted: #cbd5e1;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --white: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
            --error: #ef4444;
            --success: #10b981;
            
            /* Spacing & Layout */
            --radius: 12px;
            --radius-sm: 8px;
            --header-height: 60px;
            --mobile-nav-height: 70px;
            
            /* Effects */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--white);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* =========================================
           2. UTILITY CLASSES
           ========================================= */
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .align-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .text-center { text-align: center; }
        .text-muted { color: var(--muted); }
        .w-full { width: 100%; }
        .cursor-pointer { cursor: pointer; }

        /* =========================================
           3. COMPONENTS: BUTTONS & INPUTS
           ========================================= */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary { background: var(--accent); color: #0b1633; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }
        
        .btn-secondary { background: var(--card); color: var(--white); border-color: var(--border); }
        .btn-secondary:hover { background: var(--card-hover); border-color: var(--accent); }
        
        .btn-outline { background: transparent; border-color: var(--accent); color: var(--accent); }
        .btn-outline:hover { background: rgba(245, 158, 11, 0.1); }
        
        .btn-error { background: var(--error); color: white; }
        .btn-error:hover { background: #dc2626; }

        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; }

        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--muted); }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--white);
            font-family: inherit;
            transition: var(--transition);
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(0, 0, 0, 0.3);
        }

        /* =========================================
           4. DESKTOP LAYOUT (Default)
           ========================================= */
        .home-button { position: fixed; top: 20px; left: 20px; z-index: 100; }
        .home-button img { width: 40px; height: 40px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); transition: var(--transition); }
        .home-button:hover img { transform: scale(1.1); }

        /* Profile Header */
        .profile-header { background: var(--card); padding: 40px 0; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .profile-content { display: flex; gap: 30px; align-items: flex-start; }
        
        .avatar-wrapper { position: relative; }
        .profile-avatar {
            width: 100px; height: 100px;
            background: var(--accent);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px;
            border: 4px solid var(--card);
            box-shadow: 0 0 0 2px var(--accent);
            cursor: pointer;
            transition: var(--transition);
        }
        .profile-avatar:hover { transform: scale(1.05); }

        .profile-details { flex: 1; }
        .profile-name { font-size: 2rem; font-weight: 800; line-height: 1.2; }
        .profile-handle { color: var(--accent); font-size: 1rem; margin-bottom: 10px; }
        .profile-bio { color: var(--muted); max-width: 600px; margin-bottom: 15px; }
        
        .profile-meta { display: flex; gap: 20px; font-size: 0.9rem; color: var(--muted); margin-bottom: 20px; }
        .meta-item i { color: var(--accent); margin-right: 6px; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 40px; }
        .stat-card {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            text-align: center;
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .stat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
        .stat-value { font-size: 1.8rem; font-weight: 800; color: var(--white); }
        .stat-label { font-size: 0.85rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Tabs */
        .nav-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: var(--muted);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        .nav-tab:hover { color: var(--white); }
        .nav-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Lists Grid */
        .lists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .list-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            display: flex; flex-direction: column; height: 100%;
        }
        .list-card:hover { border-color: var(--accent); transform: translateY(-4px); }
        .list-icon { font-size: 2rem; margin-bottom: 10px; }
        .list-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .list-desc { font-size: 0.9rem; color: var(--muted); flex: 1; margin-bottom: 15px; }
        
        /* List Kebab Menu */
        .list-menu-wrapper { position: absolute; top: 15px; right: 15px; }
        .list-menu-btn {
            background: transparent; border: none; color: var(--muted);
            width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; transition: var(--transition);
            display: flex; align-items: center; justify-content: center;
        }
        .list-menu-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .list-menu-dropdown {
            position: absolute; top: 100%; right: 0;
            background: var(--bg); border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            width: 140px; display: none; z-index: 50;
            box-shadow: var(--shadow);
        }
        .list-menu-dropdown.active { display: block; }
        .menu-item { padding: 10px 15px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; color: var(--white); }
        .menu-item:hover { background: var(--card); }
        .menu-item.delete { color: var(--error); }

        /* Restaurant Cards in List View */
        .restaurant-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .restaurant-card {
            background: var(--card);
            border-radius: var(--radius);
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .restaurant-card:hover { border-color: var(--accent); }
        
        .remove-btn {
            position: absolute; top: 10px; right: 10px;
            width: 28px; height: 28px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: none; cursor: pointer;
            z-index: 10; opacity: 0;
            transition: var(--transition);
        }
        .restaurant-card:hover .remove-btn { opacity: 1; }
        .remove-btn:hover { transform: scale(1.1); background: #dc2626; }

        .restaurant-content { padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 15px; }
        .restaurant-thumb { width: 60px; height: 60px; border-radius: var(--radius-sm); object-fit: cover; background: #000; }

        /* =========================================
           5. MOBILE LAYOUT
           ========================================= */
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: block !important; }
            
            .container { padding: 0 15px; }
            
            /* Mobile Header */
            .mobile-header {
                position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
                background: rgba(19, 35, 71, 0.95);
                backdrop-filter: blur(10px);
                border-bottom: 1px solid var(--border);
                display: flex; align-items: center; justify-content: space-between;
                padding: 0 20px; z-index: 1000;
            }
            
            /* Mobile Content Padding */
            .mobile-content { padding-top: 80px; padding-bottom: 90px; }
            
            /* Mobile Profile Card */
            .mobile-profile-card {
                background: var(--card); border-radius: var(--radius);
                padding: 25px 20px; text-align: center;
                border: 1px solid var(--border); margin-bottom: 20px;
            }
            .mobile-profile-avatar { width: 80px; height: 80px; margin: 0 auto 15px; font-size: 32px; }
            
            /* Mobile Stats Row */
            .mobile-stats-row { display: flex; justify-content: space-between; margin-bottom: 20px; background: var(--card); padding: 15px; border-radius: var(--radius); }
            .mobile-stat-item { text-align: center; flex: 1; }
            .mobile-stat-val { display: block; font-weight: 700; font-size: 1.2rem; color: var(--accent); }
            .mobile-stat-lbl { font-size: 0.75rem; color: var(--muted); }

            /* Mobile Tabs (Sticky) */
            .mobile-tabs-bar {
                position: sticky; top: var(--header-height);
                background: var(--bg);
                display: flex; z-index: 900;
                border-bottom: 1px solid var(--border);
                margin: 0 -15px 20px; padding: 0 15px;
            }
            .mobile-tab-item {
                flex: 1; text-align: center; padding: 12px 0;
                font-size: 0.9rem; color: var(--muted);
                border-bottom: 2px solid transparent;
            }
            .mobile-tab-item.active { color: var(--accent); border-color: var(--accent); font-weight: 600; }

            /* Mobile List Card */
            .mobile-list-item {
                background: var(--card); padding: 15px;
                border-radius: var(--radius); margin-bottom: 12px;
                display: flex; align-items: center; gap: 15px;
                border: 1px solid var(--border);
            }
            .mobile-list-icon { font-size: 1.5rem; width: 40px; text-align: center; }
            
            /* Mobile List Detail Header */
            .mobile-list-detail-sticky {
                position: sticky; top: var(--header-height);
                background: var(--card); z-index: 899;
                padding: 15px; margin: 0 -15px 20px;
                border-bottom: 1px solid var(--border);
                display: flex; align-items: center; gap: 15px;
            }

            /* Mobile Bottom Nav */
            .mobile-nav {
                position: fixed; bottom: 0; left: 0; right: 0;
                height: var(--mobile-nav-height);
                background: var(--card);
                border-top: 1px solid var(--border);
                display: flex; align-items: center; justify-content: space-around;
                z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
            }
            .nav-item {
                display: flex; flex-direction: column; align-items: center;
                color: var(--muted); text-decoration: none; font-size: 0.7rem; gap: 4px;
            }
            .nav-item.active { color: var(--accent); }
            .nav-item i { font-size: 1.2rem; }
            
            .remove-btn { opacity: 1; width: 32px; height: 32px; } /* Always visible on mobile */
        }

        /* =========================================
           6. MODALS & TOASTS
           ========================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: var(--transition);
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-card {
            background: var(--card); width: 90%; max-width: 500px;
            border-radius: var(--radius); border: 1px solid var(--border);
            transform: translateY(20px); transition: var(--transition);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-card { transform: translateY(0); }
        
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }

        .toast-wrapper { position: fixed; top: 80px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast-msg {
            background: var(--card); padding: 12px 20px;
            border-radius: var(--radius-sm); border-left: 4px solid var(--accent);
            box-shadow: var(--shadow); color: var(--white);
            animation: slideInRight 0.3s ease; display: flex; align-items: center; gap: 10px;
        }
        .toast-msg.success { border-color: var(--success); }
        .toast-msg.error { border-color: var(--error); }

        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Mobile Specific Display toggles */
        @media (min-width: 769px) { .mobile-only { display: none !important; } }
    </style>
</head>
<body>

    <div class="desktop-only">
        <a href="index.html" class="home-button"><img src="images/logo.png" alt="Zo2y"></a>

        <div class="container" id="desktopViewBanner" style="display:none;">
            <div class="viewing-other-profile">
                <div class="d-flex align-center gap-2"><i class="fas fa-eye"></i> Viewing user profile</div>
                <button class="btn btn-outline btn-sm" onclick="App.goToMyProfile()">Return to My Profile</button>
            </div>
        </div>

        <div class="profile-header">
            <div class="container">
                <div class="profile-content">
                    <div class="avatar-wrapper">
                        <div class="profile-avatar" id="desktopAvatar" onclick="App.openAvatarModal()">üçî</div>
                    </div>
                    <div class="profile-details">
                        <div class="d-flex justify-between align-center">
                            <div>
                                <h1 class="profile-name" id="desktopName">Loading...</h1>
                                <div class="profile-handle" id="desktopHandle">@loading</div>
                            </div>
                            <div class="profile-actions" id="desktopActions">
                                </div>
                        </div>
                        <p class="profile-bio" id="desktopBio">...</p>
                        <div class="profile-meta">
                            <span class="meta-item"><i class="fas fa-map-marker-alt"></i> <span id="desktopLocation">Unknown</span></span>
                            <span class="meta-item"><i class="fas fa-calendar"></i> Joined <span id="desktopJoined">...</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statVisited">0</div>
                    <div class="stat-label">Visited</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statFollowers">0</div>
                    <div class="stat-label">Followers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statLists">0</div>
                    <div class="stat-label">Lists</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statReviews">0</div>
                    <div class="stat-label">Reviews</div>
                </div>
            </div>

            <div class="nav-tabs">
                <div class="nav-tab active" onclick="App.switchTab('journal')">Food Journal</div>
                <div class="nav-tab" onclick="App.switchTab('lists')">Lists</div>
                <div class="nav-tab" onclick="App.switchTab('community')">Community</div>
            </div>

            <div id="tab-journal" class="tab-content active">
                <div class="d-flex justify-between align-center" style="margin-bottom:20px;">
                    <h2>Recent Visits</h2>
                    <button class="btn btn-primary" onclick="App.openModal('modalAddEntry')"><i class="fas fa-plus"></i> Add Entry</button>
                </div>
                <div id="journalContainer"></div>
            </div>

            <div id="tab-lists" class="tab-content">
                <div id="listViewList">
                    <div class="d-flex justify-between align-center" style="margin-bottom:20px;">
                        <h2>My Collections</h2>
                        <button class="btn btn-primary" onclick="App.openModal('modalCreateList')"><i class="fas fa-plus"></i> New List</button>
                    </div>
                    <div class="lists-grid" id="listsContainer"></div>
                </div>
                <div id="listViewDetail" class="d-none">
                    <div class="d-flex align-center gap-2" style="margin-bottom:20px;">
                        <button class="btn btn-secondary btn-sm" onclick="App.closeListDetail()"><i class="fas fa-arrow-left"></i> Back</button>
                        <div>
                            <h2 id="detailListTitle" style="margin:0;">Title</h2>
                            <p id="detailListDesc" class="text-muted" style="font-size:0.9rem;">Desc</p>
                        </div>
                    </div>
                    <div class="restaurant-grid" id="detailListGrid"></div>
                </div>
            </div>

            <div id="tab-community" class="tab-content">
                <div class="d-flex justify-between align-center" style="margin-bottom:20px;">
                    <div class="d-flex gap-2">
                        <button class="btn btn-secondary active" id="btnShowFollowers" onclick="App.loadCommunity('followers')">Followers</button>
                        <button class="btn btn-secondary" id="btnShowFollowing" onclick="App.loadCommunity('following')">Following</button>
                    </div>
                    <button class="btn btn-primary" onclick="App.openModal('modalSearchUsers')"><i class="fas fa-search"></i> Find Users</button>
                </div>
                <div class="lists-grid" id="communityContainer" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));"></div>
            </div>
        </div>
        
        <div class="container" style="margin-top:60px; padding-bottom:40px; border-top:1px solid var(--border); padding-top:20px; text-align:center; color:var(--muted); font-size:0.9rem;">
            &copy; 2026 Zo2y Inc. <a href="#" onclick="App.logout()" style="color:var(--error); margin-left:15px;">Log Out</a>
        </div>
    </div>

    <div class="mobile-only">
        <div class="mobile-header">
            <div style="font-weight:800; font-size:1.2rem; color:var(--accent);">Zo2y</div>
            <button class="btn btn-icon btn-secondary" onclick="App.toggleMobileMenu()"><i class="fas fa-bars"></i></button>
        </div>

        <div class="container mobile-content">
            <div id="mobileViewBanner" class="d-none" style="background:var(--accent); color:var(--bg); padding:10px; margin-bottom:20px; border-radius:var(--radius-sm); text-align:center; font-weight:600;">
                Viewing another profile. <u onclick="App.goToMyProfile()">Go back</u>
            </div>

            <div class="mobile-profile-card">
                <div class="mobile-profile-avatar" id="mobileAvatar" onclick="App.openAvatarModal()">üçî</div>
                <h2 id="mobileName">Loading...</h2>
                <div id="mobileHandle" class="text-muted" style="margin-bottom:10px;">@loading</div>
                <div id="mobileActions" class="d-flex justify-center gap-2" style="margin-bottom:15px;"></div>
                <div class="mobile-stats-row">
                    <div class="mobile-stat-item"><span class="mobile-stat-val" id="mStatVisited">0</span><span class="mobile-stat-lbl">Visits</span></div>
                    <div class="mobile-stat-item"><span class="mobile-stat-val" id="mStatFollowers">0</span><span class="mobile-stat-lbl">Fans</span></div>
                    <div class="mobile-stat-item"><span class="mobile-stat-val" id="mStatLists">0</span><span class="mobile-stat-lbl">Lists</span></div>
                </div>
            </div>

            <div class="mobile-tabs-bar">
                <div class="mobile-tab-item active" onclick="App.switchTab('journal')">Journal</div>
                <div class="mobile-tab-item" onclick="App.switchTab('lists')">Lists</div>
                <div class="mobile-tab-item" onclick="App.switchTab('community')">People</div>
            </div>

            <div id="m-tab-journal">
                <button class="btn btn-primary w-full" style="margin-bottom:15px;" onclick="App.openModal('modalAddEntry')">Add Entry</button>
                <div id="mJournalContainer"></div>
            </div>

            <div id="m-tab-lists" class="d-none">
                <div id="mListViewList">
                    <button class="btn btn-primary w-full" style="margin-bottom:15px;" onclick="App.openModal('modalCreateList')">Create List</button>
                    <div id="mListsContainer"></div>
                </div>
                <div id="mListViewDetail" class="d-none">
                    <div class="mobile-list-detail-sticky">
                        <button class="btn btn-sm btn-secondary" onclick="App.closeListDetail()"><i class="fas fa-arrow-left"></i></button>
                        <div style="flex:1;">
                            <div id="mDetailTitle" style="font-weight:700; font-size:1.1rem; color:var(--accent);">Title</div>
                            <div id="mDetailDesc" style="font-size:0.8rem; color:var(--muted);">Description</div>
                        </div>
                    </div>
                    <div id="mDetailGrid"></div>
                </div>
            </div>

            <div id="m-tab-community" class="d-none">
                <div class="d-flex gap-2" style="margin-bottom:15px;">
                    <button class="btn btn-secondary w-full" onclick="App.loadCommunity('followers')">Followers</button>
                    <button class="btn btn-secondary w-full" onclick="App.loadCommunity('following')">Following</button>
                </div>
                <button class="btn btn-primary w-full" style="margin-bottom:20px;" onclick="App.openModal('modalSearchUsers')">Find People</button>
                <div id="mCommunityContainer"></div>
            </div>
        </div>

        <div class="mobile-nav">
            <a href="index.html" class="nav-item"><i class="fas fa-home"></i> Home</a>
            <a href="#" class="nav-item active"><i class="fas fa-user"></i> Profile</a>
            <a href="#" class="nav-item" onclick="App.openModal('modalSearchUsers')"><i class="fas fa-search"></i> Search</a>
            <a href="#" class="nav-item" onclick="App.logout()" style="color:var(--error);"><i class="fas fa-sign-out-alt"></i> Exit</a>
        </div>
    </div>

    <div class="modal-overlay" id="modalAddEntry">
        <div class="modal-card">
            <div class="modal-header"><h3>Add Journal Entry</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalAddEntry')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Restaurant</label>
                    <select id="inpRestSelect" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" id="inpVisitDate" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Rating (1-5)</label>
                    <select id="inpRating" class="form-select">
                        <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê (3)</option>
                        <option value="2">‚≠ê‚≠ê (2)</option>
                        <option value="1">‚≠ê (1)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="inpNotes" class="form-textarea" rows="3" placeholder="What did you eat?"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary w-full" onclick="App.saveEntry()">Save Entry</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalCreateList">
        <div class="modal-card">
            <div class="modal-header"><h3>Create Collection</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalCreateList')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">List Title</label>
                    <input type="text" id="inpListTitle" class="form-input" placeholder="e.g. Date Night Spots">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea id="inpListDesc" class="form-textarea" rows="2" placeholder="What is this list for?"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Icon</label>
                    <select id="inpListIcon" class="form-select">
                        <option value="üìã">üìã Clipboard</option>
                        <option value="üî•">üî• Hot</option>
                        <option value="üçï">üçï Pizza</option>
                        <option value="üç∑">üç∑ Drinks</option>
                        <option value="üíé">üíé Fancy</option>
                        <option value="üåÆ">üåÆ Tacos</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-full" onclick="App.createList()">Create</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalRenameList">
        <div class="modal-card">
            <div class="modal-header"><h3>Edit List</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalRenameList')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="editListId">
                <div class="form-group"><label class="form-label">Title</label><input type="text" id="editListTitle" class="form-input"></div>
                <div class="form-group"><label class="form-label">Description</label><textarea id="editListDesc" class="form-textarea" rows="2"></textarea></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-full" onclick="App.saveListRename()">Save Changes</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalEditProfile">
        <div class="modal-card">
            <div class="modal-header"><h3>Edit Profile</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalEditProfile')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Name</label><input type="text" id="editProfName" class="form-input"></div>
                <div class="form-group"><label class="form-label">Bio</label><textarea id="editProfBio" class="form-textarea" rows="2"></textarea></div>
                <div class="form-group"><label class="form-label">Location</label><input type="text" id="editProfLoc" class="form-input"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary w-full" onclick="App.saveProfile()">Update Profile</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modalAvatar">
        <div class="modal-card">
            <div class="modal-header"><h3>Choose Avatar</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalAvatar')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: repeat(5, 1fr); gap:10px;" id="avatarGrid"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalSearchUsers">
        <div class="modal-card">
            <div class="modal-header"><h3>Find Foodies</h3><button class="btn btn-sm btn-secondary" onclick="App.closeModal('modalSearchUsers')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="text" id="inpSearch" class="form-input" placeholder="Type a username..." onkeyup="App.handleSearch(this.value)">
                <div id="searchResults" style="margin-top:20px; display:grid; gap:10px;"></div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modalConfirm">
        <div class="modal-card" style="max-width:350px;">
            <div class="modal-header"><h3 id="confirmTitle">Confirm</h3></div>
            <div class="modal-body" id="confirmMsg">Are you sure?</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="App.closeModal('modalConfirm')">Cancel</button>
                <button class="btn btn-error" id="confirmBtnAction">Yes, Do It</button>
            </div>
        </div>
    </div>

    <div class="toast-wrapper" id="toastContainer"></div>

    <script>
        const App = (function() {
            // --- CONFIG ---
            const SUPABASE_URL = "https://gfkhjbztayjyojsgdpgk.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
            
            // --- STATE ---
            let supabase = null;
            let currentUser = null; // Logged in user
            let targetUser = null;  // User profile being viewed
            let isOwnProfile = true;
            let allRestaurants = [];
            let userLists = [];
            let currentTab = 'journal';
            let activeList = null;

            // --- INIT ---
            async function init() {
                if (!window.supabase) return console.error('Supabase not loaded');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Auth Check
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { window.location.href = 'login.html'; return; }
                currentUser = user;

                // URL Params (Viewing other user?)
                const urlParams = new URLSearchParams(window.location.search);
                const idParam = urlParams.get('id');
                
                if (idParam && idParam !== currentUser.id) {
                    isOwnProfile = false;
                    await loadTargetProfile(idParam);
                } else {
                    isOwnProfile = true;
                    await loadMyProfile();
                }

                // Global Data Load
                await loadRestaurants();
                
                // Initial Render
                renderHeader();
                renderStats();
                switchTab('journal');
                
                // Populate Modals
                populateAvatarGrid();
            }

            // --- DATA LOADING ---
            async function loadMyProfile() {
                // Try fetch
                let { data } = await supabase.from('user_profiles').select('*').eq('id', currentUser.id).single();
                if (!data) {
                    // Create if not exists
                    const newProfile = {
                        id: currentUser.id,
                        username: currentUser.email.split('@')[0],
                        full_name: 'New Foodie',
                        avatar_icon: 'üçî',
                        bio: 'Just started my food journey!',
                        created_at: new Date()
                    };
                    await supabase.from('user_profiles').insert([newProfile]);
                    targetUser = newProfile;
                } else {
                    targetUser = data;
                }
                
                // Ensure default lists exist
                await ensureDefaultLists(currentUser.id);
            }

            async function loadTargetProfile(id) {
                let { data } = await supabase.from('user_profiles').select('*').eq('id', id).single();
                if (!data) { alert('User not found'); window.location.href='profile.html'; return; }
                targetUser = data;
                
                // UI Adjustments for Visitor
                document.getElementById('desktopViewBanner').style.display = 'block';
                document.getElementById('mobileViewBanner').style.display = 'block';
                document.getElementById('mobileViewBanner').classList.remove('d-none');
            }

            async function ensureDefaultLists(uid) {
                const defaults = ['Favorites', 'Visited', 'Want to Go'];
                const icons = {'Favorites':'‚ù§Ô∏è', 'Visited':'‚úÖ', 'Want to Go':'üìç'};
                
                const { data: existing } = await supabase.from('lists').select('title').eq('user_id', uid);
                const existingTitles = existing.map(l => l.title);
                
                for (let title of defaults) {
                    if (!existingTitles.includes(title)) {
                        await supabase.from('lists').insert([{
                            user_id: uid, title: title, icon: icons[title], is_default: true
                        }]);
                    }
                }
            }

            async function loadRestaurants() {
                const { data } = await supabase.from('restraunts').select('*');
                allRestaurants = data || [];
                const sel = document.getElementById('inpRestSelect');
                sel.innerHTML = '<option value="">Select Restaurant...</option>';
                allRestaurants.forEach(r => {
                    sel.innerHTML += `<option value="${r.id}">${r.name} (${r.category})</option>`;
                });
            }

            // --- RENDER LOGIC ---
            function renderHeader() {
                // Desktop
                document.getElementById('desktopName').innerText = targetUser.full_name || targetUser.username;
                document.getElementById('desktopHandle').innerText = '@' + targetUser.username;
                document.getElementById('desktopBio').innerText = targetUser.bio || '';
                document.getElementById('desktopLocation').innerText = targetUser.location || 'Earth';
                document.getElementById('desktopJoined').innerText = new Date(targetUser.created_at).getFullYear();
                document.getElementById('desktopAvatar').innerText = targetUser.avatar_icon;

                // Mobile
                document.getElementById('mobileName').innerText = targetUser.full_name || targetUser.username;
                document.getElementById('mobileHandle').innerText = '@' + targetUser.username;
                document.getElementById('mobileAvatar').innerText = targetUser.avatar_icon;

                // Actions Button Logic
                const dActions = document.getElementById('desktopActions');
                const mActions = document.getElementById('mobileActions');
                dActions.innerHTML = ''; mActions.innerHTML = '';

                if (isOwnProfile) {
                    const editBtn = `<button class="btn btn-secondary" onclick="App.openModal('modalEditProfile')"><i class="fas fa-edit"></i> Edit Profile</button>`;
                    dActions.innerHTML = editBtn;
                    mActions.innerHTML = editBtn;
                } else {
                    checkFollowStatus().then(isFollowing => {
                        const btnClass = isFollowing ? 'btn-error' : 'btn-primary';
                        const btnText = isFollowing ? 'Unfollow' : 'Follow';
                        const btnIcon = isFollowing ? 'fa-user-minus' : 'fa-user-plus';
                        const html = `<button class="btn ${btnClass}" onclick="App.toggleFollow('${targetUser.id}')"><i class="fas ${btnIcon}"></i> ${btnText}</button>`;
                        dActions.innerHTML = html;
                        mActions.innerHTML = html;
                    });
                }
            }

            async function renderStats() {
                // Helper to count
                const count = async (table, col, val) => {
                    const { count } = await supabase.from(table).select('*', { count: 'exact', head: true }).eq(col, val);
                    return count || 0;
                };

                const visits = await count('journal_entries', 'user_id', targetUser.id);
                const followers = await count('follows', 'followed_id', targetUser.id);
                const lists = await count('lists', 'user_id', targetUser.id);
                
                // Desktop
                document.getElementById('statVisited').innerText = visits;
                document.getElementById('statFollowers').innerText = followers;
                document.getElementById('statLists').innerText = lists;
                // Mobile
                document.getElementById('mStatVisited').innerText = visits;
                document.getElementById('mStatFollowers').innerText = followers;
                document.getElementById('mStatLists').innerText = lists;
            }

            // --- TABS & NAVIGATION ---
            function switchTab(tab) {
                currentTab = tab;
                
                // UI Toggle Desktop
                document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                
                // UI Toggle Mobile
                document.getElementById('m-tab-journal').classList.add('d-none');
                document.getElementById('m-tab-lists').classList.add('d-none');
                document.getElementById('m-tab-community').classList.add('d-none');
                document.getElementById(`m-tab-${tab}`).classList.remove('d-none');

                // Tab Styling
                document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
                // (Index based assumption for simplicity, better to use ID in real app)
                const idx = ['journal', 'lists', 'community'].indexOf(tab);
                document.querySelectorAll('.nav-tab')[idx].classList.add('active');
                document.querySelectorAll('.mobile-tab-item').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.mobile-tab-item')[idx].classList.add('active');

                // Load Data
                if (tab === 'journal') loadJournal();
                if (tab === 'lists') loadLists();
                if (tab === 'community') loadCommunity('followers');
            }

            // --- JOURNAL LOGIC ---
            async function loadJournal() {
                const { data } = await supabase.from('journal_entries').select('*, restraunts(*)').eq('user_id', targetUser.id).order('created_at', { ascending: false });
                
                const html = data.map(entry => `
                    <div style="background:var(--card); padding:20px; border-radius:var(--radius); margin-bottom:15px; border:1px solid var(--border);">
                        <div class="d-flex justify-between">
                            <div class="d-flex gap-2">
                                <img src="images/${entry.restraunts.image || 'placeholder.jpg'}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                                <div>
                                    <div style="font-weight:700;">${entry.restraunts.name}</div>
                                    <div class="text-muted" style="font-size:0.85rem;">${new Date(entry.visit_date).toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div style="color:var(--accent); font-weight:700;">‚≠ê ${entry.rating}</div>
                        </div>
                        <p style="margin-top:10px; font-size:0.95rem;">${entry.notes || ''}</p>
                    </div>
                `).join('') || '<div class="text-center text-muted" style="padding:40px;">No reviews yet. Go eat! üçï</div>';

                document.getElementById('journalContainer').innerHTML = html;
                document.getElementById('mJournalContainer').innerHTML = html;
            }

            async function saveEntry() {
                const rid = document.getElementById('inpRestSelect').value;
                const date = document.getElementById('inpVisitDate').value;
                const rating = document.getElementById('inpRating').value;
                const notes = document.getElementById('inpNotes').value;

                if (!rid || !date) return toast('Please fill all fields', 'error');

                const { error } = await supabase.from('journal_entries').insert([{
                    user_id: currentUser.id,
                    restaurant_id: rid,
                    visit_date: date,
                    rating: rating,
                    notes: notes
                }]);

                if (error) return toast('Error saving', 'error');
                
                // Auto-add to "Visited" list
                const { data: visitedList } = await supabase.from('lists').select('id').eq('user_id', currentUser.id).eq('title', 'Visited').single();
                if (visitedList) {
                    await supabase.from('lists_restraunts').insert([{ list_id: visitedList.id, restraunt_id: rid }]);
                }

                closeModal('modalAddEntry');
                toast('Journal Updated!', 'success');
                loadJournal();
                renderStats();
            }

            // --- LISTS LOGIC ---
            async function loadLists() {
                const { data } = await supabase.from('lists').select('*').eq('user_id', targetUser.id).order('is_default', {ascending:false});
                userLists = data;
                
                // Render List of Lists
                const renderCard = (list) => {
                    const isCustom = !list.is_default;
                    // Kebab Menu Logic (Only if own profile + custom list)
                    const menuBtn = (isOwnProfile && isCustom) ? `
                        <div class="list-menu-wrapper">
                            <button class="list-menu-btn" onclick="event.stopPropagation(); App.toggleListMenu('${list.id}')"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="list-menu-dropdown" id="menu-${list.id}">
                                <div class="menu-item" onclick="event.stopPropagation(); App.openRenameModal('${list.id}')"><i class="fas fa-pen"></i> Rename</div>
                                <div class="menu-item delete" onclick="event.stopPropagation(); App.confirmDeleteList('${list.id}')"><i class="fas fa-trash"></i> Delete</div>
                            </div>
                        </div>
                    ` : '';

                    return `
                        <div class="list-card" onclick="App.openListDetail('${list.id}')">
                            ${menuBtn}
                            <div class="list-icon">${list.icon || 'üìã'}</div>
                            <div class="list-title">${list.title}</div>
                            <div class="list-desc">${list.description || 'No description'}</div>
                            <div class="btn btn-sm btn-secondary w-full">View List</div>
                        </div>
                    `;
                };

                const html = data.map(renderCard).join('');
                document.getElementById('listsContainer').innerHTML = html;
                document.getElementById('mListsContainer').innerHTML = html;
            }

            async function openListDetail(listId) {
                activeList = userLists.find(l => l.id == listId);
                
                // Fetch Restaurants
                const { data: rels } = await supabase.from('lists_restraunts').select('restraunt_id').eq('list_id', listId);
                const rids = rels.map(r => r.restraunt_id);
                const items = allRestaurants.filter(r => rids.includes(r.id));

                // Render Content
                const renderGrid = (containerId) => {
                    const el = document.getElementById(containerId);
                    if (items.length === 0) {
                        el.innerHTML = '<div class="text-center text-muted" style="grid-column:1/-1; padding:40px;">This list is empty.</div>';
                        return;
                    }
                    el.innerHTML = items.map(r => `
                        <div class="restaurant-card">
                            ${isOwnProfile ? `<button class="remove-btn" onclick="event.stopPropagation(); App.removeFromList('${r.id}')"><i class="fas fa-times"></i></button>` : ''}
                            <div class="restaurant-content" onclick="window.location.href='restaurant.html?slug=${r.slug || '#'}';">
                                <img src="images/${r.image || 'placeholder.jpg'}" class="restaurant-thumb">
                                <div>
                                    <div style="font-weight:700;">${r.name}</div>
                                    <div class="text-muted" style="font-size:0.8rem;">${r.category}</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                };

                // Desktop View Update
                document.getElementById('listViewList').classList.add('d-none');
                document.getElementById('listViewDetail').classList.remove('d-none');
                document.getElementById('detailListTitle').innerText = activeList.title;
                document.getElementById('detailListDesc').innerText = activeList.description || '';
                renderGrid('detailListGrid');

                // Mobile View Update
                document.getElementById('mListViewList').classList.add('d-none');
                document.getElementById('mListViewDetail').classList.remove('d-none');
                document.getElementById('mDetailTitle').innerText = activeList.title;
                document.getElementById('mDetailDesc').innerText = activeList.description || '';
                renderGrid('mDetailGrid');
            }

            function closeListDetail() {
                activeList = null;
                // Desktop
                document.getElementById('listViewList').classList.remove('d-none');
                document.getElementById('listViewDetail').classList.add('d-none');
                // Mobile
                document.getElementById('mListViewList').classList.remove('d-none');
                document.getElementById('mListViewDetail').classList.add('d-none');
            }

            async function createList() {
                const title = document.getElementById('inpListTitle').value;
                const desc = document.getElementById('inpListDesc').value;
                const icon = document.getElementById('inpListIcon').value;
                
                if (!title) return toast('Title required', 'error');

                await supabase.from('lists').insert([{ user_id: currentUser.id, title, description: desc, icon }]);
                closeModal('modalCreateList');
                toast('List Created', 'success');
                loadLists();
                renderStats();
            }

            // Fixed Remove Logic
            function removeFromList(rid) {
                confirmAction('Remove restaurant from list?', async () => {
                    await supabase.from('lists_restraunts').delete().match({ list_id: activeList.id, restraunt_id: rid });
                    toast('Removed', 'success');
                    openListDetail(activeList.id); // Refresh view
                });
            }

            // List Management (Rename/Delete)
            function toggleListMenu(id) {
                document.querySelectorAll('.list-menu-dropdown').forEach(e => {
                    if (e.id !== `menu-${id}`) e.classList.remove('active');
                });
                document.getElementById(`menu-${id}`).classList.toggle('active');
            }

            function confirmDeleteList(id) {
                confirmAction('Delete this list permanently?', async () => {
                    await supabase.from('lists').delete().eq('id', id);
                    toast('List Deleted', 'success');
                    loadLists();
                    renderStats();
                });
            }

            function openRenameModal(id) {
                const list = userLists.find(l => l.id == id);
                document.getElementById('editListId').value = id;
                document.getElementById('editListTitle').value = list.title;
                document.getElementById('editListDesc').value = list.description;
                openModal('modalRenameList');
            }

            async function saveListRename() {
                const id = document.getElementById('editListId').value;
                const title = document.getElementById('editListTitle').value;
                const desc = document.getElementById('editListDesc').value;
                await supabase.from('lists').update({ title, description: desc }).eq('id', id);
                closeModal('modalRenameList');
                loadLists();
                toast('List Updated', 'success');
            }

            // --- COMMUNITY & FOLLOW ---
            async function checkFollowStatus() {
                if (isOwnProfile) return false;
                const { data } = await supabase.from('follows').select('*').match({ follower_id: currentUser.id, followed_id: targetUser.id }).single();
                return !!data;
            }

            async function toggleFollow(targetId) {
                const isFollowing = await checkFollowStatus();
                if (isFollowing) {
                    await supabase.from('follows').delete().match({ follower_id: currentUser.id, followed_id: targetId });
                    toast('Unfollowed', 'success');
                } else {
                    await supabase.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
                    toast('Followed!', 'success');
                }
                renderHeader();
                renderStats();
            }

            async function loadCommunity(mode) {
                // mode: 'followers' or 'following'
                const col = mode === 'followers' ? 'followed_id' : 'follower_id';
                const joinCol = mode === 'followers' ? 'follower_id' : 'followed_id';
                
                // Get IDs
                const { data: rels } = await supabase.from('follows').select(joinCol).eq(col, targetUser.id);
                const ids = rels.map(r => r[joinCol]);
                
                if (ids.length === 0) {
                    const html = '<div class="text-center text-muted" style="grid-column:1/-1; padding:30px;">No users found.</div>';
                    document.getElementById('communityContainer').innerHTML = html;
                    document.getElementById('mCommunityContainer').innerHTML = html;
                    return;
                }

                // Get Profiles
                const { data: users } = await supabase.from('user_profiles').select('*').in('id', ids);
                
                const html = users.map(u => `
                    <div class="list-card" onclick="window.location.href='profile.html?id=${u.id}'" style="flex-direction:row; align-items:center; gap:15px;">
                        <div style="font-size:2rem;">${u.avatar_icon}</div>
                        <div>
                            <div style="font-weight:700;">${u.username}</div>
                            <div class="text-muted" style="font-size:0.8rem;">${u.full_name}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('communityContainer').innerHTML = html;
                document.getElementById('mCommunityContainer').innerHTML = html;
                
                // Button Styles
                document.getElementById('btnShowFollowers').classList.toggle('active', mode === 'followers');
                document.getElementById('btnShowFollowing').classList.toggle('active', mode === 'following');
            }

            async function handleSearch(term) {
                if (term.length < 2) return;
                const { data } = await supabase.from('user_profiles').select('*').ilike('username', `%${term}%`);
                document.getElementById('searchResults').innerHTML = data.map(u => `
                    <div style="display:flex; align-items:center; gap:10px; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; cursor:pointer;" onclick="window.location.href='profile.html?id=${u.id}'">
                        <div>${u.avatar_icon}</div>
                        <div style="font-weight:bold;">${u.username}</div>
                    </div>
                `).join('');
            }

            // --- PROFILE EDIT ---
            async function saveProfile() {
                const name = document.getElementById('editProfName').value;
                const bio = document.getElementById('editProfBio').value;
                const loc = document.getElementById('editProfLoc').value;
                
                await supabase.from('user_profiles').update({ full_name: name, bio, location: loc }).eq('id', currentUser.id);
                location.reload();
            }

            function populateAvatarGrid() {
                const icons = ["üçî", "üçï", "üç£", "üç©", "üçó", "üçú", "ü•™", "ü•ó", "ü•û", "üç§", "üåÆ", "üç¶", "üç∞", "üçü", "ü•ê"];
                const html = icons.map(i => `<div style="font-size:2rem; cursor:pointer; text-align:center; padding:10px; border:1px solid var(--border); border-radius:8px;" onclick="App.setAvatar('${i}')">${i}</div>`).join('');
                document.getElementById('avatarGrid').innerHTML = html;
            }

            async function setAvatar(icon) {
                await supabase.from('user_profiles').update({ avatar_icon: icon }).eq('id', currentUser.id);
                location.reload();
            }

            // --- UTILS ---
            function openModal(id) { 
                document.getElementById(id).classList.add('active'); 
                // Pre-fill Edit Profile
                if(id === 'modalEditProfile') {
                    document.getElementById('editProfName').value = targetUser.full_name;
                    document.getElementById('editProfBio').value = targetUser.bio;
                    document.getElementById('editProfLoc').value = targetUser.location;
                }
            }
            function closeModal(id) { document.getElementById(id).classList.remove('active'); }
            
            function toggleMobileMenu() {
                // Since I removed the side menu for a cleaner full-screen modal approach or native feel, 
                // we can map this to just opening the bottom nav or a simplified menu.
                // For this robust version, checking if we need a specific side drawer:
                // Actually, the HTML structure defines a mobile header button.
                // Let's implement a simple alert or reuse modal logic for settings/logout if needed.
                // Or better, scroll to bottom where nav is?
                // Let's just create a quick modal for menu items that aren't in bottom nav.
                if(confirm('Log out?')) logout();
            }

            function toast(msg, type='info') {
                const div = document.createElement('div');
                div.className = `toast-msg ${type}`;
                div.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-check-circle'}"></i> ${msg}`;
                document.getElementById('toastContainer').appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }

            function confirmAction(msg, cb) {
                document.getElementById('confirmMsg').innerText = msg;
                document.getElementById('modalConfirm').classList.add('active');
                document.getElementById('confirmBtnAction').onclick = () => { cb(); closeModal('modalConfirm'); };
            }

            async function logout() {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            }

            function goToMyProfile() { window.location.href = 'profile.html'; }

            // Close menus on click outside
            window.onclick = function(e) {
                if (!e.target.matches('.list-menu-btn') && !e.target.matches('.list-menu-btn i')) {
                    document.querySelectorAll('.list-menu-dropdown').forEach(d => d.classList.remove('active'));
                }
            }

            return {
                init, switchTab, openModal, closeModal, 
                openAvatarModal: () => isOwnProfile && openModal('modalAvatar'),
                setAvatar, saveProfile, toggleFollow, loadCommunity,
                saveEntry, createList, openListDetail, closeListDetail,
                removeFromList, toggleListMenu, confirmDeleteList, 
                openRenameModal, saveListRename,
                handleSearch, logout, goToMyProfile, toggleMobileMenu
            };
        })();

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>