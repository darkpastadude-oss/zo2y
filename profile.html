<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Profile | Zo2y</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: 'Poppins', sans-serif; background-color: #0b1633; color: #fefefe; }
    header { background-color: #0b1633; padding: 15px 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { height: 40px; cursor: pointer; }
    .logout-btn { background-color: #f59e0b; border: none; padding: 8px 18px; border-radius: 8px; color: #0b1633; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .logout-btn:hover { background-color: #ffb84d; }
    .profile-container { max-width: 800px; margin: 50px auto; background-color: #132347; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .avatar { font-size: 5rem; background-color: #f59e0b; color: #0b1633; width: 100px; height: 100px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
    .username { font-size: 1.8rem; text-align: center; font-weight: 600; }
    .email { text-align: center; color: #c0c0c0; font-size: 1rem; margin-bottom: 20px; }
    .bio, .lists { background-color: #1e2f5c; border-radius: 15px; padding: 20px; margin-top: 20px; position: relative; }
    h3 { color: #f59e0b; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
    .edit-btn { background: none; border: 1px solid #f59e0b; color: #f59e0b; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
    .edit-btn:hover { background: #f59e0b; color: #0b1633; }
    .join-date { text-align: center; color: #aaa; font-size: 0.9rem; margin-top: 10px; }
    .bio-textarea { width: 100%; min-height: 100px; background: #0b1633; border: 1px solid #f59e0b; border-radius: 8px; color: white; padding: 10px; font-family: inherit; resize: vertical; }
    .bio-actions { display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end; }
    .save-btn { background: #f59e0b; color: #0b1633; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .save-btn:hover { background: #ffb84d; }
    .cancel-btn { background: transparent; color: #f59e0b; border: 1px solid #f59e0b; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
    .cancel-btn:hover { background: #f59e0b22; }
    .list-item { background: #0b1633; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
    .list-name { font-weight: 600; margin-bottom: 5px; }
    .list-desc { color: #c0c0c0; font-size: 0.9rem; }
    .create-list-btn { background: #f59e0b; color: #0b1633; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; }
    .create-list-btn:hover { background: #ffb84d; }
    
    /* Custom Lists Section */
    .custom-lists { background-color: #1e2f5c; border-radius: 15px; padding: 20px; margin-top: 20px; }
    .list-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .list-card { background: #0b1633; padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: transform 0.2s; }
    .list-card:hover { transform: translateY(-3px); border-color: #f59e0b; }
    .list-icon { font-size: 2rem; margin-bottom: 10px; text-align: center; }
    .list-card-title { font-weight: 600; text-align: center; margin-bottom: 5px; }
    .list-card-count { text-align: center; color: #f59e0b; font-size: 0.9rem; }
    
    /* Notification Styles */
    .custom-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      max-width: 400px;
      transform: translateX(120%);
      transition: transform 0.4s ease;
    }
    
    .notification-success {
      background: #10b981;
      color: white;
    }
    
    .notification-info {
      background: #3b82f6;
      color: white;
    }
    
    .notification-show {
      transform: translateX(0);
    }
    
    .notification-icon {
      margin-right: 10px;
      font-size: 1.2rem;
    }
  </style>
</head>
<body>
  <header>
    <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </header>

  <div class="profile-container">
    <div class="avatar" id="avatar"></div>
    <div class="username" id="username">Loading...</div>
    <div class="email" id="email"></div>
    <div class="join-date" id="joinDate"></div>

    <!-- Bio Section -->
    <div class="bio">
      <h3>
        About Me
        <button class="edit-btn" id="editBioBtn">Edit Bio</button>
      </h3>
      <div id="bioDisplay">
        <p id="bioText">No bio yet. Click edit to add one!</p>
      </div>
      <div id="bioEdit" style="display: none;">
        <textarea class="bio-textarea" id="bioTextarea" placeholder="Tell us about yourself..."></textarea>
        <div class="bio-actions">
          <button class="cancel-btn" id="cancelBioBtn">Cancel</button>
          <button class="save-btn" id="saveBioBtn">Save Bio</button>
        </div>
      </div>
    </div>

    <!-- Custom Lists Section -->
    <div class="custom-lists">
      <h3>My Lists</h3>
      <div class="list-grid">
        <div class="list-card" onclick="showList('favorites')">
          <div class="list-icon">‚ù§Ô∏è</div>
          <div class="list-card-title">Favorites</div>
          <div class="list-card-count" id="favoritesCount">0 restaurants</div>
        </div>
        <div class="list-card" onclick="showList('visited')">
          <div class="list-icon">üçΩÔ∏è</div>
          <div class="list-card-title">Visited</div>
          <div class="list-card-count" id="visitedCount">0 restaurants</div>
        </div>
        <div class="list-card" onclick="showList('wantToGo')">
          <div class="list-icon">üìç</div>
          <div class="list-card-title">Want to Go</div>
          <div class="list-card-count" id="wantToGoCount">0 restaurants</div>
        </div>
      </div>
    </div>

    <!-- Custom Lists Section -->
    <div class="lists">
      <h3>
        Custom Lists
        <button class="edit-btn" id="createListBtn">Create List</button>
      </h3>
      <div id="listsContainer">
        <p id="listsText">You don't have any custom lists yet.</p>
      </div>
      
      <div id="createListForm" style="display: none;">
        <input type="text" id="listNameInput" placeholder="List name (e.g., Favorite Burgers)" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #0b1633; border: 1px solid #f59e0b; border-radius: 6px; color: white;">
        <textarea id="listDescInput" placeholder="List description..." style="width: 100%; min-height: 60px; padding: 8px; background: #0b1633; border: 1px solid #f59e0b; border-radius: 6px; color: white; resize: vertical;"></textarea>
        <div class="bio-actions">
          <button class="cancel-btn" id="cancelListBtn">Cancel</button>
          <button class="save-btn" id="saveListBtn">Create List</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Notification -->
  <div id="customNotification" class="custom-notification">
    <i class="notification-icon"></i>
    <span class="notification-message"></span>
  </div>

  <script>
    const supabaseUrl = "https://gfkhjbztayjyojsgdpgk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let userProfile = null;

    // Custom notification function
    function showNotification(message, type = "info") {
      const notification = document.getElementById("customNotification");
      const icon = notification.querySelector(".notification-icon");
      const messageEl = notification.querySelector(".notification-message");
      
      // Set notification content and style
      messageEl.textContent = message;
      notification.className = `custom-notification notification-${type}`;
      
      // Set icon based on type
      if (type === "success") {
        icon.className = "notification-icon fas fa-check-circle";
      } else {
        icon.className = "notification-icon fas fa-info-circle";
      }
      
      // Show notification
      notification.classList.add("notification-show");
      
      // Auto hide after 2.5 seconds
      setTimeout(() => {
        notification.classList.remove("notification-show");
      }, 2500);
    }

    const avatarEmojis = ["üçî", "üçï", "üç£", "üç©", "üçó", "üçú", "ü•™", "ü•ó", "ü•û", "üç§"];
    document.getElementById("avatar").textContent = avatarEmojis[Math.floor(Math.random() * avatarEmojis.length)];

    async function loadProfile() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) { window.location.href = "login.html"; return; }

      currentUser = user;
      
      // Load user profile data
      await loadUserProfile();
      
      // Set user info
      document.getElementById("username").textContent = userProfile?.username || user.email.split('@')[0];
      document.getElementById("email").textContent = user.email;
      document.getElementById("joinDate").textContent = `Joined ${new Date(user.created_at).toLocaleDateString()}`;
      
      // Load bio
      if (userProfile?.bio) {
        document.getElementById("bioText").textContent = userProfile.bio;
      }

      await loadUserLists();
      await loadDefaultLists();
    }

    async function loadUserProfile() {
      const { data: profile, error } = await supabase
        .from("user_profiles")
        .select("*")
        .eq("id", currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') { // PGRST116 is "not found"
        console.error("Error loading profile:", error);
      }

      userProfile = profile || {};
      
      // Create profile if it doesn't exist
      if (!profile) {
        const { error: insertError } = await supabase
          .from("user_profiles")
          .insert({
            id: currentUser.id,
            username: currentUser.email.split('@')[0],
            bio: "",
            created_at: new Date().toISOString()
          });

        if (insertError) {
          console.error("Error creating profile:", insertError);
        }
      }
    }

    async function loadDefaultLists() {
      // Try to get lists from the restaurants page first
      if (window.getUserLists) {
        const userLists = window.getUserLists();
        if (userLists) {
          document.getElementById("favoritesCount").textContent = `${userLists.favorites.length} restaurants`;
          document.getElementById("visitedCount").textContent = `${userLists.visited.length} restaurants`;
          document.getElementById("wantToGoCount").textContent = `${userLists.wantToGo.length} restaurants`;
          return;
        }
      }
      
      // Fallback: Get from Supabase
      try {
        const { data: favorites } = await supabase
          .from("lists_restraunts")
          .select("id")
          .eq("user_id", currentUser.id)
          .eq("list_name", "favorites");

        const { data: visited } = await supabase
          .from("lists_restraunts")
          .select("id")
          .eq("user_id", currentUser.id)
          .eq("list_name", "visited");

        const { data: wantToGo } = await supabase
          .from("lists_restraunts")
          .select("id")
          .eq("user_id", currentUser.id)
          .eq("list_name", "wantToGo");

        document.getElementById("favoritesCount").textContent = `${favorites?.length || 0} restaurants`;
        document.getElementById("visitedCount").textContent = `${visited?.length || 0} restaurants`;
        document.getElementById("wantToGoCount").textContent = `${wantToGo?.length || 0} restaurants`;
      } catch (error) {
        console.error("Error loading default lists:", error);
      }
    }

    async function loadUserLists() {
      const { data: lists, error } = await supabase
        .from("lists")
        .select("*")
        .eq("user_id", currentUser.id)
        .order("created_at", { ascending: false });

      if (error) {
        console.error("Error loading lists:", error);
        return;
      }

      const listsContainer = document.getElementById("listsContainer");
      if (!lists || lists.length === 0) {
        listsContainer.innerHTML = '<p id="listsText">You don\'t have any custom lists yet.</p>';
        return;
      }

      listsContainer.innerHTML = '';
      for (const list of lists) {
        const { count, error: countErr } = await supabase
          .from("lists_restraunts")
          .select("id", { count: "exact", head: true })
          .eq("list_id", list.id);

        const restaurantCount = count || 0;
        const listItem = document.createElement("div");
        listItem.className = "list-item";
        listItem.innerHTML = `
          <div class="list-name">${list.name}</div>
          <div class="list-desc">${list.description || 'No description'}</div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 5px;">
            ${restaurantCount} restaurants ‚Ä¢ Created ${new Date(list.created_at).toLocaleDateString()}
          </div>
        `;
        listsContainer.appendChild(listItem);
      }
    }

    // Bio functionality
    document.getElementById("editBioBtn").addEventListener("click", () => {
      document.getElementById("bioDisplay").style.display = "none";
      document.getElementById("bioEdit").style.display = "block";
      document.getElementById("bioTextarea").value = userProfile?.bio || "";
    });

    document.getElementById("cancelBioBtn").addEventListener("click", () => {
      document.getElementById("bioDisplay").style.display = "block";
      document.getElementById("bioEdit").style.display = "none";
    });

    document.getElementById("saveBioBtn").addEventListener("click", async () => {
      const newBio = document.getElementById("bioTextarea").value.trim();
      
      const { error } = await supabase
        .from("user_profiles")
        .update({ bio: newBio })
        .eq("id", currentUser.id);

      if (error) {
        console.error("Error updating bio:", error);
        showNotification("Error saving bio. Please try again.", "info");
        return;
      }

      userProfile.bio = newBio;
      document.getElementById("bioText").textContent = newBio || "No bio yet. Click edit to add one!";
      document.getElementById("bioDisplay").style.display = "block";
      document.getElementById("bioEdit").style.display = "none";
      
      showNotification("Bio updated successfully!", "success");
    });

    // List functionality
    document.getElementById("createListBtn").addEventListener("click", () => {
      document.getElementById("createListForm").style.display = "block";
      document.getElementById("createListBtn").style.display = "none";
    });

    document.getElementById("cancelListBtn").addEventListener("click", () => {
      document.getElementById("createListForm").style.display = "none";
      document.getElementById("createListBtn").style.display = "block";
      document.getElementById("listNameInput").value = "";
      document.getElementById("listDescInput").value = "";
    });

    document.getElementById("saveListBtn").addEventListener("click", async () => {
      const listName = document.getElementById("listNameInput").value.trim();
      const listDesc = document.getElementById("listDescInput").value.trim();

      if (!listName) {
        showNotification("Please enter a list name", "info");
        return;
      }

      const { error } = await supabase.from("lists").insert({
        user_id: currentUser.id,
        name: listName,
        description: listDesc,
        created_at: new Date().toISOString()
      });

      if (error) {
        console.error("Error creating list:", error);
        showNotification("Error creating list. Please try again.", "info");
        return;
      }

      document.getElementById("createListForm").style.display = "none";
      document.getElementById("createListBtn").style.display = "block";
      document.getElementById("listNameInput").value = "";
      document.getElementById("listDescInput").value = "";
      await loadUserLists();
      showNotification("List created successfully!", "success");
    });

    function showList(listType) {
      // Redirect to restaurants page with the list filter applied
      window.location.href = `restaurants.html?list=${listType}`;
    }

    loadProfile();

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "login.html";
    });
  </script>
</body>
</html>