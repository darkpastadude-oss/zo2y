<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zo2y - Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === DARK BLUE THEME VARIABLES === */
        :root {
            --bg: #0b1633;
            --card: #132347;
            --muted: #cbd5e1;
            --accent: #f59e0b;
            --glass: rgba(255,255,255,0.03);
            --white: #ffffff;
            --border: rgba(255,255,255,0.1);
            --bg-hover: #1a2c5a;
            --error: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.4);
            --transition: all 0.3s ease;
        }

        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; overflow-x: hidden; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        /* === KEBAB MENU STYLES (NEW) === */
        .kebab-menu-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
        }
        .kebab-btn {
            background: rgba(11, 22, 51, 0.6);
            border: 1px solid var(--border);
            color: var(--white);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .kebab-btn:hover { background: var(--accent); color: #0b1633; }
        .kebab-dropdown {
            position: absolute;
            top: 35px;
            right: 0;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            width: 120px;
            display: none;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }
        .kebab-dropdown.active { display: flex; }
        .kebab-item {
            padding: 8px 12px;
            font-size: 13px;
            color: var(--white);
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            border: none;
            background: none;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .kebab-item:hover { background: var(--bg-hover); color: var(--accent); }
        .kebab-item.delete { color: var(--error); }
        .kebab-item.delete:hover { background: rgba(239, 68, 68, 0.1); }

        /* ... [Existing Styles Preserved] ... */
        /* Paste the REST of your CSS here (Buttons, Profile Header, etc) from previous code. 
           For brevity, I am including the critical mobile fix and structure styles below. */

        .home-button { position: fixed; top: 20px; left: 20px; z-index: 1000; transition: var(--transition); text-decoration: none; }
        .home-button img { width: 40px; height: 40px; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .home-button:hover { transform: scale(1.05); }
        .profile-header { background: var(--card); padding: 40px 0; border-bottom: 1px solid var(--border); margin-bottom: 30px; }
        .profile-top { display: flex; align-items: flex-start; gap: 24px; margin-bottom: 24px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 32px; border: 3px solid var(--accent); cursor: pointer; transition: var(--transition); color: #0b1633; }
        .profile-info { flex: 1; }
        .profile-name { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .profile-username { font-size: 16px; color: var(--muted); margin-bottom: 12px; }
        .profile-bio { font-size: 16px; color: var(--muted); margin-bottom: 16px; max-width: 500px; }
        .profile-meta { display: flex; gap: 20px; font-size: 14px; color: var(--muted); }
        .meta-item { display: flex; align-items: center; gap: 6px; }
        .profile-actions { display: flex; gap: 12px; flex-wrap: wrap; }
        
        .btn { padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-weight: 500; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px; text-decoration: none; font-size: 14px; font-family: inherit; }
        .btn-primary { background: var(--accent); color: #0b1633; }
        .btn-secondary { background: var(--card); color: var(--white); border: 1px solid var(--border); }
        .btn-outline { background: transparent; border: 2px solid var(--accent); color: var(--accent); }
        .btn-error { background: var(--error); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 13px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 24px; border-radius: var(--radius); text-align: center; border: 1px solid var(--border); }
        .stat-number { font-size: 36px; font-weight: 700; color: var(--accent); margin-bottom: 4px; }
        .stat-label { font-size: 14px; color: var(--muted); font-weight: 500; }

        .nav-tabs { display: flex; background: var(--card); border-radius: var(--radius); padding: 8px; margin-bottom: 30px; border: 1px solid var(--border); overflow-x: auto; }
        .nav-tab { padding: 12px 20px; border-radius: var(--radius-sm); font-weight: 500; cursor: pointer; transition: var(--transition); white-space: nowrap; display: flex; align-items: center; gap: 8px; flex-shrink: 0; color: var(--muted); }
        .nav-tab.active { background: var(--accent); color: #0b1633; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; transition: var(--transition); position: relative; }
        .card:hover { transform: translateY(-4px); border-color: var(--accent); }
        .card-body { padding: 20px; }

        /* List Styles */
        .lists-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; margin-top: 24px; }
        .list-card { background: var(--card); border-radius: var(--radius); border: 1px solid var(--border); padding: 24px; transition: var(--transition); cursor: pointer; position: relative; display: flex; flex-direction: column; }
        .list-card:hover { transform: translateY(-4px); border-color: var(--accent); }
        .list-card-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; color: var(--accent); }
        .list-preview-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; flex-grow: 1; }
        .list-preview-item { height: 80px; background: var(--bg); border-radius: var(--radius-sm); overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .list-preview-item img { width: 100%; height: 100%; object-fit: cover; }

        /* Remove Restaurant Button */
        .remove-restaurant-btn {
            position: absolute; top: 10px; right: 10px; z-index: 10; width: 30px; height: 30px; border-radius: 50%;
            background: var(--error); color: white; border: none; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition); font-size: 14px; opacity: 0.9;
        }
        .remove-restaurant-btn:hover { opacity: 1; transform: scale(1.1); }

        /* Mobile specific fixes */
        .mobile-only { display: none; }
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: block; }
            
            /* Fix: Ensure Mobile Header Text is Visible */
            .mobile-list-detail-header {
                display: flex; align-items: center; gap: 12px; margin-bottom: 20px; padding: 12px 8px;
                background: var(--card); border-radius: var(--radius); position: sticky; top: 0; z-index: 20;
                border: 1px solid var(--border);
            }
            .mobile-list-detail-title-section { flex: 1; min-width: 0; text-align: left; }
            #mobileListDetailTitle { font-weight: 700; font-size: 18px; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            #mobileListDetailDescription { font-size: 13px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
            
            .mobile-list-card { position: relative; } /* Ensure kebab menu positions correctly */
        }

        /* Modals, Toasts etc (simplified for brevity) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--card); border-radius: var(--radius); width: 100%; max-width: 500px; padding: 20px; border: 1px solid var(--border); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--white); margin-bottom: 15px; }
        
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2100; }
        .toast { background: var(--card); padding: 16px; margin-bottom: 10px; border-radius: var(--radius-sm); border-left: 4px solid var(--accent); display: flex; align-items: center; gap: 10px; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
    </style>
</head>
<body>
    <div class="desktop-only">
        <a href="index.html" class="home-button"><img src="images/logo.png" alt="Zo2y Logo"></a>
        <div class="profile-header">
            <div class="container">
                <div class="profile-top">
                    <div class="profile-avatar" id="profileAvatar">üçî</div>
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">Loading...</div>
                        <div class="profile-username" id="profileUsername">@username</div>
                    </div>
                    <div class="profile-actions">
                        <button class="btn btn-primary" onclick="ProfileManager.showModal('createListModal')">New List</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="ProfileManager.showTab('lists')">My Lists</div>
                <div class="nav-tab" onclick="ProfileManager.showTab('community')">Community</div>
            </div>
            
            <div id="lists-tab" class="tab-content active">
                <div class="lists-grid" id="listsGrid"></div>
            </div>

            <div class="tab-content" id="list-detail-view">
                <div class="section">
                    <div class="list-detail-header" style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button class="btn btn-secondary btn-sm" onclick="ProfileManager.hideListDetail()"><i class="fas fa-arrow-left"></i> Back</button>
                            <div>
                                <h2 class="section-title" id="listDetailTitle">List Title</h2>
                                <p class="section-subtitle" id="listDetailDescription">List description</p>
                            </div>
                        </div>
                    </div>
                    <div class="cards-grid" id="listRestaurantsGrid"></div>
                </div>
            </div>
            
            <div id="community-tab" class="tab-content">
                <div id="followingList" class="lists-grid"></div>
            </div>
        </div>
    </div>

    <div class="mobile-only" style="padding: 20px;">
        <div class="mobile-profile-header" style="text-align: center; margin-bottom: 20px;">
            <div class="mobile-avatar" id="mobileAvatar" style="width: 80px; height: 80px; margin: 0 auto; background: var(--accent); border-radius: 50%; display:flex; align-items:center; justify-content:center; font-size:30px;">üçî</div>
            <h2 id="mobileProfileName" style="margin-top:10px;">User</h2>
        </div>
        
        <div id="mobileLists"></div>
        
        <div id="mobileListDetailSection" style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 100; overflow-y: auto; padding: 10px;">
            <div class="mobile-list-detail-header">
                <button class="btn btn-secondary btn-sm" onclick="ProfileManager.hideMobileListDetail()"><i class="fas fa-arrow-left"></i></button>
                <div class="mobile-list-detail-title-section">
                    <div id="mobileListDetailTitle">List Title</div>
                    <div id="mobileListDetailDescription">Description</div>
                </div>
            </div>
            <div id="mobileListRestaurants" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div class="modal" id="createListModal">
        <div class="modal-content">
            <h3>Create/Rename List</h3>
            <input type="text" class="form-input" id="listName" placeholder="List Name">
            <textarea class="form-textarea" id="listDescription" placeholder="Description"></textarea>
            <input type="hidden" id="editListId" value="">
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="ProfileManager.closeModal('createListModal')">Cancel</button>
                <button class="btn btn-primary" onclick="ProfileManager.handleListSubmit()">Save</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const ProfileManager = (function() {
            // SUPABASE CONFIG
            const SUPABASE_URL = "https://gfkhjbztayjyojsgdpgk.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
            let supabase = null;
            let currentUser = null;
            let userLists = [];
            let restaurants = [];
            let currentActiveList = null;

            function showToast(msg, type='info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span>${msg}</span>`;
                toast.style.borderColor = type === 'error' ? 'var(--error)' : 'var(--success)';
                container.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            async function initialize() {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) { window.location.href = "login.html"; return; }
                currentUser = user;
                
                // Load data
                await Promise.all([loadRestaurants(), listManager.loadUserLists()]);
                listManager.renderLists();
                loadCommunity();
            }

            async function loadRestaurants() {
                const { data } = await supabase.from('restraunts').select('*');
                restaurants = data || [];
            }

            async function loadCommunity() {
                // Simplified community loader for following/followers
                const { data: follows } = await supabase.from('follows').select('followed_id').eq('follower_id', currentUser.id);
                // Render logic here (simplified for this fix block)
            }

            // ===== LIST MANAGER (FIXED) =====
            const listManager = {
                async loadUserLists() {
                    const { data } = await supabase.from('lists').select('*').eq('user_id', currentUser.id);
                    userLists = data || [];
                    
                    // Fetch restaurants for lists
                    for (let list of userLists) {
                        const { data: rel } = await supabase.from('lists_restraunts').select('restraunt_id').eq('list_id', list.id);
                        list.restaurants = rel ? rel.map(r => r.restraunt_id) : [];
                    }
                },

                // NEW: Handle Kebab Menu Click
                toggleKebab(e, listId) {
                    e.stopPropagation();
                    // Close others
                    document.querySelectorAll('.kebab-dropdown').forEach(d => d.classList.remove('active'));
                    const menu = document.getElementById(`kebab-${listId}`);
                    if(menu) menu.classList.toggle('active');
                },

                // FIX: Delete List
                async deleteList(e, listId) {
                    e.stopPropagation();
                    if(!confirm("Delete this list?")) return;
                    
                    const { error } = await supabase.from('lists').delete().eq('id', listId);
                    if(error) return showToast('Error deleting list', 'error');
                    
                    userLists = userLists.filter(l => l.id !== listId);
                    this.renderLists();
                    showToast('List deleted');
                },

                // FIX: Rename List Setup
                setupRename(e, listId) {
                    e.stopPropagation();
                    const list = userLists.find(l => l.id == listId);
                    document.getElementById('listName').value = list.title;
                    document.getElementById('listDescription').value = list.description || '';
                    document.getElementById('editListId').value = listId;
                    document.getElementById('kebab-' + listId).classList.remove('active');
                    ProfileManager.showModal('createListModal');
                },

                // FIX: Remove Restaurant from List
                async removeRestaurant(e, restaurantId) {
                    e.stopPropagation(); // CRITICAL FIX
                    if(!currentActiveList) return;
                    
                    const { error } = await supabase
                        .from('lists_restraunts')
                        .delete()
                        .match({ list_id: currentActiveList.id, restraunt_id: restaurantId });

                    if(!error) {
                        currentActiveList.restaurants = currentActiveList.restaurants.filter(id => id !== restaurantId);
                        // Re-render current view
                        if(document.getElementById('mobileListDetailSection').style.display === 'block') {
                            renderMobileListRestaurants(currentActiveList.restaurants, currentActiveList);
                        } else {
                            renderListRestaurants(currentActiveList.restaurants, currentActiveList);
                        }
                        showToast('Restaurant removed');
                    }
                },

                renderLists() {
                    const grid = document.getElementById('listsGrid');
                    const mobileGrid = document.getElementById('mobileLists');
                    if(grid) grid.innerHTML = ''; 
                    if(mobileGrid) mobileGrid.innerHTML = '';

                    userLists.forEach(list => {
                        const isDefault = ['Favorites', 'Visited', 'Want to Go'].includes(list.title);
                        const count = list.restaurants ? list.restaurants.length : 0;
                        
                        // Kebab HTML (Only for custom lists)
                        const kebabHtml = isDefault ? '' : `
                            <div class="kebab-menu-container">
                                <div class="kebab-btn" onclick="listManager.toggleKebab(event, '${list.id}')"><i class="fas fa-ellipsis-v"></i></div>
                                <div class="kebab-dropdown" id="kebab-${list.id}">
                                    <button class="kebab-item" onclick="listManager.setupRename(event, '${list.id}')"><i class="fas fa-edit"></i> Rename</button>
                                    <button class="kebab-item delete" onclick="listManager.deleteList(event, '${list.id}')"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </div>
                        `;

                        // Card HTML
                        const html = `
                            <div class="list-card mobile-list-card" onclick="ProfileManager.showList('${list.id}')">
                                ${kebabHtml}
                                <div class="list-card-title">${list.icon || 'üìã'} ${list.title}</div>
                                <p class="list-card-description">${list.description || 'No description'}</p>
                                <span style="font-size:12px; color:var(--muted)">${count} places</span>
                            </div>
                        `;

                        if(grid) grid.innerHTML += html;
                        if(mobileGrid) mobileGrid.innerHTML += html;
                    });
                    
                    // Click outside to close kebabs
                    document.addEventListener('click', () => {
                        document.querySelectorAll('.kebab-dropdown').forEach(d => d.classList.remove('active'));
                    });
                }
            };

            // ===== PUBLIC FUNCTIONS =====
            
            async function handleListSubmit() {
                const title = document.getElementById('listName').value;
                const desc = document.getElementById('listDescription').value;
                const editId = document.getElementById('editListId').value;

                if(!title) return showToast("Name required", "error");

                if(editId) {
                    // Update
                    const { error } = await supabase.from('lists').update({ title, description: desc }).eq('id', editId);
                    if(!error) {
                        const list = userLists.find(l => l.id == editId);
                        list.title = title; list.description = desc;
                        showToast("List renamed");
                    }
                } else {
                    // Create
                    const { data, error } = await supabase.from('lists').insert({ 
                        user_id: currentUser.id, title, description: desc, is_default: false 
                    }).select().single();
                    if(!error && data) {
                        data.restaurants = [];
                        userLists.push(data);
                        showToast("List created");
                    }
                }
                
                closeModal('createListModal');
                listManager.renderLists();
                // Reset form
                document.getElementById('listName').value = '';
                document.getElementById('listDescription').value = '';
                document.getElementById('editListId').value = '';
            }

            function showList(listId) {
                currentActiveList = userLists.find(l => l.id == listId);
                if(!currentActiveList) return;

                // Desktop
                document.getElementById('lists-tab').style.display = 'none';
                document.getElementById('list-detail-view').style.display = 'block';
                document.getElementById('listDetailTitle').textContent = currentActiveList.title;
                document.getElementById('listDetailDescription').textContent = currentActiveList.description || '';
                renderListRestaurants(currentActiveList.restaurants, currentActiveList);

                // Mobile
                const mobSection = document.getElementById('mobileListDetailSection');
                mobSection.style.display = 'block';
                document.getElementById('mobileListDetailTitle').textContent = currentActiveList.title;
                document.getElementById('mobileListDetailDescription').textContent = currentActiveList.description || '';
                renderMobileListRestaurants(currentActiveList.restaurants, currentActiveList);
            }

            function renderListRestaurants(ids, list) {
                const grid = document.getElementById('listRestaurantsGrid');
                grid.innerHTML = '';
                const listRests = restaurants.filter(r => ids.includes(r.id));
                
                listRests.forEach(r => {
                    grid.innerHTML += `
                        <div class="card">
                            <button class="remove-restaurant-btn" onclick="listManager.removeRestaurant(event, ${r.id})"><i class="fas fa-times"></i></button>
                            <div class="card-body"><h3>${r.name}</h3></div>
                        </div>`;
                });
            }

            function renderMobileListRestaurants(ids, list) {
                const container = document.getElementById('mobileListRestaurants');
                container.innerHTML = '';
                const listRests = restaurants.filter(r => ids.includes(r.id));
                
                listRests.forEach(r => {
                    container.innerHTML += `
                        <div class="mobile-list-restaurant-card" style="background:var(--card); padding:15px; margin-bottom:10px; border-radius:8px; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                            <div><strong>${r.name}</strong></div>
                            <button class="remove-restaurant-btn" style="position:static;" onclick="listManager.removeRestaurant(event, ${r.id})"><i class="fas fa-times"></i></button>
                        </div>`;
                });
            }

            // FIX: Unfollow Button Logic
            async function toggleFollow(targetId, btn) {
                // Optimistic UI update
                const isFollowing = btn.classList.contains('btn-error');
                
                if (isFollowing) {
                    // Unfollow
                    const { error } = await supabase.from('follows').delete()
                        .match({ follower_id: currentUser.id, followed_id: targetId });
                    
                    if (!error) {
                        btn.classList.remove('btn-error');
                        btn.classList.add('btn-primary');
                        btn.innerHTML = '<i class="fas fa-user-plus"></i> Follow';
                        btn.style.background = 'var(--accent)';
                        btn.style.color = '#0b1633';
                    }
                } else {
                    // Follow logic...
                }
            }

            function showModal(id) { document.getElementById(id).classList.add('active'); }
            function closeModal(id) { document.getElementById(id).classList.remove('active'); }
            function hideListDetail() { 
                document.getElementById('list-detail-view').style.display = 'none'; 
                document.getElementById('lists-tab').style.display = 'block'; 
            }
            function hideMobileListDetail() {
                document.getElementById('mobileListDetailSection').style.display = 'none';
            }
            function showTab(id) {
                document.querySelectorAll('.tab-content').forEach(d => d.classList.remove('active'));
                document.getElementById(id + '-tab').classList.add('active');
            }

            return {
                initialize, handleListSubmit, showModal, closeModal, 
                showList, hideListDetail, hideMobileListDetail, showTab, toggleFollow, listManager
            };
        })();

        document.addEventListener('DOMContentLoaded', ProfileManager.initialize);
    </script>
</body>
</html>