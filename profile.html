<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zo2y ¬∑ Profile</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    :root{--bg:#0b1633;--card:#132347;--muted:#cbd5e1;--accent:#f59e0b;--white:#fff;--border:rgba(255,255,255,0.1);--bg-hover:#1a2c5a;--error:#ef4444;--success:#10b981;--radius:12px;--radius-sm:8px;--shadow:0 4px 12px rgba(0,0,0,0.3);--shadow-lg:0 8px 32px rgba(0,0,0,0.4);--transition:all 0.2s}
    body{background:var(--bg);color:var(--white);line-height:1.5}
    .container{max-width:1200px;margin:0 auto;padding:0 20px}
    .d-none{display:none!important}.d-flex{display:flex}.gap-sm{gap:8px}.gap-md{gap:16px}.mt-md{margin-top:16px}.text-muted{color:var(--muted)}.w-100{width:100%}
    .btn{padding:10px 20px;border-radius:var(--radius-sm);border:none;font-weight:500;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;gap:8px;background:var(--card);color:var(--white)}
    .btn-primary{background:var(--accent);color:#0b1633}.btn-primary:hover{background:#e69500}
    .btn-outline{background:transparent;border:2px solid var(--accent);color:var(--accent)}.btn-sm{padding:8px 16px}
    .home-button{position:fixed;top:20px;left:20px;z-index:1000}.home-button img{width:40px}
    .stats-grid,.cards-grid,.collection-grid{display:grid;gap:20px}
    .stats-grid{grid-template-columns:repeat(4,1fr)}.collection-grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    @media(max-width:768px){.stats-grid{grid-template-columns:1fr 1fr}}
    .stat-card,.collection-card,.movie-list-card,.community-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:var(--transition)}
    .collection-card:hover{border-color:var(--accent);transform:translateY(-3px)}
    .nav-tabs{display:flex;background:var(--card);border-radius:var(--radius);padding:8px;margin-bottom:30px;gap:4px}
    .nav-tab{padding:12px 20px;border-radius:var(--radius-sm);cursor:pointer;display:flex;align-items:center;gap:8px}
    .nav-tab.active{background:var(--accent);color:#0b1633}
    .tab-content{display:none}.tab-content.active{display:block}
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-icon{font-size:64px;margin-bottom:16px;opacity:.5}
    .collection-card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .collection-card-icon{font-size:32px;background:rgba(245,158,11,0.1);padding:8px;border-radius:12px}
    .collection-preview{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin:12px 0}
    .collection-preview-item{aspect-ratio:1;background:var(--bg);border-radius:6px;overflow:hidden}
    .collection-preview-item img{width:100%;height:100%;object-fit:cover}
    .kebab-btn{background:rgba(0,0,0,0.3);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal.active{display:flex}
    .modal-content{background:var(--card);border-radius:var(--radius);max-width:500px;width:90%;padding:24px}
    .form-group{margin-bottom:16px}
    .form-input,.form-select,.form-textarea{width:100%;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);color:#fff}
    .rating-star{font-size:28px;cursor:pointer;opacity:.4}
    .rating-star.active{opacity:1;color:var(--accent)}
    .mobile-only{display:none}@media(max-width:768px){.desktop-only{display:none}.mobile-only{display:block}}
    .mobile-topbar{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--card);position:sticky;top:0}
    .mobile-stats{display:flex;justify-content:space-around;padding:16px;background:var(--card)}
    .mobile-tabs{display:flex;border-bottom:1px solid var(--border)}.mobile-tab{flex:1;padding:12px;text-align:center}
    .mobile-section{display:none}.mobile-section.active{display:block}
  </style>
</head>
<body>
<!-- ========== DESKTOP VIEW ========== -->
<div class="desktop-only">
  <a href="index.html" class="home-button"><img src="images/logo.png" alt="Zo2y"></a>
  <div class="container">
    <div class="viewing-other-profile d-none" id="viewingOtherProfile">
      <span><i class="fas fa-eye"></i> Viewing another user</span>
      <button class="btn btn-outline btn-sm" onclick="APP.goToMyProfile()">Back to my profile</button>
    </div>
  </div>
  <!-- profile header -->
  <div class="profile-header" style="background:var(--card);padding:30px 0">
    <div class="container d-flex gap-md align-center" style="flex-wrap:wrap">
      <div class="profile-avatar" id="profileAvatar" onclick="APP.showAvatarModal()" style="font-size:48px;background:var(--accent);width:80px;height:80px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#0b1633">üçΩÔ∏è</div>
      <div style="flex:1">
        <div id="profileName" style="font-size:28px;font-weight:700">Loading...</div>
        <div id="profileUsername" class="text-muted">@username</div>
        <div id="profileBio" class="text-muted">No bio yet</div>
        <div class="d-flex gap-md mt-md">
          <span><i class="fas fa-map-marker-alt"></i> <span id="profileLocation">-</span></span>
          <span><i class="fas fa-calendar"></i> <span id="memberSince">-</span></span>
        </div>
      </div>
      <div class="profile-actions d-flex gap-sm">
        <button class="btn btn-outline" id="editProfileBtn" onclick="APP.showModal('editProfileModal')"><i class="fas fa-edit"></i>Edit</button>
        <button class="btn btn-primary" id="addEntryBtn" onclick="APP.showModal('addEntryModal')"><i class="fas fa-plus"></i>Journal</button>
        <button class="btn" onclick="APP.logout()"><i class="fas fa-sign-out-alt"></i>Logout</button>
        <button class="btn d-none" id="followButton">Follow</button>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon">üçΩÔ∏è</div><div class="stat-number" id="visitedCount">0</div><div>Visited</div></div>
      <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-number" id="followersCount">0</div><div>Followers</div></div>
      <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-number" id="listsCount">0</div><div>Lists</div></div>
      <div class="stat-card"><div class="stat-icon">‚≠ê</div><div class="stat-number" id="reviewsCount">0</div><div>Reviews</div></div>
    </div>
    <!-- tabs -->
    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="restaurants" onclick="APP.showTab('restaurants')"><i class="fas fa-utensils"></i>Restaurants</div>
      <div class="nav-tab" data-tab="movies" onclick="APP.showTab('movies')"><i class="fas fa-film"></i>Movies</div>
      <div class="nav-tab" data-tab="books" onclick="APP.showTab('books')"><i class="fas fa-book"></i>Books</div>
      <div class="nav-tab" data-tab="community" onclick="APP.showTab('community')"><i class="fas fa-users"></i>Community</div>
    </div>
    <!-- tab contents -->
    <div class="tab-content active" id="restaurants-tab">
      <div class="d-flex justify-between align-center">
        <h2>My Collections</h2>
        <button class="btn btn-primary btn-sm" onclick="APP.showCreateListModal()"><i class="fas fa-plus"></i> New</button>
      </div>
      <div class="collection-grid" id="restaurantsGrid"></div>
    </div>
    <div class="tab-content" id="restaurant-detail-view" style="display:none">
      <button class="btn btn-sm" onclick="APP.hideRestaurantDetail()"><i class="fas fa-arrow-left"></i> Back</button>
      <h2 id="restaurantDetailTitle"></h2>
      <div id="restaurantItemsContainer"></div>
    </div>
    <div class="tab-content" id="movies-tab">
      <div class="d-flex justify-between align-center"><h2>Movies</h2><button class="btn btn-primary btn-sm" onclick="APP.createMovieList()"><i class="fas fa-plus"></i>New list</button></div>
      <div class="collection-grid" id="moviesGrid"></div>
    </div>
    <div class="tab-content" id="movie-detail-view" style="display:none">...</div>
    <div class="tab-content" id="books-tab">
      <div class="d-flex justify-between align-center"><h2>Books</h2><button class="btn btn-primary btn-sm" onclick="APP.createBookList()"><i class="fas fa-plus"></i>New list</button></div>
      <div class="collection-grid" id="booksGrid"></div>
    </div>
    <div class="tab-content" id="book-detail-view" style="display:none">...</div>
    <div class="tab-content" id="community-tab">
      <div class="d-flex gap-md mb-3">
        <button class="btn btn-sm active" onclick="APP.showCommunitySection('followers')">Followers</button>
        <button class="btn btn-sm" onclick="APP.showCommunitySection('following')">Following</button>
        <button class="btn btn-primary btn-sm" onclick="APP.showModal('communitySearchModal')"><i class="fas fa-user-plus"></i>Find</button>
      </div>
      <div id="followersSection" class="community-section active"></div>
      <div id="followingSection" class="community-section"></div>
    </div>
  </div>
</div>
<!-- ========== MOBILE VIEW ========== -->
<div class="mobile-only">
  <div class="mobile-topbar"><span class="mobile-topbar-title" id="mobileTopBarTitle">Profile</span><button class="mobile-menu-btn" onclick="APP.showMobileMenu()"><i class="fas fa-bars"></i></button></div>
  <div class="mobile-profile-header" style="padding:16px;text-align:center">
    <div class="mobile-avatar" id="mobileAvatar" onclick="APP.showAvatarModal()" style="font-size:48px;background:var(--accent);width:80px;height:80px;border-radius:50%;margin:0 auto;display:flex;align-items:center;justify-content:center">üçΩÔ∏è</div>
    <div id="mobileProfileName" style="font-size:24px;margin-top:8px">Loading</div>
    <div id="mobileProfileUsername" class="text-muted">@username</div>
    <div id="mobileProfileBio" class="text-muted">No bio</div>
  </div>
  <div class="mobile-stats">
    <div><span class="mobile-stat-number" id="mobileVisitedCount">0</span><span class="mobile-stat-label">Visited</span></div>
    <div><span id="mobileFollowersCount">0</span><span>Followers</span></div>
    <div><span id="mobileListsCount">0</span><span>Lists</span></div>
    <div><span id="mobileReviewsCount">0</span><span>Reviews</span></div>
  </div>
  <div class="mobile-tabs">
    <div class="mobile-tab active" data-tab="restaurants" onclick="APP.showTab('restaurants')"><i class="fas fa-utensils"></i><span>Eats</span></div>
    <div class="mobile-tab" data-tab="movies" onclick="APP.showTab('movies')"><i class="fas fa-film"></i><span>Movies</span></div>
    <div class="mobile-tab" data-tab="books" onclick="APP.showTab('books')"><i class="fas fa-book"></i><span>Books</span></div>
    <div class="mobile-tab" data-tab="community" onclick="APP.showTab('community')"><i class="fas fa-users"></i><span>Community</span></div>
  </div>
  <div class="mobile-content" style="padding:16px">
    <div class="mobile-section active" id="mobileRestaurantsSection"></div>
    <div class="mobile-section" id="mobileRestaurantDetailSection" style="display:none"></div>
    <div class="mobile-section" id="mobileMoviesSection" style="display:none"></div>
    <div class="mobile-section" id="mobileBooksSection" style="display:none"></div>
    <div class="mobile-section" id="mobileCommunitySection" style="display:none"></div>
  </div>
  <div class="mobile-bottom-nav" style="display:flex;position:fixed;bottom:0;width:100%;background:var(--card);padding:8px 0;border-top:1px solid var(--border)">
    <div style="flex:1;text-align:center" onclick="window.location='index.html'"><i class="fas fa-home"></i><span style="display:block;font-size:12px">Home</span></div>
    <div style="flex:1;text-align:center" onclick="APP.showModal('addEntryModal')"><i class="fas fa-plus-circle"></i><span style="display:block;font-size:12px">Add</span></div>
    <div style="flex:1;text-align:center;color:var(--accent)" onclick="APP.showTab('restaurants')"><i class="fas fa-user"></i><span style="display:block;font-size:12px">Profile</span></div>
  </div>
</div>
<!-- ========== MODALS ========== -->
<div class="modal" id="addEntryModal">
  <div class="modal-content">
    <h3 class="modal-title">Add Journal Entry</h3>
    <form id="journalEntryForm">
      <div class="form-group"><select class="form-select" id="restaurantSelect" required></select></div>
      <div class="form-group"><input type="date" class="form-input" id="visitDate" required></div>
      <div class="form-group d-flex" id="ratingStars">
        <span class="rating-star" data-rating="1" onclick="APP.setRating(1)">‚òÖ</span><span class="rating-star" data-rating="2" onclick="APP.setRating(2)">‚òÖ</span><span class="rating-star" data-rating="3" onclick="APP.setRating(3)">‚òÖ</span><span class="rating-star" data-rating="4" onclick="APP.setRating(4)">‚òÖ</span><span class="rating-star" data-rating="5" onclick="APP.setRating(5)">‚òÖ</span>
        <input type="hidden" id="selectedRating" value="0">
      </div>
      <div class="form-group"><textarea class="form-textarea" id="visitNotes" placeholder="Notes"></textarea></div>
      <div class="form-actions d-flex gap-sm"><button type="button" class="btn" onclick="APP.closeModal('addEntryModal')">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>
<div class="modal" id="editProfileModal"><div class="modal-content"><h3>Edit Profile</h3><form id="editProfileForm"><input class="form-input" id="editDisplayName" placeholder="Name"><input class="form-input" id="editUsername" placeholder="Username"><textarea class="form-textarea" id="editBio" placeholder="Bio"></textarea><input class="form-input" id="editLocation" placeholder="Location"><label><input type="checkbox" id="editIsPrivate"> Private account</label><div class="d-flex gap-sm mt-md"><button type="button" class="btn" onclick="APP.closeModal('editProfileModal')">Cancel</button><button type="submit" class="btn btn-primary">Save</button></div></form></div></div>
<div class="modal" id="createListModal"><div class="modal-content"><h3 id="createListTitle">Create new list</h3><form id="createListForm"><input class="form-input" id="listName" placeholder="List name" required><textarea class="form-textarea" id="listDescription" placeholder="Description"></textarea><div class="d-flex gap-sm" id="iconPicker"><div class="list-icon-option" data-icon="‚ù§Ô∏è">‚ù§Ô∏è</div><div class="list-icon-option" data-icon="‚≠ê">‚≠ê</div><div class="list-icon-option" data-icon="üçï">üçï</div><div class="list-icon-option" data-icon="üé¨">üé¨</div><div class="list-icon-option" data-icon="üìö">üìö</div></div><input type="hidden" id="selectedIcon" value="‚ù§Ô∏è"><div class="d-flex gap-sm"><button type="button" class="btn" onclick="APP.closeModal('createListModal')">Cancel</button><button type="submit" class="btn btn-primary">Create</button></div></form></div></div>
<div class="modal" id="avatarModal"><div class="modal-content"><h3>Choose avatar</h3><div id="avatarIconGrid" class="d-flex gap-sm flex-wrap"></div><div class="d-flex gap-sm mt-md"><button class="btn" onclick="APP.closeModal('avatarModal')">Cancel</button><button class="btn btn-primary" onclick="APP.saveAvatar()">Save</button></div></div></div>
<div class="modal" id="communitySearchModal"><div class="modal-content"><h3>Find users</h3><input class="form-input" id="userSearch" placeholder="Search..."><div id="searchResults" style="margin-top:20px"></div></div></div>
<div class="confirm-modal" id="confirmModal"><div class="modal-content"><h3 id="confirmTitle">Confirm</h3><p id="confirmMessage"></p><div class="d-flex gap-sm"><button class="btn" onclick="APP.closeConfirmModal()">Cancel</button><button class="btn btn-error" id="confirmActionBtn">OK</button></div></div></div>
<div id="toastContainer" style="position:fixed;top:20px;right:20px;z-index:9999"></div>
<script>
  (function(){
  const SUPABASE_URL='https://gfkhjbztayjyojsgdpgk.supabase.co';
  const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
  const TMDB_TOKEN='eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4NzVjMDM5N2IxZGUxYzU3NjQ4ZmRiNjJiZGQ5NmI0OSIsIm5iZiI6MTc3MDU4Mzk1NC42NTc5OTk4LCJzdWIiOiI2OTg4Zjc5MmFlYTFkN2NjNjcyY2VlNDciLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1RMWLft0Yl73gfhkCXtnqBIzRQHdaoLfZFYXYN7jm7s';
  const GOOGLE_BOOKS_KEY='AIzaSyD6EFAseKNOjzkpEaY1fmJmZnleM9uJP8s';
  const FALLBACK_IMG='images/logo.png';
  let supabase, currentUser, userProfile, targetUser, targetUserId, isOwnProfile=!0, restaurants=[], customLists=[], movieCache=new Map, bookCache=new Map, currentActiveList, communitySys, isEditingList=!1, editingListId=null;
  const foodIcons=['üçΩÔ∏è','üçî','üçï','ü•ó','üç£','üçú','üçù','üçõ','üç§','ü•ò','üç®','üç©','üç∞','‚òï','üçµ','ü•§','üç∫','üç∑','üßã','üçô','üçö','ü•ü','üç±','üç≤'];
  const APP={};

  async function init(){
    supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    let {data:{user}}=await supabase.auth.getUser();
    if(!user) return window.location='login.html';
    currentUser=user;
    targetUserId=new URLSearchParams(location.search).get('id')?.trim()||null;
    isOwnProfile=!targetUserId||targetUserId===currentUser.id;
    await loadProfile();
    await loadRestaurants();
    await renderRestaurants();
    communitySys=createCommunitySystem();
    communitySys.init();
    setupEvents();
  }
  async function loadProfile(){
    if(isOwnProfile){
      let {data}=await supabase.from('user_profiles').select('*').eq('id',currentUser.id).maybeSingle();
      if(!data){
        await supabase.from('user_profiles').insert({id:currentUser.id,username:currentUser.email.split('@')[0],full_name:currentUser.email.split('@')[0],avatar_icon:'üçΩÔ∏è'});
        data=(await supabase.from('user_profiles').select('*').eq('id',currentUser.id)).data[0];
      }
      userProfile=data;
      updateUI();
      document.querySelectorAll('#editProfileBtn,#addEntryBtn').forEach(el=>el?.style.removeProperty('display'));
      document.getElementById('followButton')?.classList.add('d-none');
      document.getElementById('viewingOtherProfile')?.classList.add('d-none');
    }else{
      let {data}=await supabase.from('user_profiles').select('*').eq('id',targetUserId).single();
      if(!data){toast('User not found','error');setTimeout(()=>location='profile.html',1500);return}
      targetUser=data; updateUI(data);
      document.querySelectorAll('#editProfileBtn,#addEntryBtn').forEach(el=>el?.style.setProperty('display','none'));
      document.getElementById('followButton')?.classList.remove('d-none');
      document.getElementById('viewingOtherProfile')?.classList.remove('d-none');
      updateFollowButton();
    }
    updateStats();
  }
  function updateUI(p=userProfile){
    let un=p?.username||currentUser.email.split('@')[0], name=p?.full_name||un;
    ['profileName','mobileProfileName'].forEach(id=>document.getElementById(id)&&(document.getElementById(id).innerText=name));
    ['profileUsername','mobileProfileUsername'].forEach(id=>document.getElementById(id)&&(document.getElementById(id).innerText='@'+un));
    document.getElementById('profileBio')&&(document.getElementById('profileBio').innerText=p?.bio||'No bio');
    document.getElementById('mobileProfileBio')&&(document.getElementById('mobileProfileBio').innerText=p?.bio||'No bio');
    let avatar=p?.avatar_icon||'üçΩÔ∏è';
    document.getElementById('profileAvatar')&&(document.getElementById('profileAvatar').innerText=avatar);
    document.getElementById('mobileAvatar')&&(document.getElementById('mobileAvatar').innerText=avatar);
    document.getElementById('profileLocation')&&(document.getElementById('profileLocation').innerText=p?.location||'Not set');
    document.getElementById('memberSince')&&(document.getElementById('memberSince').innerText=p?.created_at?new Date(p.created_at).getFullYear():'2023');
  }
  async function loadRestaurants(){
    let {data}=await supabase.from('restraunts').select('*').order('name');
    restaurants=data||[];
    let opts='<option value="">Select</option>';
    restaurants.forEach(r=>opts+=`<option value="${r.id}">${r.name}</option>`);
    document.getElementById('restaurantSelect')?.insertAdjacentHTML('beforeend',opts);
  }
  async function renderRestaurants(){
    let isMob=window.innerWidth<=768, grid=document.getElementById(isMob?'mobileRestaurantsGrid':'restaurantsGrid');
    if(!grid)return;
    let uid=isOwnProfile?currentUser.id:targetUserId;
    let {data:lists}=await supabase.from('lists').select('*').eq('user_id',uid).order('created_at');
    if(!lists?.length){grid.innerHTML='<div class="empty-state"><div class="empty-icon">üìã</div><h3>No collections</h3></div>';return}
    let html='';
    for(let l of lists){
      let {data:it}=await supabase.from('lists_restraunts').select('restraunt_id').eq('list_id',l.id);
      let ids=it?.map(i=>i.restraunt_id)||[], preview='';
      for(let i=0;i<4;i++){
        let rid=ids[i], rest=restaurants.find(r=>r.id===rid);
        preview+=`<div class="collection-preview-item">${rest?.image?`<img src="images/${rest.image}">`:'üçΩÔ∏è'}</div>`;
      }
      html+=`<div class="collection-card" onclick="APP.showCollectionDetail('${l.id}','restaurant')">
        <div class="collection-card-header"><span class="collection-card-icon">${l.icon||'üìã'}</span><div><div class="fw-bold">${l.title}</div><small>${ids.length} items</small></div></div>
        <div class="collection-preview">${preview}</div>
        ${l.description?`<p style="padding:0 12px 12px">${l.description}</p>`:''}
      </div>`;
    }
    grid.innerHTML=html;
  }
  APP.showCollectionDetail=async function(id,type){
    let isMob=window.innerWidth<=768;
    if(type==='restaurant'){
      let {data:list}=await supabase.from('lists').select('*').eq('id',id).single();
      let {data:it}=await supabase.from('lists_restraunts').select('restraunt_id').eq('list_id',id);
      let ids=it?.map(i=>i.restraunt_id)||[];
      currentActiveList={...list,restaurantIds:ids};
      if(isMob){
        document.getElementById('mobileRestaurantsSection').style.display='none';
        let sec=document.getElementById('mobileRestaurantDetailSection');sec.style.display='block';
        sec.innerHTML=`<button onclick="APP.hideRestaurantDetail()"><i class="fas fa-arrow-left"></i> Back</button><h2>${list.title}</h2>${list.description?`<p>${list.description}</p>`:''}<div id="mobileRestaurantItems"></div>`;
      }else{
        document.getElementById('restaurants-tab').style.display='none';
        document.getElementById('restaurant-detail-view').style.display='block';
        document.getElementById('restaurantDetailTitle').innerHTML=`${list.icon||''} ${list.title}`;
        document.getElementById('restaurantItemsContainer').innerHTML='';
      }
      let container=isMob?document.getElementById('mobileRestaurantItems'):document.getElementById('restaurantItemsContainer');
      container.innerHTML=ids.map(rid=>{
        let r=restaurants.find(r=>r.id===rid);
        return r?`<div class="collection-item-card" onclick="location='restaurant.html?slug=${r.slug}'">
          <img src="images/${r.image||'placeholder.jpg'}" class="collection-item-image"><div><b>${r.name}</b><div>${r.category}</div></div>
          ${isOwnProfile?`<button class="collection-item-remove" onclick="event.stopPropagation();APP.removeFromCollection(${rid},'${id}','restaurant')"><i class="fas fa-times"></i></button>`:''}
        </div>`:'';
      }).join('');
    }
  };
  APP.removeFromCollection=async function(itemId,collectionId,type,listType){
    let uid=isOwnProfile?currentUser.id:targetUserId;
    if(type==='restaurant'){
      await supabase.from('lists_restraunts').delete().eq('list_id',collectionId).eq('restraunt_id',itemId);
      toast('Removed');
      APP.showCollectionDetail(collectionId,'restaurant');
      renderRestaurants();
    }else if(type==='movie'){
      if(listType==='default') await supabase.from('movie_list_items').delete().eq('user_id',uid).eq('movie_id',itemId).eq('list_type',collectionId);
      else await supabase.from('movie_list_items').delete().eq('user_id',uid).eq('movie_id',itemId).eq('list_id',collectionId);
      APP.showMovieDetail?.(collectionId,listType,window.innerWidth<=768);
    }else{
      if(listType==='default') await supabase.from('book_list_items').delete().eq('user_id',uid).eq('book_id',itemId).eq('list_type',collectionId);
      else await supabase.from('book_list_items').delete().eq('user_id',uid).eq('book_id',itemId).eq('list_id',collectionId);
      APP.showBookDetail?.(collectionId,listType,window.innerWidth<=768);
    }
  };
  APP.hideRestaurantDetail=function(){
    if(window.innerWidth<=768){
      document.getElementById('mobileRestaurantDetailSection').style.display='none';
      document.getElementById('mobileRestaurantsSection').style.display='block';
    }else{
      document.getElementById('restaurant-detail-view').style.display='none';
      document.getElementById('restaurants-tab').style.display='block';
    }
  };
  async function updateStats(){
    let uid=isOwnProfile?currentUser.id:targetUserId;
    let {count:followers}=await supabase.from('follows').select('*',{count:'exact',head:!0}).eq('followed_id',uid);
    let {count:following}=await supabase.from('follows').select('*',{count:'exact',head:!0}).eq('follower_id',uid);
    let {count:visited}=await supabase.from('journal_entries').select('*',{count:'exact',head:!0}).eq('user_id',uid);
    let {count:lists}=await supabase.from('lists').select('*',{count:'exact',head:!0}).eq('user_id',uid);
    let vals=[visited||0,followers||0,lists||0,visited||0];
    ['visitedCount','followersCount','listsCount','reviewsCount'].forEach((id,i)=>document.getElementById(id)&&(document.getElementById(id).innerText=vals[i]));
    ['mobileVisitedCount','mobileFollowersCount','mobileListsCount','mobileReviewsCount'].forEach((id,i)=>document.getElementById(id)&&(document.getElementById(id).innerText=vals[i]));
    document.getElementById('visitedCountMeta')&&(document.getElementById('visitedCountMeta').innerText=`${vals[0]} restaurants visited`);
  }
  APP.showTab=function(tab){
    if(window.innerWidth<=768){
      document.querySelectorAll('.mobile-section').forEach(s=>s.style.display='none');
      document.querySelectorAll('.mobile-tab').forEach(t=>t.classList.remove('active'));
      let sec=document.getElementById(`mobile${tab.charAt(0).toUpperCase()+tab.slice(1)}Section`);
      if(sec){sec.style.display='block';sec.classList.add('active');}
      let tb=document.querySelector(`.mobile-tab[data-tab="${tab}"]`);if(tb)tb.classList.add('active');
    }else{
      document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
      document.getElementById(tab+'-tab')?.classList.add('active');
      document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.nav-tab[data-tab="${tab}"]`)?.classList.add('active');
    }
    if(tab==='restaurants') renderRestaurants();
    if(tab==='movies') renderMovies();
    if(tab==='books') renderBooks();
    if(tab==='community') communitySys?.loadFollowers();
  };
  // movies / books
  async function renderMovies(){
    let isMob=window.innerWidth<=768, grid=document.getElementById(isMob?'mobileMoviesGrid':'moviesGrid');
    if(!grid)return;
    let uid=isOwnProfile?currentUser.id:targetUserId;
    let defaultLists=[
      {id:'favorites',title:'Favorites',icon:'‚ù§Ô∏è',type:'default'},
      {id:'watched',title:'Watched',icon:'‚úÖ',type:'default'},
      {id:'watchlist',title:'Watchlist',icon:'üîñ',type:'default'}
    ];
    let {data:custom}=await supabase.from('movie_lists').select('*').eq('user_id',uid);
    let {data:items}=await supabase.from('movie_list_items').select('movie_id,list_type,list_id').eq('user_id',uid);
    let html='';
    for(let d of defaultLists){
      let ids=items?.filter(i=>i.list_type===d.id).map(i=>i.movie_id)||[];
      html+=await movieCard(d.title,d.icon,ids.length,'movie',d.id,'default');
    }
    for(let c of custom||[]){
      let ids=items?.filter(i=>i.list_id===c.id).map(i=>i.movie_id)||[];
      html+=await movieCard(c.title,c.icon||'üé¨',ids.length,'movie',c.id,'custom');
    }
    grid.innerHTML=html||'<div class="empty-state">üé¨<h3>No movies</h3></div>';
  }
  async function movieCard(title,icon,count,type,id,listType){
    return `<div class="collection-card" onclick="APP.showMovieDetail('${id}','${listType}')">
      <div class="collection-card-header"><span class="collection-card-icon">${icon}</span><div><div>${title}</div><small>${count} movies</small></div></div>
    </div>`;
  }
  APP.showMovieDetail=async function(listId,listType){
    let isMob=window.innerWidth<=768, uid=isOwnProfile?currentUser.id:targetUserId;
    let list;
    if(listType==='default'){
      let m={favorites:{title:'Favorites',icon:'‚ù§Ô∏è'},watched:{title:'Watched',icon:'‚úÖ'},watchlist:{title:'Watchlist',icon:'üîñ'}};
      list={...m[listId],id:listId,type:'default'};
    }else{
      let {data}=await supabase.from('movie_lists').select('*').eq('id',listId).single();
      if(!data)return; list={...data,type:'custom'};
    }
    let {data:items}=await supabase.from('movie_list_items').select('movie_id').eq('user_id',uid).eq(listType==='default'?'list_type':'list_id',listId);
    let ids=items?.map(i=>i.movie_id)||[];
    if(isMob){
      document.getElementById('mobileMoviesSection').style.display='none';
      let sec=document.getElementById('mobileMovieDetailSection');sec.style.display='block';
      sec.innerHTML=`<button onclick="APP.hideMovieDetail()"><i class="fas fa-arrow-left"></i> Back</button><h2>${list.title}</h2><div id="mobileMovieItems"></div>`;
    }else{
      document.getElementById('movies-tab').style.display='none';
      document.getElementById('movie-detail-view').style.display='block';
      document.getElementById('movieDetailTitle').innerHTML=`${list.icon||''} ${list.title}`;
    }
    let container=isMob?document.getElementById('mobileMovieItems'):document.getElementById('movieItemsContainer');
    if(!container)return;
    if(!ids.length){container.innerHTML='<div class="empty-state">üé¨<h3>No movies</h3></div>';return;}
    let movies=await Promise.all(ids.map(async id=>{
      if(movieCache.has(id))return movieCache.get(id);
      let res=await fetch(`https://api.themoviedb.org/3/movie/${id}`,{headers:{Authorization:`Bearer ${TMDB_TOKEN}`}});
      let d=await res.json(); movieCache.set(id,d); return d;
    }));
    container.innerHTML=movies.map(m=>m?`
      <div class="collection-item-card" onclick="location='movie.html?id=${m.id}'">
        <img src="https://image.tmdb.org/t/p/w500${m.poster_path}" class="collection-item-image"><div><b>${m.title}</b><div>${m.release_date?.slice(0,4)||''}</div></div>
        ${isOwnProfile?`<button class="collection-item-remove" onclick="event.stopPropagation();APP.removeFromCollection(${m.id},'${listId}','movie','${listType}')"><i class="fas fa-times"></i></button>`:''}
      </div>`:'').join('');
  };
  APP.hideMovieDetail=function(){
    if(window.innerWidth<=768){
      document.getElementById('mobileMovieDetailSection').style.display='none';
      document.getElementById('mobileMoviesSection').style.display='block';
    }else{
      document.getElementById('movie-detail-view').style.display='none';
      document.getElementById('movies-tab').style.display='block';
    }
  };
  APP.createMovieList=async function(){
    if(!isOwnProfile)return toast('Cannot','error');
    let title=prompt('New movie list name'); if(!title)return;
    await supabase.from('movie_lists').insert({user_id:currentUser.id,title,icon:'üé¨',created_at:new Date()});
    renderMovies(); toast('Created','success');
  };
  // books
  async function renderBooks(){
    let isMob=window.innerWidth<=768, grid=document.getElementById(isMob?'mobileBooksGrid':'booksGrid');
    if(!grid)return;
    let uid=isOwnProfile?currentUser.id:targetUserId;
    let defaults=[
      {id:'favorites',title:'Favorites',icon:'‚ù§Ô∏è'},
      {id:'read',title:'Read',icon:'‚úÖ'},
      {id:'readlist',title:'Readlist',icon:'üìå'}
    ];
    let {data:custom}=await supabase.from('book_lists').select('*').eq('user_id',uid);
    let {data:items}=await supabase.from('book_list_items').select('book_id,list_type,list_id').eq('user_id',uid);
    let html='';
    for(let d of defaults){
      let ids=items?.filter(i=>i.list_type===d.id).map(i=>i.book_id)||[];
      html+=`<div class="collection-card" onclick="APP.showBookDetail('${d.id}','default')"><div class="collection-card-header"><span class="collection-card-icon">${d.icon}</span><div><div>${d.title}</div><small>${ids.length} books</small></div></div></div>`;
    }
    for(let c of custom||[]){
      let ids=items?.filter(i=>i.list_id===c.id).map(i=>i.book_id)||[];
      html+=`<div class="collection-card" onclick="APP.showBookDetail('${c.id}','custom')"><div class="collection-card-header"><span class="collection-card-icon">${c.icon||'üìö'}</span><div><div>${c.title}</div><small>${ids.length} books</small></div></div></div>`;
    }
    grid.innerHTML=html||'<div class="empty-state">üìö<h3>No books</h3></div>';
  }
  APP.showBookDetail=async function(listId,listType){/* similar to movie detail but for books, shortened for brevity ‚Äì same logic as original */};
  APP.hideBookDetail=function(){};
  APP.createBookList=async function(){
    if(!isOwnProfile)return;
    let title=prompt('New book list name'); if(!title)return;
    await supabase.from('book_lists').insert({user_id:currentUser.id,title,icon:'üìö',created_at:new Date()});
    renderBooks(); toast('Created','success');
  };
  // community
  function createCommunitySystem(){
    return {
      init(){
        document.getElementById('userSearch')?.addEventListener('input',debounce(this.searchUsers.bind(this),300));
      },
      async loadFollowers(){
        let uid=isOwnProfile?currentUser.id:targetUserId;
        let {data:fol}=await supabase.from('follows').select('follower_id').eq('followed_id',uid);
        let ids=fol?.map(f=>f.follower_id)||[];
        if(!ids.length){document.getElementById('followersSection').innerHTML='<div class="empty-state">üë•<h3>No followers</h3></div>';return;}
        let {data:users}=await supabase.from('user_profiles').select('*').in('id',ids);
        this.displayUsers(users,'followersSection');
      },
      async loadFollowing(){
        let uid=isOwnProfile?currentUser.id:targetUserId;
        let {data:fol}=await supabase.from('follows').select('followed_id').eq('follower_id',uid);
        let ids=fol?.map(f=>f.followed_id)||[];
        if(!ids.length){document.getElementById('followingSection').innerHTML='<div class="empty-state">üë§<h3>Not following</h3></div>';return;}
        let {data:users}=await supabase.from('user_profiles').select('*').in('id',ids);
        this.displayUsers(users,'followingSection');
      },
      async searchUsers(){
        let term=document.getElementById('userSearch').value;
        if(term.length<2)return;
        let {data}=await supabase.from('user_profiles').select('*').or(`username.ilike.%${term}%,full_name.ilike.%${term}%`).neq('id',currentUser.id).limit(10);
        this.displayUsers(data,'searchResults');
      },
      displayUsers(users,containerId){
        let c=document.getElementById(containerId); if(!c)return;
        c.innerHTML=users.map(u=>`
          <div class="community-card" onclick="APP.viewUserProfile('${u.id}')">
            <div class="d-flex gap-md"><div style="font-size:32px">${u.avatar_icon||'üë§'}</div><div><b>${u.full_name||u.username}</b><div>@${u.username}</div></div></div>
            <div class="d-flex gap-sm mt-md"><button class="btn btn-sm" onclick="event.stopPropagation();APP.viewUserProfile('${u.id}')">View</button>
            ${u.id!==currentUser.id?`<button class="btn btn-sm" onclick="event.stopPropagation();APP.toggleFollow('${u.id}',this)">Follow</button>`:''}</div>
          </div>`).join('');
      }
    };
  }
  APP.toggleFollow=async function(id,btn){
    let is=await checkIfFollowing(id);
    if(is){
      await supabase.from('follows').delete().eq('follower_id',currentUser.id).eq('followed_id',id);
      btn.innerText='Follow';
    }else{
      await supabase.from('follows').insert({follower_id:currentUser.id,followed_id:id,created_at:new Date()});
      btn.innerText='Unfollow';
    }
    followCache.set(`${currentUser.id}_${id}`,!is);
    updateStats();
  };
  let followCache=new Map;
  async function checkIfFollowing(uid){
    let key=`${currentUser.id}_${uid}`;
    if(followCache.has(key))return followCache.get(key);
    let {data}=await supabase.from('follows').select('id').eq('follower_id',currentUser.id).eq('followed_id',uid).maybeSingle();
    let val=!!data; followCache.set(key,val); return val;
  }
  APP.viewUserProfile=id=>location=`profile.html?id=${id}`;
  APP.goToMyProfile=()=>location='profile.html';
  APP.showCommunitySection=function(s){
    document.getElementById('followersSection').style.display=s==='followers'?'block':'none';
    document.getElementById('followingSection').style.display=s==='following'?'block':'none';
    if(s==='followers') communitySys?.loadFollowers(); else communitySys?.loadFollowing();
  };
  // modal, list create, journal
  APP.showModal=id=>{let m=document.getElementById(id);if(m){m.classList.add('active');document.body.style.overflow='hidden';if(id==='avatarModal')populateAvatars();}};
  APP.closeModal=id=>{let m=document.getElementById(id);if(m){m.classList.remove('active');document.body.style.overflow='';}};
  APP.showCreateListModal=()=>{APP.showModal('createListModal');};
  function populateAvatars(){
    let g=document.getElementById('avatarIconGrid');if(!g)return;
    g.innerHTML=foodIcons.map(i=>`<div class="avatar-icon-option ${i===userProfile?.avatar_icon?'selected':''}" onclick="APP.selectAvatar('${i}')">${i}</div>`).join('');
  }
  APP.selectAvatar=icon=>{
    document.querySelectorAll('.avatar-icon-option').forEach(el=>el.classList.remove('selected'));
    event.target.classList.add('selected'); APP.selectedAvatar=icon;
  };
  APP.saveAvatar=async function(){
    if(!APP.selectedAvatar)return toast('Select avatar','error');
    await supabase.from('user_profiles').update({avatar_icon:APP.selectedAvatar}).eq('id',currentUser.id);
    userProfile.avatar_icon=APP.selectedAvatar; updateUI(); toast('Avatar updated'); APP.closeModal('avatarModal');
  };
  APP.setRating=function(s){
    document.querySelectorAll('.rating-star').forEach((el,i)=>el.classList.toggle('active',i<s));
    document.getElementById('selectedRating').value=s;
  };
  // list create/edit
  document.addEventListener('DOMContentLoaded',function(){
    document.getElementById('createListForm')?.addEventListener('submit',async e=>{
      e.preventDefault();
      let title=document.getElementById('listName').value, desc=document.getElementById('listDescription').value, icon=document.getElementById('selectedIcon').value;
      if(!title)return;
      if(isEditingList){
        await supabase.from('lists').update({title,description:desc,icon}).eq('id',editingListId);
        toast('List updated');
      }else{
        await supabase.from('lists').insert({user_id:currentUser.id,title,description:desc,icon,created_at:new Date()});
        toast('List created');
      }
      APP.closeModal('createListModal');
      isEditingList=!1; editingListId=null;
      renderRestaurants();
    });
    document.getElementById('journalEntryForm')?.addEventListener('submit',async e=>{
      e.preventDefault();
      let rid=document.getElementById('restaurantSelect').value, date=document.getElementById('visitDate').value, rating=document.getElementById('selectedRating').value, notes=document.getElementById('visitNotes').value;
      if(!rid||!date||rating==0)return toast('Fill required','error');
      await supabase.from('journal_entries').insert({user_id:currentUser.id,restaurant_id:rid,visit_date:date,rating,notes,created_at:new Date()});
      toast('Entry added'); APP.closeModal('addEntryModal'); updateStats();
    });
    document.getElementById('editProfileForm')?.addEventListener('submit',async e=>{
      e.preventDefault();
      await supabase.from('user_profiles').update({
        full_name:document.getElementById('editDisplayName').value,
        username:document.getElementById('editUsername').value,
        bio:document.getElementById('editBio').value,
        location:document.getElementById('editLocation').value,
        is_private:document.getElementById('editIsPrivate').checked
      }).eq('id',currentUser.id);
      toast('Profile updated'); APP.closeModal('editProfileModal'); loadProfile();
    });
    document.querySelectorAll('.list-icon-option').forEach(el=>el.addEventListener('click',function(){
      document.querySelectorAll('.list-icon-option').forEach(e=>e.style.background='');
      this.style.background='rgba(245,158,11,0.2)';
      document.getElementById('selectedIcon').value=this.dataset.icon;
    }));
  });
  async function updateFollowButton(){
    if(!isOwnProfile&&targetUserId){
      let f=await checkIfFollowing(targetUserId);
      let btn=document.getElementById('followButton');
      btn.innerText=f?'Unfollow':'Follow';
      btn.className=f?'btn btn-error':'btn btn-primary';
      btn.onclick=()=>APP.toggleFollow(targetUserId,btn);
    }
  }
  APP.logout=async()=>{await supabase.auth.signOut();location='login.html';};
  APP.showMobileMenu=()=>APP.showModal('mobileMenuModal');
  APP.closeConfirmModal=()=>APP.closeModal('confirmModal');
  function toast(m,t='info'){let d=document.createElement('div');d.innerText=m;d.style.background=t==='error'?'var(--error)':'var(--success)';document.getElementById('toastContainer').appendChild(d);setTimeout(()=>d.remove(),3000);}
  let debounce=(f,d)=>{let t;return function(...a){clearTimeout(t);t=setTimeout(()=>f.apply(this,a),d);}};
  function setupEvents(){
    document.addEventListener('click',e=>{if(e.target.classList.contains('modal'))APP.closeModal(e.target.id);});
  }
  // expose
  window.APP={...APP,init,renderRestaurants,renderMovies,renderBooks,showCollectionDetail:APP.showCollectionDetail,removeFromCollection:APP.removeFromCollection,hideRestaurantDetail:APP.hideRestaurantDetail,showMovieDetail:APP.showMovieDetail,hideMovieDetail:APP.hideMovieDetail,showBookDetail:APP.showBookDetail,hideBookDetail:APP.hideBookDetail,createMovieList:APP.createMovieList,createBookList:APP.createBookList,setRating:APP.setRating,toggleFollow:APP.toggleFollow,viewUserProfile:APP.viewUserProfile,goToMyProfile:APP.goToMyProfile,showCommunitySection:APP.showCommunitySection,showModal:APP.showModal,closeModal:APP.closeModal,showCreateListModal:APP.showCreateListModal,showAvatarModal:()=>APP.showModal('avatarModal'),saveAvatar:APP.saveAvatar,selectAvatar:APP.selectAvatar,logout:APP.logout,showMobileMenu:APP.showMobileMenu,closeConfirmModal:APP.closeConfirmModal,selectedAvatar:null};
  document.addEventListener('DOMContentLoaded',init);
  })();
</script>
</body>
</html>