<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zo2y - Profile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* =========================================
           1. DESIGN SYSTEM (Production Grade)
           ========================================= */
        :root {
            /* Palette */
            --bg-dark: #0b1633;
            --bg-card: #132347;
            --bg-hover: #1a2c5a;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --accent: #f59e0b;
            --accent-hover: #d97706;
            --danger: #ef4444;
            --success: #10b981;
            
            /* Spacing & Layout */
            --radius: 12px;
            --header-height: 60px;
            --bottom-nav-height: 70px;
            --max-width: 1200px;
            
            /* Effects */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; min-height: 100vh; overflow-x: hidden; padding-bottom: 100px; }
        
        /* Utilities */
        .container { max-width: var(--max-width); margin: 0 auto; padding: 0 16px; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 8px; }
        .gap-4 { gap: 16px; }
        .text-center { text-align: center; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .cursor-pointer { cursor: pointer; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 10px 20px; border-radius: 8px; font-weight: 600; font-size: 14px;
            transition: all 0.2s; border: none; cursor: pointer; text-decoration: none;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: #0b1633; }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-secondary { background: rgba(255,255,255,0.05); color: var(--text-main); border: var(--border); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        .btn-danger { background: rgba(239,68,68,0.15); color: var(--danger); }
        .btn-danger:hover { background: rgba(239,68,68,0.25); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Cards */
        .card { background: var(--bg-card); border-radius: var(--radius); padding: 20px; border: var(--border); transition: transform 0.2s; margin-bottom: 16px; }
        
        /* Inputs */
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
        .form-control {
            width: 100%; background: rgba(0,0,0,0.2); border: var(--border); border-radius: 8px;
            padding: 12px; color: var(--text-main); font-size: 15px; outline: none; transition: border-color 0.2s;
        }
        .form-control:focus { border-color: var(--accent); }

        /* =========================================
           2. DESKTOP SPECIFIC LAYOUT
           ========================================= */
        .desktop-nav { display: none; }
        @media (min-width: 769px) {
            .mobile-only { display: none !important; }
            .desktop-nav { 
                display: flex; position: fixed; top: 0; left: 0; right: 0; 
                height: 70px; background: rgba(11, 22, 51, 0.95); backdrop-filter: blur(10px);
                border-bottom: var(--border); z-index: 100; align-items: center; padding: 0 32px;
            }
            body { padding-top: 90px; }
            .profile-header-desktop {
                display: flex; gap: 40px; margin-bottom: 40px; align-items: flex-start;
            }
            .avatar-xl {
                width: 160px; height: 160px; font-size: 64px; border-radius: 50%;
                background: var(--accent); display: flex; align-items: center; justify-content: center;
                border: 6px solid var(--bg-dark); color: #0b1633; box-shadow: var(--shadow-lg);
            }
        }

        /* =========================================
           3. MOBILE SPECIFIC LAYOUT
           ========================================= */
        @media (max-width: 768px) {
            .desktop-only { display: none !important; }
            .mobile-header {
                position: fixed; top: 0; left: 0; right: 0; height: var(--header-height);
                background: var(--bg-card); display: flex; align-items: center; justify-content: space-between;
                padding: 0 16px; border-bottom: var(--border); z-index: 50;
            }
            .mobile-bottom-nav {
                position: fixed; bottom: 0; left: 0; right: 0; height: var(--bottom-nav-height);
                background: var(--bg-card); border-top: var(--border); display: flex;
                justify-content: space-around; align-items: center; z-index: 50;
                padding-bottom: env(safe-area-inset-bottom);
            }
            body { padding-top: 70px; }
            .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 10px; text-decoration: none; }
            .nav-item.active { color: var(--accent); }
            .nav-item i { font-size: 20px; }
            
            .mobile-profile-hero { text-align: center; padding: 20px 0; }
            .avatar-lg {
                width: 100px; height: 100px; border-radius: 50%; background: var(--accent);
                font-size: 40px; display: flex; align-items: center; justify-content: center;
                margin: 0 auto 16px; color: #0b1633; border: 4px solid var(--bg-card);
            }
        }

        /* =========================================
           4. COMMON COMPONENTS
           ========================================= */
        /* Stats Bar */
        .stats-bar { display: flex; justify-content: center; gap: 40px; margin: 24px 0; border-top: var(--border); border-bottom: var(--border); padding: 16px 0; }
        .stat-box { text-align: center; cursor: pointer; }
        .stat-num { font-size: 18px; font-weight: 700; color: var(--text-main); display: block; }
        .stat-lbl { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Tabs */
        .tabs-container { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 24px; border-bottom: var(--border); }
        .tab-btn {
            padding: 12px 24px; background: transparent; color: var(--text-muted);
            border: none; font-weight: 600; cursor: pointer; white-space: nowrap; position: relative;
        }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--accent); border-radius: 4px 4px 0 0;
        }

        /* Loading Spinner */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark);
            z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast {
            background: var(--bg-card); color: white; padding: 16px; margin-bottom: 10px;
            border-radius: 8px; border-left: 4px solid var(--accent); box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease; min-width: 300px; border: var(--border);
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000; display: flex;
            align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .modal-card {
            background: var(--bg-card); width: 90%; max-width: 500px;
            border-radius: 16px; padding: 24px; border: var(--border);
            transform: scale(0.95); transition: transform 0.2s; max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        /* Star Rating */
        .star-rating span { font-size: 28px; color: #4b5563; cursor: pointer; transition: color 0.1s; }
        .star-rating span.active { color: var(--accent); }
    </style>
</head>
<body>

    <div id="globalLoader" class="loader-overlay">
        <div class="spinner"></div>
    </div>

    <nav class="desktop-nav desktop-only">
        <div style="font-weight: 800; font-size: 24px; color: var(--accent); margin-right: auto;">Zo2y</div>
        <div class="flex gap-4">
            <a href="index.html" class="btn btn-secondary">Home</a>
            <button onclick="App.logout()" class="btn btn-secondary">Logout</button>
        </div>
    </nav>

    <header class="mobile-header mobile-only">
        <div style="font-weight: 700; font-size: 20px;">Zo2y</div>
        <i class="fas fa-cog" style="color: var(--text-muted); font-size: 20px;" onclick="App.openModal('settingsModal')"></i>
    </header>

    <div class="container">
        
        <div id="profileSection">
            <div class="text-center" style="padding: 40px;">Loading Profile...</div>
        </div>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="App.switchTab('journal', this)">Journal</button>
            <button class="tab-btn" onclick="App.switchTab('lists', this)">Lists</button>
            <button class="tab-btn" onclick="App.switchTab('community', this)">Community</button>
        </div>

        <div id="contentArea">
            </div>

    </div>

    <nav class="mobile-bottom-nav mobile-only">
        <a href="index.html" class="nav-item">
            <i class="fas fa-home"></i> <span>Home</span>
        </a>
        <a href="#" class="nav-item" onclick="App.openModal('addEntryModal')">
            <i class="fas fa-plus-circle" style="font-size: 28px; color: var(--accent);"></i>
        </a>
        <a href="#" class="nav-item active">
            <i class="fas fa-user"></i> <span>Profile</span>
        </a>
    </nav>

    <div id="addEntryModal" class="modal-overlay">
        <div class="modal-card">
            <h2 style="margin-bottom: 20px;">Add Journal Entry</h2>
            <div class="input-group">
                <label class="input-label">Restaurant</label>
                <select id="entryRestaurant" class="form-control"></select>
            </div>
            <div class="input-group">
                <label class="input-label">Rating</label>
                <div class="star-rating" id="starRatingInput">
                    <span data-val="1">‚òÖ</span><span data-val="2">‚òÖ</span><span data-val="3">‚òÖ</span><span data-val="4">‚òÖ</span><span data-val="5">‚òÖ</span>
                </div>
                <input type="hidden" id="ratingValue" value="0">
            </div>
            <div class="input-group">
                <label class="input-label">Review</label>
                <textarea id="entryReview" class="form-control" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">Date</label>
                <input type="date" id="entryDate" class="form-control">
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary w-full" onclick="App.closeModal('addEntryModal')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="App.saveJournalEntry()">Save</button>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal-overlay">
        <div class="modal-card">
            <h2 style="margin-bottom: 20px;">Edit Profile</h2>
            <div class="input-group">
                <label class="input-label">Display Name</label>
                <input type="text" id="editName" class="form-control">
            </div>
            <div class="input-group">
                <label class="input-label">Bio</label>
                <textarea id="editBio" class="form-control" rows="3"></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">Avatar Emoji</label>
                <input type="text" id="editAvatar" class="form-control" maxlength="2">
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary w-full" onclick="App.closeModal('editProfileModal')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="App.saveProfile()">Update</button>
            </div>
        </div>
    </div>

    <div id="createListModal" class="modal-overlay">
        <div class="modal-card">
            <h2 style="margin-bottom: 20px;">Create List</h2>
            <div class="input-group">
                <label class="input-label">List Name</label>
                <input type="text" id="listName" class="form-control" placeholder="e.g. Best Burgers">
            </div>
            <div class="input-group">
                <label class="input-label">Description</label>
                <textarea id="listDesc" class="form-control" rows="2"></textarea>
            </div>
            <div class="input-group">
                <label class="input-label">Icon</label>
                <input type="text" id="listIcon" class="form-control" value="üìã">
            </div>
            <div class="flex gap-2">
                <button class="btn btn-secondary w-full" onclick="App.closeModal('createListModal')">Cancel</button>
                <button class="btn btn-primary w-full" onclick="App.saveList()">Create</button>
            </div>
        </div>
    </div>

    <div id="searchModal" class="modal-overlay">
        <div class="modal-card" style="height: 70vh; display: flex; flex-direction: column;">
            <div class="flex justify-between items-center mb-4">
                <h2>Find Users</h2>
                <button class="btn btn-sm btn-secondary" onclick="App.closeModal('searchModal')">‚úï</button>
            </div>
            <input type="text" id="userSearch" class="form-control" placeholder="Search username..." oninput="App.debounceSearch()">
            <div id="searchResults" style="margin-top: 16px; overflow-y: auto; flex: 1;"></div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
        const App = (function() {
            // === CONFIGURATION ===
            const SUPABASE_URL = "https://gfkhjbztayjyojsgdpgk.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
            
            // === STATE MANAGEMENT ===
            const State = {
                user: null,         // Logged in user
                targetUser: null,   // Profile being viewed
                isOwnProfile: false,
                isFollowing: false,
                journal: [],        // Cached journal entries
                lists: [],          // Cached lists
                restaurants: [],    // Cached restaurants list
                searchTimer: null
            };

            let supabase;

            // === INITIALIZATION ===
            async function init() {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // 1. Auth Check
                    const { data: { user }, error } = await supabase.auth.getUser();
                    if (error || !user) return window.location.href = 'login.html';
                    State.user = user;

                    // 2. Identify Profile to Load
                    const params = new URLSearchParams(window.location.search);
                    const paramId = params.get('id');
                    State.isOwnProfile = !paramId || paramId === State.user.id;
                    const loadId = State.isOwnProfile ? State.user.id : paramId;

                    // 3. Parallel Data Fetching
                    await Promise.all([
                        fetchProfile(loadId),
                        fetchStats(loadId),
                        fetchRestaurants()
                    ]);

                    if(!State.isOwnProfile) await checkFollowStatus(loadId);

                    // 4. Render
                    renderProfileHero();
                    switchTab('journal');
                    
                    // 5. Hide Loader
                    document.getElementById('globalLoader').classList.add('hidden');

                } catch (e) {
                    console.error("Critical Init Error:", e);
                    showToast("Failed to load application.", "error");
                }
            }

            // === DATA LAYER ===
            async function fetchProfile(id) {
                let { data } = await supabase.from('user_profiles').select('*').eq('id', id).single();
                
                // Auto-create profile if missing (Self-healing)
                if (!data && State.isOwnProfile) {
                    const newProfile = {
                        id: State.user.id,
                        username: State.user.email.split('@')[0],
                        full_name: "New Foodie",
                        avatar_icon: "üë§",
                        bio: "Just joined Zo2y!"
                    };
                    await supabase.from('user_profiles').insert(newProfile);
                    data = newProfile;
                }
                State.targetUser = data;
            }

            async function fetchStats(id) {
                const [visited, followers, following] = await Promise.all([
                    supabase.from('journal_entries').select('id', { count: 'exact', head: true }).eq('user_id', id),
                    supabase.from('follows').select('id', { count: 'exact', head: true }).eq('followed_id', id),
                    supabase.from('follows').select('id', { count: 'exact', head: true }).eq('follower_id', id)
                ]);
                
                // Update UI directly here
                updateStatUI('statVisited', visited.count);
                updateStatUI('statFollowers', followers.count);
                updateStatUI('statFollowing', following.count);
            }

            async function fetchRestaurants() {
                const { data } = await supabase.from('restraunts').select('id, name');
                State.restaurants = data || [];
                // Populate dropdown
                const select = document.getElementById('entryRestaurant');
                select.innerHTML = '<option value="">Select Restaurant</option>' + 
                    State.restaurants.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            }

            async function checkFollowStatus(targetId) {
                const { data } = await supabase.from('follows').select('id').eq('follower_id', State.user.id).eq('followed_id', targetId).maybeSingle();
                State.isFollowing = !!data;
            }

            // === RENDER LOGIC ===
            function renderProfileHero() {
                const p = State.targetUser;
                const heroHTML = `
                    <div class="desktop-only profile-header-desktop">
                        <div class="avatar-xl">${p.avatar_icon || 'üë§'}</div>
                        <div style="flex:1; padding-top:10px;">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h1 style="font-size:32px; font-weight:800; line-height:1.2;">${p.full_name}</h1>
                                    <div style="color:var(--accent); font-size:18px;">@${p.username}</div>
                                </div>
                                <div>${renderActionButtons()}</div>
                            </div>
                            <p style="color:var(--text-muted); margin-top:16px; max-width:600px;">${p.bio || ''}</p>
                            <div class="stats-bar" style="justify-content:flex-start; border:none; padding:0; margin-top:24px;">
                                <div class="stat-box" style="text-align:left;"><span class="stat-num" id="dStatVisited">0</span><span class="stat-lbl">Visited</span></div>
                                <div class="stat-box" style="text-align:left;"><span class="stat-num" id="dStatFollowers">0</span><span class="stat-lbl">Followers</span></div>
                                <div class="stat-box" style="text-align:left;"><span class="stat-num" id="dStatFollowing">0</span><span class="stat-lbl">Following</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="mobile-only mobile-profile-hero">
                        <div class="avatar-lg">${p.avatar_icon || 'üë§'}</div>
                        <h2 style="font-size:24px; font-weight:700;">${p.full_name}</h2>
                        <div style="color:var(--accent); margin-bottom:8px;">@${p.username}</div>
                        <p style="color:var(--text-muted); font-size:14px; padding:0 20px;">${p.bio || ''}</p>
                        <div class="flex gap-2 justify-center" style="margin-top:16px;">
                            ${renderActionButtons()}
                        </div>
                        <div class="stats-bar">
                            <div class="stat-box"><span class="stat-num" id="mStatVisited">0</span><span class="stat-lbl">Visited</span></div>
                            <div class="stat-box"><span class="stat-num" id="mStatFollowers">0</span><span class="stat-lbl">Followers</span></div>
                            <div class="stat-box"><span class="stat-num" id="mStatFollowing">0</span><span class="stat-lbl">Following</span></div>
                        </div>
                    </div>
                `;
                document.getElementById('profileSection').innerHTML = heroHTML;
                
                // Sync stats to the new HTML elements
                fetchStats(State.targetUser.id);
            }

            function renderActionButtons() {
                if (State.isOwnProfile) {
                    return `
                        <button class="btn btn-secondary btn-sm" onclick="App.openModal('editProfileModal')">Edit Profile</button>
                        <button class="btn btn-primary btn-sm mobile-only" onclick="App.openModal('addEntryModal')">Add Entry</button>
                    `;
                } else {
                    const txt = State.isFollowing ? 'Unfollow' : 'Follow';
                    const cls = State.isFollowing ? 'btn-danger' : 'btn-primary';
                    return `<button id="followBtn" class="btn ${cls} btn-sm" onclick="App.toggleFollow()">${txt}</button>`;
                }
            }

            function updateStatUI(key, val) {
                // Update both mobile and desktop placeholders securely
                const valStr = val || 0;
                if(document.getElementById('d' + key.charAt(0).toUpperCase() + key.slice(1))) 
                   document.getElementById('d' + key.charAt(0).toUpperCase() + key.slice(1)).innerText = valStr;
                if(document.getElementById('m' + key.charAt(0).toUpperCase() + key.slice(1))) 
                   document.getElementById('m' + key.charAt(0).toUpperCase() + key.slice(1)).innerText = valStr;
            }

            // === TABS & CONTENT ===
            async function switchTab(tab, el) {
                if(el) {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    el.classList.add('active');
                }
                const container = document.getElementById('contentArea');
                container.innerHTML = `<div class="text-center" style="padding:40px; color:var(--text-muted);">Loading...</div>`;

                if (tab === 'journal') await loadJournal(container);
                if (tab === 'lists') await loadLists(container);
                if (tab === 'community') await loadCommunity(container);
            }

            // === 1. JOURNAL LOGIC ===
            async function loadJournal(container) {
                const { data } = await supabase
                    .from('journal_entries')
                    .select('*, restraunts(name, image)')
                    .eq('user_id', State.targetUser.id)
                    .order('visited_at', { ascending: false });
                
                State.journal = data || []; // Cache

                if (State.journal.length === 0) {
                    container.innerHTML = `<div class="text-center" style="padding:40px; color:var(--text-muted);">No entries yet.</div>`;
                    return;
                }

                container.innerHTML = State.journal.map(entry => `
                    <div class="card">
                        <div class="flex justify-between">
                            <h3 style="font-size:18px;">${entry.restraunts?.name || 'Unknown'}</h3>
                            <span style="font-size:12px; color:var(--text-muted);">${entry.visited_at}</span>
                        </div>
                        <div style="color:var(--accent); margin:4px 0;">${'‚≠ê'.repeat(entry.rating)}</div>
                        <p style="font-size:14px; color:#e2e8f0;">${entry.review || ''}</p>
                        ${State.isOwnProfile ? `<div class="text-right mt-2"><button class="btn btn-sm btn-danger" onclick="App.deleteEntry('${entry.id}')">Delete</button></div>` : ''}
                    </div>
                `).join('');
            }

            async function saveJournalEntry() {
                const rId = document.getElementById('entryRestaurant').value;
                const rating = document.getElementById('ratingValue').value;
                const review = document.getElementById('entryReview').value;
                const date = document.getElementById('entryDate').value;

                if(!rId || !date || rating === '0') return showToast('Please fill all fields', 'error');

                const { error } = await supabase.from('journal_entries').insert({
                    user_id: State.user.id,
                    restaurant_id: rId,
                    rating: parseInt(rating),
                    review: review,
                    visited_at: date
                });

                if(error) { showToast('Error saving entry', 'error'); return; }
                
                closeModal('addEntryModal');
                showToast('Journal Updated');
                switchTab('journal');
                fetchStats(State.user.id);
            }

            async function deleteEntry(id) {
                if(!confirm("Delete this entry?")) return;
                await supabase.from('journal_entries').delete().eq('id', id);
                switchTab('journal');
                fetchStats(State.user.id);
            }

            // === 2. LISTS LOGIC ===
            async function loadLists(container) {
                const { data } = await supabase.from('lists').select('*').eq('user_id', State.targetUser.id);
                State.lists = data || []; // Cache

                let html = State.isOwnProfile ? `<button class="btn btn-primary w-full" style="margin-bottom:20px;" onclick="App.openModal('createListModal')">+ Create List</button>` : '';

                if (State.lists.length === 0) {
                    html += `<div class="text-center text-muted">No lists found.</div>`;
                } else {
                    html += `<div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:16px;">`;
                    State.lists.forEach(l => {
                        // Pass ID only to avoid syntax errors
                        html += `
                            <div class="card cursor-pointer" onclick="App.openListDetail('${l.id}')">
                                <div style="font-size:32px; margin-bottom:8px;">${l.icon || 'üìã'}</div>
                                <div style="font-weight:700;">${l.title}</div>
                                <div style="font-size:12px; color:var(--text-muted);">${l.description || ''}</div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }
                container.innerHTML = html;
            }

            async function openListDetail(listId) {
                const list = State.lists.find(l => l.id === listId);
                const container = document.getElementById('contentArea');
                
                // Fetch Items
                const { data: items } = await supabase.from('lists_restraunts').select('*, restraunts(*)').eq('list_id', listId);
                const restaurants = items ? items.map(i => i.restraunts) : [];

                let html = `
                    <div class="flex items-center gap-4 mb-4">
                        <button class="btn btn-sm btn-secondary" onclick="App.switchTab('lists')">‚Üê Back</button>
                        <h2>${list.icon} ${list.title}</h2>
                    </div>
                    <div class="flex-col gap-2">
                `;
                
                if (restaurants.length === 0) html += `<div class="text-center text-muted py-4">Empty list.</div>`;
                
                restaurants.forEach(r => {
                    html += `
                        <div class="card flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div style="font-size:24px;">üçΩÔ∏è</div>
                                <div>
                                    <div style="font-weight:bold;">${r.name}</div>
                                    <div style="font-size:12px; color:var(--text-muted);">${r.category}</div>
                                </div>
                            </div>
                            ${State.isOwnProfile ? `<button class="btn btn-sm btn-danger" onclick="App.removeListitem('${listId}', '${r.id}')">√ó</button>` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                if(State.isOwnProfile) {
                    html += `<button class="btn btn-danger w-full mt-4" onclick="App.deleteList('${listId}')">Delete List</button>`;
                }

                container.innerHTML = html;
            }

            async function saveList() {
                const title = document.getElementById('listName').value;
                const desc = document.getElementById('listDesc').value;
                const icon = document.getElementById('listIcon').value;

                if(!title) return showToast('Title required', 'error');

                await supabase.from('lists').insert({ user_id: State.user.id, title, description: desc, icon });
                closeModal('createListModal');
                switchTab('lists');
            }

            async function removeListitem(listId, rId) {
                if(!confirm('Remove?')) return;
                await supabase.from('lists_restraunts').delete().eq('list_id', listId).eq('restraunt_id', rId);
                openListDetail(listId);
            }

            async function deleteList(id) {
                if(!confirm('Delete list permanently?')) return;
                await supabase.from('lists_restraunts').delete().eq('list_id', id);
                await supabase.from('lists').delete().eq('id', id);
                switchTab('lists');
            }

            // === 3. COMMUNITY & SEARCH ===
            async function loadCommunity(container) {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h3>Followers</h3>
                        ${State.isOwnProfile ? `<button class="btn btn-primary btn-sm" onclick="App.openModal('searchModal')">Find Users</button>` : ''}
                    </div>
                    <div id="followersList">Loading...</div>
                `;
                
                const { data } = await supabase.from('follows').select('follower_id').eq('followed_id', State.targetUser.id);
                const listEl = document.getElementById('followersList');
                
                if (!data || data.length === 0) {
                    listEl.innerHTML = `<div class="text-center text-muted">No followers yet.</div>`;
                    return;
                }

                const ids = data.map(f => f.follower_id);
                const { data: users } = await supabase.from('user_profiles').select('*').in('id', ids);

                listEl.innerHTML = users.map(u => `
                    <div class="card flex items-center gap-4 cursor-pointer" onclick="window.location.href='?id=${u.id}'">
                        <div style="font-size:24px;">${u.avatar_icon}</div>
                        <div>
                            <div style="font-weight:bold;">${u.full_name}</div>
                            <div style="font-size:12px; color:var(--text-muted);">@${u.username}</div>
                        </div>
                    </div>
                `).join('');
            }

            function debounceSearch() {
                clearTimeout(State.searchTimer);
                State.searchTimer = setTimeout(async () => {
                    const q = document.getElementById('userSearch').value;
                    if(q.length < 2) return;
                    
                    const { data } = await supabase.from('user_profiles').select('*').ilike('username', `%${q}%`).neq('id', State.user.id).limit(10);
                    
                    document.getElementById('searchResults').innerHTML = data.map(u => `
                        <div class="card flex items-center gap-4 cursor-pointer" onclick="window.location.href='?id=${u.id}'">
                            <div>${u.avatar_icon}</div>
                            <b>${u.username}</b>
                        </div>
                    `).join('');
                }, 300);
            }

            async function toggleFollow() {
                // Optimistic UI
                State.isFollowing = !State.isFollowing;
                renderProfileHero(); // Re-render header to update button

                // DB Update
                if(!State.isFollowing) {
                    await supabase.from('follows').delete().match({ follower_id: State.user.id, followed_id: State.targetUser.id });
                    showToast('Unfollowed');
                } else {
                    await supabase.from('follows').insert({ follower_id: State.user.id, followed_id: State.targetUser.id });
                    showToast('Following');
                }
                fetchStats(State.targetUser.id);
            }

            // === UTILS ===
            async function saveProfile() {
                const updates = {
                    full_name: document.getElementById('editName').value,
                    bio: document.getElementById('editBio').value,
                    avatar_icon: document.getElementById('editAvatar').value,
                    updated_at: new Date()
                };
                await supabase.from('user_profiles').update(updates).eq('id', State.user.id);
                window.location.reload();
            }

            function openModal(id) { 
                document.getElementById(id).classList.add('open');
                // Pre-fill Edit Modal
                if(id === 'editProfileModal') {
                    document.getElementById('editName').value = State.targetUser.full_name;
                    document.getElementById('editBio').value = State.targetUser.bio;
                    document.getElementById('editAvatar').value = State.targetUser.avatar_icon;
                }
            }
            function closeModal(id) { document.getElementById(id).classList.remove('open'); }
            
            function showToast(msg, type = 'success') {
                const container = document.getElementById('toastContainer');
                const t = document.createElement('div');
                t.className = 'toast';
                t.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
                t.innerText = msg;
                container.appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }

            async function logout() {
                if(confirm("Log out?")) {
                    await supabase.auth.signOut();
                    window.location.href = 'login.html';
                }
            }
            
            function goToMyProfile() { window.location.href = 'profile.html'; }

            // Star Rating Logic
            document.querySelectorAll('#starRatingInput span').forEach(s => {
                s.onclick = function() {
                    const val = this.dataset.val;
                    document.getElementById('ratingValue').value = val;
                    document.querySelectorAll('#starRatingInput span').forEach(star => {
                        star.style.color = star.dataset.val <= val ? 'var(--accent)' : 'gray';
                    });
                }
            });

            return {
                init, logout, switchTab, openModal, closeModal, 
                saveJournalEntry, deleteEntry, saveList, openListDetail, 
                removeListitem, deleteList, debounceSearch, toggleFollow, 
                saveProfile, goToMyProfile
            };
        })();

        document.addEventListener('DOMContentLoaded', App.init);
    </script>
</body>
</html>