<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex" />
  <title>Zo2y - Song</title>
  <meta name="description" content="Listen to song previews and save tracks to your Zo2y lists." />
  <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="js/list-utils.js?v=20260221c" defer></script>
  <script src="js/index-list-menu-adapter.js?v=20260221b" defer></script>
  <script src="js/universal-search.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    :root {
      --bg: #08182d;
      --card: #0f2748;
      --card-2: #123059;
      --muted: #8fb2dd;
      --accent: #1db954;
      --cta: #f59e0b;
      --white: #fff;
      --border: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      min-height: 100%;
      background:
        radial-gradient(circle at 18% -10%, rgba(29,185,84,0.24), transparent 35%),
        radial-gradient(circle at 88% -14%, rgba(53,103,194,0.25), transparent 42%),
        var(--bg);
      color: var(--white);
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }
    a { color: inherit; text-decoration: none; }
    .container { width: min(1100px, calc(100% - 28px)); margin: 0 auto; }
    header {
      position: sticky; top: 0; z-index: 100;
      backdrop-filter: blur(10px) saturate(180%);
      background: rgba(8,24,45,0.9);
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      min-height: 72px; display: flex; align-items: center; gap: 14px;
      padding: 12px 0; flex-wrap: wrap;
    }
    .brand { display: inline-flex; align-items: center; gap: 10px; font-size: 22px; font-weight: 800; }
    .brand img { width: 36px; height: 36px; border-radius: 10px; object-fit: cover; }
    .search-wrap { flex: 1; min-width: 210px; max-width: 420px; position: relative; margin-left: 8px; }
    .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 13px; }
    .search {
      width: 100%; height: 42px; border-radius: 999px; border: 1px solid var(--border); background: var(--card);
      color: var(--white); padding: 0 14px 0 34px; outline: none;
    }
    .search:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(29,185,84,0.2); }
    .top-nav { display: inline-flex; align-items: center; gap: 8px; margin-left: auto; }
    .nav-pill {
      border: 1px solid transparent; color: #e2ecff; border-radius: 999px; font-size: 12px;
      font-weight: 600; padding: 8px 10px;
    }
    .nav-pill.active, .nav-pill:hover { border-color: var(--border); color: var(--accent); background: rgba(255,255,255,0.04); }
    .shell {
      margin-top: 22px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: rgba(15,39,72,0.9);
      box-shadow: 0 12px 34px rgba(0,0,0,0.22);
      padding: 18px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
    }
    .cover {
      width: 100%;
      aspect-ratio: 1/1;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #0f2748;
    }
    .cover img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .meta h1 { font-size: clamp(28px, 4.2vw, 46px); line-height: 1.06; }
    .meta p { margin-top: 6px; color: #d4e6ff; }
    .chips { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    .chip {
      padding: 7px 10px; border-radius: 999px; border: 1px solid var(--border);
      color: #d9e7ff; font-size: 12px; background: rgba(255,255,255,0.06);
    }
    .actions { margin-top: 14px; display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      height: 40px; border-radius: 11px; border: 1px solid var(--border);
      background: var(--card-2); color: var(--white); padding: 0 12px; cursor: pointer;
      display: inline-flex; align-items: center; gap: 7px; font-weight: 600;
    }
    .btn-primary { border: 0; color: #0b1633; background: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%); }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn-primary:hover { color: #0b1633; }
    .menu-wrapper { position: relative; }
    .menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: var(--card-2);
      color: var(--white);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    .menu-btn:hover { border-color: var(--accent); color: var(--accent); }
    .list-menu {
      position: absolute;
      top: calc(100% + 6px);
      right: 0;
      width: 220px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0f2547;
      box-shadow: 0 14px 32px rgba(0,0,0,0.35);
      padding: 10px;
      display: none;
      z-index: 130;
    }
    .list-menu.open { display: block; }
    .list-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 28, 0.55);
      z-index: 120;
      display: none;
    }
    .list-menu-backdrop.active { display: block; }
    .list-menu-title { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .list-action {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all 0.2s ease;
      margin-bottom: 6px;
    }
    .list-action:last-child { margin-bottom: 0; }
    .list-action:hover { border-color: var(--accent); color: var(--accent); }
    .list-action.active {
      background: rgba(29,185,84,0.15);
      border-color: rgba(29,185,84,0.8);
      color: #d1fae5;
    }
    .list-action[aria-busy="true"] {
      opacity: 0.72;
      pointer-events: none;
    }
    .status { margin-top: 10px; color: var(--muted); font-size: 13px; }
    .error { color: #fecaca; }
    .album-tracks {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      padding: 12px;
      display: none;
    }
    .album-tracks h3 {
      font-size: 13px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #b6cfee;
      margin-bottom: 10px;
      font-weight: 700;
    }
    .album-track-list { display: grid; gap: 10px; }
    .album-track-row {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(120deg, rgba(255,255,255,0.035), rgba(255,255,255,0.015));
      display: grid;
      gap: 8px;
      transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .album-track-row:hover {
      transform: translateY(-1px);
      border-color: rgba(143, 178, 221, 0.35);
      box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .album-track-main {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
    }
    .album-track-left {
      display: flex;
      gap: 10px;
      align-items: center;
      min-width: 0;
    }
    .album-track-index {
      color: #9fb9da;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.03em;
      flex: 0 0 auto;
      min-width: 22px;
      text-align: right;
      padding-top: 1px;
    }
    .album-track-info { min-width: 0; }
    .album-track-title {
      font-size: 16px;
      font-weight: 700;
      color: #f7fbff;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .album-track-meta {
      margin-top: 5px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .album-track-sub {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border: 1px solid rgba(255,255,255,0.13);
      border-radius: 8px;
      padding: 2px 8px;
      font-size: 11px;
      color: #c7dcf7;
      background: rgba(255,255,255,0.025);
    }
    .album-track-actions { display: flex; gap: 7px; flex-wrap: wrap; }
    .album-track-actions-primary { justify-content: flex-end; }
    .album-track-menu-btn {
      width: 34px;
      height: 31px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: #dceaff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.18s ease;
    }
    .album-track-menu-btn:hover {
      border-color: #8fb2dd;
      color: #ffffff;
      background: rgba(143,178,221,0.12);
    }
    .track-pill {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: #dceaff;
      border-radius: 10px;
      height: 31px;
      padding: 0 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease;
    }
    .track-pill:hover { border-color: #8fb2dd; color: #ffffff; background: rgba(143,178,221,0.12); }
    .track-pill.primary {
      border-color: rgba(245,158,11,0.55);
      background: rgba(245,158,11,0.16);
      color: #ffe4b0;
    }
    .track-pill.primary:hover {
      border-color: rgba(245,158,11,0.85);
      background: rgba(245,158,11,0.26);
      color: #fff3d6;
    }
    .track-pill.open-pill {
      border-color: rgba(255,255,255,0.2);
    }
    .track-pill.active {
      border-color: rgba(29,185,84,0.8);
      background: rgba(29,185,84,0.16);
      color: #d1fae5;
    }
    .track-pill[disabled] { opacity: 0.6; cursor: not-allowed; }
    .artist-panel {
      margin-top: 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      display: grid;
      gap: 6px;
    }
    .artist-panel h3 { font-size: 14px; color: #d9e7ff; }
    .artist-meta { font-size: 12px; color: #c8ddfb; }
    audio { margin-top: 12px; width: 100%; max-width: 520px; }
    @media (max-width: 860px) {
      .top-nav { display: none; }
      .shell { grid-template-columns: 1fr; }
      .container { width: calc(100% - 16px); }
      .search-wrap { order: 3; max-width: none; margin-left: 0; width: 100%; }
      .album-track-main { grid-template-columns: 1fr; }
      .album-track-actions-primary { justify-content: flex-start; }
      .album-track-title { font-size: 15px; }
    }
  </style>
  <meta name="theme-color" content="#0b1633" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Zo2y" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/images/logo.png" />
  <link rel="stylesheet" href="/js/mobile-app.css?v=20260226a" />
  <script src="/js/mobile-webapp.js?v=20260225d" defer></script>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="Zo2y" />
        <span>Zo2y</span>
      </a>
      <div class="search-wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input class="search" id="globalSearch" placeholder="Search all media..." />
      </div>
      <nav class="top-nav" aria-label="Browse media">
        <a class="nav-pill" href="movies.html">Movies</a>
        <a class="nav-pill" href="tvshows.html">TV</a>
        <a class="nav-pill" href="games.html">Games</a>
        <a class="nav-pill" href="books.html">Books</a>
        <a class="nav-pill active" href="music.html">Music</a>
        <a class="nav-pill" href="animes.html">Anime</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="shell">
      <div class="cover">
        <img id="songCover" src="images/logo.png" alt="Song cover" />
      </div>
      <div class="meta">
        <h1 id="songTitle">Loading song...</h1>
        <p id="songArtist">Artist</p>
        <div class="chips">
          <span class="chip" id="songAlbum"><i class="fa-solid fa-compact-disc"></i> Album</span>
          <span class="chip" id="songDuration"><i class="fa-regular fa-clock"></i> --:--</span>
          <span class="chip" id="songPopularity"><i class="fa-solid fa-fire"></i> Popularity --/100</span>
          <span class="chip" id="artistFollowers"><i class="fa-solid fa-users"></i> Followers --</span>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="listenBtn" type="button"><i class="fa-solid fa-play"></i> Listen Now</button>
          <div class="menu-wrapper">
            <button class="menu-btn" id="songMenuBtn" type="button" aria-label="Save to lists"><i class="fas fa-ellipsis-v"></i></button>
            <div class="list-menu" id="songListMenu">
              <div class="list-menu-title">Save to list</div>
              <button class="list-action" data-list="favorites"><span><i class="fas fa-heart"></i> Favorites</span><span class="list-action-state">Add</span></button>
              <button class="list-action" data-list="listened"><span><i class="fas fa-check"></i> Listened</span><span class="list-action-state">Add</span></button>
              <button class="list-action" data-list="listenlist"><span><i class="fas fa-bookmark"></i> Listenlist</span><span class="list-action-state">Add</span></button>
            </div>
          </div>
          <a class="btn" href="music.html"><i class="fa-solid fa-arrow-left"></i> Back to Music</a>
        </div>
        <audio id="previewPlayer" controls preload="none" style="display:none;"></audio>
        <div class="artist-panel" id="artistPanel" style="display:none;">
          <h3 id="artistPanelTitle">Artist Info</h3>
          <div class="artist-meta" id="artistGenres">Genres: --</div>
          <div class="artist-meta" id="artistPopularity">Artist popularity: --/100</div>
        </div>
        <div class="status" id="songStatus">Fetching track details...</div>
        <section class="album-tracks" id="albumTracksSection">
          <h3>Album Tracks</h3>
          <div class="album-track-list" id="albumTracks"></div>
        </section>
      </div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
    let supabaseClient = null;
    let currentUser = null;
    let track = null;
    let albumMode = false;
    let albumTracks = [];
    const albumTrackStatusMap = new Map();
    const albumTrackPendingOps = new Set();
    const albumPreviewState = { btn: null };
    const trackListStatus = { favorites: false, listened: false, listenlist: false };
    const pendingListOps = new Set();

    function qs(id) { return document.getElementById(id); }
    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
    function msToMinSec(ms) {
      const total = Math.max(0, Number(ms || 0));
      const sec = Math.floor(total / 1000);
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${m}:${String(s).padStart(2, '0')}`;
    }

    function toHttpsUrl(url) {
      const value = String(url || '').trim();
      if (!value) return '';
      if (value.startsWith('//')) return `https:${value}`;
      if (value.startsWith('http://')) return value.replace(/^http:\/\//i, 'https://');
      return value;
    }

    function upgradeItunesArtwork(url, size = 1200) {
      const src = toHttpsUrl(url);
      if (!src) return '';
      return src
        .replace(/\/[0-9]+x[0-9]+bb\./i, `/${size}x${size}bb.`)
        .replace(/\/[0-9]+x[0-9]+\./i, `/${size}x${size}.`);
    }

    function pickTrackImage(data) {
      if (!data || typeof data !== 'object') return '';
      const albumImages = Array.isArray(data.album?.images) ? data.album.images : [];
      const bestAlbumImage = albumImages
        .map((img) => ({
          url: String(img?.url || '').trim(),
          area: Number(img?.width || 0) * Number(img?.height || 0)
        }))
        .filter((img) => !!img.url)
        .sort((a, b) => b.area - a.area)[0]?.url || '';
      const raw = bestAlbumImage || String(data.image || '').trim();
      const upgraded = upgradeItunesArtwork(raw, 1200);
      return upgraded || toHttpsUrl(raw);
    }

    function inferSourceFromId(id) {
      const value = String(id || '').trim();
      if (!value) return 'spotify';
      return /^[0-9]+$/.test(value) ? 'itunes' : 'spotify';
    }

    async function ensureSupabase() {
      if (supabaseClient) return supabaseClient;
      if (!window.supabase || !window.supabase.createClient) return null;
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: { flowType: 'pkce', persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
      });
      return supabaseClient;
    }

    async function loadAuth() {
      const client = await ensureSupabase();
      if (!client) return;
      const { data } = await client.auth.getUser();
      currentUser = data?.user || null;
    }

    async function fetchSpotifyTrack(id) {
      const res = await fetch(`/api/music/tracks/${encodeURIComponent(id)}?market=US`);
      if (!res.ok) return null;
      return res.json();
    }

    async function fetchSpotifyArtist(id) {
      const artistId = String(id || '').trim();
      if (!artistId) return null;
      const res = await fetch(`/api/music/artists/${encodeURIComponent(artistId)}`);
      if (!res.ok) return null;
      return res.json();
    }

    async function fetchAlbumDetails(id, source = '') {
      const albumId = String(id || '').trim();
      if (!albumId) return null;
      const sourceParam = String(source || '').trim().toLowerCase();
      const query = new URLSearchParams({ market: 'US', include_tracks: 'true', limit: '140' });
      if (sourceParam) query.set('source', sourceParam);
      const res = await fetch(`/api/music/albums/${encodeURIComponent(albumId)}?${query.toString()}`);
      if (!res.ok) return null;
      return res.json();
    }

    async function fetchItunesTrack(id) {
      const res = await fetch(`https://itunes.apple.com/lookup?id=${encodeURIComponent(id)}&entity=song`);
      if (!res.ok) return null;
      const json = await res.json();
      const row = Array.isArray(json.results)
        ? (json.results.find((item) => item.wrapperType === 'track' || item.kind === 'song') || json.results[0])
        : null;
      if (!row) return null;
      const rawArtwork = String(row.artworkUrl100 || row.artworkUrl60 || '').trim();
      const hiResArtwork = upgradeItunesArtwork(rawArtwork, 1200) || toHttpsUrl(rawArtwork);
      return {
        id: String(row.trackId || row.collectionId || id),
        name: row.trackName || row.collectionName || 'Track',
        artists: [row.artistName || 'Artist'],
        artist_ids: [],
        album: {
          name: row.collectionName || 'Album',
          images: hiResArtwork ? [{ url: hiResArtwork, width: 1200, height: 1200 }] : []
        },
        image: hiResArtwork,
        preview_url: row.previewUrl || '',
        popularity: 0,
        duration_ms: Number(row.trackTimeMillis || 0)
      };
    }

    function renderTrack(data) {
      albumMode = false;
      albumTracks = [];
      track = data;
      qs('songTitle').textContent = data.name || 'Track';
      qs('songArtist').textContent = Array.isArray(data.artists) && data.artists.length ? data.artists.join(', ') : 'Artist';
      qs('songAlbum').innerHTML = `<i class="fa-solid fa-compact-disc"></i> ${data.album?.name || 'Album'}`;
      qs('songDuration').innerHTML = `<i class="fa-regular fa-clock"></i> ${msToMinSec(data.duration_ms)}`;
      qs('songPopularity').innerHTML = `<i class="fa-solid fa-fire"></i> Popularity ${Number(data.popularity || 0)}/100`;
      qs('artistFollowers').innerHTML = '<i class="fa-solid fa-users"></i> Followers --';
      const coverEl = qs('songCover');
      const coverUrl = pickTrackImage(data);
      coverEl.src = coverUrl || 'images/logo.png';
      track.image = coverUrl || String(track.image || '').trim();
      coverEl.onerror = () => {
        coverEl.onerror = null;
        coverEl.src = 'images/logo.png';
      };
      qs('songStatus').textContent = data.preview_url ? 'Ready to play preview.' : 'Preview not available for this track.';
      qs('songStatus').classList.remove('error');
      const section = qs('albumTracksSection');
      if (section) section.style.display = 'none';
      const menuBtn = qs('songMenuBtn');
      if (menuBtn) menuBtn.style.display = 'inline-flex';
      const listenBtn = qs('listenBtn');
      if (listenBtn) listenBtn.innerHTML = '<i class="fa-solid fa-play"></i> Listen Now';

      const audio = qs('previewPlayer');
      if (data.preview_url) {
        audio.src = data.preview_url;
        audio.style.display = 'block';
      } else {
        audio.removeAttribute('src');
        audio.style.display = 'none';
      }
    }

    function renderArtist(artist) {
      if (!artist) return;
      const panel = qs('artistPanel');
      const panelTitle = qs('artistPanelTitle');
      const genresEl = qs('artistGenres');
      const popEl = qs('artistPopularity');
      const followersEl = qs('artistFollowers');
      if (!panel || !panelTitle || !genresEl || !popEl || !followersEl) return;

      panel.style.display = 'grid';
      panelTitle.textContent = artist.name || 'Artist Info';
      const genres = Array.isArray(artist.genres) && artist.genres.length ? artist.genres.slice(0, 3).join(', ') : 'Unknown';
      genresEl.textContent = `Genres: ${genres}`;
      popEl.textContent = `Artist popularity: ${Number(artist.popularity || 0)}/100`;
      followersEl.innerHTML = `<i class="fa-solid fa-users"></i> Followers ${Number(artist.followers || 0).toLocaleString()}`;
    }

    function updateListMenuUi() {
      const menu = qs('songListMenu');
      if (!menu) return;
      const trackId = String(track?.id || '').trim();
      menu.querySelectorAll('.list-action[data-list]').forEach((btn) => {
        const listType = String(btn.getAttribute('data-list') || '').trim().toLowerCase();
        if (!(listType in trackListStatus)) return;
        const state = btn.querySelector('.list-action-state');
        const isSaved = !!trackListStatus[listType];
        const isPending = pendingListOps.has(`${trackId}:${listType}`);
        btn.classList.toggle('active', isSaved);
        btn.setAttribute('aria-busy', isPending ? 'true' : 'false');
        btn.disabled = isPending;
        btn.title = isSaved ? `Remove from ${listType}` : `Add to ${listType}`;
        if (state) state.textContent = isPending ? '...' : (isSaved ? 'Saved' : 'Add');
      });
    }

    async function loadTrackListStatus() {
      trackListStatus.favorites = false;
      trackListStatus.listened = false;
      trackListStatus.listenlist = false;
      if (!track?.id || !currentUser?.id) {
        updateListMenuUi();
        return;
      }
      const client = await ensureSupabase();
      if (!client) return;
      const { data, error } = await client
        .from('music_list_items')
        .select('list_type')
        .eq('user_id', currentUser.id)
        .eq('track_id', String(track.id));
      if (!error) {
        (data || []).forEach((row) => {
          const key = String(row.list_type || '');
          if (key in trackListStatus) {
            trackListStatus[key] = true;
          }
        });
      }
      updateListMenuUi();
    }

    async function toggleList(listType) {
      if (!track?.id) return;
      if (!(listType in trackListStatus)) return;
      const client = await ensureSupabase();
      if (!client || !currentUser?.id) {
        window.location.href = 'login.html';
        return;
      }
      const trackId = String(track.id);
      const opKey = `${trackId}:${listType}`;
      if (pendingListOps.has(opKey)) return;

      const previousSaved = !!trackListStatus[listType];
      const nextSaved = !previousSaved;
      pendingListOps.add(opKey);
      trackListStatus[listType] = nextSaved;
      updateListMenuUi();

      try {
        if (nextSaved) {
          await client.from('tracks').upsert({
            id: trackId,
            name: track.name || '',
            artists: Array.isArray(track.artists) ? track.artists.join(', ') : '',
            album_name: track.album?.name || '',
            image_url: track.image || '',
            preview_url: track.preview_url || '',
            popularity: Number(track.popularity || 0),
            duration_ms: Number(track.duration_ms || 0),
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });

          const { error } = await client.from('music_list_items').insert({
            user_id: currentUser.id,
            track_id: trackId,
            list_type: listType
          });
          if (error && String(error.code || '') !== '23505') throw error;
          qs('songStatus').textContent = 'Added to list.';
          qs('songStatus').classList.remove('error');
        } else {
          const { error } = await client
            .from('music_list_items')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('track_id', trackId)
            .eq('list_type', listType);
          if (error) throw error;
          qs('songStatus').textContent = 'Removed from list.';
          qs('songStatus').classList.remove('error');
        }
      } catch (_error) {
        trackListStatus[listType] = previousSaved;
        qs('songStatus').textContent = 'Could not update list.';
        qs('songStatus').classList.add('error');
      } finally {
        pendingListOps.delete(opKey);
        updateListMenuUi();
      }
    }

    function getAlbumTrackStatus(trackId) {
      const id = String(trackId || '').trim();
      const empty = { favorites: false, listened: false, listenlist: false };
      if (!id) return { ...empty };
      if (!albumTrackStatusMap.has(id)) albumTrackStatusMap.set(id, { ...empty });
      return albumTrackStatusMap.get(id);
    }

    async function loadAlbumTrackListStatus() {
      albumTrackStatusMap.clear();
      if (!currentUser?.id || !albumTracks.length) return;
      const ids = albumTracks
        .map((row) => String(row?.id || '').trim())
        .filter(Boolean);
      if (!ids.length) return;
      const client = await ensureSupabase();
      if (!client) return;
      const { data, error } = await client
        .from('music_list_items')
        .select('track_id, list_type')
        .eq('user_id', currentUser.id)
        .in('track_id', ids);
      if (error) return;
      (data || []).forEach((row) => {
        const id = String(row?.track_id || '').trim();
        const listType = String(row?.list_type || '').trim().toLowerCase();
        if (!id) return;
        const bucket = getAlbumTrackStatus(id);
        if (listType in bucket) bucket[listType] = true;
      });
    }

    async function upsertTrackRecord(client, row) {
      if (!client || !row?.id) return false;
      const payload = {
        id: String(row.id),
        name: String(row.name || '').trim(),
        artists: Array.isArray(row?.artists) ? row.artists.join(', ') : String(row?.subtitle || '').trim(),
        album_name: String(row?.album?.name || row?.album_name || '').trim(),
        image_url: String(row?.image || '').trim(),
        preview_url: String(row?.preview_url || '').trim(),
        popularity: Number(row?.popularity || 0),
        duration_ms: Number(row?.duration_ms || 0),
        updated_at: new Date().toISOString()
      };
      const { error } = await client.from('tracks').upsert(payload, { onConflict: 'id' });
      return !error;
    }

    async function toggleAlbumTrackDefaultList(trackId, listType, _card, forcedNextSaved) {
      const id = String(trackId || '').trim();
      if (!id) return { ok: false, saved: false };
      const type = String(listType || '').trim().toLowerCase();
      const status = getAlbumTrackStatus(id);
      if (!(type in status)) return { ok: false, saved: false };

      const row = albumTracks.find((item) => String(item?.id || '').trim() === id);
      if (!row) return { ok: false, saved: false };
      const client = await ensureSupabase();
      if (!client || !currentUser?.id) {
        window.location.href = 'login.html';
        return { ok: false, saved: false };
      }

      const opKey = `${id}:${type}`;
      if (albumTrackPendingOps.has(opKey)) return { ok: false, saved: !!status[type] };
      const previousSaved = !!status[type];
      const nextSaved = typeof forcedNextSaved === 'boolean' ? forcedNextSaved : !previousSaved;
      albumTrackPendingOps.add(opKey);
      status[type] = nextSaved;

      try {
        if (nextSaved) {
          const ok = await upsertTrackRecord(client, row);
          if (!ok) throw new Error('Track upsert failed');
          const { error } = await client.from('music_list_items').insert({
            user_id: currentUser.id,
            track_id: id,
            list_type: type
          });
          if (error && String(error.code || '') !== '23505') throw error;
          qs('songStatus').textContent = 'Added to list.';
          qs('songStatus').classList.remove('error');
          return { ok: true, saved: true };
        } else {
          const { error } = await client
            .from('music_list_items')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('track_id', id)
            .eq('list_type', type);
          if (error) throw error;
          qs('songStatus').textContent = 'Removed from list.';
          qs('songStatus').classList.remove('error');
          return { ok: true, saved: false };
        }
      } catch (_err) {
        status[type] = previousSaved;
        qs('songStatus').textContent = 'Could not update list.';
        qs('songStatus').classList.add('error');
        return { ok: false, saved: previousSaved };
      } finally {
        albumTrackPendingOps.delete(opKey);
        renderAlbumTrackRows();
      }
    }

    function renderAlbumTrackRows() {
      const list = qs('albumTracks');
      if (!list) return;
      if (!albumTracks.length) {
        list.innerHTML = '<div class="album-track-row"><div class="album-track-title">No tracks available.</div></div>';
        return;
      }
      list.innerHTML = albumTracks.map((row, index) => {
        const id = String(row?.id || '').trim();
        const duration = msToMinSec(row?.duration_ms || 0);
        const hasPreview = !!String(row?.preview_url || '').trim();
        const explicitBadge = row?.explicit ? '<span class="album-track-sub"><i class="fa-solid fa-e"></i> Explicit</span>' : '';
        const artistsText = Array.isArray(row?.artists) ? row.artists.join(', ') : '';
        return `
          <article class="album-track-row album-track-card" data-track-id="${escapeHtml(id)}" data-id="${escapeHtml(id)}" data-title="${escapeHtml(String(row?.name || 'Track'))}" data-subtitle="${escapeHtml(artistsText)}" data-image="${escapeHtml(String(row?.image || ''))}">
            <div class="album-track-main">
              <div class="album-track-left">
                <span class="album-track-index">${index + 1}</span>
                <div class="album-track-info">
                  <div class="album-track-title">${escapeHtml(String(row?.name || 'Track'))}</div>
                  <div class="album-track-meta">
                    <span class="album-track-sub"><i class="fa-regular fa-clock"></i> ${escapeHtml(duration)}</span>
                    ${explicitBadge}
                  </div>
                </div>
              </div>
              <div class="album-track-actions album-track-actions-primary">
                ${hasPreview ? `<button class="track-pill primary album-preview-btn" data-preview="${escapeHtml(String(row.preview_url || ''))}" type="button"><i class="fa-solid fa-play"></i> Preview</button>` : ''}
                ${id ? `<a class="track-pill open-pill" href="song.html?id=${encodeURIComponent(id)}"><i class="fa-solid fa-arrow-up-right-from-square"></i> Open</a>` : ''}
                <button class="album-track-menu-btn" type="button" aria-label="Add to lists"><i class="fas fa-ellipsis-v"></i></button>
              </div>
            </div>
          </article>
        `;
      }).join('');
    }

    function wireAlbumTrackInteractions() {
      const list = qs('albumTracks');
      if (!list || list.dataset.wired === '1') return;
      list.dataset.wired = '1';
      list.addEventListener('click', async (event) => {
        const previewBtn = event.target.closest('.album-preview-btn');
        if (previewBtn) {
          event.preventDefault();
          const src = String(previewBtn.getAttribute('data-preview') || '').trim();
          const audio = qs('previewPlayer');
          if (!audio || !src) return;
          if (audio.src === src && !audio.paused) {
            audio.pause();
            previewBtn.textContent = 'Preview';
            albumPreviewState.btn = null;
            return;
          }
          if (albumPreviewState.btn && albumPreviewState.btn !== previewBtn) {
            albumPreviewState.btn.textContent = 'Preview';
          }
          audio.src = src;
          audio.style.display = 'block';
          audio.play().catch(() => {});
          previewBtn.textContent = 'Pause';
          albumPreviewState.btn = previewBtn;
          return;
        }

        const menuBtn = event.target.closest('.album-track-menu-btn');
        if (menuBtn) {
          event.preventDefault();
          event.stopPropagation();
          const card = menuBtn.closest('.album-track-card');
          if (!card) return;
          if (typeof window.openIndexStyleListMenu === 'function') {
            window.openIndexStyleListMenu(card);
          }
        }
      });
    }

    async function renderAlbumPage(payload) {
      const album = payload?.album || {};
      albumTracks = Array.isArray(payload?.tracks) ? payload.tracks : [];
      albumMode = true;
      track = null;

      qs('songTitle').textContent = String(album?.name || 'Album');
      qs('songArtist').textContent = Array.isArray(album?.artists) && album.artists.length ? album.artists.join(', ') : 'Artist';
      qs('songAlbum').innerHTML = `<i class="fa-solid fa-compact-disc"></i> Album`;
      qs('songDuration').innerHTML = `<i class="fa-regular fa-clock"></i> ${albumTracks.length} tracks`;
      qs('songPopularity').innerHTML = `<i class="fa-solid fa-fire"></i> Album Release`;
      qs('artistFollowers').innerHTML = `<i class="fa-solid fa-calendar"></i> ${String(album?.release_date || 'Release date unknown')}`;

      const coverUrl = pickTrackImage({ image: album?.image, album: { images: album?.images || [] } });
      const coverEl = qs('songCover');
      coverEl.src = coverUrl || 'images/logo.png';
      coverEl.onerror = () => {
        coverEl.onerror = null;
        coverEl.src = 'images/logo.png';
      };

      const artistPanel = qs('artistPanel');
      if (artistPanel) artistPanel.style.display = 'none';
      const menuBtn = qs('songMenuBtn');
      if (menuBtn) menuBtn.style.display = 'none';
      closeAllListMenus();
      const listenBtn = qs('listenBtn');
      if (listenBtn) listenBtn.innerHTML = '<i class="fa-solid fa-list"></i> Album Tracks';
      const audio = qs('previewPlayer');
      if (audio) {
        audio.removeAttribute('src');
        audio.style.display = 'none';
      }

      qs('songStatus').textContent = `Showing ${albumTracks.length} track${albumTracks.length === 1 ? '' : 's'} from this album.`;
      qs('songStatus').classList.remove('error');

      await loadAlbumTrackListStatus();
      const section = qs('albumTracksSection');
      if (section) section.style.display = 'block';
      renderAlbumTrackRows();
      wireAlbumTrackInteractions();
    }

    function initAlbumTrackKebabMenu() {
      if (!window.initIndexStyleListMenu) return;
      window.initIndexStyleListMenu({
        mediaType: 'music',
        itemIdAttr: 'data-track-id',
        getVisibleItemIds: () =>
          (Array.isArray(albumTracks) ? albumTracks : [])
            .map((row) => String(row?.id || '').trim())
            .filter(Boolean),
        getQuickStatusForItem: (itemId) => {
          const key = String(itemId || '').trim();
          const status = albumTrackStatusMap.get(key);
          return status ? { ...status } : null;
        },
        getItemFromCard: (card) => {
          const id = String(card?.getAttribute?.('data-track-id') || '').trim();
          if (!id) return null;
          const row = albumTracks.find((item) => String(item?.id || '').trim() === id);
          const artists = Array.isArray(row?.artists) ? row.artists.join(', ') : '';
          return {
            mediaType: 'music',
            itemId: id,
            title: String(row?.name || card?.getAttribute?.('data-title') || 'Track'),
            subtitle: artists || String(card?.getAttribute?.('data-subtitle') || ''),
            image: String(row?.image || card?.getAttribute?.('data-image') || '')
          };
        },
        ensureClient: async () => {
          if (supabaseClient) return supabaseClient;
          await ensureSupabase();
          return supabaseClient;
        },
        getCurrentUser: () => currentUser,
        notify: (message, isError) => {
          const status = qs('songStatus');
          if (status) {
            status.textContent = String(message || '');
            status.classList.toggle('error', !!isError);
          }
        },
        toggleDefaultList: async ({ itemId, listType, card, nextSaved }) =>
          toggleAlbumTrackDefaultList(itemId, listType, card, nextSaved)
      });
    }

    function ensureListMenuBackdrop() {
      let backdrop = document.getElementById('songListMenuBackdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'songListMenuBackdrop';
        backdrop.className = 'list-menu-backdrop';
        backdrop.addEventListener('click', closeAllListMenus);
        document.body.appendChild(backdrop);
      }
      return backdrop;
    }

    function showListMenuBackdrop() {
      const backdrop = ensureListMenuBackdrop();
      backdrop.classList.add('active');
    }

    function hideListMenuBackdrop() {
      const backdrop = document.getElementById('songListMenuBackdrop');
      if (backdrop) backdrop.classList.remove('active');
    }

    function closeAllListMenus() {
      const menu = qs('songListMenu');
      if (menu) menu.classList.remove('open');
      hideListMenuBackdrop();
    }

    function wireListMenu() {
      const menuBtn = qs('songMenuBtn');
      const menu = qs('songListMenu');
      if (!menuBtn || !menu) return;

      menuBtn.addEventListener('click', (event) => {
        event.stopPropagation();
        const wasOpen = menu.classList.contains('open');
        closeAllListMenus();
        if (!wasOpen) {
          menu.classList.add('open');
          showListMenuBackdrop();
        }
      });

      document.addEventListener('click', (event) => {
        if (!event.target.closest('.menu-wrapper') && !event.target.closest('.list-menu')) {
          closeAllListMenus();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') closeAllListMenus();
      });

      menu.querySelectorAll('.list-action[data-list]').forEach((btn) => {
        btn.addEventListener('click', async (event) => {
          event.stopPropagation();
          const listType = String(btn.getAttribute('data-list') || '').trim().toLowerCase();
          await toggleList(listType);
          closeAllListMenus();
        });
      });
    }

    async function initSongPage() {
      await loadAuth();
      const url = new URL(window.location.href);
      const id = String(url.searchParams.get('id') || '').trim();
      const albumId = String(url.searchParams.get('album_id') || '').trim();
      const source = String(url.searchParams.get('source') || '').trim().toLowerCase();

      if (albumId) {
        const primarySource = source || inferSourceFromId(albumId);
        let payload = await fetchAlbumDetails(albumId, primarySource);
        if (!payload && primarySource !== 'itunes') {
          payload = await fetchAlbumDetails(albumId, 'itunes');
        }
        if (!payload?.album) {
          qs('songStatus').textContent = 'Could not load this album.';
          qs('songStatus').classList.add('error');
          return;
        }
        await renderAlbumPage(payload);
        return;
      }

      if (!id) {
        qs('songStatus').textContent = 'Missing song id.';
        qs('songStatus').classList.add('error');
        return;
      }

      let data = null;
      if (source === 'itunes') {
        data = await fetchItunesTrack(id);
      } else {
        data = await fetchSpotifyTrack(id);
        if (!data) data = await fetchItunesTrack(id);
      }

      if (!data) {
        qs('songStatus').textContent = 'Could not load this song.';
        qs('songStatus').classList.add('error');
        return;
      }

      renderTrack(data);
      await loadTrackListStatus();

      const firstArtistId = Array.isArray(data.artist_ids) && data.artist_ids.length
        ? String(data.artist_ids[0] || '').trim()
        : '';
      if (firstArtistId) {
        const artist = await fetchSpotifyArtist(firstArtistId);
        if (artist) renderArtist(artist);
      }
    }

    qs('listenBtn').addEventListener('click', () => {
      if (albumMode) {
        qs('albumTracksSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return;
      }
      const audio = qs('previewPlayer');
      if (!audio || !track?.preview_url) return;
      if (audio.paused) audio.play().catch(() => {});
      else audio.pause();
    });

    document.addEventListener('DOMContentLoaded', () => {
      if (window.initUniversalSearch) {
        window.initUniversalSearch({ input: '#globalSearch', fallbackRoute: 'music.html' });
      }
      initAlbumTrackKebabMenu();
      wireListMenu();
      initSongPage();
    });
  </script>
  <script src="js/production-runtime.js?v=20260227b" defer></script>
</body>
</html>








