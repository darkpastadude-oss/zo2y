<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex">
  <title>Zo2y - Travel</title>
  <meta name="description" content="Browse countries, save travel lists, and open country pages with reviews.">
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="js/list-utils.js?v=20260301d" defer></script>
  <script src="js/index-list-menu-adapter.js?v=20260301e" defer></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --card-2: #172b58;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --white: #fff;
      --border: rgba(255,255,255,0.12);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      padding: 0 12px 18px;
    }
    a { color: inherit; text-decoration: none; }
    .top {
      max-width: 1200px;
      margin: 0 auto;
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(11,22,51,0.9);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--border);
      padding: 12px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .top img { height: 34px; border-radius: 8px; }
    .pill {
      border: 1px solid var(--border);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill.active { color: var(--accent); }
    .acct {
      margin-left: auto;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .hero, .controls, .shell, .pager {
      max-width: 1200px;
      margin: 12px auto 0;
    }
    .hero, .shell {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(160deg, rgba(23,43,88,0.9), rgba(19,35,71,0.95));
    }
    .hero { padding: 14px; }
    .hero h1 { margin: 0 0 6px; font-size: 28px; }
    .hero p { margin: 0; color: var(--muted); font-size: 14px; }
    .controls {
      display: grid;
      grid-template-columns: 1fr 180px 160px auto;
      gap: 8px;
    }
    .controls input, .controls select {
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #10224a;
      color: #fff;
      padding: 0 10px;
    }
    .controls button, .pager button {
      height: 40px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card);
      color: #fff;
      padding: 0 12px;
      cursor: pointer;
    }
    .shell { padding: 12px; min-height: 220px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
    }
    .empty {
      display: none;
      color: var(--muted);
      text-align: center;
      padding: 24px;
    }
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #0f2147;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      min-height: 290px;
    }
    .card-photo-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1 / 1;
      background: #10224a;
      overflow: hidden;
    }
    .card-photo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center center;
      display: block;
    }
    .body { padding: 10px; display: grid; gap: 6px; flex: 1; }
    .row { display: flex; justify-content: space-between; gap: 8px; }
    .ttl {
      margin: 0;
      font-size: 17px;
      line-height: 1.25;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      max-width: 100%;
    }
    .ttl-flag {
      width: 20px;
      height: 14px;
      border-radius: 3px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.28);
      flex-shrink: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(9, 20, 44, 0.9);
    }
    .ttl-flag img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .ttl-text {
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: inline-block;
      max-width: 100%;
    }
    .code { font-size: 11px; color: var(--muted); text-transform: uppercase; }
    .meta, .sub { font-size: 12px; }
    .meta { color: #dce8ff; }
    .sub { color: var(--muted); }
    .menu-btn {
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 9px;
      background: rgba(255,255,255,0.04);
      color: #dce8ff;
      cursor: pointer;
    }
    .menu-btn.saved {
      border-color: rgba(34,197,94,0.6);
      color: #86efac;
      background: rgba(22,163,74,0.2);
    }
    .pager {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
    }
    .info {
      color: var(--muted);
      font-size: 13px;
      min-width: 88px;
      text-align: center;
    }
    .toast {
      position: fixed;
      top: 12px;
      right: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      z-index: 9999;
    }
    .ok { background: #10b981; }
    .err { background: #ef4444; }
    .inf { background: #3b82f6; }
    @media (max-width: 760px) {
      .controls { grid-template-columns: 1fr; }
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .ttl { font-size: 14px; }
      .ttl-flag { width: 18px; height: 12px; }
    }
  </style>
</head>
<body>
  <header class="top">
    <a href="index.html"><img src="images/logo.png" alt="Zo2y"></a>
    <a class="pill" href="index.html">Home</a>
    <a class="pill active" href="travel.html">Travel</a>
    <a class="pill" href="reviews.html">Reviews</a>
    <button id="acctBtn" class="acct"><i class="fas fa-user"></i> Account</button>
  </header>

  <section class="hero">
    <h1><i class="fa-solid fa-earth-americas"></i> Travel</h1>
    <p>Browse countries with photos, save to Favorites/Visited/Bucket List, and open each country page for reviews.</p>
  </section>

  <section class="controls">
    <input id="q" placeholder="Search countries, capitals, regions...">
    <select id="region"><option value="">All Regions</option></select>
    <select id="sort">
      <option value="name">Name A-Z</option>
      <option value="region">Region</option>
    </select>
    <button id="refresh"><i class="fas fa-rotate"></i> Refresh</button>
  </section>

  <section class="shell">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty">No countries found.</div>
  </section>

  <section class="pager">
    <button id="prev"><i class="fas fa-chevron-left"></i> Prev</button>
    <span id="pageInfo" class="info">Page 1/1</span>
    <button id="next">Next <i class="fas fa-chevron-right"></i></button>
  </section>

  <script>
  (() => {
    const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
    const COUNTRIES_URL = 'https://restcountries.com/v3.1/all?fields=name,cca2,cca3,capital,region,subregion,flags';
    const PAGE_SIZE = 24;
    const TRAVEL_PHOTO_CACHE_KEY = 'zo2y_travel_photo_cache_v3';
    const TRAVEL_PHOTO_CACHE_TTL_MS = 1000 * 60 * 60 * 24 * 14;
    const TRAVEL_COUNTRY_ROWS_CACHE_KEY = 'zo2y_travel_country_rows_v2';
    const TRAVEL_COUNTRY_ROWS_CACHE_TTL_MS = 1000 * 60 * 60 * 12;

    let client = null;
    const state = {
      user: null,
      rows: [],
      filtered: [],
      search: '',
      region: '',
      sort: 'name',
      page: 1,
      totalPages: 1,
      hasMore: false,
      listStatus: new Map(),
      pending: new Set()
    };
    const countryPhotoCache = new Map();
    const countryPhotoPending = new Set();
    let countryPhotoSaveTimer = null;
    const countryCityHints = {
      US: ['New York', 'Los Angeles', 'Chicago'],
      JP: ['Tokyo', 'Kyoto', 'Osaka'],
      FR: ['Paris', 'Lyon', 'Nice'],
      IT: ['Rome', 'Florence', 'Milan'],
      ES: ['Madrid', 'Barcelona', 'Seville'],
      BR: ['Rio de Janeiro', 'Sao Paulo', 'Salvador'],
      EG: ['Cairo', 'Alexandria', 'Luxor'],
      AU: ['Sydney', 'Melbourne', 'Brisbane'],
      GB: ['London', 'Edinburgh', 'Manchester'],
      DE: ['Berlin', 'Munich', 'Hamburg'],
      CA: ['Toronto', 'Vancouver', 'Montreal'],
      MX: ['Mexico City', 'Guadalajara', 'Merida'],
      TR: ['Istanbul', 'Ankara', 'Antalya'],
      TH: ['Bangkok', 'Chiang Mai', 'Phuket'],
      ID: ['Bali', 'Jakarta', 'Yogyakarta'],
      ZA: ['Cape Town', 'Johannesburg', 'Durban']
    };

    const emptyStatus = () => ({ favorites: false, visited: false, bucketlist: false });
    const ESCAPE_MAP = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;'
    };

    function escapeHtml(value) {
      return String(value || '').replace(/[&<>"']/g, (ch) => ESCAPE_MAP[ch] || ch);
    }

    function safeCode(value) {
      return String(value || '').trim().toUpperCase();
    }

    function canonicalCountryCode(value) {
      const raw = safeCode(value);
      if (raw === 'IL') return 'PS';
      return raw;
    }

    function safeHttps(url) {
      const text = String(url || '').trim();
      if (!text) return '';
      if (text.startsWith('//')) return `https:${text}`;
      if (text.startsWith('http://')) return text.replace(/^http:\/\//i, 'https://');
      return text;
    }

    function isBadTravelPhotoUrl(url) {
      const raw = String(url || '').trim().toLowerCase();
      if (!raw) return true;
      if (raw.includes('picsum.photos')) return true;
      if (raw.includes('images/logo.png')) return true;
      if (raw.includes('flagcdn.com')) return true;
      if (raw.includes('/flags/')) return true;
      if (raw.includes('flag_of_') || raw.includes('flag-of-')) return true;
      const blocked = ['painting', 'artwork', 'illustration', 'drawing', 'poster', 'coat_of_arms', 'coat-of-arms', 'emblem', 'seal', 'map_of_', 'map-of-'];
      return blocked.some((token) => raw.includes(token));
    }

    function normalizeTravelSearchQuery(value) {
      const query = String(value || '').trim().toLowerCase();
      if (!query) return '';
      return query
        .replace(/\bisrael\b/g, 'palestine')
        .replace(/\bisreal\b/g, 'palestine');
    }

    function loadCountryPhotoCacheFromStorage() {
      try {
        const raw = localStorage.getItem(TRAVEL_PHOTO_CACHE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        const savedAt = Number(parsed && parsed.savedAt || 0);
        const entries = parsed && parsed.entries && typeof parsed.entries === 'object'
          ? parsed.entries
          : null;
        if (!savedAt || !entries) return;
        if ((Date.now() - savedAt) > TRAVEL_PHOTO_CACHE_TTL_MS) return;
        Object.entries(entries).forEach(([code, url]) => {
          const safeCountryCode = canonicalCountryCode(code);
          const safeUrl = safeHttps(url);
          if (!safeCountryCode || !safeUrl || isBadTravelPhotoUrl(safeUrl)) return;
          countryPhotoCache.set(safeCountryCode, safeUrl);
        });
      } catch (_error) {}
    }

    function scheduleCountryPhotoCacheSave() {
      if (countryPhotoSaveTimer) window.clearTimeout(countryPhotoSaveTimer);
      countryPhotoSaveTimer = window.setTimeout(() => {
        countryPhotoSaveTimer = null;
        try {
          const entries = {};
          countryPhotoCache.forEach((url, code) => {
            const safeCountryCode = safeCode(code);
            const safeUrl = safeHttps(url);
            if (!safeCountryCode || !safeUrl || isBadTravelPhotoUrl(safeUrl)) return;
            entries[safeCountryCode] = safeUrl;
          });
          localStorage.setItem(TRAVEL_PHOTO_CACHE_KEY, JSON.stringify({
            savedAt: Date.now(),
            entries
          }));
        } catch (_error) {}
      }, 180);
    }

    function setCountryPhotoCache(code, url) {
      const safeCountryCode = canonicalCountryCode(code);
      const safeUrl = safeHttps(url);
      if (!safeCountryCode || !safeUrl || isBadTravelPhotoUrl(safeUrl)) return;
      const current = String(countryPhotoCache.get(safeCountryCode) || '').trim();
      if (current === safeUrl) return;
      countryPhotoCache.set(safeCountryCode, safeUrl);
      scheduleCountryPhotoCacheSave();
    }

    function hydrateRegionOptions() {
      const select = document.getElementById('region');
      if (!select) return;
      const current = state.region;
      const regions = [...new Set(state.rows.map((item) => item.region).filter(Boolean))]
        .sort((a, b) => a.localeCompare(b));
      select.innerHTML = '<option value="">All Regions</option>';
      regions.forEach((value) => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });
      select.value = current;
    }

    function readCountryRowsCache() {
      try {
        const raw = localStorage.getItem(TRAVEL_COUNTRY_ROWS_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        const savedAt = Number(parsed && parsed.savedAt || 0);
        const rows = Array.isArray(parsed && parsed.rows) ? parsed.rows : null;
        if (!savedAt || !rows) return null;
        if ((Date.now() - savedAt) > TRAVEL_COUNTRY_ROWS_CACHE_TTL_MS) return null;
        return rows
          .map((row) => {
            const code = safeCode(row && row.code);
            if (code === 'IL') return null;
            const name = String(row && row.name || '').trim();
            if (!code || !name) return null;
            if (/\bisrael\b/i.test(name)) return null;
            const capital = String(row && row.capital || '').trim();
            const region = String(row && row.region || '').trim();
            const subregion = String(row && row.subregion || '').trim();
            const flag = safeHttps(row && row.flag || '') || `https://flagcdn.com/w640/${code.toLowerCase()}.png`;
            const cachedPhoto = safeHttps(row && row.photo || '');
            const photo = (cachedPhoto && !isBadTravelPhotoUrl(cachedPhoto)) ? cachedPhoto : (buildCountryPhotoUrl(name, code) || flag);
            const cities = Array.isArray(row && row.cities) ? row.cities.map((value) => String(value || '').trim()).filter(Boolean).slice(0, 3) : pickCountryCities(code, capital);
            return { code, name, capital, region, subregion, cities, flag, photo };
          })
          .filter(Boolean);
      } catch (_error) {
        return null;
      }
    }

    function writeCountryRowsCache(rows = []) {
      try {
        const list = (Array.isArray(rows) ? rows : [])
          .map((row) => {
            const code = safeCode(row && row.code);
            if (code === 'IL') return null;
            const name = String(row && row.name || '').trim();
            if (!code || !name) return null;
            if (/\bisrael\b/i.test(name)) return null;
            return {
              code,
              name,
              capital: String(row && row.capital || '').trim(),
              region: String(row && row.region || '').trim(),
              subregion: String(row && row.subregion || '').trim(),
              cities: Array.isArray(row && row.cities) ? row.cities.slice(0, 3) : [],
              flag: safeHttps(row && row.flag || ''),
              photo: (() => {
                const value = safeHttps(row && row.photo || '');
                return value && !isBadTravelPhotoUrl(value) ? value : '';
              })()
            };
          })
          .filter(Boolean);
        localStorage.setItem(TRAVEL_COUNTRY_ROWS_CACHE_KEY, JSON.stringify({
          savedAt: Date.now(),
          rows: list
        }));
      } catch (_error) {}
    }

    function buildCountryPhotoUrl(name, code) {
      const safeCountryCode = canonicalCountryCode(code) || 'XX';
      const cached = String(countryPhotoCache.get(safeCountryCode) || '').trim();
      if (cached && !isBadTravelPhotoUrl(cached)) return cached;
      return '';
    }

    function normalizeCountryName(value) {
      return String(value || '')
        .trim()
        .toLowerCase()
        .replace(/\s+\(country\)\s*$/i, '')
        .replace(/[^a-z0-9 ]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function pickCountryCities(code, capital) {
      const safeCountryCode = safeCode(code);
      const seeded = Array.isArray(countryCityHints[safeCountryCode]) ? countryCityHints[safeCountryCode] : [];
      const out = [];
      if (capital) out.push(capital);
      seeded.forEach((city) => {
        if (!city) return;
        if (out.some((value) => value.toLowerCase() === String(city).toLowerCase())) return;
        out.push(city);
      });
      return out.slice(0, 3);
    }

    function isBadScenicTitle(title, countryName, capital) {
      const raw = String(title || '').toLowerCase();
      if (!raw) return true;
      const blocked = [
        'flag',
        'coat of arms',
        'emblem',
        'seal',
        'map of',
        'locator map',
        'location map',
        'orthographic',
        'equirectangular',
        'blank map',
        'administrative map',
        'province map',
        'political map',
        'banner',
        'painting',
        'artwork',
        'illustration',
        'drawing',
        'poster'
      ];
      if (blocked.some((token) => raw.includes(token))) return true;
      const countryNeedle = normalizeCountryName(countryName);
      const capitalNeedle = normalizeCountryName(capital);
      if (!countryNeedle && !capitalNeedle) return false;
      const normalizedTitle = normalizeCountryName(title);
      const hasCountry = countryNeedle && normalizedTitle.includes(countryNeedle);
      const hasCapital = capitalNeedle && normalizedTitle.includes(capitalNeedle);
      return !(hasCountry || hasCapital);
    }

    async function fetchCommonsScenicPhoto(name, code, capital, signal) {
      const safeCountryCode = canonicalCountryCode(code);
      if (!safeCountryCode) return '';
      if (countryPhotoCache.has(safeCountryCode)) return countryPhotoCache.get(safeCountryCode);

      const queries = [
        `${name} landscape`,
        `${name} travel photography`,
        `${name} city skyline`,
        `${capital ? `${capital} skyline` : ''}`,
        `${name} nature`
      ].map((value) => String(value || '').trim()).filter(Boolean);

      for (const query of queries) {
        if (signal && signal.aborted) break;
        const endpoint = `https://commons.wikimedia.org/w/api.php?action=query&format=json&formatversion=2&origin=*&generator=search&gsrnamespace=6&gsrlimit=10&gsrsearch=${encodeURIComponent(query)}&prop=imageinfo&iiprop=url|mime&iiurlwidth=1400`;
        try {
          const response = await fetch(endpoint, { signal, headers: { Accept: 'application/json' } });
          if (!response.ok) continue;
          const payload = await response.json();
          const pages = Array.isArray(payload && payload.query && payload.query.pages) ? payload.query.pages : [];
          const preferred = pages.find((page) => {
            const title = String(page && page.title || '');
            const mime = String(page && page.imageinfo && page.imageinfo[0] && page.imageinfo[0].mime || '').toLowerCase();
            const isPhotoLike = mime === 'image/jpeg' || mime === 'image/jpg' || mime === 'image/webp';
            if (!isPhotoLike) return false;
            if (isBadScenicTitle(title, name, capital)) return false;
            return true;
          }) || pages.find((page) => {
            const title = String(page && page.title || '');
            const mime = String(page && page.imageinfo && page.imageinfo[0] && page.imageinfo[0].mime || '').toLowerCase();
            const isPhotoLike = mime === 'image/jpeg' || mime === 'image/jpg' || mime === 'image/webp';
            if (!isPhotoLike) return false;
            const blocked = ['flag', 'coat of arms', 'emblem', 'seal', 'map of', 'locator map', 'location map', 'orthographic', 'equirectangular', 'blank map'];
            return !blocked.some((token) => title.toLowerCase().includes(token));
          });
          const image = safeHttps(preferred && preferred.imageinfo && preferred.imageinfo[0] && (preferred.imageinfo[0].thumburl || preferred.imageinfo[0].url));
          if (image) {
            setCountryPhotoCache(safeCountryCode, image);
            return image;
          }
        } catch (_error) {
          // try next query
        }
      }

      return '';
    }

    async function hydrateScenicCountryPhotos(rows = [], signal) {
      const list = Array.isArray(rows) ? rows : [];
      if (!list.length) return;

      const unresolved = list.filter((item) => {
        const code = safeCode(item && item.code);
        return code && !countryPhotoCache.has(code) && !countryPhotoPending.has(code);
      });
      const queue = unresolved.slice(0, 120);
      queue.forEach((item) => {
        const code = safeCode(item && item.code);
        if (code) countryPhotoPending.add(code);
      });
      const workers = Array.from({ length: Math.min(5, queue.length) }, async () => {
        while (queue.length) {
          if (signal && signal.aborted) return;
          const item = queue.shift();
          const code = safeCode(item && item.code);
          if (!item || !code) continue;
          const name = String(item && item.name || '').trim();
          const capital = String(item && item.capital || '').trim();
          try {
            const scenic = await fetchCommonsScenicPhoto(name, code, capital, signal);
            if (scenic) setCountryPhotoCache(code, scenic);
          } finally {
            countryPhotoPending.delete(code);
          }
        }
      });
      await Promise.all(workers);

      list.forEach((item) => {
        const code = safeCode(item && item.code);
        if (!code) return;
        const cached = countryPhotoCache.get(code);
        item.photo = (cached && !isBadTravelPhotoUrl(cached)) ? cached : (buildCountryPhotoUrl(item && item.name, code) || item.flag);
      });
    }

    function showToast(message, type = 'inf') {
      const node = document.createElement('div');
      node.className = `toast ${type}`;
      node.textContent = message;
      document.body.appendChild(node);
      window.setTimeout(() => node.remove(), 1800);
    }

    async function ensureClient() {
      if (client) return client;
      for (let i = 0; i < 20; i += 1) {
        if (window.supabase && typeof window.supabase.createClient === 'function') {
          client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
          });
          return client;
        }
        await new Promise((resolve) => setTimeout(resolve, 120));
      }
      return null;
    }

    function updateAccountButton() {
      const btn = document.getElementById('acctBtn');
      if (!btn) return;
      if (state.user) {
        btn.innerHTML = '<i class="fas fa-user"></i> Profile';
        btn.onclick = () => { window.location.href = 'profile.html'; };
        return;
      }
      btn.innerHTML = '<i class="fas fa-user"></i> Account';
      btn.onclick = () => { window.location.href = 'login.html'; };
    }

    async function syncAuth() {
      const sb = await ensureClient();
      if (!sb) {
        updateAccountButton();
        return;
      }
      try {
        const { data } = await sb.auth.getUser();
        state.user = data && data.user ? data.user : null;
      } catch (_error) {
        state.user = null;
      }
      updateAccountButton();
      await loadTravelListStatus();
      sb.auth.onAuthStateChange((_event, session) => {
        state.user = session && session.user ? session.user : null;
        updateAccountButton();
        void loadTravelListStatus();
      });
    }

    function normalizeCountryRow(row) {
      const rawCode = safeCode(row && (row.cca2 || row.cca3));
      if (!rawCode || rawCode === 'IL') return null;
      const code = canonicalCountryCode(rawCode);
      let name = String(row && row.name && (row.name.common || row.name.official) || '').trim();
      if (!code || !name) return null;
      if (/\bisrael\b/i.test(name)) return null;
      const capital = Array.isArray(row && row.capital)
        ? String(row.capital[0] || '').trim()
        : String(row && row.capital || '').trim();
      const region = String(row && row.region || '').trim();
      const subregion = String(row && row.subregion || '').trim();
      const flag = safeHttps(row && row.flags && (row.flags.png || row.flags.svg)) || `https://flagcdn.com/w640/${code.toLowerCase()}.png`;
      const photo = buildCountryPhotoUrl(name, code) || flag;
      return {
        code,
        name,
        capital,
        region,
        subregion,
        cities: pickCountryCities(code, capital),
        flag,
        photo
      };
    }

    async function loadCountries(force = false) {
      if (state.rows.length && !force) return true;
      if (!force && !state.rows.length) {
        const cachedRows = readCountryRowsCache();
        if (Array.isArray(cachedRows) && cachedRows.length) {
          state.rows = cachedRows.sort((a, b) => a.name.localeCompare(b.name));
          hydrateRegionOptions();
          void hydrateScenicCountryPhotos(state.rows.slice(0, 90))
            .then(() => {
              writeCountryRowsCache(state.rows);
              render();
            })
            .catch(() => {});
          return true;
        }
      }
      const controller = new AbortController();
      const timeout = window.setTimeout(() => controller.abort(), 9000);
      try {
        const response = await fetch(COUNTRIES_URL, {
          signal: controller.signal,
          headers: { Accept: 'application/json' }
        });
        if (!response.ok) return false;
        const payload = await response.json();
        state.rows = (Array.isArray(payload) ? payload : [])
          .map(normalizeCountryRow)
          .filter(Boolean)
          .sort((a, b) => a.name.localeCompare(b.name));
        void hydrateScenicCountryPhotos(state.rows.slice(0, 90), controller.signal)
          .then(() => {
            writeCountryRowsCache(state.rows);
            render();
          })
          .catch(() => {});
        state.rows = state.rows
          .sort((a, b) => a.name.localeCompare(b.name));
        hydrateRegionOptions();
        writeCountryRowsCache(state.rows);
        return true;
      } catch (_error) {
        return false;
      } finally {
        window.clearTimeout(timeout);
      }
    }

    function applyFilter() {
      const query = normalizeTravelSearchQuery(state.search);
      const region = state.region.toLowerCase();
      let output = state.rows.filter((item) => {
        if (region && item.region.toLowerCase() !== region) return false;
        if (!query) return true;
        const cityText = Array.isArray(item.cities) ? item.cities.join(' ') : '';
        const haystack = `${item.name} ${item.capital} ${item.region} ${item.subregion} ${item.code} ${cityText}`.toLowerCase();
        return haystack.includes(query);
      });
      if (state.sort === 'name') {
        output = output.sort((a, b) => a.name.localeCompare(b.name));
      } else if (state.sort === 'region') {
        output = output.sort((a, b) => {
          const left = a.region || '';
          const right = b.region || '';
          return left.localeCompare(right) || a.name.localeCompare(b.name);
        });
      }
      state.filtered = output;
    }

    function syncCardStatus(card) {
      const code = safeCode(card && card.getAttribute('data-country-code'));
      if (!code) return;
      const status = state.listStatus.get(code) || emptyStatus();
      const saved = !!(status.favorites || status.visited || status.bucketlist);
      const btn = card.querySelector('.menu-btn');
      if (btn) btn.classList.toggle('saved', saved);
    }

    function syncAllCardStatuses() {
      document.querySelectorAll('.card[data-country-code]').forEach(syncCardStatus);
    }

    function syncPager() {
      const prev = document.getElementById('prev');
      const next = document.getElementById('next');
      const info = document.getElementById('pageInfo');
      prev.disabled = state.page <= 1;
      next.disabled = !state.hasMore;
      info.textContent = `Page ${state.page}/${state.totalPages}`;
    }

    function render() {
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      applyFilter();
      const count = state.filtered.length;
      state.totalPages = Math.max(1, Math.ceil(count / PAGE_SIZE));
      state.page = Math.min(Math.max(1, state.page), state.totalPages);
      const start = (state.page - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const pageRows = state.filtered.slice(start, end);
      grid.innerHTML = '';

      if (!pageRows.length) {
        empty.style.display = 'block';
        state.hasMore = false;
        syncPager();
        return;
      }
      empty.style.display = 'none';

      pageRows.forEach((item) => {
        const node = document.createElement('article');
        node.className = 'card';
        node.setAttribute('data-country-code', item.code);
        node.setAttribute('data-list-image', item.flag);
        node.setAttribute('data-image', item.photo);
        node.innerHTML = `
          <div class="card-photo-wrap">
            <img class="card-photo" src="${escapeHtml(item.photo)}" alt="${escapeHtml(item.name)} photo" loading="lazy" onerror="this.onerror=null;this.src='${escapeHtml(item.flag)}';">
          </div>
          <div class="body">
            <div class="row">
              <div>
                <h2 class="ttl">
                  <span class="ttl-flag"><img src="${escapeHtml(item.flag)}" alt="" aria-hidden="true" loading="lazy" onerror="this.onerror=null;this.src='images/logo.png';"></span>
                  <span class="ttl-text">${escapeHtml(item.name)}</span>
                </h2>
                <div class="code">${escapeHtml(item.code)}</div>
              </div>
              <button class="menu-btn" aria-label="Add to lists"><i class="fas fa-ellipsis-v"></i></button>
            </div>
            <div class="meta">${escapeHtml(item.capital ? `Capital: ${item.capital}` : 'Capital: N/A')}</div>
            <div class="sub">${escapeHtml([item.region, item.subregion].filter(Boolean).join(' | ') || 'Region unavailable')}</div>
            <div class="sub">${escapeHtml(item.cities && item.cities.length ? `Cities: ${item.cities.join(', ')}` : 'Cities: N/A')}</div>
          </div>
        `;

        node.addEventListener('click', (event) => {
          if (event.target && event.target.closest('.menu-btn')) return;
          window.location.href = `country.html?code=${encodeURIComponent(item.code)}`;
        });

        const menuBtn = node.querySelector('.menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (window.openIndexStyleListMenu) window.openIndexStyleListMenu(node);
          });
        }
        grid.appendChild(node);
      });

      state.hasMore = end < count;
      syncPager();
      syncAllCardStatuses();
      void hydrateScenicCountryPhotos(pageRows).then(() => {
        pageRows.forEach((item) => {
          const node = grid.querySelector(`.card[data-country-code="${item.code}"] .card-photo`);
          if (!node) return;
          const nextPhoto = String(item.photo || '').trim();
          if (!nextPhoto) return;
          if (node.getAttribute('src') === nextPhoto) return;
          node.setAttribute('src', nextPhoto);
        });
      }).catch(() => {});
    }

    async function loadTravelListStatus() {
      state.listStatus = new Map();
      const sb = await ensureClient();
      if (!sb || !state.user || !state.user.id) {
        syncAllCardStatuses();
        return;
      }
      const { data, error } = await sb
        .from('travel_list_items')
        .select('country_code,list_type')
        .eq('user_id', state.user.id);
      if (error || !Array.isArray(data)) {
        syncAllCardStatuses();
        return;
      }
      data.forEach((row) => {
        const code = safeCode(row && row.country_code);
        const type = String(row && row.list_type || '').toLowerCase();
        if (!code || !['favorites', 'visited', 'bucketlist'].includes(type)) return;
        if (!state.listStatus.has(code)) state.listStatus.set(code, emptyStatus());
        state.listStatus.get(code)[type] = true;
      });
      syncAllCardStatuses();
    }

    async function toggleTravelDefaultList(itemId, listType, card, nextSaved) {
      const countryCode = safeCode(itemId);
      const type = String(listType || '').toLowerCase();
      if (!countryCode || !['favorites', 'visited', 'bucketlist'].includes(type)) {
        return { ok: false, saved: false };
      }
      if (!state.user || !state.user.id) {
        showToast('Please sign in', 'inf');
        return { ok: false, saved: false };
      }
      const sb = await ensureClient();
      if (!sb) {
        showToast('List service unavailable', 'err');
        return { ok: false, saved: false };
      }

      const status = state.listStatus.get(countryCode) || emptyStatus();
      const previous = !!status[type];
      const target = typeof nextSaved === 'boolean' ? nextSaved : !previous;
      const opKey = `${countryCode}:${type}`;
      if (state.pending.has(opKey)) return { ok: false, saved: previous };

      state.pending.add(opKey);
      status[type] = target;
      state.listStatus.set(countryCode, status);
      syncCardStatus(card);

      try {
        if (target) {
          const { error } = await sb
            .from('travel_list_items')
            .insert({ user_id: state.user.id, country_code: countryCode, list_type: type });
          if (error && error.code !== '23505') throw error;
          showToast('Saved to list', 'ok');
        } else {
          const { error } = await sb
            .from('travel_list_items')
            .delete()
            .eq('user_id', state.user.id)
            .eq('country_code', countryCode)
            .eq('list_type', type);
          if (error) throw error;
          showToast('Removed', 'inf');
        }
        return { ok: true, saved: target };
      } catch (_error) {
        status[type] = previous;
        state.listStatus.set(countryCode, status);
        syncCardStatus(card);
        showToast('Could not update list', 'err');
        return { ok: false, saved: previous };
      } finally {
        state.pending.delete(opKey);
      }
    }

    function wireEvents() {
      let searchTimer = null;
      const searchInput = document.getElementById('q');
      const regionSelect = document.getElementById('region');
      const sortSelect = document.getElementById('sort');
      const refreshBtn = document.getElementById('refresh');
      const prevBtn = document.getElementById('prev');
      const nextBtn = document.getElementById('next');

      if (searchInput) {
        searchInput.addEventListener('input', (event) => {
          window.clearTimeout(searchTimer);
          searchTimer = window.setTimeout(() => {
            state.search = String(event.target.value || '').trim();
            state.page = 1;
            render();
          }, 200);
        });
      }

      if (regionSelect) {
        regionSelect.addEventListener('change', (event) => {
          state.region = String(event.target.value || '').trim();
          state.page = 1;
          render();
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener('change', (event) => {
          state.sort = String(event.target.value || 'pop');
          state.page = 1;
          render();
        });
      }

      if (refreshBtn) {
        refreshBtn.addEventListener('click', async () => {
          refreshBtn.disabled = true;
          const ok = await loadCountries(true);
          refreshBtn.disabled = false;
          if (!ok) {
            showToast('Refresh failed', 'err');
            return;
          }
          state.page = 1;
          render();
          showToast('Refreshed', 'ok');
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          if (state.page > 1) {
            state.page -= 1;
            render();
          }
        });
      }

      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          if (state.hasMore) {
            state.page += 1;
            render();
          }
        });
      }
    }

    function wireListMenuBridge() {
      if (!window.initIndexStyleListMenu) return;
      window.initIndexStyleListMenu({
        mediaType: 'travel',
        itemIdAttr: 'data-country-code',
        getVisibleItemIds: () => Array.from(document.querySelectorAll('.card[data-country-code]'))
          .map((node) => node.getAttribute('data-country-code'))
          .filter(Boolean),
        getQuickStatusForItem: (id) => {
          const status = state.listStatus.get(safeCode(id));
          return status ? { ...status } : null;
        },
        ensureClient: async () => ensureClient(),
        getCurrentUser: () => state.user,
        notify: (message, errorLike) => showToast(message, errorLike ? 'err' : 'ok'),
        toggleDefaultList: async ({ itemId, listType, card, nextSaved }) =>
          toggleTravelDefaultList(itemId, listType, card, nextSaved)
      });
    }

    async function init() {
      loadCountryPhotoCacheFromStorage();
      await ensureClient();
      wireEvents();
      const params = new URLSearchParams(window.location.search);
      const initialSearch = String(params.get('search') || '').trim();
      if (initialSearch) {
        state.search = initialSearch;
        const input = document.getElementById('q');
        if (input) input.value = initialSearch;
      }

      const ok = await loadCountries();
      if (!ok) {
        const empty = document.getElementById('empty');
        empty.style.display = 'block';
        empty.textContent = 'Could not load countries right now.';
      }
      render();
      wireListMenuBridge();
      await syncAuth();
    }

    document.addEventListener('DOMContentLoaded', () => { void init(); });
  })();
  </script>
  <script src="js/production-runtime.js?v=20260227d" defer></script>
</body>
</html>
