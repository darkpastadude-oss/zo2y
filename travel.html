<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex">
  <title>Zo2y - Travel</title>
  <meta name="description" content="Browse countries, save travel lists, and open country detail pages with reviews.">
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="js/list-utils.js?v=20260301d"></script>
  <script src="js/index-list-menu-adapter.js?v=20260301d"></script>
  <style>
    :root{--bg:#0b1633;--card:#132347;--muted:#8ca3c7;--accent:#f59e0b;--white:#fff;--border:rgba(255,255,255,.12)}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--white);padding:0 12px 18px}
    a{color:inherit;text-decoration:none}.top{max-width:1200px;margin:0 auto;position:sticky;top:0;z-index:10;background:rgba(11,22,51,.9);backdrop-filter:blur(8px);padding:12px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .top img{height:34px;border-radius:8px}.pill{border:1px solid var(--border);padding:7px 10px;border-radius:999px;font-size:12px;color:var(--muted)}.pill.active{color:var(--accent)}
    .acct{margin-left:auto;border:1px solid var(--border);background:var(--card);color:var(--white);border-radius:10px;padding:8px 12px;cursor:pointer}
    .hero,.controls,.shell,.pager{max-width:1200px;margin:12px auto 0}.hero,.shell{border:1px solid var(--border);border-radius:14px;background:linear-gradient(160deg,rgba(23,43,88,.9),rgba(19,35,71,.95))}
    .hero{padding:14px}.hero h1{margin:0 0 6px;font-size:28px}.hero p{margin:0;color:var(--muted);font-size:14px}
    .controls{display:grid;grid-template-columns:1fr 180px 160px auto;gap:8px}.controls input,.controls select{height:40px;border:1px solid var(--border);border-radius:10px;background:#10224a;color:#fff;padding:0 10px}
    .controls button,.pager button{height:40px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:#fff;padding:0 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}.shell{padding:12px;min-height:220px}.empty{display:none;color:var(--muted);text-align:center;padding:24px}
    .card{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0f2147;cursor:pointer;display:flex;flex-direction:column}
    .card img{width:100%;height:130px;object-fit:cover;background:#10224a}.body{padding:10px;display:grid;gap:6px;flex:1}
    .row{display:flex;justify-content:space-between;gap:8px}.ttl{margin:0;font-size:17px;line-height:1.25}.code{font-size:11px;color:var(--muted);text-transform:uppercase}
    .meta,.sub,.pop{font-size:12px}.meta{color:#dce8ff}.sub{color:var(--muted)}.pop{margin-top:auto;color:#f4d8a4;font-weight:700}
    .menu-btn{width:32px;height:32px;border:1px solid var(--border);border-radius:9px;background:rgba(255,255,255,.04);color:#dce8ff;cursor:pointer}
    .menu-btn.saved{border-color:rgba(34,197,94,.6);color:#86efac;background:rgba(22,163,74,.2)}
    .pager{display:flex;justify-content:flex-end;gap:8px;align-items:center}.info{color:var(--muted);font-size:13px;min-width:88px;text-align:center}
    .toast{position:fixed;top:12px;right:12px;padding:10px 12px;border-radius:10px;color:#fff;font-size:12px;font-weight:700;z-index:9999}.ok{background:#10b981}.err{background:#ef4444}.inf{background:#3b82f6}
    @media (max-width:760px){.controls{grid-template-columns:1fr}.grid{grid-template-columns:repeat(2,minmax(0,1fr))}.card img{height:100px}.ttl{font-size:14px}}
  </style>
</head>
<body>
  <header class="top">
    <a href="index.html"><img src="images/logo.png" alt="Zo2y"></a>
    <a class="pill" href="index.html">Home</a>
    <a class="pill active" href="travel.html">Travel</a>
    <a class="pill" href="reviews.html">Reviews</a>
    <button id="acctBtn" class="acct"><i class="fas fa-user"></i> Account</button>
  </header>

  <section class="hero">
    <h1><i class="fa-solid fa-earth-americas"></i> Travel</h1>
    <p>Save countries to Favorites, Visited, or Bucket List and open each country page for reviews.</p>
  </section>

  <section class="controls">
    <input id="q" placeholder="Search countries, capitals, regions...">
    <select id="region"><option value="">All Regions</option></select>
    <select id="sort"><option value="pop">Most Populous</option><option value="name">Name A-Z</option><option value="region">Region</option></select>
    <button id="refresh"><i class="fas fa-rotate"></i> Refresh</button>
  </section>

  <section class="shell">
    <div id="grid" class="grid"></div>
    <div id="empty" class="empty">No countries found.</div>
  </section>

  <section class="pager">
    <button id="prev"><i class="fas fa-chevron-left"></i> Prev</button>
    <span id="pageInfo" class="info">Page 1/1</span>
    <button id="next">Next <i class="fas fa-chevron-right"></i></button>
  </section>

  <script>
  (()=>{const U='https://gfkhjbztayjyojsgdpgk.supabase.co',K='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s',E='https://restcountries.com/v3.1/all?fields=name,cca2,cca3,capital,region,subregion,population,flags',SZ=24,F=new Intl.NumberFormat('en-US');let c=null;const s={u:null,rows:[],flt:[],q:'',r:'',o:'pop',p:1,tp:1,more:false,m:new Map(),busy:new Set()};const D=()=>({favorites:false,visited:false,bucketlist:false});const esc=v=>String(v||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');const code=v=>String(v||'').trim().toUpperCase();const https=v=>{const t=String(v||'').trim();if(!t)return'';if(t.startsWith('//'))return`https:${t}`;if(t.startsWith('http://'))return t.replace(/^http:\/\//i,'https://');return t};function toast(m,t='inf'){const n=document.createElement('div');n.className=`toast ${t}`;n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),1800)}async function cli(){if(c)return c;for(let i=0;i<20;i++){if(window.supabase?.createClient){c=window.supabase.createClient(U,K,{auth:{persistSession:true,autoRefreshToken:true,detectSessionInUrl:true}});return c}await new Promise(r=>setTimeout(r,120))}return null}function acct(){const b=document.getElementById('acctBtn');if(!b)return;if(s.u){b.innerHTML='<i class=\"fas fa-user\"></i> Profile';b.onclick=()=>location.href='profile.html';return}b.innerHTML='<i class=\"fas fa-user\"></i> Account';b.onclick=()=>location.href='login.html'}async function auth(){const x=await cli();if(!x){acct();return}try{const{data}=await x.auth.getUser();s.u=data?.user||null}catch(_){s.u=null}acct();await status();x.auth.onAuthStateChange((_e,ss)=>{s.u=ss?.user||null;acct();void status()})}function norm(r){const cc=code(r?.cca2||r?.cca3),nm=String(r?.name?.common||r?.name?.official||'').trim();if(!cc||!nm)return null;const cap=Array.isArray(r?.capital)?String(r.capital[0]||'').trim():String(r?.capital||'').trim(),rg=String(r?.region||'').trim(),sg=String(r?.subregion||'').trim(),pp=Number(r?.population||0),fg=https(r?.flags?.png||r?.flags?.svg||'')||`https://flagcdn.com/w640/${cc.toLowerCase()}.png`;return{cc,nm,cap,rg,sg,pp:Number.isFinite(pp)?pp:0,fg}}async function load(force=false){if(s.rows.length&&!force)return true;const ac=new AbortController(),tm=setTimeout(()=>ac.abort(),9000);try{const r=await fetch(E,{signal:ac.signal,headers:{Accept:'application/json'}});if(!r.ok)return false;const j=await r.json();s.rows=(Array.isArray(j)?j:[]).map(norm).filter(Boolean).sort((a,b)=>b.pp-a.pp);const sel=document.getElementById('region'),cur=s.r,regs=[...new Set(s.rows.map(x=>x.rg).filter(Boolean))].sort((a,b)=>a.localeCompare(b));sel.innerHTML='<option value=\"\">All Regions</option>';regs.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o)});sel.value=cur;return true}catch(_){return false}finally{clearTimeout(tm)}}function flt(){const q=s.q.toLowerCase(),r=s.r.toLowerCase();let out=s.rows.filter(x=>{if(r&&x.rg.toLowerCase()!==r)return false;if(!q)return true;return`${x.nm} ${x.cap} ${x.rg} ${x.sg} ${x.cc}`.toLowerCase().includes(q)});if(s.o==='name')out.sort((a,b)=>a.nm.localeCompare(b.nm));else if(s.o==='region')out.sort((a,b)=>((a.rg||'').localeCompare(b.rg||''))||a.nm.localeCompare(b.nm));else out.sort((a,b)=>(b.pp-a.pp)||a.nm.localeCompare(b.nm));s.flt=out}function ui(card){const cc=code(card?.getAttribute('data-country-code'));if(!cc)return;const st=s.m.get(cc)||D(),on=!!(st.favorites||st.visited||st.bucketlist),b=card.querySelector('.menu-btn');if(b)b.classList.toggle('saved',on)}function uiAll(){document.querySelectorAll('.card[data-country-code]').forEach(ui)}function pager(){const pv=document.getElementById('prev'),nx=document.getElementById('next'),i=document.getElementById('pageInfo');pv.disabled=s.p<=1;nx.disabled=!s.more;i.textContent=`Page ${s.p}/${s.tp}`}function render(){const g=document.getElementById('grid'),e=document.getElementById('empty');flt();const n=s.flt.length;s.tp=Math.max(1,Math.ceil(n/SZ));s.p=Math.min(Math.max(1,s.p),s.tp);const st=(s.p-1)*SZ,en=st+SZ,rows=s.flt.slice(st,en);g.innerHTML='';if(!rows.length){e.style.display='block';s.more=false;pager();return}e.style.display='none';rows.forEach(x=>{const a=document.createElement('article');a.className='card';a.setAttribute('data-country-code',x.cc);a.innerHTML=`<img src=\"${esc(x.fg)}\" alt=\"${esc(x.nm)} flag\" loading=\"lazy\" onerror=\"this.onerror=null;this.src='images/logo.png';\"><div class=\"body\"><div class=\"row\"><div><h2 class=\"ttl\">${esc(x.nm)}</h2><div class=\"code\">${esc(x.cc)}</div></div><button class=\"menu-btn\" aria-label=\"Add to lists\"><i class=\"fas fa-ellipsis-v\"></i></button></div><div class=\"meta\">${esc(x.cap?`Capital: ${x.cap}`:'Capital: N/A')}</div><div class=\"sub\">${esc([x.rg,x.sg].filter(Boolean).join(' | ')||'Region unavailable')}</div><div class=\"pop\">Population: ${esc(F.format(x.pp||0))}</div></div>`;a.addEventListener('click',ev=>{if(ev.target.closest('.menu-btn'))return;location.href=`country.html?code=${encodeURIComponent(x.cc)}`});a.querySelector('.menu-btn')?.addEventListener('click',ev=>{ev.stopPropagation();if(window.openIndexStyleListMenu)window.openIndexStyleListMenu(a)});g.appendChild(a)});s.more=en<n;pager();uiAll()}async function status(){s.m=new Map();const x=await cli();if(!x||!s.u?.id){uiAll();return}const{data,error}=await x.from('travel_list_items').select('country_code,list_type').eq('user_id',s.u.id);if(error||!Array.isArray(data)){uiAll();return}data.forEach(r=>{const cc=code(r?.country_code),lt=String(r?.list_type||'').toLowerCase();if(!cc||!['favorites','visited','bucketlist'].includes(lt))return;if(!s.m.has(cc))s.m.set(cc,D());s.m.get(cc)[lt]=true});uiAll()}async function tog(id,lt,card,next){const cc=code(id),k=String(lt||'').toLowerCase();if(!cc||!['favorites','visited','bucketlist'].includes(k))return{ok:false,saved:false};if(!s.u?.id){toast('Please sign in','inf');return{ok:false,saved:false}}const x=await cli();if(!x){toast('List service unavailable','err');return{ok:false,saved:false}}const st=s.m.get(cc)||D(),prev=!!st[k],nxt=typeof next==='boolean'?next:!prev,op=`${cc}:${k}`;if(s.busy.has(op))return{ok:false,saved:prev};s.busy.add(op);st[k]=nxt;s.m.set(cc,st);ui(card);try{if(nxt){const{error}=await x.from('travel_list_items').insert({user_id:s.u.id,country_code:cc,list_type:k});if(error&&error.code!=='23505')throw error;toast('Saved to list','ok')}else{const{error}=await x.from('travel_list_items').delete().eq('user_id',s.u.id).eq('country_code',cc).eq('list_type',k);if(error)throw error;toast('Removed','inf')}return{ok:true,saved:nxt}}catch(_){st[k]=prev;s.m.set(cc,st);ui(card);toast('Could not update list','err');return{ok:false,saved:prev}}finally{s.busy.delete(op)}}function wire(){let t=null;document.getElementById('q')?.addEventListener('input',ev=>{clearTimeout(t);t=setTimeout(()=>{s.q=String(ev.target.value||'').trim();s.p=1;render()},200)});document.getElementById('region')?.addEventListener('change',ev=>{s.r=String(ev.target.value||'').trim();s.p=1;render()});document.getElementById('sort')?.addEventListener('change',ev=>{s.o=String(ev.target.value||'pop');s.p=1;render()});document.getElementById('refresh')?.addEventListener('click',async e=>{e.target.disabled=true;const ok=await load(true);e.target.disabled=false;if(!ok){toast('Refresh failed','err');return}s.p=1;render();toast('Refreshed','ok')});document.getElementById('prev')?.addEventListener('click',()=>{if(s.p>1){s.p-=1;render()}});document.getElementById('next')?.addEventListener('click',()=>{if(s.more){s.p+=1;render()}})}function bridge(){if(!window.initIndexStyleListMenu)return;window.initIndexStyleListMenu({mediaType:'travel',itemIdAttr:'data-country-code',getVisibleItemIds:()=>Array.from(document.querySelectorAll('.card[data-country-code]')).map(c=>c.getAttribute('data-country-code')).filter(Boolean),getQuickStatusForItem:id=>{const st=s.m.get(code(id));return st?{...st}:null},ensureClient:async()=>await cli(),getCurrentUser:()=>s.u,notify:(m,e)=>toast(m,e?'err':'ok'),toggleDefaultList:async({itemId,listType,card,nextSaved})=>await tog(itemId,listType,card,nextSaved)})}async function init(){await cli();wire();const params=new URLSearchParams(location.search),q=String(params.get('search')||'').trim();if(q){s.q=q;const inp=document.getElementById('q');if(inp)inp.value=q}const ok=await load();if(!ok){const em=document.getElementById('empty');em.style.display='block';em.textContent='Could not load countries right now.'}render();bridge();await auth()}document.addEventListener('DOMContentLoaded',()=>{void init()})})();\n+  </script>\n+  <script src=\"js/production-runtime.js?v=20260227d\" defer></script>\n+</body>\n+</html>\n*** End Patch
