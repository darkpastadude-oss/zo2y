<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zo2y â€” Movies</title>
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --accent: #f59e0b;
      --text: #ffffff;
      --muted: #9fb0cf;
      --border: rgba(255,255,255,0.08);
      --white: #ffffff;
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11, 22, 51, 0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 18px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .hero {
      max-width: 1200px;
      margin: 24px auto 0;
      padding: 0 20px;
    }

    .hero h1 {
      font-size: 28px;
      margin: 0 0 8px 0;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
    }

    .controls {
      max-width: 1200px;
      margin: 16px auto 0;
      padding: 0 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1 1 280px;
      min-width: 220px;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--text);
      outline: none;
    }

    .filter-select {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--text);
      outline: none;
      min-width: 200px;
    }

    .small-input {
      max-width: 140px;
    }

    .chip-row {
      max-width: 1200px;
      margin: 10px auto 0;
      padding: 0 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    .chip.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    .grid {
      max-width: 1200px;
      margin: 24px auto 60px;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      transition: all 0.2s ease;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .card img {
      width: 100%;
      height: 260px;
      object-fit: cover;
      background: #0f1f40;
    }

    .card-body {
      padding: 12px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
    }

    .card-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .card-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 60px;
    }

    .empty {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      color: var(--muted);
      text-align: center;
    }

    .pagination {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .page-btn {
      min-width: 44px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      color: var(--muted);
      font-size: 13px;
    }

    @media (max-width: 600px) {
      .header-inner { padding: 12px 16px; }
      .hero h1 { font-size: 22px; }
      .grid { gap: 12px; }
      .card img { height: 220px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-title"><i class="fas fa-film"></i> Movies</div>
      <div class="header-actions">
        <a class="btn" href="index.html"><i class="fas fa-home"></i> Home</a>
        <a class="btn" href="restraunts.html"><i class="fas fa-utensils"></i> Restaurants</a>
        <a class="btn" href="profile.html"><i class="fas fa-user"></i> Profile</a>
      </div>
    </div>
  </header>

  <section class="hero">
    <h1>Popular Movies</h1>
    <p>Egyptian-focused content sourced from TMDB and cached in Supabase.</p>
  </section>

  <div class="controls">
    <input id="searchInput" class="search-input" type="text" placeholder="Search movies..." />
    <select id="genreSelect" class="filter-select">
      <option value="">All Genres</option>
    </select>
    <input id="yearInput" class="search-input small-input" type="number" min="1900" max="2100" placeholder="Year" />
    <input id="actorInput" class="search-input" type="text" placeholder="Actor (e.g., Ahmed Helmy)" />
    <button class="btn" id="refreshBtn"><i class="fas fa-rotate"></i> Refresh</button>
  </div>
  <div id="activeFilters" class="chip-row"></div>

  <div id="moviesGrid" class="grid"></div>
  <div id="emptyState" class="empty" style="display:none;">No movies found.</div>
  <div class="pagination">
    <button class="page-btn" id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i></button>
    <div class="page-info" id="pageInfo">Page 1</div>
    <button class="page-btn" id="nextPageBtn" disabled><i class="fas fa-chevron-right"></i></button>
  </div>

  <script>
    (function () {
      const TMDB_API_KEY = '875c0397b1de1c57648fdb62bdd96b49';
      const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4NzVjMDM5N2IxZGUxYzU3NjQ4ZmRiNjJiZGQ5NmI0OSIsIm5iZiI6MTc3MDU4Mzk1NC42NTc5OTk4LCJzdWIiOiI2OTg4Zjc5MmFlYTFkN2NjNjcyY2VlNDciLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1RMWLft0Yl73gfhkCXtnqBIzRQHdaoLfZFYXYN7jm7s';
      const TMDB_BASE = 'https://api.themoviedb.org/3';
      const POSTER_BASE = 'https://image.tmdb.org/t/p/w500';
      const state = {
        genres: [],
        activeGenre: '',
        query: '',
        actor: '',
        year: '',
        page: 1,
        totalPages: 1
      };

      async function tmdbFetch(path, params = {}) {
        const url = new URL(TMDB_BASE + path);
        Object.entries(params).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
        });
        const res = await fetch(url.toString(), {
          headers: {
            Authorization: `Bearer ${TMDB_TOKEN}`,
            'Content-Type': 'application/json'
          }
        });
        if (!res.ok) throw new Error(`TMDB error ${res.status}`);
        return res.json();
      }

      function renderFilters() {
        const row = document.getElementById('activeFilters');
        if (!row) return;
        row.innerHTML = '';
        const items = [];
        if (state.activeGenre) items.push({ label: state.activeGenre, type: 'genre' });
        if (state.query) items.push({ label: state.query, type: 'query' });
        if (state.year) items.push({ label: state.year, type: 'year' });
        if (state.actor) items.push({ label: state.actor, type: 'actor' });
        items.forEach(item => {
          const chip = document.createElement('div');
          chip.className = 'chip active';
          chip.textContent = item.label;
          chip.onclick = () => {
            if (item.type === 'genre') state.activeGenre = '';
            if (item.type === 'query') state.query = '';
            if (item.type === 'year') state.year = '';
            if (item.type === 'actor') state.actor = '';
            document.getElementById('searchInput').value = state.query;
            document.getElementById('genreSelect').value = state.activeGenre;
            document.getElementById('yearInput').value = state.year;
            document.getElementById('actorInput').value = state.actor;
            renderFilters();
            state.page = 1;
            loadMovies();
          };
          row.appendChild(chip);
        });
      }

      async function loadGenres() {
        const data = await tmdbFetch('/genre/movie/list', { language: 'en' });
        state.genres = data.genres || [];
        const select = document.getElementById('genreSelect');
        if (!select) return;
        state.genres.forEach(g => {
          const opt = document.createElement('option');
          opt.value = String(g.id);
          opt.textContent = g.name;
          select.appendChild(opt);
        });
      }

      async function resolveActorId() {
        if (!state.actor) return null;
        const res = await tmdbFetch('/search/person', {
          query: state.actor,
          language: 'en',
          page: 1
        });
        const person = (res.results || [])[0];
        return person ? person.id : null;
      }

      async function loadMovies() {
        const grid = document.getElementById('moviesGrid');
        const empty = document.getElementById('emptyState');
        if (!grid) return;

        let data;
        try {
          const actorId = await resolveActorId();
          if (state.query || state.year || state.activeGenre || actorId) {
            data = await tmdbFetch('/discover/movie', {
              language: 'en',
              page: state.page,
              with_genres: state.activeGenre,
              primary_release_year: state.year,
              with_cast: actorId || undefined,
              sort_by: 'popularity.desc'
            });
            if (state.query) {
              // If user typed a query, use search/movie and intersect results
              const searchData = await tmdbFetch('/search/movie', {
                query: state.query,
                language: 'en',
                include_adult: false,
                page: state.page
              });
              data = searchData;
            }
          } else {
            data = await tmdbFetch('/movie/popular', {
              language: 'en',
              page: state.page
            });
          }
        } catch (e) {
          if (empty) empty.style.display = 'block';
          return;
        }

        let results = data.results || [];
        if (state.activeGenre) {
          const genreId = parseInt(state.activeGenre, 10);
          results = results.filter(m => Array.isArray(m.genre_ids) && m.genre_ids.includes(genreId));
        }

        if (!results.length) {
          if (empty) empty.style.display = 'block';
          grid.innerHTML = '';
          return;
        }

        const fragment = document.createDocumentFragment();
        results.forEach(item => {
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <img src="${item.poster_path ? POSTER_BASE + item.poster_path : 'images/placeholder.jpg'}" alt="${item.title}">
            <div class="card-body">
              <h3 class="card-title">${item.title}</h3>
              <div class="card-meta">${item.release_date || ''}</div>
              <div class="card-desc">${item.overview || 'No description available.'}</div>
            </div>
          `;
          card.onclick = () => {
            window.location.href = `movie.html?id=${item.id}`;
          };
          fragment.appendChild(card);
        });
        grid.innerHTML = '';
        grid.appendChild(fragment);
        if (empty) empty.style.display = 'none';

        state.totalPages = Math.min(data.total_pages || 1, 500);
        updatePagination();
      }

      function wireUI() {
        const searchInput = document.getElementById('searchInput');
        const genreSelect = document.getElementById('genreSelect');
        const yearInput = document.getElementById('yearInput');
        const actorInput = document.getElementById('actorInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            state.query = e.target.value.trim();
            renderFilters();
            state.page = 1;
            loadMovies();
          });
        }
        if (genreSelect) {
          genreSelect.addEventListener('change', (e) => {
            state.activeGenre = e.target.value;
            renderFilters();
            state.page = 1;
            loadMovies();
          });
        }
        if (yearInput) {
          yearInput.addEventListener('input', (e) => {
            state.year = e.target.value.trim();
            renderFilters();
            state.page = 1;
            loadMovies();
          });
        }
        if (actorInput) {
          actorInput.addEventListener('change', (e) => {
            state.actor = e.target.value.trim();
            renderFilters();
            state.page = 1;
            loadMovies();
          });
        }
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => loadMovies());
        }
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (state.page > 1) {
              state.page -= 1;
              loadMovies();
            }
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            if (state.page < state.totalPages) {
              state.page += 1;
              loadMovies();
            }
          });
        }
      }

      function updatePagination() {
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const info = document.getElementById('pageInfo');
        if (prevBtn) prevBtn.disabled = state.page <= 1;
        if (nextBtn) nextBtn.disabled = state.page >= state.totalPages;
        if (info) info.textContent = `Page ${state.page} of ${state.totalPages}`;
      }

      (async function init() {
        await loadGenres();
        wireUI();
        renderFilters();
        loadMovies();
      })();
    })();
  </script>
</body>
</html>
