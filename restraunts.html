<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zo2y ‚Äî All Restaurants</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ... (CSS styles remain exactly the same as before) ... */
  </style>
  
  <link rel="icon" type="image/png" href="images/logo.png">
</head>
<body>
  <!-- HTML structure remains exactly the same as before -->
  <!-- ... (All HTML remains the same) ... -->

  <script>
    (function() {
      'use strict';
      
      // ---------- CONFIG ----------
      const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
      
      // Initialize Supabase
      let supabase;
      try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch (error) {
          console.error('‚ùå Failed to initialize Supabase:', error);
          showNotification('Connection error. Please refresh.', 'error');
          supabase = null;
      }
      
      // ---------- GLOBAL STATE ----------
      const state = {
        restaurants: [],
        filteredRestaurants: [],
        categories: new Map(),
        currentPage: 1,
        pageSize: 20,
        isLoading: false,
        activeFilters: {
          search: '',
          category: 'all',
          quickFilter: 'all',
          sort: 'rating-desc'
        },
        restaurantImages: new Map(),
        currentModalRestaurant: null,
        currentUser: null,
        isLoggedIn: false,
        authChecked: false,
        imageQueue: [],
        imagesLoading: 0,
        maxConcurrentLoads: 6,
        customLists: [],
        selectedLists: new Set()
      };
      
      // ---------- CUSTOM LISTS MANAGER ----------
      const customListsManager = {
        async init() {
          if (state.currentUser) {
            await this.loadCustomLists();
          }
        },
        
        async loadCustomLists() {
          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return;
            
            console.log('Loading custom lists for user:', user.id);
            
            // Get all custom lists (excluding default lists)
            const { data: lists, error } = await supabase
              .from('lists')
              .select('*')
              .eq('user_id', user.id)
              .neq('title', 'Favorites')
              .neq('title', 'Visited')
              .neq('title', 'Want to Go')
              .order('created_at', { ascending: false });
            
            if (error) {
              console.error('Error loading custom lists:', error);
              throw error;
            }
            
            console.log('Loaded custom lists:', lists);
            state.customLists = lists || [];
            
          } catch (error) {
            console.error('Error loading custom lists:', error);
            state.customLists = [];
          }
        },
        
        async createList(name) {
          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) return null;
            
            const { data: newList, error } = await supabase
              .from('lists')
              .insert([
                {
                  user_id: user.id,
                  title: name,
                  description: 'Custom list for restaurants',
                  created_at: new Date().toISOString()
                }
              ])
              .select()
              .single();
            
            if (error) throw error;
            
            state.customLists.unshift(newList);
            return newList;
            
          } catch (error) {
            console.error('Error creating list:', error);
            showNotification('Error creating list', 'error');
            return null;
          }
        },
        
        async checkRestaurantInList(restaurantId, listId) {
          try {
            const { data, error } = await supabase
              .from('lists_restraunts')
              .select('*')
              .eq('list_id', listId)
              .eq('restraunt_id', restaurantId)
              .single();
            
            if (error && error.code !== 'PGRST116') throw error;
            
            return !!data;
            
          } catch (error) {
            console.error('Error checking restaurant in list:', error);
            return false;
          }
        },
        
        async toggleRestaurantInList(restaurantId, listId) {
          try {
            const isInList = await this.checkRestaurantInList(restaurantId, listId);
            
            if (isInList) {
              // Remove from list
              const { error } = await supabase
                .from('lists_restraunts')
                .delete()
                .eq('list_id', listId)
                .eq('restraunt_id', restaurantId);
              
              if (error) throw error;
              
              return false;
            } else {
              // Add to list
              const { error } = await supabase
                .from('lists_restraunts')
                .insert([
                  {
                    list_id: listId,
                    restraunt_id: restaurantId,
                    added_at: new Date().toISOString()
                  }
                ]);
              
              if (error) throw error;
              
              return true;
            }
            
          } catch (error) {
            console.error('Error toggling restaurant in list:', error);
            showNotification('Error updating list', 'error');
            return null;
          }
        },
        
        async loadRestaurantListsStatus(restaurantId) {
          if (!state.currentUser || !restaurantId) return {};
          
          const status = {};
          
          console.log('Checking restaurant status in', state.customLists.length, 'custom lists');
          
          for (const list of state.customLists) {
            status[list.id] = await this.checkRestaurantInList(restaurantId, list.id);
          }
          
          console.log('Restaurant list status:', status);
          return status;
        },
        
        renderListsList(restaurantId) {
          const container = document.getElementById('listsListContainer');
          if (!container) return;
          
          console.log('Rendering lists list for restaurant:', restaurantId);
          console.log('Available custom lists:', state.customLists);
          
          if (state.customLists.length === 0) {
            container.innerHTML = `
              <div class="empty-lists">
                <i class="fas fa-list"></i>
                <h4>No custom lists yet</h4>
                <p>Create your first list to organize restaurants</p>
              </div>
            `;
            return;
          }
          
          let html = '<div class="lists-list">';
          
          state.customLists.forEach(list => {
            const isChecked = state.selectedLists.has(list.id);
            const listIcon = list.icon || 'üìã';
            html += `
              <div class="list-item ${isChecked ? 'active' : ''}" data-list-id="${list.id}">
                <div class="list-info">
                  <div class="list-icon">
                    ${listIcon}
                  </div>
                  <div>
                    <span class="list-name">${list.title}</span>
                    ${list.description ? `<div class="text-xs text-muted mt-1">${list.description}</div>` : ''}
                  </div>
                </div>
                <div class="list-checkbox ${isChecked ? 'checked' : ''}"></div>
              </div>
            `;
          });
          
          html += '</div>';
          container.innerHTML = html;
          
          // Add event listeners
          container.querySelectorAll('.list-item').forEach(item => {
            item.addEventListener('click', (e) => {
              e.stopPropagation();
              const listId = item.dataset.listId;
              const checkbox = item.querySelector('.list-checkbox');
              
              if (state.selectedLists.has(listId)) {
                state.selectedLists.delete(listId);
                item.classList.remove('active');
                checkbox.classList.remove('checked');
              } else {
                state.selectedLists.add(listId);
                item.classList.add('active');
                checkbox.classList.add('checked');
                
                // Add animation
                checkbox.style.animation = 'none';
                setTimeout(() => {
                  checkbox.style.animation = 'checkPop 0.3s ease';
                }, 10);
              }
            });
          });
        },
        
        // NEW: Refresh lists from database
        async refreshLists() {
          await this.loadCustomLists();
        }
      };
      
      // ---------- FAST IMAGE LOADING SYSTEM ----------
      function initFastImageLoader() {
        state.imageQueue = [];
        state.imagesLoading = 0;
        
        const preloader = {
          queue: [],
          loading: 0,
          maxConcurrent: 6,
          
          addImage(url) {
            if (!url) return;
            this.queue.push(url);
            this.processQueue();
          },
          
          processQueue() {
            while (this.loading < this.maxConcurrent && this.queue.length > 0) {
              const url = this.queue.shift();
              this.loadImage(url);
            }
          },
          
          loadImage(url) {
            this.loading++;
            const img = new Image();
            img.onload = img.onerror = () => {
              this.loading--;
              this.processQueue();
            };
            img.src = url;
          }
        };
        
        state.preloader = preloader;
      }
      
      function loadImage(imgElement, url) {
        if (!url || url === '') {
          return;
        }
        
        imgElement.src = url;
        imgElement.onload = () => {
          imgElement.style.opacity = '0';
          setTimeout(() => {
            imgElement.style.transition = 'opacity 0.3s ease';
            imgElement.style.opacity = '1';
          }, 10);
        };
        
        imgElement.onerror = () => {
          imgElement.style.display = 'none';
        };
      }
      
      // ---------- LIST MANAGER ----------
      const listManager = {
          userLists: [],
          currentLists: {
              favorites: null,
              visited: null,
              wantToGo: null
          },
          
          async init() { 
              const { data: { session } } = await supabase.auth.getSession();
              if (!session) return;
              
              await this.loadUserLists();
              await customListsManager.init();
          },
          
          async loadUserLists() {
              try {
                  const { data: { user } } = await supabase.auth.getUser();
                  if (!user) return;

                  const { data: lists, error } = await supabase
                      .from('lists')
                      .select('*')
                      .eq('user_id', user.id);
                  
                  if (error) throw error;
                  
                  this.userLists = lists || [];
                  await this.setupDefaultLists();
                  await this.loadListRestaurants();
                  
              } catch (error) {
                  console.error('Error loading lists:', error);
              }
          },
          
          async setupDefaultLists() {
              const { data: { user } } = await supabase.auth.getUser();
              
              this.currentLists.favorites = this.userLists.find(list => list.title === 'Favorites');
              this.currentLists.visited = this.userLists.find(list => list.title === 'Visited'); 
              this.currentLists.wantToGo = this.userLists.find(list => list.title === 'Want to Go');
              
              if (!this.currentLists.favorites) {
                  this.currentLists.favorites = await this.createList('Favorites', 'My favorite restaurants');
              }
              if (!this.currentLists.visited) {
                  this.currentLists.visited = await this.createList('Visited', 'Restaurants I have visited');
              }
              if (!this.currentLists.wantToGo) {
                  this.currentLists.wantToGo = await this.createList('Want to Go', 'Restaurants I want to try');
              }
          },
          
          async createList(title, description) {
              const { data: { user } } = await supabase.auth.getUser();
              
              const { data: newList, error } = await supabase
                  .from('lists')
                  .insert([
                      {
                          user_id: user.id,
                          title: title,
                          description: description
                      }
                  ])
                  .select()
                  .single();
              
              if (error) {
                  console.error('Error creating list:', error);
                  return null;
              }
              
              this.userLists.push(newList);
              return newList;
          },
          
          async loadListRestaurants() {
              for (const listType in this.currentLists) {
                  const list = this.currentLists[listType];
                  if (list) {
                      const { data: listRestaurants, error } = await supabase
                          .from('lists_restraunts')
                          .select('restraunt_id')
                          .eq('list_id', list.id);
                      
                      if (!error && listRestaurants) {
                          list.restaurants = listRestaurants.map(item => item.restraunt_id);
                      } else {
                          list.restaurants = [];
                      }
                  }
              }
          },
          
          async toggleInList(listType, restaurantId) {
              const list = this.currentLists[listType];
              if (!list) return false;
              
              const isInList = list.restaurants?.includes(restaurantId);
              
              try {
                  if (isInList) {
                      const { error } = await supabase
                          .from('lists_restraunts')
                          .delete()
                          .match({
                              list_id: list.id,
                              restraunt_id: restaurantId
                          });
                      
                      if (error) throw error;
                      
                      list.restaurants = list.restaurants.filter(id => id !== restaurantId);
                      showNotification(`Removed from ${list.title}`, 'info');
                      return false;
                      
                  } else {
                      const { error } = await supabase
                          .from('lists_restraunts')
                          .insert([
                              {
                                  list_id: list.id,
                                  restraunt_id: restaurantId,
                                  added_at: new Date().toISOString()
                              }
                          ]);
                      
                      if (error) throw error;
                      
                      if (!list.restaurants) list.restaurants = [];
                      list.restaurants.push(restaurantId);
                      showNotification(`Added to ${list.title}`, 'success');
                      return true;
                  }
                  
              } catch (error) {
                  console.error('Error updating list:', error);
                  showNotification('Failed to update list', 'error');
                  return isInList;
              }
          },
          
          isInList(listType, restaurantId) {
              const list = this.currentLists[listType];
              return list?.restaurants?.includes(restaurantId) || false;
          },
          
          getRestaurantListStatus(restaurantId) {
              return {
                  favorites: this.isInList('favorites', restaurantId),
                  wantToGo: this.isInList('wantToGo', restaurantId),
                  visited: this.isInList('visited', restaurantId)
              };
          }
      };
      
      // ---------- NOTIFICATION SYSTEM ----------
      function showNotification(message, type = "info", duration = 2500) {
        const container = document.getElementById("notificationContainer");
        if (!container) return;
        
        const notification = document.createElement("div");
        notification.className = `custom-notification notification-${type}`;
        
        let iconClass;
        if (type === "success") {
            iconClass = "fas fa-check-circle";
        } else if (type === "error") {
            iconClass = "fas fa-exclamation-circle";
        } else if (type === "warning") {
            iconClass = "fas fa-exclamation-triangle";
        } else {
            iconClass = "fas fa-info-circle";
        }
        
        notification.innerHTML = `
            <i class="notification-icon ${iconClass}"></i>
            <span class="notification-message">${message}</span>
            <button class="notification-close" aria-label="Close notification">√ó</button>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add("notification-show");
        }, 10);
        
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.classList.remove("notification-show");
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        });
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.classList.remove("notification-show");
                setTimeout(() => notification.remove(), 400);
            }
        }, duration);
      }
      
      // ---------- CUSTOM LISTS MODAL ----------
      async function showCustomListsModal(restaurantId) {
        if (!restaurantId) {
          showNotification('No restaurant selected', 'error');
          return;
        }
        
        if (!state.isLoggedIn) {
            showAuthPrompt();
            return;
        }
        
        // Find the restaurant in the state
        const restaurant = state.restaurants.find(r => r.id === restaurantId);
        if (!restaurant) {
          showNotification('Restaurant not found', 'error');
          return;
        }
        
        state.currentModalRestaurant = restaurant;
        
        console.log('Showing custom lists modal for restaurant:', restaurantId);
        
        // First, refresh lists from database to ensure we have latest
        await customListsManager.refreshLists();
        
        // Load current list status for this restaurant
        try {
          const status = await customListsManager.loadRestaurantListsStatus(restaurantId);
          
          state.selectedLists.clear();
          for (const [listId, isChecked] of Object.entries(status)) {
            if (isChecked) {
              state.selectedLists.add(parseInt(listId));
            }
          }
          
          console.log('Selected lists after loading status:', Array.from(state.selectedLists));
          
          // Render lists list
          customListsManager.renderListsList(restaurantId);
          
          // Show modal
          const modal = document.getElementById('customListsModal');
          modal.classList.add('active');
          document.body.style.overflow = 'hidden';
          
        } catch (error) {
          console.error('Error loading list status:', error);
          showNotification('Error loading lists', 'error');
        }
      }
      
      function hideCustomListsModal() {
        const modal = document.getElementById('customListsModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
        state.selectedLists.clear();
      }
      
      async function saveListChanges() {
        if (!state.currentModalRestaurant || !state.currentModalRestaurant.id) {
          showNotification('No restaurant selected', 'error');
          hideCustomListsModal();
          return;
        }
        
        const restaurantId = state.currentModalRestaurant.id;
        const saveBtn = document.getElementById('saveListsBtn');
        const originalText = saveBtn.textContent;
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
        
        try {
          let changesMade = false;
          
          // Process each list
          for (const list of state.customLists) {
            const shouldBeInList = state.selectedLists.has(list.id);
            const isInList = await customListsManager.checkRestaurantInList(
              restaurantId, 
              list.id
            );
            
            if (shouldBeInList && !isInList) {
              // Add to list
              const success = await customListsManager.toggleRestaurantInList(
                restaurantId, 
                list.id
              );
              if (success) {
                showNotification(`Added to "${list.title}" list`, 'success');
                changesMade = true;
              }
            } else if (!shouldBeInList && isInList) {
              // Remove from list
              const success = await customListsManager.toggleRestaurantInList(
                restaurantId, 
                list.id
              );
              if (success !== null) {
                showNotification(`Removed from "${list.title}" list`, 'info');
                changesMade = true;
              }
            }
          }
          
          if (changesMade) {
            showNotification('List changes saved successfully!', 'success');
          } else {
            showNotification('No changes made', 'info');
          }
          
          hideCustomListsModal();
          
          // Refresh restaurant display
          if (state.filteredRestaurants.length > 0) {
            renderRestaurants();
          }
          
        } catch (error) {
          console.error('Error saving list changes:', error);
          showNotification('Error saving changes', 'error');
        } finally {
          saveBtn.disabled = false;
          saveBtn.textContent = originalText;
        }
      }
      
      // ---------- AUTH PROMPT MODAL ----------
      function showAuthPrompt() {
        const modal = document.getElementById('authPromptModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function hideAuthPrompt() {
        const modal = document.getElementById('authPromptModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
      
      // ---------- ACTIONS MODAL ----------
      function showModal(restaurantData) {
        if (!restaurantData) return;
        
        if (!state.isLoggedIn) {
            showAuthPrompt();
            return;
        }
        
        state.currentModalRestaurant = restaurantData;
        document.getElementById('modalRestaurantName').textContent = restaurantData.name;
        
        updateModalButtons(restaurantData.id);
        
        const modal = document.getElementById('actionsModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      
      function hideModal() {
        const modal = document.getElementById('actionsModal');
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      }
      
      function updateModalButtons(restaurantId) {
        const status = listManager.getRestaurantListStatus(restaurantId);
        
        const favoritesBtn = document.getElementById('modalFavoritesBtn');
        const wantToGoBtn = document.getElementById('modalWantToGoBtn');
        const visitedBtn = document.getElementById('modalVisitedBtn');
        
        if (favoritesBtn) {
          favoritesBtn.innerHTML = `<i class="fas fa-heart"></i><span>${status.favorites ? 'Remove from Favorites' : 'Add to Favorites'}</span>`;
          favoritesBtn.classList.toggle('active', status.favorites);
        }
        
        if (wantToGoBtn) {
          wantToGoBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${status.wantToGo ? 'Remove from Want to Go' : 'Add to Want to Go'}</span>`;
          wantToGoBtn.classList.toggle('active', status.wantToGo);
        }
        
        if (visitedBtn) {
          visitedBtn.innerHTML = `<i class="fas fa-utensils"></i><span>${status.visited ? 'Remove from Visited' : 'Mark as Visited'}</span>`;
          visitedBtn.classList.toggle('active', status.visited);
        }
      }
      
      // ---------- GUEST BANNER ----------
      const guestBanner = {
        init: function() {
          const loginBtn = document.getElementById('bannerLoginBtn');
          const signupBtn = document.getElementById('bannerSignupBtn');
          
          if (loginBtn) {
            loginBtn.addEventListener('click', () => {
              window.location.href = 'login.html';
            });
          }
          
          if (signupBtn) {
            signupBtn.addEventListener('click', () => {
              window.location.href = 'sign-up.html';
            });
          }
        },
        
        show: function() {
          const banner = document.getElementById('guestBanner');
          if (banner) {
            banner.classList.add('show');
          }
        },
        
        hide: function() {
          const banner = document.getElementById('guestBanner');
          if (banner) {
            banner.classList.remove('show');
          }
        }
      };
      
      // ---------- DATA LOADING ----------
      async function loadRestaurantImages() {
        try {
          const { data: galleryData, error: galleryError } = await supabase
            .from('restaurant_gallery')
            .select('restaurant_slug, image_url, image_type, is_primary')
            .order('sort_order');
          
          if (galleryError) throw galleryError;
          
          const { data: restaurantsData, error: restaurantsError } = await supabase
            .from('restraunts')
            .select('slug, image, logo_url');
          
          if (restaurantsError) throw restaurantsError;
          
          state.restaurantImages.clear();
          
          if (galleryData && galleryData.length > 0) {
            galleryData.forEach(item => {
              if (!state.restaurantImages.has(item.restaurant_slug)) {
                state.restaurantImages.set(item.restaurant_slug, {
                  cover: null,
                  logo: null
                });
              }
              
              const images = state.restaurantImages.get(item.restaurant_slug);
              
              if (item.image_type === 'cover' && item.image_url) {
                images.cover = item.image_url;
              }
              
              if (item.image_type === 'logo' && item.image_url) {
                images.logo = item.image_url;
              }
            });
          }
          
          if (restaurantsData && restaurantsData.length > 0) {
            restaurantsData.forEach(restaurant => {
              if (!state.restaurantImages.has(restaurant.slug)) {
                state.restaurantImages.set(restaurant.slug, {
                  cover: restaurant.image || null,
                  logo: restaurant.logo_url || null
                });
              } else {
                const images = state.restaurantImages.get(restaurant.slug);
                if (!images.cover && restaurant.image) {
                  images.cover = restaurant.image;
                }
                if (!images.logo && restaurant.logo_url) {
                  images.logo = restaurant.logo_url;
                }
              }
            });
          }
          
        } catch (error) {
          console.error('Error loading images:', error);
        }
      }
      
      function getCoverImageUrl(restaurantSlug) {
        const images = state.restaurantImages.get(restaurantSlug);
        return images?.cover || null;
      }
      
      function getLogoUrl(restaurant) {
        const images = state.restaurantImages.get(restaurant.slug);
        if (images?.logo) {
          return images.logo;
        }
        
        if (restaurant.logo_url) {
          return restaurant.logo_url;
        }
        
        if (restaurant.image) {
          return restaurant.image;
        }
        
        return null;
      }
      
      async function loadCategories() {
        try {
          const { data, error } = await supabase
            .from('categories')
            .select('*')
            .order('sort_order', { ascending: true });
          
          if (error) {
            console.warn('No categories table found, using fallback categories');
            createFallbackCategories();
            return;
          }
          
          state.categories.clear();
          
          if (data && data.length > 0) {
            data.forEach(cat => {
              state.categories.set(cat.id, {
                id: cat.id,
                name: cat.name,
                slug: cat.slug,
                icon: cat.icon,
                description: cat.description,
                sort_order: cat.sort_order || 0
              });
            });
          } else {
            createFallbackCategories();
          }
          
        } catch (error) {
          console.error('Error loading categories:', error);
          createFallbackCategories();
        }
      }
      
      function createFallbackCategories() {
        state.categories.clear();
        const fallbackCategories = [
          { id: 1, name: 'Burgers', slug: 'burgers', icon: 'üçî', sort_order: 1 },
          { id: 2, name: 'Chicken', slug: 'chicken', icon: 'üçó', sort_order: 2 },
          { id: 3, name: 'Middle Eastern', slug: 'middle-eastern', icon: 'ü•ô', sort_order: 3 },
          { id: 4, name: 'Pizza', slug: 'pizza', icon: 'üçï', sort_order: 4 },
          { id: 5, name: 'Asian', slug: 'asian', icon: 'üçú', sort_order: 5 },
          { id: 6, name: 'Mexican', slug: 'mexican', icon: 'üåÆ', sort_order: 6 },
          { id: 7, name: 'Cafe & Bakery', slug: 'cafe-bakery', icon: '‚òï', sort_order: 7 },
          { id: 8, name: 'Fast Food', slug: 'fast-food', icon: 'üçü', sort_order: 8 },
          { id: 9, name: 'Seafood', slug: 'seafood', icon: 'üêü', sort_order: 9 },
          { id: 10, name: 'International', slug: 'international', icon: 'üåç', sort_order: 10 }
        ];
        
        fallbackCategories.forEach(cat => {
          state.categories.set(cat.id, cat);
        });
      }
      
      async function loadRestaurantsData() {
        try {
          await loadRestaurantImages();
          
          // First, try to load with categories join
          const { data, error } = await supabase
            .from('restraunts')
            .select(`
              id, 
              slug, 
              name, 
              category,
              category_id,
              description, 
              rating, 
              logo_url, 
              image,
              categories!inner (
                name,
                icon,
                slug
              )
            `)
            .order('rating', { ascending: false });
          
          if (error) {
            console.warn('Could not load with categories join, loading basic data');
            await loadBasicRestaurantData();
            return;
          }
          
          if (!data || data.length === 0) {
            showEmptyState();
            return;
          }
          
          // Process restaurants with categories
          state.restaurants = data.map(restaurant => ({
            id: restaurant.id,
            slug: restaurant.slug,
            name: restaurant.name,
            category: restaurant.categories ? restaurant.categories.name : restaurant.category || 'Restaurant',
            category_id: restaurant.category_id,
            category_icon: restaurant.categories ? restaurant.categories.icon : getCategoryIconFallback(restaurant.category),
            description: restaurant.description,
            rating: restaurant.rating,
            logo_url: getLogoUrl(restaurant),
            coverImage: getCoverImageUrl(restaurant.slug)
          }));
          
          await loadCategories();
          populateCategoryDropdown();
          
          applyFilters();
          updateCounts();
          
          setTimeout(() => preloadVisibleImages(), 100);
          
        } catch (error) {
          console.error('Error loading restaurants:', error);
          showNotification('Failed to load restaurants', 'error');
          showEmptyState();
        }
      }
      
      async function loadBasicRestaurantData() {
        const { data, error } = await supabase
          .from('restraunts')
          .select('id, slug, name, category, description, rating, logo_url, image')
          .order('rating', { ascending: false });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          showEmptyState();
          return;
        }
        
        // Normalize categories from restaurant data
        const categoryMap = new Map();
        data.forEach((restaurant, index) => {
          let categoryName = restaurant.category || 'Restaurant';
          categoryName = normalizeCategoryName(categoryName);
          
          if (!categoryMap.has(categoryName)) {
            categoryMap.set(categoryName, {
              id: categoryMap.size + 1,
              name: categoryName,
              icon: getCategoryIconFallback(categoryName),
              sort_order: categoryMap.size + 1
            });
          }
        });
        
        // Add categories to state
        categoryMap.forEach((cat, name) => {
          state.categories.set(cat.id, cat);
        });
        
        // Process restaurants
        state.restaurants = data.map(restaurant => {
          const categoryName = normalizeCategoryName(restaurant.category || 'Restaurant');
          const category = Array.from(state.categories.values()).find(c => c.name === categoryName);
          
          return {
            id: restaurant.id,
            slug: restaurant.slug,
            name: restaurant.name,
            category: categoryName,
            category_id: category ? category.id : 1,
            category_icon: category ? category.icon : getCategoryIconFallback(categoryName),
            description: restaurant.description,
            rating: restaurant.rating,
            logo_url: getLogoUrl(restaurant),
            coverImage: getCoverImageUrl(restaurant.slug)
          };
        });
        
        populateCategoryDropdown();
        applyFilters();
        updateCounts();
        
        setTimeout(() => preloadVisibleImages(), 100);
      }
      
      function normalizeCategoryName(categoryName) {
        if (!categoryName) return 'Restaurant';
        
        const lowerName = categoryName.toLowerCase().trim();
        const corrections = {
          'burgers': 'Burgers',
          'burger': 'Burgers',
          'chicken': 'Chicken',
          'middle eastern': 'Middle Eastern',
          'pizza': 'Pizza',
          'asian': 'Asian',
          'mexican': 'Mexican',
          'cafe & bakery': 'Cafe & Bakery',
          'cafe': 'Cafe & Bakery',
          'bakery': 'Cafe & Bakery',
          'fast food': 'Fast Food',
          'seafood': 'Seafood',
          'breakfast': 'Breakfast',
          'desserts': 'Desserts',
          'indian': 'Indian',
          'italian': 'Italian',
          'bbq & ribs': 'BBQ & Ribs',
          'bbq': 'BBQ & Ribs',
          'international': 'International',
          'sushi': 'Asian',
          'shawerma': 'Middle Eastern'
        };
        
        return corrections[lowerName] || 
               categoryName.charAt(0).toUpperCase() + categoryName.slice(1).toLowerCase();
      }
      
      function getCategoryIconFallback(categoryName) {
        const icons = {
          'Burgers': 'üçî',
          'Chicken': 'üçó',
          'Middle Eastern': 'ü•ô',
          'Pizza': 'üçï',
          'Asian': 'üçú',
          'Mexican': 'üåÆ',
          'Cafe & Bakery': '‚òï',
          'Fast Food': 'üçü',
          'Italian': 'üçù',
          'Seafood': 'üêü',
          'Breakfast': 'ü•û',
          'Desserts': 'üç∞',
          'Indian': 'üçõ',
          'BBQ & Ribs': 'ü•©',
          'International': 'üåç'
        };
        
        return icons[categoryName] || 'üç¥';
      }
      
      function preloadVisibleImages() {
        const images = document.querySelectorAll('.restaurant-image[data-src], .logo-overlay img[data-src]');
        images.forEach(img => {
          const rect = img.getBoundingClientRect();
          if (rect.top < window.innerHeight + 200) {
            const url = img.dataset.src;
            if (url && url !== '') {
              state.preloader.addImage(url);
            }
          }
        });
      }
      
      function populateCategoryDropdown() {
        const select = document.getElementById('categorySelect');
        if (!select) return;
        
        select.innerHTML = '<option value="all">All Categories</option>';
        
        const sortedCategories = Array.from(state.categories.values())
          .sort((a, b) => {
            if (a.sort_order !== undefined && b.sort_order !== undefined) {
              return a.sort_order - b.sort_order;
            }
            return a.name.localeCompare(b.name);
          });
        
        sortedCategories.forEach(cat => {
          const option = document.createElement('option');
          option.value = cat.id;
          option.textContent = `${cat.icon || 'üç¥'} ${cat.name}`;
          select.appendChild(option);
        });
      }
      
      // ---------- FILTERING & SORTING ----------
      function applyFilters() {
        let filtered = [...state.restaurants];
        
        if (state.activeFilters.search) {
          const searchTerm = state.activeFilters.search.toLowerCase();
          filtered = filtered.filter(r => 
            r.name.toLowerCase().includes(searchTerm) ||
            (r.description && r.description.toLowerCase().includes(searchTerm)) ||
            (r.category && r.category.toLowerCase().includes(searchTerm))
          );
        }
        
        if (state.activeFilters.category !== 'all') {
          const categoryId = parseInt(state.activeFilters.category);
          filtered = filtered.filter(r => r.category_id === categoryId);
        }
        
        filtered = applyQuickFilter(filtered, state.activeFilters.quickFilter);
        filtered = sortRestaurants(filtered, state.activeFilters.sort);
        
        state.filteredRestaurants = filtered;
        state.currentPage = 1;
        
        renderRestaurants();
        updatePagination();
        updateCounts();
      }
      
      function applyQuickFilter(restaurants, filterType) {
        switch(filterType) {
          case 'trending':
            return restaurants.filter(r => (r.rating || 0) >= 4.3);
          case 'top-rated':
            return restaurants.filter(r => (r.rating || 0) >= 4.5);
          case 'new':
            return restaurants.filter(r => Math.random() > 0.7);
          default:
            return restaurants;
        }
      }
      
      function sortRestaurants(restaurants, sortType) {
        const sorted = [...restaurants];
        
        switch(sortType) {
          case 'rating-desc':
            return sorted.sort((a, b) => (b.rating || 0) - (a.rating || 0));
          case 'rating-asc':
            return sorted.sort((a, b) => (a.rating || 0) - (b.rating || 0));
          case 'name-asc':
            return sorted.sort((a, b) => a.name.localeCompare(b.name));
          case 'name-desc':
            return sorted.sort((a, b) => b.name.localeCompare(a.name));
          default:
            return sorted;
        }
      }
      
      // ---------- RENDERING ----------
      function showLoadingSkeleton() {
        const grid = document.getElementById('restaurantGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        grid.classList.add('skeleton-grid');
        
        for (let i = 0; i < 8; i++) {
          const skeleton = document.createElement('div');
          skeleton.className = 'skeleton-card';
          skeleton.innerHTML = `
            <div class="skeleton-image"></div>
            <div class="skeleton-content">
              <div class="skeleton-line" style="width: 70%"></div>
              <div class="skeleton-line short"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line" style="width: 40%"></div>
            </div>
          `;
          grid.appendChild(skeleton);
        }
      }
      
      async function renderRestaurants() {
        const grid = document.getElementById('restaurantGrid');
        const emptyState = document.querySelector('.empty-state');
        
        if (!grid) return;
        
        if (state.filteredRestaurants.length === 0) {
          showEmptyState();
          return;
        }
        
        if (emptyState) {
          emptyState.style.display = 'none';
        }
        
        grid.classList.remove('skeleton-grid');
        
        const startIdx = (state.currentPage - 1) * state.pageSize;
        const endIdx = startIdx + state.pageSize;
        const pageItems = state.filteredRestaurants.slice(startIdx, endIdx);
        
        // Clear grid first
        grid.innerHTML = '';
        
        // Create cards sequentially to avoid async issues
        for (const restaurant of pageItems) {
          const card = await createRestaurantCard(restaurant);
          grid.appendChild(card);
        }
        
        loadVisibleImages();
      }
      
      function createRestaurantCard(restaurant) {
        const card = document.createElement('div');
        card.className = 'restaurant-card';
        card.dataset.id = restaurant.id;
        
        const rating = restaurant.rating || 0;
        const categoryIcon = restaurant.category_icon || getCategoryIconFallback(restaurant.category);
        const category = restaurant.category || 'Restaurant';
        const logoUrl = getLogoUrl(restaurant);
        const status = listManager.getRestaurantListStatus(restaurant.id);
        const isTopRated = rating >= 4.5;
        const hasCoverImage = restaurant.coverImage && restaurant.coverImage !== '';
        
        let badgeText = '';
        if (status.favorites) badgeText += '‚ù§Ô∏è ';
        if (status.wantToGo) badgeText += 'üìç ';
        if (status.visited) badgeText += '‚úì ';
        
        // Also check if in any custom lists
        if (state.isLoggedIn && state.customLists.length > 0) {
          // This would be more efficient with a batch check, but for simplicity:
          state.customLists.forEach(list => {
            if (list.restaurants && list.restaurants.includes(restaurant.id)) {
              badgeText += 'üìã ';
            }
          });
        }
        
        card.innerHTML = `
          <a href="restaurant.html?slug=${restaurant.slug}" class="card-link">
            <div class="card-image">
              ${hasCoverImage ? `
                <img class="restaurant-image" 
                     data-src="${restaurant.coverImage}" 
                     alt="${restaurant.name}" 
                     width="300" 
                     height="200">
              ` : ''}
              ${logoUrl ? `
                <div class="logo-overlay">
                  <img data-src="${logoUrl}" 
                       alt="${restaurant.name} logo" 
                       width="48" 
                       height="48">
                </div>
              ` : ''}
              <button class="menu-btn" aria-label="Restaurant actions" title="Save to lists">
                <i class="fas fa-ellipsis-h"></i>
              </button>
              ${badgeText ? `
                <div class="badge-container">
                  <div class="user-list-badge">${badgeText.trim()}</div>
                </div>
              ` : ''}
            </div>
            <div class="card-content">
              <div class="card-header">
                <div class="card-title-wrapper">
                  <h3 class="card-title">${restaurant.name}</h3>
                  ${isTopRated ? '<div class="top-rated-badge">TOP RATED</div>' : ''}
                </div>
                <div class="card-rating">
                  <i class="fas fa-star"></i>
                  ${rating.toFixed(1)}
                </div>
              </div>
              <div class="card-category">
                <span>${categoryIcon}</span>
                ${category}
              </div>
              <p class="card-description">${restaurant.description || 'Delicious food served with care'}</p>
              <div class="card-footer">
                <div class="card-location">Click to view details</div>
              </div>
            </div>
          </a>
        `;
        
        const menuBtn = card.querySelector('.menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            showModal({
              id: restaurant.id,
              name: restaurant.name,
              slug: restaurant.slug
            });
          });
        }
        
        return card;
      }
      
      function loadVisibleImages() {
        const images = document.querySelectorAll('.restaurant-image[data-src], .logo-overlay img[data-src]');
        images.forEach(img => {
          loadImage(img, img.dataset.src);
        });
      }
      
      function showEmptyState() {
        const grid = document.getElementById('restaurantGrid');
        if (!grid) return;
        
        grid.innerHTML = '';
        grid.classList.remove('skeleton-grid');
        
        const emptyState = document.createElement('div');
        emptyState.className = 'empty-state';
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
          <i class="fas fa-utensils"></i>
          <h3>No restaurants found</h3>
          <p>Try adjusting your search or filters</p>
          <button class="btn" id="resetEmpty" style="margin-top: 12px;">Reset All Filters</button>
        `;
        
        grid.appendChild(emptyState);
        
        const resetBtn = document.getElementById('resetEmpty');
        if (resetBtn) {
          resetBtn.addEventListener('click', resetAllFilters);
        }
      }
      
      // ---------- PAGINATION ----------
      function updatePagination() {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;
        
        const totalPages = Math.ceil(state.filteredRestaurants.length / state.pageSize);
        
        if (totalPages <= 1) {
          pagination.style.display = 'none';
          return;
        }
        
        pagination.style.display = 'flex';
        document.getElementById('currentPage').textContent = state.currentPage;
        document.getElementById('totalPages').textContent = totalPages;
        
        const prevBtn = document.getElementById('prevPage');
        const nextBtn = document.getElementById('nextPage');
        
        if (prevBtn) prevBtn.disabled = state.currentPage === 1;
        if (nextBtn) nextBtn.disabled = state.currentPage === totalPages;
        
        if (prevBtn) {
          prevBtn.onclick = () => {
            if (state.currentPage > 1) {
              state.currentPage--;
              renderRestaurants();
              updatePagination();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          };
        }
        
        if (nextBtn) {
          nextBtn.onclick = () => {
            if (state.currentPage < totalPages) {
              state.currentPage++;
              renderRestaurants();
              updatePagination();
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          };
        }
      }
      
      // ---------- UI UPDATES ----------
      function updateCounts() {
        const showing = Math.min(state.currentPage * state.pageSize, state.filteredRestaurants.length);
        const showingEl = document.getElementById('showingCount');
        const totalEl = document.getElementById('totalCount');
        
        if (showingEl) showingEl.textContent = showing;
        if (totalEl) totalEl.textContent = state.filteredRestaurants.length;
      }
      
      // ---------- EVENT HANDLERS ----------
      function setupEventListeners() {
        const searchInput = document.getElementById('search');
        const clearSearchBtn = document.getElementById('clearSearch');
        
        if (searchInput && clearSearchBtn) {
          const debouncedSearch = debounce(() => {
            state.activeFilters.search = searchInput.value.trim();
            applyFilters();
          }, 300);
          
          searchInput.addEventListener('input', () => {
            clearSearchBtn.style.display = searchInput.value ? 'block' : 'none';
            debouncedSearch();
          });
          
          clearSearchBtn.addEventListener('click', () => {
            searchInput.value = '';
            clearSearchBtn.style.display = 'none';
            state.activeFilters.search = '';
            applyFilters();
          });
        }
        
        const categorySelect = document.getElementById('categorySelect');
        if (categorySelect) {
          categorySelect.addEventListener('change', (e) => {
            state.activeFilters.category = e.target.value;
            applyFilters();
          });
        }
        
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
          sortSelect.addEventListener('change', (e) => {
            state.activeFilters.sort = e.target.value;
            applyFilters();
          });
        }
        
        document.querySelectorAll('.filter-chip').forEach(chip => {
          chip.addEventListener('click', (e) => {
            const filterType = e.target.dataset.filter;
            
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            e.target.classList.add('active');
            
            state.activeFilters.quickFilter = filterType;
            applyFilters();
          });
        });
        
        const resetBtn = document.getElementById('resetFilters');
        if (resetBtn) {
          resetBtn.addEventListener('click', resetAllFilters);
        }
        
        initializeViewControls();
        
        // Actions modal buttons
        const modalFavoritesBtn = document.getElementById('modalFavoritesBtn');
        const modalWantToGoBtn = document.getElementById('modalWantToGoBtn');
        const modalVisitedBtn = document.getElementById('modalVisitedBtn');
        const modalCustomListsBtn = document.getElementById('modalCustomListsBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        
        if (modalFavoritesBtn) {
          modalFavoritesBtn.addEventListener('click', async () => {
            if (!state.currentModalRestaurant) return;
            await listManager.toggleInList('favorites', state.currentModalRestaurant.id);
            updateModalButtons(state.currentModalRestaurant.id);
            renderRestaurants();
          });
        }
        
        if (modalWantToGoBtn) {
          modalWantToGoBtn.addEventListener('click', async () => {
            if (!state.currentModalRestaurant) return;
            await listManager.toggleInList('wantToGo', state.currentModalRestaurant.id);
            updateModalButtons(state.currentModalRestaurant.id);
            renderRestaurants();
          });
        }
        
        if (modalVisitedBtn) {
          modalVisitedBtn.addEventListener('click', async () => {
            if (!state.currentModalRestaurant) return;
            await listManager.toggleInList('visited', state.currentModalRestaurant.id);
            updateModalButtons(state.currentModalRestaurant.id);
            renderRestaurants();
          });
        }
        
        // Custom Lists button handler
        if (modalCustomListsBtn) {
          modalCustomListsBtn.addEventListener('click', async () => {
            if (!state.currentModalRestaurant) {
              showNotification('No restaurant selected', 'error');
              return;
            }
            
            // Store the current restaurant ID before closing the modal
            const restaurantId = state.currentModalRestaurant.id;
            const restaurantName = state.currentModalRestaurant.name;
            
            // Close the actions modal
            hideModal();
            
            // Wait a bit for the modal to close
            setTimeout(() => {
              // Set the restaurant for custom lists
              state.currentModalRestaurant = {
                id: restaurantId,
                name: restaurantName,
                slug: state.currentModalRestaurant.slug
              };
              
              // Now show the custom lists modal
              showCustomListsModal(restaurantId);
            }, 100);
          });
        }
        
        // Custom lists modal buttons
        const closeListsBtn = document.getElementById('closeListsBtn');
        const createListBtn = document.getElementById('createListBtn');
        const saveListsBtn = document.getElementById('saveListsBtn');
        const newListNameInput = document.getElementById('newListName');
        
        if (closeListsBtn) {
          closeListsBtn.addEventListener('click', hideCustomListsModal);
        }
        
        if (createListBtn) {
          createListBtn.addEventListener('click', async () => {
            const name = newListNameInput.value.trim();
            if (!name) {
              showNotification('Please enter a list name', 'warning');
              return;
            }
            
            // Check if list already exists
            const existingList = state.customLists.find(l => 
              l.title.toLowerCase() === name.toLowerCase()
            );
            
            if (existingList) {
              showNotification(`"${name}" list already exists`, 'warning');
              return;
            }
            
            const newList = await customListsManager.createList(name);
            if (newList) {
              showNotification(`Created "${name}" list`, 'success');
              newListNameInput.value = '';
              
              // Refresh lists from database
              await customListsManager.refreshLists();
              
              // Auto-select the new list
              state.selectedLists.add(newList.id);
              
              // Refresh the display
              customListsManager.renderListsList(state.currentModalRestaurant?.id);
            }
          });
        }
        
        if (saveListsBtn) {
          saveListsBtn.addEventListener('click', saveListChanges);
        }
        
        if (newListNameInput) {
          newListNameInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
              createListBtn.click();
            }
          });
        }
        
        const customListsModal = document.getElementById('customListsModal');
        if (customListsModal) {
          customListsModal.addEventListener('click', (e) => {
            if (e.target === customListsModal) {
              hideCustomListsModal();
            }
          });
        }
        
        // Auth prompt modal buttons
        const authPromptSignupBtn = document.getElementById('authPromptSignupBtn');
        const authPromptLoginBtn = document.getElementById('authPromptLoginBtn');
        const authPromptCloseBtn = document.getElementById('authPromptCloseBtn');
        
        if (authPromptSignupBtn) {
          authPromptSignupBtn.addEventListener('click', () => {
            window.location.href = 'sign-up.html';
          });
        }
        
        if (authPromptLoginBtn) {
          authPromptLoginBtn.addEventListener('click', () => {
            window.location.href = 'login.html';
          });
        }
        
        if (authPromptCloseBtn) {
          authPromptCloseBtn.addEventListener('click', hideAuthPrompt);
        }
        
        const authPromptModal = document.getElementById('authPromptModal');
        if (authPromptModal) {
          authPromptModal.addEventListener('click', (e) => {
            if (e.target === authPromptModal) {
              hideAuthPrompt();
            }
          });
        }
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            hideModal();
            hideCustomListsModal();
            hideAuthPrompt();
          }
        });
        
        guestBanner.init();
      }
      
      function initializeViewControls() {
        const gridButtons = document.querySelectorAll('.grid-btn');
        const grid = document.getElementById('restaurantGrid');
        
        if (!grid || gridButtons.length === 0) return;
        
        gridButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const view = btn.dataset.view;
            
            gridButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            grid.classList.remove('grid-normal', 'grid-compact', 'grid-dense');
            grid.classList.add(`grid-${view}`);
            
            try {
              localStorage.setItem('zo2y_grid_view', view);
            } catch (e) {}
            
            if (state.filteredRestaurants.length > 0) {
              renderRestaurants();
            }
          });
        });
        
        try {
          const savedView = localStorage.getItem('zo2y_grid_view') || 'normal';
          const savedBtn = document.querySelector(`.grid-btn[data-view="${savedView}"]`);
          if (savedBtn) {
            savedBtn.click();
          }
        } catch (e) {}
      }
      
      function resetAllFilters() {
        const searchInput = document.getElementById('search');
        const clearSearchBtn = document.getElementById('clearSearch');
        const categorySelect = document.getElementById('categorySelect');
        const sortSelect = document.getElementById('sortSelect');
        
        if (searchInput) searchInput.value = '';
        if (clearSearchBtn) clearSearchBtn.style.display = 'none';
        if (categorySelect) categorySelect.value = 'all';
        if (sortSelect) sortSelect.value = 'rating-desc';
        
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        const allFilter = document.querySelector('[data-filter="all"]');
        if (allFilter) allFilter.classList.add('active');
        
        state.activeFilters = {
          search: '',
          category: 'all',
          quickFilter: 'all',
          sort: 'rating-desc'
        };
        
        applyFilters();
        showNotification('Filters reset', 'info');
      }
      
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }
      
      // ---------- AUTH MANAGEMENT ----------
      async function updateAuthUI() {
        try {
          const { data: { session } } = await supabase.auth.getSession();
          
          if (session && session.user) {
            state.isLoggedIn = true;
            
            guestBanner.hide();
            
            let profile = null;
            try {
              const { data: profileData, error: profileError } = await supabase
                .from('user_profiles')
                .select('username, full_name, avatar_url')
                .eq('id', session.user.id)
                .single();
              
              if (!profileError) {
                profile = profileData;
              }
            } catch (err) {
              console.warn('Profile fetch error:', err);
            }
            
            const displayName = profile?.username || 
                              profile?.full_name || 
                              session.user.email?.split('@')[0] || 
                              'Profile';
            
            const authBtn = document.getElementById('authBtn');
            if (authBtn) {
              authBtn.innerHTML = `<i class="fas fa-user"></i><span>${displayName}</span>`;
              authBtn.onclick = () => {
                window.location.href = 'profile.html';
              };
            }
            
            await listManager.init();
            
          } else {
            state.isLoggedIn = false;
            
            guestBanner.show();
            
            const authBtn = document.getElementById('authBtn');
            if (authBtn) {
              authBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i><span>Sign In</span>`;
              authBtn.onclick = () => window.location.href = 'login.html';
            }
          }
          
          state.authChecked = true;
          
          if (state.filteredRestaurants.length > 0) {
            // Render restaurants without waiting for list status
            const grid = document.getElementById('restaurantGrid');
            if (grid) {
              // Clear and re-render synchronously
              renderRestaurants();
            }
          }
          
        } catch (error) {
          console.error('Auth error:', error);
          state.isLoggedIn = false;
          state.authChecked = true;
          
          guestBanner.show();
          
          const authBtn = document.getElementById('authBtn');
          if (authBtn) {
            authBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i><span>Sign In</span>`;
            authBtn.onclick = () => window.location.href = 'login.html';
          }
        }
      }
      
      // ---------- INITIALIZATION ----------
      async function init() {
        if (!supabase) {
          showNotification('Failed to connect to server', 'error');
          return;
        }
        
        initFastImageLoader();
        showLoadingSkeleton();
        setupEventListeners();
        await loadRestaurantsData();
        await updateAuthUI();
        
        supabase.auth.onAuthStateChange(updateAuthUI);
        
        let scrollTimeout;
        window.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            preloadVisibleImages();
          }, 100);
        });
      }
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
      
    })();
  </script>
</body>
</html>