<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zo2y ‚Äî All Restaurants</title>
    
    <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logo.png">

    <style>
        :root { 
            --bg: #0b1633; 
            --card: #132347; 
            --muted: #8ca3c7; 
            --accent: #f59e0b; 
            --white: #ffffff; 
            --border: rgba(255,255,255,0.1);
            --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
            --surface: rgba(19, 35, 71, 0.95);
            --cloud-color: #3b82f6;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; } 
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; min-height: 100vh; } 
        a { color: inherit; text-decoration: none; } 
        img { display: block; max-width: 100%; }

        /* --- Header --- */
        header { 
            position: sticky; top: 0; z-index: 100; 
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 32px; background: var(--surface); 
            backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); 
        } 
        .logo { height: 32px; cursor: pointer; }
        
        .nav-right { display: flex; gap: 16px; align-items: center; }
        .search-wrapper { position: relative; width: 300px; }
        .search-input { 
            width: 100%; background: #1a2d55; border: 1px solid var(--border); 
            color: white; padding: 10px 16px 10px 40px; border-radius: 20px; outline: none; transition: 0.3s;
        }
        .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(245,158,11,0.2); }
        .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--muted); }
        .btn-outline { border: 1px solid var(--border); background: transparent; color: var(--white); padding: 8px 16px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
        
        .account-btn { display: flex; align-items: center; gap: 8px; font-weight: 600; cursor: pointer; padding: 8px 16px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid var(--border); color: white; }

        /* --- Main Layout --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 32px 24px; padding-bottom: 100px; }
        
        .page-title h1 { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .page-title p { color: var(--muted); margin-bottom: 24px; }

        /* --- Filters & Controls --- */
        .quick-filters { display: flex; gap: 10px; margin-bottom: 24px; }
        .filter-pill { 
            background: #1a2d55; border: 1px solid var(--border); color: var(--muted); 
            padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; font-weight: 500; transition: 0.2s; 
        }
        .filter-pill:hover { color: white; border-color: var(--accent); }
        .filter-pill.active { background: var(--accent); color: #0b1633; border-color: var(--accent); font-weight: 700; }

        .controls-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(19, 35, 71, 0.5); padding: 16px; border-radius: 12px; 
            border: 1px solid var(--border); margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
        }
        .showing-text { color: var(--muted); font-size: 14px; }
        .controls-right { display: flex; gap: 12px; align-items: center; }
        
        select { 
            background: #0b1633; border: 1px solid var(--border); color: white; 
            padding: 8px 12px; border-radius: 8px; outline: none; cursor: pointer; 
        }
        .view-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--muted); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .view-btn.active { background: var(--accent); color: #0b1633; border-color: var(--accent); }

        /* --- Grid --- */
        .grid { display: grid; gap: 24px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); }
        
        /* List View Modifier */
        .grid.list-view { grid-template-columns: 1fr; }
        .grid.list-view .restaurant-card { flex-direction: row; height: 220px; }
        .grid.list-view .card-image { width: 300px; height: 100%; }
        .grid.list-view .logo-overlay { bottom: 12px; left: 12px; }

        /* --- Card Styles --- */
        .restaurant-card { 
            background: var(--card); border: 1px solid var(--border); border-radius: 16px; 
            overflow: hidden; display: flex; flex-direction: column; position: relative; 
            transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        }
        .restaurant-card:hover { transform: translateY(-4px); border-color: var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.3); }

        .card-image { height: 220px; position: relative; background: #1a2d55; overflow: hidden; }
        .res-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s ease; }
        .res-img.loaded { opacity: 1; }

        /* Card Overlays */
        .top-badges { position: absolute; top: 12px; left: 12px; display: flex; gap: 8px; z-index: 2; }
        .list-badge { width: 32px; height: 32px; background: rgba(11,22,51,0.9); border: 1px solid var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        
        .menu-btn { position: absolute; top: 12px; right: 12px; width: 40px; height: 40px; background: rgba(11,22,51,0.9); border: 1px solid var(--border); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; transition: 0.2s; }
        .menu-btn:hover { background: var(--accent); color: #0b1633; border-color: var(--accent); }

        /* Cloud Badge + Tooltip */
        .cloud-badge { 
            position: absolute; top: 12px; right: 60px; width: 40px; height: 40px; 
            background: var(--cloud-color); border-radius: 50%; color: white; 
            display: flex; align-items: center; justify-content: center; z-index: 5;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .cloud-tooltip {
            position: absolute; top: 110%; right: -10px; width: 220px;
            background: var(--card); border: 1px solid var(--cloud-color);
            padding: 12px; border-radius: 12px; font-size: 12px;
            color: var(--muted); visibility: hidden; opacity: 0; 
            transform: translateY(10px); transition: 0.3s; pointer-events: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: left;
        }
        .cloud-tooltip strong { color: var(--white); display: block; margin-bottom: 4px; }
        .cloud-badge:hover .cloud-tooltip { visibility: visible; opacity: 1; transform: translateY(0); }

        .logo-overlay { 
            position: absolute; bottom: 12px; left: 12px; width: 60px; height: 60px; 
            background: rgba(11,22,51,0.95); border-radius: 12px; border: 1px solid var(--border);
            padding: 4px; display: flex; align-items: center; justify-content: center;
        }
        .logo-img { width: 100%; height: 100%; object-fit: contain; }

        /* Card Content */
        .card-details { padding: 20px; display: flex; flex-direction: column; flex: 1; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-title { font-size: 20px; font-weight: 700; margin: 0; line-height: 1.2; }
        .top-rated-tag { 
            background: var(--gradient); color: #0b1633; font-size: 10px; font-weight: 800; 
            padding: 4px 8px; border-radius: 6px; text-transform: uppercase; margin-left: 8px;
            display: inline-block; vertical-align: middle;
        }
        .rating { background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 14px; color: #facc15; display: flex; align-items: center; gap: 4px; }
        
        .card-meta { display: flex; align-items: center; gap: 8px; color: var(--accent); font-size: 13px; font-weight: 600; margin-bottom: 12px; }
        .card-desc { color: var(--muted); font-size: 14px; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; margin-bottom: 16px; }
        
        /* --- Pagination Bar (Floating) --- */
        .pagination-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150%);
            background: #1a2d55; border: 1px solid var(--accent); padding: 8px 24px;
            border-radius: 50px; display: flex; align-items: center; gap: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); z-index: 900; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .pagination-bar.visible { transform: translateX(-50%) translateY(0); }
        .page-text { font-weight: 600; font-size: 14px; }
        .page-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .page-btn:hover:not(:disabled) { background: var(--accent); color: #0b1633; }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* --- Modals --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-overlay.active { display: flex; }
        .modal-box { background: var(--card); border: 1px solid var(--accent); padding: 30px; border-radius: 20px; width: 90%; max-width: 420px; text-align: center; animation: popUp 0.3s ease; }
        @keyframes popUp { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .action-list { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }
        .action-item { background: var(--bg); padding: 15px; border-radius: 12px; border: 1px solid var(--border); color: white; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .action-item:hover { border-color: var(--accent); background: rgba(245,158,11,0.1); }
        .action-item.active { background: var(--accent); color: #0b1633; border-color: var(--accent); }
        
        /* Custom List Modal Specifics */
        .list-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 8px; border: 1px solid transparent; cursor: pointer; }
        .list-row.selected { border-color: var(--accent); background: rgba(245,158,11,0.1); }
        .checkbox { width: 20px; height: 20px; border: 2px solid var(--muted); border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .list-row.selected .checkbox { background: var(--accent); border-color: var(--accent); }
        .list-row.selected .checkbox::after { content: '‚úì'; color: #0b1633; font-size: 14px; font-weight: bold; }

        /* Notification */
        #notificationContainer { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .notify { background: var(--card); border-left: 4px solid var(--accent); padding: 15px 20px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; color: white; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .grid.list-view .restaurant-card { flex-direction: column; height: auto; }
            .grid.list-view .card-image { width: 100%; height: 200px; }
            .controls-bar { flex-direction: column; align-items: flex-start; }
            .controls-right { width: 100%; justify-content: space-between; margin-top: 10px; }
            .pagination-bar { bottom: 20px; width: 90%; justify-content: space-between; }
        }
    </style>
</head>
<body>

    <div id="actionsModal" class="modal-overlay">
        <div class="modal-box">
            <h3 id="modalResName" style="margin-bottom: 5px;">Restaurant Name</h3>
            <p style="color:var(--muted); font-size:14px;">Manage your lists</p>
            <div class="action-list">
                <div class="action-item" id="actFav"><div style="display:flex; gap:10px; align-items:center"><i class="fas fa-heart"></i> <span>Favorites</span></div></div>
                <div class="action-item" id="actWant"><div style="display:flex; gap:10px; align-items:center"><i class="fas fa-map-marker-alt"></i> <span>Want to Go</span></div></div>
                <div class="action-item" id="actVisit"><div style="display:flex; gap:10px; align-items:center"><i class="fas fa-check"></i> <span>Visited</span></div></div>
                <div class="action-item" id="actCustom" style="border-color:var(--accent);"><div style="display:flex; gap:10px; align-items:center"><i class="fas fa-list"></i> <span>Custom Lists</span></div> <i class="fas fa-chevron-right"></i></div>
            </div>
            <button class="btn-outline" style="width:100%" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="customListModal" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Save to List</h3>
                <button style="background:none; border:none; color:white; font-size:24px; cursor:pointer;" onclick="closeModals()">√ó</button>
            </div>
            
            <div id="customListContainer" style="max-height: 250px; overflow-y: auto; text-align:left; margin-bottom:20px;">
                </div>

            <div style="border-top:1px solid var(--border); padding-top:15px; display:flex; gap:10px;">
                <input type="text" id="newListName" placeholder="New list name..." style="flex:1; background:rgba(255,255,255,0.05); border:1px solid var(--border); color:white; padding:10px; border-radius:8px; outline:none;">
                <button style="background:var(--accent); border:none; color:#0b1633; font-weight:700; padding:0 15px; border-radius:8px; cursor:pointer;" id="createListBtn">+</button>
            </div>
            <button style="width:100%; margin-top:15px; background:var(--accent); border:none; padding:12px; border-radius:10px; font-weight:700; color:#0b1633; cursor:pointer;" id="saveCustomBtn">Done</button>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <header>
        <img src="images/logo.png" alt="Zo2y Logo" class="logo" onclick="window.location.href='index.html'">
        <div class="nav-right">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" class="search-input" placeholder="Search restaurants...">
            </div>
            <button class="account-btn" id="accountBtn"><i class="fas fa-user"></i> <span>Account</span></button>
        </div>
    </header>

    <div class="container">
        <div class="page-title">
            <h1>All Restaurants</h1>
            <p>Discover and explore the best local spots</p>
        </div>

        <div class="quick-filters">
            <button class="filter-pill active" data-filter="all">All</button>
            <button class="filter-pill" data-filter="top-rated">‚≠ê Top Rated</button>
            <button class="filter-pill" data-filter="trending">üî• Trending</button>
            <button class="filter-pill" data-filter="new">üÜï New</button>
        </div>

        <div class="controls-bar">
            <span class="showing-text" id="showingText">Loading...</span>
            
            <div class="controls-right">
                <select id="categoryFilter">
                    <option value="all">All Categories</option>
                </select>
                
                <select id="sortFilter">
                    <option value="rating-desc">Rating: High to Low</option>
                    <option value="name-asc">Name: A-Z</option>
                </select>

                <div style="display:flex; gap:5px;">
                    <button class="view-btn active" id="viewGrid"><i class="fas fa-th-large"></i></button>
                    <button class="view-btn" id="viewList"><i class="fas fa-list"></i></button>
                </div>
            </div>
        </div>

        <div id="restaurantGrid" class="grid">
            </div>
    </div>

    <div id="paginationBar" class="pagination-bar">
        <button class="page-btn" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
        <span class="page-text" id="pageIndicator">Page 1 of 2</span>
        <button class="page-btn" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>

    <script>
    (function() {
        const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // State
        const state = {
            allRestaurants: [],
            filtered: [],
            categories: [],
            customLists: [],
            selectedListIds: new Set(),
            cloudIds: new Set(),
            user: null,
            currentPage: 1,
            pageSize: 20,
            currentModalRes: null
        };

        // DOM Elements
        const grid = document.getElementById('restaurantGrid');
        const paginationBar = document.getElementById('paginationBar');
        const showingText = document.getElementById('showingText');

        // Init
        async function init() {
            // Check Session
            const { data: { session } } = await supabase.auth.getSession();
            state.user = session?.user || null;
            updateAuthUI();

            if(state.user) await loadUserLists();

            // Parallel Load
            await Promise.all([loadCloudKitchens(), loadRestaurants(), loadCategories()]);
            
            // Events
            setupEvents();
        }

        function updateAuthUI() {
            const btn = document.getElementById('accountBtn');
            if(state.user) {
                btn.innerHTML = `<i class="fas fa-user"></i> <span>${state.user.user_metadata?.username || 'Profile'}</span>`;
                btn.onclick = () => location.href = 'profile.html';
            } else {
                btn.innerHTML = `<i class="fas fa-sign-in-alt"></i> <span>Sign In</span>`;
                btn.onclick = () => location.href = 'login.html';
            }
        }

        // --- Data Loading ---
        async function loadCloudKitchens() {
            const { data } = await supabase.from('cloud_kitchens').select('restaurant_id');
            if(data) data.forEach(ck => state.cloudIds.add(ck.restaurant_id));
        }

        async function loadRestaurants() {
            const { data } = await supabase.from('restraunts').select('*').order('rating', {ascending:false});
            if(data) {
                state.allRestaurants = data;
                applyFilters();
            }
        }

        async function loadCategories() {
            const { data } = await supabase.from('categories').select('*');
            if(data) {
                const sel = document.getElementById('categoryFilter');
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name;
                    opt.textContent = (c.icon || 'üç¥') + ' ' + c.name;
                    sel.appendChild(opt);
                });
            }
        }

        async function loadUserLists() {
            const { data } = await supabase.from('lists').select('*').eq('user_id', state.user.id);
            if(data) state.customLists = data;
        }

        // --- Core Logic ---
        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('categoryFilter').value;
            const sort = document.getElementById('sortFilter').value;
            const quick = document.querySelector('.filter-pill.active').dataset.filter;

            let res = state.allRestaurants.filter(r => r.name.toLowerCase().includes(search));

            if(cat !== 'all') res = res.filter(r => r.category === cat);

            if(quick === 'top-rated') res = res.filter(r => r.rating >= 4.5);
            else if(quick === 'trending') res = res.filter(r => r.rating >= 4.0);
            
            if(sort === 'rating-desc') res.sort((a,b) => b.rating - a.rating);
            if(sort === 'name-asc') res.sort((a,b) => a.name.localeCompare(b.name));

            state.filtered = res;
            state.currentPage = 1;
            render();
        }

        function render() {
            grid.innerHTML = '';
            
            // Pagination Slicing
            const start = (state.currentPage - 1) * state.pageSize;
            const end = start + state.pageSize;
            const pageData = state.filtered.slice(start, end);

            const fragment = document.createDocumentFragment();
            pageData.forEach(r => fragment.appendChild(createCard(r)));
            grid.appendChild(fragment);

            // Update Text
            showingText.textContent = `Showing ${pageData.length} of ${state.filtered.length} restaurants`;

            // Update Pagination UI
            const totalPages = Math.ceil(state.filtered.length / state.pageSize);
            document.getElementById('pageIndicator').textContent = `Page ${state.currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = state.currentPage === 1;
            document.getElementById('nextBtn').disabled = state.currentPage === totalPages || totalPages === 0;

            // Initial Scroll Check
            handleScroll();
        }

        function createCard(r) {
            const el = document.createElement('div');
            el.className = 'restaurant-card';
            
            const isTop = r.rating >= 4.5;
            const isCloud = state.cloudIds.has(r.id);
            const iconMap = {'Burgers':'üçî','Pizza':'üçï','Chicken':'üçó','Asian':'üçú'};
            const catIcon = iconMap[r.category] || 'üç¥';

            el.innerHTML = `
                <div class="card-image" onclick="location.href='restaurant.html?slug=${r.slug}'">
                    <img src="${r.image}" class="res-img" onload="this.classList.add('loaded')">
                    
                    ${r.logo_url ? `<div class="logo-overlay"><img src="${r.logo_url}" class="logo-img"></div>` : ''}
                    
                    <div class="top-badges" id="badges-${r.id}"></div>

                    ${isCloud ? `
                    <div class="cloud-badge">
                        <i class="fas fa-cloud"></i>
                        <div class="cloud-tooltip">
                            <strong>Cloud Kitchen</strong>
                            A delivery-only restaurant concept with no dine-in space.
                        </div>
                    </div>` : ''}

                    <div class="menu-btn" onclick="event.stopPropagation(); openModal('${r.id}')"><i class="fas fa-ellipsis-h"></i></div>
                </div>
                <div class="card-details" onclick="location.href='restaurant.html?slug=${r.slug}'">
                    <div class="card-header">
                        <div style="flex:1">
                            <h3 class="card-title">${r.name} ${isTop ? '<span class="top-rated-tag">Top Rated</span>' : ''}</h3>
                        </div>
                        <div class="rating"><i class="fas fa-star"></i> ${r.rating.toFixed(1)}</div>
                    </div>
                    <div class="card-meta"><span>${catIcon}</span> ${r.category}</div>
                    <p class="card-desc">${r.description || 'Delicious food served hot and fresh.'}</p>
                </div>
            `;
            
            // Async load badges to keep rendering fast
            loadBadges(r.id, el.querySelector('.top-badges'));
            return el;
        }

        async function loadBadges(rId, container) {
            if(!state.user) return;
            // Fetch list membership
            const { data } = await supabase.from('lists_restraunts').select('list_id').eq('restraunt_id', rId);
            if(!data) return;
            
            const myLists = state.customLists;
            const membership = new Set(data.map(x => x.list_id));

            myLists.forEach(l => {
                if(membership.has(l.id)) {
                    let icon = '';
                    if(l.title === 'Favorites') icon = '‚ù§Ô∏è';
                    else if(l.title === 'Want to Go') icon = 'üìç';
                    else if(l.title === 'Visited') icon = '‚úì';
                    
                    if(icon) {
                        const b = document.createElement('div');
                        b.className = 'list-badge';
                        b.innerHTML = icon;
                        container.appendChild(b);
                    }
                }
            });
        }

        // --- Pagination Logic (Scroll Based) ---
        function handleScroll() {
            // Logic: Is the user near the bottom?
            const scrollTotal = document.documentElement.scrollHeight - window.innerHeight;
            const currentScroll = window.scrollY;
            const threshold = 150; // Show when 150px from bottom

            const totalPages = Math.ceil(state.filtered.length / state.pageSize);
            
            // Only show if there are multiple pages AND we are near the bottom
            if (totalPages > 1 && (scrollTotal - currentScroll) < 400) {
                paginationBar.classList.add('visible');
            } else {
                paginationBar.classList.remove('visible');
            }
        }

        // --- Modals ---
        window.openModal = async (rId) => {
            if(!state.user) { location.href = 'login.html'; return; }
            
            state.currentModalRes = state.allRestaurants.find(r => r.id === rId);
            document.getElementById('modalResName').textContent = state.currentModalRes.name;
            document.getElementById('actionsModal').classList.add('active');

            // Determine button states based on db
            const { data } = await supabase.from('lists_restraunts').select('list_id').eq('restraunt_id', rId);
            const activeIds = new Set(data?.map(x => x.list_id) || []);

            const setupBtn = (eleId, title) => {
                const btn = document.getElementById(eleId);
                const list = state.customLists.find(l => l.title === title);
                const isActive = list && activeIds.has(list.id);
                
                if(isActive) {
                    btn.classList.add('active');
                    btn.querySelector('span').textContent = 'Remove from ' + title;
                } else {
                    btn.classList.remove('active');
                    btn.querySelector('span').textContent = 'Add to ' + title;
                }
                
                // Set click
                btn.onclick = async () => {
                    if(!list) {
                        // Create default list if missing
                        const {data:nl} = await supabase.from('lists').insert([{user_id:state.user.id, title:title}]).select().single();
                        state.customLists.push(nl);
                        await toggleList(nl.id, rId);
                    } else {
                        await toggleList(list.id, rId);
                    }
                    openModal(rId); // refresh modal state
                    render(); // refresh grid badges
                };
            };

            setupBtn('actFav', 'Favorites');
            setupBtn('actWant', 'Want to Go');
            setupBtn('actVisit', 'Visited');
            
            // Custom list button
            document.getElementById('actCustom').onclick = () => {
                document.getElementById('actionsModal').classList.remove('active');
                openCustomModal(activeIds);
            };
        };

        async function toggleList(listId, rId) {
            // Check if exists
            const {data} = await supabase.from('lists_restraunts').select('*').match({list_id:listId, restraunt_id:rId});
            if(data.length > 0) {
                await supabase.from('lists_restraunts').delete().match({list_id:listId, restraunt_id:rId});
                showNotify('Removed from list', 'info');
            } else {
                await supabase.from('lists_restraunts').insert([{list_id:listId, restraunt_id:rId}]);
                showNotify('Added to list', 'success');
            }
        }

        function openCustomModal(activeIds) {
            state.selectedListIds = new Set(activeIds); // Clone current state
            const container = document.getElementById('customListContainer');
            container.innerHTML = '';
            
            // Filter out default lists
            const customs = state.customLists.filter(l => !['Favorites','Visited','Want to Go'].includes(l.title));
            
            if(customs.length === 0) container.innerHTML = '<p style="color:var(--muted); text-align:center;">No custom lists yet.</p>';

            customs.forEach(l => {
                const div = document.createElement('div');
                const isSel = state.selectedListIds.has(l.id);
                div.className = `list-row ${isSel ? 'selected' : ''}`;
                div.innerHTML = `<span>${l.title}</span> <div class="checkbox"></div>`;
                div.onclick = () => {
                    if(state.selectedListIds.has(l.id)) state.selectedListIds.delete(l.id);
                    else state.selectedListIds.add(l.id);
                    openCustomModal(state.selectedListIds); // re-render self
                };
                container.appendChild(div);
            });

            document.getElementById('customListModal').classList.add('active');
        }

        window.closeModals = () => {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
        };

        // --- Events ---
        function setupEvents() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            
            // Pills
            document.querySelectorAll('.filter-pill').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.filter-pill').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyFilters();
                };
            });

            // View Switch
            document.getElementById('viewGrid').onclick = () => {
                grid.classList.remove('list-view');
                document.getElementById('viewGrid').classList.add('active');
                document.getElementById('viewList').classList.remove('active');
            };
            document.getElementById('viewList').onclick = () => {
                grid.classList.add('list-view');
                document.getElementById('viewList').classList.add('active');
                document.getElementById('viewGrid').classList.remove('active');
            };

            // Pagination
            document.getElementById('prevBtn').onclick = () => {
                if(state.currentPage > 1) { state.currentPage--; render(); window.scrollTo(0,0); }
            };
            document.getElementById('nextBtn').onclick = () => {
                const total = Math.ceil(state.filtered.length / state.pageSize);
                if(state.currentPage < total) { state.currentPage++; render(); window.scrollTo(0,0); }
            };

            // Scroll Listener
            window.addEventListener('scroll', handleScroll);

            // Custom List Logic
            document.getElementById('createListBtn').onclick = async () => {
                const name = document.getElementById('newListName').value;
                if(!name) return;
                const {data} = await supabase.from('lists').insert([{user_id:state.user.id, title:name}]).select().single();
                if(data) {
                    state.customLists.push(data);
                    state.selectedListIds.add(data.id);
                    document.getElementById('newListName').value = '';
                    openCustomModal(state.selectedListIds);
                }
            };

            document.getElementById('saveCustomBtn').onclick = async () => {
                const rId = state.currentModalRes.id;
                // Get fresh list from DB to diff
                const { data } = await supabase.from('lists_restraunts').select('list_id').eq('restraunt_id', rId);
                const dbIds = new Set(data.map(x => x.list_id));
                const currentIds = state.selectedListIds;

                // Only touch custom lists
                const customOnly = state.customLists.filter(l => !['Favorites','Visited','Want to Go'].includes(l.title));
                
                for(const list of customOnly) {
                    const inDb = dbIds.has(list.id);
                    const inUI = currentIds.has(list.id);
                    
                    if(inDb && !inUI) await supabase.from('lists_restraunts').delete().match({list_id:list.id, restraunt_id:rId});
                    if(!inDb && inUI) await supabase.from('lists_restraunts').insert([{list_id:list.id, restraunt_id:rId}]);
                }
                
                closeModals();
                showNotify('Lists updated!', 'success');
                render(); // refresh badges
            };
        }

        function showNotify(msg, type) {
            const d = document.createElement('div');
            d.className = 'notify';
            d.style.borderColor = type === 'success' ? '#10b981' : '#3b82f6';
            d.innerHTML = `<i class="fas fa-info-circle"></i> <span>${msg}</span>`;
            document.getElementById('notificationContainer').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }

        init();
    })();
    </script>
</body>
</html>