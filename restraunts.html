<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zo2y ‚Äî All Restaurants</title>
    
    <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
    <link rel="dns-prefetch" href="https://gfkhjbztayjyojsgdpgk.supabase.co">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="images/logo.png">

    <style>
        :root { 
            --bg: #0b1633; --card: #132347; --muted: #8ca3c7; --accent: #f59e0b; 
            --glass: rgba(255,255,255,0.03); --white: #ffffff; --border: rgba(255,255,255,0.1);
            --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --success: #10b981; --error: #ef4444; --info: #3b82f6;
            --surface: rgba(19, 35, 71, 0.6);
            --cloud-color: #3b82f6;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; } 
        html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; overflow-x: hidden; } 
        a { color: inherit; text-decoration: none; } 

        /* Enhanced Header */
        header { 
            position: sticky; top: 0; z-index: 1000; display: flex; align-items: center; 
            gap: 20px; padding: 14px 24px; backdrop-filter: blur(10px) saturate(180%);
            background: var(--surface); border-bottom: 1px solid var(--border); 
        } 
        .logo { height: 40px; cursor: pointer; transition: transform 0.3s ease; }
        .logo:hover { transform: scale(1.05); }
        .toolbar { display: flex; gap: 12px; margin-left: auto; align-items: center; flex-wrap: wrap; } 

        /* Search */
        .search-wrapper { width: 320px; position: relative; }
        .search { 
            width: 100%; padding: 10px 16px 10px 40px; border-radius: 20px; 
            border: 1px solid var(--border); background: var(--card); color: var(--white); 
            outline: none; font-size: 14px; transition: all 0.3s ease;
        } 
        .search:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); } 
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); opacity: 0.6; pointer-events: none; }
        .clear-search { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--muted); cursor: pointer; display: none; padding: 4px; }
        
        /* Buttons */
        .btn { background: var(--card); border: 1px solid var(--border); color: var(--white); padding: 8px 16px; border-radius: 16px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s ease; white-space: nowrap; } 
        .btn:hover { background: var(--accent); color: #0b1633; }
        .btn-primary { background: var(--gradient); border: none; color: #0b1633; font-weight: 600; }
        .account-btn { background: transparent; color: var(--white); padding: 8px 16px; border-radius: 12px; border: 1px solid var(--border); cursor: pointer; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; font-size: 14px; }
        .account-btn:hover { background: rgba(245, 158, 11, 0.1); border-color: var(--accent); }

        /* Controls */
        .container { max-width: 1200px; margin: 24px auto; padding: 0 20px; min-height: calc(100vh - 200px); } 
        .page-header { margin-bottom: 24px; }
        .page-header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .page-header p { color: var(--muted); font-size: 14px; }

        .quick-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 10px; scrollbar-width: none; }
        .filter-chip { background: var(--card); border: 1px solid var(--border); color: var(--muted); padding: 6px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .filter-chip.active, .filter-chip:hover { background: var(--accent); color: #0b1633; border-color: var(--accent); }

        .controls { display: flex; gap: 12px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: rgba(255,255,255,0.02); padding: 15px; border-radius: 16px; border: 1px solid var(--border); } 
        .controls-info { color: var(--muted); font-size: 14px; font-weight: 500; margin-right: auto; } 
        .sort-select { background: var(--bg); border: 1px solid var(--border); color: var(--white); padding: 8px 12px; border-radius: 10px; font-size: 13px; cursor: pointer; min-width: 140px; }
        
        .view-controls { display: flex; align-items: center; gap: 10px; }
        .grid-btn { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; background: var(--bg); border: 1px solid var(--border); color: var(--muted); }
        .grid-btn.active { background: var(--accent); color: #0b1633; border-color: var(--accent); }

        /* Grid Layouts */
        .grid { display: grid; gap: 20px; transition: all 0.3s ease; }
        .grid-quad { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        .grid-single { grid-template-columns: 1fr; } /* List view */

        /* --- RESTAURANT CARD --- */
        .restaurant-card { 
            background: var(--card); border-radius: 16px; overflow: hidden; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid var(--border);
            cursor: pointer; position: relative; transition: all 0.2s ease; 
            display: flex; flex-direction: column; height: 100%;
        } 
        .restaurant-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.2); border-color: var(--accent); }

        /* Horizontal Layout (List View) */
        .grid-single .restaurant-card { flex-direction: row; height: 180px; }
        .grid-single .card-image { width: 280px; height: 100%; flex-shrink: 0; }
        .grid-single .card-content { justify-content: center; }

        .card-image { height: 200px; position: relative; overflow: hidden; background: linear-gradient(135deg, #1a2d5f 0%, #0b1633 100%); }
        .restaurant-image { display: block; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s ease; }
        .restaurant-image.loaded { opacity: 1; }

        /* Logo Overlay - Bottom Left (Increased Size) */
        .logo-overlay { 
            position: absolute; bottom: 12px; left: 12px; 
            width: 56px; height: 56px; 
            background: rgba(11, 22, 51, 0.9); border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; padding: 4px; 
            border: 2px solid var(--accent); backdrop-filter: blur(10px); z-index: 20; 
            transition: all 0.3s ease; box-shadow: 0 6px 20px rgba(0,0,0,0.4); 
            pointer-events: none;
        }
        .restaurant-card:hover .logo-overlay { 
            transform: scale(1.1); border-color: var(--accent); background: rgba(245,158,11,0.9); 
        }

        /* List Icons - Top Left (Stacked) */
        .list-badges-container {
            position: absolute; top: 12px; left: 12px; 
            display: flex; flex-direction: column; gap: 8px; z-index: 30;
        }
        .list-badge {
            background: rgba(11, 22, 51, 0.95); color: var(--accent);
            width: 36px; height: 36px; 
            border-radius: 10px; font-size: 18px; 
            border: 1px solid var(--accent); cursor: help;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: all 0.3s ease;
        }
        .list-badge:hover { transform: scale(1.1); background: var(--accent); color: #0b1633; }

        /* Menu Button - Top Right */
        .menu-btn-container { position: absolute; top: 12px; right: 12px; z-index: 30; }
        .menu-btn { 
            width: 40px; height: 40px;
            background: rgba(11, 22, 51, 0.9); border: 2px solid var(--accent); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;
            color: var(--white); font-size: 18px;
        }
        .menu-btn:hover { background: var(--accent); color: #0b1633; transform: scale(1.1); }

        /* Cloud Kitchen Badge */
        .cloud-badge {
            position: absolute; top: 12px; right: 60px; /* Spaced from menu btn */
            width: 40px; height: 40px;
            background: rgba(59, 130, 246, 0.95); border: 1px solid #3b82f6;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 20px; z-index: 29; cursor: help;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        /* Cloud Tooltip */
        .cloud-tooltip {
            position: absolute; top: 110%; right: 0;
            background: var(--card); border: 1px solid var(--cloud-color);
            color: var(--white); padding: 12px; border-radius: 12px;
            font-size: 12px; width: 220px; opacity: 0; visibility: hidden;
            transition: all 0.2s ease; z-index: 100; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            font-weight: 500; line-height: 1.4; text-align: left;
        }
        .cloud-badge:hover .cloud-tooltip { opacity: 1; visibility: visible; transform: translateY(5px); }
        .tooltip-header { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-weight: 700; color: var(--cloud-color); font-size: 14px; }

        /* Content Area */
        .card-content { padding: 16px; flex: 1; display: flex; flex-direction: column; }
        .card-header { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; }
        .card-title-wrapper { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; flex: 1; }
        .card-title { font-size: 18px; font-weight: 700; line-height: 1.3; margin: 0; }
        
        .top-rated-badge { 
            display: inline-block; background: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%); 
            color: #0b1633; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; 
            letter-spacing: 0.5px; text-transform: uppercase; border: 1px solid rgba(245, 158, 11, 0.5);
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); white-space: nowrap;
        }

        .card-rating { 
            background: var(--gradient); color: #0b1633; padding: 4px 8px; 
            border-radius: 8px; font-size: 13px; font-weight: 700; 
            display: flex; align-items: center; gap: 4px; flex-shrink: 0; 
        }
        
        .card-category { color: var(--accent); font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px; }
        .card-description { color: var(--muted); font-size: 14px; line-height: 1.5; margin-bottom: 16px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
        .card-footer { margin-top: auto; padding-top: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; }
        .card-location { color: var(--muted); font-size: 13px; font-weight: 500; }

        /* Pagination Bar */
        .pagination-bar { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px); 
            background: rgba(19, 35, 71, 0.95); backdrop-filter: blur(10px); 
            padding: 10px 20px; border-radius: 50px; border: 1px solid var(--accent); 
            display: flex; gap: 20px; align-items: center; z-index: 900; 
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); opacity: 0;
        }
        .pagination-bar.visible { transform: translateX(-50%) translateY(0); opacity: 1; }
        .page-btn { width: 40px; height: 40px; border-radius: 50%; border: 1px solid var(--border); background: var(--bg); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; font-size: 16px; }
        .page-btn:hover:not(:disabled) { background: var(--accent); color: #0b1633; border-color: var(--accent); }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .page-info { font-weight: 600; color: var(--white); font-size: 15px; min-width: 80px; text-align: center; }

        /* Footer */
        footer { padding: 40px 20px 24px; color: var(--muted); text-align: center; border-top: 1px solid var(--border); margin-top: 40px; background: var(--card); }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; text-align: center; margin-bottom: 30px; }
        .footer-column h3 { color: var(--white); margin-bottom: 16px; font-size: 16px; font-weight: 600; }
        .footer-column a { display: block; margin-bottom: 10px; transition: all 0.3s ease; padding: 4px 0; font-size: 14px; }
        .footer-column a:hover { color: var(--accent); }
        .footer-bottom { border-top: 1px solid var(--border); padding-top: 20px; font-size: 14px; max-width: 1200px; margin: 0 auto; }

        /* Modals & Notification CSS (Standard) */
        .actions-modal, .custom-lists-modal, .auth-prompt-modal { display: none; position: fixed; inset: 0; background: rgba(11,22,51,0.95); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .actions-modal.active, .custom-lists-modal.active, .auth-prompt-modal.active { display: flex; }
        .actions-content, .custom-lists-content, .auth-prompt-content { background: var(--card); padding: 30px; border-radius: 20px; border: 2px solid var(--accent); width: 90%; max-width: 400px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        .action-buttons { display: flex; flex-direction: column; gap: 12px; margin: 24px 0; }
        .action-btn-modal { background: var(--bg); border: 1px solid var(--border); color: white; padding: 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.3s; font-size: 15px; }
        .action-btn-modal:hover, .action-btn-modal.active { background: var(--accent); color: #0b1633; border-color: var(--accent); }
        .cancel-btn, .close-lists-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 12px; border-radius: 12px; width: 100%; cursor: pointer; margin-top: 10px; }
        
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .custom-notification { background: var(--card); border: 1px solid var(--border); padding: 16px; border-radius: 12px; display: flex; align-items: center; gap: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideInRight 0.3s ease; }
        .notification-success { border-left: 4px solid var(--success); }
        .notification-error { border-left: 4px solid var(--error); }
        
        /* Lists specific */
        .lists-list-container { max-height: 300px; overflow-y: auto; margin-bottom: 20px; text-align: left; }
        .list-item { padding: 12px; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; }
        .list-item:hover { background: rgba(255,255,255,0.05); }
        .list-item.active { border-color: var(--accent); background: rgba(245,158,11,0.1); }
        .list-icon { width: 32px; height: 32px; background: var(--gradient); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0b1633; }
        .list-checkbox { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 6px; margin-left: auto; display: flex; align-items: center; justify-content: center; }
        .list-item.active .list-checkbox { background: var(--accent); border-color: var(--accent); }
        .list-item.active .list-checkbox::after { content: '‚úì'; color: #0b1633; font-size: 12px; font-weight: bold; }
        
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            header { flex-wrap: wrap; }
            .search-wrapper { width: 100%; order: 3; margin-top: 10px; }
            .grid-quad { grid-template-columns: 1fr; }
            .grid-single .restaurant-card { flex-direction: column; height: auto; }
            .grid-single .card-image { width: 100%; height: 200px; }
            .controls { flex-direction: column; align-items: flex-start; }
            .sort-controls { width: 100%; overflow-x: auto; }
            .footer-content { grid-template-columns: repeat(2, 1fr); text-align: left; }
            .cloud-tooltip { display: none; /* No hover on mobile */ }
        }
    </style>
</head>
<body>

  <div id="actionsModal" class="actions-modal">
    <div class="actions-content">
      <h3 id="modalRestaurantName" style="margin-bottom: 5px; color:white;">Restaurant</h3>
      <p style="color:var(--muted); font-size:14px;">Manage your lists</p>
      <div class="action-buttons">
        <button class="action-btn-modal" id="modalFavoritesBtn"><i class="fas fa-heart"></i> <span>Favorites</span></button>
        <button class="action-btn-modal" id="modalWantToGoBtn"><i class="fas fa-map-marker-alt"></i> <span>Want to Go</span></button>
        <button class="action-btn-modal" id="modalVisitedBtn"><i class="fas fa-utensils"></i> <span>Visited</span></button>
        <button class="action-btn-modal custom-lists-btn" id="modalCustomListsBtn"><i class="fas fa-list"></i> <span>Custom Lists</span> <i class="fas fa-chevron-right" style="margin-left:auto"></i></button>
      </div>
      <button class="cancel-btn" id="modalCancelBtn">Close</button>
    </div>
  </div>

  <div id="customListsModal" class="custom-lists-modal">
    <div class="custom-lists-content">
      <div class="lists-header">
        <h3 style="color:white; margin:0"><i class="fas fa-list" style="color:var(--accent)"></i> Custom Lists</h3>
        <button class="close-lists-btn" id="closeListsBtn" style="width:auto; margin:0; border:none;">√ó</button>
      </div>
      <div id="listsListContainer" class="lists-list-container"></div>
      <div class="new-list-section" style="border-top:1px solid var(--border); padding-top:15px;">
        <div style="display:flex; gap:10px; margin-bottom:10px;">
          <input type="text" id="newListName" placeholder="New list name..." style="flex:1; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--bg); color:white;">
          <button id="createListBtn" class="btn-primary" style="padding:10px 15px; border-radius:10px;">Create</button>
        </div>
        <button id="saveListsBtn" class="btn-primary" style="width:100%; padding:12px; border-radius:12px;">Save Changes</button>
      </div>
    </div>
  </div>

  <div id="authPromptModal" class="auth-prompt-modal">
    <div class="auth-prompt-content">
      <div style="font-size:40px; color:var(--accent); margin-bottom:20px;"><i class="fas fa-lock"></i></div>
      <h3 style="color:white; margin-bottom:10px;">Sign In Required</h3>
      <p style="color:var(--muted); margin-bottom:20px;">Create an account to save restaurants and track your food journey.</p>
      <div style="display:flex; gap:10px; flex-direction:column;">
        <button class="btn-primary" style="padding:12px; border-radius:12px;" onclick="location.href='sign-up.html'">Create Account</button>
        <button class="cancel-btn" onclick="location.href='login.html'">Sign In</button>
      </div>
      <button class="cancel-btn" style="border:none; margin-top:15px;" onclick="document.getElementById('authPromptModal').classList.remove('active')">Maybe Later</button>
    </div>
  </div>

  <div id="notificationContainer" class="notification-container"></div>

  <header class="nav">
    <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
    <div class="toolbar">
      <div class="search-wrapper">
        <span class="search-icon">üîé</span>
        <input type="text" id="search" class="search" placeholder="Search restaurants...">
        <button class="clear-search" id="clearSearch">‚úï</button>
      </div>
      <button class="btn" id="resetFilters">Clear Filters</button>
      <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1>All Restaurants</h1>
      <p>Discover and explore the best local spots</p>
    </div>
    
    <div class="quick-filters" id="quickFilters">
        <div class="filter-chip active" data-filter="all">All</div>
        <div class="filter-chip" data-filter="top-rated">‚≠ê Top Rated</div>
        <div class="filter-chip" data-filter="trending">üî• Trending</div>
        <div class="filter-chip" data-filter="new">üÜï New</div>
    </div>

    <div class="controls">
      <div class="controls-info"><span id="showingText">Loading...</span></div>
      <div class="sort-controls">
        <select id="categorySelect" class="sort-select"><option value="all">All Categories</option></select>
        <select id="sortSelect" class="sort-select">
          <option value="rating-desc">Rating: High to Low</option>
          <option value="name-asc">Name: A-Z</option>
        </select>
        <div class="items-per-page" style="margin-left:10px; color:var(--muted); font-size:13px;">
           Show: <select id="itemsPerPage" class="sort-select" style="min-width:60px;"><option value="20">20</option><option value="all">All</option></select>
        </div>
      </div>
      <div class="view-controls">
          <button class="grid-btn active" data-view="quad"><i class="fas fa-th"></i></button>
          <button class="grid-btn" data-view="single"><i class="fas fa-list"></i></button>
      </div>
    </div>
    
    <div id="restaurantGrid" class="grid grid-quad"></div>
  </main>
  
  <div id="paginationBar" class="pagination-bar">
      <button class="page-btn" id="prevPage"><i class="fas fa-chevron-left"></i></button>
      <div class="page-info">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></div>
      <button class="page-btn" id="nextPage"><i class="fas fa-chevron-right"></i></button>
  </div>

  <footer>
    <div class="footer-content">
      <div class="footer-column">
        <h3>Explore</h3>
        <a href="restraunts.html">All Restaurants</a>
        <a href="categories.html">By Category</a>
      </div>
      <div class="footer-column">
        <h3>Community</h3>
        <a href="blog.html">Food Blog</a>
      </div>
      <div class="footer-column">
        <h3>Business</h3>
        <a href="add-restaurant.html">Add Your Restaurant</a>
      </div>
      <div class="footer-column">
        <h3>Support</h3>
        <a href="about.html">About Zo2y</a>
      </div>
    </div>
    <div class="footer-bottom">
      <div style="margin-bottom:8px">¬© 2025 Zo2y</div>
    </div>
  </footer>

  <script>
    (function(){
        const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const state = {
            restaurants: [], filtered: [], isLoggedIn: false,
            currentModalRestaurant: null, customLists: [], selectedLists: new Set(),
            cloudKitchens: new Set(),
            currentPage: 1, pageSize: 20
        };

        const elements = {
            grid: document.getElementById('restaurantGrid'),
            search: document.getElementById('search'),
            showingText: document.getElementById('showingText'),
            paginationBar: document.getElementById('paginationBar'),
            currentPageSpan: document.getElementById('currentPage'),
            totalPagesSpan: document.getElementById('totalPages')
        };

        // --- Optimized Loading Logic ---
        function loadImage(imgElement, url) {
            if (!url || !imgElement) return;
            // Only set src if different to avoid reloading
            if (imgElement.getAttribute('src') !== url) imgElement.src = url;
            
            // Standard load handler
            if(imgElement.complete) imgElement.classList.add('loaded');
            else imgElement.onload = () => imgElement.classList.add('loaded');
        }

        async function init() {
            // 1. Check Auth
            const { data: { session } } = await supabase.auth.getSession();
            state.isLoggedIn = !!session;
            
            if(state.isLoggedIn) {
                const user = session.user;
                document.getElementById('userAccountBtn').innerHTML = `<i class="fas fa-user"></i> <span>${user.user_metadata?.username || 'Profile'}</span>`;
                document.getElementById('userAccountBtn').onclick = () => location.href = 'profile.html';
                // Load user lists
                await loadLists(user.id);
            } else {
                document.getElementById('userAccountBtn').onclick = () => location.href = 'login.html';
            }

            setupEventListeners();
            
            // 2. Load Data in Parallel (Fastest)
            await Promise.all([loadCloudKitchens(), loadRestaurants(), loadCategories()]);
        }

        async function loadCloudKitchens() {
            const { data } = await supabase.from('cloud_kitchens').select('restaurant_id');
            if(data) data.forEach(ck => state.cloudKitchens.add(ck.restaurant_id));
        }

        async function loadRestaurants() {
            // Fetch basic data for ALL restaurants sorted by rating
            const { data } = await supabase.from('restraunts').select('*').order('rating', {ascending:false});
            if(data) {
                state.restaurants = data;
                applyFilters(); // Renders the grid
            }
        }

        async function loadCategories() {
            const { data } = await supabase.from('categories').select('*');
            if(data) {
                const select = document.getElementById('categorySelect');
                data.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.name; 
                    opt.textContent = `${c.icon || 'üç¥'} ${c.name}`;
                    select.appendChild(opt);
                });
            }
        }

        async function loadLists(userId) {
            const { data } = await supabase.from('lists').select('*').eq('user_id', userId).order('created_at');
            if(data) state.customLists = data;
        }

        // --- Lists Logic ---

        async function toggleList(listId, rId, btn) {
             // Check existence
             const { data } = await supabase.from('lists_restraunts').select('*').eq('list_id', listId).eq('restraunt_id', rId);
             const exists = data && data.length > 0;

             if(exists) {
                 await supabase.from('lists_restraunts').delete().match({ list_id: listId, restraunt_id: rId });
                 if(btn) {
                     btn.classList.remove('active');
                     // Dynamic Text Update
                     const text = btn.querySelector('span').textContent;
                     btn.querySelector('span').textContent = text.replace('Remove from', 'Add to');
                 }
                 showNotification('Removed from list', 'info');
             } else {
                 await supabase.from('lists_restraunts').insert([{ list_id: listId, restraunt_id: rId }]);
                 if(btn) {
                     btn.classList.add('active');
                     const text = btn.querySelector('span').textContent;
                     btn.querySelector('span').textContent = text.replace('Add to', 'Remove from');
                 }
                 showNotification('Added to list', 'success');
             }
             // Re-render only badges for visible cards? 
             // For simplicity/accuracy in this snippet, we re-render the current view
             renderRestaurants(); 
        }

        async function getRestaurantLists(rId) {
            if(!state.isLoggedIn) return new Set();
            const { data } = await supabase.from('lists_restraunts').select('list_id').eq('restraunt_id', rId);
            const set = new Set();
            if(data) data.forEach(i => set.add(i.list_id));
            return set;
        }

        // --- Rendering ---

        function renderRestaurants() {
            elements.grid.innerHTML = '';
            
            // Pagination Logic
            const start = (state.currentPage - 1) * state.pageSize;
            const end = state.pageSize === 'all' ? state.filtered.length : start + state.pageSize;
            const list = state.filtered.slice(start, end);
            
            const frag = document.createDocumentFragment();
            list.forEach(r => {
                const card = createCard(r);
                frag.appendChild(card);
            });
            elements.grid.appendChild(frag);

            // Update Counts Text
            elements.showingText.textContent = `Showing ${list.length} of ${state.filtered.length} restaurants`;
            
            // Pagination Bar UI
            const totalPages = state.pageSize === 'all' ? 1 : Math.ceil(state.filtered.length / state.pageSize);
            elements.currentPageSpan.textContent = state.currentPage;
            elements.totalPagesSpan.textContent = totalPages;
            
            document.getElementById('prevPage').disabled = state.currentPage === 1;
            document.getElementById('nextPage').disabled = state.currentPage === totalPages || totalPages === 0;
            
            if(totalPages > 1) elements.paginationBar.classList.add('visible');
            else elements.paginationBar.classList.remove('visible');
        }

        function createCard(r) {
            const div = document.createElement('div');
            div.className = 'restaurant-card';
            const isTop = r.rating >= 4.5;
            const isCloud = state.cloudKitchens.has(r.id);

            div.innerHTML = `
                <a href="restaurant.html?slug=${r.slug}" class="card-link" style="text-decoration:none; color:inherit; display:flex; flex-direction:column; height:100%;">
                    <div class="card-image">
                        <img src="${r.image}" class="restaurant-image" loading="lazy">
                        ${r.logo_url ? `<div class="logo-overlay"><img src="${r.logo_url}"></div>` : ''}
                        
                        <div class="list-badges-container" id="badges-${r.id}"></div>

                        ${isCloud ? `
                        <div class="cloud-badge">
                            <i class="fas fa-cloud"></i>
                            <div class="cloud-tooltip">
                                <div class="tooltip-header"><i class="fas fa-info-circle"></i> <h4>Cloud Kitchen</h4></div>
                                <p>A delivery-only restaurant with no physical dine-in space.</p>
                            </div>
                        </div>` : ''}
                        
                        <div class="menu-btn-container">
                             <button class="menu-btn save-trigger"><i class="fas fa-ellipsis-h"></i></button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <h3 class="card-title">${r.name}</h3>
                                ${isTop ? `<span class="top-rated-badge">TOP RATED</span>` : ''}
                            </div>
                            <div class="card-rating"><i class="fas fa-star"></i> ${r.rating.toFixed(1)}</div>
                        </div>
                        <div class="card-category"><span>üç¥</span> ${r.category}</div>
                        <p class="card-description">${r.description}</p>
                        <div class="card-footer">
                            <span class="card-location">View Details</span>
                        </div>
                    </div>
                </a>
            `;

            // Trigger Load Image Logic manually after insert
            const img = div.querySelector('.restaurant-image');
            loadImage(img, r.image);

            div.querySelector('.save-trigger').addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                openActionsModal(r);
            });

            // Async load badges (Heart, Pin, Check)
            updateCardBadges(div, r.id);

            return div;
        }

        async function updateCardBadges(card, rId) {
            if(!state.isLoggedIn) return;
            
            // Check lists for this specific restaurant
            const { data } = await supabase.from('lists_restraunts').select('list_id').eq('restraunt_id', rId);
            if(!data) return;

            const badgeContainer = card.querySelector('.list-badges-container');
            badgeContainer.innerHTML = '';
            
            const ids = new Set(data.map(d => d.list_id));
            
            state.customLists.forEach(l => {
                if(ids.has(l.id)) {
                   let icon = '';
                   if(l.title === 'Favorites') icon = '‚ù§Ô∏è';
                   else if(l.title === 'Want to Go') icon = 'üìç';
                   else if(l.title === 'Visited') icon = '‚úì';
                   
                   if(icon) {
                       const el = document.createElement('div');
                       el.className = 'list-badge';
                       el.innerHTML = icon;
                       badgeContainer.appendChild(el);
                   }
                }
            });
        }

        // --- Modals & Actions ---

        async function openActionsModal(r) {
            if(!state.isLoggedIn) { document.getElementById('authPromptModal').classList.add('active'); return; }
            state.currentModalRestaurant = r;
            document.getElementById('modalRestaurantName').textContent = r.name;
            document.getElementById('actionsModal').classList.add('active');
            
            // Get current status to set button state text
            const listIds = await getRestaurantLists(r.id);
            
            const setBtn = (id, title) => {
                const btn = document.getElementById(id);
                const list = state.customLists.find(l => l.title === title);
                if(list && listIds.has(list.id)) {
                    btn.classList.add('active');
                    btn.querySelector('span').textContent = 'Remove from ' + title;
                } else {
                    btn.classList.remove('active');
                    btn.querySelector('span').textContent = 'Add to ' + title;
                }
                // Clear old listeners by cloning
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                newBtn.onclick = () => toggleList(list?.id, r.id, newBtn);
            };

            setBtn('modalFavoritesBtn', 'Favorites');
            setBtn('modalWantToGoBtn', 'Want to Go');
            setBtn('modalVisitedBtn', 'Visited');
        }

        // --- Custom Lists Logic ---
        
        // Open Custom List Modal
        document.getElementById('modalCustomListsBtn').onclick = async () => {
            document.getElementById('actionsModal').classList.remove('active');
            const modal = document.getElementById('customListsModal');
            modal.classList.add('active');
            
            const container = document.getElementById('listsListContainer');
            container.innerHTML = '<div style="padding:20px; text-align:center">Loading...</div>';
            
            const rId = state.currentModalRestaurant.id;
            const listIds = await getRestaurantLists(rId);
            state.selectedLists = new Set(listIds);

            renderCustomListItems();
        };

        function renderCustomListItems() {
            const container = document.getElementById('listsListContainer');
            container.innerHTML = '';
            
            // Filter out default lists from this view
            const customs = state.customLists.filter(l => !['Favorites','Visited','Want to Go'].includes(l.title));
            
            if(customs.length === 0) {
                container.innerHTML = '<div class="empty-lists"><i class="fas fa-list"></i><p>No custom lists yet</p></div>';
            }

            customs.forEach(l => {
                const div = document.createElement('div');
                const isSel = state.selectedLists.has(l.id);
                div.className = `list-item ${isSel ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="list-info">
                        <div class="list-icon">üìã</div>
                        <span class="list-name">${l.title}</span>
                    </div>
                    <div class="list-checkbox ${isSel ? 'checked' : ''}"></div>
                `;
                div.onclick = () => {
                    if(state.selectedLists.has(l.id)) state.selectedLists.delete(l.id);
                    else state.selectedLists.add(l.id);
                    renderCustomListItems(); // Re-render to show check
                };
                container.appendChild(div);
            });
        }

        // Save Custom Lists
        document.getElementById('saveListsBtn').onclick = async () => {
            const rId = state.currentModalRestaurant.id;
            const currentIds = await getRestaurantLists(rId); // Re-fetch absolute truth
            
            const customs = state.customLists.filter(l => !['Favorites','Visited','Want to Go'].includes(l.title));
            
            for(const list of customs) {
                const wasIn = currentIds.has(list.id);
                const nowIn = state.selectedLists.has(list.id);
                
                if(wasIn && !nowIn) {
                    await supabase.from('lists_restraunts').delete().match({list_id: list.id, restraunt_id: rId});
                } else if(!wasIn && nowIn) {
                    await supabase.from('lists_restraunts').insert([{list_id: list.id, restraunt_id: rId}]);
                }
            }
            
            document.getElementById('customListsModal').classList.remove('active');
            showNotification('Lists updated', 'success');
            renderRestaurants(); // update badges on grid
        };

        // Create New List
        document.getElementById('createListBtn').onclick = async () => {
            const input = document.getElementById('newListName');
            const name = input.value.trim();
            if(!name || !state.isLoggedIn) return;
            
            const { data: { user } } = await supabase.auth.getSession().then(res => res.data);
            const { data } = await supabase.from('lists').insert([{user_id: user.id, title: name, description:'Custom list'}]).select().single();
            
            if(data) {
                state.customLists.push(data);
                state.selectedLists.add(data.id); // Auto check new list
                input.value = '';
                renderCustomListItems();
                showNotification('List created', 'success');
            }
        };

        // --- Filtering Logic ---
        function applyFilters() {
            let res = state.restaurants;
            const search = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('categorySelect').value;
            const sort = document.getElementById('sortSelect').value;
            const quickFilter = document.querySelector('.filter-chip.active')?.dataset.filter || 'all';

            // 1. Search
            if(search) res = res.filter(r => r.name.toLowerCase().includes(search));
            
            // 2. Category
            if(cat !== 'all') res = res.filter(r => r.category === cat); 

            // 3. Quick Filter
            if(quickFilter === 'top-rated') res = res.filter(r => r.rating >= 4.5);
            else if(quickFilter === 'trending') res = res.filter(r => r.rating >= 4.0);
            else if(quickFilter === 'new') res = res.filter((r,i) => i % 3 === 0); // Mock 'new' logic

            // 4. Sort
            if(sort === 'rating-desc') res.sort((a,b) => b.rating - a.rating);
            if(sort === 'name-asc') res.sort((a,b) => a.name.localeCompare(b.name));

            state.filtered = res;
            state.currentPage = 1;
            renderRestaurants();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Pagination
            document.getElementById('prevPage').onclick = () => {
                if(state.currentPage > 1) { state.currentPage--; renderRestaurants(); window.scrollTo(0,0); }
            };
            document.getElementById('nextPage').onclick = () => {
                const total = Math.ceil(state.filtered.length / state.pageSize);
                if(state.currentPage < total) { state.currentPage++; renderRestaurants(); window.scrollTo(0,0); }
            };

            // Inputs
            document.getElementById('search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.getElementById('clearSearch').style.display = term ? 'block' : 'none';
                applyFilters();
            });
            document.getElementById('clearSearch').onclick = () => {
                document.getElementById('search').value = '';
                document.getElementById('clearSearch').style.display = 'none';
                applyFilters();
            };
            document.getElementById('categorySelect').onchange = applyFilters;
            document.getElementById('sortSelect').onchange = applyFilters;
            document.getElementById('itemsPerPage').onchange = (e) => {
                state.pageSize = e.target.value === 'all' ? 'all' : parseInt(e.target.value);
                state.currentPage = 1;
                renderRestaurants();
            };
            document.getElementById('resetFilters').onclick = () => {
                document.getElementById('search').value = '';
                document.getElementById('categorySelect').value = 'all';
                applyFilters();
            };

            // Grid Toggle
            document.querySelectorAll('.grid-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.grid-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    elements.grid.className = `grid grid-${btn.dataset.view}`;
                };
            });

            // Quick Filters
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.onclick = () => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    applyFilters();
                };
            });

            // Modal Closes
            document.querySelectorAll('.cancel-btn, .close-lists-btn').forEach(btn => {
                btn.onclick = () => document.querySelectorAll('.actions-modal, .custom-lists-modal, .auth-prompt-modal').forEach(m => m.classList.remove('active'));
            });
        }

        // --- Utils ---
        function showNotification(msg, type) {
            const d = document.createElement('div');
            d.className = `custom-notification notification-${type} notification-show`;
            d.innerHTML = `<span>${msg}</span>`;
            document.getElementById('notificationContainer').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }
        
        function getCategoryIconFallback(name) {
            const map = { 'Burgers':'üçî', 'Pizza':'üçï', 'Asian':'üçú', 'Chicken':'üçó' };
            return map[name] || 'üç¥';
        }

        init();
    })();
  </script>
</body>
</html>