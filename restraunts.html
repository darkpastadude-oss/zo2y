<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zo2y ‚Äî All Restaurants</title>
  
  <!-- Critical CSS Inlined -->
  <style>
    /* Critical CSS only - rest will be loaded async */
    :root { 
      --bg: #0b1633; --card: #132347; --muted: #cbd5e1; --accent: #f59e0b; 
      --glass: rgba(255,255,255,0.03); --white: #ffffff; --border: rgba(255,255,255,0.1);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; } 
    html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; } 
    a { color: inherit; text-decoration: none; } 
    
    /* Critical header styles */
    header { 
      position: sticky; top: 0; z-index: 60; 
      display: flex; align-items: center; gap: 20px; 
      padding: 14px 24px; backdrop-filter: blur(20px) saturate(180%);
      background: rgba(19, 35, 71, 0.8); border-bottom: 1px solid var(--border); 
    } 
    .logo { 
      height: 40px; cursor: pointer;
    }
    .toolbar { 
      display: flex; gap: 12px; margin-left: auto; align-items: center; flex-wrap: wrap; 
    } 
    
    /* Container */
    .container { 
      max-width: 1200px; margin: 24px auto; padding: 0 20px; 
    }
    
    /* Loading skeleton */
    .skeleton {
      background: linear-gradient(90deg, var(--card) 25%, rgba(255,255,255,0.05) 50%, var(--card) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 8px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-img {
      height: 180px;
      width: 100%;
    }
    
    .skeleton-text {
      height: 16px;
      margin-bottom: 8px;
    }
    
    .skeleton-text.short {
      width: 60%;
    }
    
    .grid {
      display: grid;
      gap: 24px;
      grid-template-columns: repeat(4, 1fr);
    }
    
    @media (max-width: 1200px) {
      .grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Prevents FOUC */
    .js-hidden {
      opacity: 0;
      visibility: hidden;
    }
    
    .js-visible {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease;
    }
  </style>
  
  <!-- Non-critical CSS deferred -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
  <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co">
  <link rel="dns-prefetch" href="https://gfkhjbztayjyojsgdpgk.supabase.co">
  
  <!-- Preload critical resources -->
  <link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin>
  <link rel="icon" type="image/png" href="images/logo.png">
  
  <!-- Load non-critical CSS async -->
  <noscript>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  </noscript>
</head>
<body class="js-hidden">
  <header>
    <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
    <div class="toolbar">
      <div class="search">
        <span class="icon">üîé</span>
        <input id="q" placeholder="Search restaurants...">
      </div>
      <button class="btn" id="reset">Reset</button>
      <div class="user-auth">
        <div class="user-welcome" id="userWelcome">
          <div class="user-avatar" id="userAvatar">U</div>
          <span id="userName">User</span>
        </div>
        <button class="auth-btn" id="loginBtn">Sign In</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="login-prompt" id="loginPrompt">
      <h3>‚ú® Get the full experience!</h3>
      <p>Sign in to create favorites lists and save your preferences.</p>
      <button class="auth-btn" onclick="location.href='login.html'">Sign In Now</button>
    </div>
    
    <div class="list-tabs" id="listTabs">
      <button class="list-tab active" data-list="all">All</button>
      <button class="list-tab" data-list="favorites">Favorites <span class="count" id="favoritesCount">0</span></button>
      <button class="list-tab" data-list="visited">Visited <span class="count" id="visitedCount">0</span></button>
      <button class="list-tab" data-list="want-to-go">Want to Go <span class="count" id="wantToGoCount">0</span></button>
    </div>
    
    <div class="controls">
      <div class="controls-info">Loading restaurants...</div>
      <div class="category-filters">
        <div class="category-dropdown">
          <select id="categorySelect">
            <option value="All">All Categories</option>
          </select>
        </div>
      </div>
      <div class="view-controls">
        <div class="grid-size-buttons">
          <button class="grid-btn active" data-view="normal" title="Normal View">
            <i class="fas fa-th"></i>
          </button>
          <button class="grid-btn" data-view="compact" title="Compact View">
            <i class="fas fa-th-large"></i>
          </button>
          <button class="grid-btn" data-view="dense" title="Dense View">
            <i class="fas fa-th-list"></i>
          </button>
        </div>
      </div>
    </div>
    
    <div id="grid" class="grid">
      <!-- Loading skeleton - reduced to 4 for faster initial paint -->
      <div class="tile skeleton">
        <div class="media skeleton-img"></div>
        <div class="inner">
          <div class="skeleton-text"></div>
          <div class="skeleton-text short"></div>
          <div class="skeleton-text"></div>
        </div>
      </div>
      <div class="tile skeleton">
        <div class="media skeleton-img"></div>
        <div class="inner">
          <div class="skeleton-text"></div>
          <div class="skeleton-text short"></div>
          <div class="skeleton-text"></div>
        </div>
      </div>
      <div class="tile skeleton">
        <div class="media skeleton-img"></div>
        <div class="inner">
          <div class="skeleton-text"></div>
          <div class="skeleton-text short"></div>
          <div class="skeleton-text"></div>
        </div>
      </div>
      <div class="tile skeleton">
        <div class="media skeleton-img"></div>
        <div class="inner">
          <div class="skeleton-text"></div>
          <div class="skeleton-text short"></div>
          <div class="skeleton-text"></div>
        </div>
      </div>
    </div>
    <div id="empty" class="empty">
      <div>üçΩÔ∏è</div>
      <h3>No restaurants found</h3>
      <p>Try adjusting your search or filters</p>
    </div>
  </main>

  <!-- Mobile Actions Modal -->
  <div id="mobileActionsModal" class="mobile-actions-modal">
    <div class="mobile-actions-content">
      <div class="mobile-actions-header">
        <h3 id="modalRestaurantName">Restaurant Name</h3>
        <p>Add this restaurant to your lists</p>
      </div>
      <div class="mobile-action-buttons">
        <button class="mobile-action-btn" data-action="favorites" id="modalFavoritesBtn">
          <i class="fas fa-heart"></i>
          <span>Add to Favorites</span>
        </button>
        <button class="mobile-action-btn" data-action="wantToGo" id="modalWantToGoBtn">
          <i class="fas fa-map-marker-alt"></i>
          <span>Want to Go</span>
        </button>
        <button class="mobile-action-btn" data-action="visited" id="modalVisitedBtn">
          <i class="fas fa-utensils"></i>
          <span>Mark as Visited</span>
        </button>
      </div>
      <button class="mobile-cancel-btn" id="modalCancelBtn">Cancel</button>
    </div>
  </div>

  <footer>¬© 2025 Zo2y ‚Äî Built with ‚ù§Ô∏è for food lovers</footer>

  <!-- Notification Container -->
  <div id="notificationContainer" class="notification-container"></div>

  <!-- Load Supabase async -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" async onload="initApp()"></script>

  <!-- Main JS - optimized -->
  <script>
    // Show content once JS loads
    document.body.classList.remove('js-hidden');
    document.body.classList.add('js-visible');
    
    // Single Supabase client instance - FIXED DUPLICATE DECLARATION
    let supabase;
    let supabaseInitialized = false;
    
    // Default fallback images
    const DEFAULT_COVER_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co/storage/v1/object/public/restaurant-images/default-cover.jpg';
    const DEFAULT_LOGO_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co/storage/v1/object/public/restaurant-images/default-logo.jpg';
    
    // Cache for restaurant images
    const restaurantImages = new Map();
    const imageCache = new Map();
    
    // Performance metrics
    const perf = {
      startTime: performance.now(),
      imagesLoaded: 0,
      restaurantsLoaded: 0
    };
    
    // Initialize Supabase and app
    function initApp() {
      if (window.supabase && !supabaseInitialized) {
        const supabaseUrl = "https://gfkhjbztayjyojsgdpgk.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        supabaseInitialized = true;
        
        // Load non-critical CSS
        loadNonCriticalCSS();
        
        // Initialize app
        updateAuthUI();
        listManager.init();
        loadRestaurantsFromSupabase();
        initializeViewControls();
        setupEventListeners();
        
        console.log('üöÄ App initialized in', Math.round(performance.now() - perf.startTime), 'ms');
      }
    }
    
    // Fallback if Supabase fails to load
    setTimeout(() => {
      if (!supabaseInitialized) {
        console.warn('Supabase loading delayed, showing fallback UI');
        document.body.classList.remove('js-hidden');
        document.body.classList.add('js-visible');
        showNotification('Loading content...', 'info');
      }
    }, 3000);
    
    // Load non-critical CSS
    function loadNonCriticalCSS() {
      const style = document.createElement('style');
      style.textContent = `
        /* Full CSS - non-critical styles */
        :root { 
          --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
          --shadow: 0 10px 30px rgba(0,0,0,0.3);
          --success: #10b981; --error: #ef4444; --info: #3b82f6;
          --grid-columns: 4;
        }
        
        img { display: block; max-width: 100%; height: auto; opacity: 0; transition: opacity 0.3s ease; }
        img.loaded { opacity: 1; }
        
        /* Enhanced Header */
        .logo:hover { transform: scale(1.05) rotate(-2deg); filter: drop-shadow(0 6px 12px rgba(245,158,11,0.3)); }
        .search { width: 280px; position: relative; } 
        .search input { 
          width: 100%; padding: 10px 16px 10px 40px; border-radius: 20px; 
          border: 1px solid var(--border); background: var(--card); color: var(--white); 
          outline: none; font-size: 14px; transition: all 0.3s ease;
        } 
        .search input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); } 
        .search .icon { 
          position: absolute; left: 12px; top: 50%; transform: translateY(-50%); 
          opacity: 0.85; transition: all 0.3s ease;
        }
        .search input:focus + .icon { opacity: 1; color: var(--accent); }
        .btn { 
          background: var(--card); border: 1px solid var(--border); color: var(--white); 
          padding: 8px 16px; border-radius: 16px; cursor: pointer; font-size: 13px; 
          font-weight: 500; transition: all 0.3s ease;
        } 
        .btn:hover { 
          background: var(--accent); color: #0b1633; transform: translateY(-2px);
          box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }
        
        /* Enhanced User Auth */
        .auth-btn { 
          background: var(--gradient); color: #0b1633; border: none; 
          padding: 8px 16px; border-radius: 16px; cursor: pointer; 
          font-size: 13px; font-weight: 600; transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        } 
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(245,158,11,0.4); }
        .user-welcome { 
          display: none; align-items: center; gap: 8px; font-size: 13px; 
          cursor: pointer; padding: 6px 12px; border-radius: 16px; 
          transition: all 0.3s ease; font-weight: 500;
        } 
        .user-welcome:hover { background: var(--accent); color: #0b1633; transform: translateY(-2px); } 
        .user-avatar { 
          width: 32px; height: 32px; border-radius: 50%; background: var(--gradient); 
          display: flex; align-items: center; justify-content: center; 
          font-weight: bold; color: #0b1633; font-size: 14px; 
          box-shadow: 0 4px 8px rgba(245,158,11,0.3);
        }
        
        /* Enhanced Container */
        .login-prompt { 
          display: none; background: var(--card); border: 1px solid var(--accent); 
          border-radius: 16px; padding: 20px; margin: 20px 0; text-align: center;
          backdrop-filter: blur(10px);
        }
        .login-prompt h3 {
          background: var(--gradient);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin-bottom: 8px;
        }
        
        /* Enhanced List Tabs */
        .list-tabs { 
          display: none; gap: 8px; margin-bottom: 20px; 
          border-bottom: 1px solid var(--border); padding-bottom: 12px; overflow-x: auto; 
        } 
        .list-tab { 
          background: var(--card); border: 1px solid var(--border); color: var(--white); 
          padding: 8px 16px; border-radius: 16px; cursor: pointer; font-size: 13px; 
          white-space: nowrap; transition: all 0.3s ease; font-weight: 500;
        } 
        .list-tab.active { 
          background: var(--gradient); color: #0b1633; border-color: var(--accent);
          box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        } 
        .list-tab .count { 
          background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 8px; 
          font-size: 11px; margin-left: 6px; font-weight: 600;
        }
        
        /* Enhanced Controls */
        .controls { 
          display: flex; gap: 12px; align-items: center; margin-bottom: 24px; flex-wrap: wrap; 
        } 
        .controls-info { color: var(--muted); font-size: 14px; font-weight: 500; } 
        .view-controls { 
          display: flex; align-items: center; gap: 8px; margin-left: auto; 
        }
        .grid-size-buttons { 
          display: flex; gap: 4px; background: var(--card); 
          border: 1px solid var(--border); border-radius: 16px; padding: 4px;
        }
        .grid-btn { 
          width: 36px; height: 36px; display: flex; align-items: center; 
          justify-content: center; border-radius: 12px; cursor: pointer;
          background: transparent; border: none; color: var(--muted);
          transition: all 0.3s ease;
        }
        .grid-btn:hover { background: rgba(255,255,255,0.1); color: var(--white); }
        .grid-btn.active { background: var(--accent); color: #0b1633; }
        .category-filters { } 
        .category-dropdown select { 
          background: var(--card); border: 1px solid var(--border); color: var(--white); 
          padding: 8px 12px; border-radius: 16px; cursor: pointer; font-size: 13px;
          transition: all 0.3s ease;
        }
        .category-dropdown select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2); }
        
        /* Grid variations */
        .grid-compact { grid-template-columns: repeat(var(--grid-columns), 1fr); }
        .grid-dense { grid-template-columns: repeat(var(--grid-columns), 1fr); }
        
        /* Restaurant Card */
        .tile { 
          background: var(--card); 
          border-radius: 20px; 
          overflow: hidden; 
          box-shadow: 0 6px 16px rgba(0,0,0,0.1); 
          border: 2px solid transparent;
          cursor: pointer; 
          position: relative; 
          transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        } 
        .tile:hover { 
          transform: translateY(-8px); 
          box-shadow: 0 20px 40px rgba(0,0,0,0.2);
          border-color: var(--accent);
        }
        
        /* Enhanced Image Container */
        .tile .media {
          height: 180px;
          overflow: hidden;
          background: linear-gradient(135deg, rgba(19, 35, 71, 0.8), rgba(11, 22, 51, 0.9));
          position: relative;
          cursor: pointer;
          -webkit-tap-highlight-color: transparent;
          user-select: none;
        }
        .tile .food-image {
          width: 100%;
          height: 100%;
          object-fit: cover;
          transition: transform 0.6s ease;
        }
        .tile .logo-overlay {
          position: absolute;
          bottom: 16px;
          left: 16px;
          width: 64px;
          height: 64px;
          background: rgba(11, 22, 51, 0.9);
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 6px;
          border: 2px solid var(--accent);
          backdrop-filter: blur(10px);
          z-index: 20;
          transition: all 0.3s ease;
          box-shadow: 0 6px 20px rgba(0,0,0,0.4);
          pointer-events: none;
        }
        .tile .logo-overlay img {
          width: 100%;
          height: 100%;
          object-fit: contain;
          pointer-events: none;
        }
        .tile:hover .food-image { transform: scale(1.1); }
        .tile:hover .logo-overlay {
          transform: scale(1.1);
          border-color: var(--accent);
          background: rgba(245,158,11,0.9);
          box-shadow: 0 8px 24px rgba(245,158,11,0.4);
        }
        
        /* Mobile menu button */
        .mobile-menu-btn {
          position: absolute;
          top: 12px;
          right: 12px;
          width: 40px;
          height: 40px;
          background: rgba(11, 22, 51, 0.9);
          border: 2px solid var(--accent);
          border-radius: 12px;
          display: none;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          z-index: 25;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .mobile-menu-btn:hover { background: var(--accent); transform: scale(1.1); }
        .mobile-menu-btn i { color: var(--white); font-size: 18px; }
        .mobile-menu-btn:hover i { color: #0b1633; }
        
        /* Mobile Actions Modal */
        .mobile-actions-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(11, 22, 51, 0.95);
          backdrop-filter: blur(20px);
          z-index: 1000;
          align-items: center;
          justify-content: center;
          padding: 20px;
          opacity: 0;
          transition: opacity 0.3s ease;
        }
        .mobile-actions-modal.active { display: flex; opacity: 1; }
        .mobile-actions-content {
          background: var(--card);
          border-radius: 20px;
          padding: 30px;
          max-width: 400px;
          width: 100%;
          border: 2px solid var(--accent);
          box-shadow: 0 25px 50px rgba(0,0,0,0.3);
          animation: modalSlideIn 0.3s ease-out;
          text-align: center;
        }
        @keyframes modalSlideIn {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        .mobile-actions-header { margin-bottom: 24px; }
        .mobile-actions-header h3 { font-size: 22px; margin-bottom: 8px; color: var(--white); font-weight: 600; }
        .mobile-actions-header p { color: var(--muted); font-size: 14px; }
        .mobile-action-buttons { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
        .mobile-action-btn {
          background: var(--bg);
          border: 1px solid var(--border);
          color: var(--white);
          padding: 16px 20px;
          border-radius: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          display: flex;
          align-items: center;
          gap: 12px;
          text-align: left;
          font-size: 15px;
        }
        .mobile-action-btn:hover {
          background: var(--accent);
          color: #0b1633;
          transform: translateY(-2px);
          border-color: var(--accent);
          box-shadow: 0 4px 12px rgba(245,158,11,0.3);
        }
        .mobile-action-btn.active { background: var(--accent); color: #0b1633; border-color: var(--accent); }
        .mobile-action-btn i { font-size: 18px; width: 24px; }
        .mobile-cancel-btn {
          background: transparent;
          color: var(--muted);
          border: 1px solid var(--border);
          padding: 14px 20px;
          border-radius: 16px;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          width: 100%;
        }
        .mobile-cancel-btn:hover { background: rgba(255,255,255,0.05); color: var(--white); }
        
        /* PC List Actions */
        .list-actions { 
          position: absolute; top: 16px; right: 16px; display: flex; 
          flex-direction: column; gap: 10px; opacity: 0; z-index: 10; 
          transition: all 0.3s ease;
        } 
        .tile:hover .list-actions { opacity: 1; } 
        .list-btn { 
          background: rgba(11, 22, 51, 0.95); 
          border: 2px solid var(--accent); 
          color: var(--white); 
          padding: 10px; 
          border-radius: 14px; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          cursor: pointer; 
          font-size: 16px; 
          backdrop-filter: blur(10px); 
          width: 50px; 
          height: 50px; 
          transition: all 0.3s ease;
        } 
        .list-btn:hover { 
          transform: scale(1.15); 
          background: var(--accent); 
          color: #0b1633; 
          border-color: var(--accent); 
          box-shadow: 0 6px 16px rgba(245,158,11,0.4);
        } 
        .list-btn.active { background: var(--accent); color: #0b1633; border-color: var(--accent); transform: scale(1.1); } 
        
        .tile .inner { padding: 20px; } 
        .tile h3 { margin: 0 0 10px 0; font-size: 18px; font-weight: 700; line-height: 1.3; } 
        .tile .category { 
          color: var(--muted); 
          font-size: 13px; 
          margin: 0 0 10px 0; 
          display: flex; 
          align-items: center; 
          gap: 8px;
        } 
        .tile .rating { color: var(--accent); font-weight: 800; font-size: 15px; } 
        .tile .desc { 
          color: var(--muted); 
          font-size: 14px; 
          margin: 12px 0 0 0; 
          line-height: 1.5; 
          display: -webkit-box; 
          -webkit-line-clamp: 3; 
          -webkit-box-orient: vertical; 
          overflow: hidden; 
        }
        
        /* Enhanced Empty State */
        .empty { 
          padding: 60px 20px; text-align: center; color: var(--muted); display: none; 
        }
        .empty div { font-size: 48px; margin-bottom: 16px; }
        .empty h3 { margin-bottom: 8px; font-size: 20px; }
        
        /* Enhanced Footer */
        footer { 
          padding: 30px 20px; color: var(--muted); text-align: center; 
          border-top: 1px solid var(--border); margin-top: 40px; 
          background: var(--card);
        }
        
        /* Enhanced Custom Notification */
        .notification-container {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 1000;
          display: flex;
          flex-direction: column;
          gap: 10px;
          max-width: 400px;
        }
        .custom-notification {
          padding: 16px 20px;
          border-radius: 12px;
          box-shadow: var(--shadow);
          display: flex;
          align-items: center;
          transform: translateX(120%);
          transition: transform 0.4s ease;
          backdrop-filter: blur(10px);
          border: 1px solid var(--border);
        }
        .notification-success { background: rgba(16, 185, 129, 0.9); color: white; }
        .notification-error { background: rgba(239, 68, 68, 0.9); color: white; }
        .notification-info { background: rgba(59, 130, 246, 0.9); color: white; }
        .notification-show { transform: translateY(0); }
        .notification-icon { margin-right: 12px; font-size: 1.2rem; }
        .notification-close {
          margin-left: auto;
          background: none;
          border: none;
          color: white;
          cursor: pointer;
          font-size: 1rem;
          opacity: 0.7;
          transition: opacity 0.2s;
        }
        .notification-close:hover { opacity: 1; }
        
        /* Mobile styles */
        @media (max-width: 768px) {
          .mobile-menu-btn { display: flex; }
          .list-actions { display: none !important; }
          .tile .logo-overlay { width: 48px; height: 48px; bottom: 12px; left: 12px; border-radius: 10px; }
          header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; } 
          .toolbar { margin-left: 0; width: 100%; justify-content: space-between; } 
          .search { width: 200px; } 
          .view-controls { order: 3; width: 100%; margin-left: 0; margin-top: 12px; justify-content: center; }
          .grid { gap: 16px; }
          .grid-compact .tile .media { height: 140px; } 
          .grid-dense .tile .media { height: 100px; } 
          .tile .media { height: 160px; } 
          .tile .inner { padding: 16px; } 
          .tile h3 { font-size: 16px; } 
          .tile .desc { font-size: 13px; -webkit-line-clamp: 2; } 
          .list-btn { width: 40px; height: 40px; font-size: 16px; background: rgba(11, 22, 51, 0.95); border: 1.5px solid var(--border); } 
          .list-btn.active { background: var(--accent); } 
          .user-welcome { padding: 6px 10px; font-size: 12px; } 
          .user-avatar { width: 28px; height: 28px; font-size: 12px; } 
        }
        
        @media (max-width: 480px) {
          .grid-compact { grid-template-columns: repeat(3, 1fr); }
          .grid-dense { grid-template-columns: repeat(4, 1fr); }
          .grid-compact .tile .media { height: 120px; }
          .grid-dense .tile .media { height: 90px; }
          .grid-dense .tile h3 { font-size: 14px; }
          .grid-dense .tile .category { font-size: 11px; }
          .search { width: 160px; } 
          .toolbar { gap: 8px; } 
          .list-btn { width: 36px; height: 36px; font-size: 14px; } 
          .user-welcome span { display: none; } 
          .user-welcome { padding: 8px; } 
          .container { padding: 0 16px; }
          .controls { flex-direction: column; align-items: flex-start; }
          .category-filters { width: 100%; }
          .category-dropdown select { width: 100%; }
          .tile .logo-overlay { width: 40px; height: 40px; bottom: 10px; left: 10px; border-radius: 8px; }
          .mobile-menu-btn { width: 36px; height: 36px; top: 10px; right: 10px; }
        }
        
        @media (max-width: 360px) {
          .grid-compact { grid-template-columns: repeat(2, 1fr); }
          .grid-dense { grid-template-columns: repeat(3, 1fr); }
        }
        
        @media (hover: none) and (pointer: coarse) { 
          .list-actions { display: none !important; } 
          .list-btn:hover { transform: none; } 
          .tile:hover { transform: none; }
          .tile:hover .food-image { transform: none; }
          .tile:hover .logo-overlay { transform: none; }
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
          .tile, .list-btn, .btn, .auth-btn, .user-welcome, .notification-show,
          .food-image, .logo-overlay, .mobile-actions-modal {
            transition: none !important;
            animation: none !important;
          }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Setup event listeners
    function setupEventListeners() {
      const qInput = document.getElementById('q');
      const categorySelect = document.getElementById('categorySelect');
      const resetBtn = document.getElementById('reset');
      
      // Debounced search
      let debounceTimer;
      qInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => filterAndRender(), 300);
      });
      
      categorySelect.addEventListener('change', () => filterAndRender());
      resetBtn.addEventListener('click', () => {
        qInput.value = ''; 
        categorySelect.value = 'All'; 
        currentList = 'all';
        document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
        document.querySelector('[data-list="all"]').classList.add('active');
        filterAndRender();
      });
      
      // List tabs
      document.querySelectorAll('.list-tab').forEach(tab => {
        tab.addEventListener('click', async () => {
          const { data: { session } } = await supabase.auth.getSession();
          if (!session) return;
          document.querySelectorAll('.list-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentList = tab.dataset.list;
          filterAndRender();
        });
      });
    }
    
    // ---------- LAZY LOADING & IMAGE OPTIMIZATION ----------
    let imageObserver;
    
    function initLazyLoading() {
      imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.getAttribute('data-src');
            
            if (src) {
              // Use cached image if available
              if (imageCache.has(src)) {
                img.src = imageCache.get(src);
                img.classList.add('loaded');
                observer.unobserve(img);
              } else {
                // Load with priority for above-fold images
                const priority = entry.intersectionRatio > 0.5 ? 'high' : 'low';
                loadImage(img, src, priority).then(() => {
                  observer.unobserve(img);
                });
              }
            }
          }
        });
      }, {
        rootMargin: '50px 0px',
        threshold: [0.1, 0.5]
      });
    }
    
    async function loadImage(img, src, priority = 'low') {
      return new Promise((resolve) => {
        const image = new Image();
        
        if (priority === 'high') {
          image.fetchPriority = 'high';
        }
        
        image.onload = () => {
          img.src = src;
          img.classList.add('loaded');
          imageCache.set(src, src);
          perf.imagesLoaded++;
          resolve();
        };
        
        image.onerror = () => {
          // Fallback to default
          img.src = img.classList.contains('food-image') ? DEFAULT_COVER_URL : DEFAULT_LOGO_URL;
          img.classList.add('loaded');
          resolve();
        };
        
        image.src = src;
      });
    }
    
    // ---------- ACCOUNT SYSTEM ----------
    const userWelcome = document.getElementById('userWelcome');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const loginBtn = document.getElementById('loginBtn');
    
    async function updateAuthUI() {
      if (!supabaseInitialized) return;
      
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          console.warn('supabase getSession err', error);
          return;
        }
        
        if (session && session.user) {
          const userId = session.user.id;
          let username = null;
          
          // Fetch profile
          try {
            const { data: profile, error: profileError } = await supabase
              .from('user_profiles')
              .select('username, full_name, avatar_url')
              .eq('id', userId)
              .limit(1)
              .maybeSingle();
            
            if (!profileError && profile) {
              username = profile.username || profile.full_name || null;
              try { localStorage.setItem('zo2y_user', JSON.stringify(profile)); } catch(e){}
            }
          } catch (err) {
            console.warn('profile fetch error', err);
          }
          
          const displayName = username || session.user.user_metadata?.username || session.user.email?.split('@')[0] || 'User';
          
          userWelcome.style.display = 'flex';
          loginBtn.style.display = 'none';
          document.getElementById('listTabs').style.display = 'flex';
          document.getElementById('loginPrompt').style.display = 'none';
          
          userName.textContent = displayName;
          userAvatar.textContent = displayName.charAt(0).toUpperCase();
          userWelcome.onclick = (e) => {
            e.preventDefault();
            safeGoToProfile();
          };
          
        } else {
          userWelcome.style.display = 'none';
          loginBtn.style.display = 'block';
          document.getElementById('listTabs').style.display = 'none';
          document.getElementById('loginPrompt').style.display = 'block';
          
          try { localStorage.removeItem('zo2y_user'); } catch(e){}
          loginBtn.onclick = () => location.href = 'login.html';
        }
      } catch (e) {
        console.error('updateAuthUI error', e);
        userWelcome.style.display = 'none';
        loginBtn.style.display = 'block';
        document.getElementById('listTabs').style.display = 'none';
        document.getElementById('loginPrompt').style.display = 'block';
        loginBtn.onclick = () => location.href = 'login.html';
      }
    }
    
    async function safeGoToProfile() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session && session.user) {
          window.location.href = 'profile.html';
        } else {
          window.location.href = 'login.html';
        }
      } catch (err) {
        console.error('safeGoToProfile err', err);
        window.location.href = 'login.html';
      }
    }
    
    // ---------- NOTIFICATION SYSTEM ----------
    const notificationQueue = [];
    let isShowingNotification = false;
    
    function showNotification(message, type = "info", duration = 2500) {
      notificationQueue.push({ message, type, duration });
      processNotificationQueue();
    }
    
    function processNotificationQueue() {
      if (isShowingNotification || notificationQueue.length === 0) return;
      
      isShowingNotification = true;
      const { message, type, duration } = notificationQueue.shift();
      
      const notificationContainer = document.getElementById("notificationContainer");
      const notification = document.createElement("div");
      notification.className = `custom-notification notification-${type}`;
      
      let iconClass;
      if (type === "success") iconClass = "fas fa-check-circle";
      else if (type === "error") iconClass = "fas fa-exclamation-circle";
      else iconClass = "fas fa-info-circle";
      
      notification.innerHTML = `
        <i class="notification-icon ${iconClass}"></i>
        <span class="notification-message">${message}</span>
        <button class="notification-close" aria-label="Close notification">√ó</button>
      `;
      
      notificationContainer.appendChild(notification);
      
      setTimeout(() => notification.classList.add("notification-show"), 10);
      
      notification.querySelector('.notification-close').addEventListener('click', () => {
        hideNotification(notification);
      });
      
      setTimeout(() => {
        if (notification.parentNode) hideNotification(notification);
      }, duration);
    }
    
    function hideNotification(notification) {
      notification.classList.remove("notification-show");
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
        isShowingNotification = false;
        processNotificationQueue();
      }, 400);
    }
    
    // ---------- GRID VIEW CONTROLS ----------
    let currentView = 'normal';
    
    function initializeViewControls() {
      const gridButtons = document.querySelectorAll('.grid-btn');
      const grid = document.getElementById('grid');
      
      gridButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const view = btn.dataset.view;
          gridButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          grid.classList.remove('grid-compact', 'grid-dense');
          if (view === 'compact') grid.classList.add('grid-compact');
          else if (view === 'dense') grid.classList.add('grid-dense');
          
          currentView = view;
          
          try {
            localStorage.setItem('zo2y_grid_view', view);
          } catch (e) {}
        });
      });
      
      try {
        const savedView = localStorage.getItem('zo2y_grid_view');
        if (savedView) {
          const savedBtn = document.querySelector(`.grid-btn[data-view="${savedView}"]`);
          if (savedBtn) savedBtn.click();
        }
      } catch (e) {}
    }
    
    // ---------- MOBILE MODAL FUNCTIONS ----------
    const mobileActionsModal = document.getElementById('mobileActionsModal');
    const modalRestaurantName = document.getElementById('modalRestaurantName');
    const modalFavoritesBtn = document.getElementById('modalFavoritesBtn');
    const modalWantToGoBtn = document.getElementById('modalWantToGoBtn');
    const modalVisitedBtn = document.getElementById('modalVisitedBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    let currentMobileRestaurant = null;
    
    function showMobileModal(restaurantData) {
      if (!restaurantData) return;
      
      currentMobileRestaurant = restaurantData;
      modalRestaurantName.textContent = restaurantData.name;
      updateMobileModalButtons(restaurantData.id);
      mobileActionsModal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function hideMobileModal() {
      mobileActionsModal.classList.remove('active');
      document.body.style.overflow = 'auto';
      currentMobileRestaurant = null;
    }
    
    function updateMobileModalButtons(restaurantId) {
      const isFavorite = listManager.isInList('favorites', restaurantId);
      const isWantToGo = listManager.isInList('wantToGo', restaurantId);
      const isVisited = listManager.isInList('visited', restaurantId);
      
      modalFavoritesBtn.innerHTML = `<i class="fas fa-heart"></i><span>${isFavorite ? 'Remove from Favorites' : 'Add to Favorites'}</span>`;
      modalFavoritesBtn.classList.toggle('active', isFavorite);
      
      modalWantToGoBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${isWantToGo ? 'Remove from Want to Go' : 'Add to Want to Go'}</span>`;
      modalWantToGoBtn.classList.toggle('active', isWantToGo);
      
      modalVisitedBtn.innerHTML = `<i class="fas fa-utensils"></i><span>${isVisited ? 'Remove from Visited' : 'Mark as Visited'}</span>`;
      modalVisitedBtn.classList.toggle('active', isVisited);
    }
    
    // Modal event listeners
    modalFavoritesBtn.addEventListener('click', async () => {
      if (!currentMobileRestaurant) return;
      const wasAdded = await listManager.toggleInList('favorites', currentMobileRestaurant.id);
      updateMobileModalButtons(currentMobileRestaurant.id);
      showNotification(wasAdded ? 'Added to Favorites' : 'Removed from Favorites', wasAdded ? 'success' : 'info');
    });
    
    modalWantToGoBtn.addEventListener('click', async () => {
      if (!currentMobileRestaurant) return;
      const wasAdded = await listManager.toggleInList('wantToGo', currentMobileRestaurant.id);
      updateMobileModalButtons(currentMobileRestaurant.id);
      showNotification(wasAdded ? 'Added to Want to Go' : 'Removed from Want to Go', wasAdded ? 'success' : 'info');
    });
    
    modalVisitedBtn.addEventListener('click', async () => {
      if (!currentMobileRestaurant) return;
      const wasAdded = await listManager.toggleInList('visited', currentMobileRestaurant.id);
      updateMobileModalButtons(currentMobileRestaurant.id);
      showNotification(wasAdded ? 'Added to Visited' : 'Removed from Visited', wasAdded ? 'success' : 'info');
    });
    
    modalCancelBtn.addEventListener('click', hideMobileModal);
    mobileActionsModal.addEventListener('click', (e) => {
      if (e.target === mobileActionsModal) hideMobileModal();
    });
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && mobileActionsModal.classList.contains('active')) {
        hideMobileModal();
      }
    });
    
    // ---------- LIST MANAGEMENT ----------
    const listManager = {
      userLists: [],
      currentLists: {
        favorites: null,
        visited: null,
        wantToGo: null
      },
      
      async init() { 
        if (!supabaseInitialized) return;
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) return;
        await this.loadUserLists();
        this.updateListCounts();
      },
      
      async loadUserLists() {
        try {
          const { data: { user } } = await supabase.auth.getUser();
          if (!user) return;
          
          const { data: lists, error } = await supabase
            .from('lists')
            .select('*')
            .eq('user_id', user.id);
          
          if (error) throw error;
          this.userLists = lists || [];
          await this.setupDefaultLists();
          await this.loadListRestaurants();
          
        } catch (error) {
          console.error('Error loading lists:', error);
        }
      },
      
      async setupDefaultLists() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;
        
        this.currentLists.favorites = this.userLists.find(list => list.title === 'Favorites');
        this.currentLists.visited = this.userLists.find(list => list.title === 'Visited'); 
        this.currentLists.wantToGo = this.userLists.find(list => list.title === 'Want to Go');
        
        if (!this.currentLists.favorites) {
          this.currentLists.favorites = await this.createList('Favorites', 'My favorite restaurants');
        }
        if (!this.currentLists.visited) {
          this.currentLists.visited = await this.createList('Visited', 'Restaurants I have visited');
        }
        if (!this.currentLists.wantToGo) {
          this.currentLists.wantToGo = await this.createList('Want to Go', 'Restaurants I want to try');
        }
      },
      
      async createList(title, description) {
        const { data: { user } } = await supabase.auth.getUser();
        
        const { data: newList, error } = await supabase
          .from('lists')
          .insert([{ user_id: user.id, title, description }])
          .select()
          .single();
        
        if (error) {
          console.error('Error creating list:', error);
          return null;
        }
        
        this.userLists.push(newList);
        return newList;
      },
      
      async loadListRestaurants() {
        for (const listType in this.currentLists) {
          const list = this.currentLists[listType];
          if (list) {
            const { data: listRestaurants, error } = await supabase
              .from('lists_restraunts')
              .select('restraunt_id')
              .eq('list_id', list.id);
            
            if (!error && listRestaurants) {
              list.restaurants = listRestaurants.map(item => item.restraunt_id);
            } else {
              list.restaurants = [];
            }
          }
        }
      },
      
      updateListCounts() {
        if (this.currentLists.favorites) {
          document.getElementById('favoritesCount').textContent = this.currentLists.favorites.restaurants?.length || 0;
        }
        if (this.currentLists.visited) {
          document.getElementById('visitedCount').textContent = this.currentLists.visited.restaurants?.length || 0;
        }
        if (this.currentLists.wantToGo) {
          document.getElementById('wantToGoCount').textContent = this.currentLists.wantToGo.restaurants?.length || 0;
        }
      },
      
      async toggleInList(listType, restaurantId) {
        const list = this.currentLists[listType];
        if (!list) return false;
        
        const isInList = list.restaurants?.includes(restaurantId);
        
        try {
          if (isInList) {
            const { error } = await supabase
              .from('lists_restraunts')
              .delete()
              .match({ list_id: list.id, restraunt_id: restaurantId });
            
            if (error) throw error;
            list.restaurants = list.restaurants.filter(id => id !== restaurantId);
            showNotification(`Removed from ${list.title}`, "info");
          } else {
            const { error } = await supabase
              .from('lists_restraunts')
              .insert([{ list_id: list.id, restraunt_id: restaurantId, added_at: new Date().toISOString() }]);
            
            if (error) throw error;
            if (!list.restaurants) list.restaurants = [];
            list.restaurants.push(restaurantId);
            showNotification(`Added to ${list.title}`, "success");
          }
          
          this.updateListCounts();
          return !isInList;
        } catch (error) {
          console.error('Error updating list:', error);
          showNotification('Error saving changes', 'error');
          return isInList;
        }
      },
      
      isInList(listType, restaurantId) {
        const list = this.currentLists[listType];
        return list?.restaurants?.includes(restaurantId) || false;
      }
    };
    
    // ---------- RESTAURANT DATA ----------
    let restaurants = [];
    let categories = new Set();
    let currentList = 'all';
    let isRendering = false;
    
    async function loadRestaurantsFromSupabase() {
      if (!supabaseInitialized) {
        setTimeout(loadRestaurantsFromSupabase, 500);
        return;
      }
      
      try {
        showLoadingSkeleton();
        initLazyLoading();
        
        console.log("üîÑ Loading restaurants from Supabase...");
        
        // Load images first (optimized query)
        await loadAllRestaurantImages();
        
        // Load restaurants with optimized query
        const { data, error } = await supabase
          .from('restraunts')
          .select('id, slug, name, category, description, rating, logo_url, image')
          .order('rating', { ascending: false });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          showNoRestaurantsFound();
          return;
        }
        
        // Process restaurants with dynamic images
        restaurants = data.map(restaurant => ({
          id: restaurant.id,
          slug: restaurant.slug,
          name: restaurant.name,
          category: restaurant.category,
          desc: restaurant.description,
          rating: restaurant.rating,
          logo_url: getLogoUrl(restaurant),
          food_image: getCoverImageUrl(restaurant.slug)
        }));
        
        perf.restaurantsLoaded = restaurants.length;
        
        // Extract unique categories
        categories = new Set(restaurants.map(r => r.category).filter(Boolean));
        
        // Populate category dropdown
        populateCategoryDropdown();
        
        // Render initial list
        await filterAndRender();
        
        console.log(`‚úÖ Loaded ${restaurants.length} restaurants in ${Math.round(performance.now() - perf.startTime)}ms`);
        showNotification(`Loaded ${restaurants.length} restaurants`, 'success');
        
      } catch (error) {
        console.error('‚ùå Error loading restaurants:', error);
        showErrorState(error);
      }
    }
    
    async function loadAllRestaurantImages() {
      try {
        console.log("üîÑ Loading restaurant images...");
        
        const { data, error } = await supabase
          .from('restaurant_gallery')
          .select('restaurant_slug, image_url, image_type, is_primary')
          .order('sort_order', { ascending: true });
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          data.forEach(item => {
            if (!restaurantImages.has(item.restaurant_slug)) {
              restaurantImages.set(item.restaurant_slug, {
                cover: DEFAULT_COVER_URL,
                logo: DEFAULT_LOGO_URL
              });
            }
            
            const images = restaurantImages.get(item.restaurant_slug);
            
            if (item.image_type === 'cover') {
              if (item.is_primary || images.cover === DEFAULT_COVER_URL) {
                images.cover = item.image_url;
              }
            }
            
            if (item.image_type === 'logo') {
              if (item.is_primary || images.logo === DEFAULT_LOGO_URL) {
                images.logo = item.image_url;
              }
            }
          });
          
          console.log(`‚úÖ Loaded images for ${restaurantImages.size} restaurants`);
        }
      } catch (error) {
        console.error('Error loading restaurant images:', error);
      }
    }
    
    function getCoverImageUrl(restaurantSlug) {
      const images = restaurantImages.get(restaurantSlug);
      return images?.cover || DEFAULT_COVER_URL;
    }
    
    function getLogoUrl(restaurant) {
      // Try from cached gallery images
      const cachedImages = restaurantImages.get(restaurant.slug);
      if (cachedImages?.logo && cachedImages.logo !== DEFAULT_LOGO_URL) {
        return cachedImages.logo;
      }
      
      // Try from restaurant data
      if (restaurant.logo_url) return restaurant.logo_url;
      if (restaurant.image) return restaurant.image;
      
      return DEFAULT_LOGO_URL;
    }
    
    function populateCategoryDropdown() {
      const categorySelect = document.getElementById('categorySelect');
      categorySelect.innerHTML = '<option value="All">All Categories</option>';
      
      Array.from(categories).sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }
    
    function showLoadingSkeleton() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';
      
      let count = 4; // Reduced for faster initial paint
      if (currentView === 'compact') count = 6;
      if (currentView === 'dense') count = 8;
      
      for (let i = 0; i < count; i++) {
        const skeletonCard = document.createElement('div');
        skeletonCard.className = 'tile skeleton';
        skeletonCard.innerHTML = `
          <div class="media skeleton-img"></div>
          <div class="inner">
            <div class="skeleton-text"></div>
            <div class="skeleton-text short"></div>
            <div class="skeleton-text"></div>
          </div>
        `;
        grid.appendChild(skeletonCard);
      }
    }
    
    function showNoRestaurantsFound() {
      document.getElementById('grid').innerHTML = '';
      document.getElementById('empty').style.display = 'block';
      document.getElementById('empty').innerHTML = `
        <div>üì≠</div>
        <h3>No restaurants in database</h3>
        <p>Add restaurants to your Supabase 'restraunts' table</p>
      `;
    }
    
    function showErrorState(error) {
      let errorMessage = 'Error loading restaurants. ';
      if (error.message?.includes('JWT')) {
        errorMessage += 'Authentication error. Please refresh.';
      } else if (error.code === 'PGRST116') {
        errorMessage += 'Table "restraunts" not found. Check table name.';
      } else {
        errorMessage += 'Please check your connection and refresh.';
      }
      
      document.getElementById('grid').innerHTML = '';
      document.getElementById('empty').style.display = 'block';
      document.getElementById('empty').innerHTML = `
        <div>‚ö†Ô∏è</div>
        <h3>Error loading restaurants</h3>
        <p>${errorMessage}</p>
        <button class="btn" onclick="location.reload()" style="margin-top: 10px;">Refresh Page</button>
      `;
    }
    
    // ---------- RENDERING ----------
    async function renderList(list) {
      if (isRendering) return;
      isRendering = true;
      
      const grid = document.getElementById('grid');
      const empty = document.getElementById('empty');
      
      if (!list || !list.length) { 
        empty.style.display = 'block'; 
        grid.style.display = 'none'; 
        document.getElementById('count').textContent = '0'; 
        isRendering = false;
        return; 
      }
      
      empty.style.display = 'none'; 
      grid.style.display = 'grid'; 
      document.getElementById('count').textContent = list.length;
      
      const { data: { session } } = await supabase.auth.getSession();
      const isLoggedIn = !!session;
      const isMobile = window.innerWidth <= 768;
      
      grid.innerHTML = '';
      
      // Render in batches for better performance
      const batchSize = 12;
      let batchIndex = 0;
      
      function renderBatch() {
        const end = Math.min(batchIndex + batchSize, list.length);
        
        for (let i = batchIndex; i < end; i++) {
          const r = list[i];
          createRestaurantCard(r, isLoggedIn, isMobile);
        }
        
        batchIndex = end;
        
        if (batchIndex < list.length) {
          requestAnimationFrame(renderBatch);
        } else {
          isRendering = false;
        }
      }
      
      renderBatch();
    }
    
    function createRestaurantCard(restaurant, isLoggedIn, isMobile) {
      const grid = document.getElementById('grid');
      const tile = document.createElement('div');
      tile.className = 'tile';
      
      const clickableContent = document.createElement('a');
      clickableContent.href = `restaurant.html?slug=${restaurant.slug}`;
      clickableContent.style.cssText = 'text-decoration: none; color: inherit; display: block; height: 100%;';
      
      clickableContent.innerHTML = `
        <div class="media">
          <img class="food-image" data-src="${restaurant.food_image}" alt="${restaurant.name} food" loading="lazy">
          <div class="logo-overlay">
            <img data-src="${restaurant.logo_url}" alt="${restaurant.name} logo" loading="lazy">
          </div>
          ${isMobile && isLoggedIn ? '<div class="mobile-menu-btn"><i class="fas fa-ellipsis-h"></i></div>' : ''}
        </div>
        <div class="inner">
          <h3>${restaurant.name}</h3>
          <div class="category"><span class="rating">‚≠ê ${restaurant.rating}</span> ‚Ä¢ ${restaurant.category || 'Restaurant'}</div>
          <p class="desc">${restaurant.desc || 'Delicious food served with care'}</p>
        </div>
      `;
      
      tile.appendChild(clickableContent);
      tile.dataset.restaurantId = restaurant.id;
      tile.dataset.restaurantName = restaurant.name;
      
      if (isLoggedIn && !isMobile) {
        const listActions = document.createElement('div');
        listActions.className = 'list-actions';
        listActions.innerHTML = `
          <button class="list-btn favorite ${listManager.isInList('favorites', restaurant.id) ? 'active' : ''}" 
                  data-id="${restaurant.id}" data-list="favorites" title="Add to Favorites">‚ù§Ô∏è</button>
          <button class="list-btn want-to-go ${listManager.isInList('wantToGo', restaurant.id) ? 'active' : ''}" 
                  data-id="${restaurant.id}" data-list="wantToGo" title="Want to Go">üìç</button>
          <button class="list-btn visited ${listManager.isInList('visited', restaurant.id) ? 'active' : ''}" 
                  data-id="${restaurant.id}" data-list="visited" title="Mark as Visited">üçΩÔ∏è</button>
        `;
        tile.appendChild(listActions);
      }
      
      grid.appendChild(tile);
      
      // Lazy load images
      const images = tile.querySelectorAll('img[data-src]');
      images.forEach(img => {
        if (imageObserver) {
          imageObserver.observe(img);
        } else {
          // Fallback if observer not ready
          img.src = img.getAttribute('data-src');
          img.classList.add('loaded');
        }
      });
      
      // Mobile menu button
      if (isMobile && isLoggedIn) {
        const menuBtn = tile.querySelector('.mobile-menu-btn');
        if (menuBtn) {
          menuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            showMobileModal({
              id: restaurant.id,
              name: restaurant.name,
              slug: restaurant.slug
            });
          });
        }
      }
      
      // PC list buttons
      if (isLoggedIn && !isMobile) {
        tile.querySelectorAll('.list-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.preventDefault(); 
            e.stopPropagation();
            const restaurantId = parseInt(btn.dataset.id);
            const wasAdded = await listManager.toggleInList(btn.dataset.list, restaurantId);
            btn.classList.toggle('active', wasAdded);
            if (currentList !== 'all') filterAndRender();
          });
        });
      }
    }
    
    async function filterAndRender() {
      if (!supabaseInitialized) return;
      
      const { data: { session } } = await supabase.auth.getSession();
      const isLoggedIn = !!session;
      
      let filtered = restaurants.filter(r => {
        const q = document.getElementById('q').value.trim().toLowerCase();
        const categoryMatch = document.getElementById('categorySelect').value === 'All' || r.category === document.getElementById('categorySelect').value;
        const searchMatch = !q || r.name.toLowerCase().includes(q) || (r.desc && r.desc.toLowerCase().includes(q));
        
        let listMatch = true;
        if (isLoggedIn && currentList !== 'all') {
          if (currentList === 'favorites') listMatch = listManager.isInList('favorites', r.id);
          else if (currentList === 'visited') listMatch = listManager.isInList('visited', r.id);
          else if (currentList === 'want-to-go') listMatch = listManager.isInList('wantToGo', r.id);
        }
        
        return categoryMatch && searchMatch && listMatch;
      });
      
      await renderList(filtered);
    }
    
    // Listen for auth changes
    if (supabaseInitialized) {
      supabase.auth.onAuthStateChange(() => {
        setTimeout(updateAuthUI, 50);
      });
    }
  </script>
</body>
</html>