<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zo2y ‚Äî Add Your Restaurant</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { 
      --bg: #0b1633; --card: #132347; --muted: #cbd5e1; --accent: #f59e0b; 
      --glass: rgba(255,255,255,0.03); --white: #ffffff; --border: rgba(255,255,255,0.1);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --shadow: 0 10px 30px rgba(0,0,0,0.3);
      --success: #10b981; --error: #ef4444; --info: #3b82f6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; } 
    html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; } 
    a { color: inherit; text-decoration: none; } 
    img { display: block; max-width: 100%; height: auto; }
    
    /* Enhanced Header */
    header { 
      position: sticky; top: 0; z-index: 60; 
      display: flex; align-items: center; gap: 20px; 
      padding: 14px 24px; backdrop-filter: blur(20px) saturate(180%);
      background: rgba(19, 35, 71, 0.8); border-bottom: 1px solid var(--border); 
    } 
    .logo { 
      height: 40px; cursor: pointer; transition: all 0.3s ease;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
    }
    .logo:hover {
      transform: scale(1.05) rotate(-2deg);
      filter: drop-shadow(0 6px 12px rgba(245,158,11,0.3));
    }
    .toolbar { 
      display: flex; gap: 12px; margin-left: auto; align-items: center; flex-wrap: wrap; 
    } 
    .user-auth { display: flex; align-items: center; gap: 10px; } 
    .auth-btn { 
      background: var(--gradient); color: #0b1633; border: none; 
      padding: 8px 16px; border-radius: 16px; cursor: pointer; 
      font-size: 13px; font-weight: 600; transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(245,158,11,0.3);
    } 
    .auth-btn:hover { 
      transform: translateY(-2px); box-shadow: 0 6px 16px rgba(245,158,11,0.4);
    }
    .user-welcome { 
      display: none; align-items: center; gap: 8px; font-size: 13px; 
      cursor: pointer; padding: 6px 12px; border-radius: 16px; 
      transition: all 0.3s ease; font-weight: 500;
    } 
    .user-welcome:hover { 
      background: var(--accent); color: #0b1633; transform: translateY(-2px);
    } 
    .user-avatar { 
      width: 32px; height: 32px; border-radius: 50%; background: var(--gradient); 
      display: flex; align-items: center; justify-content: center; 
      font-weight: bold; color: #0b1633; font-size: 14px; 
      box-shadow: 0 4px 8px rgba(245,158,11,0.3);
    }
    
    /* Enhanced Container */
    .container { 
      max-width: 800px; margin: 24px auto; padding: 0 20px; 
    } 
    
    /* Form Styles */
    .form-card {
      background: var(--card);
      border-radius: 20px;
      padding: 32px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      margin-bottom: 40px;
    }
    
    .form-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .form-header h1 {
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      margin-bottom: 8px;
    }
    
    .form-header p {
      color: var(--muted);
      font-size: 1.1rem;
    }
    
    .form-group {
      margin-bottom: 24px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--white);
      font-size: 14px;
    }
    
    .form-input, .form-textarea, .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--bg);
      color: var(--white);
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .submit-btn {
      background: var(--gradient);
      color: #0b1633;
      border: none;
      padding: 14px 32px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      box-shadow: 0 4px 12px rgba(245,158,11,0.3);
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245,158,11,0.4);
    }
    
    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Success Message */
    .success-message {
      display: none;
      text-align: center;
      padding: 40px;
      background: var(--card);
      border-radius: 20px;
      border: 1px solid var(--success);
    }
    
    .success-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      color: var(--success);
    }
    
    /* Login Prompt */
    .login-prompt {
      background: var(--card);
      border: 1px solid var(--accent);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      backdrop-filter: blur(10px);
    }
    
    .login-prompt h3 {
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 12px;
    }
    
    /* Enhanced Footer */
    footer { 
      padding: 30px 20px; color: var(--muted); text-align: center; 
      border-top: 1px solid var(--border); margin-top: 40px; 
      background: var(--card);
    }
    
    /* Notification */
    .notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 400px;
    }
    
    .custom-notification {
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      transform: translateX(120%);
      transition: transform 0.4s ease;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }
    
    .notification-success {
      background: rgba(16, 185, 129, 0.9);
      color: white;
    }
    
    .notification-error {
      background: rgba(239, 68, 68, 0.9);
      color: white;
    }
    
    .notification-info {
      background: rgba(59, 130, 246, 0.9);
      color: white;
    }
    
    .notification-show {
      transform: translateX(0);
    }
    
    .notification-icon {
      margin-right: 12px;
      font-size: 1.2rem;
    }
    
    .notification-close {
      margin-left: auto;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1rem;
      opacity: 0.7;
      transition: opacity 0.2s;
    }
    
    .notification-close:hover {
      opacity: 1;
    }

    /* Responsive Design */
    @media (max-width: 768px) { 
      header { padding: 12px 16px; flex-wrap: wrap; gap: 12px; } 
      .toolbar { margin-left: 0; width: 100%; justify-content: space-between; } 
      .container { padding: 0 16px; }
      .form-card { padding: 24px; }
      .form-header h1 { font-size: 2rem; }
      .form-row { grid-template-columns: 1fr; }
    }
    
    @media (max-width: 480px) { 
      .user-welcome span { display: none; } 
      .user-welcome { padding: 8px; } 
    }
  </style>
  
  <link rel="icon" type="image/png" href="images/logo.png">
</head>
<body>
  <header>
    <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
    <div class="toolbar">
      <div class="user-auth">
        <div class="user-welcome" id="userWelcome">
          <div class="user-avatar" id="userAvatar">U</div>
          <span id="userName">User</span>
        </div>
        <button class="auth-btn" id="loginBtn">Sign In</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Login Required Message -->
    <div class="login-prompt" id="loginPrompt">
      <h3>üîê Sign In Required</h3>
      <p>Please sign in to submit your restaurant for review.</p>
      <button class="auth-btn" onclick="location.href='login.html'" style="margin-top: 16px;">Sign In Now</button>
    </div>

    <!-- Main Form (hidden until logged in) -->
    <div id="restaurantForm" style="display: none;">
      <div class="form-card">
        <div class="form-header">
          <h1>Add Your Restaurant</h1>
          <p>Share your favorite spot with the Zo2y community</p>
        </div>

        <form id="addRestaurantForm">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="restaurantName">Restaurant Name *</label>
              <input type="text" id="restaurantName" class="form-input" required placeholder="e.g., Mori Sushi">
            </div>
            
            <div class="form-group">
              <label class="form-label" for="category">Category *</label>
              <select id="category" class="form-select" required>
                <option value="">Select a category</option>
                <option value="Asian">Asian</option>
                <option value="Burgers">Burgers</option>
                <option value="Chicken">Chicken</option>
                <option value="Middle Eastern">Middle Eastern</option>
                <option value="Mexican">Mexican</option>
                <option value="Fast Food">Fast Food</option>
                <option value="Cafe & Bakery">Cafe & Bakery</option>
                <option value="Pizza">Pizza</option>
                <option value="BBQ & Ribs">BBQ & Ribs</option>
                <option value="Italian">Italian</option>
                <option value="Seafood">Seafood</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Sandwiches">Sandwiches</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="description">Description *</label>
            <textarea id="description" class="form-textarea" required placeholder="Describe the restaurant, popular dishes, atmosphere..."></textarea>
            <div class="form-hint">Be descriptive! This will help others discover great places.</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="location">Location/Area *</label>
              <input type="text" id="location" class="form-input" required placeholder="e.g., Downtown, Heliopolis">
            </div>
            
            <div class="form-group">
              <label class="form-label" for="priceRange">Price Range</label>
              <select id="priceRange" class="form-select">
                <option value="">Select price range</option>
                <option value="$">$ - Budget Friendly</option>
                <option value="$$">$$ - Moderate</option>
                <option value="$$$">$$$ - Expensive</option>
                <option value="$$$$">$$$$ - Fine Dining</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="website">Website</label>
              <input type="url" id="website" class="form-input" placeholder="https://...">
            </div>
            
            <div class="form-group">
              <label class="form-label" for="phone">Phone Number</label>
              <input type="tel" id="phone" class="form-input" placeholder="+20...">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="specialty">Specialty Dish</label>
            <input type="text" id="specialty" class="form-input" placeholder="What dish are they known for?">
          </div>

          <div class="form-group">
            <label class="form-label" for="recommendation">Why do you recommend it? *</label>
            <textarea id="recommendation" class="form-textarea" required placeholder="Share what makes this place special..."></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="additionalInfo">Additional Information</label>
            <textarea id="additionalInfo" class="form-textarea" placeholder="Opening hours, parking, dietary options, etc."></textarea>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">
            <i class="fas fa-utensils" style="margin-right: 8px;"></i>
            Submit Restaurant
          </button>
        </form>
      </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="successMessage">
      <div class="success-icon">üéâ</div>
      <h2>Thank You!</h2>
      <p>Your restaurant submission has been received and is under review.</p>
      <p>We'll notify you once it's added to Zo2y!</p>
      <button class="auth-btn" onclick="location.href='index.html'" style="margin-top: 20px;">
        Back to Restaurants
      </button>
    </div>
  </main>

  <footer>¬© 2025 Zo2y ‚Äî Built with ‚ù§Ô∏è for food lovers</footer>

  <!-- Notification Container -->
  <div id="notificationContainer" class="notification-container"></div>

  <script>
    const supabaseUrl = "https://gfkhjbztayjyojsgdpgk.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // ---------- AUTH SYSTEM ----------
    const userWelcome = document.getElementById('userWelcome');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const loginBtn = document.getElementById('loginBtn');
    const loginPrompt = document.getElementById('loginPrompt');
    const restaurantForm = document.getElementById('restaurantForm');

    async function updateAuthUI() {
      try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) {
          console.warn('supabase getSession err', error);
        }

        if (session && session.user) {
          // User is logged in
          const userId = session.user.id;

          // Fetch profile from user_profiles table
          let username = null;
          try {
            const { data: profile, error: profileError } = await supabase
              .from('user_profiles')
              .select('username, full_name, avatar_url')
              .eq('id', userId)
              .limit(1)
              .maybeSingle();

            if (profileError) {
              console.warn('profile fetch err', profileError);
            } else if (profile) {
              username = profile.username || profile.full_name || null;
            }
          } catch (err) {
            console.warn('profile fetch catch', err);
          }

          // Fallback display name
          const displayName = username || session.user.user_metadata?.username || session.user.email?.split('@')[0] || 'User';

          // Set UI elements
          userWelcome.style.display = 'flex';
          loginBtn.style.display = 'none';
          loginPrompt.style.display = 'none';
          restaurantForm.style.display = 'block';
          
          userName.textContent = displayName;
          userAvatar.textContent = displayName.charAt(0).toUpperCase();

          // Set click handler for profile redirect
          userWelcome.onclick = (e) => {
            e.preventDefault();
            safeGoToProfile();
          };

        } else {
          // Not logged in
          userWelcome.style.display = 'none';
          loginBtn.style.display = 'block';
          loginPrompt.style.display = 'block';
          restaurantForm.style.display = 'none';
          
          loginBtn.onclick = () => location.href = 'login.html';
        }
      } catch (e) {
        console.error('updateAuthUI error', e);
        // Fallback to logged out state
        userWelcome.style.display = 'none';
        loginBtn.style.display = 'block';
        loginPrompt.style.display = 'block';
        restaurantForm.style.display = 'none';
        loginBtn.onclick = () => location.href = 'login.html';
      }
    }

    async function safeGoToProfile() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (session && session.user) {
          window.location.href = 'profile.html';
        } else {
          window.location.href = 'login.html';
        }
      } catch (err) {
        console.error('safeGoToProfile err', err);
        window.location.href = 'login.html';
      }
    }

    // Listen for auth changes
    if (supabase) {
      supabase.auth.onAuthStateChange((event, session) => {
        setTimeout(updateAuthUI, 50);
      });
    }

    // ---------- NOTIFICATION SYSTEM ----------
    const notificationQueue = [];
    let isShowingNotification = false;

    function showNotification(message, type = "info", duration = 2500) {
      notificationQueue.push({ message, type, duration });
      processNotificationQueue();
    }

    function processNotificationQueue() {
      if (isShowingNotification || notificationQueue.length === 0) return;
      
      isShowingNotification = true;
      const { message, type, duration } = notificationQueue.shift();
      
      const notificationContainer = document.getElementById("notificationContainer");
      const notification = document.createElement("div");
      notification.className = `custom-notification notification-${type}`;
      
      let iconClass;
      if (type === "success") {
        iconClass = "fas fa-check-circle";
      } else if (type === "error") {
        iconClass = "fas fa-exclamation-circle";
      } else {
        iconClass = "fas fa-info-circle";
      }
      
      notification.innerHTML = `
        <i class="notification-icon ${iconClass}"></i>
        <span class="notification-message">${message}</span>
        <button class="notification-close" aria-label="Close notification">√ó</button>
      `;
      
      notificationContainer.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add("notification-show");
      }, 10);
      
      notification.querySelector('.notification-close').addEventListener('click', () => {
        hideNotification(notification);
      });
      
      setTimeout(() => {
        if (notification.parentNode) {
          hideNotification(notification);
        }
      }, duration);
    }

    function hideNotification(notification) {
      notification.classList.remove("notification-show");
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
        isShowingNotification = false;
        processNotificationQueue();
      }, 400);
    }

    // ---------- FORM HANDLING ----------
    document.getElementById('addRestaurantForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalText = submitBtn.innerHTML;
      
      try {
        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          showNotification('Please sign in to submit a restaurant', 'error');
          return;
        }

        const formData = {
          restaurant_name: document.getElementById('restaurantName').value,
          category: document.getElementById('category').value,
          description: document.getElementById('description').value,
          location: document.getElementById('location').value,
          price_range: document.getElementById('priceRange').value,
          website: document.getElementById('website').value,
          phone: document.getElementById('phone').value,
          specialty_dish: document.getElementById('specialty').value,
          recommendation: document.getElementById('recommendation').value,
          additional_info: document.getElementById('additionalInfo').value,
          submitted_by: session.user.id,
          submitted_at: new Date().toISOString(),
          status: 'pending' // pending, approved, rejected
        };

        // Insert into restaurant_submissions table
        const { data, error } = await supabase
          .from('restaurant_submissions')
          .insert([formData]);

        if (error) {
          console.error('Error submitting restaurant:', error);
          showNotification('Error submitting restaurant. Please try again.', 'error');
          return;
        }

        // Show success message
        document.getElementById('restaurantForm').style.display = 'none';
        document.getElementById('successMessage').style.display = 'block';
        
        showNotification('Restaurant submitted successfully!', 'success');

      } catch (error) {
        console.error('Form submission error:', error);
        showNotification('An unexpected error occurred. Please try again.', 'error');
      } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      }
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      updateAuthUI();
    });
  </script>
</body>
</html>