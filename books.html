<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex" />
  <title>Zo2y - Books</title>
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/list-utils.js?v=20260221c"></script>
  <script src="js/index-list-menu-adapter.js?v=20260221b"></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --glass: rgba(255,255,255,0.03);
      --white: #ffffff;
      --border: rgba(255,255,255,0.1);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --surface: rgba(19, 35, 71, 0.6);
      --radial-glow: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      --shadow: 0 10px 30px rgba(0,0,0,0.3);
      --info: #3b82f6;
      --success: #10b981;
      --error: #ef4444;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      overflow-x: hidden;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      inset: -20% 0 0 0;
      background: var(--radial-glow);
      pointer-events: none;
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0 12px, rgba(255, 184, 77, 0) 12px 24px);
      opacity: 0.25;
      pointer-events: none;
      z-index: -3;
    }

    a { color: inherit; text-decoration: none; }

    /* Header to match index/book */
    .nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 14px 16px;
      backdrop-filter: blur(10px) saturate(180%);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      gap: 12px;
    }

    .logo {
      height: 40px;
      width: auto;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }

    .logo:hover { transform: scale(1.05); }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }

    .nav a.ghost {
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }

    .nav a.ghost:hover { color: var(--accent); background: rgba(245, 158, 11, 0.05); }

    .account-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .account-btn:hover { border-color: var(--accent); color: var(--accent); }

    .account-btn.logged-in {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.4);
      color: var(--accent);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .hero {
      max-width: 1200px;
      margin: 24px auto 0;
      padding: 0 20px;
    }

    .hero h1 {
      font-size: 28px;
      margin: 0 0 8px 0;
    }

    .hero p {
      margin: 0;
      color: var(--muted);
    }

    .controls {
      max-width: 1200px;
      margin: 16px auto 0;
      padding: 0 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1 1 280px;
      width: min(92vw, 320px);
      max-height: 70vh;
      overflow-y: auto;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      outline: none;
    }

    .filter-select {
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      outline: none;
      min-width: 200px;
    }

    .small-input {
      max-width: 140px;
    }

    .chip-row {
      max-width: 1200px;
      margin: 10px auto 0;
      padding: 0 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--muted);
      font-size: 12px;
      cursor: pointer;
    }

    .chip.active {
      border-color: var(--accent);
      color: var(--accent);
    }

    .grid {
      max-width: 1200px;
      margin: 24px auto 60px;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 320px;
      transition: all 0.2s ease;
      position: relative;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .card.menu-open,
    .card.menu-open:hover {
      transform: none;
      overflow: visible;
    }

    .card img {
      width: 100%;
      aspect-ratio: 2 / 3;
      height: auto;
      object-fit: cover;
      display: block;
      background: linear-gradient(135deg, #0f1f40 0%, #1a2d5f 100%);
      position: relative;
    }

    .card img[src=""] {
      background: linear-gradient(90deg, #0f1f40 0px, rgba(255,255,255,0.05) 50%, #0f1f40 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .card img[src*="logo.png"] {
      object-fit: contain;
      padding: 20px;
      background: linear-gradient(135deg, #132347 0%, #0b1633 100%);
      opacity: 0.6;
    }

    .card-body {
      padding: 12px 14px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      min-height: 0;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      margin: 0;
      order: 1;
    }

    .card-meta {
      font-size: 12px;
      color: var(--muted);
    }

    .card-desc {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 60px;
      order: 2;
      flex: 1;
    }

    .empty {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      color: var(--muted);
      text-align: center;
    }

    .pagination {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .page-btn {
      min-width: 44px;
      height: 40px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .card-meta-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      order: 3;
      margin-top: auto;
    }

    .card-menu-wrap {
      position: relative;
      margin-left: auto;
      flex-shrink: 0;
    }

    .menu-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(19, 35, 71, 0.9);
      color: var(--white);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .menu-btn:hover { border-color: var(--accent); color: var(--accent); }

    .list-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .list-menu.open { display: flex; }

    .list-menu-panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 380px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      animation: menuFadeIn 0.2s ease;
    }

    .list-menu-title { font-size: 12px; color: var(--muted); margin-bottom: 8px; }

    .list-action {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all 0.2s ease;
      margin-bottom: 6px;
    }

    .list-action:last-child { margin-bottom: 0; }
    .list-action:hover { border-color: var(--accent); color: var(--accent); }
    .list-action.active {
      background: rgba(245, 158, 11, 0.12);
      border-color: var(--accent);
      color: var(--accent);
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 2000;
      box-shadow: var(--shadow);
    }
    .notification.success { background: var(--success); color: white; }
    .notification.error { background: var(--error); color: white; }
    .notification.info { background: var(--info); color: white; }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      color: var(--white);
      font-size: 22px;
      cursor: pointer;
    }
    .modal-list {
      display: grid;
      gap: 8px;
      max-height: 240px;
      overflow: auto;
      margin-bottom: 12px;
    }
    .modal-list-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .modal-list-actions { display: inline-flex; gap: 6px; align-items: center; }
    .list-edit-btn {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .list-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    .modal-list-item.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }
    .modal-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .modal-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      outline: none;
    }
    .icon-options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .icon-option {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .icon-option.selected { border-color: var(--accent); color: var(--accent); }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .page-info {
      color: var(--muted);
      font-size: 13px;
    }

    @media (max-width: 600px) {
      .hero h1 { font-size: 22px; }
      .grid { gap: 12px; }
      .card img { height: 220px; }
    }

    .menu-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .menu-modal.active {
      display: flex;
    }

    .menu-modal-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 380px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      animation: menuFadeIn 0.2s ease;
    }

    @keyframes menuFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    .menu-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .menu-modal-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--white);
      margin: 0;
    }

    .menu-modal-close {
      background: transparent;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .menu-modal-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
    }

    .menu-modal-body {
      padding: 16px 20px;
    }

    .menu-quick-lists {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 20px;
    }

    .menu-custom-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .menu-custom-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .menu-create-list-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--accent);
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .menu-create-list-btn:hover {
      background: rgba(245, 158, 11, 0.1);
      border-color: var(--accent);
    }

    .menu-custom-lists {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
  </style>
  <meta name="theme-color" content="#0b1633" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Zo2y" />
  <link rel="manifest" href="/manifest.webmanifest?v=2" />
  <link rel="apple-touch-icon" href="/images/apple-touch-icon-180.png" />
  <link rel="stylesheet" href="/js/mobile-app.css?v=20260226a" />
  <script src="/js/mobile-webapp.js?v=20260225d" defer></script>
</head>
<body>
  <header class="nav" role="banner">
    <div class="nav-container">
      <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'" width="160" height="40" decoding="async" fetchpriority="high">
      <div class="nav-right">
        <a class="ghost" href="animes.html">Anime</a>
        <a class="ghost" href="reviews.html">Reviews</a>
        <a class="ghost" href="index.html">Home</a>
        <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
      </div>
    </div>
  </header>

  <section class="hero">
    <h1>Popular Books</h1>
    <p>Book data sourced from Google Books and cached in Supabase.</p>
  </section>

  <div class="controls">
    <input id="searchInput" class="search-input" type="text" placeholder="Search books..." />
    <select id="categorySelect" class="filter-select">
      <option value="">All Categories</option>
    </select>
    <input id="yearInput" class="search-input small-input" type="number" min="1900" max="2100" placeholder="Year" />
    <input id="authorInput" class="search-input" type="text" placeholder="Author (e.g., Agatha Christie)" />
    <button class="btn" id="refreshBtn"><i class="fas fa-rotate"></i> Refresh</button>
  </div>
  <div id="activeFilters" class="chip-row"></div>

  <div id="booksGrid" class="grid"></div>
  <div id="emptyState" class="empty" style="display:none;">No books found.</div>
  <div class="pagination">
    <button class="page-btn" id="prevPageBtn" disabled><i class="fas fa-chevron-left"></i></button>
    <div class="page-info" id="pageInfo">Page 1</div>
    <button class="page-btn" id="nextPageBtn" disabled><i class="fas fa-chevron-right"></i></button>
  </div>

  <div class="modal" id="bookListsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Custom Book Lists</div>
        <button class="modal-close" id="closeBookListsBtn">&times;</button>
      </div>
      <div class="modal-list" id="bookListsContainer"></div>
      <div class="modal-input">
        <input type="text" id="newBookListName" placeholder="New list name..." maxlength="50">
        <button class="btn" id="createBookListBtn">Create</button>
      </div>
      <div class="icon-options" id="bookListIconOptions">
        <button class="icon-option selected" data-icon="fas fa-film"><i class="fas fa-film"></i></button>
        <button class="icon-option" data-icon="fas fa-heart"><i class="fas fa-heart"></i></button>
        <button class="icon-option" data-icon="fas fa-star"><i class="fas fa-star"></i></button>
        <button class="icon-option" data-icon="fas fa-bookmark"><i class="fas fa-bookmark"></i></button>
        <button class="icon-option" data-icon="fas fa-eye"><i class="fas fa-eye"></i></button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn" id="saveBookListsBtn">Save Changes</button>
      </div>
    </div>
  </div>

      <script>
    (function () {
      if (window.innerWidth <= 768) {
        window.location.href = 'books-mobile.html';
        return;
      }
      const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
      const GOOGLE_BOOKS_PROXY_BASE = '/api/books';
      const FALLBACK_BOOK_IMAGE = 'images/logo.png';
      const BOOKS_PER_PAGE = 20;
      const CATEGORY_OPTIONS = [
        'Fiction',
        'Mystery',
        'Fantasy',
        'Romance',
        'History',
        'Biography',
        'Science',
        'Business',
        'Self-Help',
        'Children'
      ];
      const state = {
        categories: CATEGORY_OPTIONS,
        activeCategory: '',
        query: '',
        author: '',
        year: '',
        page: 1,
        totalPages: 1,
        currentUser: null,
        listStatusMap: new Map(),
        customLists: [],
        activeBookId: null,
        modalSelectedLists: new Set(),
        selectedIcon: 'fas fa-book',
        pendingDefaultOps: new Set(),
        bookIndex: new Map(),
        requestSeq: 0
      };

      let supabaseClient = null;

      function toHttpsUrl(value) {
        return String(value || '').replace(/^http:\/\//i, 'https://').trim();
      }

      function buildOpenLibraryCoverUrl(doc, size = 'L') {
        const safeSize = ['S', 'M', 'L'].includes(String(size || '').toUpperCase())
          ? String(size).toUpperCase()
          : 'L';
        const coverId = Number(doc?.cover_i || 0) || 0;
        if (coverId > 0) {
          return `https://covers.openlibrary.org/b/id/${encodeURIComponent(String(coverId))}-${safeSize}.jpg`;
        }
        const isbnRaw = Array.isArray(doc?.isbn) ? String(doc.isbn[0] || '').trim() : '';
        const isbn = isbnRaw.replace(/[^0-9Xx]/g, '');
        if (isbn) {
          return `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(isbn)}-${safeSize}.jpg`;
        }
        return '';
      }

      function normalizeRemoteBookDoc(raw, idx = 0) {
        if (!raw) return null;
        if (raw.volumeInfo) {
          return normalizeGoogleBookDoc(raw, idx);
        }
        const title = String(raw?.title || `Book ${idx + 1}`).trim();
        if (!title) return null;
        const authorNames = Array.isArray(raw?.author_name)
          ? raw.author_name.map((entry) => String(entry || '').trim()).filter(Boolean)
          : [];
        const year = Number(raw?.first_publish_year || 0) || null;
        const isbn = Array.isArray(raw?.isbn)
          ? raw.isbn.map((entry) => String(entry || '').replace(/[^0-9Xx]/g, '')).filter(Boolean)
          : [];
        const subject = Array.isArray(raw?.subject)
          ? raw.subject.map((entry) => String(entry || '').trim()).filter(Boolean)
          : [];
        const publisher = Array.isArray(raw?.publisher)
          ? raw.publisher.map((entry) => String(entry || '').trim()).filter(Boolean)
          : [];
        return {
          key: String(raw?.key || '').trim(),
          title,
          author_name: authorNames.length ? authorNames : ['Unknown author'],
          first_publish_year: year,
          isbn,
          subject,
          publisher,
          cover_i: Number(raw?.cover_i || 0) || null,
          coverImage: toHttpsUrl(raw?.coverImage || ''),
          _googleThumbnail: toHttpsUrl(raw?._googleThumbnail || ''),
          _googleVolumeId: String(raw?._googleVolumeId || '').trim()
        };
      }

      function buildGoogleBooksQuery(params = {}) {
        const title = String(params?.title || '').trim();
        const author = String(params?.author || '').trim();
        const qRaw = String(params?.q || '').trim();
        const subject = String(params?.subject || '').trim();
        const year = String(params?.first_publish_year || params?.year || '').trim();
        const chunks = [];
        if (qRaw) chunks.push(qRaw);
        if (title) chunks.push(`intitle:\"${title}\"`);
        if (author) chunks.push(`inauthor:\"${author}\"`);
        if (subject) chunks.push(subject);
        if (year) chunks.push(year);
        return chunks.join(' ').trim();
      }

      function normalizeGoogleBookDoc(volume, idx = 0) {
        const info = volume?.volumeInfo || {};
        const title = String(info?.title || `Book ${idx + 1}`).trim();
        const authorNames = Array.isArray(info?.authors) ? info.authors.filter(Boolean).map((name) => String(name).trim()).filter(Boolean) : [];
        const published = String(info?.publishedDate || '').trim();
        const yearMatch = published.match(/\d{4}/);
        const year = yearMatch ? Number(yearMatch[0]) : null;
        const categories = Array.isArray(info?.categories) ? info.categories.filter(Boolean).map((entry) => String(entry).trim()) : [];
        const publisher = String(info?.publisher || '').trim();
        const identifiers = Array.isArray(info?.industryIdentifiers) ? info.industryIdentifiers : [];
        const isbn = identifiers
          .map((entry) => String(entry?.identifier || '').replace(/[^0-9Xx]/g, ''))
          .filter(Boolean);
        const thumb = String(info?.imageLinks?.thumbnail || info?.imageLinks?.smallThumbnail || '').replace(/^http:\/\//i, 'https://').trim();

        return {
          key: '',
          title,
          author_name: authorNames.length ? authorNames : ['Unknown author'],
          first_publish_year: Number.isFinite(year) ? year : null,
          isbn,
          subject: categories,
          publisher: publisher ? [publisher] : [],
          cover_i: null,
          _googleThumbnail: thumb,
          _googleVolumeId: String(volume?.id || '').trim()
        };
      }

      async function fetchGoogleBooksDocs(params = {}) {
        const q = buildGoogleBooksQuery(params);
        if (!q) return [];
        const googleUrl = new URL(`${GOOGLE_BOOKS_PROXY_BASE}/volumes`, window.location.origin);
        googleUrl.searchParams.set('q', q);
        googleUrl.searchParams.set('printType', 'books');
        googleUrl.searchParams.set('langRestrict', 'en');
        googleUrl.searchParams.set('maxResults', String(Math.max(1, Number(params?.limit || 20))));
        try {
          const res = await fetch(googleUrl.toString(), { headers: { Accept: 'application/json' } });
          if (!res.ok) return [];
          const json = await res.json();
          const items = Array.isArray(json?.items) ? json.items : [];
          return items.map((entry, idx) => normalizeGoogleBookDoc(entry, idx)).filter((entry) => String(entry?.title || '').trim());
        } catch (_err) {
          return [];
        }
      }

      async function booksFetch(path, params = {}) {
        const normalizedPath = String(path || '').startsWith('/') ? String(path) : `/${String(path || '')}`;
        const endpoint = normalizedPath === '/search.json'
          ? `${GOOGLE_BOOKS_PROXY_BASE}/search`
          : `${GOOGLE_BOOKS_PROXY_BASE}${normalizedPath}`;
        const url = new URL(endpoint, window.location.origin);
        Object.entries(params || {}).forEach(([key, value]) => {
          if (value === undefined || value === null || value === '') return;
          if (Array.isArray(value)) {
            value.forEach((entry) => {
              if (entry === undefined || entry === null || entry === '') return;
              url.searchParams.append(key, String(entry));
            });
            return;
          }
          url.searchParams.set(key, String(value));
        });
        const res = await fetch(url.toString(), { headers: { Accept: 'application/json' } });
        if (!res.ok) throw new Error(`Books API error ${res.status}`);
        const json = await res.json();
        const docsRaw = Array.isArray(json?.docs) ? json.docs : (Array.isArray(json?.items) ? json.items : []);
        const docs = docsRaw.map((entry, idx) => normalizeRemoteBookDoc(entry, idx)).filter((entry) => String(entry?.title || '').trim());
        const numFound = Number(json?.numFound || json?.count || json?.totalItems || docs.length) || docs.length;
        return { docs, numFound };
      }

      async function fetchPopularBooks(page = 1, limit = BOOKS_PER_PAGE) {
        return booksFetch('/popular', {
          page,
          limit,
          subject: state.activeCategory || 'fiction',
          language: 'en',
          orderBy: 'relevance'
        });
      }

      async function fetchTrendingBooks(limit = BOOKS_PER_PAGE) {
        return booksFetch('/trending', {
          period: 'weekly',
          limit
        });
      }

      function getPreferredBookImage(doc) {
        const googleThumb = toHttpsUrl(doc?._googleThumbnail || '');
        if (googleThumb) return googleThumb;
        const coverImage = toHttpsUrl(doc?.coverImage || '');
        if (coverImage) return coverImage;
        const byCoverId = toHttpsUrl(buildOpenLibraryCoverUrl(doc, 'L'));
        if (byCoverId) return byCoverId;
        const byIsbn = toHttpsUrl(buildOpenLibraryCoverUrl(doc, 'M'));
        if (byIsbn) return byIsbn;
        return null;
      }

      function slugifyBookPart(value) {
        return String(value || '')
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '')
          .slice(0, 64);
      }

      function getBookEntryId(item, idx = 0) {
        const googleVolumeId = String(item?._googleVolumeId || '').trim();
        if (googleVolumeId) return googleVolumeId;
        const workKey = String(item?.key || '').trim();
        if (workKey.startsWith('/works/')) {
          const workId = workKey.replace('/works/', '').trim();
          if (workId) return workId;
        }
        const titleSlug = slugifyBookPart(item?.title || `book-${idx}`);
        const authorSlug = slugifyBookPart(Array.isArray(item?.author_name) ? item.author_name[0] : '');
        const year = String(item?.first_publish_year || '').trim();
        return `search-${titleSlug}-${authorSlug || 'unknown'}-${year || 'na'}`;
      }

      async function loadCuratedPopularBooks() {
        const [trendingResult, popularResult] = await Promise.allSettled([
          fetchTrendingBooks(BOOKS_PER_PAGE),
          fetchPopularBooks(1, BOOKS_PER_PAGE)
        ]);

        const trending = trendingResult.status === 'fulfilled' ? trendingResult.value : null;
        const popular = popularResult.status === 'fulfilled' ? popularResult.value : null;
        const trendingDocs = Array.isArray(trending?.docs) ? trending.docs.slice(0, BOOKS_PER_PAGE) : [];
        const popularDocs = Array.isArray(popular?.docs) ? popular.docs.slice(0, BOOKS_PER_PAGE) : [];

        if (popularDocs.length || trendingDocs.length) {
          const merged = [];
          const seen = new Set();
          [...trendingDocs, ...popularDocs].forEach((doc) => {
            const title = String(doc?.title || '').trim().toLowerCase();
            const author = String((Array.isArray(doc?.author_name) ? doc.author_name[0] : '') || '').trim().toLowerCase();
            const key = `${title}::${author}`;
            if (!title || seen.has(key)) return;
            seen.add(key);
            merged.push(doc);
          });

          const docs = (merged.length ? merged : (popularDocs.length ? popularDocs : trendingDocs)).slice(0, BOOKS_PER_PAGE);
          return {
            docs,
            numFound: Math.max(
              Number(popular?.numFound || 0),
              Number(trending?.numFound || 0),
              docs.length,
              BOOKS_PER_PAGE * 2
            )
          };
        }

        return { docs: [], numFound: 0 };
      }

      function stripHtml(html) {
        if (!html) return '';
        return html.replace(/<[^>]*>/g, '').trim();
      }

      function truncateText(text, maxLen) {
        if (!text) return '';
        if (text.length <= maxLen) return text;
        return `${text.slice(0, maxLen - 1)}…`;
      }

      function showNotification(message, type = 'info', duration = 3000) {
        const existing = document.querySelectorAll('.notification');
        existing.forEach(n => n.remove());
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), duration);
      }

      function debounce(fn, wait = 260) {
        let timeoutId = null;
        return (...args) => {
          if (timeoutId) clearTimeout(timeoutId);
          timeoutId = setTimeout(() => fn(...args), wait);
        };
      }

      function scoreBookMatch(item) {
        const query = String(state.query || '').trim().toLowerCase();
        const authorQuery = String(state.author || '').trim().toLowerCase();
        const categoryQuery = String(state.activeCategory || '').trim().toLowerCase();
        const yearQuery = String(state.year || '').trim();
        const title = String(item?.title || '').trim().toLowerCase();
        const authors = Array.isArray(item?.author_name)
          ? item.author_name.map((name) => String(name || '').trim().toLowerCase()).join(' ')
          : '';
        const subjects = Array.isArray(item?.subject)
          ? item.subject.map((entry) => String(entry || '').trim().toLowerCase()).join(' ')
          : '';
        const publishYear = String(item?.first_publish_year || '').trim();
        let score = 0;

        if (query) {
          if (title === query) score += 240;
          else if (title.startsWith(query)) score += 180;
          else if (title.includes(query)) score += 120;
          if (authors.includes(query)) score += 80;
          if (subjects.includes(query)) score += 36;
          query.split(/\s+/).filter(Boolean).forEach((term) => {
            if (title.includes(term)) score += 16;
            if (authors.includes(term)) score += 11;
            if (subjects.includes(term)) score += 6;
          });
        }

        if (authorQuery) {
          if (authors === authorQuery) score += 140;
          else if (authors.includes(authorQuery)) score += 90;
        }

        if (categoryQuery && subjects.includes(categoryQuery)) score += 42;
        if (yearQuery && publishYear.startsWith(yearQuery)) score += 30;
        return score;
      }

      function sortBooksByAccuracy(items) {
        const list = Array.isArray(items) ? items.slice() : [];
        if (!list.length) return [];
        const hasQuery = !!String(state.query || '').trim() ||
          !!String(state.author || '').trim() ||
          !!String(state.activeCategory || '').trim() ||
          !!String(state.year || '').trim();
        if (!hasQuery) return list;
        return list
          .map((item, index) => ({ item, index, score: scoreBookMatch(item) }))
          .sort((a, b) => (Number(b.score || 0) - Number(a.score || 0)) || (a.index - b.index))
          .map((entry) => entry.item);
      }

      function renderListIcon(icon) {
        if (window.ListUtils) return ListUtils.renderListIcon(icon, 'fas fa-book');
        if (!icon) return '<i class="fas fa-book"></i>';
        if (icon.includes('fa-')) return `<i class="${icon}"></i>`;
        return icon;
      }

      async function initSupabase() {
        if (typeof supabase === 'undefined') {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        if (typeof supabase === 'undefined') return null;
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return supabaseClient;
      }

      async function initAuth() {
        if (!supabaseClient) return;
        const { data: { user } } = await supabaseClient.auth.getUser();
        state.currentUser = user || null;
        updateAccountButton();
        await loadUserListStatus();
        supabaseClient.auth.onAuthStateChange((_event, session) => {
          state.currentUser = session?.user || null;
          updateAccountButton();
          loadUserListStatus();
        });
      }

      function updateAccountButton() {
        const btn = document.getElementById('userAccountBtn');
        if (!btn) return;
        if (state.currentUser) {
          btn.classList.add('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Profile</span>';
          btn.onclick = () => window.location.href = 'profile.html';
        } else {
          btn.classList.remove('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Account</span>';
          btn.onclick = () => window.location.href = 'login.html';
        }
      }

      async function loadUserListStatus() {
        state.listStatusMap = new Map();
        if (!supabaseClient || !state.currentUser) return;
        const { data, error } = await supabaseClient
          .from('book_list_items')
          .select('book_id, list_type')
          .eq('user_id', state.currentUser.id);
        if (error) return;
        (data || []).forEach(row => {
          if (!state.listStatusMap.has(row.book_id)) {
            state.listStatusMap.set(row.book_id, { favorites: false, read: false, readlist: false });
          }
          if (row.list_type && state.listStatusMap.get(row.book_id)[row.list_type] !== undefined) {
            state.listStatusMap.get(row.book_id)[row.list_type] = true;
          }
        });
        updateAllCardMenus();
      }

      function updateAllCardMenus() {
        document.querySelectorAll('.card').forEach(card => {
          const bookId = card.getAttribute('data-book-id');
          if (!bookId) return;
          updateCardMenuUI(card, bookId);
        });
      }

      function updateCardMenuUI(card, bookId) {
        const status = state.listStatusMap.get(bookId) || { favorites: false, read: false, readlist: false };
        card.querySelectorAll('.list-action').forEach(btn => {
          const listType = btn.getAttribute('data-list');
          if (!listType) return;
          const isActive = !!status[listType];
          btn.classList.toggle('active', isActive);
          const stateEl = btn.querySelector('.list-action-state');
          if (stateEl) stateEl.textContent = isActive ? 'Saved' : 'Add';
        });
      }

      function renderFilters() {
        const row = document.getElementById('activeFilters');
        if (!row) return;
        row.innerHTML = '';
        const items = [];
        if (state.activeCategory) items.push({ label: state.activeCategory, type: 'category' });
        if (state.query) items.push({ label: state.query, type: 'query' });
        if (state.year) items.push({ label: state.year, type: 'year' });
        if (state.author) items.push({ label: state.author, type: 'author' });
        items.forEach(item => {
          const chip = document.createElement('div');
          chip.className = 'chip active';
          chip.textContent = item.label;
          chip.onclick = () => {
            if (item.type === 'category') state.activeCategory = '';
            if (item.type === 'query') state.query = '';
            if (item.type === 'year') state.year = '';
            if (item.type === 'author') state.author = '';
            document.getElementById('searchInput').value = state.query;
            document.getElementById('categorySelect').value = state.activeCategory;
            document.getElementById('yearInput').value = state.year;
            document.getElementById('authorInput').value = state.author;
            renderFilters();
            state.page = 1;
            loadBooks();
          };
          row.appendChild(chip);
        });
      }

      function populateCategories() {
        const select = document.getElementById('categorySelect');
        if (!select) return;
        select.innerHTML = '<option value="">All Categories</option>';
        state.categories.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c;
          opt.textContent = c;
          select.appendChild(opt);
        });
      }

      function filterByYear(items) {
        if (!state.year) return items;
        const year = String(state.year);
        return (items || []).filter(item => {
          const date = item.first_publish_year || '';
          return String(date).startsWith(year);
        });
      }

      async function upsertBookRecord(book, bookId) {
        if (!supabaseClient || !book) return;
        const safeId = String(bookId || getBookEntryId(book)).trim();
        if (!safeId) return;
        const payload = {
          id: safeId,
          title: book.title || '',
          authors: (book.author_name || []).join(', '),
          thumbnail: getPreferredBookImage(book) || '',
          published_date: book.first_publish_year ? `${book.first_publish_year}-01-01` : null,
          categories: book.subject || [],
          description: '',
          page_count: null,
          publisher: book.publisher ? book.publisher[0] : null,
          updated_at: new Date().toISOString()
        };
        const { data, error } = await supabaseClient.from('books').upsert(payload, { onConflict: 'id' });
        if (error) {
          console.error('Upsert book error', error);
          showNotification('Could not save book record', 'error');
        }
        return { data, error };
      }

      async function loadBooks() {
        const grid = document.getElementById('booksGrid');
        if (!grid) return;
        const requestSeq = ++state.requestSeq;

        // Show cached results instantly
        const cacheKey = `books_search_v2_${state.query}_${state.author}_${state.activeCategory}_${state.year}_${state.page}`;
        const cached = localStorage.getItem(cacheKey);
        if (cached && state.page !== 1) {
          try {
            const cachedData = JSON.parse(cached);
            displayBookResults(cachedData.docs, cachedData.numFound);
            return;
          } catch (e) {
            console.warn('Cache read error', e);
          }
        }

        let data;
        try {
          const params = {
            page: state.page,
            limit: BOOKS_PER_PAGE,
            language: 'en'
          };
          if (state.query) params.q = state.query;
          if (state.author) params.author = state.author;
          if (state.activeCategory) params.subject = state.activeCategory;
          if (state.year) params.first_publish_year = state.year;
          if (!params.q && !params.author && !params.subject && !params.first_publish_year) {
            if (Number(state.page || 1) === 1) {
              data = await loadCuratedPopularBooks();
            } else {
              data = await fetchPopularBooks(state.page, BOOKS_PER_PAGE);
            }
          } else {
            data = await booksFetch('/search.json', params);
          }
          if (!Array.isArray(data?.docs) || !data.docs.length) {
            data = { docs: [], numFound: 0 };
          }
          // Cache successful results
          localStorage.setItem(cacheKey, JSON.stringify({ docs: data.docs || [], numFound: data.numFound || 0 }));
        } catch (e) {
          console.error('Books fetch error', e);
          if (cached) {
            try {
              const cachedData = JSON.parse(cached);
              data = cachedData;
            } catch {
              data = { docs: [], numFound: 0 };
            }
          } else {
            data = { docs: [], numFound: 0 };
          }
        }

        if (requestSeq !== state.requestSeq) return;
        displayBookResults(data.docs || [], data.numFound || 0);
      }

      function displayBookResults(docs, totalFound) {
        const grid = document.getElementById('booksGrid');
        const empty = document.getElementById('emptyState');
        if (!grid) return;
        const data = { docs: docs || [], numFound: totalFound || 0 };

        let results = data.docs || [];
        results = filterByYear(results);
        results = sortBooksByAccuracy(results);

        if (!results.length) {
          if (empty) empty.style.display = 'block';
          grid.innerHTML = '';
          return;
        }

        const fragment = document.createDocumentFragment();
        state.bookIndex.clear();
        results.forEach((item, idx) => {
          const authors = item.author_name ? item.author_name.join(', ') : 'Unknown author';
          const year = item.first_publish_year || '';
          const desc = truncateText(item.title || '', 140) || 'No description available.';
          const thumb = getPreferredBookImage(item);
          const bookId = getBookEntryId(item, idx);
          const titleParam = encodeURIComponent(String(item?.title || '').trim());
          const authorParam = encodeURIComponent(String((Array.isArray(item?.author_name) ? item.author_name[0] : '') || '').trim());
          state.bookIndex.set(bookId, item);

          const card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('data-book-id', bookId);
          card.innerHTML = `
            <img
              src="${thumb || FALLBACK_BOOK_IMAGE}"
              alt="${item.title || 'Book'}"
              loading="lazy"
              onerror="this.onerror=null;this.src='images/logo.png';">
            <div class="card-body">
              <h3 class="card-title">${item.title || 'Untitled'}</h3>
              <div class="card-meta-row">
                <div class="card-meta">${authors}${year ? ` � ${year}` : ''}</div>
                <div class="card-menu-wrap">
                  <button class="menu-btn" aria-label="Save to lists"><i class="fas fa-ellipsis-v"></i></button>
                </div>
              </div>
              <div class="card-desc">${desc}</div>
            </div>
          `;
          card.onclick = (e) => {
            if (e.target.closest('.menu-btn')) return;
            window.location.href = `book.html?id=${encodeURIComponent(bookId)}&title=${titleParam}&author=${authorParam}`;
          };
          wireCardMenu(card, bookId);
          updateCardMenuUI(card, bookId);
          fragment.appendChild(card);
        });
        grid.innerHTML = '';
        grid.appendChild(fragment);
        if (empty) empty.style.display = 'none';

        const reportedTotal = Number(data.numFound || 0) || 0;
        const currentPage = Math.max(1, Number(state.page || 1));
        const minimumTotal = ((currentPage - 1) * BOOKS_PER_PAGE) + results.length;
        let effectiveTotal = Math.max(reportedTotal, minimumTotal);
        if (results.length >= BOOKS_PER_PAGE && effectiveTotal <= (currentPage * BOOKS_PER_PAGE)) {
          effectiveTotal = (currentPage * BOOKS_PER_PAGE) + BOOKS_PER_PAGE;
        }
        state.totalPages = Math.max(currentPage, Math.ceil(effectiveTotal / BOOKS_PER_PAGE));
        updatePagination();
      }

      function wireCardMenu(card, bookId) {
        const menuBtn = card.querySelector('.menu-btn');
        if (!menuBtn) return;
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (typeof window.openIndexStyleListMenu === 'function') {
            window.openIndexStyleListMenu(card);
          }
        });
      }

      function ensureListMenuBackdrop() {
        let backdrop = document.getElementById('listMenuBackdrop');
        if (!backdrop) {
          backdrop = document.createElement('div');
          backdrop.id = 'listMenuBackdrop';
          backdrop.className = 'list-menu-backdrop';
          backdrop.addEventListener('click', closeAllListMenus);
          document.body.appendChild(backdrop);
        }
        return backdrop;
      }

      function showListMenuBackdrop() {
        const backdrop = ensureListMenuBackdrop();
        backdrop.classList.add('active');
      }

      function hideListMenuBackdrop() {
        const backdrop = document.getElementById('listMenuBackdrop');
        if (backdrop) backdrop.classList.remove('active');
      }

      function closeAllListMenus() {
        document.querySelectorAll('.list-menu.open').forEach(m => m.classList.remove('open'));
        document.querySelectorAll('.card.menu-open').forEach(c => c.classList.remove('menu-open'));
        hideListMenuBackdrop();
      }

      async function toggleDefaultList(bookId, listType, card, forcedNextSaved) {
        if (!state.currentUser) {
          showNotification('Please sign in to save books', 'info');
          return { ok: false, saved: false };
        }
        if (!supabaseClient) return { ok: false, saved: false };
        const status = state.listStatusMap.get(bookId) || { favorites: false, read: false, readlist: false };
        const previousSaved = !!status[listType];
        const nextSaved = typeof forcedNextSaved === 'boolean' ? forcedNextSaved : !previousSaved;
        const opKey = `${bookId}:${listType}`;
        if (state.pendingDefaultOps.has(opKey)) {
          return { ok: false, saved: previousSaved };
        }
        state.pendingDefaultOps.add(opKey);

        status[listType] = nextSaved;
        state.listStatusMap.set(bookId, status);
        if (card) updateCardMenuUI(card, bookId);

        try {
          if (nextSaved) {
            await upsertBookRecord(state.bookIndex.get(bookId), bookId);
            const { error } = await supabaseClient
              .from('book_list_items')
              .insert({ user_id: state.currentUser.id, book_id: bookId, list_type: listType });
            if (error) throw error;
            showNotification('Saved to list', 'success');
          } else {
            const { error } = await supabaseClient
              .from('book_list_items')
              .delete()
              .eq('user_id', state.currentUser.id)
              .eq('book_id', bookId)
              .eq('list_type', listType);
            if (error) throw error;
            showNotification('Removed from list', 'info');
          }
          return { ok: true, saved: nextSaved };
        } catch (_err) {
          status[listType] = previousSaved;
          state.listStatusMap.set(bookId, status);
          if (card) updateCardMenuUI(card, bookId);
          showNotification('Could not update list', 'error');
          return { ok: false, saved: previousSaved };
        } finally {
          state.pendingDefaultOps.delete(opKey);
        }
      }

      async function loadCustomLists() {
        if (!supabaseClient || !state.currentUser || !window.ListUtils) return [];
        return await ListUtils.loadCustomLists(supabaseClient, state.currentUser.id, 'book');
      }

      async function openBookListsModal(bookId) {
        if (!state.currentUser) {
          showNotification('Please sign in to manage lists', 'info');
          return;
        }
        state.activeBookId = bookId;
        const modal = document.getElementById('bookListsModal');
        const container = document.getElementById('bookListsContainer');
        if (!modal || !container) return;
        container.innerHTML = '<div class="chip">Loading...</div>';
        state.customLists = await loadCustomLists();
        const listIds = state.customLists.map(l => l.id);
        state.modalSelectedLists = window.ListUtils
          ? await ListUtils.loadCustomListMembership(supabaseClient, state.currentUser.id, 'book', bookId, listIds)
          : new Set();
        container.innerHTML = '';
        if (!state.customLists.length) {
          container.innerHTML = '<div class="chip">No custom lists yet.</div>';
        } else {
          state.customLists.forEach(list => {
            const item = document.createElement('div');
            item.className = 'modal-list-item' + (state.modalSelectedLists.has(list.id) ? ' active' : '');
            item.innerHTML = `
              <span>${renderListIcon(list.icon)} ${list.title}</span>
              <span class="modal-list-actions">
                <span>${state.modalSelectedLists.has(list.id) ? 'Saved' : 'Add'}</span>
                <button class="list-edit-btn" aria-label="Rename list"><i class="fas fa-pen"></i></button>
              </span>
            `;
            item.onclick = () => {
              if (state.modalSelectedLists.has(list.id)) {
                state.modalSelectedLists.delete(list.id);
              } else {
                state.modalSelectedLists.add(list.id);
              }
              item.classList.toggle('active');
              item.querySelector('.modal-list-actions span').textContent = state.modalSelectedLists.has(list.id) ? 'Saved' : 'Add';
            };
            const editBtn = item.querySelector('.list-edit-btn');
            if (editBtn) {
              editBtn.onclick = (e) => {
                e.stopPropagation();
                renameBookList(list.id, list.title);
              };
            }
            container.appendChild(item);
          });
        }
        modal.classList.add('active');
      }

      async function saveBookListChanges() {
        if (!supabaseClient || !state.currentUser || !state.activeBookId) return;
        if (window.ListUtils) {
          const book = state.bookIndex.get(state.activeBookId);
          await ListUtils.saveCustomListChanges(
            supabaseClient,
            state.currentUser.id,
            'book',
            state.activeBookId,
            [...state.modalSelectedLists],
            book
              ? {
                id: state.activeBookId,
                title: book.title || '',
                authors: (book.author_name || []).join(', '),
                thumbnail: getPreferredBookImage(book) || ''
              }
              : null
          );
        }
        showNotification('Lists updated', 'success');
        closeBookListsModal();
      }

      function closeBookListsModal() {
        const modal = document.getElementById('bookListsModal');
        if (modal) modal.classList.remove('active');
        state.activeBookId = null;
      }

      async function createBookList() {
        const input = document.getElementById('newBookListName');
        if (!input || !input.value.trim()) return;
        if (!supabaseClient || !state.currentUser) return;
        const title = input.value.trim();
        const modal = document.getElementById('bookListsModal');
        const tierState = window.ListUtils && modal
          ? ListUtils.readTierCreateState(modal)
          : { listKind: 'standard', maxRank: null };
        const data = window.ListUtils
          ? await ListUtils.createCustomList(supabaseClient, state.currentUser.id, 'book', {
            title,
            icon: state.selectedIcon || 'fas fa-book',
          listKind: tierState.listKind,
          maxRank: tierState.maxRank
          })
          : null;
        if (!data) {
          showNotification('Could not create list', 'error');
          return;
        }
        input.value = '';
        if (window.ListUtils && modal) ListUtils.resetTierCreateState(modal);
        state.customLists.unshift(data);
        openBookListsModal(state.activeBookId);
      }

      async function renameBookList(listId, currentTitle) {
        const nextTitle = prompt('Rename list', currentTitle || '');
        if (!nextTitle || !nextTitle.trim()) return;
        if (!supabaseClient || !state.currentUser) return;
        const ok = window.ListUtils
          ? await ListUtils.renameCustomList(supabaseClient, state.currentUser.id, 'book', listId, nextTitle.trim())
          : false;
        if (!ok) {
          showNotification('Could not rename list', 'error');
          return;
        }
        state.customLists = state.customLists.map(l => l.id === listId ? { ...l, title: nextTitle.trim() } : l);
        openBookListsModal(state.activeBookId);
      }

      function wireUI() {
        const searchInput = document.getElementById('searchInput');
        const categorySelect = document.getElementById('categorySelect');
        const yearInput = document.getElementById('yearInput');
        const authorInput = document.getElementById('authorInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const closeListsBtn = document.getElementById('closeBookListsBtn');
        const saveListsBtn = document.getElementById('saveBookListsBtn');
        const createListBtn = document.getElementById('createBookListBtn');
        const iconOptions = document.querySelectorAll('#bookListIconOptions .icon-option');
        const debouncedSearchReload = debounce(() => {
          renderFilters();
          state.page = 1;
          loadBooks();
        }, 280);
        if (searchInput) {
          searchInput.addEventListener('input', (e) => {
            state.query = e.target.value.trim();
            debouncedSearchReload();
          });
        }
        if (categorySelect) {
          categorySelect.addEventListener('change', (e) => {
            state.activeCategory = e.target.value;
            renderFilters();
            state.page = 1;
            loadBooks();
          });
        }
        if (yearInput) {
          yearInput.addEventListener('input', (e) => {
            state.year = e.target.value.trim();
            renderFilters();
            state.page = 1;
            loadBooks();
          });
        }
        if (authorInput) {
          authorInput.addEventListener('input', (e) => {
            state.author = e.target.value.trim();
            debouncedSearchReload();
          });
        }
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => loadBooks());
        }
        if (prevBtn) {
          prevBtn.addEventListener('click', () => {
            if (state.page > 1) {
              state.page -= 1;
              loadBooks();
            }
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener('click', () => {
            if (state.page < state.totalPages) {
              state.page += 1;
              loadBooks();
            }
          });
        }
        if (closeListsBtn) closeListsBtn.addEventListener('click', closeBookListsModal);
        if (saveListsBtn) saveListsBtn.addEventListener('click', saveBookListChanges);
        if (createListBtn) createListBtn.addEventListener('click', createBookList);
        iconOptions.forEach(btn => {
          btn.addEventListener('click', () => {
            iconOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.selectedIcon = btn.getAttribute('data-icon') || 'fas fa-book';
          });
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAllListMenus();
        });
      }

      function updatePagination() {
        const prevBtn = document.getElementById('prevPageBtn');
        const nextBtn = document.getElementById('nextPageBtn');
        const info = document.getElementById('pageInfo');
        if (prevBtn) prevBtn.disabled = state.page <= 1;
        if (nextBtn) nextBtn.disabled = state.page >= state.totalPages;
        if (info) info.textContent = `Page ${state.page} of ${state.totalPages}`;
      }

      function syncSearchStateFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const search = (params.get('search') || '').trim();
        if (!search) return;
        state.query = search;
        const searchInput = document.getElementById('searchInput');
        if (searchInput) searchInput.value = search;
      }

      if (window.initIndexStyleListMenu) {
        window.initIndexStyleListMenu({
          mediaType: 'book',
          itemIdAttr: 'data-book-id',
          getVisibleItemIds: () =>
            Array.from(document.querySelectorAll('.card[data-book-id]'))
              .map((card) => card.getAttribute('data-book-id'))
              .filter(Boolean),
          getQuickStatusForItem: (itemId) => {
            const key = String(itemId || '');
            const status = state.listStatusMap.get(key);
            return status ? { ...status } : null;
          },
          ensureClient: async () => {
            if (supabaseClient) return supabaseClient;
            await initSupabase();
            return supabaseClient;
          },
          getCurrentUser: () => state.currentUser,
          notify: (message, isError) => showNotification(message, isError ? 'error' : 'success'),
          toggleDefaultList: async ({ itemId, listType, card, nextSaved }) =>
            toggleDefaultList(itemId, listType, card, nextSaved)
        });
      }

      (async function init() {
        await initSupabase();
        wireUI();
        syncSearchStateFromUrl();
        populateCategories();
        await initAuth();
        renderFilters();
        loadBooks();
      })();
    })();
  </script>
  <script src="js/production-runtime.js?v=20260221a" defer></script>
</body>
</html>



















