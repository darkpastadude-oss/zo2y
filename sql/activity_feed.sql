-- Activity feed table + triggers for profile community activity stream.
-- Run this in Supabase SQL editor whenever schema or activity mappings change.

create table if not exists public.user_activity_feed (
  id bigint generated by default as identity primary key,
  actor_id uuid not null references auth.users(id) on delete cascade,
  event_type text not null check (
    event_type in (
      'list_create',
      'list_delete',
      'list_add',
      'list_remove',
      'review_add',
      'review_edit',
      'review_delete'
    )
  ),
  media_type text not null,
  item_id text,
  list_type text,
  list_id uuid,
  rating numeric(3,1),
  review_text text,
  metadata jsonb not null default '{}'::jsonb,
  created_at timestamptz not null default now()
);

create index if not exists idx_user_activity_feed_actor_created
  on public.user_activity_feed (actor_id, created_at desc);

create index if not exists idx_user_activity_feed_created
  on public.user_activity_feed (created_at desc);

alter table public.user_activity_feed enable row level security;

-- Keep the check constraint current if table already exists.
alter table public.user_activity_feed
  drop constraint if exists user_activity_feed_event_type_check;
alter table public.user_activity_feed
  add constraint user_activity_feed_event_type_check
  check (
    event_type in (
      'list_create',
      'list_delete',
      'list_add',
      'list_remove',
      'review_add',
      'review_edit',
      'review_delete'
    )
  );

drop policy if exists "activity_feed_select_public" on public.user_activity_feed;
create policy "activity_feed_select_public"
  on public.user_activity_feed
  for select
  to anon, authenticated
  using (true);

drop policy if exists "activity_feed_insert_own" on public.user_activity_feed;
create policy "activity_feed_insert_own"
  on public.user_activity_feed
  for insert
  to authenticated
  with check (auth.uid() = actor_id);

create or replace function public.log_list_activity_iud()
returns trigger
language plpgsql
as $$
declare
  v_event_type text;
  v_media_type text;
  v_item_id text;
  v_actor_id uuid;
  v_list_type text;
  v_list_id uuid;
  v_payload jsonb;
begin
  v_event_type := case tg_op
    when 'INSERT' then 'list_add'
    when 'DELETE' then 'list_remove'
    else null
  end;
  if v_event_type is null then
    return coalesce(new, old);
  end if;

  v_media_type := case tg_table_name
    when 'movie_list_items' then 'movie'
    when 'tv_list_items' then 'tv'
    when 'anime_list_items' then 'anime'
    when 'game_list_items' then 'game'
    when 'book_list_items' then 'book'
    when 'music_list_items' then 'music'
    else null
  end;

  v_payload := case
    when tg_op = 'INSERT' then to_jsonb(new)
    when tg_op = 'DELETE' then to_jsonb(old)
    else '{}'::jsonb
  end;

  v_item_id := case tg_table_name
    when 'movie_list_items' then nullif(v_payload->>'movie_id', '')
    when 'tv_list_items' then nullif(v_payload->>'tv_id', '')
    when 'anime_list_items' then nullif(v_payload->>'anime_id', '')
    when 'game_list_items' then nullif(v_payload->>'game_id', '')
    when 'book_list_items' then nullif(v_payload->>'book_id', '')
    when 'music_list_items' then nullif(v_payload->>'track_id', '')
    else null
  end;
  v_actor_id := nullif(v_payload->>'user_id', '')::uuid;
  v_list_type := nullif(v_payload->>'list_type', '');
  v_list_id := nullif(v_payload->>'list_id', '')::uuid;

  if v_media_type is null or v_item_id is null or v_actor_id is null then
    return coalesce(new, old);
  end if;

  insert into public.user_activity_feed (
    actor_id,
    event_type,
    media_type,
    item_id,
    list_type,
    list_id,
    metadata
  ) values (
    v_actor_id,
    v_event_type,
    v_media_type,
    v_item_id,
    v_list_type,
    v_list_id,
    jsonb_build_object(
      'source_table', tg_table_name,
      'source_pk', nullif(v_payload->>'id', '')
    )
  );

  return coalesce(new, old);
end;
$$;

create or replace function public.log_custom_list_activity_iud()
returns trigger
language plpgsql
as $$
declare
  v_event_type text;
  v_media_type text;
  v_actor_id uuid;
  v_list_id uuid;
  v_list_title text;
  v_payload jsonb;
begin
  v_event_type := case tg_op
    when 'INSERT' then 'list_create'
    when 'DELETE' then 'list_delete'
    else null
  end;
  if v_event_type is null then
    return coalesce(new, old);
  end if;

  v_media_type := case tg_table_name
    when 'movie_lists' then 'movie'
    when 'tv_lists' then 'tv'
    when 'anime_lists' then 'anime'
    when 'game_lists' then 'game'
    when 'book_lists' then 'book'
    when 'music_lists' then 'music'
    when 'lists' then 'restaurant'
    else null
  end;

  v_payload := case
    when tg_op = 'INSERT' then to_jsonb(new)
    when tg_op = 'DELETE' then to_jsonb(old)
    else '{}'::jsonb
  end;

  v_actor_id := nullif(v_payload->>'user_id', '')::uuid;
  v_list_id := nullif(v_payload->>'id', '')::uuid;
  v_list_title := nullif(trim(v_payload->>'title'), '');

  if v_media_type is null or v_actor_id is null or v_list_id is null then
    return coalesce(new, old);
  end if;

  insert into public.user_activity_feed (
    actor_id,
    event_type,
    media_type,
    list_id,
    metadata
  ) values (
    v_actor_id,
    v_event_type,
    v_media_type,
    v_list_id,
    jsonb_build_object(
      'source_table', tg_table_name,
      'source_pk', nullif(v_payload->>'id', ''),
      'list_title', v_list_title
    )
  );

  return coalesce(new, old);
end;
$$;

create or replace function public.log_media_review_activity_iud()
returns trigger
language plpgsql
as $$
declare
  v_event_type text;
  v_media_type text;
  v_actor_id uuid;
  v_item_id text;
  v_review_text text;
  v_rating numeric(3,1);
  v_payload jsonb;
  v_metadata jsonb;
begin
  v_event_type := case tg_op
    when 'INSERT' then 'review_add'
    when 'UPDATE' then 'review_edit'
    when 'DELETE' then 'review_delete'
    else null
  end;
  if v_event_type is null then
    return coalesce(new, old);
  end if;

  v_media_type := case tg_table_name
    when 'movie_reviews' then 'movie'
    when 'tv_reviews' then 'tv'
    when 'anime_reviews' then 'anime'
    when 'game_reviews' then 'game'
    when 'book_reviews' then 'book'
    when 'music_reviews' then 'music'
    when 'journal_entries' then 'restaurant'
    else null
  end;

  v_payload := case
    when tg_op in ('INSERT', 'UPDATE') then to_jsonb(new)
    when tg_op = 'DELETE' then to_jsonb(old)
    else '{}'::jsonb
  end;

  v_actor_id := nullif(v_payload->>'user_id', '')::uuid;
  v_item_id := case tg_table_name
    when 'movie_reviews' then nullif(v_payload->>'movie_id', '')
    when 'tv_reviews' then nullif(v_payload->>'tv_id', '')
    when 'anime_reviews' then nullif(v_payload->>'anime_id', '')
    when 'game_reviews' then nullif(v_payload->>'game_id', '')
    when 'book_reviews' then nullif(v_payload->>'book_id', '')
    when 'music_reviews' then nullif(v_payload->>'track_id', '')
    when 'journal_entries' then coalesce(
      nullif(v_payload->>'restraunt_id', ''),
      nullif(v_payload->>'restaurant_id', '')
    )
    else null
  end;
  v_review_text := case tg_table_name
    when 'journal_entries' then nullif(trim(v_payload->>'notes'), '')
    else nullif(trim(v_payload->>'comment'), '')
  end;
  v_rating := nullif(v_payload->>'rating', '')::numeric(3,1);

  v_metadata := jsonb_build_object('source_table', tg_table_name);
  v_metadata := v_metadata || jsonb_build_object('source_pk', nullif(v_payload->>'id', ''));
  if tg_table_name = 'journal_entries' then
    v_metadata := v_metadata || jsonb_build_object(
      'visit_date', v_payload->>'visit_date',
      'tags', coalesce(v_payload->'tags', '[]'::jsonb)
    );
  end if;

  if v_media_type is null or v_actor_id is null or v_item_id is null then
    return coalesce(new, old);
  end if;

  insert into public.user_activity_feed (
    actor_id,
    event_type,
    media_type,
    item_id,
    rating,
    review_text,
    metadata
  ) values (
    v_actor_id,
    v_event_type,
    v_media_type,
    v_item_id,
    v_rating,
    v_review_text,
    v_metadata
  );

  return coalesce(new, old);
end;
$$;

create or replace function public.ensure_activity_trigger(
  p_table_name text,
  p_trigger_name text,
  p_events text,
  p_function_name text
)
returns void
language plpgsql
as $$
begin
  if to_regclass(format('public.%s', p_table_name)) is null then
    return;
  end if;

  execute format('drop trigger if exists %I on public.%I', p_trigger_name, p_table_name);
  execute format(
    'create trigger %I after %s on public.%I for each row execute function %s()',
    p_trigger_name,
    p_events,
    p_table_name,
    p_function_name
  );
end;
$$;

-- List item add/remove activity.
select public.ensure_activity_trigger('movie_list_items', 'trg_movie_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('movie_list_items', 'trg_movie_list_remove_activity', 'delete', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('tv_list_items', 'trg_tv_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('tv_list_items', 'trg_tv_list_remove_activity', 'delete', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('anime_list_items', 'trg_anime_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('anime_list_items', 'trg_anime_list_remove_activity', 'delete', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('game_list_items', 'trg_game_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('game_list_items', 'trg_game_list_remove_activity', 'delete', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('book_list_items', 'trg_book_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('book_list_items', 'trg_book_list_remove_activity', 'delete', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('music_list_items', 'trg_music_list_add_activity', 'insert', 'public.log_list_activity_iud');
select public.ensure_activity_trigger('music_list_items', 'trg_music_list_remove_activity', 'delete', 'public.log_list_activity_iud');

-- Custom list create/delete activity.
select public.ensure_activity_trigger('movie_lists', 'trg_movie_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('movie_lists', 'trg_movie_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('tv_lists', 'trg_tv_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('tv_lists', 'trg_tv_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('anime_lists', 'trg_anime_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('anime_lists', 'trg_anime_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('game_lists', 'trg_game_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('game_lists', 'trg_game_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('book_lists', 'trg_book_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('book_lists', 'trg_book_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('music_lists', 'trg_music_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('music_lists', 'trg_music_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('lists', 'trg_restaurant_list_create_activity', 'insert', 'public.log_custom_list_activity_iud');
select public.ensure_activity_trigger('lists', 'trg_restaurant_list_delete_activity', 'delete', 'public.log_custom_list_activity_iud');

-- Review add/edit/delete activity.
select public.ensure_activity_trigger('movie_reviews', 'trg_movie_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('movie_reviews', 'trg_movie_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('movie_reviews', 'trg_movie_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('tv_reviews', 'trg_tv_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('tv_reviews', 'trg_tv_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('tv_reviews', 'trg_tv_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('anime_reviews', 'trg_anime_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('anime_reviews', 'trg_anime_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('anime_reviews', 'trg_anime_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('game_reviews', 'trg_game_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('game_reviews', 'trg_game_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('game_reviews', 'trg_game_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('book_reviews', 'trg_book_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('book_reviews', 'trg_book_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('book_reviews', 'trg_book_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('music_reviews', 'trg_music_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('music_reviews', 'trg_music_review_edit_activity', 'update of rating, comment', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('music_reviews', 'trg_music_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('journal_entries', 'trg_journal_review_add_activity', 'insert', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('journal_entries', 'trg_journal_review_edit_activity', 'update of rating, notes, visit_date, tags', 'public.log_media_review_activity_iud');
select public.ensure_activity_trigger('journal_entries', 'trg_journal_review_delete_activity', 'delete', 'public.log_media_review_activity_iud');

-- Best-effort backfill for existing rows so feed is populated immediately.
do $$
begin
  if to_regclass('public.movie_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'movie',
      src.movie_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'movie_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.movie_list_items src
    where src.user_id is not null
      and src.movie_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'movie'
          and f.metadata->>'source_table' = 'movie_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.tv_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'tv',
      src.tv_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'tv_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.tv_list_items src
    where src.user_id is not null
      and src.tv_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'tv'
          and f.metadata->>'source_table' = 'tv_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.anime_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'anime',
      src.anime_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'anime_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.anime_list_items src
    where src.user_id is not null
      and src.anime_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'anime'
          and f.metadata->>'source_table' = 'anime_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.game_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'game',
      src.game_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'game_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.game_list_items src
    where src.user_id is not null
      and src.game_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'game'
          and f.metadata->>'source_table' = 'game_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.book_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'book',
      src.book_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'book_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.book_list_items src
    where src.user_id is not null
      and src.book_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'book'
          and f.metadata->>'source_table' = 'book_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.music_list_items') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, list_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_add',
      'music',
      src.track_id::text,
      src.list_type,
      src.list_id,
      jsonb_build_object('source_table', 'music_list_items', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.music_list_items src
    where src.user_id is not null
      and src.track_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_add'
          and f.media_type = 'music'
          and f.metadata->>'source_table' = 'music_list_items'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.movie_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'movie',
      src.id,
      jsonb_build_object('source_table', 'movie_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.movie_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'movie'
          and f.metadata->>'source_table' = 'movie_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.tv_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'tv',
      src.id,
      jsonb_build_object('source_table', 'tv_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.tv_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'tv'
          and f.metadata->>'source_table' = 'tv_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.anime_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'anime',
      src.id,
      jsonb_build_object('source_table', 'anime_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.anime_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'anime'
          and f.metadata->>'source_table' = 'anime_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.game_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'game',
      src.id,
      jsonb_build_object('source_table', 'game_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.game_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'game'
          and f.metadata->>'source_table' = 'game_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.book_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'book',
      src.id,
      jsonb_build_object('source_table', 'book_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.book_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'book'
          and f.metadata->>'source_table' = 'book_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.music_lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'music',
      src.id,
      jsonb_build_object('source_table', 'music_lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.music_lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'music'
          and f.metadata->>'source_table' = 'music_lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.lists') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, list_id, metadata, created_at
    )
    select
      src.user_id,
      'list_create',
      'restaurant',
      src.id,
      jsonb_build_object('source_table', 'lists', 'source_pk', src.id::text, 'list_title', src.title, 'backfill', true),
      coalesce(src.created_at, now())
    from public.lists src
    where src.user_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'list_create'
          and f.media_type = 'restaurant'
          and f.metadata->>'source_table' = 'lists'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.movie_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'movie',
      src.movie_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'movie_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.movie_reviews src
    where src.user_id is not null
      and src.movie_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'movie'
          and f.metadata->>'source_table' = 'movie_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.tv_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'tv',
      src.tv_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'tv_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.tv_reviews src
    where src.user_id is not null
      and src.tv_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'tv'
          and f.metadata->>'source_table' = 'tv_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.anime_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'anime',
      src.anime_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'anime_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.anime_reviews src
    where src.user_id is not null
      and src.anime_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'anime'
          and f.metadata->>'source_table' = 'anime_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.game_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'game',
      src.game_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'game_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.game_reviews src
    where src.user_id is not null
      and src.game_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'game'
          and f.metadata->>'source_table' = 'game_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.book_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'book',
      src.book_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'book_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.book_reviews src
    where src.user_id is not null
      and src.book_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'book'
          and f.metadata->>'source_table' = 'book_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.music_reviews') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'music',
      src.track_id::text,
      src.rating::numeric(3,1),
      nullif(trim(src.comment), ''),
      jsonb_build_object('source_table', 'music_reviews', 'source_pk', src.id::text, 'backfill', true),
      coalesce(src.created_at, now())
    from public.music_reviews src
    where src.user_id is not null
      and src.track_id is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'music'
          and f.metadata->>'source_table' = 'music_reviews'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;

  if to_regclass('public.journal_entries') is not null then
    insert into public.user_activity_feed (
      actor_id, event_type, media_type, item_id, rating, review_text, metadata, created_at
    )
    select
      src.user_id,
      'review_add',
      'restaurant',
      coalesce(
        nullif(to_jsonb(src)->>'restraunt_id', ''),
        nullif(to_jsonb(src)->>'restaurant_id', '')
      ),
      src.rating::numeric(3,1),
      nullif(trim(coalesce(to_jsonb(src)->>'notes', '')), ''),
      jsonb_build_object(
        'source_table', 'journal_entries',
        'source_pk', src.id::text,
        'visit_date', to_jsonb(src)->>'visit_date',
        'tags', coalesce(to_jsonb(src)->'tags', '[]'::jsonb),
        'backfill', true
      ),
      coalesce(src.created_at, now())
    from public.journal_entries src
    where src.user_id is not null
      and coalesce(
        nullif(to_jsonb(src)->>'restraunt_id', ''),
        nullif(to_jsonb(src)->>'restaurant_id', '')
      ) is not null
      and not exists (
        select 1
        from public.user_activity_feed f
        where f.event_type = 'review_add'
          and f.media_type = 'restaurant'
          and f.metadata->>'source_table' = 'journal_entries'
          and f.metadata->>'source_pk' = src.id::text
      );
  end if;
end
$$;

-- Optional cleanup for helper.
drop function if exists public.ensure_activity_trigger(text, text, text, text);

-- Ensure Supabase REST picks up new table/functions promptly.
notify pgrst, 'reload schema';
