<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="index,follow,max-image-preview:none,noimageindex" />
  <title>Zo2y - Movie</title>
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --glass: rgba(255,255,255,0.03);
      --white: #ffffff;
      --border: rgba(255,255,255,0.1);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --shadow: 0 10px 30px rgba(0,0,0,0.3);
      --success: #10b981;
      --error: #ef4444;
      --info: #3b82f6;
      --surface: rgba(19, 35, 71, 0.6);
      --radial-glow: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      --text2: #9fb0cf;
      --input-bg: #0f1f40;
      --input-text: #ffffff;
      --btn-bg: var(--gradient);
      --btn-text: #0b1633;
      --nav-shadow: rgba(255,255,255,0.08);
      --nav-bg: #0f1f40;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      inset: -20% 0 0 0;
      background: var(--radial-glow);
      pointer-events: none;
      z-index: -2;
    }
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0 12px, rgba(255, 184, 77, 0) 12px 24px);
      opacity: 0.25;
      pointer-events: none;
      z-index: -3;
    }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 14px 16px;
      backdrop-filter: blur(10px) saturate(180%);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      gap: 12px;
    }
    .logo {
      height: 40px;
      width: auto;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    .logo:hover { transform: scale(1.05); }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .nav-search {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-search-input {
      width: 220px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      padding: 0 10px;
      font-size: 13px;
    }
    .nav-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.14);
    }
    .nav-search-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
    }
    .nav-search-btn:hover { border-color: var(--accent); color: var(--accent); }
    .search-suggest {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      z-index: 1200;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .search-suggest.open { display: block; }
    .search-suggest-item {
      display: grid;
      grid-template-columns: 38px 1fr;
      gap: 10px;
      align-items: center;
      width: 100%;
      border: 0;
      background: transparent;
      color: var(--white);
      text-align: left;
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .search-suggest-item:last-child { border-bottom: 0; }
    .search-suggest-item:hover,
    .search-suggest-item.active { background: rgba(245, 158, 11, 0.14); }
    .search-suggest-thumb {
      width: 38px;
      height: 52px;
      border-radius: 6px;
      object-fit: cover;
      background: #0f1f40;
      border: 1px solid var(--border);
    }
    .search-suggest-title {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-suggest-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nav a.ghost {
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }
    .nav a.ghost:hover { color: var(--accent); background: rgba(245, 158, 11, 0.05); }
    .account-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .account-btn:hover { border-color: var(--accent); color: var(--accent); }
    .account-btn.logged-in {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.4);
      color: var(--accent);
    }
    .account-btn.logged-in:hover { background: rgba(245, 158, 11, 0.25); }
    .wrap { max-width: 1200px; margin: 24px auto 40px; padding: 0 20px; display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .poster { width: 100%; border-radius: 14px; border: 1px solid var(--border); background: #0f1f40; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
    .title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    .title { margin: 0 0 8px; font-size: 28px; }
    .meta { color: var(--muted); font-size: 14px; margin-bottom: 16px; }
    .overview { line-height: 1.6; color: var(--muted); }
    .section-title { margin: 20px 0 8px; font-size: 16px; }
    .people-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .person-chip { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 10px; }
    .meta-item { background: #0f1f40; border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 12px; color: var(--muted); }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 12px; margin-right: 8px; }
    .video-frame { width: 100%; aspect-ratio: 16 / 9; border: 0; border-radius: 12px; background: #0f1f40; }
    .list-stack { display: grid; gap: 6px; }
    .list-row { display: flex; gap: 8px; align-items: baseline; color: var(--muted); font-size: 12px; }
    .list-label { color: var(--white); font-weight: 600; }
    .menu-wrapper { position: relative; }
    .menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .menu-btn:hover { border-color: var(--accent); color: var(--accent); }
    .list-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      min-width: 220px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 20;
    }
    .list-menu.open { display: block; }
    .list-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 28, 0.55);
      z-index: 10;
      display: none;
    }
    .list-menu-backdrop.active { display: block; }
    .list-menu-title { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .list-action {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all 0.2s ease;
      margin-bottom: 6px;
    }
    .list-action:last-child { margin-bottom: 0; }
    .list-action:hover { border-color: var(--accent); color: var(--accent); }
    .list-action.active {
      background: rgba(245, 158, 11, 0.12);
      border-color: var(--accent);
      color: var(--accent);
    }
    .section {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 20px;
    }
    .section h2 { margin: 0 0 12px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn.primary { background: var(--gradient); border: none; color: #0b1633; font-weight: 600; }
    .btn.secondary { background: #0f1f40; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 2000;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
    }
    .notification.success { background: var(--success); color: white; }
    .notification.error { background: var(--error); color: white; }
    .notification.info { background: var(--info); color: white; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      color: var(--white);
      font-size: 22px;
      cursor: pointer;
    }
    .modal-list {
      display: grid;
      gap: 8px;
      max-height: 240px;
      overflow: auto;
      margin-bottom: 12px;
    }
    .modal-list-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .modal-list-actions { display: inline-flex; gap: 6px; align-items: center; }
    .list-edit-btn {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .list-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    .modal-list-item.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }
    .modal-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .modal-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      outline: none;
    }
    .icon-options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .icon-option {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .icon-option.selected { border-color: var(--accent); color: var(--accent); }
    .reviews-stats {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--nav-shadow);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }
    .stat-item { text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); line-height: 1; }
    .stat-label { font-size: 0.85rem; color: var(--text2); margin-top: 5px; }
    .rating-breakdown { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .rating-row { display: flex; align-items: center; gap: 10px; }
    .rating-stars { color: #FF9800; font-size: 0.9rem; width: 60px; }
    .rating-bar { flex: 1; height: 8px; background: var(--nav-shadow); border-radius: 4px; overflow: hidden; }
    .rating-fill { height: 100%; background: #FF9800; border-radius: 4px; transition: width 0.5s ease; }
    .rating-count { font-size: 0.8rem; color: var(--text2); width: 30px; text-align: right; }
    .reviews-container { margin-bottom: 40px; }
    .review-card {
      background: var(--card);
      border: 1px solid var(--nav-shadow);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .review-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 15px; }
    .reviewer-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .reviewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #FF6F00);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .reviewer-name { font-weight: 600; color: var(--white); margin-bottom: 2px; }
    .reviewer-link {
      color: var(--white);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .reviewer-link:hover { color: var(--accent); text-decoration: underline; }
    .review-date { font-size: 0.8rem; color: var(--text2); }
    .review-rating { color: #FF9800; font-size: 1.1rem; white-space: nowrap; }
    .review-actions { display: flex; gap: 8px; margin-top: 12px; }
    .review-edit, .review-delete {
      background: none;
      border: 1px solid var(--nav-shadow);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text2);
    }
    .review-edit:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .review-delete:hover { background: var(--error); color: white; border-color: var(--error); }
    .review-comment { color: var(--white); line-height: 1.5; margin-bottom: 0; }
    .review-form-section {
      background: var(--card);
      padding: 25px;
      border-radius: 12px;
      border: 1px solid var(--nav-shadow);
    }
    .rating-input { margin-bottom: 20px; }
    .rating-input label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--white); }
    .stars-rating { display: flex; gap: 4px; margin-bottom: 8px; }
    .star {
      font-size: 2rem;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
      min-width: 40px;
      text-align: center;
      user-select: none;
    }
    .star:hover, .star.active { color: #FF9800; transform: scale(1.05); }
    .rating-text { font-size: 0.9rem; color: var(--text2); font-style: italic; }
    .comment-input { margin-bottom: 20px; }
    .comment-input textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--nav-shadow);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 0.95rem;
      resize: vertical;
      transition: all 0.3s ease;
      min-height: 100px;
      font-family: inherit;
    }
    .comment-input textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1); }
    .char-count { text-align: right; font-size: 0.8rem; color: var(--text2); margin-top: 4px; }
    .form-actions { display: flex; gap: 12px; align-items: center; }
    .submit-review-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-review-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3); }
    .cancel-edit-btn { background: var(--nav-bg); color: var(--white); border: 1px solid var(--nav-shadow); min-height: 44px; }
    .auth-prompt { text-align: center; padding: 30px 20px; color: var(--text2); }
    .auth-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.7; }
    .auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
    .auth-link:hover { text-decoration: underline; }
    .reviews-loading, .reviews-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
      font-style: italic;
    }
    .reviews-empty { background: var(--card); border-radius: 12px; border: 1px solid var(--nav-shadow); }
    .reviews-sort-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 20px;
      gap: 12px;
    }
    .sort-label { font-size: 0.9rem; color: var(--text2); }
    .sort-select {
      background: var(--card);
      border: 1px solid var(--nav-shadow);
      color: var(--white);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    .sort-select:hover { border-color: var(--accent); }
    .sort-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1); }
    @media (max-width: 900px) {
      .nav-container { flex-wrap: wrap; align-items: flex-start; gap: 8px; }
      .nav-right {
        width: 100%;
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto auto;
        align-items: center;
        gap: 8px;
      }
      .nav-search {
        grid-column: 1 / -1;
        width: 100%;
        order: 0;
      }
      .nav-search-input { width: 100%; }
      .wrap { grid-template-columns: 1fr; }
      .poster {
        width: min(62vw, 240px);
        max-width: 240px;
        margin: 0 auto 6px;
        justify-self: center;
      }
    }
    @media (max-width: 640px) {
      .nav { padding: 10px 12px; }
      .logo { height: 32px; }
      .nav-right > a.ghost:nth-of-type(2) { display: none; }
      .nav a.ghost {
        padding: 6px 10px;
        font-size: 12px;
      }
      .account-btn {
        gap: 6px;
        padding: 6px 10px;
        font-size: 12px;
      }
      .account-btn span { display: none; }
      .nav-search {
        position: relative;
        display: block;
      }
      .nav-search-input {
        height: 34px;
        border-radius: 10px;
        font-size: 12px;
        padding: 0 40px 0 10px;
      }
      .nav-search-btn {
        position: absolute;
        right: 3px;
        top: 3px;
        width: 28px;
        height: 28px;
        border-radius: 8px;
      }
    }
  </style>
  <meta name="theme-color" content="#0b1633" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Zo2y" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/images/logo.png" />
  <link rel="stylesheet" href="/js/mobile-app.css?v=20260225b" />
  <script src="/js/mobile-webapp.js" defer></script>
</head>
<body>
  <header class="nav" role="banner">
    <div class="nav-container">
      <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'" width="160" height="40" decoding="async" fetchpriority="high">
      <div class="nav-right">
        <div class="nav-search">
          <input id="pageSearchInput" class="nav-search-input" type="search" placeholder="Search movies..." aria-label="Search movies">
          <button id="pageSearchBtn" class="nav-search-btn" type="button" aria-label="Search movies"><i class="fas fa-search"></i></button>
          <div id="pageSearchSuggest" class="search-suggest"></div>
        </div>
        <a class="ghost" href="animes.html">Anime</a>
        <a class="ghost" href="reviews.html">Reviews</a>
        <a class="ghost" href="index.html">Home</a>
        <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <img id="poster" class="poster" src="images/placeholder.jpg" alt="Poster">
    <div class="card">
      <div class="title-row">
        <h1 id="title" class="title">Loading...</h1>
        <div class="menu-wrapper">
          <button class="menu-btn" id="movieMenuBtn" aria-label="Save to lists"><i class="fas fa-ellipsis-v"></i></button>
          <div class="list-menu" id="movieListMenu">
            <div class="list-menu-title">Save to list</div>
            <button class="list-action" data-list="favorites"><span><i class="fas fa-heart"></i> Favorites</span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="watched"><span><i class="fas fa-eye"></i> Watched</span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="watchlist"><span><i class="fas fa-bookmark"></i> Watchlist</span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="custom"><span><i class="fas fa-list"></i> Custom Lists</span><span class="list-action-state">Open</span></button>
          </div>
        </div>
      </div>
      <div id="meta" class="meta"></div>
      <div id="tags"></div>
      <p id="overview" class="overview"></p>
      <div class="meta-grid" id="metaGrid"></div>
      <h3 class="section-title">Details</h3>
      <div id="details" class="list-stack"></div>
      <h3 class="section-title">Trailer</h3>
      <div id="trailer"></div>
      <h3 class="section-title">Director</h3>
      <div id="directors" class="people-list"></div>
      <h3 class="section-title">Writers</h3>
      <div id="writers" class="people-list"></div>
      <h3 class="section-title">Cast</h3>
      <div id="cast" class="people-list"></div>
    </div>
  </div>

  <section id="reviews-section" class="section reviews">
    <h2>Movie Reviews</h2>
    <div class="reviews-sort-controls" id="reviewsSortControls" style="display: none;">
      <span class="sort-label">Sort by:</span>
      <select class="sort-select" id="sortSelect">
        <option value="latest">Latest</option>
        <option value="highest">Highest Rated</option>
        <option value="lowest">Lowest Rated</option>
      </select>
    </div>
    <div class="reviews-stats" id="reviewsStats">
      <div class="reviews-loading">Loading reviews...</div>
    </div>
    <div class="reviews-container" id="reviewsList"></div>
    <div class="review-form-section">
      <h3>Share Your Thoughts</h3>
      <form id="review-form" style="display: none;">
        <div class="rating-input">
          <label>Your Rating:</label>
          <div class="stars-rating">
            <span class="star" data-rating="1">★</span>
            <span class="star" data-rating="2">★</span>
            <span class="star" data-rating="3">★</span>
            <span class="star" data-rating="4">★</span>
            <span class="star" data-rating="5">★</span>
          </div>
          <span class="rating-text" id="ratingText">Select your rating</span>
        </div>
        <div class="comment-input">
          <textarea id="review-comment" placeholder="What did you think of this movie?" rows="4" maxlength="500"></textarea>
          <div class="char-count">
            <span id="charCount">0</span>/500 characters
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn submit-review-btn">
            <span class="btn-text">Submit Review</span>
          </button>
          <button type="button" class="btn secondary cancel-edit-btn" style="display: none;">Cancel Edit</button>
        </div>
      </form>
      <div id="auth-prompt" class="auth-prompt">
        <div class="auth-icon"><i class="fas fa-lock"></i></div>
        <p>Please <a href="login.html" class="auth-link">sign in</a> to review movies</p>
      </div>
    </div>
  </section>

  <div class="modal" id="movieListsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Custom Movie Lists</div>
        <button class="modal-close" id="closeMovieListsBtn">&times;</button>
      </div>
      <div class="modal-list" id="movieListsContainer"></div>
      <div class="modal-input">
        <input type="text" id="newMovieListName" placeholder="New list name..." maxlength="50">
        <button class="btn" id="createMovieListBtn">Create</button>
      </div>
      <div class="icon-options" id="movieListIconOptions">
        <button class="icon-option selected" data-icon="fas fa-film"><i class="fas fa-film"></i></button>
        <button class="icon-option" data-icon="fas fa-heart"><i class="fas fa-heart"></i></button>
        <button class="icon-option" data-icon="fas fa-star"><i class="fas fa-star"></i></button>
        <button class="icon-option" data-icon="fas fa-bookmark"><i class="fas fa-bookmark"></i></button>
        <button class="icon-option" data-icon="fas fa-eye"><i class="fas fa-eye"></i></button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn" id="saveMovieListsBtn">Save Changes</button>
      </div>
    </div>
  </div>

    <script src="js/list-utils.js?v=20260221c"></script>
    <script src="js/index-list-menu-adapter.js?v=20260221b"></script>
    <script>
    (function () {
      const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
      const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4NzVjMDM5N2IxZGUxYzU3NjQ4ZmRiNjJiZGQ5NmI0OSIsIm5iZiI6MTc3MDU4Mzk1NC42NTc5OTk4LCJzdWIiOiI2OTg4Zjc5MmFlYTFkN2NjNjcyY2VlNDciLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1RMWLft0Yl73gfhkCXtnqBIzRQHdaoLfZFYXYN7jm7s';
      const TMDB_BASE = 'https://api.themoviedb.org/3';
      const POSTER_BASE = 'https://image.tmdb.org/t/p/w500';
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const movieId = id ? Number(id) : null;
      let supabaseClient = null;
      let currentUser = null;
      let currentRating = 0;
      let editingReviewId = null;
      let reviews = [];
      let currentSort = 'latest';
      const listStatus = { favorites: false, watched: false, watchlist: false };
      const pendingListOps = new Set();
      let customLists = [];
      let modalSelectedLists = new Set();
      let selectedIcon = 'fas fa-film';

      async function tmdbFetch(path) {
        const res = await fetch(TMDB_BASE + path, {
          headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
        });
        if (!res.ok) throw new Error('TMDB error');
        return res.json();
      }

      function showNotification(message, type = 'info', duration = 3000) {
        const existing = document.querySelectorAll('.notification');
        existing.forEach(n => n.remove());
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), duration);
      }

      let lastAnimeSearchPrompt = '';
      let animeRedirectModal = null;
      let animeRedirectConfirmHandler = null;

      function isAnimeMovieResult(item) {
        const genreIds = Array.isArray(item?.genre_ids) ? item.genre_ids.map((entry) => Number(entry)) : [];
        const originalLanguage = String(item?.original_language || '').trim().toLowerCase();
        return genreIds.includes(16) && originalLanguage === 'ja';
      }

      function closeAnimeRedirectModal() {
        if (!animeRedirectModal) return;
        animeRedirectModal.style.display = 'none';
        animeRedirectConfirmHandler = null;
      }

      function ensureAnimeRedirectModal() {
        if (animeRedirectModal) return animeRedirectModal;
        const modal = document.createElement('div');
        modal.id = 'animeRedirectModal';
        modal.style.cssText = [
          'position:fixed',
          'inset:0',
          'background:rgba(6,10,20,0.68)',
          'backdrop-filter:blur(4px)',
          'z-index:12000',
          'display:none',
          'align-items:center',
          'justify-content:center',
          'padding:16px'
        ].join(';');
        modal.innerHTML = `
          <div style="width:min(92vw,420px);background:#132347;border:1px solid rgba(255,255,255,0.14);border-radius:16px;padding:18px;color:#fff;box-shadow:0 18px 50px rgba(0,0,0,0.45);position:relative;">
            <button type="button" data-close="1" aria-label="Close" style="position:absolute;top:10px;right:10px;width:30px;height:30px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:#0f1f40;color:#fff;cursor:pointer;">x</button>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
              <span style="width:34px;height:34px;border-radius:10px;background:rgba(245,158,11,0.2);display:inline-flex;align-items:center;justify-content:center;color:#f59e0b;"><i class="fas fa-dragon"></i></span>
              <strong style="font-size:17px;">Found Under Anime</strong>
            </div>
            <div id="animeRedirectTitle" style="font-size:15px;line-height:1.5;color:#e6eefc;"></div>
            <div id="animeRedirectSub" style="margin-top:6px;font-size:13px;color:#9fb0cf;">This title is categorized as Anime. Open Anime results?</div>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;">
              <button type="button" data-stay="1" style="padding:9px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:#0f1f40;color:#fff;cursor:pointer;">Stay Here</button>
              <button type="button" data-go="1" style="padding:9px 14px;border-radius:10px;border:none;background:#f59e0b;color:#0b1633;font-weight:700;cursor:pointer;">Go To Anime</button>
            </div>
          </div>
        `;
        modal.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          if (target === modal || target.closest('[data-close="1"]') || target.closest('[data-stay="1"]')) {
            closeAnimeRedirectModal();
            return;
          }
          if (target.closest('[data-go="1"]')) {
            const handler = animeRedirectConfirmHandler;
            closeAnimeRedirectModal();
            if (typeof handler === 'function') handler();
          }
        });
        document.addEventListener('keydown', (event) => {
          if (event.key === 'Escape' && modal.style.display !== 'none') {
            closeAnimeRedirectModal();
          }
        });
        document.body.appendChild(modal);
        animeRedirectModal = modal;
        return modal;
      }

      function showAnimeRedirectModal(query, matchedTitle) {
        const modal = ensureAnimeRedirectModal();
        const titleEl = modal.querySelector('#animeRedirectTitle');
        const displayTitle = String(matchedTitle || query || 'This result').trim();
        if (titleEl) {
          titleEl.textContent = `"${displayTitle}" is available in the Anime section.`;
        }
        const destinationUrl = new URL('animes.html', window.location.href);
        if (query) destinationUrl.searchParams.set('search', query);
        animeRedirectConfirmHandler = () => {
          window.location.href = `${destinationUrl.pathname}${destinationUrl.search}`;
        };
        modal.style.display = 'flex';
      }

      function promptAnimeRedirect(query, forcePrompt = false, matchedTitle = '') {
        const q = String(query || '').trim();
        if (!q) return;
        const key = `${q.toLowerCase()}::${String(matchedTitle || '').toLowerCase()}`;
        if (key === lastAnimeSearchPrompt) return;
        lastAnimeSearchPrompt = key;
        showAnimeRedirectModal(q, matchedTitle);
      }

      function renderListIcon(icon) {
        if (window.ListUtils) return ListUtils.renderListIcon(icon, 'fas fa-film');
        if (!icon) return '<i class="fas fa-film"></i>';
        if (icon.includes('fa-')) return `<i class="${icon}"></i>`;
        return icon;
      }

      async function initSupabase() {
        if (typeof supabase === 'undefined') {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        if (typeof supabase === 'undefined') return null;
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return supabaseClient;
      }

      async function initAuth() {
        if (!supabaseClient) return;
        const { data: { user } } = await supabaseClient.auth.getUser();
        currentUser = user || null;
        updateAccountButton();
        renderReviewForm();
        await loadListStatus();
        supabaseClient.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAccountButton();
          renderReviewForm();
          loadListStatus();
        });
      }

      function updateAccountButton() {
        const btn = document.getElementById('userAccountBtn');
        if (!btn) return;
        if (currentUser) {
          btn.classList.add('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Profile</span>';
          btn.onclick = () => window.location.href = 'profile.html';
        } else {
          btn.classList.remove('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Account</span>';
          btn.onclick = () => window.location.href = 'login.html';
        }
      }

      async function load() {
        if (!id) return;
        const [data, credits, videos, keywords, externals] = await Promise.all([
          tmdbFetch(`/movie/${id}?language=en`),
          tmdbFetch(`/movie/${id}/credits?language=en`),
          tmdbFetch(`/movie/${id}/videos?language=en`),
          tmdbFetch(`/movie/${id}/keywords`),
          tmdbFetch(`/movie/${id}/external_ids`)
        ]);
        document.getElementById('title').textContent = data.title || 'Untitled';
        document.getElementById('overview').textContent = data.overview || 'No description available.';
        document.getElementById('meta').textContent = `${data.release_date || ''} - ${data.runtime || ''} min`;
        document.getElementById('poster').src = data.poster_path ? POSTER_BASE + data.poster_path : 'images/placeholder.jpg';
        const tags = document.getElementById('tags');
        if (tags && Array.isArray(data.genres)) {
          tags.innerHTML = data.genres.map(g => `<span class="tag">${g.name}</span>`).join('');
        }
        const metaGrid = document.getElementById('metaGrid');
        if (metaGrid) {
          const items = [];
          if (data.original_language) items.push(`Language: ${data.original_language.toUpperCase()}`);
          if (data.status) items.push(`Status: ${data.status}`);
          if (typeof data.vote_average === 'number') items.push(`Rating: ${data.vote_average.toFixed(1)} (${data.vote_count || 0})`);
          if (typeof data.popularity === 'number') items.push(`Popularity: ${Math.round(data.popularity)}`);
          if (data.budget) items.push(`Budget: $${data.budget.toLocaleString()}`);
          if (data.revenue) items.push(`Revenue: $${data.revenue.toLocaleString()}`);
          metaGrid.innerHTML = items.map(i => `<div class="meta-item">${i}</div>`).join('');
        }
        const detailsEl = document.getElementById('details');
        if (detailsEl) {
          const detailRows = [];
          if (data.tagline) detailRows.push(`<div class="list-row"><span class="list-label">Tagline:</span> ${data.tagline}</div>`);
          if (Array.isArray(data.production_companies) && data.production_companies.length) {
            detailRows.push(`<div class="list-row"><span class="list-label">Studios:</span> ${data.production_companies.map(c => c.name).join(', ')}</div>`);
          }
          if (Array.isArray(data.production_countries) && data.production_countries.length) {
            detailRows.push(`<div class="list-row"><span class="list-label">Countries:</span> ${data.production_countries.map(c => c.name).join(', ')}</div>`);
          }
          if (Array.isArray(data.spoken_languages) && data.spoken_languages.length) {
            detailRows.push(`<div class="list-row"><span class="list-label">Languages:</span> ${data.spoken_languages.map(l => l.english_name || l.name).join(', ')}</div>`);
          }
          if (externals && externals.imdb_id) {
            detailRows.push(`<div class="list-row"><span class="list-label">IMDB:</span> <a class="tag" href="https://www.imdb.com/title/${externals.imdb_id}/" target="_blank" rel="noopener">Open</a></div>`);
          }
          const keywordList = (keywords.keywords || []).slice(0, 8).map(k => k.name);
          if (keywordList.length) {
            detailRows.push(`<div class="list-row"><span class="list-label">Keywords:</span> ${keywordList.join(', ')}</div>`);
          }
          detailsEl.innerHTML = detailRows.length ? detailRows.join('') : '<div class="list-row">No extra details available.</div>';
        }
        const trailerEl = document.getElementById('trailer');
        if (trailerEl) {
          const trailer = (videos.results || []).find(v => v.site === 'YouTube' && (v.type === 'Trailer' || v.type === 'Teaser'));
          trailerEl.innerHTML = trailer
            ? `<iframe class="video-frame" src="https://www.youtube.com/embed/${trailer.key}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
            : '<div class="meta-item">No trailer available.</div>';
        }
        const directors = (credits.crew || []).filter(p => p.job === 'Director').slice(0, 3);
        const writers = (credits.crew || []).filter(p => ['Writer', 'Screenplay', 'Story'].includes(p.job)).slice(0, 6);
        const cast = (credits.cast || []).slice(0, 12);
        const directorsEl = document.getElementById('directors');
        if (directorsEl) {
          directorsEl.innerHTML = directors.length ? directors.map(p => `<span class="person-chip">${p.name}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
        const writersEl = document.getElementById('writers');
        if (writersEl) {
          writersEl.innerHTML = writers.length ? writers.map(p => `<span class="person-chip">${p.name}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
        const castEl = document.getElementById('cast');
        if (castEl) {
          castEl.innerHTML = cast.length ? cast.map(p => `<span class="person-chip">${p.name}${p.character ? ` as ${p.character}` : ''}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
      }

      function ensureListMenuBackdrop() {
        let backdrop = document.getElementById('listMenuBackdrop');
        if (!backdrop) {
          backdrop = document.createElement('div');
          backdrop.id = 'listMenuBackdrop';
          backdrop.className = 'list-menu-backdrop';
          backdrop.addEventListener('click', closeAllListMenus);
          document.body.appendChild(backdrop);
        }
        return backdrop;
      }

      function showListMenuBackdrop() {
        const backdrop = ensureListMenuBackdrop();
        backdrop.classList.add('active');
      }

      function hideListMenuBackdrop() {
        const backdrop = document.getElementById('listMenuBackdrop');
        if (backdrop) backdrop.classList.remove('active');
      }

      function closeAllListMenus() {
        const menu = document.getElementById('movieListMenu');
        if (menu) menu.classList.remove('open');
        hideListMenuBackdrop();
      }

      function wireListMenu() {
        const menuBtn = document.getElementById('movieMenuBtn');
        const menu = document.getElementById('movieListMenu');
        if (!menuBtn || !menu) return;
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wasOpen = menu.classList.contains('open');
          closeAllListMenus();
          if (!wasOpen) {
            menu.classList.add('open');
            showListMenuBackdrop();
          }
        });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.menu-wrapper') && !e.target.closest('.list-menu')) {
            closeAllListMenus();
          }
        });
        menu.querySelectorAll('.list-action').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const listType = btn.getAttribute('data-list');
            if (listType === 'custom') {
              closeAllListMenus();
              openMovieListsModal();
              return;
            }
            await toggleList(listType);
            closeAllListMenus();
          });
        });
      }

      async function loadListStatus() {
        if (!supabaseClient || !currentUser || !movieId) return;
        const { data, error } = await supabaseClient
          .from('movie_list_items')
          .select('list_type')
          .eq('user_id', currentUser.id)
          .eq('movie_id', movieId);
        if (error) return;
        listStatus.favorites = false;
        listStatus.watched = false;
        listStatus.watchlist = false;
        (data || []).forEach(item => {
          if (listStatus[item.list_type] !== undefined) {
            listStatus[item.list_type] = true;
          }
        });
        updateListMenuUI();
      }

      async function loadCustomLists() {
        if (!supabaseClient || !currentUser || !window.ListUtils) return [];
        return await ListUtils.loadCustomLists(supabaseClient, currentUser.id, 'movie');
      }

      async function openMovieListsModal() {
        if (!currentUser) {
          showNotification('Please sign in to manage lists', 'info');
          return;
        }
        const modal = document.getElementById('movieListsModal');
        const container = document.getElementById('movieListsContainer');
        if (!modal || !container) return;
        container.innerHTML = '<div class="chip">Loading...</div>';
        customLists = await loadCustomLists();
        const listIds = customLists.map(l => l.id);
        modalSelectedLists = window.ListUtils
          ? await ListUtils.loadCustomListMembership(supabaseClient, currentUser.id, 'movie', movieId, listIds)
          : new Set();
        container.innerHTML = '';
        if (!customLists.length) {
          container.innerHTML = '<div class="chip">No custom lists yet.</div>';
        } else {
          customLists.forEach(list => {
            const item = document.createElement('div');
            item.className = 'modal-list-item' + (modalSelectedLists.has(list.id) ? ' active' : '');
            item.innerHTML = `
              <span>${renderListIcon(list.icon)} ${list.title}</span>
              <span class="modal-list-actions">
                <span>${modalSelectedLists.has(list.id) ? 'Saved' : 'Add'}</span>
                <button class="list-edit-btn" aria-label="Rename list"><i class="fas fa-pen"></i></button>
              </span>
            `;
            item.onclick = () => {
              if (modalSelectedLists.has(list.id)) {
                modalSelectedLists.delete(list.id);
              } else {
                modalSelectedLists.add(list.id);
              }
              item.classList.toggle('active');
              item.querySelector('.modal-list-actions span').textContent = modalSelectedLists.has(list.id) ? 'Saved' : 'Add';
            };
            const editBtn = item.querySelector('.list-edit-btn');
            if (editBtn) {
              editBtn.onclick = (e) => {
                e.stopPropagation();
                renameMovieList(list.id, list.title);
              };
            }
            container.appendChild(item);
          });
        }
        modal.classList.add('active');
      }

      async function saveMovieListChanges() {
        if (!supabaseClient || !currentUser || !movieId) return;
        if (window.ListUtils) {
          await ListUtils.saveCustomListChanges(
            supabaseClient,
            currentUser.id,
            'movie',
            movieId,
            [...modalSelectedLists]
          );
        }
        showNotification('Lists updated', 'success');
        closeMovieListsModal();
      }

      function closeMovieListsModal() {
        const modal = document.getElementById('movieListsModal');
        if (modal) modal.classList.remove('active');
      }

      async function createMovieList() {
        const input = document.getElementById('newMovieListName');
        if (!input || !input.value.trim()) return;
        if (!supabaseClient || !currentUser) return;
        const title = input.value.trim();
        const modal = document.getElementById('movieListsModal');
        const tierState = window.ListUtils && modal
          ? ListUtils.readTierCreateState(modal)
          : { listKind: 'standard', maxRank: null };
        const data = window.ListUtils
          ? await ListUtils.createCustomList(supabaseClient, currentUser.id, 'movie', {
            title,
            icon: selectedIcon || 'fas fa-film',
          listKind: tierState.listKind,
          maxRank: tierState.maxRank
          })
          : null;
        if (!data) {
          showNotification('Could not create list', 'error');
          return;
        }
        input.value = '';
        if (window.ListUtils && modal) ListUtils.resetTierCreateState(modal);
        customLists.unshift(data);
        openMovieListsModal();
      }

      async function renameMovieList(listId, currentTitle) {
        const nextTitle = prompt('Rename list', currentTitle || '');
        if (!nextTitle || !nextTitle.trim()) return;
        if (!supabaseClient || !currentUser) return;
        const ok = window.ListUtils
          ? await ListUtils.renameCustomList(supabaseClient, currentUser.id, 'movie', listId, nextTitle.trim())
          : false;
        if (!ok) {
          showNotification('Could not rename list', 'error');
          return;
        }
        customLists = customLists.map(l => l.id === listId ? { ...l, title: nextTitle.trim() } : l);
        openMovieListsModal();
      }

      function updateListMenuUI() {
        const menu = document.getElementById('movieListMenu');
        if (!menu) return;
        menu.querySelectorAll('.list-action').forEach(btn => {
          const listType = btn.getAttribute('data-list');
          const state = btn.querySelector('.list-action-state');
          if (listType === 'custom') {
            btn.classList.remove('active');
            btn.removeAttribute('aria-busy');
            btn.style.pointerEvents = '';
            btn.style.opacity = '';
            if (state) state.textContent = 'Open';
            return;
          }
          const isActive = !!listStatus[listType];
          const opKey = `${String(movieId || '')}:${listType}`;
          const isPending = pendingListOps.has(opKey);
          btn.classList.toggle('active', isActive);
          if (state) state.textContent = isActive ? 'Saved' : 'Add';
          btn.setAttribute('aria-busy', isPending ? 'true' : 'false');
          btn.style.pointerEvents = isPending ? 'none' : '';
          btn.style.opacity = isPending ? '0.72' : '';
        });
      }

      async function toggleList(listType, forcedNextSaved) {
        if (!currentUser) {
          showNotification('Please sign in to save movies', 'info');
          return { ok: false, saved: false };
        }
        if (!movieId || !(listType in listStatus)) return { ok: false, saved: false };
        const opKey = `${String(movieId)}:${listType}`;
        if (pendingListOps.has(opKey)) return { ok: false, saved: !!listStatus[listType] };

        const previousSaved = !!listStatus[listType];
        const nextSaved = typeof forcedNextSaved === 'boolean' ? forcedNextSaved : !previousSaved;
        pendingListOps.add(opKey);
        listStatus[listType] = nextSaved;
        updateListMenuUI();

        try {
          if (nextSaved) {
            const { error } = await supabaseClient
              .from('movie_list_items')
              .insert({ user_id: currentUser.id, movie_id: movieId, list_type: listType });
            if (error && String(error.code || '') !== '23505') throw error;
            showNotification('Saved to list', 'success');
          } else {
            const { error } = await supabaseClient
              .from('movie_list_items')
              .delete()
              .eq('user_id', currentUser.id)
              .eq('movie_id', movieId)
              .eq('list_type', listType);
            if (error) throw error;
            showNotification('Removed from list', 'info');
          }
          return { ok: true, saved: nextSaved };
        } catch (error) {
          listStatus[listType] = previousSaved;
          showNotification('Could not update list', 'error');
          return { ok: false, saved: previousSaved };
        } finally {
          pendingListOps.delete(opKey);
          updateListMenuUI();
        }
      }

      function bindUnifiedListMenu() {
        const menuBtn = document.getElementById('movieMenuBtn');
        if (!menuBtn || !movieId || !window.initIndexStyleListMenu) return;

        window.initIndexStyleListMenu({
          mediaType: 'movie',
          itemIdAttr: 'data-item-id',
          getVisibleItemIds: () => movieId ? [movieId] : [],
          getQuickStatusForItem: (itemId) => {
            const numericId = Number(itemId);
            if (Number.isFinite(numericId) && numericId !== movieId) return null;
            return { ...listStatus };
          },
          getItemFromCard: () => ({
            mediaType: 'movie',
            itemId: movieId,
            title: String(document.getElementById('title')?.textContent || 'Movie').trim(),
            subtitle: String(document.getElementById('meta')?.textContent || '').trim(),
            image: String(document.getElementById('poster')?.getAttribute('src') || '').trim()
          }),
          ensureClient: async () => {
            if (supabaseClient) return supabaseClient;
            return initSupabase();
          },
          getCurrentUser: () => currentUser,
          notify: (message, isError) => showNotification(message, isError ? 'error' : 'success'),
          toggleDefaultList: async ({ listType, nextSaved }) => toggleList(listType, nextSaved)
        });

        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          if (typeof window.openIndexStyleListMenu === 'function') {
            window.openIndexStyleListMenu(menuBtn);
          }
        });
      }

      async function initReviewSystem() {
        if (!supabaseClient || !movieId) return;
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
          sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortAndRenderReviews();
          });
        }
        const reviewForm = document.getElementById('review-form');
        if (reviewForm) {
          reviewForm.addEventListener('submit', submitReview);
        }
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => resetReviewForm());
        }
        const commentTextarea = document.getElementById('review-comment');
        if (commentTextarea) {
          commentTextarea.addEventListener('input', () => {
            const count = document.getElementById('charCount');
            if (count) count.textContent = String(commentTextarea.value.length);
          });
        }
        document.querySelectorAll('.star').forEach(star => {
          star.addEventListener('click', () => {
            currentRating = parseInt(star.dataset.rating, 10);
            updateStarDisplay();
          });
        });
        await loadReviews();
      }

      function renderReviewForm() {
        const form = document.getElementById('review-form');
        const prompt = document.getElementById('auth-prompt');
        if (!form || !prompt) return;
        if (currentUser) {
          form.style.display = 'block';
          prompt.style.display = 'none';
        } else {
          form.style.display = 'none';
          prompt.style.display = 'block';
        }
      }

      async function loadReviews() {
        const container = document.getElementById('reviewsList');
        const statsContainer = document.getElementById('reviewsStats');
        if (!container || !statsContainer || !supabaseClient) return;
        container.innerHTML = '<div class="reviews-loading">Loading reviews...</div>';
        const { data, error } = await supabaseClient
          .from('movie_reviews')
          .select('*')
          .eq('movie_id', movieId)
          .order('created_at', { ascending: false });
        if (error) {
          container.innerHTML = '<div class="reviews-empty">Error loading reviews.</div>';
          statsContainer.innerHTML = '<div class="reviews-empty">Error loading stats.</div>';
          return;
        }
        reviews = data || [];
        if (reviews.length === 0) {
          container.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to share your thoughts!</div>';
          statsContainer.innerHTML = '<div class="reviews-empty">No reviews yet</div>';
          return;
        }
        const totalReviews = reviews.length;
        const averageRating = reviews.reduce((sum, review) => sum + review.rating, 0) / totalReviews;
        const ratingDistribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
        reviews.forEach(review => ratingDistribution[review.rating]++);
        statsContainer.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${averageRating.toFixed(1)}</div>
              <div class="stat-label">Average Rating</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${totalReviews}</div>
              <div class="stat-label">Total Reviews</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${Math.round((ratingDistribution[5] / totalReviews) * 100)}%</div>
              <div class="stat-label">5-Star Reviews</div>
            </div>
          </div>
          <div class="rating-breakdown">
            ${[5,4,3,2,1].map(stars => `
              <div class="rating-row">
                <div class="rating-stars">${'?'.repeat(stars)}</div>
                <div class="rating-bar">
                  <div class="rating-fill" style="width: ${(ratingDistribution[stars] / totalReviews) * 100}%"></div>
                </div>
                <div class="rating-count">${ratingDistribution[stars]}</div>
              </div>
            `).join('')}
          </div>
        `;
        document.getElementById('reviewsSortControls').style.display = 'flex';
        sortAndRenderReviews();
      }

      function sortAndRenderReviews() {
        if (!reviews || reviews.length === 0) return;
        let sorted = [...reviews];
        if (currentSort === 'highest') sorted.sort((a, b) => b.rating - a.rating);
        if (currentSort === 'lowest') sorted.sort((a, b) => a.rating - b.rating);
        displayReviews(sorted);
      }

      async function displayReviews(reviewsToDisplay) {
        const container = document.getElementById('reviewsList');
        if (!container) return;
        if (!reviewsToDisplay || reviewsToDisplay.length === 0) {
          container.innerHTML = '<div class="reviews-empty">No reviews yet.</div>';
          return;
        }
        const userIds = [...new Set(reviewsToDisplay.map(r => r.user_id))];
        let userMap = {};
        if (userIds.length && supabaseClient) {
          let users = [];
          const profileSelects = [
            'user_id, id, username, full_name',
            'user_id, username, full_name',
            'user_id, username',
            'user_id, full_name',
            'id, username, full_name',
            'id, username',
            'id, full_name'
          ];
          for (const cols of profileSelects) {
            const { data, error } = await supabaseClient
              .from('user_profiles')
              .select(cols)
              .in(cols.includes('user_id') ? 'user_id' : 'id', userIds);
            if (!error) {
              users = data || [];
              break;
            }
          }
          (users || []).forEach(u => {
            const key = u.user_id || u.id;
            if (key) userMap[key] = u;
          });
        }
        const escapeHtml = (v) => String(v ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        container.innerHTML = reviewsToDisplay.map(review => {
          const user = userMap[review.user_id];
          const reviewUsernameRaw = String(review?.username || review?.user_name || '').trim();
          const isAutoUsername = /^user-[a-f0-9]{6,}$/i.test(reviewUsernameRaw);
          const reviewUsername = isAutoUsername ? '' : reviewUsernameRaw;
          const username = String(user?.username || reviewUsername).trim();
          const fallbackName = String(user?.full_name || '').trim();
          const displayName = username ? `@${username}` : (fallbackName || 'User');
          const initialsBase = username || fallbackName || 'User';
          const initials = initialsBase.split(/\s+/).map(n => n[0]).slice(0, 2).join('').toUpperCase();
          const profileHref = `profile.html?id=${encodeURIComponent(review.user_id)}`;
          const canEditDelete = currentUser && currentUser.id === review.user_id;
          return `
            <div class="review-card" id="review-${review.id}">
              <div class="review-header">
                <div class="reviewer-info">
                  <a class="reviewer-avatar reviewer-link" href="${profileHref}" aria-label="View ${escapeHtml(displayName)} profile">${escapeHtml(initials)}</a>
                  <div>
                    <div class="reviewer-name"><a class="reviewer-link" href="${profileHref}">${escapeHtml(displayName)}</a></div>
                    <div class="review-date">${new Date(review.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                  </div>
                </div>
                <div class="review-rating">${'\u2605'.repeat(review.rating)}${'\u2606'.repeat(5 - review.rating)}</div>
              </div>
              <p class="review-comment">${escapeHtml(review.comment || '')}</p>
              ${canEditDelete ? `
                <div class="review-actions">
                  <button class="review-edit" onclick="editReview('${review.id}')">Edit</button>
                  <button class="review-delete" onclick="deleteReview('${review.id}')">Delete</button>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }

      function updateStarDisplay() {
        const stars = document.querySelectorAll('.star');
        const ratingText = document.getElementById('ratingText');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating, 10);
          star.classList.toggle('active', starRating <= currentRating);
        });
        const ratingTexts = ['Select your rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        if (ratingText) ratingText.textContent = ratingTexts[currentRating] || 'Select your rating';
      }

      async function submitReview(e) {
        e.preventDefault();
        if (!currentUser) {
          showNotification('Please sign in to submit a review', 'info');
          return;
        }
        const comment = document.getElementById('review-comment').value.trim();
        if (!currentRating) {
          showNotification('Please select a rating', 'info');
          return;
        }
        const payload = { movie_id: movieId, user_id: currentUser.id, rating: currentRating, comment };
        let error = null;
        if (editingReviewId) {
          const { error: updateError } = await supabaseClient
            .from('movie_reviews')
            .update(payload)
            .eq('id', editingReviewId);
          error = updateError;
        } else {
          const { error: insertError } = await supabaseClient
            .from('movie_reviews')
            .insert(payload);
          error = insertError;
        }
        if (error) {
          showNotification('Error submitting review', 'error');
          return;
        }
        resetReviewForm();
        await loadReviews();
        showNotification('Review saved', 'success');
      }

      window.editReview = async function (reviewId) {
        if (!supabaseClient) return;
        const { data: review } = await supabaseClient
          .from('movie_reviews')
          .select('*')
          .eq('id', reviewId)
          .single();
        if (!review) return;
        editingReviewId = reviewId;
        currentRating = review.rating;
        document.getElementById('review-comment').value = review.comment || '';
        updateStarDisplay();
        const submitText = document.querySelector('.submit-review-btn .btn-text');
        if (submitText) submitText.textContent = 'Update Review';
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) cancelBtn.style.display = 'inline-flex';
      };

      window.deleteReview = async function (reviewId) {
        if (!currentUser) {
          showNotification('Please sign in to delete reviews', 'info');
          return;
        }
        if (!confirm('Delete this review?')) return;
        const { error } = await supabaseClient
          .from('movie_reviews')
          .delete()
          .eq('id', reviewId);
        if (error) {
          showNotification('Error deleting review', 'error');
          return;
        }
        await loadReviews();
        showNotification('Review deleted', 'success');
      };

      function resetReviewForm() {
        editingReviewId = null;
        currentRating = 0;
        const form = document.getElementById('review-form');
        if (form) form.reset();
        updateStarDisplay();
        const submitText = document.querySelector('.submit-review-btn .btn-text');
        if (submitText) submitText.textContent = 'Submit Review';
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) cancelBtn.style.display = 'none';
        const count = document.getElementById('charCount');
        if (count) count.textContent = '0';
      }

      function initPageSearch() {
        const input = document.getElementById('pageSearchInput');
        const btn = document.getElementById('pageSearchBtn');
        const suggest = document.getElementById('pageSearchSuggest');
        if (!input || !btn || !suggest) return;
        const esc = (v) => String(v ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        let suggestions = [];
        let activeIndex = -1;
        let debounceTimer = null;
        const go = () => {
          const query = input.value.trim();
          const url = new URL('movies.html', window.location.href);
          if (query) url.searchParams.set('search', query);
          window.location.href = `${url.pathname}${url.search}`;
        };
        const closeSuggest = () => {
          suggest.classList.remove('open');
          suggest.innerHTML = '';
          suggestions = [];
          activeIndex = -1;
        };
        const renderSuggest = () => {
          if (!suggestions.length) {
            closeSuggest();
            return;
          }
          suggest.innerHTML = suggestions.map((item, idx) => `
            <button class="search-suggest-item${idx === activeIndex ? ' active' : ''}" data-idx="${idx}" type="button">
              <img class="search-suggest-thumb" src="${esc(item.image || 'images/logo.png')}" alt="" loading="lazy" onerror="this.onerror=null;this.src='images/logo.png';">
              <span>
                <span class="search-suggest-title">${esc(item.title)}</span>
                <span class="search-suggest-sub">${esc(item.sub)}</span>
              </span>
            </button>
          `).join('');
          suggest.classList.add('open');
          suggest.querySelectorAll('.search-suggest-item').forEach((el) => {
            el.addEventListener('click', () => {
              const idx = Number(el.getAttribute('data-idx'));
              const selected = suggestions[idx];
              if (!selected) return;
              input.value = selected.title;
              closeSuggest();
              window.location.href = `movie.html?id=${encodeURIComponent(selected.id)}`;
            });
          });
        };
        const fetchSuggest = async (query) => {
          const q = query.trim();
          if (q.length < 2) {
            closeSuggest();
            return;
          }
          try {
            const url = `${TMDB_BASE}/search/movie?query=${encodeURIComponent(q)}&language=en-US&page=1&include_adult=false`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${TMDB_TOKEN}` } });
            if (!res.ok) throw new Error('TMDB suggestions failed');
            const json = await res.json();
            const rawResults = Array.isArray(json.results) ? json.results : [];
            const filteredResults = rawResults.filter((item) => !isAnimeMovieResult(item));
            suggestions = filteredResults.slice(0, 6).map((m) => ({
              id: m.id,
              title: m.title || 'Movie',
              sub: m.release_date ? String(m.release_date).slice(0, 4) : 'Movie',
              image: m.poster_path ? `${POSTER_BASE}${m.poster_path}` : ''
            }));
            activeIndex = -1;
            renderSuggest();
          } catch (_e) {
            closeSuggest();
          }
        };
        btn.addEventListener('click', go);
        input.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => fetchSuggest(input.value), 180);
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowDown') {
            if (!suggestions.length) return;
            e.preventDefault();
            activeIndex = (activeIndex + 1) % suggestions.length;
            renderSuggest();
            return;
          }
          if (e.key === 'ArrowUp') {
            if (!suggestions.length) return;
            e.preventDefault();
            activeIndex = activeIndex <= 0 ? suggestions.length - 1 : activeIndex - 1;
            renderSuggest();
            return;
          }
          if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0 && suggestions[activeIndex]) {
              window.location.href = `movie.html?id=${encodeURIComponent(suggestions[activeIndex].id)}`;
              return;
            }
            go();
          }
          if (e.key === 'Escape') closeSuggest();
        });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.nav-search')) closeSuggest();
        });
      }

      (async function init() {
        await initSupabase();
        initPageSearch();
        bindUnifiedListMenu();
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAllListMenus();
        });
        const closeListsBtn = document.getElementById('closeMovieListsBtn');
        const saveListsBtn = document.getElementById('saveMovieListsBtn');
        const createListBtn = document.getElementById('createMovieListBtn');
        const iconOptions = document.querySelectorAll('#movieListIconOptions .icon-option');
        if (closeListsBtn) closeListsBtn.addEventListener('click', closeMovieListsModal);
        if (saveListsBtn) saveListsBtn.addEventListener('click', saveMovieListChanges);
        if (createListBtn) createListBtn.addEventListener('click', createMovieList);
        iconOptions.forEach(btn => {
          btn.addEventListener('click', () => {
            iconOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedIcon = btn.getAttribute('data-icon') || 'fas fa-film';
          });
        });
        await initAuth();
        await load();
        await initReviewSystem();
      })();
    })();
  </script>
  <script src="js/production-runtime.js?v=20260221a" defer></script>
</body>
</html>





