
<!-- List Manager - CLEAN VERSION -->

<!-- List Manager - CLEAN VERSION -->

<!-- Real Reviews System -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.overall-rating { text-align: center; }
.rating-large { font-size: 3rem; font-weight: 700; color: var(--accent); line-height: 1; }
.rating-stars-large { color: #FF9800; font-size: 1.5rem; margin: 10px 0; }
.rating-count { color: var(--text2); font-size: 0.9rem; }
.rating-breakdown { flex: 1; }
.rating-bar { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
.rating-bar-label { width: 60px; font-size: 0.9rem; color: var(--text2); }
.rating-bar-track { flex: 1; height: 8px; background: var(--nav-shadow); border-radius: 4px; overflow: hidden; }
.rating-bar-fill { height: 100%; background: #FF9800; border-radius: 4px; transition: width 0.3s ease; }
.rating-bar-count { width: 30px; font-size: 0.8rem; color: var(--text2); text-align: right; }
.review-item { background: var(--card); border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--nav-shadow); transition: all 0.3s ease; }
.review-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
.reviewer-info { display: flex; align-items: center; gap: 12px; }
.reviewer-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600; color: #0b1633; font-size: 0.9rem; }
.reviewer-details { display: flex; flex-direction: column; }
.reviewer-name { font-weight: 600; margin-bottom: 2px; }
.review-date { font-size: 0.8rem; color: var(--text2); }
.review-rating { color: #FF9800; font-size: 1.1rem; }
.review-content { margin-bottom: 12px; line-height: 1.6; }
.review-actions { display: flex; gap: 8px; justify-content: flex-end; }
.add-review-section { background: var(--card); border-radius: 12px; padding: 24px; margin-top: 30px; border: 1px solid var(--nav-shadow); }
.rating-input { margin-bottom: 20px; }
.rating-input label { display: block; margin-bottom: 8px; font-weight: 600; }
.star-rating { display: flex; gap: 4px; }
.star { font-size: 2rem; cursor: pointer; transition: all 0.2s ease; user-select: none; }
.star:hover { transform: scale(1.1); }
.login-prompt { text-align: center; padding: 40px 20px; background: var(--card); border-radius: 12px; margin-top: 30px; }
.empty-reviews { text-align: center; padding: 40px 20px; color: var(--text2); }
.empty-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.5; }
@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
</style>

<style>
.reviews-container {
  max-height: 500px;
  overflow-y: auto;
  padding-right: 10px;
}

.review {
  border-bottom: 1px solid var(--nav-shadow);
  padding: 15px 0;
  position: relative;
}

.review:last-child {
  border-bottom: none;
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.reviewer-name {
  font-weight: 600;
  color: var(--text);
  margin: 0;
}

.review-rating {
  color: #FF9800;
  font-size: 0.9rem;
}

.review-comment {
  margin: 0;
  color: var(--text2);
  line-height: 1.5;
}

.review-date {
  font-size: 0.8rem;
  color: var(--text2);
  margin-top: 5px;
}

.review-input-group {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.review-input-group input {
  flex: 1;
  min-width: 200px;
}

.rating-input {
  display: flex;
  align-items: center;
  gap: 10px;
}

.stars {
  display: flex;
  gap: 2px;
}

.star {
  font-size: 1.5rem;
  color: #ddd;
  cursor: pointer;
  transition: color 0.2s ease;
}

.star:hover,
.star.active {
  color: #FF9800;
}

.rating-text {
  font-size: 0.9rem;
  color: var(--text2);
  min-width: 100px;
}

.review-form-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.char-count {
  font-size: 0.8rem;
  color: var(--text2);
}

.reviews-loading, .reviews-empty {
  text-align: center;
  padding: 40px 20px;
  color: var(--text2);
  font-style: italic;
}

.review-actions {
  position: absolute;
  top: 15px;
  right: 0;
}

.delete-review {
  background: none;
  border: none;
  color: #ff4444;
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.delete-review:hover {
  background: rgba(255, 68, 68, 0.1);
}

.auth-prompt-review {
  text-align: center;
  padding: 20px;
  background: var(--card);
  border-radius: 8px;
  margin-top: 20px;
}

/* Scrollbar styling */
.reviews-container::-webkit-scrollbar {
  width: 6px;
}

.reviews-container::-webkit-scrollbar-track {
  background: var(--nav-bg);
  border-radius: 3px;
}

.reviews-container::-webkit-scrollbar-thumb {
  background: #FF9800;
  border-radius: 3px;
}

.reviews-container::-webkit-scrollbar-thumb:hover {
  background: #F57C00;
}
</style>

        `;
    }

    createReviewForm() {
        return `
        <div class="add-review-section">
            <h3>Write a Review</h3>
            <form class="review-form" id="reviewForm">
                <div class="rating-input">
                    <label>Your Rating:</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">‚òÜ</span>
                        <span class="star" data-rating="2">‚òÜ</span>
                        <span class="star" data-rating="3">‚òÜ</span>
                        <span class="star" data-rating="4">‚òÜ</span>
                        <span class="star" data-rating="5">‚òÜ</span>
                    </div>
                    <input type="hidden" id="selectedRating" name="rating" required>
                </div>
                
                <div class="form-group">
                    <label for="reviewComment">Your Review:</label>
                    <textarea 
                        id="reviewComment" 
                        name="comment" 
                        placeholder="Share your experience with this restaurant..." 
                        rows="4"
                        required
                    ></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit Review
                </button>
            </form>
        </div>
        `;
    }

    createLoginPrompt() {
        return `
        <div class="login-prompt">
            <h3>Want to share your experience?</h3>
            <p>Please log in to write a review and help other food lovers discover great places!</p>
            <button onclick="window.location.href='../login.html'" class="btn btn-primary">
                <i class="fas fa-sign-in-alt"></i> Log In to Review
            </button>
        </div>
        `;
    }

    renderReviews() {
        const container = document.getElementById('reviewsList');
        if (!container) return;

        if (this.reviews.length === 0) {
            container.innerHTML = `
                <div class="empty-reviews">
                    <div class="empty-icon">üí¨</div>
                    <h3>No Reviews Yet</h3>
                    <p>Be the first to share your experience!</p>
                </div>
            `;
            return;
        }

        container.innerHTML = this.reviews.map(review => `
            <div class="review-item" data-review-id="${review.id}">
                <div class="review-header">
                    <div class="reviewer-info">
                        <div class="reviewer-avatar">
                            ${review.user_name ? review.user_name.charAt(0).toUpperCase() : 'U'}
                        </div>
                        <div class="reviewer-details">
                            <div class="reviewer-name">${review.user_name || 'Anonymous User'}</div>
                            <div class="review-date">${this.formatDate(review.created_at)}</div>
                        </div>
                    </div>
                    <div class="review-rating">
                        ${'‚≠ê'.repeat(review.rating)}
                    </div>
                </div>
                <div class="review-content">
                    <p>${review.comment || 'No comment provided.'}</p>
                </div>
                ${this.canEditReview(review) ? `
                    <div class="review-actions">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    canEditReview(review) {
        return this.currentUser && review.user_id === this.currentUser.id;
    }

    calculateRatings() {
        if (this.reviews.length === 0) {
            this.updateRatingDisplay(0, 0);
            return;
        }

        const totalRating = this.reviews.reduce((sum, review) => sum + review.rating, 0);
        const averageRating = totalRating / this.reviews.length;
        
        const distribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
        this.reviews.forEach(review => {
            distribution[review.rating]++;
        });

        this.updateRatingDisplay(averageRating, this.reviews.length);
        this.updateRatingBars(distribution);
    }

    updateRatingDisplay(averageRating, totalReviews) {
        const overallRating = document.getElementById('overallRating');
        const overallStars = document.getElementById('overallStars');
        const reviewCount = document.getElementById('reviewCount');

        if (overallRating) overallRating.textContent = averageRating.toFixed(1);
        if (overallStars) overallStars.innerHTML = '‚≠ê'.repeat(Math.round(averageRating));
        if (reviewCount) reviewCount.textContent = `${totalReviews} review${totalReviews !== 1 ? 's' : ''}`;
    }

    updateRatingBars(distribution) {
        const container = document.getElementById('ratingBreakdown');
        if (!container) return;

        const totalReviews = this.reviews.length;
        
        container.innerHTML = [5, 4, 3, 2, 1].map(rating => {
            const count = distribution[rating] || 0;
            const percentage = totalReviews > 0 ? (count / totalReviews) * 100 : 0;
            
            return `
                <div class="rating-bar">
                    <span class="rating-bar-label">${rating} stars</span>
                    <div class="rating-bar-track">
                        <div class="rating-bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span class="rating-bar-count">${count}</span>
                </div>
            `;
        }).join('');
    }

    setupEventListeners() {
        // Star rating interaction
        const stars = document.querySelectorAll('.star');
        stars.forEach(star => {
            star.addEventListener('click', () => this.setRating(parseInt(star.dataset.rating)));
            star.addEventListener('mouseover', () => this.previewRating(parseInt(star.dataset.rating)));
        });

        // Review form submission
        const reviewForm = document.getElementById('reviewForm');
        if (reviewForm) {
            reviewForm.addEventListener('submit', (e) => this.submitReview(e));
        }

        // Reset star preview when mouse leaves
        const starRating = document.getElementById('starRating');
        if (starRating) {
            starRating.addEventListener('mouseleave', () => this.resetStarPreview());
        }
    }

    setRating(rating) {
        this.selectedRating = rating;
        const selectedRatingInput = document.getElementById('selectedRating');
        if (selectedRatingInput) selectedRatingInput.value = rating;
        
        this.updateStarDisplay(rating);
    }

    previewRating(rating) {
        this.updateStarDisplay(rating);
    }

    resetStarPreview() {
        if (this.selectedRating) {
            this.updateStarDisplay(this.selectedRating);
        } else {
            this.updateStarDisplay(0);
        }
    }

    updateStarDisplay(rating) {
        const stars = document.querySelectorAll('.star');
        stars.forEach((star, index) => {
            if (index < rating) {
                star.textContent = '‚≠ê';
                star.style.color = '#FF9800';
            } else {
                star.textContent = '‚òÜ';
                star.style.color = 'var(--text2)';
            }
        });
    }

    async submitReview(event) {
        event.preventDefault();
        
        if (!this.currentUser) {
            this.showNotification('Please log in to write a review', 'error');
            return;
        }

        const rating = parseInt(document.getElementById('selectedRating')?.value);
        const comment = document.getElementById('reviewComment')?.value.trim();

        if (!rating || !comment) {
            this.showNotification('Please provide both a rating and comment', 'error');
            return;
        }

        try {
            // Get user profile for the name
            const { data: profile } = await this.supabase
                .from('user_profiles')
                .select('full_name, username')
                .eq('id', this.currentUser.id)
                .single();

            const userName = profile?.full_name || profile?.username || this.currentUser.email.split('@')[0];

            const { data, error } = await this.supabase
                .from('reviews')
                .insert({
                    restaurant_id: this.restaurantId,
                    user_id: this.currentUser.id,
                    user_name: userName,
                    rating: rating,
                    comment: comment,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .select()
                .single();

            if (error) throw error;

            // Reload reviews
            await this.loadReviews();
            this.renderReviews();
            this.calculateRatings();

            // Reset form
            document.getElementById('reviewForm').reset();
            this.selectedRating = null;
            this.updateStarDisplay(0);

            this.showNotification('Review submitted successfully!', 'success');

        } catch (error) {
            console.error('Error submitting review:', error);
            this.showNotification('Error submitting review', 'error');
        }
    }

    async editReview(reviewId) {
        const review = this.reviews.find(r => r.id === reviewId);
        if (!review) return;

        const newComment = prompt('Edit your review:', review.comment);
        if (newComment === null) return;

        try {
            const { error } = await this.supabase
                .from('reviews')
                .update({
                    comment: newComment,
                    updated_at: new Date().toISOString()
                })
                .eq('id', reviewId);

            if (error) throw error;

            await this.loadReviews();
            this.renderReviews();
            this.showNotification('Review updated successfully!', 'success');

        } catch (error) {
            console.error('Error updating review:', error);
            this.showNotification('Error updating review', 'error');
        }
    }

    async deleteReview(reviewId) {
        if (!confirm('Are you sure you want to delete this review?')) return;

        try {
            const { error } = await this.supabase
                .from('reviews')
                .delete()
                .eq('id', reviewId);

            if (error) throw error;

            await this.loadReviews();
            this.renderReviews();
            this.calculateRatings();
            this.showNotification('Review deleted successfully!', 'success');

        } catch (error) {
            console.error('Error deleting review:', error);
            this.showNotification('Error deleting review', 'error');
        }
    }

    formatDate(dateString) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return new Date(dateString).toLocaleDateString(undefined, options);
    }

    showNotification(message, type = 'info') {
        const toast = document.createElement('div');
        toast.innerHTML = `
            </div>
        `;

        const existingContainer = document.getElementById('reviewToasts') || this.createToastContainer();
        existingContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 5000);

            toast.remove();
        });
    }

    createToastContainer() {
        const container = document.createElement('div');
        container.id = 'reviewToasts';
        document.body.appendChild(container);
        return container;
    }
}

// Initialize the system when page loads
document.addEventListener('DOMContentLoaded', () => {
});
</script>

<style>
/* Review System Styles */
    display: flex;
    align-items: center;
    gap: 30px;
    margin-bottom: 30px;
    padding: 20px;
    background: var(--card);
    border-radius: 12px;
    border: 1px solid var(--nav-shadow);
}

.overall-rating {
    text-align: center;
}

.rating-large {
    font-size: 3rem;
    font-weight: 700;
    color: var(--accent);
    line-height: 1;
}

.rating-stars-large {
    color: #FF9800;
    font-size: 1.5rem;
    margin: 10px 0;
}

.rating-count {
    color: var(--text2);
    font-size: 0.9rem;
}

.rating-breakdown {
    flex: 1;
}

.rating-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
}

.rating-bar-label {
    width: 60px;
    font-size: 0.9rem;
    color: var(--text2);
}

.rating-bar-track {
    flex: 1;
    height: 8px;
    background: var(--nav-shadow);
    border-radius: 4px;
    overflow: hidden;
}

.rating-bar-fill {
    height: 100%;
    background: #FF9800;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.rating-bar-count {
    width: 30px;
    font-size: 0.8rem;
    color: var(--text2);
    text-align: right;
}

.review-item {
    background: var(--card);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
    border: 1px solid var(--nav-shadow);
    transition: all 0.3s ease;
}

.review-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.reviewer-info {
    display: flex;
    align-items: center;
    gap: 12px;
}

.reviewer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    color: #0b1633;
    font-size: 0.9rem;
}

.reviewer-details {
    display: flex;
    flex-direction: column;
}

.reviewer-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.review-date {
    font-size: 0.8rem;
    color: var(--text2);
}

.review-rating {
    color: #FF9800;
    font-size: 1.1rem;
}

.review-content {
    margin-bottom: 12px;
    line-height: 1.6;
}

.review-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
}

.add-review-section {
    background: var(--card);
    border-radius: 12px;
    padding: 24px;
    margin-top: 30px;
    border: 1px solid var(--nav-shadow);
}

.rating-input {
    margin-bottom: 20px;
}

.rating-input label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
}

.star-rating {
    display: flex;
    gap: 4px;
}

.star {
    font-size: 2rem;
    cursor: pointer;
    transition: all 0.2s ease;
    user-select: none;
}

.star:hover {
    transform: scale(1.1);
}

.login-prompt {
    text-align: center;
    padding: 40px 20px;
    background: var(--card);
    border-radius: 12px;
    margin-top: 30px;
}

.empty-reviews {
    text-align: center;
    padding: 40px 20px;
    color: var(--text2);
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.5;
}

    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
}

    background: var(--card);
    border-radius: 8px;
    padding: 12px 16px;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    animation: slideInRight 0.3s ease;
}

    border-left-color: #10b981;
}

    border-left-color: #ef4444;
}

    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}

    background: none;
    border: none;
    font-size: 1.2rem;
    cursor: pointer;
    color: var(--text2);
}

    color: var(--text);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@media (max-width: 768px) {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
    
    .rating-breakdown {
        width: 100%;
    }
    
    .review-header {
        flex-direction: column;
        gap: 12px;
    }
    
    .star {
        font-size: 1.5rem;
    }
}
</style>

<!-- REAL REVIEWS SYSTEM -->



<style>
.review-stats { 
    display: flex; 
    align-items: center; 
    gap: 30px; 
    margin-bottom: 30px; 
    padding: 20px; 
    background: var(--card); 
    border-radius: 12px; 
    border: 1px solid var(--nav-shadow); 
}
.overall-rating { 
    text-align: center; 
}
.rating-large { 
    font-size: 3rem; 
    font-weight: 700; 
    color: var(--accent); 
    line-height: 1; 
}
.rating-stars-large { 
    color: #FF9800; 
    font-size: 1.5rem; 
    margin: 10px 0; 
}
.rating-count { 
    color: var(--text2); 
    font-size: 0.9rem; 
}
.add-review-section { 
    background: var(--card); 
    border-radius: 12px; 
    padding: 24px; 
    margin-top: 30px; 
    border: 1px solid var(--nav-shadow); 
}
.rating-input { 
    margin-bottom: 20px; 
}
.rating-input label { 
    display: block; 
    margin-bottom: 8px; 
    font-weight: 600; 
}
.star-rating { 
    display: flex; 
    gap: 4px; 
}
.star { 
    font-size: 2rem; 
    cursor: pointer; 
    transition: all 0.2s ease; 
    user-select: none; 
}
.star:hover { 
    transform: scale(1.1); 
}
.empty-reviews { 
    text-align: center; 
    padding: 40px 20px; 
    color: var(--text2); 
}

@media (max-width: 768px) {
    .review-stats { 
        flex-direction: column; 
        gap: 20px; 
    }
    .star { 
        font-size: 1.5rem; 
    }
}
</style>



<style>
.stars { display: flex; gap: 4px; }
.star { 
  font-size: 1.8rem; 
  color: #ddd; 
  cursor: pointer; 
  transition: all 0.2s ease; 
  user-select: none;
}
.star:hover, .star.active { 
  color: #FF9800; 
  transform: scale(1.2); 
}
.review { 
  border-bottom: 1px solid var(--nav-shadow); 
  padding: 20px 0; 
  position: relative; 
}
.review:last-child { border-bottom: none; }
.review-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  margin-bottom: 12px; 
  position: relative; 
}
.reviewer-name { 
  font-weight: 600; 
  color: var(--text); 
  margin: 0; 
  flex: 1; 
  padding-right: 100px; 
}
.review-rating { 
  color: #FF9800; 
  font-size: 1rem;
  font-weight: 600;
  position: absolute; 
  right: 0; 
  top: 0; 
}
.review-comment { 
  margin: 0; 
  color: var(--text2); 
  line-height: 1.6; 
  margin-bottom: 8px;
}
.review-date { 
  font-size: 0.8rem; 
  color: var(--text2); 
}
.review-actions { 
  position: absolute; 
  top: 0; 
  right: 0; 
}
.delete-review { 
  background: none; 
  border: none; 
  color: #ff4444; 
  cursor: pointer; 
  padding: 6px 10px; 
  border-radius: 6px; 
  font-size: 0.8rem; 
  transition: all 0.3s ease; 
  border: 1px solid transparent;
}
.delete-review:hover { 
  background: rgba(255, 68, 68, 0.1); 
  border-color: #ff4444;
}
.reviews-loading, .reviews-empty { 
  text-align: center; 
  padding: 40px 20px; 
  color: var(--text2); 
  font-style: italic; 
}
</style>





<style>
.stars { display: flex; gap: 4px; }
.star { 
  font-size: 1.8rem; 
  color: #ddd; 
  cursor: pointer; 
  transition: all 0.2s ease; 
  user-select: none;
}
.star:hover, .star.active { 
  color: #FF9800; 
  transform: scale(1.2); 
}
.review { 
  border-bottom: 1px solid var(--nav-shadow); 
  padding: 20px 0; 
  position: relative; 
}
.review:last-child { border-bottom: none; }
.review-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  margin-bottom: 12px; 
  position: relative; 
}
.reviewer-name { 
  font-weight: 600; 
  color: var(--text); 
  margin: 0; 
  flex: 1; 
  padding-right: 100px; 
}
.review-rating { 
  color: #FF9800; 
  font-size: 1rem;
  font-weight: 600;
  position: absolute; 
  right: 0; 
  top: 0; 
}
.review-comment { 
  margin: 0; 
  color: var(--text2); 
  line-height: 1.6; 
  margin-bottom: 8px;
}
.review-date { 
  font-size: 0.8rem; 
  color: var(--text2); 
}
.review-actions { 
  position: absolute; 
  top: 0; 
  right: 0; 
}
.delete-review { 
  background: none; 
  border: none; 
  color: #ff4444; 
  cursor: pointer; 
  padding: 6px 10px; 
  border-radius: 6px; 
  font-size: 0.8rem; 
  transition: all 0.3s ease; 
  border: 1px solid transparent;
}
.delete-review:hover { 
  background: rgba(255, 68, 68, 0.1); 
  border-color: #ff4444;
}
.reviews-loading, .reviews-empty { 
  text-align: center; 
  padding: 40px 20px; 
  color: var(--text2); 
  font-style: italic; 
}
</style>

<!-- REVIEW SYSTEM -->
<section class="section reviews" id="reviews-section">
  <h2>Customer Reviews</h2>
  <div id="reviews-list">
    <div class="reviews-loading">Loading reviews...</div>
  </div>
  
  <h3 style="margin-top: 30px; font-size: 1.2rem;">Add Your Review</h3>
  <form id="review-form" style="display:none;">
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px; flex-wrap: wrap;">
        <span style="font-weight: 500;">Rating:</span>
        <div class="stars">
          <span class="star" data-rating="1">‚òÖ</span>
          <span class="star" data-rating="2">‚òÖ</span>
          <span class="star" data-rating="3">‚òÖ</span>
          <span class="star" data-rating="4">‚òÖ</span>
          <span class="star" data-rating="5">‚òÖ</span>
        </div>
        <span id="rating-text" style="color: var(--text2); min-width: 100px;">Select rating</span>
      </div>
    </div>
    <textarea 
      id="review-comment" 
      placeholder="Share your experience..." 
      rows="4" 
      style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--nav-shadow); background: var(--input-bg); color: var(--input-text); font-family: inherit;"
      required
      maxlength="500"
    ></textarea>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
      <button type="submit" class="btn">Submit Review</button>
      <span class="char-count" style="font-size: 0.8rem; color: var(--text2);">0/500</span>
    </div>
  </form>
  <div id="auth-prompt" style="text-align: center; padding: 20px; background: var(--card); border-radius: 8px; margin-top: 20px; border: 1px solid var(--nav-shadow);">
    <p>Please <a href="../login.html" style="color: #FF9800; text-decoration: underline;">sign in</a> to submit a review.</p>
  </div>
</section>

<style>
.stars { display: flex; gap: 4px; }
.star { 
  font-size: 1.8rem; 
  color: #ddd; 
  cursor: pointer; 
  transition: all 0.2s ease; 
  user-select: none;
}
.star:hover, .star.active { 
  color: #FF9800; 
  transform: scale(1.2); 
}
.review { 
  border-bottom: 1px solid var(--nav-shadow); 
  padding: 20px 0; 
  position: relative; 
}
.review:last-child { border-bottom: none; }
.review-header { 
  display: flex; 
  justify-content: space-between; 
  align-items: flex-start; 
  margin-bottom: 12px; 
  position: relative; 
}
.reviewer-name { 
  font-weight: 600; 
  color: var(--text); 
  margin: 0; 
  flex: 1; 
  padding-right: 100px; 
}
.review-rating { 
  color: #FF9800; 
  font-size: 1rem;
  font-weight: 600;
  position: absolute; 
  right: 0; 
  top: 0; 
}
.review-comment { 
  margin: 0; 
  color: var(--text2); 
  line-height: 1.6; 
  margin-bottom: 8px;
}
.review-date { 
  font-size: 0.8rem; 
  color: var(--text2); 
}
.review-actions { 
  position: absolute; 
  top: 0; 
  right: 0; 
}
.delete-review { 
  background: none; 
  border: none; 
  color: #ff4444; 
  cursor: pointer; 
  padding: 6px 10px; 
  border-radius: 6px; 
  font-size: 0.8rem; 
  transition: all 0.3s ease; 
  border: 1px solid transparent;
}
.delete-review:hover { 
  background: rgba(255, 68, 68, 0.1); 
  border-color: #ff4444;
}
.reviews-loading, .reviews-empty { 
  text-align: center; 
  padding: 40px 20px; 
  color: var(--text2); 
  font-style: italic; 
}

@media (max-width: 768px) {
  .review-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  .reviewer-name {
    padding-right: 0;
  }
  .review-rating {
    position: static;
  }
  .review-actions {
    position: static;
    align-self: flex-end;
  }
}
</style>

<script>
// Review System with Profile-style Authentication
console.log('Loading review system for restaurant: 41');

document.addEventListener('DOMContentLoaded', function() {
    const restaurantId = 41;
    let currentUser = null;
    let currentRating = 0;

    console.log('Review system initialized for restaurant:', restaurantId);

    // Check authentication (same as profile page)
    async function checkAuth() {
        try {
            console.log('Checking authentication...');
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error) {
                console.error('Auth error:', error);
                return;
            }

            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.email);
                document.getElementById('review-form').style.display = 'block';
                document.getElementById('auth-prompt').style.display = 'none';
            } else {
                console.log('User not authenticated');
                document.getElementById('review-form').style.display = 'none';
                document.getElementById('auth-prompt').style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking auth:', error);
        }
    }

    // Load reviews
    async function loadReviews() {
        const container = document.getElementById('reviews-list');
        if (!container) {
            console.error('Reviews container not found!');
            return;
        }

        try {
            console.log('Loading reviews...');
            const { data: reviews, error } = await supabase
                .from('reviews')
                .select('*')
                .eq('restaurant_id', restaurantId)
                .order('created_at', { ascending: false });

            if (error) throw error;

            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to share your experience!</div>';
                console.log('No reviews found');
                return;
            }

            console.log('Found ' + reviews.length + ' reviews');

            // Get user profiles for proper names
            const userIds = [...new Set(reviews.map(r => r.user_id))];
            const { data: userProfiles } = await supabase
                .from('user_profiles')
                .select('id, username, full_name')
                .in('id', userIds);

            const userMap = {};
            if (userProfiles) {
                userProfiles.forEach(profile => {
                    userMap[profile.id] = profile;
                });
            }

            container.innerHTML = reviews.map(review => {
                const user = userMap[review.user_id];
                const displayName = user ? (user.full_name || user.username) : 'Anonymous User';
                const canDelete = currentUser && currentUser.id === review.user_id;
                
                return '<div class="review">' +
                    '<div class="review-header">' +
                        '<h4 class="reviewer-name">' + displayName + '</h4>' +
                        '<div class="review-rating">' + '‚òÖ'.repeat(review.rating) + '‚òÜ'.repeat(5 - review.rating) + '</div>' +
                        (canDelete ? 
                            '<div class="review-actions">' +
                                '<button class="delete-review" onclick="deleteReview(\'' + review.id + '\')">' +
                                    '<i class="fas fa-trash"></i> Delete' +
                                '</button>' +
                            '</div>' 
                        : '') +
                    '</div>' +
                    '<p class="review-comment">' + review.comment + '</p>' +
                    '<div class="review-date">' + new Date(review.created_at).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long', 
                        day: 'numeric'
                    }) + '</div>' +
                '</div>';
            }).join('');

        } catch (error) {
            console.error('Error loading reviews:', error);
            container.innerHTML = '<div class="reviews-empty">Error loading reviews</div>';
        }
    }

    // Submit review
    async function submitReview(e) {
        e.preventDefault();
        
        if (!currentUser) {
            alert('Please sign in to submit a review');
            window.location.href = '../login.html';
            return;
        }

        const comment = document.getElementById('review-comment').value.trim();
        if (!comment) {
            alert('Please write a review comment');
            return;
        }

        if (currentRating === 0) {
            alert('Please select a rating');
            return;
        }

        try {
            // Get user profile for proper name
            const { data: userProfile } = await supabase
                .from('user_profiles')
                .select('username, full_name')
                .eq('id', currentUser.id)
                .single();

            const displayName = userProfile ? (userProfile.full_name || userProfile.username) : 'User';

            const { error } = await supabase
                .from('reviews')
                .insert({
                    restaurant_id: restaurantId,
                    user_id: currentUser.id,
                    user_name: displayName,
                    rating: currentRating,
                    comment: comment
                });

            if (error) throw error;

            // Reset form
            document.getElementById('review-form').reset();
            currentRating = 0;
            updateStars();
            
            const charCount = document.querySelector('.char-count');
            if (charCount) charCount.textContent = '0/500';

            // Reload reviews
            await loadReviews();
            alert('Review submitted successfully! üéâ');

        } catch (error) {
            console.error('Error submitting review:', error);
            alert('Error submitting review. Please try again.');
        }
    }

    // Delete review
    async function deleteReview(reviewId) {
        if (!currentUser || !confirm('Are you sure you want to delete this review?')) {
            return;
        }

        try {
            const { error } = await supabase
                .from('reviews')
                .delete()
                .eq('id', reviewId)
                .eq('user_id', currentUser.id);

            if (error) throw error;

            await loadReviews();
            alert('Review deleted successfully');

        } catch (error) {
            console.error('Error deleting review:', error);
            alert('Error deleting review');
        }
    }

    // Star rating
    function updateStars() {
        const stars = document.querySelectorAll('.star');
        const ratingText = document.getElementById('rating-text');
        
        stars.forEach(star => {
            const rating = parseInt(star.dataset.rating);
            star.classList.toggle('active', rating <= currentRating);
        });
        
        const texts = ['Select rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        if (ratingText) {
            ratingText.textContent = texts[currentRating] || 'Select rating';
        }
    }

    // Event listeners
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('star')) {
            currentRating = parseInt(e.target.dataset.rating);
            updateStars();
        }
    });

    const reviewForm = document.getElementById('review-form');
    if (reviewForm) {
        reviewForm.addEventListener('submit', submitReview);
    }

    // Character count
    const commentTextarea = document.getElementById('review-comment');
    if (commentTextarea) {
        commentTextarea.addEventListener('input', function(e) {
            const count = e.target.value.length;
            const charCount = document.querySelector('.char-count');
            if (charCount) charCount.textContent = count + '/500';
        });
    }

    // Make deleteReview global
    window.deleteReview = deleteReview;

    // Initialize
    checkAuth();
    loadReviews();
});
</script>