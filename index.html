<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zo2y - Home</title>
  <meta name="description" content="Zo2y universal homepage for restaurants, movies, TV shows, games, and books." />
  <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="js/list-utils.js" defer></script>
  <script src="js/universal-search.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --card-2: #172b58;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --white: #ffffff;
      --border: rgba(255,255,255,0.1);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --surface: rgba(19, 35, 71, 0.82);
      --shadow: 0 12px 34px rgba(0,0,0,0.28);
      --ok: #10b981;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      min-height: 100%;
      background: var(--bg);
      color: var(--white);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
    }

    a { color: inherit; text-decoration: none; }

    .container {
      width: min(1240px, calc(100% - 28px));
      margin: 0 auto;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px) saturate(180%);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      min-height: 72px;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      flex-wrap: wrap;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .brand img {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: cover;
    }

    .search-wrap {
      flex: 1;
      min-width: 210px;
      max-width: 420px;
      position: relative;
      margin-left: 8px;
    }

    .search-wrap i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 13px;
    }

    .search {
      width: 100%;
      height: 42px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      padding: 0 14px 0 34px;
      outline: none;
    }

    .search:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.14);
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      height: 40px;
      padding: 0 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }

    .btn:hover { border-color: var(--accent); }

    .btn-primary {
      background: var(--gradient);
      color: #0b1633;
      border: 0;
    }

    .hero {
      margin-top: 18px;
      background: linear-gradient(145deg, #132347, #0f1f43);
      border: 1px solid var(--border);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      right: -80px;
      top: -70px;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(245,158,11,0.24) 0%, rgba(245,158,11,0) 70%);
      pointer-events: none;
    }

    .hero h1 {
      font-size: clamp(28px, 4.2vw, 46px);
      line-height: 1.08;
      margin-bottom: 10px;
    }

    .hero p {
      color: #c9d6f2;
      font-size: 16px;
      max-width: 860px;
      margin-bottom: 14px;
    }

    .hero-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .pill {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 11px;
      font-size: 13px;
      color: #e8efff;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status { font-size: 13px; color: var(--ok); }

    .jump-grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
    }

    .jump-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      transition: transform 0.2s ease;
    }

    .jump-card:hover { transform: translateY(-3px); border-color: var(--accent); }

    .jump-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 15px;
      font-weight: 700;
    }

    .jump-card p { color: var(--muted); font-size: 13px; }

    .section {
      margin-top: 18px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .section-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }

    .section-head h2 { font-size: 23px; margin-bottom: 3px; }
    .section-head p { color: var(--muted); font-size: 13px; }

    .rail-wrap { padding: 14px 14px 16px; }

    .rail-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 9px;
      font-size: 16px;
      font-weight: 700;
    }

    .rail-title a { color: var(--accent); font-size: 13px; }

    .rail {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 156px;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
    }

    .rail::-webkit-scrollbar { height: 7px; }
    .rail::-webkit-scrollbar-thumb { background: rgba(140,163,199,0.55); border-radius: 999px; }
    .rail.games-rail { grid-auto-columns: 248px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--card-2);
      scroll-snap-align: start;
      min-height: 232px;
      position: relative;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .card.menu-open,
    .card.menu-open:hover {
      transform: none;
    }

    .card-media {
      width: 100%;
      aspect-ratio: 2/3;
      background: #0c1a3b;
      display: grid;
      place-items: center;
      color: var(--muted);
    }

    .card-media.landscape { aspect-ratio: 16/10; }
    .card-media.game-poster { aspect-ratio: 16/10; }
    .card-media.game-poster img {
      object-fit: contain !important;
      background: #0c1a3b;
      padding: 4px;
    }

    .card-media img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .card-meta { padding: 9px; }
    .card-meta-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 5px;
    }

    .card-name {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 36px;
      margin-bottom: 0;
    }

    .card-sub {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 17px;
    }

    .card-extra {
      margin-top: 6px;
      color: #a9b9da;
      font-size: 12px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 32px;
    }

    .rail.games-rail .card {
      height: 326px;
      min-height: 326px;
      display: flex;
      flex-direction: column;
    }

    .rail.games-rail .card-meta {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .card-menu-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .card-menu-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(19, 35, 71, 0.92);
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .card-menu-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .rail-menu {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(94vw, 400px);
      border-radius: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 12px;
      display: none;
      z-index: 3300;
    }

    .rail-menu.open {
      display: block;
    }

    .rail-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 3290;
      display: none;
    }

    .rail-menu-backdrop.active {
      display: block;
    }

    .rail-menu-item {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 11px;
      padding: 10px 12px;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .rail-menu-item:last-child {
      margin-bottom: 0;
    }

    .rail-menu-item:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .rail-menu-title {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 2px 2px 10px;
    }

    .rail-menu-item-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .rail-menu-state {
      color: var(--white);
      opacity: 0.9;
      font-weight: 600;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(6, 12, 28, 0.72);
      z-index: 240;
      padding: 16px;
    }

    .modal.active { display: flex; }

    .modal-content {
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
    }

    .modal-close {
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 22px;
      cursor: pointer;
    }

    .modal-list {
      display: grid;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding: 6px 0;
    }

    .modal-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .modal-list-item.active {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }

    .modal-list-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .list-edit-btn {
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .list-edit-btn:hover { color: var(--accent); }

    .modal-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-input input {
      flex: 1;
      height: 38px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-2);
      color: var(--white);
      padding: 0 10px;
    }

    .icon-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .icon-option {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-2);
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .icon-option.selected {
      border-color: var(--accent);
      color: var(--accent);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      font-size: 12px;
      display: inline-block;
    }

    .card-hover-cue {
      position: absolute;
      right: 8px;
      top: 8px;
      z-index: 8;
      border: 1px solid rgba(245, 158, 11, 0.45);
      background: rgba(11, 22, 51, 0.88);
      color: var(--accent);
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      opacity: 0;
      transform: translateY(-3px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }

    .card:hover .card-hover-cue {
      opacity: 1;
      transform: translateY(0);
    }

    .empty {
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      border-radius: 12px;
      text-align: center;
      padding: 22px 10px;
      font-size: 13px;
    }

    @media (max-width: 1050px) {
      .jump-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    @media (max-width: 760px) {
      .container { width: calc(100% - 16px); }
      .header-inner { gap: 10px; }
      .brand { font-size: 18px; }
      .brand img { width: 31px; height: 31px; }
      .search-wrap { order: 3; max-width: none; margin-left: 0; width: 100%; }
      .header-actions { margin-left: 0; }
      .hero { padding: 16px; border-radius: 16px; }
      .hero p { font-size: 14px; }
      .jump-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
      .section { border-radius: 16px; }
      .section-head h2 { font-size: 19px; }
      .rail { grid-auto-columns: 142px; }
      .btn { height: 38px; padding: 0 12px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="Zo2y" />
        <span>Zo2y</span>
      </a>

      <div class="search-wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input class="search" id="globalSearch" placeholder="Search all media..." />
      </div>

      <div class="header-actions">
        <a class="btn" href="movies.html">Movies</a>
        <a class="btn" href="tvshows.html">TV</a>
        <a class="btn" href="games.html">Games</a>
        <a class="btn" href="books.html">Books</a>
        <a class="btn" href="restraunts.html">Restaurants</a>
        <a class="btn" href="login.html" id="loginBtn">Login</a>
        <a class="btn btn-primary" href="sign-up.html" id="signupBtn">Sign Up</a>
        <a class="btn" href="profile.html" id="profileBtn" style="display:none;">Profile</a>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <h1>Discover Everything In One Place</h1>
      <p>A universal Zo2y homepage with your restaurants, movies, TV shows, games, and books in one familiar layout.</p>
      <div class="hero-pills">
        <span class="pill"><i class="fa-solid fa-utensils"></i> Restaurants</span>
        <span class="pill"><i class="fa-solid fa-film"></i> Movies</span>
        <span class="pill"><i class="fa-solid fa-tv"></i> TV Shows</span>
        <span class="pill"><i class="fa-solid fa-gamepad"></i> Games</span>
        <span class="pill"><i class="fa-solid fa-book"></i> Books</span>
      </div>
      <div class="status" id="loadStatus">Loading universal feed...</div>

      <div class="jump-grid">
        <a class="jump-card" href="restraunts.html">
          <div class="jump-top"><span>Restaurants</span><i class="fa-solid fa-arrow-right"></i></div>
          <p>Local picks and community favorites.</p>
        </a>
        <a class="jump-card" href="movies.html">
          <div class="jump-top"><span>Movies</span><i class="fa-solid fa-arrow-right"></i></div>
          <p>Trending films and watchlist ideas.</p>
        </a>
        <a class="jump-card" href="tvshows.html">
          <div class="jump-top"><span>TV Shows</span><i class="fa-solid fa-arrow-right"></i></div>
          <p>New series and binge picks.</p>
        </a>
        <a class="jump-card" href="games.html">
          <div class="jump-top"><span>Games</span><i class="fa-solid fa-arrow-right"></i></div>
          <p>Top games and latest hits.</p>
        </a>
        <a class="jump-card" href="books.html">
          <div class="jump-top"><span>Books</span><i class="fa-solid fa-arrow-right"></i></div>
          <p>Popular books worth reading.</p>
        </a>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>Universal Feed</h2>
        <p>Swipe on mobile, scroll on desktop.</p>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-utensils"></i> Restaurants</span><a href="restraunts.html">View all</a></div>
        <div class="rail" id="restaurantsRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-film"></i> Movies</span><a href="movies.html">View all</a></div>
        <div class="rail" id="moviesRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-tv"></i> TV Shows</span><a href="tvshows.html">View all</a></div>
        <div class="rail" id="tvRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-gamepad"></i> Games</span><a href="games.html">View all</a></div>
        <div class="rail" id="gamesRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-book"></i> Books</span><a href="books.html">View all</a></div>
        <div class="rail" id="booksRail"></div>
      </div>
    </section>
  </main>

  <div class="modal" id="homeListsModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="homeListsTitle">Custom Lists</div>
        <button class="modal-close" id="closeHomeListsBtn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-list" id="homeListsContainer"></div>
      <div class="modal-input">
        <input type="text" id="newHomeListName" placeholder="New list name..." maxlength="50">
        <button class="btn" id="createHomeListBtn">Create</button>
      </div>
      <div class="icon-options" id="homeListIconOptions">
        <button class="icon-option selected" data-icon="fas fa-list" aria-label="List"><i class="fas fa-list"></i></button>
        <button class="icon-option" data-icon="fas fa-film" aria-label="Movie"><i class="fas fa-film"></i></button>
        <button class="icon-option" data-icon="fas fa-tv" aria-label="TV"><i class="fas fa-tv"></i></button>
        <button class="icon-option" data-icon="fas fa-gamepad" aria-label="Game"><i class="fas fa-gamepad"></i></button>
        <button class="icon-option" data-icon="fas fa-book" aria-label="Book"><i class="fas fa-book"></i></button>
        <button class="icon-option" data-icon="fas fa-heart" aria-label="Heart"><i class="fas fa-heart"></i></button>
        <button class="icon-option" data-icon="fas fa-star" aria-label="Star"><i class="fas fa-star"></i></button>
        <button class="icon-option" data-icon="fas fa-bookmark" aria-label="Bookmark"><i class="fas fa-bookmark"></i></button>
        <button class="icon-option" data-icon="fas fa-utensils" aria-label="Restaurant"><i class="fas fa-utensils"></i></button>
      </div>
      <div class="modal-actions">
        <button class="btn" id="saveHomeListsBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
    const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4NzVjMDM5N2IxZGUxYzU3NjQ4ZmRiNjJiZGQ5NmI0OSIsIm5iZiI6MTc3MDU4Mzk1NC42NTc5OTk4LCJzdWIiOiI2OTg4Zjc5MmFlYTFkN2NjNjcyY2VlNDciLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1RMWLft0Yl73gfhkCXtnqBIzRQHdaoLfZFYXYN7jm7s';
    const RAWG_KEY = '83b2a55ac54c4c1db7099212e740f680';
    const GOOGLE_BOOKS_KEY = 'AIzaSyD6EFAseKNOjzkpEaY1fmJmZnleM9uJP8s';
    const TMDB_POSTER = 'https://image.tmdb.org/t/p/w500';
    const FALLBACK_RESTAURANTS = [
      { id: 'fallback-r1', name: 'Top Rated Picks', category: 'Community', rating: '4.8' },
      { id: 'fallback-r2', name: 'Most Saved', category: 'Trending', rating: '4.7' },
      { id: 'fallback-r3', name: 'Local Favorites', category: 'Local', rating: '4.9' },
      { id: 'fallback-r4', name: 'Date Night', category: 'Curated', rating: '4.7' },
      { id: 'fallback-r5', name: 'Quick Bites', category: 'Casual', rating: '4.6' }
    ];
    const FALLBACK_BOOKS = [
      { title: 'Atomic Habits', author: 'James Clear', isbn: '9780735211292' },
      { title: 'The Alchemist', author: 'Paulo Coelho', isbn: '9780061122415' },
      { title: 'The Silent Patient', author: 'Alex Michaelides', isbn: '9781250316776' },
      { title: 'Sapiens', author: 'Yuval Noah Harari', isbn: '9780062316097' },
      { title: 'The Hobbit', author: 'J.R.R. Tolkien', isbn: '9780261103344' },
      { title: "Harry Potter and the Sorcerer's Stone", author: 'J.K. Rowling', isbn: '9780590353427' },
      { title: 'To Kill a Mockingbird', author: 'Harper Lee', isbn: '9780061120084' },
      { title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', isbn: '9780743273565' },
      { title: 'Thinking, Fast and Slow', author: 'Daniel Kahneman', isbn: '9780374533557' },
      { title: 'The Psychology of Money', author: 'Morgan Housel', isbn: '9780857197689' }
    ];

    const statusEl = document.getElementById('loadStatus');
    let homeSupabaseClient = null;
    let homeCurrentUser = null;
    const homeCustomListState = {
      mediaType: null,
      itemId: null,
      title: '',
      subtitle: '',
      image: '',
      customLists: [],
      selectedIcon: 'fas fa-list',
      selectedLists: new Set()
    };

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function toHttpsUrl(value) {
      return String(value || '').replace(/^http:\/\//i, 'https://');
    }

    function showHomeToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.top = '16px';
      toast.style.right = '16px';
      toast.style.zIndex = '99999';
      toast.style.background = isError ? '#dc2626' : '#10b981';
      toast.style.color = '#fff';
      toast.style.padding = '10px 14px';
      toast.style.borderRadius = '10px';
      toast.style.fontSize = '13px';
      toast.style.boxShadow = '0 10px 24px rgba(0,0,0,0.35)';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2200);
    }

    function getMediaListConfig(mediaType) {
      const type = String(mediaType || '').toLowerCase();
      if (type === 'movie') {
        return {
          customHref: 'movies.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Watched', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Watchlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'tv') {
        return {
          customHref: 'tvshows.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Watched', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Watchlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'game') {
        return {
          customHref: 'games.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Played', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Backlog', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'book') {
        return {
          customHref: 'books.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'read', label: 'Read', icon: 'fas fa-eye' },
            { key: 'readlist', label: 'Readlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      return {
        customHref: 'restraunts.html',
        rows: [
          { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
          { key: 'visited', label: 'Visited', icon: 'fas fa-eye' },
          { key: 'wantToGo', label: 'Want to Go', icon: 'fas fa-bookmark' }
        ]
      };
    }

    function buildRailListMenuHtml(item) {
      const cfg = getMediaListConfig(item.mediaType);
      const buttons = cfg.rows.map(row => `
        <button class="rail-menu-item" data-action="save" data-list="${row.key}">
          <span class="rail-menu-item-main"><i class="${row.icon}"></i> ${row.label}</span>
          <span class="rail-menu-state">Add</span>
        </button>
      `).join('');
      return `
        <div class="rail-menu-title">Add to list</div>
        ${buttons}
        <button class="rail-menu-item" data-action="custom" data-href="${cfg.customHref}">
          <span class="rail-menu-item-main"><i class="fas fa-list"></i> Custom Lists</span>
          <span class="rail-menu-state">Open</span>
        </button>
      `;
    }

    async function ensureHomeSupabase() {
      if (homeSupabaseClient) return homeSupabaseClient;
      if (!window.supabase || !window.supabase.createClient) return null;
      homeSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          flowType: 'pkce',
          persistSession: true,
          autoRefreshToken: true,
          detectSessionInUrl: true
        }
      });
      return homeSupabaseClient;
    }

    async function ensureRestaurantList(userId, listType) {
      const client = await ensureHomeSupabase();
      if (!client) return null;
      const mapping = {
        favorites: { title: 'Favorites', description: 'My favorite restaurants', icon: 'heart' },
        visited: { title: 'Visited', description: 'Places I have been to', icon: 'check' },
        wantToGo: { title: 'Want to Go', description: 'Places I want to try', icon: 'bookmark' }
      };
      const conf = mapping[listType] || mapping.favorites;
      const { data: existing } = await client
        .from('lists')
        .select('id')
        .eq('user_id', userId)
        .eq('title', conf.title)
        .limit(1)
        .maybeSingle();
      if (existing?.id) return existing.id;
      const { data: created, error } = await client
        .from('lists')
        .insert({
          user_id: userId,
          title: conf.title,
          description: conf.description,
          icon: conf.icon
        })
        .select('id')
        .single();
      if (error) return null;
      return created?.id || null;
    }

    async function saveToListFromHome(payload) {
      const client = await ensureHomeSupabase();
      if (!client) {
        showHomeToast('List service unavailable', true);
        return;
      }
      if (!homeCurrentUser?.id) {
        window.location.href = 'login.html';
        return;
      }

      const mediaType = String(payload.mediaType || '').toLowerCase();
      const itemId = payload.itemId;
      const listType = payload.listType;
      if (!itemId || !listType) return;

      try {
        if (mediaType === 'movie') {
          const { data: existing } = await client
            .from('movie_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('movie_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            showHomeToast('Already in list');
            return;
          }
          await client.from('movie_list_items').insert({ user_id: homeCurrentUser.id, movie_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'tv') {
          const { data: existing } = await client
            .from('tv_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('tv_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            showHomeToast('Already in list');
            return;
          }
          await client.from('tv_list_items').insert({ user_id: homeCurrentUser.id, tv_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'game') {
          const { data: existing } = await client
            .from('game_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('game_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            showHomeToast('Already in list');
            return;
          }
          await client.from('game_list_items').insert({ user_id: homeCurrentUser.id, game_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'book') {
          await client.from('books').upsert({
            id: String(itemId),
            title: payload.title || '',
            authors: payload.subtitle || '',
            thumbnail: payload.image || '',
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
          const { data: existing } = await client
            .from('book_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('book_id', String(itemId))
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            showHomeToast('Already in list');
            return;
          }
          await client.from('book_list_items').insert({ user_id: homeCurrentUser.id, book_id: String(itemId), list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'restaurant') {
          const listId = await ensureRestaurantList(homeCurrentUser.id, listType);
          if (!listId) {
            showHomeToast('Could not prepare list', true);
            return;
          }
          const { data: existing } = await client
            .from('lists_restraunts')
            .select('id')
            .eq('list_id', listId)
            .eq('restraunt_id', itemId)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            showHomeToast('Already in list');
            return;
          }
          await client.from('lists_restraunts').insert({ list_id: listId, restraunt_id: itemId });
          showHomeToast('Added to list');
          return;
        }
      } catch (_err) {
        showHomeToast('Could not add to list', true);
      }
    }

    function getHomeListConfig(mediaType) {
      return window.ListUtils ? ListUtils.getListConfig(mediaType) : null;
    }

    function coerceHomeItemId(mediaType, itemId) {
      return window.ListUtils ? ListUtils.coerceItemId(mediaType, itemId) : itemId;
    }

    function renderHomeListsModal() {
      const container = document.getElementById('homeListsContainer');
      if (!container) return;
      container.innerHTML = '';
      if (!homeCustomListState.customLists.length) {
        container.innerHTML = '<div class="chip">No custom lists yet.</div>';
        return;
      }
      homeCustomListState.customLists.forEach(list => {
        const item = document.createElement('div');
        const isActive = homeCustomListState.selectedLists.has(list.id);
        item.className = `modal-list-item${isActive ? ' active' : ''}`;
        item.innerHTML = `
          <span>${window.ListUtils ? ListUtils.renderListIcon(list.icon, homeCustomListState.selectedIcon) : ''} ${list.title}</span>
          <span class="modal-list-actions">
            <span>${isActive ? 'Saved' : 'Add'}</span>
            <button class="list-edit-btn" aria-label="Rename list"><i class="fas fa-pen"></i></button>
          </span>
        `;
        item.onclick = () => {
          if (homeCustomListState.selectedLists.has(list.id)) {
            homeCustomListState.selectedLists.delete(list.id);
          } else {
            homeCustomListState.selectedLists.add(list.id);
          }
          const active = homeCustomListState.selectedLists.has(list.id);
          item.classList.toggle('active', active);
          const label = item.querySelector('.modal-list-actions span');
          if (label) label.textContent = active ? 'Saved' : 'Add';
        };
        const editBtn = item.querySelector('.list-edit-btn');
        if (editBtn) {
          editBtn.onclick = (e) => {
            e.stopPropagation();
            renameHomeList(list.id, list.title);
          };
        }
        container.appendChild(item);
      });
    }

    function setHomeModalTitle(mediaType) {
      const title = document.getElementById('homeListsTitle');
      if (!title) return;
      const type = String(mediaType || '').toLowerCase();
      const map = {
        movie: 'Custom Movie Lists',
        tv: 'Custom TV Lists',
        game: 'Custom Game Lists',
        book: 'Custom Book Lists',
        restaurant: 'Custom Restaurant Lists'
      };
      title.textContent = map[type] || 'Custom Lists';
    }

    function syncHomeIconSelection(nextIcon) {
      const options = document.querySelectorAll('#homeListIconOptions .icon-option');
      let matched = false;
      options.forEach(btn => {
        const icon = btn.getAttribute('data-icon');
        const selected = icon === nextIcon;
        btn.classList.toggle('selected', selected);
        if (selected) matched = true;
      });
      if (!matched && options[0]) {
        options[0].classList.add('selected');
        homeCustomListState.selectedIcon = options[0].getAttribute('data-icon') || 'fas fa-list';
      }
    }

    async function openHomeListsModal(item) {
      if (!homeCurrentUser?.id) {
        window.location.href = 'login.html';
        return;
      }
      const cfg = getHomeListConfig(item.mediaType);
      if (!cfg) return;
      const client = await ensureHomeSupabase();
      if (!client) return;
      homeCustomListState.mediaType = String(item.mediaType || '').toLowerCase();
      homeCustomListState.itemId = coerceHomeItemId(homeCustomListState.mediaType, item.itemId);
      homeCustomListState.title = item.title || '';
      homeCustomListState.subtitle = item.subtitle || '';
      homeCustomListState.image = item.image || '';
      homeCustomListState.selectedIcon = cfg.defaultIcon || 'fas fa-list';
      syncHomeIconSelection(homeCustomListState.selectedIcon);
      setHomeModalTitle(homeCustomListState.mediaType);

      const modal = document.getElementById('homeListsModal');
      const container = document.getElementById('homeListsContainer');
      if (!modal || !container) return;
      container.innerHTML = '<div class="chip">Loading...</div>';
      homeCustomListState.customLists = window.ListUtils
        ? await ListUtils.loadCustomLists(client, homeCurrentUser.id, homeCustomListState.mediaType)
        : [];
      const listIds = homeCustomListState.customLists.map(l => l.id);
      homeCustomListState.selectedLists = window.ListUtils
        ? await ListUtils.loadCustomListMembership(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          homeCustomListState.itemId,
          listIds
        )
        : new Set();
      renderHomeListsModal();
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeHomeListsModal() {
      const modal = document.getElementById('homeListsModal');
      if (modal) {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
      }
      homeCustomListState.mediaType = null;
      homeCustomListState.itemId = null;
      homeCustomListState.customLists = [];
      homeCustomListState.selectedLists = new Set();
    }

    async function saveHomeListChanges() {
      const cfg = getHomeListConfig(homeCustomListState.mediaType);
      const client = await ensureHomeSupabase();
      if (!cfg || !client || !homeCurrentUser?.id || !homeCustomListState.itemId) return;
      if (window.ListUtils) {
        await ListUtils.saveCustomListChanges(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          homeCustomListState.itemId,
          [...homeCustomListState.selectedLists],
          homeCustomListState.mediaType === 'book'
            ? {
              id: homeCustomListState.itemId,
              title: homeCustomListState.title,
              authors: homeCustomListState.subtitle,
              thumbnail: homeCustomListState.image
            }
            : null
        );
      }
      showHomeToast('Lists updated');
      closeHomeListsModal();
    }

    async function createHomeList() {
      const input = document.getElementById('newHomeListName');
      const client = await ensureHomeSupabase();
      if (!input || !client || !homeCurrentUser?.id) return;
      const title = input.value.trim();
      if (!title) return;
      const exists = homeCustomListState.customLists.some(
        list => String(list.title || '').trim().toLowerCase() === title.toLowerCase()
      );
      if (exists) {
        showHomeToast('List already exists', true);
        return;
      }
      const data = window.ListUtils
        ? await ListUtils.createCustomList(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          {
            title,
            icon: homeCustomListState.selectedIcon
          }
        )
        : null;
      if (!data) {
        showHomeToast('Could not create list', true);
        return;
      }
      input.value = '';
      homeCustomListState.customLists.unshift(data);
      renderHomeListsModal();
    }

    async function renameHomeList(listId, currentTitle) {
      const nextTitle = prompt('Rename list', currentTitle || '');
      if (!nextTitle || !nextTitle.trim()) return;
      const client = await ensureHomeSupabase();
      if (!client || !homeCurrentUser?.id) return;
      const ok = window.ListUtils
        ? await ListUtils.renameCustomList(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          listId,
          nextTitle.trim()
        )
        : false;
      if (!ok) {
        showHomeToast('Could not rename list', true);
        return;
      }
      homeCustomListState.customLists = homeCustomListState.customLists.map(list =>
        list.id === listId ? { ...list, title: nextTitle.trim() } : list
      );
      renderHomeListsModal();
    }

    function setStatus(text, isError) {
      statusEl.textContent = text;
      statusEl.style.color = isError ? '#fca5a5' : 'var(--ok)';
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffleArray(input) {
      const arr = [...input];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function renderRail(railId, items, opts) {
      const rail = document.getElementById(railId);
      if (!rail) return;
      rail.classList.toggle('games-rail', String(opts?.mediaType || '').toLowerCase() === 'game');

      if (!items || !items.length) {
        rail.innerHTML = '<div class="empty">No items right now.</div>';
        return;
      }

      const landscape = !!opts.landscape;
      rail.innerHTML = items.map(item => {
        const title = escapeHtml(item.title);
        const subtitle = escapeHtml(item.subtitle);
        const extra = escapeHtml(item.extra || '');
        const image = item.image || '';
        const href = item.href || '#';
        const mediaType = escapeHtml(item.mediaType || '');
        const itemId = escapeHtml(item.itemId || '');
        const safeImage = escapeHtml(item.image || '');
        return `
          <article class="card" data-href="${href}" data-media-type="${mediaType}" data-item-id="${itemId}" data-title="${title}" data-subtitle="${subtitle}" data-image="${safeImage}">
            <div class="card-hover-cue"><i class="fas fa-arrow-up-right-from-square"></i> Open</div>
            <div class="card-media ${landscape ? 'landscape' : ''} ${String(item.mediaType || '').toLowerCase() === 'game' ? 'game-poster' : ''}">
              ${image ? `<img src="${image}" alt="${title}" loading="lazy">` : '<i class="fa-solid fa-image"></i>'}
            </div>
            <div class="card-meta">
              <div class="card-meta-top">
                <p class="card-name">${title}</p>
                <div class="card-menu-wrap">
                  <button class="card-menu-btn" aria-label="Add to lists"><i class="fas fa-ellipsis-v"></i></button>
                  <div class="rail-menu">
                    ${buildRailListMenuHtml(item)}
                  </div>
                </div>
              </div>
              <p class="card-sub">${subtitle}</p>
              ${extra ? `<p class="card-extra">${extra}</p>` : ''}
            </div>
          </article>
        `;
      }).join('');

      wireHomeCardMenus(rail);
    }

    function wireHomeCardMenus(scope) {
      scope.querySelectorAll('.card').forEach((card) => {
        const href = card.getAttribute('data-href');
        card.onclick = (e) => {
          if (e.target.closest('.card-menu-btn') || e.target.closest('.rail-menu')) return;
          if (href) window.location.href = href;
        };
      });

      scope.querySelectorAll('.card-menu-btn').forEach((btn) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const menu = btn.parentElement.querySelector('.rail-menu');
          const wasOpen = !!menu?.classList.contains('open');
          closeAllRailMenus();
          if (menu && !wasOpen) {
            menu.classList.add('open');
            const card = btn.closest('.card');
            if (card) card.classList.add('menu-open');
            showRailMenuBackdrop();
          }
        });
      });

      scope.querySelectorAll('.rail-menu-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = item.getAttribute('data-action');
          closeAllRailMenus();
          if (action === 'save') {
            const card = item.closest('.card');
            if (!card) return;
            saveToListFromHome({
              mediaType: card.getAttribute('data-media-type'),
              itemId: card.getAttribute('data-item-id'),
              listType: item.getAttribute('data-list'),
              title: card.getAttribute('data-title'),
              subtitle: card.getAttribute('data-subtitle'),
              image: card.getAttribute('data-image')
            });
            return;
          }
          if (action === 'custom') {
            const card = item.closest('.card');
            if (card) {
              openHomeListsModal({
                mediaType: card.getAttribute('data-media-type'),
                itemId: card.getAttribute('data-item-id'),
                title: card.getAttribute('data-title'),
                subtitle: card.getAttribute('data-subtitle'),
                image: card.getAttribute('data-image')
              });
              return;
            }
            const href = item.getAttribute('data-href');
            if (href) window.location.href = href;
          }
        });
      });
    }

    function ensureRailMenuBackdrop() {
      let backdrop = document.getElementById('railMenuBackdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'railMenuBackdrop';
        backdrop.className = 'rail-menu-backdrop';
        backdrop.addEventListener('click', closeAllRailMenus);
        document.body.appendChild(backdrop);
      }
      return backdrop;
    }

    function showRailMenuBackdrop() {
      const backdrop = ensureRailMenuBackdrop();
      backdrop.classList.add('active');
    }

    function hideRailMenuBackdrop() {
      const backdrop = document.getElementById('railMenuBackdrop');
      if (backdrop) backdrop.classList.remove('active');
    }

    function closeAllRailMenus() {
      document.querySelectorAll('.rail-menu.open').forEach((menu) => menu.classList.remove('open'));
      document.querySelectorAll('.card.menu-open').forEach((card) => card.classList.remove('menu-open'));
      hideRailMenuBackdrop();
    }

    async function setupHomeAuthListener() {
      const client = await ensureHomeSupabase();
      if (!client) return;

      client.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_IN' && session) {
          homeCurrentUser = session.user;
          await initAuthUi();
        } else if (event === 'SIGNED_OUT') {
          homeCurrentUser = null;
          window.location.reload();
        } else if (event === 'TOKEN_REFRESHED') {
          if (session?.user) {
            homeCurrentUser = session.user;
          }
        }
      });
    }

    async function initAuthUi() {
      const client = await ensureHomeSupabase();
      if (!client) return;
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const profileBtn = document.getElementById('profileBtn');
      try {
        const { data } = await client.auth.getSession();
        const user = data?.session?.user || null;
        homeCurrentUser = user;
        const isLoggedIn = !!user;
        if (isLoggedIn) {
          loginBtn.style.display = 'none';
          signupBtn.style.display = 'none';
          let label = 'Profile';
          try {
            const { data: profile } = await client
              .from('user_profiles')
              .select('username, display_name, full_name')
              .eq('id', user.id)
              .single();
            const raw = profile?.username || profile?.display_name || profile?.full_name || '';
            const clean = String(raw || '').trim();
            if (clean) label = clean.startsWith('@') ? clean : `@${clean}`;
          } catch (_profileErr) {}
          profileBtn.innerHTML = `<i class=\"fas fa-user\"></i><span>${label}</span>`;
          profileBtn.style.display = 'inline-flex';
        } else {
          loginBtn.style.display = 'inline-flex';
          signupBtn.style.display = 'inline-flex';
          profileBtn.style.display = 'none';
        }
      } catch (_e) {
        homeCurrentUser = null;
        profileBtn.style.display = 'none';
      }
    }

    async function loadRestaurants() {
      const client = await ensureHomeSupabase();
      if (!client) {
        return FALLBACK_RESTAURANTS.map((r) => ({
          mediaType: 'restaurant',
          itemId: String(r.id),
          title: r.name,
          subtitle: `${r.category} | ${r.rating}/5`,
          image: '',
          href: 'restraunts.html'
        }));
      }
      const { data, error } = await client
        .from('restraunts')
        .select('id,name,image,category,rating')
        .order('rating', { ascending: false })
        .limit(10);
      if (error || !data || !data.length) {
        return FALLBACK_RESTAURANTS.map((r) => ({
          mediaType: 'restaurant',
          itemId: String(r.id),
          title: r.name,
          subtitle: `${r.category} | ${r.rating}/5`,
          image: '',
          href: 'restraunts.html'
        }));
      }
      return data.map(r => ({
        mediaType: 'restaurant',
        itemId: String(r.id || ''),
        title: r.name || 'Restaurant',
        subtitle: `${r.category || 'Restaurant'}${r.rating ? ` | ${r.rating}/5` : ''}`,
        image: r.image ? toHttpsUrl(`images/${r.image}`) : '',
        href: r.id ? `restaurant.html?id=${encodeURIComponent(r.id)}` : 'restraunts.html'
      }));
    }

    async function loadMovies() {
      const page = randomInt(1, 5);
      const res = await fetch(`https://api.themoviedb.org/3/movie/popular?language=en-US&page=${page}`, {
        headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
      });
      if (!res.ok) return [];
      const json = await res.json();
      const results = Array.isArray(json.results) ? shuffleArray(json.results).slice(0, 10) : [];
      return results.map(m => ({
        mediaType: 'movie',
        itemId: String(m.id || ''),
        title: m.title || 'Movie',
        subtitle: m.release_date ? m.release_date.slice(0, 4) : 'Movie',
        image: m.poster_path ? `${TMDB_POSTER}${m.poster_path}` : '',
        href: m.id ? `movie.html?id=${encodeURIComponent(m.id)}` : 'movies.html'
      }));
    }

    async function loadTv() {
      const page = randomInt(1, 5);
      const res = await fetch(`https://api.themoviedb.org/3/tv/popular?language=en-US&page=${page}`, {
        headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
      });
      if (!res.ok) return [];
      const json = await res.json();
      const results = Array.isArray(json.results) ? shuffleArray(json.results).slice(0, 10) : [];
      return results.map(t => ({
        mediaType: 'tv',
        itemId: String(t.id || ''),
        title: t.name || 'TV Show',
        subtitle: t.first_air_date ? t.first_air_date.slice(0, 4) : 'TV Show',
        image: t.poster_path ? `${TMDB_POSTER}${t.poster_path}` : '',
        href: t.id ? `tvshow.html?id=${encodeURIComponent(t.id)}` : 'tvshows.html'
      }));
    }

    async function loadGames() {
      // Prefer broadly popular, mainstream releases over niche high-rating titles.
      const res = await fetch(`https://api.rawg.io/api/games?page_size=24&ordering=-added&dates=2015-01-01,2026-12-31&metacritic=70,100&key=${RAWG_KEY}`);
      if (!res.ok) return [];
      const json = await res.json();
      const results = Array.isArray(json.results) ? json.results : [];

      const seen = new Set();
      const candidates = [];
      for (const g of results) {
        const nameKey = String(g.name || '').trim().toLowerCase();
        if (!nameKey || seen.has(nameKey)) continue;
        if (!g.background_image) continue;
        if ((g.ratings_count || 0) < 200) continue;
        seen.add(nameKey);
        candidates.push(g);
      }

      const filtered = shuffleArray(candidates).slice(0, 10);

      return filtered.map(g => ({
        mediaType: 'game',
        itemId: String(g.id || ''),
        title: g.name || 'Game',
        subtitle: g.released ? g.released.slice(0, 4) : 'Game',
        extra: `${Array.isArray(g.genres) && g.genres.length ? g.genres.slice(0, 2).map(x => x?.name).filter(Boolean).join(' | ') : 'Video Game'}${g.rating ? ` | ${Number(g.rating).toFixed(1)}/5` : ''}`,
        image: g.background_image || '',
        href: g.id ? `game.html?id=${encodeURIComponent(g.id)}` : 'games.html'
      }));
    }

    async function loadBooks() {
      // Keep to one request to avoid hitting Google Books 429 rate limits.
      try {
        const url = `https://www.googleapis.com/books/v1/volumes?q=subject:fiction&orderBy=relevance&maxResults=24&printType=books&langRestrict=en&key=${GOOGLE_BOOKS_KEY}`;
        const res = await fetch(url);
        if (res.ok) {
          const json = await res.json();
          const items = Array.isArray(json.items) ? json.items : [];
          const mapped = items.map((item) => {
            const info = item.volumeInfo || {};
            const title = String(info.title || '').trim();
            if (!title) return null;
            const author = Array.isArray(info.authors) && info.authors.length ? info.authors[0] : 'Book';
            return {
              mediaType: 'book',
              itemId: String(item.id || ''),
              title,
              subtitle: author,
              image: toHttpsUrl(info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || ''),
              href: item.id ? `book.html?id=${encodeURIComponent(item.id)}` : 'books.html'
            };
          }).filter(Boolean);
          if (mapped.length) return mapped.slice(0, 10);
        }
      } catch (_e) {}

      return shuffleArray(FALLBACK_BOOKS).slice(0, 10).map((b, idx) => ({
        mediaType: 'book',
        itemId: `fallback-book-${idx}`,
        title: b.title,
        subtitle: b.author,
        image: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        href: 'books.html'
      }));
    }

    async function initUniversalHome() {
      setStatus('Loading universal feed...', false);

      const rails = [
        { railId: 'restaurantsRail', loader: loadRestaurants, opts: { landscape: true, sectionHref: 'restraunts.html', typeName: 'restaurant', mediaType: 'restaurant' } },
        { railId: 'moviesRail', loader: loadMovies, opts: { landscape: false, sectionHref: 'movies.html', typeName: 'movie', mediaType: 'movie' } },
        { railId: 'tvRail', loader: loadTv, opts: { landscape: false, sectionHref: 'tvshows.html', typeName: 'TV show', mediaType: 'tv' } },
        { railId: 'gamesRail', loader: loadGames, opts: { landscape: false, sectionHref: 'games.html', typeName: 'game', mediaType: 'game' } },
        { railId: 'booksRail', loader: loadBooks, opts: { landscape: false, sectionHref: 'books.html', typeName: 'book', mediaType: 'book' } }
      ];

      let completed = 0;
      let successful = 0;

      rails.forEach((section) => {
        section.loader()
          .then((items) => {
            const list = Array.isArray(items) ? items : [];
            renderRail(section.railId, list, section.opts);
            if (list.length > 0) successful += 1;
          })
          .catch(() => {
            renderRail(section.railId, [], section.opts);
          })
          .finally(() => {
            completed += 1;
            if (completed < rails.length) {
              setStatus(`Loading feed... ${completed}/${rails.length}`, false);
              return;
            }
            if (!successful) {
              setStatus('Could not load feeds right now. Use top tabs to browse directly.', true);
              return;
            }
            setStatus('Universal feed ready.', false);
          });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupHomeAuthListener();
      initAuthUi();
      initUniversalHome();
      const closeListsBtn = document.getElementById('closeHomeListsBtn');
      const saveListsBtn = document.getElementById('saveHomeListsBtn');
      const createListBtn = document.getElementById('createHomeListBtn');
      const iconOptions = document.querySelectorAll('#homeListIconOptions .icon-option');
      const modal = document.getElementById('homeListsModal');
      if (closeListsBtn) closeListsBtn.addEventListener('click', closeHomeListsModal);
      if (saveListsBtn) saveListsBtn.addEventListener('click', saveHomeListChanges);
      if (createListBtn) createListBtn.addEventListener('click', createHomeList);
      iconOptions.forEach(btn => {
        btn.addEventListener('click', () => {
          iconOptions.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          homeCustomListState.selectedIcon = btn.getAttribute('data-icon') || 'fas fa-list';
        });
      });
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeHomeListsModal();
        });
      }
      if (window.initUniversalSearch) {
        window.initUniversalSearch({
          input: '#globalSearch',
          fallbackRoute: 'restraunts.html'
        });
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAllRailMenus();
          closeHomeListsModal();
        }
      });
    });
  </script>
</body>
</html>
