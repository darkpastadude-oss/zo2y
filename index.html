<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zo2y ‚Äî Discover Local Favorites</title>

    <!-- Favicon for all devices -->
    <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico?v=3" type="image/x-icon">
    
    <!-- For modern browsers -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=3">
    
    <!-- For Apple devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3">
    
    <!-- For Windows Metro -->
    <meta name="msapplication-TileColor" content="#0b1633">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png?v=3">
    <meta name="theme-color" content="#0b1633">
    
    <!-- Safari pinned tab -->
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=3" color="#f59e0b">

    <!-- Search Engine Optimization -->
    <meta name="description" content="Discover hidden gems and local favorite restaurants based on authentic reviews from the food lover community.">
    <meta name="keywords" content="restaurants, food, dining, reviews, local favorites, food discovery">
    <meta name="author" content="Zo2y">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.zo2y.com/">
    <meta property="og:title" content="Zo2y ‚Äî Discover Local Favorites">
    <meta property="og:description" content="Find authentic dining experiences based on real reviews from the food lover community.">
    <meta property="og:image" content="https://www.zo2y.com/images/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Zo2y Logo">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.zo2y.com/">
    <meta property="twitter:title" content="Zo2y ‚Äî Discover Local Favorites">
    <meta property="twitter:description" content="Find authentic dining experiences based on real reviews from the food lover community.">
    <meta property="twitter:image" content="https://www.zo2y.com/images/logo.png">
    <meta property="twitter:image:alt" content="Zo2y Logo">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* KEEP ALL YOUR EXISTING CSS HERE - IT'S FINE */
        :root { 
            --bg: #0b1633; 
            --card: #132347; 
            --muted: #8ca3c7; 
            --accent: #f59e0b; 
            --glass: rgba(255,255,255,0.03); 
            --white: #ffffff; 
            --border: rgba(255,255,255,0.1);
            --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --success: #10b981; 
            --error: #ef4444; 
            --info: #3b82f6;
            --surface: rgba(19, 35, 71, 0.6);
            --cloud-color: #3b82f6;
            --radial-glow: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; overflow-x: hidden; }
        a { color: inherit; text-decoration: none; }
        img { display: block; max-width: 100%; height: auto; }
        
        /* ALL YOUR EXISTING CSS REMAINS HERE */
        /* I'm keeping it brief since you want the full working loading code */
        
    </style>
</head>
<body>
    <!-- Guest Banner -->
    <div id="guestBanner" class="guest-banner">
        <div class="banner-content">
            <span class="banner-text">Want to save your favorite restaurants?</span>
            <div class="banner-actions">
                <button class="banner-btn banner-btn-outline" id="bannerLoginBtn">Sign In</button>
                <button class="banner-btn banner-btn-primary" id="bannerSignupBtn">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Header with Mobile Layout -->
    <header class="nav" role="banner">
        <div class="nav-container">
            <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
            
            <!-- Mobile Search Toggle Button -->
            <button class="mobile-search-toggle" id="mobileSearchToggle" aria-label="Toggle search">
                <i class="fas fa-search"></i>
            </button>
            
            <div class="search-wrapper" id="searchWrapper">
                <div class="search-container">
                    <span class="search-icon">üîé</span>
                    <input type="text" id="search" class="search" placeholder="Search restaurants..." aria-label="Search restaurants">
                    <button class="clear-search" id="clearSearch" aria-label="Clear search">‚úï</button>
                    
                    <!-- Search Dropdown -->
                    <div class="search-dropdown" id="searchDropdown"></div>
                </div>
            </div>
            
            <div class="nav-right">
                <a class="ghost" href="restraunts.html">Explore All</a>
                <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" aria-labelledby="heroTitle">
        <div class="hero-container">
            <div class="hero-left">
                <div class="tag">Trusted by Food Lovers</div>
                <h1 id="heroTitle">Discover Hidden Gems & Local Favorites</h1>
                <p class="lead">Find authentic dining experiences based on real reviews from the food lover community.</p>
                <div class="cta-row">
                    <button class="btn-primary logged-out" id="startJourneyBtn">
                        <i class="fas fa-map-signs"></i>
                        <span>Start Your Food Journey</span>
                    </button>
                    
                    <button class="btn-primary logged-in" onclick="location.href='restraunts.html'" style="display: none;">
                        <i class="fas fa-utensils"></i>
                        <span>Explore All Restaurants</span>
                    </button>
                </div>
            </div>
            <div class="hero-right">
                <div class="spotlight-wrapper">
                    <div class="spotlight" id="spotlightCard" role="region" aria-live="polite">
                        <div class="spotlight-img-container">
                            <img id="spotFoodImage" class="spotlight-food-image" src="" alt="Featured restaurant food" fetchpriority="high">
                            <div class="spotlight-logo-overlay" id="spotLogoOverlay">
                                <img id="spotLogo" src="" alt="Restaurant logo">
                            </div>
                        </div>
                        <div class="spotlight-content">
                            <div class="spotlight-text">
                                <h3 id="spotName">Loading...</h3>
                                <p id="spotDesc">Loading restaurant details...</p>
                                <div class="rating" id="spotRating">‚≠ê ...</div>
                            </div>
                            <div class="spotlight-actions">
                                <button class="btn-outline" id="spotlightViewBtn" style="padding:8px 16px; font-size:13px">View Details</button>
                            </div>
                        </div>
                    </div>
                    <div class="slide-indicators" id="slideIndicators"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Container -->
    <main>
        <!-- Featured Restaurants -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2>Featured Restaurants</h2>
                    <p class="section-subtitle">Handpicked selections based on quality and authenticity</p>
                </div>
                <a href="restraunts.html" class="view-all">View All <span>‚Üí</span></a>
            </div>
            
            <div class="filter-bar" id="filterBar">
                <!-- Filters will be populated dynamically -->
            </div>
            
            <div class="slider-container">
                <div id="featuredSlider" class="slider-grid skeleton-grid">
                    <!-- Skeleton loading -->
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                </div>
            </div>
            
            <div class="load-more-container">
                <button class="load-more-btn" onclick="location.href='restraunts.html'">
                    <i class="fas fa-arrow-right"></i>
                    View All Restaurants
                </button>
            </div>
        </section>

        <!-- Nearby Restaurants -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2>Nearby Restaurants</h2>
                    <p class="section-subtitle">Great food close to you</p>
                </div>
            </div>
            
            <div class="slider-container">
                <div id="nearbySlider" class="slider-grid skeleton-grid">
                    <!-- Skeleton loading -->
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                </div>
            </div>
            
            <div class="load-more-container">
                <button class="load-more-btn" onclick="location.href='restraunts.html'">
                    <i class="fas fa-arrow-right"></i>
                    View All Restaurants
                </button>
            </div>
        </section>

        <!-- REDESIGNED Restaurant of the Day -->
        <section class="section">
            <div class="restaurant-of-day">
                <div class="day-header">
                    <h2>Restaurant of the Day</h2>
                    <p>Our specially selected restaurant that stands out from the rest.</p>
                </div>
                <div class="day-card-container">
                    <div id="dayCard" class="day-card">
                        <div class="skeleton-card" style="width:100%; height:400px;">
                            <div class="skeleton-image" style="height:250px"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line" style="width: 70%"></div>
                                <div class="skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- App Download -->
        <section class="section">
            <div class="app-download">
                <h2>Get the Zo2y App</h2>
                <p>Discover restaurants, save your favorites, and share reviews on the go.</p>
                <div class="app-buttons">
                    <a href="#" class="app-button" id="iosAppButton">
                        <i class="fab fa-apple"></i>
                        <div class="app-button-text"><span>Download on the</span><br><span>App Store</span></div>
                    </a>
                    <a href="#" class="app-button" id="androidAppButton">
                        <i class="fab fa-google-play"></i>
                        <div class="app-button-text"><span>Get it on</span><br><span>Google Play</span></div>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>Explore</h3>
                <a href="restraunts.html">All Restaurants</a>
                <a href="categories.html">By Category</a>
                <a href="#" id="searchFooterLink">Search</a>
            </div>
            <div class="footer-column">
                <h3>Community</h3>
                <a href="blog.html">Food Blog</a>
                <a href="guides.html">Neighborhood Guides</a>
                <a href="#" id="featuredLink">Featured</a>
            </div>
            <div class="footer-column">
                <h3>Business</h3>
                <a href="add-restaurant.html">Add Your Restaurant</a>
                <a href="partners.html">Partnerships</a>
                <a href="contact.html">Contact Us</a>
            </div>
            <div class="footer-column">
                <h3>Support</h3>
                <a href="about.html">About Zo2y</a>
                <a href="help.html">Help Center</a>
                <a href="terms.html">Terms & Privacy</a>
            </div>
        </div>
        <div class="footer-bottom">
            <div style="margin-bottom:8px">¬© 2025 Zo2y ‚Äî Built with ‚ù§Ô∏è for food lovers</div>
            <div style="font-size:12px; color:var(--muted)">Join thousands discovering authentic dining experiences</div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="actionsModal" class="actions-modal">
        <div class="actions-content">
            <div class="actions-header">
                <h3 id="modalRestaurantName">Restaurant Name</h3>
                <p>Add this restaurant to your lists</p>
            </div>
            <div class="action-buttons">
                <button class="action-btn-modal" data-action="favorites" id="modalFavoritesBtn">
                    <i class="fas fa-heart"></i>
                    <span id="favoritesText">Add to Favorites</span>
                </button>
                <button class="action-btn-modal" data-action="wantToGo" id="modalWantToGoBtn">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="wantToGoText">Want to Go</span>
                </button>
                <button class="action-btn-modal" data-action="visited" id="modalVisitedBtn">
                    <i class="fas fa-utensils"></i>
                    <span id="visitedText">Mark as Visited</span>
                </button>
                <button class="action-btn-modal custom-lists-btn" id="modalCustomListsBtn">
                    <i class="fas fa-list"></i>
                    <span>Custom Lists</span>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="cancel-btn" id="modalCancelBtn">Cancel</button>
        </div>
    </div>

    <div id="customListsModal" class="custom-lists-modal">
        <div class="custom-lists-content">
            <div class="lists-header">
                <h3><i class="fas fa-list"></i> Custom Lists</h3>
                <button class="close-lists-btn" id="closeListsBtn">√ó</button>
            </div>
            
            <div class="lists-list-container" id="listsListContainer">
                <!-- Lists will be populated here -->
            </div>
            
            <div class="new-list-section">
                <div class="new-list-input">
                    <input type="text" id="newListName" placeholder="Enter new list name..." maxlength="50">
                    <button class="create-list-btn" id="createListBtn">
                        <i class="fas fa-plus"></i> Create
                    </button>
                </div>
                <div class="lists-actions">
                    <button class="lists-save-btn" id="saveListsBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="authPromptModal" class="auth-prompt-modal">
        <div class="auth-prompt-content">
            <div class="auth-prompt-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="auth-prompt-header">
                <h3>Sign In Required</h3>
                <p>You need to be signed in to save restaurants to your lists. Create an account to save your favorites, mark places you want to visit, and track where you've been!</p>
            </div>
            <div class="auth-prompt-buttons">
                <button class="auth-prompt-btn auth-prompt-primary" id="authPromptSignupBtn">
                    <i class="fas fa-user-plus"></i>
                    Create Free Account
                </button>
                <button class="auth-prompt-btn auth-prompt-secondary" id="authPromptLoginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In to Existing Account
                </button>
            </div>
            <button class="auth-prompt-close" id="authPromptCloseBtn">Maybe Later</button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <script>
        (function() {
            'use strict';
            
            // ---------- CONFIG ----------
            const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
            
            // Initialize Supabase with proper auth settings
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    flowType: 'pkce',
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: true
                }
            });
            
            let currentUser = null;
            
            // ---------- GLOBAL STATE ----------
            const state = {
                restaurants: [],
                categories: new Map(),
                cloudKitchens: new Set(),
                currentModalRestaurant: null,
                isLoggedIn: false,
                customLists: [],
                selectedLists: new Set(),
                restaurantImages: new Map(),
                spotlightIndex: 0,
                spotlightRestaurants: [],
                spotlightInterval: null,
                allRestaurants: [],
                imageObserver: null,
                searchResults: [],
                searchDebounceTimer: null,
                selectedSearchIndex: -1,
                isMobileSearchOpen: false,
                restaurantOfTheDay: null
            };
            
            // ---------- ‚úÖ FIXED AUTH MANAGEMENT ----------
            async function initializeAuth() {
                console.log('üîê Initializing auth...');
                
                try {
                    // Check for existing session
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    if (sessionError) {
                        console.error('Session error:', sessionError);
                        setGuestState();
                        return;
                    }
                    
                    if (session?.user) {
                        console.log('‚úÖ User found in session:', session.user.email);
                        currentUser = session.user;
                        state.isLoggedIn = true;
                        
                        // Load or create user profile
                        await ensureUserProfile(currentUser);
                        
                        // Set logged in UI
                        setLoggedInState(currentUser);
                        
                        // Initialize user features
                        await initUserFeatures();
                    } else {
                        console.log('No active session, setting guest state');
                        setGuestState();
                    }
                    
                } catch (error) {
                    console.error('Auth initialization error:', error);
                    setGuestState();
                }
            }
            
            async function ensureUserProfile(user) {
                try {
                    console.log('üîç Checking/creating profile for user:', user.id);
                    
                    // Check if profile exists
                    const { data: profile, error: profileError } = await supabase
                        .from('user_profiles')
                        .select('*')
                        .eq('id', user.id)
                        .single();
                    
                    if (profileError && profileError.code === 'PGRST116') {
                        // Profile doesn't exist, create it
                        console.log('üìù Creating new profile for user...');
                        
                        const userData = user.user_metadata || {};
                        const username = userData.full_name || 
                                        userData.name || 
                                        user.email?.split('@')[0] || 
                                        'User';
                        
                        const { data: newProfile, error: createError } = await supabase
                            .from('user_profiles')
                            .insert([
                                {
                                    id: user.id,
                                    username: username,
                                    full_name: userData.full_name || userData.name || username,
                                    avatar_url: userData.avatar_url || userData.picture || null,
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString(),
                                    is_private: false,
                                    visited_count: 0,
                                    favorites_count: 0,
                                    followers_count: 0,
                                    following_count: 0
                                }
                            ])
                            .select()
                            .single();
                        
                        if (createError) {
                            console.error('Error creating profile:', createError);
                            return null;
                        }
                        
                        console.log('‚úÖ Profile created successfully');
                        return newProfile;
                    } else if (profileError) {
                        console.error('Error checking profile:', profileError);
                        return null;
                    }
                    
                    console.log('‚úÖ Profile exists:', profile.username);
                    return profile;
                    
                } catch (error) {
                    console.error('Error ensuring user profile:', error);
                    return null;
                }
            }
            
            // ---------- ‚úÖ FIXED AUTH STATE LISTENER ----------
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log('üîÑ Auth state change:', event);
                
                if (event === 'SIGNED_OUT') {
                    console.log('User signed out');
                    currentUser = null;
                    state.isLoggedIn = false;
                    setGuestState();
                    guestBanner.show();
                    
                    // Clear user-specific data
                    state.selectedLists.clear();
                    
                    // Re-render without user data
                    renderFeaturedRestaurants();
                    renderNearbyRestaurants();
                    updateSpotlight();
                    setupRestaurantOfTheDay();
                    
                } else if (event === 'SIGNED_IN' && session?.user) {
                    console.log('‚úÖ User signed in:', session.user.email);
                    
                    currentUser = session.user;
                    state.isLoggedIn = true;
                    
                    // Ensure profile exists
                    await ensureUserProfile(currentUser);
                    
                    // Update UI
                    setLoggedInState(currentUser);
                    
                    // Initialize user features
                    await initUserFeatures();
                    
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('Token refreshed');
                    // Session is still valid
                }
            });
            
            // ---------- HELPER FUNCTIONS ----------
            function setLoggedInState(user) {
                try {
                    let displayName = 'User';
                    const userData = user.user_metadata || {};
                    
                    displayName = userData.full_name || 
                                 userData.name || 
                                 user.email?.split('@')[0] || 
                                 'User';
                    
                    // Update account button
                    const authBtn = document.getElementById('userAccountBtn');
                    if (authBtn) {
                        authBtn.innerHTML = `<i class="fas fa-user"></i><span>${displayName}</span>`;
                        authBtn.onclick = () => {
                            window.location.href = 'profile.html';
                        };
                    }
                    
                    // Show logged-in button, hide start journey button
                    const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                    const loggedInBtn = document.querySelector('.btn-primary.logged-in');
                    if (startJourneyBtn) startJourneyBtn.style.display = 'none';
                    if (loggedInBtn) loggedInBtn.style.display = 'flex';
                    
                    // Hide guest banner
                    guestBanner.hide();
                    
                } catch (error) {
                    console.error('Error setting logged in state:', error);
                    // Fallback to guest state
                    setGuestState();
                }
            }
            
            function setGuestState() {
                // Update account button
                const authBtn = document.getElementById('userAccountBtn');
                if (authBtn) {
                    authBtn.innerHTML = `<i class="fas fa-user"></i><span>Account</span>`;
                    authBtn.onclick = () => {
                        window.location.href = 'login.html';
                    };
                }
                
                // Show start journey button, hide logged-in button
                const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                const loggedInBtn = document.querySelector('.btn-primary.logged-in');
                if (startJourneyBtn) startJourneyBtn.style.display = 'flex';
                if (loggedInBtn) loggedInBtn.style.display = 'none';
                
                // Show guest banner
                guestBanner.show();
            }
            
            // ---------- ‚úÖ FIXED RESTAURANT DATA LOADING ----------
            async function loadRestaurantsData() {
                console.log('üçΩÔ∏è Loading restaurant data...');
                try {
                    // Load cloud kitchens first
                    await loadCloudKitchens();
                    
                    // Load restaurant images
                    await loadRestaurantImages();
                    
                    // Load restaurants with categories
                    const { data, error } = await supabase
                        .from('restraunts')
                        .select(`
                            id, 
                            slug, 
                            name, 
                            category,
                            description, 
                            rating, 
                            logo_url, 
                            image
                        `)
                        .order('rating', { ascending: false })
                        .limit(48);
                    
                    if (error) {
                        console.warn('Error loading restaurants:', error);
                        showNotification('Failed to load restaurants', 'error');
                        return;
                    }
                    
                    if (!data || data.length === 0) {
                        console.warn('No restaurants found');
                        showNotification('No restaurants available', 'info');
                        return;
                    }
                    
                    console.log(`‚úÖ Loaded ${data.length} restaurants`);
                    
                    // Transform restaurant data
                    state.restaurants = data.map(restaurant => ({
                        id: restaurant.id,
                        slug: restaurant.slug,
                        name: restaurant.name,
                        category: restaurant.category || 'Restaurant',
                        description: restaurant.description,
                        rating: restaurant.rating,
                        logo_url: restaurant.logo_url,
                        coverImage: getCoverImageUrl(restaurant.slug) || restaurant.image,
                        isCloudKitchen: state.cloudKitchens.has(restaurant.id)
                    }));
                    
                    // Now render everything
                    renderFeaturedRestaurants();
                    renderNearbyRestaurants();
                    setupSpotlight();
                    setupRestaurantOfTheDay();
                    populateFilters();
                    
                } catch (error) {
                    console.error('Error loading restaurants:', error);
                    showNotification('Failed to load restaurants', 'error');
                }
            }
            
            async function loadCloudKitchens() {
                try {
                    const { data: cloudKitchens, error } = await supabase
                        .from('cloud_kitchens')
                        .select('restaurant_id');
                    
                    if (error) {
                        console.warn('Error loading cloud kitchens:', error);
                        return;
                    }
                    
                    if (cloudKitchens && cloudKitchens.length > 0) {
                        state.cloudKitchens.clear();
                        cloudKitchens.forEach(ck => {
                            state.cloudKitchens.add(ck.restaurant_id);
                        });
                        console.log(`‚úÖ Loaded ${cloudKitchens.length} cloud kitchens`);
                    }
                } catch (error) {
                    console.error('Error loading cloud kitchens:', error);
                }
            }
            
            async function loadRestaurantImages() {
                try {
                    const { data: galleryData, error: galleryError } = await supabase
                        .from('restaurant_gallery')
                        .select('restaurant_slug, image_url, image_type, is_primary')
                        .order('sort_order');
                    
                    if (!galleryError && galleryData) {
                        galleryData.forEach(item => {
                            if (!state.restaurantImages.has(item.restaurant_slug)) {
                                state.restaurantImages.set(item.restaurant_slug, {
                                    cover: null,
                                    logo: null
                                });
                            }
                            
                            const images = state.restaurantImages.get(item.restaurant_slug);
                            
                            if (item.image_type === 'cover' && item.image_url) {
                                images.cover = item.image_url;
                            }
                            
                            if (item.image_type === 'logo' && item.image_url) {
                                images.logo = item.image_url;
                            }
                        });
                    }
                    
                    // Also get images from restaurants table
                    const { data: restaurantsData } = await supabase
                        .from('restraunts')
                        .select('slug, image, logo_url');
                    
                    if (restaurantsData) {
                        restaurantsData.forEach(restaurant => {
                            if (!state.restaurantImages.has(restaurant.slug)) {
                                state.restaurantImages.set(restaurant.slug, {
                                    cover: restaurant.image || null,
                                    logo: restaurant.logo_url || null
                                });
                            } else {
                                const images = state.restaurantImages.get(restaurant.slug);
                                if (!images.cover && restaurant.image) {
                                    images.cover = restaurant.image;
                                }
                                if (!images.logo && restaurant.logo_url) {
                                    images.logo = restaurant.logo_url;
                                }
                            }
                        });
                    }
                    
                    console.log(`‚úÖ Loaded images for ${state.restaurantImages.size} restaurants`);
                    
                } catch (error) {
                    console.error('Error loading images:', error);
                }
            }
            
            function getCoverImageUrl(restaurantSlug) {
                const images = state.restaurantImages.get(restaurantSlug);
                return images?.cover || null;
            }
            
            function getLogoUrl(restaurant) {
                const images = state.restaurantImages.get(restaurant.slug);
                if (images?.logo) {
                    return images.logo;
                }
                
                if (restaurant.logo_url) {
                    return restaurant.logo_url;
                }
                
                if (restaurant.image) {
                    return restaurant.image;
                }
                
                return null;
            }
            
            // ---------- ‚úÖ FIXED SPOTLIGHT FUNCTIONS ----------
            function setupSpotlight() {
                if (state.restaurants.length === 0) {
                    console.log('No restaurants for spotlight');
                    return;
                }
                
                // Take top 6 rated restaurants for spotlight
                state.spotlightRestaurants = [...state.restaurants]
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 6);
                
                console.log('Spotlight restaurants loaded:', state.spotlightRestaurants.length);
                
                updateSpotlight();
                startSpotlightRotation();
            }
            
            function updateSpotlight() {
                if (!state.spotlightRestaurants.length) {
                    console.log('No spotlight restaurants available');
                    return;
                }
                
                const restaurant = state.spotlightRestaurants[state.spotlightIndex];
                console.log('Updating spotlight to:', restaurant.name);
                
                // Update spotlight content
                document.getElementById('spotName').textContent = restaurant.name;
                document.getElementById('spotDesc').textContent = restaurant.description || 'Delicious food served with care';
                document.getElementById('spotRating').innerHTML = `‚≠ê ${(restaurant.rating || 0).toFixed(1)}`;
                
                // Update images
                const foodImage = document.getElementById('spotFoodImage');
                const logoImage = document.getElementById('spotLogo');
                const logoOverlay = document.getElementById('spotLogoOverlay');
                
                // Clear previous images
                foodImage.src = '';
                foodImage.classList.remove('loaded');
                logoImage.src = '';
                logoImage.classList.remove('loaded');
                
                // Load new images
                if (restaurant.coverImage) {
                    foodImage.dataset.src = restaurant.coverImage;
                    foodImage.onload = () => {
                        foodImage.classList.add('loaded');
                        console.log('Food image loaded');
                    };
                    foodImage.onerror = () => {
                        console.log('Failed to load food image');
                        foodImage.style.display = 'none';
                    };
                    foodImage.src = restaurant.coverImage;
                } else {
                    foodImage.style.display = 'none';
                }
                
                const logoUrl = getLogoUrl(restaurant);
                if (logoUrl) {
                    logoOverlay.style.display = 'flex';
                    logoImage.dataset.src = logoUrl;
                    logoImage.onload = () => {
                        logoImage.classList.add('loaded');
                        console.log('Logo loaded');
                    };
                    logoImage.onerror = () => {
                        console.log('Failed to load logo');
                        logoOverlay.style.display = 'none';
                    };
                    logoImage.src = logoUrl;
                } else {
                    logoOverlay.style.display = 'none';
                }
                
                // Update click handlers
                const spotlightViewBtn = document.getElementById('spotlightViewBtn');
                if (spotlightViewBtn) {
                    spotlightViewBtn.onclick = () => {
                        location.href = `restaurant.html?slug=${restaurant.slug}`;
                    };
                }
                
                const spotlightCard = document.getElementById('spotlightCard');
                if (spotlightCard) {
                    spotlightCard.onclick = () => {
                        location.href = `restaurant.html?slug=${restaurant.slug}`;
                    };
                }
                
                // Update dots
                const indicators = document.getElementById('slideIndicators');
                if (indicators) {
                    indicators.innerHTML = state.spotlightRestaurants.map((_, i) => 
                        `<div class="slide-indicator ${i === state.spotlightIndex ? 'active' : ''}" data-index="${i}"></div>`
                    ).join('');
                    
                    indicators.querySelectorAll('.slide-indicator').forEach((dot, i) => {
                        dot.onclick = (e) => { 
                            e.stopPropagation(); 
                            state.spotlightIndex = i; 
                            updateSpotlight(); 
                            resetSpotlightInterval(); 
                        };
                    });
                }
            }
            
            function startSpotlightRotation() {
                resetSpotlightInterval();
                
                if (state.spotlightRestaurants.length > 1) {
                    state.spotlightInterval = setInterval(() => {
                        state.spotlightIndex = (state.spotlightIndex + 1) % state.spotlightRestaurants.length;
                        console.log('Rotating spotlight to index:', state.spotlightIndex);
                        updateSpotlight();
                    }, 5000);
                }
                
                // Pause on hover
                const spotlightCard = document.getElementById('spotlightCard');
                if (spotlightCard) {
                    spotlightCard.onmouseenter = () => {
                        if (state.spotlightInterval) {
                            clearInterval(state.spotlightInterval);
                            state.spotlightInterval = null;
                            console.log('Spotlight rotation paused');
                        }
                    };
                    spotlightCard.onmouseleave = resetSpotlightInterval;
                }
            }
            
            function resetSpotlightInterval() {
                if (state.spotlightInterval) {
                    clearInterval(state.spotlightInterval);
                    state.spotlightInterval = null;
                }
                
                if (state.spotlightRestaurants.length > 1) {
                    state.spotlightInterval = setInterval(() => {
                        state.spotlightIndex = (state.spotlightIndex + 1) % state.spotlightRestaurants.length;
                        console.log('Rotating spotlight to index:', state.spotlightIndex);
                        updateSpotlight();
                    }, 5000);
                }
            }
            
            // ---------- ‚úÖ FIXED IMAGE LOADING ----------
            function initImageLoader() {
                if (state.imageObserver) return;
                
                state.imageObserver = new IntersectionObserver((entries, observer) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            if (img.dataset.src) {
                                img.src = img.dataset.src;
                                img.classList.add('loaded');
                                observer.unobserve(img);
                            }
                        }
                    });
                }, {
                    rootMargin: '100px 0px',
                    threshold: 0.01
                });
                
                // Observe initial images
                setTimeout(() => {
                    const images = document.querySelectorAll('img[data-src]');
                    images.forEach(img => {
                        if (!img.classList.contains('observed')) {
                            state.imageObserver.observe(img);
                            img.classList.add('observed');
                        }
                    });
                }, 100);
            }
            
            // ---------- ‚úÖ FIXED RESTAURANT CARD CREATION ----------
            function createRestaurantCard(restaurant) {
                const card = document.createElement('div');
                card.className = 'restaurant-card';
                card.dataset.id = restaurant.id;
                
                const rating = restaurant.rating || 0;
                const categoryIcon = getCategoryIconFallback(restaurant.category);
                const category = restaurant.category || 'Restaurant';
                const logoUrl = getLogoUrl(restaurant);
                const hasCoverImage = restaurant.coverImage && restaurant.coverImage !== '';
                const isCloudKitchen = restaurant.isCloudKitchen || false;
                
                // Get list status if logged in
                let listBadges = '';
                if (state.isLoggedIn && listManager) {
                    const status = listManager.getRestaurantListStatus(restaurant.id);
                    
                    if (status.favorites) {
                        listBadges += `
                            <div class="list-badge">
                                ‚ù§Ô∏è
                                <div class="list-badge-tooltip">Favorited</div>
                            </div>
                        `;
                    }
                    
                    if (status.wantToGo) {
                        listBadges += `
                            <div class="list-badge">
                                üìç
                                <div class="list-badge-tooltip">Want to go to</div>
                            </div>
                        `;
                    }
                    
                    if (status.visited) {
                        listBadges += `
                            <div class="list-badge">
                                ‚úì
                                <div class="list-badge-tooltip">Visited</div>
                            </div>
                        `;
                    }
                }
                
                // Create cloud badge if needed
                const cloudBadge = isCloudKitchen ? `
                    <div class="cloud-badge" aria-label="Cloud Kitchen">
                        <i class="fas fa-cloud"></i>
                        <div class="cloud-tooltip">
                            Cloud Kitchen
                        </div>
                    </div>
                ` : '';
                
                card.innerHTML = `
                    <a href="restaurant.html?slug=${restaurant.slug}" class="card-link">
                        <div class="card-image">
                            ${hasCoverImage ? `
                                <img class="restaurant-image" 
                                     data-src="${restaurant.coverImage}" 
                                     alt="${restaurant.name}" 
                                     width="300" 
                                     height="200">
                            ` : ''}
                            ${logoUrl ? `
                                <div class="logo-overlay">
                                    <img data-src="${logoUrl}" 
                                         alt="${restaurant.name} logo" 
                                         width="48" 
                                         height="48">
                                </div>
                            ` : ''}
                            
                            ${listBadges ? `<div class="list-badges-container">${listBadges}</div>` : ''}
                            
                            ${cloudBadge}
                            
                            <div class="menu-btn-container">
                                <button class="menu-btn" aria-label="Restaurant actions">
                                    <i class="fas fa-ellipsis-h"></i>
                                    <div class="menu-btn-tooltip">Save to lists</div>
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-title-wrapper">
                                    <h3 class="card-title">${restaurant.name}</h3>
                                </div>
                                <div class="card-rating">
                                    <i class="fas fa-star"></i>
                                    ${rating.toFixed(1)}
                                </div>
                            </div>
                            <div class="card-category">
                                <span>${categoryIcon}</span>
                                ${category}
                            </div>
                            <p class="card-description">${restaurant.description || 'Delicious food served with care'}</p>
                            <div class="card-footer">
                                <div class="card-location">Click to view details</div>
                            </div>
                        </div>
                    </a>
                `;
                
                const menuBtn = card.querySelector('.menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal({
                            id: restaurant.id,
                            name: restaurant.name,
                            slug: restaurant.slug
                        });
                    });
                }
                
                return card;
            }
            
            function getCategoryIconFallback(categoryName) {
                const icons = {
                    'Burgers': 'üçî',
                    'Chicken': 'üçó',
                    'Middle Eastern': 'ü•ô',
                    'Pizza': 'üçï',
                    'Asian': 'üçú',
                    'Mexican': 'üåÆ',
                    'Cafe & Bakery': '‚òï',
                    'Fast Food': 'üçü',
                    'Seafood': 'üêü',
                    'Breakfast': 'ü•û',
                    'Desserts': 'üç∞',
                    'Indian': 'üçõ',
                    'BBQ & Ribs': 'ü•©',
                    'International': 'üåç'
                };
                
                return icons[categoryName] || 'üç¥';
            }
            
            // ---------- ‚úÖ FIXED RENDERING FUNCTIONS ----------
            function renderFeaturedRestaurants() {
                const grid = document.getElementById('featuredSlider');
                if (!grid) return;
                
                if (state.restaurants.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No restaurants found</div>';
                    return;
                }
                
                grid.classList.remove('skeleton-grid');
                
                const featured = state.restaurants.slice(0, 8);
                
                // Create document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                for (const restaurant of featured) {
                    const card = createRestaurantCard(restaurant);
                    fragment.appendChild(card);
                }
                
                grid.innerHTML = '';
                grid.appendChild(fragment);
                
                // Initialize IntersectionObserver for the new images
                if (state.imageObserver) {
                    setTimeout(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (!img.classList.contains('observed')) {
                                state.imageObserver.observe(img);
                                img.classList.add('observed');
                            }
                        });
                    }, 100);
                }
            }
            
            function renderNearbyRestaurants() {
                const grid = document.getElementById('nearbySlider');
                if (!grid) return;
                
                if (state.restaurants.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No restaurants found</div>';
                    return;
                }
                
                grid.classList.remove('skeleton-grid');
                
                const nearby = state.restaurants.slice(8, 16);
                
                // Create document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                for (const restaurant of nearby) {
                    const card = createRestaurantCard(restaurant);
                    fragment.appendChild(card);
                }
                
                grid.innerHTML = '';
                grid.appendChild(fragment);
                
                // Initialize IntersectionObserver for the new images
                if (state.imageObserver) {
                    setTimeout(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (!img.classList.contains('observed')) {
                                state.imageObserver.observe(img);
                                img.classList.add('observed');
                            }
                        });
                    }, 100);
                }
            }
            
            // ---------- ‚úÖ FIXED RESTAURANT OF THE DAY ----------
            async function setupRestaurantOfTheDay() {
                if (state.restaurants.length === 0) return;
                
                // Pick the highest rated restaurant
                const topRestaurants = [...state.restaurants]
                    .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                    .slice(0, 10);
                
                // Get today's date for consistent daily selection
                const today = new Date().getDate();
                const restaurantIndex = today % topRestaurants.length;
                const restaurant = topRestaurants[restaurantIndex];
                
                state.restaurantOfTheDay = restaurant;
                
                const categoryIcon = getCategoryIconFallback(restaurant.category);
                const isCloudKitchen = restaurant.isCloudKitchen || false;
                const cloudBadge = isCloudKitchen ? `
                    <div class="cloud-badge" aria-label="Cloud Kitchen" style="top: 70px; right: 56px;">
                        <i class="fas fa-cloud"></i>
                        <div class="cloud-tooltip">
                            Cloud Kitchen
                        </div>
                    </div>
                ` : '';
                
                // Get list status if logged in
                let listBadges = '';
                if (state.isLoggedIn && listManager) {
                    const status = listManager.getRestaurantListStatus(restaurant.id);
                    if (status.favorites) listBadges += `
                        <div class="list-badge" style="top: 70px;">
                            ‚ù§Ô∏è
                            <div class="list-badge-tooltip">Favorited</div>
                        </div>
                    `;
                    if (status.wantToGo) listBadges += `
                        <div class="list-badge" style="top: 70px; margin-top: 44px;">
                            üìç
                            <div class="list-badge-tooltip">Want to go to</div>
                        </div>
                    `;
                    if (status.visited) listBadges += `
                        <div class="list-badge" style="top: 70px; margin-top: 88px;">
                            ‚úì
                            <div class="list-badge-tooltip">Visited</div>
                        </div>
                    `;
                }
                
                const dayCard = document.getElementById('dayCard');
                dayCard.innerHTML = `
                    <div class="day-card-badge">Restaurant of the Day</div>
                    <div class="card-image">
                        ${restaurant.coverImage ? `
                            <img class="restaurant-image" 
                                 data-src="${restaurant.coverImage}" 
                                 alt="${restaurant.name}" 
                                 loading="lazy"
                                 style="height: 300px;">
                        ` : ''}
                        ${listBadges ? `<div class="list-badges-container">${listBadges}</div>` : ''}
                        ${cloudBadge}
                        ${restaurant.logo_url ? `
                            <div class="logo-overlay" style="bottom: 20px; left: 20px; width: 60px; height: 60px;">
                                <img data-src="${restaurant.logo_url}" 
                                     alt="${restaurant.name} logo">
                            </div>
                        ` : ''}
                        <div class="menu-btn-container">
                            <button class="menu-btn" aria-label="Restaurant actions">
                                <i class="fas fa-ellipsis-h"></i>
                                <div class="menu-btn-tooltip">Save to lists</div>
                            </button>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-header">
                            <div class="card-title-wrapper">
                                <h3 class="card-title">${restaurant.name}</h3>
                            </div>
                            <div class="card-rating" style="padding: 8px 16px; font-size: 16px;">
                                <i class="fas fa-star"></i>
                                ${(restaurant.rating || 0).toFixed(1)}
                            </div>
                        </div>
                        <div class="card-category" style="font-size: 16px; margin-bottom: 20px;">
                            <span>${categoryIcon}</span>
                            ${restaurant.category || 'Restaurant'}
                        </div>
                        <p class="card-description" style="font-size: 16px; line-height: 1.6; margin-bottom: 30px; -webkit-line-clamp: 3; color: #c3d1e8;">
                            ${restaurant.description || 'Delicious food served with care'}
                        </p>
                        
                        <div class="day-card-stats">
                            <div class="day-stat">
                                <div class="day-stat-value">${(restaurant.rating || 0).toFixed(1)}</div>
                                <div class="day-stat-label">Rating</div>
                            </div>
                            <div class="day-stat">
                                <div class="day-stat-value">${categoryIcon}</div>
                                <div class="day-stat-label">Category</div>
                            </div>
                            <div class="day-stat">
                                <div class="day-stat-value">${isCloudKitchen ? '‚òÅÔ∏è' : 'üè†'}</div>
                                <div class="day-stat-label">${isCloudKitchen ? 'Cloud Kitchen' : 'Restaurant'}</div>
                            </div>
                        </div>
                        
                        <div class="day-card-actions">
                            <button class="day-card-btn day-card-btn-primary" onclick="location.href='restaurant.html?slug=${restaurant.slug}'">
                                <i class="fas fa-external-link-alt"></i>
                                View Restaurant
                            </button>
                            <button class="day-card-btn day-card-btn-outline" id="dayCardSaveBtn">
                                <i class="fas fa-bookmark"></i>
                                Save to Lists
                            </button>
                        </div>
                    </div>
                `;
                
                // Load images
                const mainImage = dayCard.querySelector('.restaurant-image');
                if (mainImage && mainImage.dataset.src) {
                    mainImage.src = mainImage.dataset.src;
                    mainImage.onload = () => mainImage.classList.add('loaded');
                }
                
                const logoImage = dayCard.querySelector('.logo-overlay img');
                if (logoImage && logoImage.dataset.src) {
                    logoImage.src = logoImage.dataset.src;
                    logoImage.onload = () => logoImage.classList.add('loaded');
                }
                
                // Attach save button event
                const saveBtn = dayCard.querySelector('#dayCardSaveBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showModal(restaurant);
                    });
                }
                
                // Attach menu button event
                const menuBtn = dayCard.querySelector('.menu-btn');
                if (menuBtn) {
                    menuBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showModal(restaurant);
                    });
                }
                
                // Card click event
                dayCard.onclick = (e) => {
                    // Only navigate if not clicking on the save button or menu button
                    if (!e.target.closest('.day-card-btn-outline') && !e.target.closest('.menu-btn')) {
                        location.href = `restaurant.html?slug=${restaurant.slug}`;
                    }
                };
            }
            
            // ---------- FILTER FUNCTIONS ----------
            function populateFilters() {
                const filterBar = document.getElementById('filterBar');
                if (!filterBar) return;
                
                // Get unique categories from first 8 restaurants
                const categories = [...new Set(state.restaurants.slice(0, 8).map(r => r.category).filter(Boolean))];
                
                let filterHTML = `<div class="filter-btn active" data-filter="all">All</div>`;
                
                categories.slice(0, 5).forEach(category => {
                    filterHTML += `<div class="filter-btn" data-filter="${category}">${category}</div>`;
                });
                
                filterHTML += `<div class="filter-btn" data-filter="top-rated">Top Rated</div>`;
                
                filterBar.innerHTML = filterHTML;
                
                // Add event listeners
                filterBar.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        filterBar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        filterFeaturedRestaurants(this.dataset.filter);
                    });
                });
            }
            
            function filterFeaturedRestaurants(filter) {
                let filtered = state.restaurants.slice(0, 8);
                
                if (filter === 'top-rated') {
                    filtered = filtered.filter(r => (r.rating || 0) >= 4.5);
                } else if (filter !== 'all') {
                    filtered = filtered.filter(r => r.category === filter);
                }
                
                const grid = document.getElementById('featuredSlider');
                if (!grid) return;
                
                // Create document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                for (const restaurant of filtered) {
                    const card = createRestaurantCard(restaurant);
                    fragment.appendChild(card);
                }
                
                grid.innerHTML = '';
                grid.appendChild(fragment);
                
                // Initialize IntersectionObserver for the new images
                if (state.imageObserver) {
                    setTimeout(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (!img.classList.contains('observed')) {
                                state.imageObserver.observe(img);
                                img.classList.add('observed');
                            }
                        });
                    }, 100);
                }
            }
            
            // ---------- LIST MANAGER ----------
            const listManager = {
                userLists: [],
                currentLists: {
                    favorites: null,
                    visited: null,
                    wantToGo: null
                },
                
                async init() { 
                    if (!state.isLoggedIn) return;
                    
                    await this.loadUserLists();
                },
                
                async loadUserLists() {
                    try {
                        if (!currentUser) return;

                        const { data: lists, error } = await supabase
                            .from('lists')
                            .select('*')
                            .eq('user_id', currentUser.id);
                        
                        if (error) throw error;
                        
                        this.userLists = lists || [];
                        await this.setupDefaultLists();
                        await this.loadListRestaurants();
                        
                    } catch (error) {
                        console.error('Error loading lists:', error);
                    }
                },
                
                async setupDefaultLists() {
                    if (!currentUser) return;
                    
                    this.currentLists.favorites = this.userLists.find(list => list.title === 'Favorites');
                    this.currentLists.visited = this.userLists.find(list => list.title === 'Visited'); 
                    this.currentLists.wantToGo = this.userLists.find(list => list.title === 'Want to Go');
                    
                    if (!this.currentLists.favorites) {
                        this.currentLists.favorites = await this.createList('Favorites', 'My favorite restaurants');
                    }
                    if (!this.currentLists.visited) {
                        this.currentLists.visited = await this.createList('Visited', 'Restaurants I have visited');
                    }
                    if (!this.currentLists.wantToGo) {
                        this.currentLists.wantToGo = await this.createList('Want to Go', 'Restaurants I want to try');
                    }
                },
                
                async createList(title, description) {
                    if (!currentUser) return null;
                    
                    const { data: newList, error } = await supabase
                        .from('lists')
                        .insert([
                            {
                                user_id: currentUser.id,
                                title: title,
                                description: description
                            }
                        ])
                        .select()
                        .single();
                    
                    if (error) {
                        console.error('Error creating list:', error);
                        return null;
                    }
                    
                    this.userLists.push(newList);
                    return newList;
                },
                
                async loadListRestaurants() {
                    for (const listType in this.currentLists) {
                        const list = this.currentLists[listType];
                        if (list) {
                            const { data: listRestaurants, error } = await supabase
                                .from('lists_restraunts')
                                .select('restraunt_id')
                                .eq('list_id', list.id);
                            
                            if (!error && listRestaurants) {
                                list.restaurants = listRestaurants.map(item => item.restraunt_id);
                            } else {
                                list.restaurants = [];
                            }
                        }
                    }
                },
                
                async toggleInList(listType, restaurantId) {
                    const list = this.currentLists[listType];
                    if (!list) return false;
                    
                    const isInList = list.restaurants?.includes(restaurantId);
                    
                    try {
                        if (isInList) {
                            const { error } = await supabase
                                .from('lists_restraunts')
                                .delete()
                                .match({
                                    list_id: list.id,
                                    restraunt_id: restaurantId
                                });
                            
                            if (error) throw error;
                            
                            list.restaurants = list.restaurants.filter(id => id !== restaurantId);
                            showNotification(`Removed from ${list.title}`, 'info');
                            return false;
                            
                        } else {
                            const { error } = await supabase
                                .from('lists_restraunts')
                                .insert([
                                    {
                                        list_id: list.id,
                                        restraunt_id: restaurantId,
                                        added_at: new Date().toISOString()
                                    }
                                ]);
                            
                            if (error) throw error;
                            
                            if (!list.restaurants) list.restaurants = [];
                            list.restaurants.push(restaurantId);
                            showNotification(`Added to ${list.title}`, 'success');
                            return true;
                        }
                        
                    } catch (error) {
                        console.error('Error updating list:', error);
                        showNotification('Failed to update list', 'error');
                        return isInList;
                    }
                },
                
                isInList(listType, restaurantId) {
                    const list = this.currentLists[listType];
                    return list?.restaurants?.includes(restaurantId) || false;
                },
                
                getRestaurantListStatus(restaurantId) {
                    if (!state.isLoggedIn) {
                        return {
                            favorites: false,
                            wantToGo: false,
                            visited: false
                        };
                    }
                    
                    return {
                        favorites: this.isInList('favorites', restaurantId),
                        wantToGo: this.isInList('wantToGo', restaurantId),
                        visited: this.isInList('visited', restaurantId)
                    };
                }
            };
            
            // ---------- MODAL FUNCTIONS ----------
            function showModal(restaurantData) {
                if (!restaurantData) return;
                
                if (!state.isLoggedIn) {
                    showAuthPrompt();
                    return;
                }
                
                state.currentModalRestaurant = restaurantData;
                document.getElementById('modalRestaurantName').textContent = restaurantData.name;
                
                updateModalButtons(restaurantData.id);
                
                const modal = document.getElementById('actionsModal');
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            function hideModal() {
                const modal = document.getElementById('actionsModal');
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
            }
            
            function updateModalButtons(restaurantId) {
                const status = listManager.getRestaurantListStatus(restaurantId);
                
                const favoritesBtn = document.getElementById('modalFavoritesBtn');
                const wantToGoBtn = document.getElementById('modalWantToGoBtn');
                const visitedBtn = document.getElementById('modalVisitedBtn');
                
                if (favoritesBtn) {
                    favoritesBtn.innerHTML = `<i class="fas fa-heart"></i><span>${status.favorites ? 'Remove from Favorites' : 'Add to Favorites'}</span>`;
                    favoritesBtn.classList.toggle('active', status.favorites);
                }
                
                if (wantToGoBtn) {
                    wantToGoBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${status.wantToGo ? 'Remove from Want to Go' : 'Add to Want to Go'}</span>`;
                    wantToGoBtn.classList.toggle('active', status.wantToGo);
                }
                
                if (visitedBtn) {
                    visitedBtn.innerHTML = `<i class="fas fa-utensils"></i><span>${status.visited ? 'Remove from Visited' : 'Mark as Visited'}</span>`;
                    visitedBtn.classList.toggle('active', status.visited);
                }
            }
            
            // ---------- NOTIFICATION SYSTEM ----------
            function showNotification(message, type = "info", duration = 2500) {
                const container = document.getElementById("notificationContainer");
                if (!container) return;
                
                const notification = document.createElement("div");
                notification.className = `custom-notification notification-${type}`;
                
                let iconClass;
                if (type === "success") {
                    iconClass = "fas fa-check-circle";
                } else if (type === "error") {
                    iconClass = "fas fa-exclamation-circle";
                } else if (type === "warning") {
                    iconClass = "fas fa-exclamation-triangle";
                } else {
                    iconClass = "fas fa-info-circle";
                }
                
                notification.innerHTML = `
                    <i class="notification-icon ${iconClass}"></i>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" aria-label="Close notification">√ó</button>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add("notification-show");
                }, 10);
                
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.classList.remove("notification-show");
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                });
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.classList.remove("notification-show");
                        setTimeout(() => notification.remove(), 400);
                    }
                }, duration);
            }
            
            // ---------- GUEST BANNER ----------
            const guestBanner = {
                init: function() {
                    const loginBtn = document.getElementById('bannerLoginBtn');
                    const signupBtn = document.getElementById('bannerSignupBtn');
                    
                    if (loginBtn) {
                        loginBtn.addEventListener('click', () => {
                            window.location.href = 'login.html';
                        });
                    }
                    
                    if (signupBtn) {
                        signupBtn.addEventListener('click', () => {
                            window.location.href = 'sign-up.html';
                        });
                    }
                },
                
                show: function() {
                    const banner = document.getElementById('guestBanner');
                    if (banner) banner.classList.add('show');
                },
                
                hide: function() {
                    const banner = document.getElementById('guestBanner');
                    if (banner) banner.classList.remove('show');
                }
            };
            
            // ---------- AUTH PROMPT ----------
            function showAuthPrompt() {
                const modal = document.getElementById('authPromptModal');
                if (modal) modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }
            
            // ---------- INITIALIZE USER FEATURES ----------
            async function initUserFeatures() {
                if (!currentUser) return;
                
                try {
                    await listManager.init();
                    
                    // Re-render with user data
                    renderFeaturedRestaurants();
                    renderNearbyRestaurants();
                    updateSpotlight();
                    setupRestaurantOfTheDay();
                    
                } catch (error) {
                    console.error('Error initializing user features:', error);
                }
            }
            
            // ---------- EVENT LISTENERS ----------
            function setupEventListeners() {
                // Mobile search toggle
                const mobileSearchToggle = document.getElementById('mobileSearchToggle');
                if (mobileSearchToggle) {
                    mobileSearchToggle.addEventListener('click', () => {
                        const searchWrapper = document.getElementById('searchWrapper');
                        if (searchWrapper) {
                            searchWrapper.classList.toggle('active');
                        }
                    });
                }
                
                // Start journey button (for logged out users)
                const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                if (startJourneyBtn) {
                    startJourneyBtn.addEventListener('click', () => {
                        window.location.href = 'sign-up.html';
                    });
                }
                
                // Footer search link
                const searchFooterLink = document.getElementById('searchFooterLink');
                if (searchFooterLink) {
                    searchFooterLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const searchInput = document.getElementById('search');
                        if (searchInput) {
                            searchInput.focus();
                        }
                    });
                }
                
                // App download buttons
                const iosAppButton = document.getElementById('iosAppButton');
                const androidAppButton = document.getElementById('androidAppButton');
                
                if (iosAppButton) {
                    iosAppButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        showNotification('Zo2y iOS app coming soon!', 'info');
                    });
                }
                
                if (androidAppButton) {
                    androidAppButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        showNotification('Zo2y Android app coming soon!', 'info');
                    });
                }
                
                // Banner buttons
                guestBanner.init();
                
                // Modal buttons
                const modalFavoritesBtn = document.getElementById('modalFavoritesBtn');
                const modalWantToGoBtn = document.getElementById('modalWantToGoBtn');
                const modalVisitedBtn = document.getElementById('modalVisitedBtn');
                const modalCustomListsBtn = document.getElementById('modalCustomListsBtn');
                const modalCancelBtn = document.getElementById('modalCancelBtn');
                
                if (modalFavoritesBtn) {
                    modalFavoritesBtn.addEventListener('click', async () => {
                        if (!state.currentModalRestaurant) return;
                        await listManager.toggleInList('favorites', state.currentModalRestaurant.id);
                        updateModalButtons(state.currentModalRestaurant.id);
                        renderFeaturedRestaurants();
                        renderNearbyRestaurants();
                        updateSpotlight();
                        setupRestaurantOfTheDay();
                        hideModal();
                    });
                }
                
                if (modalWantToGoBtn) {
                    modalWantToGoBtn.addEventListener('click', async () => {
                        if (!state.currentModalRestaurant) return;
                        await listManager.toggleInList('wantToGo', state.currentModalRestaurant.id);
                        updateModalButtons(state.currentModalRestaurant.id);
                        renderFeaturedRestaurants();
                        renderNearbyRestaurants();
                        updateSpotlight();
                        setupRestaurantOfTheDay();
                        hideModal();
                    });
                }
                
                if (modalVisitedBtn) {
                    modalVisitedBtn.addEventListener('click', async () => {
                        if (!state.currentModalRestaurant) return;
                        await listManager.toggleInList('visited', state.currentModalRestaurant.id);
                        updateModalButtons(state.currentModalRestaurant.id);
                        renderFeaturedRestaurants();
                        renderNearbyRestaurants();
                        updateSpotlight();
                        setupRestaurantOfTheDay();
                        hideModal();
                    });
                }
                
                if (modalCustomListsBtn) {
                    modalCustomListsBtn.addEventListener('click', () => {
                        if (!state.currentModalRestaurant) {
                            showNotification('No restaurant selected', 'error');
                            return;
                        }
                        
                        hideModal();
                        
                        setTimeout(() => {
                            showNotification('Custom lists feature coming soon!', 'info');
                        }, 100);
                    });
                }
                
                if (modalCancelBtn) {
                    modalCancelBtn.addEventListener('click', hideModal);
                }
                
                // Scroll effect for header
                window.addEventListener('scroll', () => {
                    const nav = document.querySelector('.nav');
                    if (window.scrollY > 10) {
                        nav.classList.add('scrolled');
                    } else {
                        nav.classList.remove('scrolled');
                    }
                });
            }
            
            // ---------- INITIALIZATION ----------
            async function init() {
                console.log('üöÄ Initializing homepage...');
                
                // Initialize image loader first
                initImageLoader();
                
                // Setup event listeners
                setupEventListeners();
                
                // Initialize guest banner
                guestBanner.init();
                
                // Initialize auth
                await initializeAuth();
                
                // Load restaurant data
                await loadRestaurantsData();
                
                // Force observe images after everything loads
                setTimeout(() => {
                    if (state.imageObserver) {
                        const images = document.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (!img.classList.contains('observed')) {
                                state.imageObserver.observe(img);
                                img.classList.add('observed');
                            }
                        });
                    }
                }, 500);
            }
            
            // Start initialization
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();
    </script>
</body>
</html>