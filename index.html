<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Zo2y - Home</title>
  <meta name="description" content="Zo2y universal homepage for restaurants, movies, TV shows, games, and books." />
  <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="js/list-utils.js" defer></script>
  <script src="js/universal-search.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg: #0b1633;
      --bg-2: #0f1d40;
      --card: #132347;
      --card-2: #172b58;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --white: #ffffff;
      --border: rgba(255,255,255,0.12);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --surface: rgba(12, 26, 57, 0.84);
      --shadow: 0 12px 34px rgba(0,0,0,0.28);
      --ok: #10b981;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      min-height: 100%;
      background:
        radial-gradient(circle at 18% -8%, rgba(245, 158, 11, 0.16), transparent 35%),
        radial-gradient(circle at 85% -12%, rgba(88, 130, 255, 0.22), transparent 42%),
        var(--bg);
      color: var(--white);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
    }

    body {
      padding-bottom: 18px;
    }

    a { color: inherit; text-decoration: none; }

    .container {
      width: min(1240px, calc(100% - 28px));
      margin: 0 auto;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px) saturate(180%);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }

    .header-inner {
      min-height: 72px;
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      flex-wrap: wrap;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 22px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }

    .brand img {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      object-fit: cover;
    }

    .search-wrap {
      flex: 1;
      min-width: 210px;
      max-width: 420px;
      position: relative;
      margin-left: 8px;
    }

    .search-wrap i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 13px;
    }

    .search {
      width: 100%;
      height: 42px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      padding: 0 14px 0 34px;
      outline: none;
    }

    .search:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.14);
    }

    .header-actions {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .top-nav {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      opacity: 0.92;
    }

    .nav-pill {
      border: 1px solid transparent;
      color: #e2ecff;
      background: transparent;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      padding: 8px 10px;
      transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
    }

    .nav-pill:hover {
      border-color: var(--border);
      color: var(--accent);
      background: rgba(255,255,255,0.04);
    }

    .auth-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      height: 40px;
      padding: 0 14px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: border-color 0.2s ease, transform 0.2s ease;
    }

    .btn:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .btn-primary {
      background: var(--gradient);
      color: #0b1633;
      border: 0;
    }

    .page-shell {
      margin-top: 18px;
      display: grid;
      gap: 18px;
    }

    .spotlight {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 24px;
      overflow: hidden;
      min-height: 360px;
      box-shadow: var(--shadow);
      background: linear-gradient(145deg, #132347, #0f1f43);
      isolation: isolate;
    }

    .spotlight-bg {
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, #12203e 0%, #1b2f61 48%, #243b77 100%);
      background-size: cover;
      background-position: center;
      transition: background-image 0.22s ease;
      z-index: -2;
    }

    .spotlight::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      background:
        linear-gradient(100deg, rgba(6, 13, 28, 0.9) 0%, rgba(8, 16, 35, 0.7) 42%, rgba(13, 25, 52, 0.25) 100%),
        radial-gradient(circle at 80% 22%, rgba(245, 158, 11, 0.24), transparent 40%);
    }

    .spotlight-inner {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: clamp(18px, 3.6vw, 34px);
      min-height: 360px;
      justify-content: flex-end;
      max-width: calc(100% - 290px);
      position: relative;
      z-index: 2;
    }

    .spotlight-media {
      position: absolute;
      right: 22px;
      top: 50%;
      transform: translateY(-50%);
      width: clamp(184px, 22vw, 240px);
      aspect-ratio: 2/3;
      border-radius: 14px;
      overflow: hidden;
      border: 0;
      background: transparent;
      z-index: 1;
      box-shadow: none;
    }

    .spotlight-media img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: transparent;
    }

    .spotlight.has-square-media .spotlight-inner {
      max-width: calc(100% - 232px);
    }

    .spotlight.has-landscape-media .spotlight-inner {
      max-width: calc(100% - 292px);
    }

    .spotlight-media.square {
      width: clamp(154px, 18vw, 208px);
      aspect-ratio: 1/1;
      border-radius: 16px;
      padding: 0;
      background: transparent;
      display: block;
    }

    .spotlight-media.square img {
      border-radius: 12px;
      object-fit: contain !important;
      background: transparent;
      width: 100%;
      height: 100%;
      padding: 0;
    }

    .spotlight-media.landscape {
      width: clamp(224px, 30vw, 320px);
      aspect-ratio: 16/10;
      border-radius: 16px;
      padding: 0;
      background: transparent;
    }

    .spotlight-media.landscape img {
      object-fit: contain !important;
      background: transparent;
    }

    .spotlight.no-media .spotlight-inner {
      max-width: 760px;
    }

    .spotlight-kicker {
      text-transform: uppercase;
      letter-spacing: 1.1px;
      color: #cfe0ff;
      font-size: 12px;
      font-weight: 700;
      opacity: 0.92;
    }

    .spotlight-title {
      font-size: clamp(31px, 5.2vw, 57px);
      line-height: 1.03;
      letter-spacing: -0.4px;
    }

    .spotlight-summary {
      color: #d7e4ff;
      font-size: 15px;
      line-height: 1.45;
      max-width: 640px;
    }

    .spotlight-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 2px;
    }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.08);
      color: #d9e7ff;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .spotlight-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }

    .spotlight-dots {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      margin-top: 2px;
    }

    .spotlight-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 0;
      background: rgba(255,255,255,0.36);
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .spotlight-dot.active {
      background: var(--accent);
      transform: scale(1.2);
    }

    .status {
      font-size: 12px;
      color: var(--ok);
      margin-top: 3px;
      display: none;
    }

    .section {
      background: rgba(19, 35, 71, 0.9);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .section-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }

    .section-head h2 {
      font-size: 23px;
      margin-bottom: 3px;
      letter-spacing: -0.2px;
    }
    .section-head p { color: var(--muted); font-size: 13px; }

    .rail-wrap { padding: 14px 14px 16px; }

    .rail-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 15px;
      font-weight: 700;
    }

    .rail-title a {
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
    }

    .rail {
      display: grid;
      grid-auto-flow: column;
      grid-auto-columns: 156px;
      gap: 11px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 6px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .rail.unified-rail { grid-auto-columns: 156px; }
    .rail::-webkit-scrollbar { height: 7px; }
    .rail::-webkit-scrollbar-thumb { background: rgba(140,163,199,0.55); border-radius: 999px; }
    .rail.games-rail { grid-auto-columns: 156px; }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      overflow: hidden;
      background: var(--card-2);
      scroll-snap-align: start;
      min-height: 232px;
      position: relative;
      transition: border-color 0.2s ease, transform 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .card.menu-open,
    .card.menu-open:hover {
      transform: none;
    }

    .card-media {
      width: 100%;
      aspect-ratio: 2/3;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
      display: grid;
      place-items: center;
      color: var(--muted);
      overflow: hidden;
      position: relative;
    }

    .card-media img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transform: scale(1.001);
    }

    .card-media.landscape { aspect-ratio: 16/10; }

    .card-media.landscape img {
      object-fit: cover;
    }

    .card-media.game-poster {
      aspect-ratio: 2/3;
      padding: 0;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
    }

    .card-media.music-cover {
      aspect-ratio: 1/1;
      padding: 0;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
    }

    .card-media.music-cover img {
      object-fit: cover;
      border-radius: 0;
      background: transparent;
    }

    .card-media.game-poster img {
      object-fit: cover;
      border-radius: 0;
    }

    .card-media.landscape.game-poster img {
      object-fit: cover;
    }

    .card-media.restaurant-composite {
      position: relative;
      display: block;
      background: linear-gradient(135deg, #1a2d5f 0%, #0b1633 100%);
    }

    .card-media.restaurant-composite .restaurant-cover {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .restaurant-logo-badge {
      position: absolute;
      right: 8px;
      bottom: 8px;
      width: 42px;
      height: 42px;
      border-radius: 10px;
      background: rgba(11, 22, 51, 0.92);
      border: 1px solid rgba(245, 158, 11, 0.75);
      padding: 4px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }

    .card-media .restaurant-logo-badge img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      border-radius: 7px;
    }

    .card-meta {
      padding: 9px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      flex: 1;
    }

    .card-meta-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 2px;
    }

    .card-type {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: #dbe7ff;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 999px;
      padding: 3px 8px;
      margin-bottom: 3px;
      width: fit-content;
    }

    .card-name {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 36px;
      margin-bottom: 0;
    }

    .card-sub {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-height: 17px;
    }

    .card-extra {
      margin-top: 4px;
      color: #a9b9da;
      font-size: 12px;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      min-height: 32px;
    }

    .card-extra.placeholder {
      visibility: hidden;
    }

    .rail.unified-rail .card {
      height: 332px;
      min-height: 332px;
    }

    .rail.unified-rail .card-media {
      aspect-ratio: 2/3;
      height: 216px;
      padding: 0;
    }

    .rail.unified-rail .card-media img {
      object-fit: contain;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
    }

    .rail.unified-rail .card-media.restaurant-composite {
      aspect-ratio: 2/3;
    }

    .rail.unified-rail .card-media.restaurant-composite .restaurant-cover {
      object-fit: cover;
    }

    .rail.unified-rail .card-media.game-poster {
      aspect-ratio: 2/3;
      height: 216px;
      padding: 0;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
    }

    .rail.unified-rail .card-media.game-poster img {
      object-fit: cover;
      border-radius: 0;
    }

    .rail.unified-rail .card-media.music-cover img {
      object-fit: cover;
      background: transparent;
    }

    .rail.games-rail .card {
      height: 332px;
      min-height: 332px;
      display: flex;
      flex-direction: column;
    }

    .rail.games-rail .card-meta {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .rail.games-rail .card-media.game-poster {
      aspect-ratio: 2/3;
      height: 216px;
      padding: 0;
      background: linear-gradient(135deg, #0e1f42 0%, #0c1a3b 100%);
    }

    .rail.games-rail .card-media.game-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 0;
      background: transparent;
    }

    .card-menu-wrap {
      position: relative;
      flex-shrink: 0;
    }

    .card-menu-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(19, 35, 71, 0.92);
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .card-menu-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .card-open-link {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(19, 35, 71, 0.92);
      color: #d4e2ff;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .rail-menu {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(94vw, 400px);
      border-radius: 14px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 12px;
      display: none;
      z-index: 3300;
    }

    .rail-menu.open {
      display: block;
    }

    .rail-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      z-index: 3290;
      display: none;
    }

    .rail-menu-backdrop.active {
      display: block;
    }

    .rail-menu-item {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 11px;
      padding: 10px 12px;
      font-size: 13px;
      text-align: left;
      cursor: pointer;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .rail-menu-item:last-child {
      margin-bottom: 0;
    }

    .rail-menu-item:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .rail-menu-item[data-saved="1"] {
      border-color: rgba(248, 113, 113, 0.85);
      background: rgba(239, 68, 68, 0.12);
      color: #fecaca;
    }

    .rail-menu-item[data-saved="1"]:hover {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.18);
      color: #fecaca;
    }

    .rail-menu-item[data-saved="1"] .rail-menu-state {
      color: #fca5a5;
      opacity: 1;
    }

    .rail-menu-title {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 2px 2px 10px;
    }

    .rail-menu-item-main {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .rail-menu-state {
      color: var(--white);
      opacity: 0.9;
      font-weight: 600;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(6, 12, 28, 0.72);
      z-index: 240;
      padding: 16px;
    }

    .modal.active { display: flex; }

    .modal-content {
      width: min(420px, 100%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 700;
    }

    .modal-close {
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 22px;
      cursor: pointer;
    }

    .modal-list {
      display: grid;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
      padding: 6px 0;
    }

    .modal-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
    }

    .modal-list-item.active {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }

    .modal-list-actions {
      display: inline-flex;
      gap: 6px;
      align-items: center;
      color: var(--muted);
      font-size: 12px;
    }

    .list-edit-btn {
      border: 0;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }

    .list-edit-btn:hover { color: var(--accent); }

    .modal-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-input input {
      flex: 1;
      height: 38px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-2);
      color: var(--white);
      padding: 0 10px;
    }

    .icon-options {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .icon-option {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card-2);
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: border-color 0.2s ease, color 0.2s ease;
    }

    .icon-option.selected {
      border-color: var(--accent);
      color: var(--accent);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    .card-hover-cue {
      position: absolute;
      right: 8px;
      top: 8px;
      z-index: 8;
      border: 1px solid rgba(245, 158, 11, 0.45);
      background: rgba(11, 22, 51, 0.88);
      color: var(--accent);
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      opacity: 0;
      transform: translateY(-3px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }

    .card:hover .card-hover-cue {
      opacity: 1;
      transform: translateY(0);
    }

    .empty {
      border: 1px dashed var(--border);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      border-radius: 12px;
      text-align: center;
      padding: 22px 10px;
      font-size: 13px;
      width: min(92vw, 240px);
    }

    .mobile-bottom-nav {
      display: none;
    }

    .spotlight-fade {
      animation: spotlightFade 0.32s ease;
    }

    @keyframes spotlightFade {
      from { opacity: 0.45; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 1100px) {
      .top-nav {
        flex-wrap: wrap;
        justify-content: flex-end;
      }
    }

    @media (max-width: 860px) {
      .top-nav {
        display: none;
      }
      .header-actions {
        margin-left: auto;
      }
    }

    @media (max-width: 760px) {
      body {
        padding-bottom: 86px;
      }

      .container { width: calc(100% - 16px); }
      .header-inner { gap: 10px; }
      .brand { font-size: 18px; }
      .brand img { width: 31px; height: 31px; }
      .search-wrap { order: 3; max-width: none; margin-left: 0; width: 100%; }
      .header-actions { margin-left: auto; }
      .auth-actions .btn {
        height: 36px;
        padding: 0 10px;
        border-radius: 11px;
      }
      #profileBtn span {
        display: none;
      }

      .spotlight { border-radius: 18px; min-height: 332px; }
      .spotlight-media {
        right: 12px;
        top: 12px;
        transform: none;
        width: 96px;
        aspect-ratio: 2/3;
        margin: 0;
        border-radius: 12px;
      }
      .spotlight-inner {
        min-height: 332px;
        max-width: none;
        padding: 14px 16px 16px;
        padding-right: 120px;
        gap: 9px;
      }
      .spotlight.no-media .spotlight-inner {
        padding-right: 16px;
      }

      .spotlight.has-square-media .spotlight-inner {
        padding-right: 112px;
      }

      .spotlight.has-landscape-media .spotlight-inner {
        padding-right: 16px;
        padding-top: 118px;
      }

      .spotlight-media.square {
        width: 88px;
        aspect-ratio: 1/1;
        padding: 0;
        border-radius: 12px;
        background: transparent;
      }

      .spotlight-media.square img {
        width: 100%;
        height: 100%;
        object-fit: contain !important;
        padding: 0;
        border-radius: 12px;
        background: transparent;
      }

      .spotlight-media.landscape {
        width: min(46vw, 184px);
        max-width: 184px;
        height: auto;
        aspect-ratio: 16/9;
        right: 12px;
        left: auto;
        top: 12px;
        border-radius: 12px;
        padding: 0;
        background: transparent;
      }

      .spotlight-media.landscape img {
        object-fit: contain !important;
        width: 100%;
        height: 100%;
        background: transparent;
      }

      .spotlight.has-landscape-media .spotlight-title {
        font-size: clamp(20px, 6vw, 32px);
      }

      .spotlight.has-landscape-media .spotlight-summary {
        font-size: 12px;
        -webkit-line-clamp: 2;
      }

      .spotlight-title {
        font-size: clamp(24px, 8vw, 38px);
      }

      .spotlight-summary {
        font-size: 13px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .spotlight-meta {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        width: 100%;
      }

      .spotlight-meta .chip {
        display: flex;
        width: 100%;
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
        max-width: none;
        font-size: 11px;
        line-height: 1.25;
        padding: 7px 9px;
        align-items: flex-start;
        gap: 7px;
      }

      .spotlight-meta .chip i {
        flex-shrink: 0;
        margin-top: 1px;
      }

      .spotlight-actions {
        gap: 8px;
      }

      .section { border-radius: 16px; }
      .section-head h2 { font-size: 19px; }
      .rail { grid-auto-columns: 142px; }
      .rail.unified-rail { grid-auto-columns: 142px; }
      .rail.games-rail { grid-auto-columns: 142px; }
      .card { min-height: 232px; }
      .card-hover-cue { display: none; }

      .rail.unified-rail .card {
        height: 314px;
        min-height: 314px;
      }

      .rail.unified-rail .card-media {
        height: 190px;
        aspect-ratio: 2/3;
      }

      .rail.unified-rail .card-media.game-poster {
        height: 190px;
        aspect-ratio: 2/3;
        padding: 0;
      }

      .rail.unified-rail .card-media.game-poster img {
        object-fit: cover;
        border-radius: 0;
      }

      .rail.unified-rail .card-media.music-cover img {
        object-fit: cover;
      }

      .rail.games-rail .card {
        height: 314px;
        min-height: 314px;
      }

      .rail.games-rail .card-media.game-poster {
        height: 190px;
        aspect-ratio: 2/3;
        padding: 0;
      }

      .rail.games-rail .card-media.game-poster img {
        object-fit: cover;
        border-radius: 0;
      }

      .rail.unified-rail .card-media.restaurant-composite {
        aspect-ratio: 2/3;
      }

      #restaurantsRail .card-media.restaurant-composite {
        aspect-ratio: 16/10;
      }

      #restaurantsRail .restaurant-logo-badge {
        width: 36px;
        height: 36px;
        right: 7px;
        bottom: 7px;
        border-radius: 9px;
      }

      .mobile-bottom-nav {
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        border: 1px solid var(--border);
        border-radius: 18px;
        background: rgba(12, 24, 52, 0.95);
        backdrop-filter: blur(12px);
        box-shadow: 0 10px 34px rgba(0,0,0,0.35);
        z-index: 230;
        padding: 6px;
      }

      .mobile-nav-item {
        min-height: 48px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #c8d7f6;
        font-size: 18px;
        transition: color 0.2s ease, background 0.2s ease;
      }

      .mobile-nav-item.active,
      .mobile-nav-item:hover {
        color: var(--accent);
        background: rgba(245, 158, 11, 0.16);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container header-inner">
      <a class="brand" href="index.html">
        <img src="images/logo.png" alt="Zo2y" />
        <span>Zo2y</span>
      </a>

      <div class="search-wrap">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input class="search" id="globalSearch" placeholder="Search all media..." />
      </div>

      <div class="header-actions">
        <nav class="top-nav" aria-label="Browse media">
          <a class="nav-pill" href="movies.html">Movies</a>
          <a class="nav-pill" href="tvshows.html">TV</a>
          <a class="nav-pill" href="games.html">Games</a>
          <a class="nav-pill" href="books.html">Books</a>
          <a class="nav-pill" href="music.html">Music</a>
          <a class="nav-pill" href="restraunts.html">Restaurants</a>
        </nav>
        <div class="auth-actions">
          <a class="btn" href="login.html" id="loginBtn">Login</a>
          <a class="btn btn-primary" href="sign-up.html" id="signupBtn">Sign Up</a>
          <a class="btn" href="profile.html" id="profileBtn" style="display:none;">Profile</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container page-shell">
    <section class="spotlight" id="spotlightSection">
      <div class="spotlight-bg" id="spotlightBackground"></div>
      <div class="spotlight-media" id="spotlightMedia">
        <img id="spotlightImage" alt="Spotlight artwork" loading="eager" fetchpriority="high" />
      </div>
      <div class="spotlight-inner" id="spotlightInner">
        <p class="spotlight-kicker" id="spotlightKicker">Live Spotlight</p>
        <h1 class="spotlight-title" id="spotlightTitle">Loading spotlight...</h1>
        <p class="spotlight-summary" id="spotlightSummary">Pulling trends and personalization signals.</p>
        <div class="spotlight-meta">
          <span class="chip" id="spotlightReason"><i class="fa-solid fa-compass"></i> Discovery engine warming up</span>
          <span class="chip" id="spotlightTrend"><i class="fa-solid fa-bolt"></i> Global buzz sync</span>
        </div>
        <div class="spotlight-actions">
          <a class="btn btn-primary" href="movies.html" id="spotlightOpenBtn"><i class="fa-solid fa-play"></i> Open</a>
          <button class="btn" id="spotlightNextBtn" type="button"><i class="fa-solid fa-forward"></i> Next Pulse</button>
        </div>
        <div class="spotlight-dots" id="spotlightDots" aria-label="Spotlight items"></div>
        <div class="status" id="loadStatus">Loading live feed...</div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>Culture Stream</h2>
        <p>One swipeable feed blending movies, TV, games, books, music, and restaurants.</p>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-wave-square"></i> Mixed for you</span><a href="profile.html">Tune taste</a></div>
        <div class="rail unified-rail" id="unifiedRail"></div>
      </div>
    </section>

    <section class="section">
      <div class="section-head">
        <h2>Trending by Category</h2>
        <p>Dive into a lane when you want focused browsing.</p>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-utensils"></i> Restaurants</span><a href="restraunts.html">View all</a></div>
        <div class="rail" id="restaurantsRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-film"></i> Movies</span><a href="movies.html">View all</a></div>
        <div class="rail" id="moviesRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-tv"></i> TV Shows</span><a href="tvshows.html">View all</a></div>
        <div class="rail" id="tvRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-gamepad"></i> Games</span><a href="games.html">View all</a></div>
        <div class="rail" id="gamesRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-book"></i> Books</span><a href="books.html">View all</a></div>
        <div class="rail" id="booksRail"></div>
      </div>

      <div class="rail-wrap">
        <div class="rail-title"><span><i class="fa-solid fa-music"></i> Music</span><a href="music.html">View all</a></div>
        <div class="rail" id="musicRail"></div>
      </div>

    </section>
  </main>

  <nav class="mobile-bottom-nav" aria-label="Mobile sections">
    <a class="mobile-nav-item active" href="index.html" aria-label="Home"><i class="fa-solid fa-house"></i></a>
    <a class="mobile-nav-item" href="movies.html" aria-label="Movies"><i class="fa-solid fa-film"></i></a>
    <a class="mobile-nav-item" href="tvshows.html" aria-label="TV Shows"><i class="fa-solid fa-tv"></i></a>
    <a class="mobile-nav-item" href="games.html" aria-label="Games"><i class="fa-solid fa-gamepad"></i></a>
    <a class="mobile-nav-item" href="books.html" aria-label="Books"><i class="fa-solid fa-book"></i></a>
    <a class="mobile-nav-item" href="music.html" aria-label="Music"><i class="fa-solid fa-music"></i></a>
    <a class="mobile-nav-item" href="restraunts.html" aria-label="Restaurants"><i class="fa-solid fa-utensils"></i></a>
  </nav>

  <div class="modal" id="homeListsModal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="homeListsTitle">Custom Lists</div>
        <button class="modal-close" id="closeHomeListsBtn" aria-label="Close">&times;</button>
      </div>
      <div class="modal-list" id="homeListsContainer"></div>
      <div class="modal-input">
        <input type="text" id="newHomeListName" placeholder="New list name..." maxlength="50">
        <button class="btn" id="createHomeListBtn">Create</button>
      </div>
      <div class="icon-options" id="homeListIconOptions">
        <button class="icon-option selected" data-icon="fas fa-list" aria-label="List"><i class="fas fa-list"></i></button>
        <button class="icon-option" data-icon="fas fa-film" aria-label="Movie"><i class="fas fa-film"></i></button>
        <button class="icon-option" data-icon="fas fa-tv" aria-label="TV"><i class="fas fa-tv"></i></button>
        <button class="icon-option" data-icon="fas fa-gamepad" aria-label="Game"><i class="fas fa-gamepad"></i></button>
        <button class="icon-option" data-icon="fas fa-book" aria-label="Book"><i class="fas fa-book"></i></button>
        <button class="icon-option" data-icon="fas fa-music" aria-label="Music"><i class="fas fa-music"></i></button>
        <button class="icon-option" data-icon="fas fa-heart" aria-label="Heart"><i class="fas fa-heart"></i></button>
        <button class="icon-option" data-icon="fas fa-star" aria-label="Star"><i class="fas fa-star"></i></button>
        <button class="icon-option" data-icon="fas fa-bookmark" aria-label="Bookmark"><i class="fas fa-bookmark"></i></button>
        <button class="icon-option" data-icon="fas fa-utensils" aria-label="Restaurant"><i class="fas fa-utensils"></i></button>
      </div>
      <div class="modal-actions">
        <button class="btn" id="saveHomeListsBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <script src="js/igdb-client.js"></script>
  <script>
    const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
    const TMDB_TOKEN = 'eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI4NzVjMDM5N2IxZGUxYzU3NjQ4ZmRiNjJiZGQ5NmI0OSIsIm5iZiI6MTc3MDU4Mzk1NC42NTc5OTk4LCJzdWIiOiI2OTg4Zjc5MmFlYTFkN2NjNjcyY2VlNDciLCJzY29wZXMiOlsiYXBpX3JlYWQiXSwidmVyc2lvbiI6MX0.1RMWLft0Yl73gfhkCXtnqBIzRQHdaoLfZFYXYN7jm7s';
    const IGDB_PROXY_BASE = '/api/igdb';
    const GOOGLE_BOOKS_KEY = 'AIzaSyD6EFAseKNOjzkpEaY1fmJmZnleM9uJP8s';
    const TMDB_POSTER = 'https://image.tmdb.org/t/p/w500';
    const TMDB_SPOT_POSTER = 'https://image.tmdb.org/t/p/w780';
    const TMDB_BACKDROP = 'https://image.tmdb.org/t/p/w1280';
    const FALLBACK_RESTAURANTS = [
      { id: 'fallback-r1', name: 'Top Rated Picks', category: 'Community', rating: '4.8' },
      { id: 'fallback-r2', name: 'Most Saved', category: 'Trending', rating: '4.7' },
      { id: 'fallback-r3', name: 'Local Favorites', category: 'Local', rating: '4.9' },
      { id: 'fallback-r4', name: 'Date Night', category: 'Curated', rating: '4.7' },
      { id: 'fallback-r5', name: 'Quick Bites', category: 'Casual', rating: '4.6' }
    ];
    const FALLBACK_BOOKS = [
      { title: 'Atomic Habits', author: 'James Clear', isbn: '9780735211292' },
      { title: 'The Alchemist', author: 'Paulo Coelho', isbn: '9780061122415' },
      { title: 'The Silent Patient', author: 'Alex Michaelides', isbn: '9781250316776' },
      { title: 'Sapiens', author: 'Yuval Noah Harari', isbn: '9780062316097' },
      { title: 'The Hobbit', author: 'J.R.R. Tolkien', isbn: '9780261103344' },
      { title: "Harry Potter and the Sorcerer's Stone", author: 'J.K. Rowling', isbn: '9780590353427' },
      { title: 'To Kill a Mockingbird', author: 'Harper Lee', isbn: '9780061120084' },
      { title: 'The Great Gatsby', author: 'F. Scott Fitzgerald', isbn: '9780743273565' },
      { title: 'Thinking, Fast and Slow', author: 'Daniel Kahneman', isbn: '9780374533557' },
      { title: 'The Psychology of Money', author: 'Morgan Housel', isbn: '9780857197689' }
    ];
    const POPULAR_BOOK_QUERIES = [
      'new york times best sellers books',
      'popular fiction books',
      'classic novels everyone should read',
      'bestselling fantasy books',
      'bestselling mystery books'
    ];
    const POPULAR_MUSIC_QUERIES = [
      'global top hits',
      'viral pop tracks',
      'hip hop trending',
      'indie chill',
      'house dance hits',
      'rnb essentials'
    ];
    const HOME_MEDIA_META = {
      restaurant: { label: 'Restaurant', icon: 'fa-utensils', accent: '#f59e0b' },
      movie: { label: 'Movie', icon: 'fa-film', accent: '#ef4444' },
      tv: { label: 'TV', icon: 'fa-tv', accent: '#22c55e' },
      game: { label: 'Game', icon: 'fa-gamepad', accent: '#38bdf8' },
      book: { label: 'Book', icon: 'fa-book', accent: '#f97316' },
      music: { label: 'Music', icon: 'fa-music', accent: '#1db954' }
    };
    const HOME_RESTAURANT_LIST_META = {
      favorites: { title: 'Favorites', description: 'My favorite restaurants', icon: 'heart' },
      visited: { title: 'Visited', description: 'Places I have been to', icon: 'check' },
      wantToGo: { title: 'Want to Go', description: 'Places I want to try', icon: 'bookmark' }
    };
    const HOME_FEED_CACHE_KEY = 'zo2y_home_feed_cache_v2';
    const HOME_FEED_CACHE_MAX_AGE_MS = 1000 * 60 * 30;
    const HOME_CHANNEL_TIMEOUT_MS = 3800;
    const SPOTLIGHT_ROTATE_MS = 5000;
    const HOME_CHANNEL_TARGET_ITEMS = 24;
    const HOME_SPOTLIGHT_POOL_SIZE = 24;
    const HOME_ONBOARDING_VERSION = 'v1';

    async function homeIgdbFetch(path, params = {}) {
      if (window.ZO2Y_IGDB && typeof window.ZO2Y_IGDB.request === 'function') {
        return window.ZO2Y_IGDB.request(path, params);
      }
      const url = new URL(`${IGDB_PROXY_BASE}${path}`, window.location.origin);
      Object.entries(params || {}).forEach(([key, value]) => {
        if (value === undefined || value === null || value === '') return;
        url.searchParams.set(key, String(value));
      });
      const res = await fetch(url.toString());
      if (!res.ok) throw new Error(`IGDB error ${res.status}`);
      return res.json();
    }

    const statusEl = document.getElementById('loadStatus');
    let homeSupabaseClient = null;
    let homeCurrentUser = null;
    let homeAuthListenerReady = false;
    let homeSpotlightTimer = null;
    let homeSpotlightItems = [];
    let homeSpotlightIndex = 0;
    let homeSpotlightImageToken = 0;
    let homeOnboardingIndex = 0;
    let homeOnboardingUserId = null;
    let homeTasteWeights = {
      restaurant: 1,
      movie: 1,
      tv: 1,
      game: 1,
      book: 1,
      music: 1
    };
    const homeFeedState = {
      restaurant: [],
      movie: [],
      tv: [],
      game: [],
      book: [],
      music: []
    };
    const homeCustomListState = {
      mediaType: null,
      itemId: null,
      title: '',
      subtitle: '',
      image: '',
      customLists: [],
      selectedIcon: 'fas fa-list',
      selectedLists: new Set()
    };

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/\"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function toHttpsUrl(value) {
      return String(value || '').replace(/^http:\/\//i, 'https://');
    }

    function resolveRestaurantImage(value) {
      const raw = String(value || '').trim();
      if (!raw) return '';
      if (/^https?:\/\//i.test(raw)) return toHttpsUrl(raw);
      const normalized = raw.replace(/^\/+/, '');
      if (/^images\//i.test(normalized)) return toHttpsUrl(normalized);
      return toHttpsUrl(`images/${normalized}`);
    }

    function showHomeToast(message, isError = false) {
      const toast = document.createElement('div');
      toast.style.position = 'fixed';
      toast.style.top = '16px';
      toast.style.right = '16px';
      toast.style.zIndex = '99999';
      toast.style.background = isError ? '#dc2626' : '#10b981';
      toast.style.color = '#fff';
      toast.style.padding = '10px 14px';
      toast.style.borderRadius = '10px';
      toast.style.fontSize = '13px';
      toast.style.boxShadow = '0 10px 24px rgba(0,0,0,0.35)';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2200);
    }

    function getHomeMediaMeta(mediaType) {
      const type = String(mediaType || '').toLowerCase();
      return HOME_MEDIA_META[type] || { label: 'Item', icon: 'fa-star', accent: '#f59e0b' };
    }

    function supportsHomeLists(mediaType) {
      const type = String(mediaType || '').toLowerCase();
      return type === 'restaurant' || type === 'movie' || type === 'tv' || type === 'game' || type === 'book' || type === 'music';
    }

    function getMediaListConfig(mediaType) {
      const type = String(mediaType || '').toLowerCase();
      if (type === 'movie') {
        return {
          customHref: 'movies.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Watched', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Watchlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'tv') {
        return {
          customHref: 'tvshows.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Watched', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Watchlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'game') {
        return {
          customHref: 'games.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'watched', label: 'Played', icon: 'fas fa-eye' },
            { key: 'watchlist', label: 'Backlog', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'book') {
        return {
          customHref: 'books.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'read', label: 'Read', icon: 'fas fa-eye' },
            { key: 'readlist', label: 'Readlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'music') {
        return {
          customHref: 'music.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'listened', label: 'Listened', icon: 'fas fa-eye' },
            { key: 'listenlist', label: 'Listenlist', icon: 'fas fa-bookmark' }
          ]
        };
      }
      if (type === 'restaurant') {
        return {
          customHref: 'restraunts.html',
          rows: [
            { key: 'favorites', label: 'Favorites', icon: 'fas fa-heart' },
            { key: 'visited', label: 'Visited', icon: 'fas fa-eye' },
            { key: 'wantToGo', label: 'Want to Go', icon: 'fas fa-bookmark' }
          ]
        };
      }
      return null;
    }

    function buildRailListMenuHtml(item) {
      const cfg = getMediaListConfig(item.mediaType);
      if (!cfg) return '';
      const buttons = cfg.rows.map(row => `
        <button class="rail-menu-item" data-action="save" data-list="${row.key}">
          <span class="rail-menu-item-main"><i class="${row.icon}"></i> ${row.label}</span>
          <span class="rail-menu-state">Add</span>
        </button>
      `).join('');
      return `
        <div class="rail-menu-title">Add to list</div>
        ${buttons}
        <button class="rail-menu-item" data-action="custom" data-href="${cfg.customHref}">
          <span class="rail-menu-item-main"><i class="fas fa-list"></i> Custom Lists</span>
          <span class="rail-menu-state">Open</span>
        </button>
      `;
    }

    function getSpotlightSeedOffset() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const weekOfYear = Math.ceil(dayOfYear / 7);
      const userSeed = homeCurrentUser?.id ? homeCurrentUser.id.slice(-4).split('').reduce((sum, ch) => sum + ch.charCodeAt(0), 0) : 0;
      return dayOfYear + weekOfYear + userSeed;
    }

    function hashString(value) {
      const text = String(value || '');
      let hash = 0;
      for (let i = 0; i < text.length; i += 1) {
        hash = ((hash << 5) - hash + text.charCodeAt(i)) | 0;
      }
      return Math.abs(hash);
    }

    function getDailySignal(value) {
      const dateKey = new Date().toISOString().slice(0, 10);
      return (hashString(`${value}|${dateKey}`) % 100) / 100;
    }

    function getTrendLabel(item) {
      const buzz = Math.max(52, Math.min(99, Math.round((Number(item.discoveryScore) || 0.62) * 100)));
      return `<i class="fa-solid fa-fire"></i> Global buzz ${buzz}%`;
    }

    function getPersonalReason(item) {
      const type = String(item.mediaType || '').toLowerCase();
      const meta = getHomeMediaMeta(type);
      const weight = Number(homeTasteWeights[type] || 1);
      if (weight >= 1.45) {
        return `<i class="fa-solid fa-sparkles"></i> Tuned to your ${meta.label.toLowerCase()} taste`;
      }
      return `<i class="fa-solid fa-compass"></i> Cross-media discovery pick`;
    }

    function getSpotlightSummary(item) {
      const details = [item.subtitle, item.extra].map(v => String(v || '').trim()).filter(Boolean);
      if (!details.length) return 'Fresh signal from the live discovery engine.';
      return details.join(' | ');
    }

    function renderSpotlightDots() {
      const dotsEl = document.getElementById('spotlightDots');
      if (!dotsEl) return;
      dotsEl.innerHTML = homeSpotlightItems.map((item, index) => {
        const active = index === homeSpotlightIndex ? ' active' : '';
        const title = escapeHtml(item.title || '');
        return `<button class="spotlight-dot${active}" type="button" data-spotlight-index="${index}" aria-label="Spotlight ${index + 1}: ${title}"></button>`;
      }).join('');
      dotsEl.querySelectorAll('[data-spotlight-index]').forEach((btn) => {
        btn.addEventListener('click', () => {
          const idx = Number(btn.getAttribute('data-spotlight-index'));
          showSpotlightByIndex(idx, true);
          resetSpotlightTimer();
        });
      });
    }

    function renderSpotlightItem(item, shouldAnimate = false) {
      const bg = document.getElementById('spotlightBackground');
      const spotlightSection = document.getElementById('spotlightSection');
      const mediaWrap = document.getElementById('spotlightMedia');
      const mediaImage = document.getElementById('spotlightImage');
      const title = document.getElementById('spotlightTitle');
      const kicker = document.getElementById('spotlightKicker');
      const summary = document.getElementById('spotlightSummary');
      const reason = document.getElementById('spotlightReason');
      const trend = document.getElementById('spotlightTrend');
      const openBtn = document.getElementById('spotlightOpenBtn');
      const spotlightInner = document.getElementById('spotlightInner');
      if (!bg || !spotlightSection || !mediaWrap || !mediaImage || !title || !kicker || !summary || !reason || !trend || !openBtn) return;

      const meta = getHomeMediaMeta(item.mediaType);
      const spotlightBackground = String(item.spotlightImage || item.backgroundImage || item.image || '').trim();
      const spotlightMediaImage = String(item.spotlightMediaImage || item.image || item.spotlightImage || item.backgroundImage || '').trim();
      const spotlightMediaFit = String(item.spotlightMediaFit || '').trim() || 'contain';
      const spotlightMediaShape = String(item.spotlightMediaShape || '').trim() || 'poster';
      const usesSquareMedia = spotlightMediaShape === 'square';
      const usesLandscapeMedia = spotlightMediaShape === 'landscape';
      const mediaToken = ++homeSpotlightImageToken;

      spotlightSection.classList.remove('has-square-media', 'has-landscape-media');
      mediaWrap.classList.remove('square', 'landscape');
      if (usesLandscapeMedia) {
        spotlightSection.classList.add('has-landscape-media');
        mediaWrap.classList.add('landscape');
      } else if (usesSquareMedia) {
        spotlightSection.classList.add('has-square-media');
        mediaWrap.classList.add('square');
      }

      if (spotlightBackground) {
        bg.style.backgroundImage = `linear-gradient(120deg, rgba(8, 14, 31, 0.7), rgba(10, 19, 39, 0.42)), url("${spotlightBackground}")`;
      } else {
        bg.style.backgroundImage = 'linear-gradient(120deg, #12203e 0%, #1b2f61 48%, #243b77 100%)';
      }

      if (spotlightMediaImage) {
        mediaImage.loading = 'eager';
        mediaImage.fetchPriority = 'high';
        mediaImage.style.width = '';
        mediaImage.style.height = '';
        mediaImage.style.padding = '';
        mediaImage.style.borderRadius = '';
        mediaImage.style.background = '';
        mediaImage.style.objectFit = spotlightMediaFit;
        mediaImage.style.display = 'block';
        mediaWrap.style.display = 'block';
        spotlightSection.classList.remove('no-media');
        const fallbackCandidates = [
          spotlightMediaImage,
          item.fallbackImage,
          item.image,
          item.spotlightImage,
          item.backgroundImage
        ];
        if (String(item.mediaType || '').toLowerCase() === 'book') {
          fallbackCandidates.push(getBookCoverFallback(item));
        }
        setSpotlightImageWithFallback(mediaImage, fallbackCandidates, mediaToken);
      } else {
        if (mediaImage.__homeSpotlightOnLoad) {
          mediaImage.removeEventListener('load', mediaImage.__homeSpotlightOnLoad);
          mediaImage.__homeSpotlightOnLoad = null;
        }
        if (mediaImage.__homeSpotlightOnError) {
          mediaImage.removeEventListener('error', mediaImage.__homeSpotlightOnError);
          mediaImage.__homeSpotlightOnError = null;
        }
        mediaImage.removeAttribute('src');
        mediaImage.style.width = '';
        mediaImage.style.height = '';
        mediaImage.style.padding = '';
        mediaImage.style.borderRadius = '';
        mediaImage.style.background = '';
        mediaImage.style.objectFit = '';
        mediaWrap.style.display = 'none';
        spotlightSection.classList.remove('has-square-media');
        spotlightSection.classList.remove('has-landscape-media');
        mediaWrap.classList.remove('square');
        mediaWrap.classList.remove('landscape');
        spotlightSection.classList.add('no-media');
      }
      title.textContent = item.title || 'Spotlight';
      kicker.textContent = `${meta.label} Spotlight`;
      summary.textContent = getSpotlightSummary(item);
      reason.innerHTML = getPersonalReason(item);
      trend.innerHTML = getTrendLabel(item);
      openBtn.href = item.href || 'index.html';
      openBtn.onclick = null;

      if (shouldAnimate && spotlightInner) {
        spotlightInner.classList.remove('spotlight-fade');
        requestAnimationFrame(() => spotlightInner.classList.add('spotlight-fade'));
      }
      renderSpotlightDots();
    }

    function showSpotlightByIndex(index, shouldAnimate = false) {
      if (!homeSpotlightItems.length) return;
      const normalized = ((Number(index) || 0) % homeSpotlightItems.length + homeSpotlightItems.length) % homeSpotlightItems.length;
      homeSpotlightIndex = normalized;
      renderSpotlightItem(homeSpotlightItems[homeSpotlightIndex], shouldAnimate);
    }

    function resetSpotlightTimer(shouldStart = true) {
      if (homeSpotlightTimer) clearInterval(homeSpotlightTimer);
      homeSpotlightTimer = null;
      if (!shouldStart || homeSpotlightItems.length < 2) return;
      homeSpotlightTimer = window.setInterval(() => {
        showSpotlightByIndex(homeSpotlightIndex + 1, true);
      }, SPOTLIGHT_ROTATE_MS);
    }

    function buildScoredDiscoveryPool(feedMap) {
      const pool = [];
      Object.entries(feedMap).forEach(([type, items]) => {
        const list = Array.isArray(items) ? items : [];
        const weight = Number(homeTasteWeights[type] || 1);
        const maxRank = Math.max(1, list.length);
        list.forEach((item, index) => {
          const rankWeight = 1 - (index / maxRank);
          const dailySignal = getDailySignal(`${type}:${item.itemId || item.title || index}`);
          const trendScore = rankWeight * 0.55 + Math.min(weight, 2.1) * 0.32 + dailySignal * 0.13;
          pool.push({
            ...item,
            mediaType: type,
            discoveryScore: Number(trendScore.toFixed(4))
          });
        });
      });
      pool.sort((a, b) => Number(b.discoveryScore || 0) - Number(a.discoveryScore || 0));
      return pool;
    }

    function buildUnifiedFeed(pool, limit = 32) {
      if (!pool.length) return [];
      const grouped = new Map();
      pool.forEach((item) => {
        const key = String(item.mediaType || 'other');
        if (!grouped.has(key)) grouped.set(key, []);
        grouped.get(key).push(item);
      });

      const typeOrder = [...grouped.keys()].sort(
        (a, b) => Number(homeTasteWeights[b] || 1) - Number(homeTasteWeights[a] || 1)
      );
      const stream = [];
      let guard = 0;
      while (stream.length < limit && guard < 800) {
        let addedAny = false;
        for (const type of typeOrder) {
          const queue = grouped.get(type);
          if (!queue || !queue.length) continue;
          const next = queue.shift();
          if (next) {
            stream.push(next);
            addedAny = true;
            if (stream.length >= limit) break;
          }
        }
        if (!addedAny) break;
        guard += 1;
      }
      return stream;
    }

    function hydrateSpotlightFromPool(pool) {
      if (!Array.isArray(pool) || !pool.length) {
        homeSpotlightItems = [];
        resetSpotlightTimer(false);
        return;
      }
      const topPool = pool.slice(0, HOME_SPOTLIGHT_POOL_SIZE * 3);
      const mixedCandidates = buildUnifiedFeed(topPool, HOME_SPOTLIGHT_POOL_SIZE * 2);
      const diversified = shuffleArray(mixedCandidates.length ? mixedCandidates : topPool).slice(0, HOME_SPOTLIGHT_POOL_SIZE);
      let shortlist = diversified.length ? diversified : pool.slice(0, HOME_SPOTLIGHT_POOL_SIZE);

      const gamePool = pool.filter((item) => String(item.mediaType || '').toLowerCase() === 'game');
      const desiredGameCount = Math.min(gamePool.length, Math.max(6, Math.floor(HOME_SPOTLIGHT_POOL_SIZE * 0.4)));
      const currentGameCount = shortlist.filter((item) => String(item.mediaType || '').toLowerCase() === 'game').length;
      if (currentGameCount < desiredGameCount) {
        const keyOf = (item) => `${String(item.mediaType || '')}:${String(item.itemId || item.title || '')}`;
        const existingKeys = new Set(shortlist.map((item) => keyOf(item)));
        const gameAdditions = gamePool.filter((item) => !existingKeys.has(keyOf(item))).slice(0, desiredGameCount - currentGameCount);
        if (gameAdditions.length) {
          const boosted = [...shortlist];
          gameAdditions.forEach((gameItem) => {
            for (let i = boosted.length - 1; i >= 0; i -= 1) {
              if (String(boosted[i].mediaType || '').toLowerCase() !== 'game') {
                boosted[i] = gameItem;
                break;
              }
            }
          });
          shortlist = shuffleArray(boosted);
        }
      }

      const bookPool = pool.filter((item) => String(item.mediaType || '').toLowerCase() === 'book');
      const desiredBookCount = Math.min(bookPool.length, Math.max(3, Math.floor(HOME_SPOTLIGHT_POOL_SIZE * 0.2)));
      const currentBookCount = shortlist.filter((item) => String(item.mediaType || '').toLowerCase() === 'book').length;
      if (currentBookCount < desiredBookCount) {
        const knownTitles = new Set(FALLBACK_BOOKS.map((b) => String(b.title || '').trim().toLowerCase()));
        const scoreBook = (item) => (knownTitles.has(String(item.title || '').trim().toLowerCase()) ? 1 : 0);
        const bookAdditions = [...bookPool]
          .sort((a, b) => scoreBook(b) - scoreBook(a))
          .slice(0, desiredBookCount - currentBookCount);
        if (bookAdditions.length) {
          const boosted = [...shortlist];
          bookAdditions.forEach((bookItem) => {
            for (let i = boosted.length - 1; i >= 0; i -= 1) {
              const type = String(boosted[i].mediaType || '').toLowerCase();
              if (type !== 'book' && type !== 'game') {
                boosted[i] = bookItem;
                break;
              }
            }
          });
          shortlist = shuffleArray(boosted);
        }
      }

      const seed = getSpotlightSeedOffset();
      const offset = seed % shortlist.length;
      homeSpotlightItems = [...shortlist.slice(offset), ...shortlist.slice(0, offset)];
      warmSpotlightImages(homeSpotlightItems);
      homeSpotlightIndex = 0;
      showSpotlightByIndex(0, false);
      resetSpotlightTimer(true);
    }

    async function loadTasteWeights() {
      const weights = {
        restaurant: 1,
        movie: 1,
        tv: 1,
        game: 1,
        book: 1,
        music: 1
      };
      if (!homeCurrentUser?.id) return weights;

      const client = await ensureHomeSupabase();
      if (!client) return weights;
      try {
        const [movieRes, tvRes, gameRes, bookRes, musicRes, listRes] = await Promise.all([
          client.from('movie_list_items').select('id', { count: 'exact', head: true }).eq('user_id', homeCurrentUser.id),
          client.from('tv_list_items').select('id', { count: 'exact', head: true }).eq('user_id', homeCurrentUser.id),
          client.from('game_list_items').select('id', { count: 'exact', head: true }).eq('user_id', homeCurrentUser.id),
          client.from('book_list_items').select('id', { count: 'exact', head: true }).eq('user_id', homeCurrentUser.id),
          client.from('music_list_items').select('id', { count: 'exact', head: true }).eq('user_id', homeCurrentUser.id),
          client.from('lists').select('id').eq('user_id', homeCurrentUser.id)
        ]);

        const listIds = Array.isArray(listRes?.data) ? listRes.data.map((row) => row.id).filter(Boolean) : [];
        let restaurantCount = 0;
        if (listIds.length) {
          const { count } = await client
            .from('lists_restraunts')
            .select('id', { count: 'exact', head: true })
            .in('list_id', listIds);
          restaurantCount = Number(count || 0);
        }

        const counts = {
          movie: Number(movieRes?.count || 0),
          tv: Number(tvRes?.count || 0),
          game: Number(gameRes?.count || 0),
          book: Number(bookRes?.count || 0),
          music: Number(musicRes?.count || 0),
          restaurant: restaurantCount
        };
        const total = Object.values(counts).reduce((sum, value) => sum + value, 0);
        if (!total) return weights;

        Object.entries(counts).forEach(([type, value]) => {
          const share = value / total;
          weights[type] = Number((1 + Math.min(1.1, share * 3.2)).toFixed(2));
        });
      } catch (_err) {}
      return weights;
    }

    async function ensureHomeSupabase() {
      if (homeSupabaseClient) return homeSupabaseClient;
      if (!window.supabase || !window.supabase.createClient) return null;
      homeSupabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
        auth: {
          flowType: 'pkce',
          persistSession: true,
          autoRefreshToken: true,
          // OAuth callback is handled on auth-callback.html, keep homepage parser off.
          detectSessionInUrl: false
        }
      });
      return homeSupabaseClient;
    }

    function clearHomeAuthParamsFromUrl() {
      const url = new URL(window.location.href);
      const authParams = ['code', 'state', 'error', 'error_description', 'scope', 'authuser', 'prompt'];
      authParams.forEach((key) => url.searchParams.delete(key));
      if (/(access_token|refresh_token|expires_in|token_type|type)=/i.test(window.location.hash || '')) {
        url.hash = '';
      }
      const cleaned = `${url.pathname}${url.search}${url.hash}`;
      window.history.replaceState({}, document.title, cleaned || 'index.html');
    }

    async function completeHomeOAuthReturnIfNeeded() {
      const searchParams = new URLSearchParams(window.location.search || '');
      const hashParams = new URLSearchParams((window.location.hash || '').replace(/^#/, ''));
      const oauthError = searchParams.get('error_description') || searchParams.get('error');

      if (oauthError) {
        showHomeToast('Google sign-in failed. Please try again.', true);
        clearHomeAuthParamsFromUrl();
        return false;
      }

      const hasCode = !!searchParams.get('code');
      const hasTokens = !!(hashParams.get('access_token') && hashParams.get('refresh_token'));
      if (!hasCode && !hasTokens) return false;

      const client = await ensureHomeSupabase();
      if (!client) return false;

      try {
        if (hasCode) {
          const code = searchParams.get('code');
          const { error } = await client.auth.exchangeCodeForSession(code);
          if (error) throw error;
        } else {
          const { error } = await client.auth.setSession({
            access_token: hashParams.get('access_token'),
            refresh_token: hashParams.get('refresh_token')
          });
          if (error) throw error;
        }
        clearHomeAuthParamsFromUrl();
        return true;
      } catch (error) {
        console.error('Home OAuth completion failed:', error);
        showHomeToast('Could not complete sign-in. Please try again.', true);
        clearHomeAuthParamsFromUrl();
        return false;
      }
    }

    async function ensureRestaurantList(userId, listType) {
      const client = await ensureHomeSupabase();
      if (!client) return null;
      const conf = HOME_RESTAURANT_LIST_META[listType] || HOME_RESTAURANT_LIST_META.favorites;
      const { data: existing } = await client
        .from('lists')
        .select('id')
        .eq('user_id', userId)
        .eq('title', conf.title)
        .limit(1)
        .maybeSingle();
      if (existing?.id) return existing.id;
      const { data: created, error } = await client
        .from('lists')
        .insert({
          user_id: userId,
          title: conf.title,
          description: conf.description,
          icon: conf.icon
        })
        .select('id')
        .single();
      if (error) return null;
      return created?.id || null;
    }

    async function saveToListFromHome(payload) {
      const client = await ensureHomeSupabase();
      if (!client) {
        showHomeToast('List service unavailable', true);
        return;
      }
      if (!homeCurrentUser?.id) {
        window.location.href = 'login.html';
        return;
      }

      const mediaType = String(payload.mediaType || '').toLowerCase();
      const itemId = payload.itemId;
      const listType = payload.listType;
      if (!itemId || !listType) return;
      if (!supportsHomeLists(mediaType)) {
        showHomeToast('Lists are not available for this media yet.');
        return;
      }

      try {
        if (mediaType === 'movie') {
          const { data: existing } = await client
            .from('movie_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('movie_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('movie_list_items').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('movie_list_items').insert({ user_id: homeCurrentUser.id, movie_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'tv') {
          const { data: existing } = await client
            .from('tv_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('tv_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('tv_list_items').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('tv_list_items').insert({ user_id: homeCurrentUser.id, tv_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'game') {
          const { data: existing } = await client
            .from('game_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('game_id', itemId)
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('game_list_items').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('game_list_items').insert({ user_id: homeCurrentUser.id, game_id: itemId, list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'book') {
          await client.from('books').upsert({
            id: String(itemId),
            title: payload.title || '',
            authors: payload.subtitle || '',
            thumbnail: payload.image || '',
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
          const { data: existing } = await client
            .from('book_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('book_id', String(itemId))
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('book_list_items').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('book_list_items').insert({ user_id: homeCurrentUser.id, book_id: String(itemId), list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'music') {
          await client.from('tracks').upsert({
            id: String(itemId),
            name: payload.title || '',
            artists: payload.subtitle || '',
            image_url: payload.image || '',
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
          const { data: existing } = await client
            .from('music_list_items')
            .select('id')
            .eq('user_id', homeCurrentUser.id)
            .eq('track_id', String(itemId))
            .eq('list_type', listType)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('music_list_items').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('music_list_items').insert({ user_id: homeCurrentUser.id, track_id: String(itemId), list_type: listType });
          showHomeToast('Added to list');
          return;
        }

        if (mediaType === 'restaurant') {
          const listId = await ensureRestaurantList(homeCurrentUser.id, listType);
          if (!listId) {
            showHomeToast('Could not prepare list', true);
            return;
          }
          const { data: existing } = await client
            .from('lists_restraunts')
            .select('id')
            .eq('list_id', listId)
            .eq('restraunt_id', itemId)
            .limit(1)
            .maybeSingle();
          if (existing?.id) {
            await client.from('lists_restraunts').delete().eq('id', existing.id);
            showHomeToast('Removed from list');
            return;
          }
          await client.from('lists_restraunts').insert({ list_id: listId, restraunt_id: itemId });
          showHomeToast('Added to list');
          return;
        }
      } catch (_err) {
        showHomeToast('Could not add to list', true);
      }
    }

    async function getHomeListStatusMap(mediaType, itemId, listKeys) {
      const status = {};
      (listKeys || []).forEach((key) => {
        status[key] = false;
      });
      if (!homeCurrentUser?.id || !listKeys?.length) return status;
      const client = await ensureHomeSupabase();
      if (!client) return status;

      try {
        if (mediaType === 'movie') {
          const { data } = await client
            .from('movie_list_items')
            .select('list_type')
            .eq('user_id', homeCurrentUser.id)
            .eq('movie_id', itemId)
            .in('list_type', listKeys);
          (data || []).forEach((row) => {
            const key = String(row.list_type || '');
            if (key in status) status[key] = true;
          });
          return status;
        }

        if (mediaType === 'tv') {
          const { data } = await client
            .from('tv_list_items')
            .select('list_type')
            .eq('user_id', homeCurrentUser.id)
            .eq('tv_id', itemId)
            .in('list_type', listKeys);
          (data || []).forEach((row) => {
            const key = String(row.list_type || '');
            if (key in status) status[key] = true;
          });
          return status;
        }

        if (mediaType === 'game') {
          const { data } = await client
            .from('game_list_items')
            .select('list_type')
            .eq('user_id', homeCurrentUser.id)
            .eq('game_id', itemId)
            .in('list_type', listKeys);
          (data || []).forEach((row) => {
            const key = String(row.list_type || '');
            if (key in status) status[key] = true;
          });
          return status;
        }

        if (mediaType === 'book') {
          const { data } = await client
            .from('book_list_items')
            .select('list_type')
            .eq('user_id', homeCurrentUser.id)
            .eq('book_id', String(itemId))
            .in('list_type', listKeys);
          (data || []).forEach((row) => {
            const key = String(row.list_type || '');
            if (key in status) status[key] = true;
          });
          return status;
        }

        if (mediaType === 'music') {
          const { data } = await client
            .from('music_list_items')
            .select('list_type')
            .eq('user_id', homeCurrentUser.id)
            .eq('track_id', String(itemId))
            .in('list_type', listKeys);
          (data || []).forEach((row) => {
            const key = String(row.list_type || '');
            if (key in status) status[key] = true;
          });
          return status;
        }

        if (mediaType === 'restaurant') {
          const titleByKey = {};
          listKeys.forEach((key) => {
            const conf = HOME_RESTAURANT_LIST_META[key];
            if (conf?.title) titleByKey[key] = conf.title;
          });
          const titles = Object.values(titleByKey);
          if (!titles.length) return status;

          const { data: lists } = await client
            .from('lists')
            .select('id,title')
            .eq('user_id', homeCurrentUser.id)
            .in('title', titles);

          const listIdToKey = {};
          Object.entries(titleByKey).forEach(([key, title]) => {
            const match = (lists || []).find((row) => String(row.title || '').toLowerCase() === String(title).toLowerCase());
            if (match?.id) listIdToKey[String(match.id)] = key;
          });

          const listIds = Object.keys(listIdToKey);
          if (!listIds.length) return status;

          const { data: links } = await client
            .from('lists_restraunts')
            .select('list_id')
            .eq('restraunt_id', itemId)
            .in('list_id', listIds);

          (links || []).forEach((row) => {
            const key = listIdToKey[String(row.list_id)];
            if (key && key in status) status[key] = true;
          });
          return status;
        }
      } catch (_err) {}

      return status;
    }

    async function syncCardMenuListState(card, menu) {
      if (!card || !menu) return;
      const mediaType = String(card.getAttribute('data-media-type') || '').toLowerCase();
      const itemId = card.getAttribute('data-item-id');
      const cfg = getMediaListConfig(mediaType);
      if (!cfg || !Array.isArray(cfg.rows) || !cfg.rows.length) return;

      const listKeys = cfg.rows.map((row) => row.key).filter(Boolean);
      menu.querySelectorAll('.rail-menu-item[data-action="save"]').forEach((btn) => {
        btn.setAttribute('data-saved', '0');
        const stateEl = btn.querySelector('.rail-menu-state');
        if (stateEl) stateEl.textContent = 'Add';
      });

      if (!homeCurrentUser?.id) return;
      const status = await getHomeListStatusMap(mediaType, itemId, listKeys);
      menu.querySelectorAll('.rail-menu-item[data-action="save"]').forEach((btn) => {
        const key = String(btn.getAttribute('data-list') || '');
        const saved = !!status[key];
        btn.setAttribute('data-saved', saved ? '1' : '0');
        const stateEl = btn.querySelector('.rail-menu-state');
        if (stateEl) stateEl.textContent = saved ? 'Remove' : 'Add';
      });
    }

    function getHomeListConfig(mediaType) {
      return window.ListUtils ? ListUtils.getListConfig(mediaType) : null;
    }

    function coerceHomeItemId(mediaType, itemId) {
      return window.ListUtils ? ListUtils.coerceItemId(mediaType, itemId) : itemId;
    }

    function renderHomeListsModal() {
      const container = document.getElementById('homeListsContainer');
      if (!container) return;
      container.innerHTML = '';
      if (!homeCustomListState.customLists.length) {
        container.innerHTML = '<div class="chip">No custom lists yet.</div>';
        return;
      }
      homeCustomListState.customLists.forEach(list => {
        const item = document.createElement('div');
        const isActive = homeCustomListState.selectedLists.has(list.id);
        item.className = `modal-list-item${isActive ? ' active' : ''}`;
        item.innerHTML = `
          <span>${window.ListUtils ? ListUtils.renderListIcon(list.icon, homeCustomListState.selectedIcon) : ''} ${list.title}</span>
          <span class="modal-list-actions">
            <span>${isActive ? 'Saved' : 'Add'}</span>
            <button class="list-edit-btn" aria-label="Rename list"><i class="fas fa-pen"></i></button>
          </span>
        `;
        item.onclick = () => {
          if (homeCustomListState.selectedLists.has(list.id)) {
            homeCustomListState.selectedLists.delete(list.id);
          } else {
            homeCustomListState.selectedLists.add(list.id);
          }
          const active = homeCustomListState.selectedLists.has(list.id);
          item.classList.toggle('active', active);
          const label = item.querySelector('.modal-list-actions span');
          if (label) label.textContent = active ? 'Saved' : 'Add';
        };
        const editBtn = item.querySelector('.list-edit-btn');
        if (editBtn) {
          editBtn.onclick = (e) => {
            e.stopPropagation();
            renameHomeList(list.id, list.title);
          };
        }
        container.appendChild(item);
      });
    }

    function setHomeModalTitle(mediaType) {
      const title = document.getElementById('homeListsTitle');
      if (!title) return;
      const type = String(mediaType || '').toLowerCase();
      const map = {
        movie: 'Custom Movie Lists',
        tv: 'Custom TV Lists',
        game: 'Custom Game Lists',
        book: 'Custom Book Lists',
        music: 'Custom Music Lists',
        restaurant: 'Custom Restaurant Lists'
      };
      title.textContent = map[type] || 'Custom Lists';
    }

    function syncHomeIconSelection(nextIcon) {
      const options = document.querySelectorAll('#homeListIconOptions .icon-option');
      let matched = false;
      options.forEach(btn => {
        const icon = btn.getAttribute('data-icon');
        const selected = icon === nextIcon;
        btn.classList.toggle('selected', selected);
        if (selected) matched = true;
      });
      if (!matched && options[0]) {
        options[0].classList.add('selected');
        homeCustomListState.selectedIcon = options[0].getAttribute('data-icon') || 'fas fa-list';
      }
    }

    async function openHomeListsModal(item) {
      if (!homeCurrentUser?.id) {
        window.location.href = 'login.html';
        return;
      }
      const cfg = getHomeListConfig(item.mediaType);
      if (!cfg) return;
      const client = await ensureHomeSupabase();
      if (!client) return;
      homeCustomListState.mediaType = String(item.mediaType || '').toLowerCase();
      homeCustomListState.itemId = coerceHomeItemId(homeCustomListState.mediaType, item.itemId);
      homeCustomListState.title = item.title || '';
      homeCustomListState.subtitle = item.subtitle || '';
      homeCustomListState.image = item.image || '';
      homeCustomListState.selectedIcon = cfg.defaultIcon || 'fas fa-list';
      syncHomeIconSelection(homeCustomListState.selectedIcon);
      setHomeModalTitle(homeCustomListState.mediaType);

      const modal = document.getElementById('homeListsModal');
      const container = document.getElementById('homeListsContainer');
      if (!modal || !container) return;
      container.innerHTML = '<div class="chip">Loading...</div>';
      homeCustomListState.customLists = window.ListUtils
        ? await ListUtils.loadCustomLists(client, homeCurrentUser.id, homeCustomListState.mediaType)
        : [];
      const listIds = homeCustomListState.customLists.map(l => l.id);
      homeCustomListState.selectedLists = window.ListUtils
        ? await ListUtils.loadCustomListMembership(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          homeCustomListState.itemId,
          listIds
        )
        : new Set();
      renderHomeListsModal();
      modal.classList.add('active');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeHomeListsModal() {
      const modal = document.getElementById('homeListsModal');
      if (modal) {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
      }
      homeCustomListState.mediaType = null;
      homeCustomListState.itemId = null;
      homeCustomListState.customLists = [];
      homeCustomListState.selectedLists = new Set();
    }

    async function saveHomeListChanges() {
      const cfg = getHomeListConfig(homeCustomListState.mediaType);
      const client = await ensureHomeSupabase();
      if (!cfg || !client || !homeCurrentUser?.id || !homeCustomListState.itemId) return;
      if (window.ListUtils) {
        await ListUtils.saveCustomListChanges(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          homeCustomListState.itemId,
          [...homeCustomListState.selectedLists],
          homeCustomListState.mediaType === 'book'
            ? {
              id: homeCustomListState.itemId,
              title: homeCustomListState.title,
              authors: homeCustomListState.subtitle,
              thumbnail: homeCustomListState.image
            }
            : null
        );
      }
      showHomeToast('Lists updated');
      closeHomeListsModal();
    }

    async function createHomeList() {
      const input = document.getElementById('newHomeListName');
      const client = await ensureHomeSupabase();
      if (!input || !client || !homeCurrentUser?.id) return;
      const title = input.value.trim();
      if (!title) return;
      const exists = homeCustomListState.customLists.some(
        list => String(list.title || '').trim().toLowerCase() === title.toLowerCase()
      );
      if (exists) {
        showHomeToast('List already exists', true);
        return;
      }
      const data = window.ListUtils
        ? await ListUtils.createCustomList(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          {
            title,
            icon: homeCustomListState.selectedIcon
          }
        )
        : null;
      if (!data) {
        showHomeToast('Could not create list', true);
        return;
      }
      input.value = '';
      homeCustomListState.customLists.unshift(data);
      renderHomeListsModal();
    }

    async function renameHomeList(listId, currentTitle) {
      const nextTitle = prompt('Rename list', currentTitle || '');
      if (!nextTitle || !nextTitle.trim()) return;
      const client = await ensureHomeSupabase();
      if (!client || !homeCurrentUser?.id) return;
      const ok = window.ListUtils
        ? await ListUtils.renameCustomList(
          client,
          homeCurrentUser.id,
          homeCustomListState.mediaType,
          listId,
          nextTitle.trim()
        )
        : false;
      if (!ok) {
        showHomeToast('Could not rename list', true);
        return;
      }
      homeCustomListState.customLists = homeCustomListState.customLists.map(list =>
        list.id === listId ? { ...list, title: nextTitle.trim() } : list
      );
      renderHomeListsModal();
    }

    function setStatus(_text, _isError) {
      if (!statusEl) return;
      statusEl.textContent = '';
    }

    function randomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffleArray(input) {
      const arr = [...input];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function preloadImage(url) {
      const src = String(url || '').trim();
      if (!src) return;
      const img = new Image();
      img.decoding = 'async';
      img.src = src;
    }

    function warmHomeFeedImages(feedMap) {
      const groups = Object.values(feedMap || {});
      groups.forEach((items) => {
        if (!Array.isArray(items)) return;
        items.slice(0, HOME_CHANNEL_TARGET_ITEMS).forEach((item) => {
          preloadImage(item.image);
          preloadImage(item.logo);
          preloadImage(item.backgroundImage);
          preloadImage(item.spotlightImage);
          preloadImage(item.spotlightMediaImage);
        });
      });
    }

    function warmSpotlightImages(items) {
      if (!Array.isArray(items)) return;
      items.slice(0, HOME_SPOTLIGHT_POOL_SIZE).forEach((item) => {
        preloadImage(item.spotlightImage || item.backgroundImage || item.image);
        preloadImage(item.spotlightMediaImage || item.image || item.spotlightImage || item.backgroundImage);
        preloadImage(item.fallbackImage);
      });
    }

    function getBookCoverFallback(item) {
      const isbn = String(item?.isbn || '').trim();
      if (isbn) {
        return `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(isbn)}-L.jpg`;
      }
      return '';
    }

    function setSpotlightImageWithFallback(imgEl, sources, token) {
      if (!imgEl) return;
      if (imgEl.__homeSpotlightOnLoad) {
        imgEl.removeEventListener('load', imgEl.__homeSpotlightOnLoad);
      }
      if (imgEl.__homeSpotlightOnError) {
        imgEl.removeEventListener('error', imgEl.__homeSpotlightOnError);
      }

      const candidates = [...new Set((sources || [])
        .map((value) => String(value || '').trim())
        .filter(Boolean))];

      if (!candidates.length) {
        imgEl.removeAttribute('src');
        return;
      }

      let pointer = 0;
      const onLoad = () => {
        if (token !== homeSpotlightImageToken) return;
        imgEl.removeAttribute('data-loading');
      };
      const onError = () => {
        if (token !== homeSpotlightImageToken) return;
        pointer += 1;
        if (pointer < candidates.length) {
          imgEl.src = candidates[pointer];
          return;
        }
        imgEl.removeAttribute('src');
        imgEl.removeAttribute('data-loading');
      };

      imgEl.__homeSpotlightOnLoad = onLoad;
      imgEl.__homeSpotlightOnError = onError;
      imgEl.addEventListener('load', onLoad);
      imgEl.addEventListener('error', onError);
      imgEl.setAttribute('data-loading', '1');
      imgEl.src = candidates[pointer];
    }

    function buildInstantFallbackFeed() {
      const makeSeedItems = (mediaType, titles, href) => titles.map((title, index) => ({
        mediaType,
        itemId: `seed-${mediaType}-${index + 1}`,
        title,
        subtitle: 'Loading live picks',
        image: '',
        backgroundImage: '',
        spotlightImage: '',
        spotlightMediaImage: '',
        spotlightMediaFit: 'contain',
        spotlightMediaShape: 'poster',
        href,
        isPlaceholder: true
      }));

      return {
        restaurant: FALLBACK_RESTAURANTS.map((r, index) => ({
          mediaType: 'restaurant',
          itemId: `seed-restaurant-${index + 1}`,
          title: r.name,
          subtitle: `${r.category} | ${r.rating}/5`,
          image: '',
          logo: '',
          backgroundImage: '',
          spotlightImage: '',
          spotlightMediaImage: '',
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          href: 'restraunts.html',
          isPlaceholder: true
        })),
        movie: makeSeedItems('movie', ['Popular Movies', 'Now in Theaters', 'Award Winners', 'Critics Picks', 'Weekend Watch'], 'movies.html'),
        tv: makeSeedItems('tv', ['Top TV Shows', 'Binge Picks', 'New Seasons', 'Global Hits', 'Fan Favorites'], 'tvshows.html'),
        game: makeSeedItems('game', ['Top Games', 'New Releases', 'Most Played', 'Action Picks', 'Co-op Favorites'], 'games.html'),
        music: makeSeedItems('music', ['Global Hits', 'Viral Tracks', 'Fresh Releases', 'Chill Vibes', 'Late Night Mix'], 'music.html'),
        book: FALLBACK_BOOKS.slice(0, 8).map((b, index) => ({
          mediaType: 'book',
          itemId: `seed-book-${index + 1}`,
          title: b.title,
          subtitle: b.author,
          image: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
          backgroundImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
          spotlightImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
          spotlightMediaImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          fallbackImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
          isbn: b.isbn,
          href: 'books.html',
          isPlaceholder: true
        }))
      };
    }

    function getHomeChannels() {
      return [
        { key: 'restaurant', railId: 'restaurantsRail', loader: loadRestaurants, opts: { mediaType: 'restaurant', landscape: true, restaurantComposite: true } },
        { key: 'movie', railId: 'moviesRail', loader: loadMovies, opts: { mediaType: 'movie' } },
        { key: 'tv', railId: 'tvRail', loader: loadTv, opts: { mediaType: 'tv' } },
        { key: 'game', railId: 'gamesRail', loader: loadGames, opts: { mediaType: 'game' } },
        { key: 'book', railId: 'booksRail', loader: loadBooks, opts: { mediaType: 'book' } },
        { key: 'music', railId: 'musicRail', loader: loadMusic, opts: { mediaType: 'music' } }
      ];
    }

    function readHomeFeedCache() {
      try {
        const raw = localStorage.getItem(HOME_FEED_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        const savedAt = Number(parsed?.savedAt || 0);
        if (!savedAt || (Date.now() - savedAt) > HOME_FEED_CACHE_MAX_AGE_MS) return null;
        const feed = parsed?.feed;
        if (!feed || typeof feed !== 'object') return null;
        return feed;
      } catch (_err) {
        return null;
      }
    }

    function writeHomeFeedCache(feedMap) {
      try {
        const channels = getHomeChannels();
        const payload = {};
        channels.forEach((channel) => {
          payload[channel.key] = Array.isArray(feedMap?.[channel.key]) ? feedMap[channel.key] : [];
        });
        localStorage.setItem(HOME_FEED_CACHE_KEY, JSON.stringify({
          savedAt: Date.now(),
          feed: payload
        }));
      } catch (_err) {}
    }

    async function loadHomeChannelWithTimeout(loader, timeoutMs = HOME_CHANNEL_TIMEOUT_MS) {
      let timer = null;
      try {
        const value = await Promise.race([
          Promise.resolve().then(() => loader()),
          new Promise((resolve) => {
            timer = setTimeout(() => resolve([]), timeoutMs);
          })
        ]);
        return Array.isArray(value) ? value : [];
      } catch (_err) {
        return [];
      } finally {
        if (timer) clearTimeout(timer);
      }
    }

    function applyHomeFeedMap(feedMap) {
      const channels = getHomeChannels();
      warmHomeFeedImages(feedMap);
      let activeChannels = 0;
      channels.forEach((channel) => {
        const items = Array.isArray(feedMap?.[channel.key]) ? feedMap[channel.key] : [];
        homeFeedState[channel.key] = items;
        renderRail(channel.railId, items, channel.opts);
        if (items.length) activeChannels += 1;
      });

      const scoredPool = buildScoredDiscoveryPool(homeFeedState);
      const unified = buildUnifiedFeed(scoredPool, 32);
      renderRail('unifiedRail', unified, { mediaType: 'mixed', uniformMedia: true, restaurantComposite: true });
      hydrateSpotlightFromPool(scoredPool);

      return { activeChannels, scoredPool, channelsCount: channels.length };
    }

    async function refreshHomePersonalization() {
      const hasItems = Object.values(homeFeedState).some((items) => Array.isArray(items) && items.length);
      if (!hasItems) return;
      homeTasteWeights = await loadTasteWeights();
      const scoredPool = buildScoredDiscoveryPool(homeFeedState);
      const unified = buildUnifiedFeed(scoredPool, 32);
      renderRail('unifiedRail', unified, { mediaType: 'mixed', uniformMedia: true, restaurantComposite: true });
      hydrateSpotlightFromPool(scoredPool);
    }

    function renderRail(railId, items, opts) {
      const rail = document.getElementById(railId);
      if (!rail) return;
      rail.classList.toggle('games-rail', String(opts?.mediaType || '').toLowerCase() === 'game');

      if (!items || !items.length) {
        rail.innerHTML = '<div class="empty">No items right now.</div>';
        return;
      }

      rail.innerHTML = items.map((item, index) => {
        const mediaTypeRaw = String(item.mediaType || opts?.mediaType || '').toLowerCase();
        const media = getHomeMediaMeta(mediaTypeRaw);
        const uniformMedia = !!opts?.uniformMedia;
        const landscape = !uniformMedia && (!!opts?.landscape || mediaTypeRaw === 'restaurant');
        const restaurantComposite = !!opts?.restaurantComposite && mediaTypeRaw === 'restaurant';
        const title = escapeHtml(item.title || 'Untitled');
        const subtitle = escapeHtml(item.subtitle || media.label);
        const extra = escapeHtml(item.extra || '');
        const image = escapeHtml(item.image || '');
        const logo = escapeHtml(item.logo || '');
        const fallbackImage = escapeHtml(item.fallbackImage || '');
        const coverImage = image || logo;
        const hrefRaw = item.href || '#';
        const href = escapeHtml(hrefRaw);
        const mediaType = escapeHtml(mediaTypeRaw);
        const itemId = escapeHtml(item.itemId || '');
        const supportsLists = supportsHomeLists(mediaTypeRaw) && !item.isPlaceholder;
        const opensExternal = /^https?:\/\//i.test(String(hrefRaw || ''));
        const imageLoading = index < 12 ? 'eager' : 'lazy';
        const imagePriority = index < 8 ? 'high' : 'auto';
        const mediaClasses = ['card-media'];
        if (landscape) mediaClasses.push('landscape');
        if (mediaTypeRaw === 'game') mediaClasses.push('game-poster');
        if (mediaTypeRaw === 'music') mediaClasses.push('music-cover');
        if (restaurantComposite) mediaClasses.push('restaurant-composite');
        const mediaHtml = restaurantComposite
          ? `
              ${coverImage ? `<img class="restaurant-cover" src="${coverImage}" alt="${title}" loading="${imageLoading}" fetchpriority="${imagePriority}" decoding="async" data-fallback-image="${fallbackImage || logo}" data-fallback-applied="0">` : '<i class="fa-solid fa-image"></i>'}
              ${logo ? `<span class="restaurant-logo-badge"><img src="${logo}" alt="${title} logo" loading="${imageLoading}" fetchpriority="${imagePriority}" decoding="async" data-fallback-image="${fallbackImage || coverImage}" data-fallback-applied="0"></span>` : ''}
            `
          : `${image ? `<img src="${image}" alt="${title}" loading="${imageLoading}" fetchpriority="${imagePriority}" decoding="async" data-fallback-image="${fallbackImage}" data-fallback-applied="0">` : '<i class="fa-solid fa-image"></i>'}`;
        const extraMarkup = extra ? `<p class="card-extra">${extra}</p>` : '<p class="card-extra placeholder">&nbsp;</p>';
        const trailingControl = supportsLists
          ? `
            <div class="card-menu-wrap">
              <button class="card-menu-btn" aria-label="Add to lists"><i class="fas fa-ellipsis-v"></i></button>
              <div class="rail-menu">
                ${buildRailListMenuHtml(item)}
              </div>
            </div>
          `
          : `<a class="card-open-link" href="${href}" ${opensExternal ? 'target="_blank" rel="noopener"' : ''} aria-label="Open item"><i class="fas fa-arrow-up-right-from-square"></i></a>`;
        return `
          <article class="card" data-href="${href}" data-media-type="${mediaType}" data-item-id="${itemId}" data-title="${title}" data-subtitle="${subtitle}" data-image="${image}">
            <div class="card-hover-cue"><i class="fas fa-arrow-up-right-from-square"></i> Open</div>
            <div class="${mediaClasses.join(' ')}">
              ${mediaHtml}
            </div>
            <div class="card-meta">
              <span class="card-type"><i class="fa-solid ${media.icon}"></i> ${escapeHtml(media.label)}</span>
              <div class="card-meta-top">
                <p class="card-name">${title}</p>
                ${trailingControl}
              </div>
              <p class="card-sub">${subtitle}</p>
              ${extraMarkup}
            </div>
          </article>
        `;
      }).join('');

      wireHomeCardMenus(rail);
      wireHomeRailImageFallbacks(rail);
    }

    function wireHomeRailImageFallbacks(scope) {
      scope.querySelectorAll('img[data-fallback-image]').forEach((img) => {
        img.addEventListener('error', () => {
          const fallback = String(img.getAttribute('data-fallback-image') || '').trim();
          const alreadyApplied = img.getAttribute('data-fallback-applied') === '1';
          if (!fallback || alreadyApplied) return;
          img.setAttribute('data-fallback-applied', '1');
          if (String(img.currentSrc || img.src).trim() === fallback) return;
          img.src = fallback;
        });
      });
    }

    function wireHomeCardMenus(scope) {
      scope.querySelectorAll('.card').forEach((card) => {
        const href = card.getAttribute('data-href');
        card.onclick = (e) => {
          if (e.target.closest('.card-menu-btn') || e.target.closest('.rail-menu') || e.target.closest('.card-open-link')) return;
          if (href) window.location.href = href;
        };
      });

      scope.querySelectorAll('.card-menu-btn').forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          const menu = btn.parentElement.querySelector('.rail-menu');
          const wasOpen = !!menu?.classList.contains('open');
          closeAllRailMenus();
          if (menu && !wasOpen) {
            menu.classList.add('open');
            const card = btn.closest('.card');
            if (card) card.classList.add('menu-open');
            showRailMenuBackdrop();
            await syncCardMenuListState(card, menu);
          }
        });
      });

      scope.querySelectorAll('.rail-menu-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = item.getAttribute('data-action');
          closeAllRailMenus();
          if (action === 'save') {
            const card = item.closest('.card');
            if (!card) return;
            saveToListFromHome({
              mediaType: card.getAttribute('data-media-type'),
              itemId: card.getAttribute('data-item-id'),
              listType: item.getAttribute('data-list'),
              title: card.getAttribute('data-title'),
              subtitle: card.getAttribute('data-subtitle'),
              image: card.getAttribute('data-image')
            });
            return;
          }
          if (action === 'custom') {
            const card = item.closest('.card');
            if (card) {
              openHomeListsModal({
                mediaType: card.getAttribute('data-media-type'),
                itemId: card.getAttribute('data-item-id'),
                title: card.getAttribute('data-title'),
                subtitle: card.getAttribute('data-subtitle'),
                image: card.getAttribute('data-image')
              });
              return;
            }
            const href = item.getAttribute('data-href');
            if (href) window.location.href = href;
          }
        });
      });
    }

    function ensureRailMenuBackdrop() {
      let backdrop = document.getElementById('railMenuBackdrop');
      if (!backdrop) {
        backdrop = document.createElement('div');
        backdrop.id = 'railMenuBackdrop';
        backdrop.className = 'rail-menu-backdrop';
        backdrop.addEventListener('click', closeAllRailMenus);
        document.body.appendChild(backdrop);
      }
      return backdrop;
    }

    function showRailMenuBackdrop() {
      const backdrop = ensureRailMenuBackdrop();
      backdrop.classList.add('active');
    }

    function hideRailMenuBackdrop() {
      const backdrop = document.getElementById('railMenuBackdrop');
      if (backdrop) backdrop.classList.remove('active');
    }

    function closeAllRailMenus() {
      document.querySelectorAll('.rail-menu.open').forEach((menu) => menu.classList.remove('open'));
      document.querySelectorAll('.card.menu-open').forEach((card) => card.classList.remove('menu-open'));
      hideRailMenuBackdrop();
    }

    async function setupHomeAuthListener() {
      if (homeAuthListenerReady) return;
      const client = await ensureHomeSupabase();
      if (!client) return;
      homeAuthListenerReady = true;

      client.auth.onAuthStateChange((event, session) => {
        if ((event === 'SIGNED_IN' || event === 'INITIAL_SESSION') && session?.user) {
          homeCurrentUser = session.user;
        } else if (event === 'SIGNED_OUT') {
          homeCurrentUser = null;
        } else if (event === 'TOKEN_REFRESHED') {
          if (session?.user) {
            homeCurrentUser = session.user;
          }
        }

        if (event === 'SIGNED_IN' || event === 'SIGNED_OUT' || event === 'INITIAL_SESSION' || event === 'TOKEN_REFRESHED') {
          void initAuthUi();
          void refreshHomePersonalization();
        }
      });
    }

    async function getVerifiedHomeUser(client) {
      // Short retry window to avoid race right after OAuth redirect.
      for (let attempt = 0; attempt < 4; attempt += 1) {
        const { data: sessionData } = await client.auth.getSession();
        const session = sessionData?.session || null;
        if (!session) {
          if (attempt < 3) {
            await new Promise((resolve) => setTimeout(resolve, 250));
            continue;
          }
          return null;
        }

        const { data: userData, error: userError } = await client.auth.getUser();
        if (!userError && userData?.user) {
          return userData.user;
        }

        const errorMessage = String(userError?.message || '').toLowerCase();
        const invalidSession =
          userError?.status === 401 ||
          errorMessage.includes('jwt') ||
          errorMessage.includes('token') ||
          errorMessage.includes('session') ||
          errorMessage.includes('unauthorized');

        if (invalidSession) {
          // Session token in local storage can be stale and cause false "logged in" redirects.
          await client.auth.signOut({ scope: 'local' });
        } else if (attempt < 3) {
          await new Promise((resolve) => setTimeout(resolve, 250));
          continue;
        }
        return null;
      }
      return null;
    }

    async function initAuthUi() {
      const client = await ensureHomeSupabase();
      if (!client) return;
      const loginBtn = document.getElementById('loginBtn');
      const signupBtn = document.getElementById('signupBtn');
      const profileBtn = document.getElementById('profileBtn');
      try {
        const user = await getVerifiedHomeUser(client);
        homeCurrentUser = user;
        const isLoggedIn = !!user;
        if (isLoggedIn) {
          if (loginBtn) loginBtn.style.display = 'none';
          if (signupBtn) signupBtn.style.display = 'none';
          let label = 'Profile';
          try {
            const { data: profile } = await client
              .from('user_profiles')
              .select('username, full_name')
              .eq('id', user.id)
              .single();
            const raw = profile?.username || profile?.full_name || '';
            const clean = String(raw || '').trim();
            if (clean) label = clean.startsWith('@') ? clean : `@${clean}`;
          } catch (_profileErr) {}
          if (profileBtn) {
            profileBtn.innerHTML = `<i class=\"fas fa-user\"></i><span>${label}</span>`;
            profileBtn.style.display = 'inline-flex';
          }
        } else {
          if (loginBtn) loginBtn.style.display = 'inline-flex';
          if (signupBtn) signupBtn.style.display = 'inline-flex';
          if (profileBtn) profileBtn.style.display = 'none';
        }
      } catch (_e) {
        homeCurrentUser = null;
        if (loginBtn) loginBtn.style.display = 'inline-flex';
        if (signupBtn) signupBtn.style.display = 'inline-flex';
        if (profileBtn) profileBtn.style.display = 'none';
      }
    }

    function getOnboardingStorageKey(userId) {
      return `zo2y_onboarding_seen_${HOME_ONBOARDING_VERSION}_${String(userId || '').trim()}`;
    }

    function hasSeenOnboarding(userId) {
      if (!userId) return true;
      return localStorage.getItem(getOnboardingStorageKey(userId)) === '1';
    }

    function markOnboardingSeen(userId) {
      if (!userId) return;
      localStorage.setItem(getOnboardingStorageKey(userId), '1');
    }

    function getHomeOnboardingSteps() {
      return [
        {
          title: 'Welcome to Zo2y',
          body: 'Quick tour: how to add places to lists, create your own lists, and connect with friends.',
          actionLabel: null,
          action: null
        },
        {
          title: 'Add Places To Lists',
          body: 'On any card, tap the three-dot menu. Use quick list buttons, or choose Custom Lists to organize it your way.',
          actionLabel: 'Open A Card Menu',
          action: () => {
            const menuBtn = document.querySelector('.card-menu-btn');
            if (!menuBtn) {
              showHomeToast('Cards are still loading. Try again in a moment.', true);
              return;
            }
            closeHomeOnboarding(false);
            menuBtn.click();
          }
        },
        {
          title: 'Create Your Own Lists',
          body: 'In the Custom Lists modal, enter a list name, pick an icon, then press Create.',
          actionLabel: 'Open Custom Lists',
          action: () => {
            const firstCard = document.querySelector('.card[data-media-type][data-item-id]');
            if (!firstCard) {
              showHomeToast('Cards are still loading. Try again in a moment.', true);
              return;
            }
            closeHomeOnboarding(false);
            void openHomeListsModal({
              mediaType: firstCard.getAttribute('data-media-type') || 'restaurant',
              itemId: firstCard.getAttribute('data-item-id') || '',
              title: firstCard.getAttribute('data-title') || '',
              subtitle: firstCard.getAttribute('data-subtitle') || '',
              image: firstCard.getAttribute('data-image') || ''
            });
          }
        },
        {
          title: 'Add Friends',
          body: 'Open profiles and tap Follow to build your network. You can manage followers and following from your profile.',
          actionLabel: 'Go To My Profile',
          action: () => {
            closeHomeOnboarding(true);
            window.location.href = 'profile.html';
          }
        }
      ];
    }

    function ensureHomeOnboardingUi() {
      let style = document.getElementById('homeOnboardingStyle');
      if (!style) {
        style = document.createElement('style');
        style.id = 'homeOnboardingStyle';
        style.textContent = `
          .home-onboarding-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(6, 12, 28, 0.76);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(6px);
          }
          .home-onboarding-overlay.active { display: flex; }
          .home-onboarding-card {
            width: min(680px, 96vw);
            background: linear-gradient(180deg, rgba(19,35,71,0.98), rgba(10,24,54,0.98));
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 16px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.45);
            padding: 24px;
            color: #fff;
          }
          .home-onboarding-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 13px;
            color: rgba(255,255,255,0.78);
          }
          .home-onboarding-skip {
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.78);
            cursor: pointer;
            font-weight: 600;
          }
          .home-onboarding-skip:hover { color: #fff; }
          .home-onboarding-title {
            margin: 6px 0 8px;
            font-size: clamp(24px, 3vw, 32px);
            line-height: 1.2;
          }
          .home-onboarding-body {
            color: rgba(255,255,255,0.88);
            font-size: 16px;
            line-height: 1.55;
            min-height: 72px;
          }
          .home-onboarding-progress {
            margin-top: 14px;
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
          }
          .home-onboarding-dot {
            height: 6px;
            flex: 1;
            border-radius: 999px;
            background: rgba(255,255,255,0.18);
          }
          .home-onboarding-dot.active { background: #f59e0b; }
          .home-onboarding-actions {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 10px;
          }
          .home-onboarding-left, .home-onboarding-right {
            display: flex;
            gap: 10px;
            align-items: center;
          }
          .home-onboarding-btn {
            border: 1px solid rgba(255,255,255,0.22);
            background: rgba(255,255,255,0.06);
            color: #fff;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            cursor: pointer;
          }
          .home-onboarding-btn:hover { background: rgba(255,255,255,0.14); }
          .home-onboarding-btn.primary {
            border-color: rgba(245, 158, 11, 0.9);
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #0b1633;
          }
          .home-onboarding-btn.primary:hover {
            filter: brightness(1.05);
          }
        `;
        document.head.appendChild(style);
      }

      let overlay = document.getElementById('homeOnboardingOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'homeOnboardingOverlay';
        overlay.className = 'home-onboarding-overlay';
        overlay.innerHTML = `
          <div class="home-onboarding-card" role="dialog" aria-modal="true" aria-labelledby="homeOnboardingTitle">
            <div class="home-onboarding-top">
              <span id="homeOnboardingStepText"></span>
              <button class="home-onboarding-skip" id="homeOnboardingSkipBtn">Skip tour</button>
            </div>
            <h2 class="home-onboarding-title" id="homeOnboardingTitle"></h2>
            <p class="home-onboarding-body" id="homeOnboardingBody"></p>
            <div class="home-onboarding-progress" id="homeOnboardingProgress"></div>
            <div class="home-onboarding-actions">
              <div class="home-onboarding-left">
                <button class="home-onboarding-btn" id="homeOnboardingBackBtn">Back</button>
              </div>
              <div class="home-onboarding-right">
                <button class="home-onboarding-btn" id="homeOnboardingTryBtn" style="display:none;"></button>
                <button class="home-onboarding-btn primary" id="homeOnboardingNextBtn">Next</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);
      }
    }

    function renderHomeOnboardingStep() {
      const steps = getHomeOnboardingSteps();
      const safeIndex = Math.max(0, Math.min(homeOnboardingIndex, steps.length - 1));
      homeOnboardingIndex = safeIndex;
      const step = steps[safeIndex];
      const overlay = document.getElementById('homeOnboardingOverlay');
      if (!overlay || !step) return;

      const stepText = document.getElementById('homeOnboardingStepText');
      const title = document.getElementById('homeOnboardingTitle');
      const body = document.getElementById('homeOnboardingBody');
      const progress = document.getElementById('homeOnboardingProgress');
      const backBtn = document.getElementById('homeOnboardingBackBtn');
      const nextBtn = document.getElementById('homeOnboardingNextBtn');
      const tryBtn = document.getElementById('homeOnboardingTryBtn');
      if (!stepText || !title || !body || !progress || !backBtn || !nextBtn || !tryBtn) return;

      stepText.textContent = `Step ${safeIndex + 1} of ${steps.length}`;
      title.textContent = step.title;
      body.textContent = step.body;
      backBtn.disabled = safeIndex === 0;
      backBtn.style.opacity = safeIndex === 0 ? '0.5' : '1';
      nextBtn.textContent = safeIndex === steps.length - 1 ? 'Finish' : 'Next';

      if (step.actionLabel && typeof step.action === 'function') {
        tryBtn.textContent = step.actionLabel;
        tryBtn.style.display = 'inline-flex';
      } else {
        tryBtn.style.display = 'none';
      }

      progress.innerHTML = '';
      steps.forEach((_s, idx) => {
        const dot = document.createElement('span');
        dot.className = `home-onboarding-dot${idx <= safeIndex ? ' active' : ''}`;
        progress.appendChild(dot);
      });
    }

    function closeHomeOnboarding(markSeen = true) {
      const overlay = document.getElementById('homeOnboardingOverlay');
      if (overlay) overlay.classList.remove('active');
      document.body.style.overflow = '';
      if (markSeen) markOnboardingSeen(homeOnboardingUserId);
    }

    function attachHomeOnboardingEvents() {
      const steps = getHomeOnboardingSteps();
      const skipBtn = document.getElementById('homeOnboardingSkipBtn');
      const backBtn = document.getElementById('homeOnboardingBackBtn');
      const nextBtn = document.getElementById('homeOnboardingNextBtn');
      const tryBtn = document.getElementById('homeOnboardingTryBtn');
      if (!skipBtn || !backBtn || !nextBtn || !tryBtn) return;

      skipBtn.onclick = () => closeHomeOnboarding(true);
      backBtn.onclick = () => {
        homeOnboardingIndex = Math.max(0, homeOnboardingIndex - 1);
        renderHomeOnboardingStep();
      };
      nextBtn.onclick = () => {
        if (homeOnboardingIndex >= steps.length - 1) {
          closeHomeOnboarding(true);
          showHomeToast('Tour completed. You can start saving now.');
          return;
        }
        homeOnboardingIndex += 1;
        renderHomeOnboardingStep();
      };
      tryBtn.onclick = () => {
        const current = steps[homeOnboardingIndex];
        if (!current || typeof current.action !== 'function') return;
        current.action();
      };
    }

    function maybeShowHomeOnboarding() {
      const userId = homeCurrentUser?.id;
      if (!userId || hasSeenOnboarding(userId)) return;
      homeOnboardingUserId = userId;
      homeOnboardingIndex = 0;
      ensureHomeOnboardingUi();
      attachHomeOnboardingEvents();
      renderHomeOnboardingStep();
      const overlay = document.getElementById('homeOnboardingOverlay');
      if (overlay) overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    async function loadRestaurants() {
      const client = await ensureHomeSupabase();
      if (!client) {
        return FALLBACK_RESTAURANTS.map((r) => ({
          mediaType: 'restaurant',
          itemId: String(r.id),
          title: r.name,
          subtitle: `${r.category} | ${r.rating}/5`,
          image: '',
          logo: '',
          backgroundImage: '',
          spotlightImage: '',
          spotlightMediaImage: '',
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          href: 'restraunts.html'
        }));
      }
      const fetchLimit = Math.max(HOME_CHANNEL_TARGET_ITEMS * 3, HOME_CHANNEL_TARGET_ITEMS);
      const { data, error } = await client
        .from('restraunts')
        .select('id,name,image,category,rating,slug,logo_url')
        .order('rating', { ascending: false })
        .limit(fetchLimit);
      if (error || !data || !data.length) {
        return FALLBACK_RESTAURANTS.map((r) => ({
          mediaType: 'restaurant',
          itemId: String(r.id),
          title: r.name,
          subtitle: `${r.category} | ${r.rating}/5`,
          image: '',
          logo: '',
          backgroundImage: '',
          spotlightImage: '',
          spotlightMediaImage: '',
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          href: 'restraunts.html'
        }));
      }

      const selectedRows = shuffleArray(data).slice(0, HOME_CHANNEL_TARGET_ITEMS);
      const slugs = selectedRows.map((row) => String(row.slug || '').trim()).filter(Boolean);
      const galleryBySlug = {};
      if (slugs.length) {
        const { data: galleryRows } = await client
          .from('restaurant_gallery')
          .select('restaurant_slug, image_url, image_type')
          .in('restaurant_slug', slugs);
        if (Array.isArray(galleryRows)) {
          galleryRows.forEach((row) => {
            const slug = String(row.restaurant_slug || '').trim();
            const url = String(row.image_url || '').trim();
            const imageType = String(row.image_type || '').trim().toLowerCase();
            if (!slug || !url) return;
            if (!galleryBySlug[slug]) {
              galleryBySlug[slug] = {
                cover: '',
                logo: ''
              };
            }
            if (imageType === 'cover' && !galleryBySlug[slug].cover) {
              galleryBySlug[slug].cover = toHttpsUrl(url);
            } else if (imageType === 'logo' && !galleryBySlug[slug].logo) {
              galleryBySlug[slug].logo = toHttpsUrl(url);
            }
          });
        }
      }

      return selectedRows.map((r) => {
        const coverImage = galleryBySlug[r.slug]?.cover || resolveRestaurantImage(r.image);
        const logoImage = galleryBySlug[r.slug]?.logo || resolveRestaurantImage(r.logo_url);
        const hasLogo = String(logoImage || '').trim().length > 0;
        return {
          mediaType: 'restaurant',
          itemId: String(r.id || ''),
          title: r.name || 'Restaurant',
          subtitle: `${r.category || 'Restaurant'}${r.rating ? ` | ${r.rating}/5` : ''}`,
          image: coverImage || logoImage || '',
          logo: logoImage || '',
          backgroundImage: coverImage || '',
          spotlightImage: coverImage || '',
          spotlightMediaImage: hasLogo ? logoImage : (coverImage || ''),
          spotlightMediaFit: hasLogo ? 'contain' : 'cover',
          spotlightMediaShape: hasLogo ? 'square' : 'poster',
          href: r.id ? `restaurant.html?id=${encodeURIComponent(r.id)}` : 'restraunts.html'
        };
      });
    }

    async function loadMovies() {
      const sourceBuilders = shuffleArray([
        () => `https://api.themoviedb.org/3/movie/popular?language=en-US&page=${randomInt(1, 5)}`,
        () => `https://api.themoviedb.org/3/movie/top_rated?language=en-US&page=${randomInt(1, 5)}`,
        () => `https://api.themoviedb.org/3/movie/now_playing?language=en-US&page=${randomInt(1, 4)}`,
        () => `https://api.themoviedb.org/3/trending/movie/week?page=${randomInt(1, 3)}`
      ]).slice(0, 3);
      const batches = await Promise.all(sourceBuilders.map(async (buildUrl) => {
        try {
          const res = await fetch(buildUrl(), {
            headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
          });
          if (!res.ok) return [];
          const json = await res.json();
          return Array.isArray(json.results) ? json.results : [];
        } catch (_err) {
          return [];
        }
      }));
      const collected = shuffleArray(batches.flat());
      const seen = new Set();
      const results = [];
      for (const item of collected) {
        const key = String(item?.id || '').trim();
        if (!key || seen.has(key)) continue;
        if (!item?.poster_path && !item?.backdrop_path) continue;
        seen.add(key);
        results.push(item);
        if (results.length >= HOME_CHANNEL_TARGET_ITEMS) break;
      }
      return results.map(m => ({
        mediaType: 'movie',
        itemId: String(m.id || ''),
        title: m.title || 'Movie',
        subtitle: m.release_date ? m.release_date.slice(0, 4) : 'Movie',
        image: m.poster_path ? `${TMDB_POSTER}${m.poster_path}` : '',
        backgroundImage: m.backdrop_path ? `${TMDB_BACKDROP}${m.backdrop_path}` : '',
        spotlightImage: m.backdrop_path ? `${TMDB_BACKDROP}${m.backdrop_path}` : '',
        spotlightMediaImage: m.poster_path ? `${TMDB_SPOT_POSTER}${m.poster_path}` : (m.backdrop_path ? `${TMDB_BACKDROP}${m.backdrop_path}` : ''),
        spotlightMediaFit: 'contain',
        spotlightMediaShape: 'poster',
        href: m.id ? `movie.html?id=${encodeURIComponent(m.id)}` : 'movies.html'
      }));
    }

    async function loadTv() {
      const sourceBuilders = shuffleArray([
        () => `https://api.themoviedb.org/3/tv/popular?language=en-US&page=${randomInt(1, 5)}`,
        () => `https://api.themoviedb.org/3/tv/top_rated?language=en-US&page=${randomInt(1, 5)}`,
        () => `https://api.themoviedb.org/3/tv/airing_today?language=en-US&page=${randomInt(1, 4)}`,
        () => `https://api.themoviedb.org/3/trending/tv/week?page=${randomInt(1, 3)}`
      ]).slice(0, 3);
      const batches = await Promise.all(sourceBuilders.map(async (buildUrl) => {
        try {
          const res = await fetch(buildUrl(), {
            headers: { Authorization: `Bearer ${TMDB_TOKEN}` }
          });
          if (!res.ok) return [];
          const json = await res.json();
          return Array.isArray(json.results) ? json.results : [];
        } catch (_err) {
          return [];
        }
      }));
      const collected = shuffleArray(batches.flat());
      const seen = new Set();
      const results = [];
      for (const item of collected) {
        const key = String(item?.id || '').trim();
        if (!key || seen.has(key)) continue;
        if (!item?.poster_path && !item?.backdrop_path) continue;
        seen.add(key);
        results.push(item);
        if (results.length >= HOME_CHANNEL_TARGET_ITEMS) break;
      }
      return results.map(t => ({
        mediaType: 'tv',
        itemId: String(t.id || ''),
        title: t.name || 'TV Show',
        subtitle: t.first_air_date ? t.first_air_date.slice(0, 4) : 'TV Show',
        image: t.poster_path ? `${TMDB_POSTER}${t.poster_path}` : '',
        backgroundImage: t.backdrop_path ? `${TMDB_BACKDROP}${t.backdrop_path}` : '',
        spotlightImage: t.backdrop_path ? `${TMDB_BACKDROP}${t.backdrop_path}` : '',
        spotlightMediaImage: t.poster_path ? `${TMDB_SPOT_POSTER}${t.poster_path}` : (t.backdrop_path ? `${TMDB_BACKDROP}${t.backdrop_path}` : ''),
        spotlightMediaFit: 'contain',
        spotlightMediaShape: 'poster',
        href: t.id ? `tvshow.html?id=${encodeURIComponent(t.id)}` : 'tvshows.html'
      }));
    }

    async function loadGames() {
      const orderings = shuffleArray(['-added', '-rating', '-released', '-metacritic']).slice(0, 3);
      const batches = await Promise.all(orderings.map(async (ordering, index) => {
        const dateRange = index % 2 === 0 ? '2010-01-01,2026-12-31' : '2000-01-01,2026-12-31';
        const page = randomInt(1, 2);
        try {
          const json = await homeIgdbFetch('/games', {
            page_size: 40,
            ordering,
            dates: dateRange,
            page
          });
          if (Array.isArray(json?.results)) return json.results;
          if (Array.isArray(json)) return json;
          return [];
        } catch (_err) {
          return [];
        }
      }));
      const results = shuffleArray(batches.flat());

      const seen = new Set();
      const candidates = [];
      for (const g of results) {
        const idKey = String(g.id || '').trim();
        const nameKey = String(g.name || '').trim().toLowerCase();
        if (!idKey || !nameKey || seen.has(idKey)) continue;
        if (!g.cover) continue;
        seen.add(idKey);
        candidates.push(g);
      }

      const filtered = candidates.slice(0, HOME_CHANNEL_TARGET_ITEMS);

      return filtered.map((g) => {
        const coverImage = String(g.cover || '').trim();
        const heroImage = String(g.hero || '').trim();
        const backgroundImage = heroImage || coverImage || '';
        const mainImage = coverImage || '';
        return {
          mediaType: 'game',
          itemId: String(g.id || ''),
          title: g.name || 'Game',
          subtitle: g.released ? g.released.slice(0, 4) : 'Game',
          extra: `${Array.isArray(g.genres) && g.genres.length ? g.genres.slice(0, 2).map(x => x?.name).filter(Boolean).join(' | ') : 'Video Game'}${g.rating ? ` | ${Number(g.rating).toFixed(1)}/5` : ''}`,
          image: coverImage,
          backgroundImage,
          spotlightImage: backgroundImage || coverImage,
          spotlightMediaImage: coverImage,
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          href: g.id ? `game.html?id=${encodeURIComponent(g.id)}` : 'games.html'
        };
      });
    }

    async function loadBooks() {
      // Keep to one request to avoid hitting Google Books 429 rate limits.
      try {
        const topic = shuffleArray(POPULAR_BOOK_QUERIES)[0];
        const orderBy = 'relevance';
        const startIndex = randomInt(0, 6) * 20;
        const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(topic)}&orderBy=${orderBy}&maxResults=40&startIndex=${startIndex}&printType=books&langRestrict=en&key=${GOOGLE_BOOKS_KEY}`;
        const res = await fetch(url);
        if (res.ok) {
          const json = await res.json();
          const items = Array.isArray(json.items) ? json.items : [];
          const seenTitles = new Set();
          const mapped = shuffleArray(items).map((item) => {
            const info = item.volumeInfo || {};
            const title = String(info.title || '').trim();
            if (!title) return null;
            const ratingsCount = Number(info.ratingsCount || 0);
            if (Number.isFinite(ratingsCount) && ratingsCount > 0 && ratingsCount < 10) return null;
            const titleKey = title.toLowerCase();
            if (seenTitles.has(titleKey)) return null;
            seenTitles.add(titleKey);
            const author = Array.isArray(info.authors) && info.authors.length ? info.authors[0] : 'Book';
            const identifiers = Array.isArray(info.industryIdentifiers) ? info.industryIdentifiers : [];
            const rawIsbn =
              identifiers.find((id) => String(id?.type || '') === 'ISBN_13')?.identifier ||
              identifiers.find((id) => String(id?.type || '') === 'ISBN_10')?.identifier ||
              '';
            const isbn = String(rawIsbn || '').replace(/[^0-9Xx]/g, '').trim();
            const fallbackImage = isbn
              ? `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(isbn)}-L.jpg`
              : 'images/logo.png';
            const primaryImage = toHttpsUrl(info.imageLinks?.thumbnail || info.imageLinks?.smallThumbnail || '') || fallbackImage;
            return {
              mediaType: 'book',
              itemId: String(item.id || ''),
              title,
              subtitle: author,
              image: primaryImage,
              backgroundImage: primaryImage,
              spotlightImage: primaryImage,
              spotlightMediaImage: primaryImage,
              spotlightMediaFit: 'contain',
              spotlightMediaShape: 'poster',
              fallbackImage,
              isbn,
              href: item.id ? `book.html?id=${encodeURIComponent(item.id)}` : 'books.html'
            };
          }).filter(Boolean);
          const fallbackKnown = FALLBACK_BOOKS.map((b, idx) => ({
            mediaType: 'book',
            itemId: `known-book-${idx}`,
            title: b.title,
            subtitle: b.author,
            image: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
            backgroundImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
            spotlightImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
            spotlightMediaImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
            spotlightMediaFit: 'contain',
            spotlightMediaShape: 'poster',
            fallbackImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
            isbn: b.isbn,
            href: 'books.html'
          }));

          const merged = [...mapped, ...fallbackKnown];
          const deduped = [];
          const seen = new Set();
          merged.forEach((entry) => {
            const key = String(entry.title || '').trim().toLowerCase();
            if (!key || seen.has(key)) return;
            seen.add(key);
            deduped.push(entry);
          });
          if (deduped.length) return deduped.slice(0, HOME_CHANNEL_TARGET_ITEMS);
        }
      } catch (_e) {}

      return shuffleArray(FALLBACK_BOOKS).slice(0, HOME_CHANNEL_TARGET_ITEMS).map((b, idx) => ({
        mediaType: 'book',
        itemId: `fallback-book-${idx}`,
        title: b.title,
        subtitle: b.author,
        image: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        backgroundImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        spotlightImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        spotlightMediaImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        spotlightMediaFit: 'contain',
        spotlightMediaShape: 'poster',
        fallbackImage: `https://covers.openlibrary.org/b/isbn/${encodeURIComponent(b.isbn)}-L.jpg`,
        isbn: b.isbn,
        href: 'books.html'
      }));
    }

    async function loadMusic() {
      try {
        const query = shuffleArray(POPULAR_MUSIC_QUERIES)[0] || 'top hits';
        const limit = Math.max(HOME_CHANNEL_TARGET_ITEMS, 24);
        const url = `/api/music/search?q=${encodeURIComponent(query)}&limit=${limit}&market=US`;
        const res = await fetch(url);
        if (!res.ok) return [];
        const json = await res.json();
        const rows = Array.isArray(json.results) ? json.results : [];
        const seen = new Set();
        const deduped = [];
        rows.forEach((row) => {
          const id = String(row.id || '').trim();
          if (!id || seen.has(id)) return;
          seen.add(id);
          deduped.push(row);
        });
        return deduped.slice(0, HOME_CHANNEL_TARGET_ITEMS).map((track) => {
          const artists = Array.isArray(track.artists) ? track.artists.filter(Boolean).join(', ') : 'Artist';
          const albumName = String(track.album?.name || 'Album').trim();
          const popularity = Number(track.popularity || 0);
          return {
            mediaType: 'music',
            itemId: String(track.id || ''),
            title: track.name || 'Track',
            subtitle: artists || 'Artist',
            extra: `${albumName}${popularity ? ` | Popularity ${popularity}/100` : ''}`,
            image: String(track.image || '').trim(),
            backgroundImage: String(track.image || '').trim(),
            spotlightImage: String(track.image || '').trim(),
            spotlightMediaImage: String(track.image || '').trim(),
            spotlightMediaFit: 'cover',
            spotlightMediaShape: 'square',
            href: String(track.id || '').trim() ? `song.html?id=${encodeURIComponent(track.id)}` : 'music.html'
          };
        });
      } catch (_err) {
        return [];
      }
    }

    async function initUniversalHome() {
      setStatus('Loading spotlight and live feed...', false);
      resetSpotlightTimer(false);
      const channels = getHomeChannels();
      const cachedFeed = readHomeFeedCache();
      const baselineFeed = cachedFeed || null;

      if (baselineFeed) {
        const cachedResult = applyHomeFeedMap(baselineFeed);
        if (cachedResult.scoredPool.length) {
          setStatus(cachedFeed ? 'Feed ready from cache. Syncing live data...' : 'Feed ready. Syncing live data...', false);
        }
      }

      const tastePromise = loadTasteWeights().catch(() => homeTasteWeights);
      const loaded = await Promise.all(channels.map(async (channel) => {
        const firstPass = await loadHomeChannelWithTimeout(channel.loader);
        if (firstPass.length) {
          return { ...channel, items: firstPass };
        }
        // One retry without timeout race to improve reliability on slower APIs.
        try {
          const retryItems = await Promise.resolve().then(() => channel.loader());
          return { ...channel, items: Array.isArray(retryItems) ? retryItems : [] };
        } catch (_err) {
          return { ...channel, items: [] };
        }
      }));
      homeTasteWeights = await tastePromise;

      const mergedFeed = {};
      loaded.forEach((channel) => {
        const freshItems = Array.isArray(channel.items) ? channel.items : [];
        const cachedItems = Array.isArray(baselineFeed?.[channel.key]) ? baselineFeed[channel.key] : [];
        mergedFeed[channel.key] = freshItems.length ? freshItems : cachedItems;
      });

      const { scoredPool, channelsCount } = applyHomeFeedMap(mergedFeed);

      if (!scoredPool.length) {
        homeSpotlightItems = [{
          mediaType: 'movie',
          title: 'No live spotlight yet',
          subtitle: 'We are refreshing your feed',
          extra: 'Try again in a moment.',
          image: '',
          spotlightImage: '',
          spotlightMediaImage: '',
          spotlightMediaFit: 'contain',
          spotlightMediaShape: 'poster',
          href: 'movies.html',
          discoveryScore: 0.5
        }];
        showSpotlightByIndex(0, false);
        resetSpotlightTimer(false);
        setStatus('Could not load live feeds right now. Try again shortly.', true);
        return;
      }

      const freshActiveChannels = loaded.filter((channel) => Array.isArray(channel.items) && channel.items.length).length;
      if (freshActiveChannels > 0) {
        writeHomeFeedCache(mergedFeed);
      }
      if (freshActiveChannels === channelsCount) {
        setStatus(`Live feed ready. ${freshActiveChannels}/${channelsCount} channels live.`, false);
      } else if (freshActiveChannels === 0) {
        if (cachedFeed) {
          setStatus('Feed loaded from cache. Live sources are slow right now.', false);
        } else {
          setStatus('Showing quick feed while live sources connect...', false);
        }
      } else {
        setStatus(`Live feed ready. ${freshActiveChannels}/${channelsCount} channels live (fallback used for slower channels).`, false);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      void initUniversalHome();

      void (async () => {
        await setupHomeAuthListener();
        await completeHomeOAuthReturnIfNeeded();
        await initAuthUi();
        maybeShowHomeOnboarding();
        await refreshHomePersonalization();
      })();

      const closeListsBtn = document.getElementById('closeHomeListsBtn');
      const saveListsBtn = document.getElementById('saveHomeListsBtn');
      const createListBtn = document.getElementById('createHomeListBtn');
      const iconOptions = document.querySelectorAll('#homeListIconOptions .icon-option');
      const modal = document.getElementById('homeListsModal');
      const nextSpotlightBtn = document.getElementById('spotlightNextBtn');

      if (closeListsBtn) closeListsBtn.addEventListener('click', closeHomeListsModal);
      if (saveListsBtn) saveListsBtn.addEventListener('click', saveHomeListChanges);
      if (createListBtn) createListBtn.addEventListener('click', createHomeList);

      iconOptions.forEach(btn => {
        btn.addEventListener('click', () => {
          iconOptions.forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          homeCustomListState.selectedIcon = btn.getAttribute('data-icon') || 'fas fa-list';
        });
      });

      if (nextSpotlightBtn) {
        nextSpotlightBtn.addEventListener('click', () => {
          showSpotlightByIndex(homeSpotlightIndex + 1, true);
          resetSpotlightTimer(true);
        });
      }

      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeHomeListsModal();
        });
      }

      if (window.initUniversalSearch) {
        window.initUniversalSearch({
          input: '#globalSearch',
          fallbackRoute: 'restraunts.html'
        });
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAllRailMenus();
          closeHomeListsModal();
        }
      });

      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          resetSpotlightTimer(false);
        } else {
          resetSpotlightTimer(true);
        }
      });
    });
  </script>
</body>
</html>
