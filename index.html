<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Zo2y ‚Äî Discover Local Favorites</title>

    <!-- OPTIMIZATION 1: Preconnect to external resources -->
    <link rel="preconnect" href="https://gfkhjbztayjyojsgdpgk.supabase.co" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    
    <!-- Favicon for all devices -->
    <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon">
    <link rel="shortcut icon" href="/favicon.ico?v=3" type="image/x-icon">
    
    <!-- For modern browsers -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=3">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=3">
    
    <!-- For Apple devices -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=3">
    
    <!-- For Windows Metro -->
    <meta name="msapplication-TileColor" content="#0b1633">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png?v=3">
    <meta name="theme-color" content="#0b1633">
    
    <!-- Safari pinned tab -->
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=3" color="#f59e0b">

    <!-- Search Engine Optimization -->
    <meta name="description" content="Discover hidden gems and local favorite restaurants based on authentic reviews from the food lover community.">
    <meta name="keywords" content="restaurants, food, dining, reviews, local favorites, food discovery">
    <meta name="author" content="Zo2y">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.zo2y.com/">
    <meta property="og:title" content="Zo2y ‚Äî Discover Local Favorites">
    <meta property="og:description" content="Find authentic dining experiences based on real reviews from the food lover community.">
    <meta property="og:image" content="https://www.zo2y.com/images/logo.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Zo2y Logo">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.zo2y.com/">
    <meta property="twitter:title" content="Zo2y ‚Äî Discover Local Favorites">
    <meta property="twitter:description" content="Find authentic dining experiences based on real reviews from the food lover community.">
    <meta property="twitter:image" content="https://www.zo2y.com/images/logo.png">
    <meta property="twitter:image:alt" content="Zo2y Logo">

    <!-- OPTIMIZATION 2: Load Supabase BEFORE other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ALL THE SAME CSS AS BEFORE - KEEP THIS PART EXACTLY AS IN YOUR ORIGINAL */
        :root { 
            --bg: #0b1633; 
            --card: #132347; 
            --muted: #8ca3c7; 
            --accent: #f59e0b; 
            --glass: rgba(255,255,255,0.03); 
            --white: #ffffff; 
            --border: rgba(255,255,255,0.1);
            --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --success: #10b981; 
            --error: #ef4444; 
            --info: #3b82f6;
            --surface: rgba(19, 35, 71, 0.6);
            --cloud-color: #3b82f6;
            --radial-glow: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--white); line-height: 1.6; overflow-x: hidden; }
        a { color: inherit; text-decoration: none; }
        img { display: block; max-width: 100%; height: auto; }
        
        /* ALL OTHER CSS RULES REMAIN EXACTLY THE SAME */
        /* ... [KEEP ALL YOUR EXISTING CSS HERE] ... */
        
    </style>
</head>
<body>
    <!-- ALL YOUR HTML CONTENT REMAINS EXACTLY THE SAME -->
    <!-- Guest Banner -->
    <div id="guestBanner" class="guest-banner">
        <div class="banner-content">
            <span class="banner-text">Want to save your favorite restaurants?</span>
            <div class="banner-actions">
                <button class="banner-btn banner-btn-outline" id="bannerLoginBtn">Sign In</button>
                <button class="banner-btn banner-btn-primary" id="bannerSignupBtn">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Enhanced Header with Mobile Layout -->
    <header class="nav" role="banner">
        <div class="nav-container">
            <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'">
            
            <!-- Mobile Search Toggle Button -->
            <button class="mobile-search-toggle" id="mobileSearchToggle" aria-label="Toggle search">
                <i class="fas fa-search"></i>
            </button>
            
            <div class="search-wrapper" id="searchWrapper">
                <div class="search-container">
                    <span class="search-icon">üîé</span>
                    <input type="text" id="search" class="search" placeholder="Search restaurants..." aria-label="Search restaurants">
                    <button class="clear-search" id="clearSearch" aria-label="Clear search">‚úï</button>
                    
                    <!-- Search Dropdown -->
                    <div class="search-dropdown" id="searchDropdown"></div>
                </div>
            </div>
            
            <div class="nav-right">
                <a class="ghost" href="restraunts.html">Explore All</a>
                <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero" aria-labelledby="heroTitle">
        <div class="hero-container">
            <div class="hero-left">
                <div class="tag">Trusted by Food Lovers</div>
                <h1 id="heroTitle">Discover Hidden Gems & Local Favorites</h1>
                <p class="lead">Find authentic dining experiences based on real reviews from the food lover community.</p>
                <div class="cta-row">
                    <button class="btn-primary logged-out" id="startJourneyBtn">
                        <i class="fas fa-map-signs"></i>
                        <span>Start Your Food Journey</span>
                    </button>
                    
                    <button class="btn-primary logged-in" onclick="location.href='restraunts.html'" style="display: none;">
                        <i class="fas fa-utensils"></i>
                        <span>Explore All Restaurants</span>
                    </button>
                </div>
            </div>
            <div class="hero-right">
                <div class="spotlight-wrapper">
                    <div class="spotlight" id="spotlightCard" role="region" aria-live="polite">
                        <div class="spotlight-img-container">
                            <img id="spotFoodImage" class="spotlight-food-image" src="" alt="Featured restaurant food" fetchpriority="high">
                            <div class="spotlight-logo-overlay" id="spotLogoOverlay">
                                <img id="spotLogo" src="" alt="Restaurant logo">
                            </div>
                        </div>
                        <div class="spotlight-content">
                            <div class="spotlight-text">
                                <h3 id="spotName">Loading...</h3>
                                <p id="spotDesc">Loading restaurant details...</p>
                                <div class="rating" id="spotRating">‚≠ê ...</div>
                            </div>
                            <div class="spotlight-actions">
                                <button class="btn-outline" id="spotlightViewBtn" style="padding:8px 16px; font-size:13px">View Details</button>
                            </div>
                        </div>
                    </div>
                    <div class="slide-indicators" id="slideIndicators"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Container -->
    <main>
        <!-- Featured Restaurants -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2>Featured Restaurants</h2>
                    <p class="section-subtitle">Handpicked selections based on quality and authenticity</p>
                </div>
                <a href="restraunts.html" class="view-all">View All <span>‚Üí</span></a>
            </div>
            
            <div class="filter-bar" id="filterBar">
                <!-- Filters will be populated dynamically -->
            </div>
            
            <div class="slider-container">
                <div id="featuredSlider" class="slider-grid skeleton-grid">
                    <!-- Skeleton loading -->
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                </div>
            </div>
            
            <div class="load-more-container">
                <button class="load-more-btn" onclick="location.href='restraunts.html'">
                    <i class="fas fa-arrow-right"></i>
                    View All Restaurants
                </button>
            </div>
        </section>

        <!-- Nearby Restaurants -->
        <section class="section">
            <div class="section-header">
                <div>
                    <h2>Nearby Restaurants</h2>
                    <p class="section-subtitle">Great food close to you</p>
                </div>
            </div>
            
            <div class="slider-container">
                <div id="nearbySlider" class="slider-grid skeleton-grid">
                    <!-- Skeleton loading -->
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                    <div class="skeleton-card"><div class="skeleton-image"></div><div class="skeleton-content"><div class="skeleton-line" style="width: 70%"></div><div class="skeleton-line short"></div></div></div>
                </div>
            </div>
            
            <div class="load-more-container">
                <button class="load-more-btn" onclick="location.href='restraunts.html'">
                    <i class="fas fa-arrow-right"></i>
                    View All Restaurants
                </button>
            </div>
        </section>

        <!-- REDESIGNED Restaurant of the Day -->
        <section class="section">
            <div class="restaurant-of-day">
                <div class="day-header">
                    <h2>Restaurant of the Day</h2>
                    <p>Our specially selected restaurant that stands out from the rest.</p>
                </div>
                <div class="day-card-container">
                    <div id="dayCard" class="day-card">
                        <div class="skeleton-card" style="width:100%; height:400px;">
                            <div class="skeleton-image" style="height:250px"></div>
                            <div class="skeleton-content">
                                <div class="skeleton-line" style="width: 70%"></div>
                                <div class="skeleton-line short"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- App Download -->
        <section class="section">
            <div class="app-download">
                <h2>Get the Zo2y App</h2>
                <p>Discover restaurants, save your favorites, and share reviews on the go.</p>
                <div class="app-buttons">
                    <a href="#" class="app-button" id="iosAppButton">
                        <i class="fab fa-apple"></i>
                        <div class="app-button-text"><span>Download on the</span><br><span>App Store</span></div>
                    </a>
                    <a href="#" class="app-button" id="androidAppButton">
                        <i class="fab fa-google-play"></i>
                        <div class="app-button-text"><span>Get it on</span><br><span>Google Play</span></div>
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>Explore</h3>
                <a href="restraunts.html">All Restaurants</a>
                <a href="categories.html">By Category</a>
                <a href="#" id="searchFooterLink">Search</a>
            </div>
            <div class="footer-column">
                <h3>Community</h3>
                <a href="blog.html">Food Blog</a>
                <a href="guides.html">Neighborhood Guides</a>
                <a href="#" id="featuredLink">Featured</a>
            </div>
            <div class="footer-column">
                <h3>Business</h3>
                <a href="add-restaurant.html">Add Your Restaurant</a>
                <a href="partners.html">Partnerships</a>
                <a href="contact.html">Contact Us</a>
            </div>
            <div class="footer-column">
                <h3>Support</h3>
                <a href="about.html">About Zo2y</a>
                <a href="help.html">Help Center</a>
                <a href="terms.html">Terms & Privacy</a>
            </div>
        </div>
        <div class="footer-bottom">
            <div style="margin-bottom:8px">¬© 2025 Zo2y ‚Äî Built with ‚ù§Ô∏è for food lovers</div>
            <div style="font-size:12px; color:var(--muted)">Join thousands discovering authentic dining experiences</div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="actionsModal" class="actions-modal">
        <div class="actions-content">
            <div class="actions-header">
                <h3 id="modalRestaurantName">Restaurant Name</h3>
                <p>Add this restaurant to your lists</p>
            </div>
            <div class="action-buttons">
                <button class="action-btn-modal" data-action="favorites" id="modalFavoritesBtn">
                    <i class="fas fa-heart"></i>
                    <span id="favoritesText">Add to Favorites</span>
                </button>
                <button class="action-btn-modal" data-action="wantToGo" id="modalWantToGoBtn">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="wantToGoText">Want to Go</span>
                </button>
                <button class="action-btn-modal" data-action="visited" id="modalVisitedBtn">
                    <i class="fas fa-utensils"></i>
                    <span id="visitedText">Mark as Visited</span>
                </button>
                <button class="action-btn-modal custom-lists-btn" id="modalCustomListsBtn">
                    <i class="fas fa-list"></i>
                    <span>Custom Lists</span>
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button class="cancel-btn" id="modalCancelBtn">Cancel</button>
        </div>
    </div>

    <div id="customListsModal" class="custom-lists-modal">
        <div class="custom-lists-content">
            <div class="lists-header">
                <h3><i class="fas fa-list"></i> Custom Lists</h3>
                <button class="close-lists-btn" id="closeListsBtn">√ó</button>
            </div>
            
            <div class="lists-list-container" id="listsListContainer">
                <!-- Lists will be populated here -->
            </div>
            
            <div class="new-list-section">
                <div class="new-list-input">
                    <input type="text" id="newListName" placeholder="Enter new list name..." maxlength="50">
                    <button class="create-list-btn" id="createListBtn">
                        <i class="fas fa-plus"></i> Create
                    </button>
                </div>
                <div class="lists-actions">
                    <button class="lists-save-btn" id="saveListsBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div id="authPromptModal" class="auth-prompt-modal">
        <div class="auth-prompt-content">
            <div class="auth-prompt-icon">
                <i class="fas fa-lock"></i>
            </div>
            <div class="auth-prompt-header">
                <h3>Sign In Required</h3>
                <p>You need to be signed in to save restaurants to your lists. Create an account to save your favorites, mark places you want to visit, and track where you've been!</p>
            </div>
            <div class="auth-prompt-buttons">
                <button class="auth-prompt-btn auth-prompt-primary" id="authPromptSignupBtn">
                    <i class="fas fa-user-plus"></i>
                    Create Free Account
                </button>
                <button class="auth-prompt-btn auth-prompt-secondary" id="authPromptLoginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In to Existing Account
                </button>
            </div>
            <button class="auth-prompt-close" id="authPromptCloseBtn">Maybe Later</button>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>

    <script>
        // Wait for Supabase to load before initializing
        function waitForSupabase(callback) {
            if (window.supabase && window.supabase.createClient) {
                callback();
            } else {
                setTimeout(() => waitForSupabase(callback), 100);
            }
        }

        // Start initialization when Supabase is ready
        waitForSupabase(function() {
            (function() {
                'use strict';
                
                // ---------- CONFIG ----------
                const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
                
                // Initialize Supabase with PKCE flow
                const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        flowType: 'pkce',
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: true
                    }
                });
                
                // ---------- GLOBAL STATE ----------
                const state = {
                    restaurants: [],
                    categories: new Map(),
                    cloudKitchens: new Set(),
                    isLoggedIn: false,
                    restaurantImages: new Map(),
                    spotlightIndex: 0,
                    spotlightRestaurants: [],
                    imageObserver: null,
                    currentUser: null,
                    searchData: [],
                    listManager: {
                        userLists: [],
                        currentLists: {
                            favorites: null,
                            visited: null,
                            wantToGo: null
                        },
                        
                        async init() { 
                            if (!state.isLoggedIn || !state.currentUser) return;
                            
                            await this.loadUserLists();
                        },
                        
                        async loadUserLists() {
                            try {
                                if (!state.currentUser) return;

                                const { data: lists, error } = await supabase
                                    .from('lists')
                                    .select('*')
                                    .eq('user_id', state.currentUser.id);
                                
                                if (error) throw error;
                                
                                this.userLists = lists || [];
                                await this.setupDefaultLists();
                                await this.loadListRestaurants();
                                
                            } catch (error) {
                                console.error('Error loading lists:', error);
                            }
                        },
                        
                        async setupDefaultLists() {
                            if (!state.currentUser) return;
                            
                            this.currentLists.favorites = this.userLists.find(list => list.title === 'Favorites');
                            this.currentLists.visited = this.userLists.find(list => list.title === 'Visited'); 
                            this.currentLists.wantToGo = this.userLists.find(list => list.title === 'Want to Go');
                            
                            if (!this.currentLists.favorites) {
                                this.currentLists.favorites = await this.createList('Favorites', 'My favorite restaurants');
                            }
                            if (!this.currentLists.visited) {
                                this.currentLists.visited = await this.createList('Visited', 'Restaurants I have visited');
                            }
                            if (!this.currentLists.wantToGo) {
                                this.currentLists.wantToGo = await this.createList('Want to Go', 'Restaurants I want to try');
                            }
                        },
                        
                        async createList(title, description) {
                            if (!state.currentUser) return null;
                            
                            const { data: newList, error } = await supabase
                                .from('lists')
                                .insert([
                                    {
                                        user_id: state.currentUser.id,
                                        title: title,
                                        description: description
                                    }
                                ])
                                .select()
                                .single();
                            
                            if (error) {
                                console.error('Error creating list:', error);
                                return null;
                            }
                            
                            this.userLists.push(newList);
                            return newList;
                        },
                        
                        async loadListRestaurants() {
                            for (const listType in this.currentLists) {
                                const list = this.currentLists[listType];
                                if (list) {
                                    const { data: listRestaurants, error } = await supabase
                                        .from('lists_restraunts')
                                        .select('restraunt_id')
                                        .eq('list_id', list.id);
                                    
                                    if (!error && listRestaurants) {
                                        list.restaurants = listRestaurants.map(item => item.restraunt_id);
                                    } else {
                                        list.restaurants = [];
                                    }
                                }
                            }
                        },
                        
                        async toggleInList(listType, restaurantId) {
                            const list = this.currentLists[listType];
                            if (!list) return false;
                            
                            const isInList = list.restaurants?.includes(restaurantId);
                            
                            try {
                                if (isInList) {
                                    const { error } = await supabase
                                        .from('lists_restraunts')
                                        .delete()
                                        .match({
                                            list_id: list.id,
                                            restraunt_id: restaurantId
                                        });
                                    
                                    if (error) throw error;
                                    
                                    list.restaurants = list.restaurants.filter(id => id !== restaurantId);
                                    showNotification(`Removed from ${list.title}`, 'info');
                                    return false;
                                    
                                } else {
                                    const { error } = await supabase
                                        .from('lists_restraunts')
                                        .insert([
                                            {
                                                list_id: list.id,
                                                restraunt_id: restaurantId,
                                                added_at: new Date().toISOString()
                                            }
                                        ]);
                                    
                                    if (error) throw error;
                                    
                                    if (!list.restaurants) list.restaurants = [];
                                    list.restaurants.push(restaurantId);
                                    showNotification(`Added to ${list.title}`, 'success');
                                    return true;
                                }
                                
                            } catch (error) {
                                console.error('Error updating list:', error);
                                showNotification('Failed to update list', 'error');
                                return isInList;
                            }
                        },
                        
                        isInList(listType, restaurantId) {
                            const list = this.currentLists[listType];
                            return list?.restaurants?.includes(restaurantId) || false;
                        },
                        
                        getRestaurantListStatus(restaurantId) {
                            if (!state.isLoggedIn) {
                                return {
                                    favorites: false,
                                    wantToGo: false,
                                    visited: false
                                };
                            }
                            
                            return {
                                favorites: this.isInList('favorites', restaurantId),
                                wantToGo: this.isInList('wantToGo', restaurantId),
                                visited: this.isInList('visited', restaurantId)
                            };
                        }
                    }
                };
                
                // ---------- SEARCH FUNCTIONALITY WITH OPTIMIZATIONS ----------
                function setupSearch() {
                    const searchInput = document.getElementById('search');
                    const searchDropdown = document.getElementById('searchDropdown');
                    const clearSearchBtn = document.getElementById('clearSearch');
                    const mobileSearchToggle = document.getElementById('mobileSearchToggle');
                    const searchWrapper = document.getElementById('searchWrapper');
                    
                    if (!searchInput || !searchDropdown) return;
                    
                    let searchTimeout;
                    let searchResults = [];
                    let selectedResultIndex = -1;
                    
                    // Load search data in background
                    async function loadSearchData() {
                        try {
                            const { data, error } = await supabase
                                .from('restraunts')
                                .select('id, slug, name, category, rating, logo_url')
                                .order('name')
                                .limit(100);
                            
                            if (error) throw error;
                            return data || [];
                        } catch (error) {
                            console.error('Error loading search data:', error);
                            return [];
                        }
                    }
                    
                    // Initialize search data in background
                    setTimeout(() => {
                        loadSearchData().then(data => {
                            state.searchData = data;
                            console.log(`‚úÖ Loaded ${data.length} restaurants for search`);
                        });
                    }, 100);
                    
                    function performSearch(query) {
                        if (!query.trim() || state.searchData.length === 0) {
                            searchResults = [];
                            renderSearchResults([]);
                            searchDropdown.classList.remove('active');
                            return;
                        }
                        
                        const lowerQuery = query.toLowerCase().trim();
                        
                        const results = state.searchData.filter(restaurant => {
                            const nameMatch = restaurant.name?.toLowerCase().includes(lowerQuery);
                            const categoryMatch = restaurant.category?.toLowerCase().includes(lowerQuery);
                            return nameMatch || categoryMatch;
                        }).slice(0, 8);
                        
                        searchResults = results;
                        selectedResultIndex = -1;
                        
                        if (results.length > 0) {
                            renderSearchResults(results);
                            searchDropdown.classList.add('active');
                        } else {
                            renderNoResults();
                            searchDropdown.classList.add('active');
                        }
                    }
                    
                    // OPTIMIZED: Search logos load instantly
                    function renderSearchResults(results) {
                        searchDropdown.innerHTML = '';
                        
                        results.forEach((restaurant, index) => {
                            const resultItem = document.createElement('div');
                            resultItem.className = 'search-result-item';
                            resultItem.dataset.index = index;
                            resultItem.tabIndex = 0;
                            
                            const logoUrl = restaurant.logo_url || 'images/default-logo.jpg';
                            
                            // FIXED: Direct src loading, no lazy loading
                            resultItem.innerHTML = `
                                <div class="search-result-logo">
                                    <img src="${logoUrl}" alt="${restaurant.name} logo" loading="eager">
                                </div>
                                <div class="search-result-info">
                                    <div class="search-result-name">${restaurant.name}</div>
                                    <div class="search-result-category">
                                        <span>${restaurant.category || 'Restaurant'}</span>
                                    </div>
                                </div>
                                <div class="search-result-rating">
                                    <i class="fas fa-star"></i>
                                    ${restaurant.rating ? restaurant.rating.toFixed(1) : 'N/A'}
                                </div>
                            `;
                            
                            resultItem.addEventListener('click', () => {
                                selectRestaurant(restaurant);
                            });
                            
                            resultItem.addEventListener('keydown', (e) => {
                                if (e.key === 'Enter') {
                                    selectRestaurant(restaurant);
                                }
                            });
                            
                            searchDropdown.appendChild(resultItem);
                        });
                    }
                    
                    function renderNoResults() {
                        searchDropdown.innerHTML = `
                            <div class="no-results">
                                <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                                <p>No restaurants found</p>
                                <p style="font-size: 12px; margin-top: 5px; color: var(--muted);">Try different keywords</p>
                            </div>
                        `;
                    }
                    
                    function selectRestaurant(restaurant) {
                        if (restaurant && restaurant.slug) {
                            if (searchWrapper.classList.contains('active')) {
                                searchWrapper.classList.remove('active');
                                document.body.style.overflow = '';
                            }
                            
                            window.location.href = `restaurant.html?slug=${restaurant.slug}`;
                        }
                    }
                    
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value;
                        
                        if (clearSearchBtn) {
                            clearSearchBtn.style.display = query ? 'block' : 'none';
                        }
                        
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            performSearch(query);
                        }, 300);
                    });
                    
                    if (clearSearchBtn) {
                        clearSearchBtn.addEventListener('click', () => {
                            searchInput.value = '';
                            searchInput.focus();
                            clearSearchBtn.style.display = 'none';
                            searchDropdown.classList.remove('active');
                            searchResults = [];
                            selectedResultIndex = -1;
                        });
                    }
                    
                    searchInput.addEventListener('keydown', (e) => {
                        if (!searchDropdown.classList.contains('active')) return;
                        
                        switch (e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                navigateResults(1);
                                break;
                            case 'ArrowUp':
                                e.preventDefault();
                                navigateResults(-1);
                                break;
                            case 'Enter':
                                e.preventDefault();
                                if (selectedResultIndex >= 0 && searchResults[selectedResultIndex]) {
                                    selectRestaurant(searchResults[selectedResultIndex]);
                                }
                                break;
                            case 'Escape':
                                searchDropdown.classList.remove('active');
                                selectedResultIndex = -1;
                                break;
                        }
                    });
                    
                    function navigateResults(direction) {
                        if (searchResults.length === 0) return;
                        
                        const prevItem = searchDropdown.querySelector('.search-result-item.active');
                        if (prevItem) prevItem.classList.remove('active');
                        
                        selectedResultIndex += direction;
                        
                        if (selectedResultIndex < 0) {
                            selectedResultIndex = searchResults.length - 1;
                        } else if (selectedResultIndex >= searchResults.length) {
                            selectedResultIndex = 0;
                        }
                        
                        const currentItem = searchDropdown.querySelector(`.search-result-item[data-index="${selectedResultIndex}"]`);
                        if (currentItem) {
                            currentItem.classList.add('active');
                            currentItem.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                            searchInput.value = searchResults[selectedResultIndex].name;
                        }
                    }
                    
                    document.addEventListener('click', (e) => {
                        if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
                            searchDropdown.classList.remove('active');
                            selectedResultIndex = -1;
                        }
                    });
                    
                    if (mobileSearchToggle && searchWrapper) {
                        mobileSearchToggle.addEventListener('click', () => {
                            searchWrapper.classList.toggle('active');
                            
                            if (searchWrapper.classList.contains('active')) {
                                searchInput.focus();
                                document.body.style.overflow = 'hidden';
                            } else {
                                document.body.style.overflow = '';
                                searchDropdown.classList.remove('active');
                            }
                        });
                    }
                    
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && searchWrapper.classList.contains('active')) {
                            searchWrapper.classList.remove('active');
                            document.body.style.overflow = '';
                            searchDropdown.classList.remove('active');
                        }
                    });
                    
                    console.log('‚úÖ Search functionality initialized');
                }
                
                // ---------- OPTIMIZED INITIALIZATION ----------
                async function initializeAuth() {
                    console.log('üîê Initializing auth...');
                    
                    try {
                        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                        
                        if (sessionError) {
                            console.error('Session error:', sessionError);
                            setGuestState();
                            return;
                        }
                        
                        if (!session?.user) {
                            console.log('üë§ No active session, setting guest state');
                            setGuestState();
                            return;
                        }
                        
                        console.log('‚úÖ User found in session:', session.user.email);
                        state.currentUser = session.user;
                        state.isLoggedIn = true;
                        
                        const profileReady = await ensureUserProfileExists(session.user);
                        
                        if (profileReady) {
                            await state.listManager.init();
                            setLoggedInState(session.user);
                        } else {
                            setLoggedInState(session.user);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Auth initialization error:', error);
                        setGuestState();
                    }
                    
                    supabase.auth.onAuthStateChange(async (event, session) => {
                        console.log('üîÑ Auth state change:', event);
                        
                        if (event === 'SIGNED_OUT') {
                            state.currentUser = null;
                            state.isLoggedIn = false;
                            setGuestState();
                            guestBanner.show();
                            
                        } else if (event === 'SIGNED_IN' && session?.user) {
                            state.currentUser = session.user;
                            state.isLoggedIn = true;
                            
                            await ensureUserProfileExists(session.user);
                            await state.listManager.init();
                            setLoggedInState(session.user);
                        }
                    });
                }
                
                async function ensureUserProfileExists(user, retries = 3) {
                    console.log('üîç Ensuring profile exists for:', user.id);
                    
                    for (let attempt = 1; attempt <= retries; attempt++) {
                        console.log(`Attempt ${attempt}/${retries}`);
                        
                        try {
                            if (attempt > 1) {
                                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                            }
                            
                            const { data: profile, error: checkError } = await supabase
                                .from('user_profiles')
                                .select('id, username, full_name, avatar_icon')
                                .eq('id', user.id)
                                .maybeSingle();
                            
                            if (profile) {
                                console.log('‚úÖ Profile exists:', profile);
                                return true;
                            }
                            
                            if (checkError && checkError.code !== 'PGRST116') {
                                console.error('Profile check error:', checkError);
                            }
                            
                            console.log('üìù Creating profile for user...');
                            
                            const userData = user.user_metadata || {};
                            const email = user.email || '';
                            
                            let username = (
                                userData.full_name || 
                                userData.name || 
                                email.split('@')[0] || 
                                'user'
                            ).toLowerCase()
                              .replace(/\s+/g, '_')
                              .replace(/[^a-z0-9_]/g, '')
                              .substring(0, 30);
                            
                            const timestamp = Date.now().toString(36).substring(-4);
                            username = `${username}_${timestamp}`;
                            
                            const profileData = {
                                id: user.id,
                                username: username,
                                full_name: userData.full_name || userData.name || username,
                                avatar_icon: 'üçî',
                                bio: '',
                                location: '',
                                is_private: false
                            };
                            
                            console.log('Profile data:', profileData);
                            
                            const { data: newProfile, error: createError } = await supabase
                                .from('user_profiles')
                                .insert([profileData])
                                .select()
                                .maybeSingle();
                            
                            if (createError) {
                                console.error('‚ùå Profile creation error:', createError);
                                
                                if (createError.code === '23505') {
                                    console.log('Profile already exists (created by trigger)');
                                    return true;
                                }
                                
                                if (attempt === retries) {
                                    console.error('All retry attempts failed');
                                    return false;
                                }
                                continue;
                            }
                            
                            if (newProfile) {
                                console.log('‚úÖ Profile created successfully:', newProfile);
                                return true;
                            }
                            
                        } catch (error) {
                            console.error('Unexpected error:', error);
                            if (attempt === retries) {
                                return false;
                            }
                        }
                    }
                    
                    return false;
                }
                
                function setLoggedInState(user) {
                    try {
                        let displayName = 'User';
                        const userData = user.user_metadata || {};
                        
                        displayName = userData.full_name || 
                                     userData.name || 
                                     user.email?.split('@')[0] || 
                                     'User';
                        
                        const authBtn = document.getElementById('userAccountBtn');
                        if (authBtn) {
                            authBtn.innerHTML = `<i class="fas fa-user"></i><span>${displayName}</span>`;
                            authBtn.onclick = () => {
                                window.location.href = 'profile.html';
                            };
                        }
                        
                        const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                        const loggedInBtn = document.querySelector('.btn-primary.logged-in');
                        if (startJourneyBtn) startJourneyBtn.style.display = 'none';
                        if (loggedInBtn) loggedInBtn.style.display = 'flex';
                        
                        guestBanner.hide();
                        
                    } catch (error) {
                        console.error('Error setting logged in state:', error);
                        setGuestState();
                    }
                }
                
                function setGuestState() {
                    const authBtn = document.getElementById('userAccountBtn');
                    if (authBtn) {
                        authBtn.innerHTML = `<i class="fas fa-user"></i><span>Account</span>`;
                        authBtn.onclick = () => {
                            window.location.href = 'login.html';
                        };
                    }
                    
                    const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                    const loggedInBtn = document.querySelector('.btn-primary.logged-in');
                    if (startJourneyBtn) startJourneyBtn.style.display = 'flex';
                    if (loggedInBtn) loggedInBtn.style.display = 'none';
                    
                    guestBanner.show();
                }
                
                // ---------- IMAGE LOADER ----------
                function initImageLoader() {
                    if (state.imageObserver) return;
                    
                    state.imageObserver = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                const img = entry.target;
                                if (img.dataset.src) {
                                    img.src = img.dataset.src;
                                    img.classList.add('loaded');
                                    observer.unobserve(img);
                                }
                            }
                        });
                    }, {
                        rootMargin: '100px 0px',
                        threshold: 0.01
                    });
                }
                
                // ---------- OPTIMIZED RESTAURANT DATA LOADING ----------
                async function loadRestaurantsData() {
                    console.log('üçΩÔ∏è Loading restaurant data...');
                    
                    try {
                        // OPTIMIZATION: Load everything in parallel
                        const [cloudKitchensResult, restaurantImagesResult, restaurantsResult] = 
                            await Promise.allSettled([
                                loadCloudKitchens(),
                                loadRestaurantImages(),
                                supabase
                                    .from('restraunts')
                                    .select('id, slug, name, category, description, rating, logo_url, image')
                                    .order('rating', { ascending: false })
                                    .limit(32)
                            ]);
                        
                        if (restaurantsResult.status === 'fulfilled' && restaurantsResult.value.data) {
                            const data = restaurantsResult.value.data;
                            
                            state.restaurants = data.map(restaurant => ({
                                id: restaurant.id,
                                slug: restaurant.slug,
                                name: restaurant.name,
                                category: restaurant.category || 'Restaurant',
                                description: restaurant.description || 'Delicious food served with care',
                                rating: restaurant.rating || 0,
                                logo_url: restaurant.logo_url,
                                coverImage: getCoverImageUrl(restaurant.slug) || restaurant.image,
                                isCloudKitchen: state.cloudKitchens.has(restaurant.id)
                            }));
                            
                            console.log(`‚úÖ Loaded ${state.restaurants.length} restaurants`);
                            
                            // OPTIMIZATION: Immediate rendering
                            renderFeaturedRestaurants();
                            renderNearbyRestaurants();
                            setupSpotlight();
                            setupRestaurantOfTheDay();
                            populateFilters();
                            
                        } else {
                            showEmptyState();
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error loading restaurants:', error);
                        showNotification('Failed to load restaurants', 'error');
                        showEmptyState();
                    }
                }
                
                async function loadCloudKitchens() {
                    try {
                        const { data: cloudKitchens, error } = await supabase
                            .from('cloud_kitchens')
                            .select('restaurant_id')
                            .limit(50);
                        
                        if (error) {
                            console.warn('Error loading cloud kitchens:', error);
                            return;
                        }
                        
                        if (cloudKitchens && cloudKitchens.length > 0) {
                            state.cloudKitchens.clear();
                            cloudKitchens.forEach(ck => {
                                state.cloudKitchens.add(ck.restaurant_id);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading cloud kitchens:', error);
                    }
                }
                
                async function loadRestaurantImages() {
                    try {
                        const [galleryData, restaurantsData] = await Promise.all([
                            supabase
                                .from('restaurant_gallery')
                                .select('restaurant_slug, image_url, image_type')
                                .limit(100),
                            supabase
                                .from('restraunts')
                                .select('slug, image, logo_url')
                                .limit(50)
                        ]);
                        
                        state.restaurantImages.clear();
                        
                        if (galleryData.data) {
                            galleryData.data.forEach(item => {
                                if (!state.restaurantImages.has(item.restaurant_slug)) {
                                    state.restaurantImages.set(item.restaurant_slug, {
                                        cover: null,
                                        logo: null
                                    });
                                }
                                
                                const images = state.restaurantImages.get(item.restaurant_slug);
                                
                                if (item.image_type === 'cover' && item.image_url) {
                                    images.cover = item.image_url;
                                }
                                
                                if (item.image_type === 'logo' && item.image_url) {
                                    images.logo = item.image_url;
                                }
                            });
                        }
                        
                        if (restaurantsData.data) {
                            restaurantsData.data.forEach(restaurant => {
                                if (!state.restaurantImages.has(restaurant.slug)) {
                                    state.restaurantImages.set(restaurant.slug, {
                                        cover: restaurant.image || null,
                                        logo: restaurant.logo_url || null
                                    });
                                }
                            });
                        }
                        
                    } catch (error) {
                        console.error('Error loading restaurant images:', error);
                    }
                }
                
                function getCoverImageUrl(restaurantSlug) {
                    const images = state.restaurantImages.get(restaurantSlug);
                    return images?.cover || null;
                }
                
                function getLogoUrl(restaurant) {
                    const images = state.restaurantImages.get(restaurant.slug);
                    if (images?.logo) {
                        return images.logo;
                    }
                    
                    if (restaurant.logo_url) {
                        return restaurant.logo_url;
                    }
                    
                    return null;
                }
                
                function showEmptyState() {
                    const featuredSlider = document.getElementById('featuredSlider');
                    const nearbySlider = document.getElementById('nearbySlider');
                    
                    if (featuredSlider) {
                        featuredSlider.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">No restaurants found</div>';
                        featuredSlider.classList.remove('skeleton-grid');
                    }
                    if (nearbySlider) {
                        nearbySlider.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">No restaurants found</div>';
                        nearbySlider.classList.remove('skeleton-grid');
                    }
                }
                
                // ---------- SPOTLIGHT ----------
                function setupSpotlight() {
                    if (state.restaurants.length === 0) return;
                    
                    state.spotlightRestaurants = [...state.restaurants]
                        .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                        .slice(0, 6);
                    
                    updateSpotlight();
                    startSpotlightRotation();
                }
                
                function updateSpotlight() {
                    if (!state.spotlightRestaurants.length) return;
                    
                    const restaurant = state.spotlightRestaurants[state.spotlightIndex];
                    
                    document.getElementById('spotName').textContent = restaurant.name;
                    document.getElementById('spotDesc').textContent = restaurant.description || 'Delicious food served with care';
                    document.getElementById('spotRating').innerHTML = `‚≠ê ${(restaurant.rating || 0).toFixed(1)}`;
                    
                    const foodImage = document.getElementById('spotFoodImage');
                    const logoImage = document.getElementById('spotLogo');
                    const logoOverlay = document.getElementById('spotLogoOverlay');
                    
                    foodImage.src = '';
                    foodImage.classList.remove('loaded');
                    logoImage.src = '';
                    logoImage.classList.remove('loaded');
                    
                    if (restaurant.coverImage) {
                        foodImage.dataset.src = restaurant.coverImage;
                        foodImage.onload = () => {
                            foodImage.classList.add('loaded');
                        };
                        foodImage.onerror = () => {
                            foodImage.style.display = 'none';
                        };
                        foodImage.src = restaurant.coverImage;
                    } else {
                        foodImage.style.display = 'none';
                    }
                    
                    const logoUrl = getLogoUrl(restaurant);
                    if (logoUrl) {
                        logoOverlay.style.display = 'flex';
                        logoImage.dataset.src = logoUrl;
                        logoImage.onload = () => {
                            logoImage.classList.add('loaded');
                        };
                        logoImage.onerror = () => {
                            logoOverlay.style.display = 'none';
                        };
                        logoImage.src = logoUrl;
                    } else {
                        logoOverlay.style.display = 'none';
                    }
                    
                    document.getElementById('spotlightViewBtn').onclick = () => {
                        location.href = `restaurant.html?slug=${restaurant.slug}`;
                    };
                    
                    document.getElementById('spotlightCard').onclick = () => {
                        location.href = `restaurant.html?slug=${restaurant.slug}`;
                    };
                    
                    const indicators = document.getElementById('slideIndicators');
                    indicators.innerHTML = state.spotlightRestaurants.map((_, i) => 
                        `<div class="slide-indicator ${i === state.spotlightIndex ? 'active' : ''}" data-index="${i}"></div>`
                    ).join('');
                    
                    indicators.querySelectorAll('.slide-indicator').forEach((dot, i) => {
                        dot.onclick = (e) => { 
                            e.stopPropagation(); 
                            state.spotlightIndex = i; 
                            updateSpotlight(); 
                            resetSpotlightInterval(); 
                        };
                    });
                }
                
                function startSpotlightRotation() {
                    resetSpotlightInterval();
                    
                    if (state.spotlightRestaurants.length > 1) {
                        state.spotlightInterval = setInterval(() => {
                            state.spotlightIndex = (state.spotlightIndex + 1) % state.spotlightRestaurants.length;
                            updateSpotlight();
                        }, 5000);
                    }
                    
                    const spotlightCard = document.getElementById('spotlightCard');
                    if (spotlightCard) {
                        spotlightCard.onmouseenter = () => {
                            if (state.spotlightInterval) {
                                clearInterval(state.spotlightInterval);
                                state.spotlightInterval = null;
                            }
                        };
                        spotlightCard.onmouseleave = resetSpotlightInterval;
                    }
                }
                
                function resetSpotlightInterval() {
                    if (state.spotlightInterval) {
                        clearInterval(state.spotlightInterval);
                        state.spotlightInterval = null;
                    }
                    
                    if (state.spotlightRestaurants.length > 1) {
                        state.spotlightInterval = setInterval(() => {
                            state.spotlightIndex = (state.spotlightIndex + 1) % state.spotlightRestaurants.length;
                            updateSpotlight();
                        }, 5000);
                    }
                }
                
                // ---------- RESTAURANT CARD CREATION ----------
                function createRestaurantCard(restaurant) {
                    const card = document.createElement('div');
                    card.className = 'restaurant-card';
                    card.dataset.id = restaurant.id;
                    
                    const rating = restaurant.rating || 0;
                    const categoryIcon = getCategoryIconFallback(restaurant.category);
                    const category = restaurant.category || 'Restaurant';
                    const logoUrl = getLogoUrl(restaurant);
                    const status = state.listManager.getRestaurantListStatus(restaurant.id);
                    const hasCoverImage = restaurant.coverImage && restaurant.coverImage !== '';
                    const isCloudKitchen = restaurant.isCloudKitchen || false;
                    const cloudBadge = isCloudKitchen ? createCloudBadge(restaurant.id) : '';
                    
                    let listBadges = '';
                    
                    if (status.favorites) {
                        listBadges += `
                            <div class="list-badge">
                                ‚ù§Ô∏è
                                <div class="list-badge-tooltip">Favorited</div>
                            </div>
                        `;
                    }
                    
                    if (status.wantToGo) {
                        listBadges += `
                            <div class="list-badge">
                                üìç
                                <div class="list-badge-tooltip">Want to go to</div>
                            </div>
                        `;
                    }
                    
                    if (status.visited) {
                        listBadges += `
                            <div class="list-badge">
                                ‚úì
                                <div class="list-badge-tooltip">Visited</div>
                            </div>
                        `;
                    }
                    
                    card.innerHTML = `
                        <a href="restaurant.html?slug=${restaurant.slug}" class="card-link">
                            <div class="card-image">
                                ${hasCoverImage ? `
                                    <img class="restaurant-image" 
                                         data-src="${restaurant.coverImage}" 
                                         alt="${restaurant.name}" 
                                         width="300" 
                                         height="200">
                                ` : ''}
                                ${logoUrl ? `
                                    <div class="logo-overlay">
                                        <img data-src="${logoUrl}" 
                                             alt="${restaurant.name} logo" 
                                             width="48" 
                                             height="48">
                                    </div>
                                ` : ''}
                                
                                ${listBadges ? `<div class="list-badges-container">${listBadges}</div>` : ''}
                                
                                ${cloudBadge}
                                
                                <div class="menu-btn-container">
                                    <button class="menu-btn" aria-label="Restaurant actions">
                                        <i class="fas fa-ellipsis-h"></i>
                                        <div class="menu-btn-tooltip">Save to lists</div>
                                    </button>
                                </div>
                            </div>
                            <div class="card-content">
                                <div class="card-header">
                                    <div class="card-title-wrapper">
                                        <h3 class="card-title">${restaurant.name}</h3>
                                    </div>
                                    <div class="card-rating">
                                        <i class="fas fa-star"></i>
                                        ${rating.toFixed(1)}
                                    </div>
                                </div>
                                <div class="card-category">
                                    <span>${categoryIcon}</span>
                                    ${category}
                                </div>
                                <p class="card-description">${restaurant.description || 'Delicious food served with care'}</p>
                                <div class="card-footer">
                                    <div class="card-location">Click to view details</div>
                                </div>
                            </div>
                        </a>
                    `;
                    
                    const menuBtn = card.querySelector('.menu-btn');
                    if (menuBtn) {
                        menuBtn.addEventListener('click', async (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            showModal({
                                id: restaurant.id,
                                name: restaurant.name,
                                slug: restaurant.slug
                            });
                        });
                    }
                    
                    return card;
                }
                
                function createCloudBadge(restaurantId) {
                    if (!state.cloudKitchens.has(restaurantId)) return '';
                    
                    return `
                        <div class="cloud-badge" aria-label="Cloud Kitchen">
                            <i class="fas fa-cloud"></i>
                            <div class="cloud-tooltip">
                                Cloud Kitchen
                            </div>
                        </div>
                    `;
                }
                
                function getCategoryIconFallback(categoryName) {
                    const icons = {
                        'Burgers': 'üçî',
                        'Chicken': 'üçó',
                        'Middle Eastern': 'ü•ô',
                        'Pizza': 'üçï',
                        'Asian': 'üçú',
                        'Mexican': 'üåÆ',
                        'Cafe & Bakery': '‚òï',
                        'Fast Food': 'üçü',
                        'Seafood': 'üêü',
                        'Breakfast': 'ü•û',
                        'Desserts': 'üç∞',
                        'Indian': 'üçõ',
                        'BBQ & Ribs': 'ü•©',
                        'International': 'üåç'
                    };
                    
                    return icons[categoryName] || 'üç¥';
                }
                
                // ---------- OPTIMIZED RENDERING ----------
                function renderFeaturedRestaurants() {
                    console.log('üé® Rendering featured restaurants...');
                    
                    const grid = document.getElementById('featuredSlider');
                    if (!grid) return;
                    
                    if (state.restaurants.length === 0) {
                        showEmptyState();
                        return;
                    }
                    
                    grid.classList.remove('skeleton-grid');
                    
                    const featured = state.restaurants.slice(0, Math.min(8, state.restaurants.length));
                    const fragment = document.createDocumentFragment();
                    
                    for (const restaurant of featured) {
                        const card = createRestaurantCard(restaurant);
                        fragment.appendChild(card);
                    }
                    
                    grid.innerHTML = '';
                    grid.appendChild(fragment);
                    
                    console.log('‚úÖ Featured restaurants rendered');
                    
                    // OPTIMIZATION: Immediate image loading
                    requestAnimationFrame(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (img.dataset.src && !img.src) {
                                img.src = img.dataset.src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                };
                            }
                        });
                    });
                }
                
                function renderNearbyRestaurants() {
                    console.log('üé® Rendering nearby restaurants...');
                    
                    const grid = document.getElementById('nearbySlider');
                    if (!grid) return;
                    
                    if (state.restaurants.length === 0) {
                        showEmptyState();
                        return;
                    }
                    
                    grid.classList.remove('skeleton-grid');
                    
                    const startIndex = Math.min(8, state.restaurants.length);
                    const nearby = state.restaurants.slice(startIndex, Math.min(startIndex + 8, state.restaurants.length));
                    const fragment = document.createDocumentFragment();
                    
                    for (const restaurant of nearby) {
                        const card = createRestaurantCard(restaurant);
                        fragment.appendChild(card);
                    }
                    
                    grid.innerHTML = '';
                    grid.appendChild(fragment);
                    
                    console.log('‚úÖ Nearby restaurants rendered');
                    
                    // OPTIMIZATION: Immediate image loading
                    requestAnimationFrame(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (img.dataset.src && !img.src) {
                                img.src = img.dataset.src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                };
                            }
                        });
                    });
                }
                
                // ---------- RESTAURANT OF THE DAY ----------
                async function setupRestaurantOfTheDay() {
                    if (state.restaurants.length === 0) return;
                    
                    const topRestaurants = [...state.restaurants]
                        .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                        .slice(0, 10);
                    
                    const today = new Date().getDate();
                    const restaurantIndex = today % topRestaurants.length;
                    const restaurant = topRestaurants[restaurantIndex];
                    
                    const categoryIcon = getCategoryIconFallback(restaurant.category);
                    const isCloudKitchen = restaurant.isCloudKitchen || false;
                    const cloudBadge = isCloudKitchen ? `
                        <div class="cloud-badge" aria-label="Cloud Kitchen" style="top: 70px; right: 56px;">
                            <i class="fas fa-cloud"></i>
                            <div class="cloud-tooltip">
                                Cloud Kitchen
                            </div>
                        </div>
                    ` : '';
                    
                    let listBadges = '';
                    if (state.isLoggedIn && state.listManager) {
                        const status = state.listManager.getRestaurantListStatus(restaurant.id);
                        if (status.favorites) listBadges += `
                            <div class="list-badge" style="top: 70px;">
                                ‚ù§Ô∏è
                                <div class="list-badge-tooltip">Favorited</div>
                            </div>
                        `;
                        if (status.wantToGo) listBadges += `
                            <div class="list-badge" style="top: 70px; margin-top: 44px;">
                                üìç
                                <div class="list-badge-tooltip">Want to go to</div>
                            </div>
                        `;
                        if (status.visited) listBadges += `
                            <div class="list-badge" style="top: 70px; margin-top: 88px;">
                                ‚úì
                                <div class="list-badge-tooltip">Visited</div>
                            </div>
                        `;
                    }
                    
                    const dayCard = document.getElementById('dayCard');
                    dayCard.innerHTML = `
                        <div class="day-card-badge">Restaurant of the Day</div>
                        <div class="card-image">
                            ${restaurant.coverImage ? `
                                <img class="restaurant-image" 
                                     data-src="${restaurant.coverImage}" 
                                     alt="${restaurant.name}" 
                                     loading="lazy"
                                     style="height: 300px;">
                            ` : ''}
                            ${listBadges ? `<div class="list-badges-container">${listBadges}</div>` : ''}
                            ${cloudBadge}
                            ${restaurant.logo_url ? `
                                <div class="logo-overlay" style="bottom: 20px; left: 20px; width: 60px; height: 60px;">
                                    <img data-src="${restaurant.logo_url}" 
                                         alt="${restaurant.name} logo">
                                </div>
                            ` : ''}
                            <div class="menu-btn-container">
                                <button class="menu-btn" aria-label="Restaurant actions">
                                    <i class="fas fa-ellipsis-h"></i>
                                    <div class="menu-btn-tooltip">Save to lists</div>
                                </button>
                            </div>
                        </div>
                        <div class="card-content">
                            <div class="card-header">
                                <div class="card-title-wrapper">
                                    <h3 class="card-title">${restaurant.name}</h3>
                                </div>
                                <div class="card-rating" style="padding: 8px 16px; font-size: 16px;">
                                    <i class="fas fa-star"></i>
                                    ${(restaurant.rating || 0).toFixed(1)}
                                </div>
                            </div>
                            <div class="card-category" style="font-size: 16px; margin-bottom: 20px;">
                                <span>${categoryIcon}</span>
                                ${restaurant.category || 'Restaurant'}
                            </div>
                            <p class="card-description" style="font-size: 16px; line-height: 1.6; margin-bottom: 30px; -webkit-line-clamp: 3; color: #c3d1e8;">
                                ${restaurant.description || 'Delicious food served with care'}
                            </p>
                            
                            <div class="day-card-stats">
                                <div class="day-stat">
                                    <div class="day-stat-value">${(restaurant.rating || 0).toFixed(1)}</div>
                                    <div class="day-stat-label">Rating</div>
                                </div>
                                <div class="day-stat">
                                    <div class="day-stat-value">${categoryIcon}</div>
                                    <div class="day-stat-label">Category</div>
                                </div>
                                <div class="day-stat">
                                    <div class="day-stat-value">${isCloudKitchen ? '‚òÅÔ∏è' : 'üè†'}</div>
                                    <div class="day-stat-label">${isCloudKitchen ? 'Cloud Kitchen' : 'Restaurant'}</div>
                                </div>
                            </div>
                            
                            <div class="day-card-actions">
                                <button class="day-card-btn day-card-btn-primary" onclick="location.href='restaurant.html?slug=${restaurant.slug}'">
                                    <i class="fas fa-external-link-alt"></i>
                                    View Restaurant
                                </button>
                                <button class="day-card-btn day-card-btn-outline" id="dayCardSaveBtn">
                                    <i class="fas fa-bookmark"></i>
                                    Save to Lists
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // OPTIMIZATION: Immediate image loading
                    const mainImage = dayCard.querySelector('.restaurant-image');
                    if (mainImage && mainImage.dataset.src) {
                        mainImage.src = mainImage.dataset.src;
                        mainImage.onload = () => mainImage.classList.add('loaded');
                    }
                    
                    const logoImage = dayCard.querySelector('.logo-overlay img');
                    if (logoImage && logoImage.dataset.src) {
                        logoImage.src = logoImage.dataset.src;
                        logoImage.onload = () => logoImage.classList.add('loaded');
                    }
                    
                    const saveBtn = dayCard.querySelector('#dayCardSaveBtn');
                    if (saveBtn) {
                        saveBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showModal(restaurant);
                        });
                    }
                    
                    const menuBtn = dayCard.querySelector('.menu-btn');
                    if (menuBtn) {
                        menuBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            showModal(restaurant);
                        });
                    }
                    
                    dayCard.onclick = (e) => {
                        if (!e.target.closest('.day-card-btn-outline') && !e.target.closest('.menu-btn')) {
                            location.href = `restaurant.html?slug=${restaurant.slug}`;
                        }
                    };
                    
                    console.log('‚úÖ Restaurant of the Day set up');
                }
                
                // ---------- FILTERS ----------
                function populateFilters() {
                    const filterBar = document.getElementById('filterBar');
                    if (!filterBar) return;
                    
                    if (state.restaurants.length === 0) {
                        filterBar.innerHTML = '';
                        return;
                    }
                    
                    const categories = [...new Set(state.restaurants.slice(0, 8).map(r => r.category).filter(Boolean))];
                    
                    let filterHTML = `<div class="filter-btn active" data-filter="all">All</div>`;
                    
                    categories.slice(0, 5).forEach(category => {
                        filterHTML += `<div class="filter-btn" data-filter="${category}">${category}</div>`;
                    });
                    
                    filterHTML += `<div class="filter-btn" data-filter="top-rated">Top Rated</div>`;
                    
                    filterBar.innerHTML = filterHTML;
                    
                    filterBar.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            filterBar.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                            this.classList.add('active');
                            filterFeaturedRestaurants(this.dataset.filter);
                        });
                    });
                    
                    console.log('‚úÖ Filters populated');
                }
                
                function filterFeaturedRestaurants(filter) {
                    if (state.restaurants.length === 0) return;
                    
                    let filtered = state.restaurants.slice(0, 8);
                    
                    if (filter === 'top-rated') {
                        filtered = filtered.filter(r => (r.rating || 0) >= 4.5);
                    } else if (filter !== 'all') {
                        filtered = filtered.filter(r => r.category === filter);
                    }
                    
                    const grid = document.getElementById('featuredSlider');
                    if (!grid) return;
                    
                    const fragment = document.createDocumentFragment();
                    
                    for (const restaurant of filtered) {
                        const card = createRestaurantCard(restaurant);
                        fragment.appendChild(card);
                    }
                    
                    grid.innerHTML = '';
                    grid.appendChild(fragment);
                    
                    // OPTIMIZATION: Immediate image loading
                    requestAnimationFrame(() => {
                        const images = grid.querySelectorAll('img[data-src]');
                        images.forEach(img => {
                            if (img.dataset.src && !img.src) {
                                img.src = img.dataset.src;
                                img.onload = () => {
                                    img.classList.add('loaded');
                                };
                            }
                        });
                    });
                }
                
                // ---------- NOTIFICATION SYSTEM ----------
                function showNotification(message, type = "info", duration = 2500) {
                    const container = document.getElementById("notificationContainer");
                    if (!container) return;
                    
                    const notification = document.createElement("div");
                    notification.className = `custom-notification notification-${type}`;
                    
                    let iconClass;
                    if (type === "success") {
                        iconClass = "fas fa-check-circle";
                    } else if (type === "error") {
                        iconClass = "fas fa-exclamation-circle";
                    } else if (type === "warning") {
                        iconClass = "fas fa-exclamation-triangle";
                    } else {
                        iconClass = "fas fa-info-circle";
                    }
                    
                    notification.innerHTML = `
                        <i class="notification-icon ${iconClass}"></i>
                        <span class="notification-message">${message}</span>
                        <button class="notification-close" aria-label="Close notification">√ó</button>
                    `;
                    
                    container.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.classList.add("notification-show");
                    }, 10);
                    
                    notification.querySelector('.notification-close').addEventListener('click', () => {
                        notification.classList.remove("notification-show");
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 400);
                    });
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.classList.remove("notification-show");
                            setTimeout(() => notification.remove(), 400);
                        }
                    }, duration);
                }
                
                // ---------- GUEST BANNER ----------
                const guestBanner = {
                    init: function() {
                        const loginBtn = document.getElementById('bannerLoginBtn');
                        const signupBtn = document.getElementById('bannerSignupBtn');
                        
                        if (loginBtn) {
                            loginBtn.addEventListener('click', () => {
                                window.location.href = 'login.html';
                            });
                        }
                        
                        if (signupBtn) {
                            signupBtn.addEventListener('click', () => {
                                window.location.href = 'sign-up.html';
                            });
                        }
                    },
                    
                    show: function() {
                        const banner = document.getElementById('guestBanner');
                        if (banner) banner.classList.add('show');
                    },
                    
                    hide: function() {
                        const banner = document.getElementById('guestBanner');
                        if (banner) banner.classList.remove('show');
                    }
                };
                
                // ---------- AUTH PROMPT ----------
                function showAuthPrompt() {
                    const modal = document.getElementById('authPromptModal');
                    if (modal) modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // ---------- MODAL FUNCTIONS ----------
                function showModal(restaurantData) {
                    if (!restaurantData) return;
                    
                    if (!state.isLoggedIn) {
                        showAuthPrompt();
                        return;
                    }
                    
                    state.currentModalRestaurant = restaurantData;
                    document.getElementById('modalRestaurantName').textContent = restaurantData.name;
                    
                    updateModalButtons(restaurantData.id);
                    
                    const modal = document.getElementById('actionsModal');
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                function hideModal() {
                    const modal = document.getElementById('actionsModal');
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                }
                
                function updateModalButtons(restaurantId) {
                    const status = state.listManager.getRestaurantListStatus(restaurantId);
                    
                    const favoritesBtn = document.getElementById('modalFavoritesBtn');
                    const wantToGoBtn = document.getElementById('modalWantToGoBtn');
                    const visitedBtn = document.getElementById('modalVisitedBtn');
                    
                    if (favoritesBtn) {
                        favoritesBtn.innerHTML = `<i class="fas fa-heart"></i><span>${status.favorites ? 'Remove from Favorites' : 'Add to Favorites'}</span>`;
                        favoritesBtn.classList.toggle('active', status.favorites);
                    }
                    
                    if (wantToGoBtn) {
                        wantToGoBtn.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${status.wantToGo ? 'Remove from Want to Go' : 'Add to Want to Go'}</span>`;
                        wantToGoBtn.classList.toggle('active', status.wantToGo);
                    }
                    
                    if (visitedBtn) {
                        visitedBtn.innerHTML = `<i class="fas fa-utensils"></i><span>${status.visited ? 'Remove from Visited' : 'Mark as Visited'}</span>`;
                        visitedBtn.classList.toggle('active', status.visited);
                    }
                }
                
                // ---------- EVENT LISTENERS ----------
                function setupEventListeners() {
                    console.log('üîß Setting up event listeners...');
                    
                    const mobileSearchToggle = document.getElementById('mobileSearchToggle');
                    if (mobileSearchToggle) {
                        mobileSearchToggle.addEventListener('click', () => {
                            const searchWrapper = document.getElementById('searchWrapper');
                            if (searchWrapper) {
                                searchWrapper.classList.toggle('active');
                            }
                        });
                    }
                    
                    const startJourneyBtn = document.querySelector('.btn-primary.logged-out');
                    if (startJourneyBtn) {
                        startJourneyBtn.addEventListener('click', () => {
                            window.location.href = 'sign-up.html';
                        });
                    }
                    
                    const searchFooterLink = document.getElementById('searchFooterLink');
                    if (searchFooterLink) {
                        searchFooterLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            const searchInput = document.getElementById('search');
                            if (searchInput) {
                                searchInput.focus();
                            }
                        });
                    }
                    
                    const iosAppButton = document.getElementById('iosAppButton');
                    const androidAppButton = document.getElementById('androidAppButton');
                    
                    if (iosAppButton) {
                        iosAppButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            showNotification('Zo2y iOS app coming soon!', 'info');
                        });
                    }
                    
                    if (androidAppButton) {
                        androidAppButton.addEventListener('click', (e) => {
                            e.preventDefault();
                            showNotification('Zo2y Android app coming soon!', 'info');
                        });
                    }
                    
                    guestBanner.init();
                    
                    const modalFavoritesBtn = document.getElementById('modalFavoritesBtn');
                    const modalWantToGoBtn = document.getElementById('modalWantToGoBtn');
                    const modalVisitedBtn = document.getElementById('modalVisitedBtn');
                    const modalCustomListsBtn = document.getElementById('modalCustomListsBtn');
                    const modalCancelBtn = document.getElementById('modalCancelBtn');
                    
                    if (modalFavoritesBtn) {
                        modalFavoritesBtn.addEventListener('click', async () => {
                            if (!state.currentModalRestaurant) return;
                            await state.listManager.toggleInList('favorites', state.currentModalRestaurant.id);
                            updateModalButtons(state.currentModalRestaurant.id);
                            renderFeaturedRestaurants();
                            renderNearbyRestaurants();
                            updateSpotlight();
                            setupRestaurantOfTheDay();
                            hideModal();
                        });
                    }
                    
                    if (modalWantToGoBtn) {
                        modalWantToGoBtn.addEventListener('click', async () => {
                            if (!state.currentModalRestaurant) return;
                            await state.listManager.toggleInList('wantToGo', state.currentModalRestaurant.id);
                            updateModalButtons(state.currentModalRestaurant.id);
                            renderFeaturedRestaurants();
                            renderNearbyRestaurants();
                            updateSpotlight();
                            setupRestaurantOfTheDay();
                            hideModal();
                        });
                    }
                    
                    if (modalVisitedBtn) {
                        modalVisitedBtn.addEventListener('click', async () => {
                            if (!state.currentModalRestaurant) return;
                            await state.listManager.toggleInList('visited', state.currentModalRestaurant.id);
                            updateModalButtons(state.currentModalRestaurant.id);
                            renderFeaturedRestaurants();
                            renderNearbyRestaurants();
                            updateSpotlight();
                            setupRestaurantOfTheDay();
                            hideModal();
                        });
                    }
                    
                    if (modalCustomListsBtn) {
                        modalCustomListsBtn.addEventListener('click', () => {
                            if (!state.currentModalRestaurant) {
                                showNotification('No restaurant selected', 'error');
                                return;
                            }
                            
                            hideModal();
                            
                            setTimeout(() => {
                                showNotification('Custom lists feature coming soon!', 'info');
                            }, 100);
                        });
                    }
                    
                    if (modalCancelBtn) {
                        modalCancelBtn.addEventListener('click', hideModal);
                    }
                    
                    window.addEventListener('scroll', () => {
                        const nav = document.querySelector('.nav');
                        if (window.scrollY > 10) {
                            nav.classList.add('scrolled');
                        } else {
                            nav.classList.remove('scrolled');
                        }
                    });
                    
                    const authPromptSignupBtn = document.getElementById('authPromptSignupBtn');
                    const authPromptLoginBtn = document.getElementById('authPromptLoginBtn');
                    const authPromptCloseBtn = document.getElementById('authPromptCloseBtn');
                    
                    if (authPromptSignupBtn) {
                        authPromptSignupBtn.addEventListener('click', () => {
                            window.location.href = 'sign-up.html';
                        });
                    }
                    
                    if (authPromptLoginBtn) {
                        authPromptLoginBtn.addEventListener('click', () => {
                            window.location.href = 'login.html';
                        });
                    }
                    
                    if (authPromptCloseBtn) {
                        authPromptCloseBtn.addEventListener('click', () => {
                            const modal = document.getElementById('authPromptModal');
                            modal.classList.remove('active');
                            document.body.style.overflow = 'auto';
                        });
                    }
                    
                    console.log('‚úÖ Event listeners set up');
                }
                
                // ---------- OPTIMIZED INIT FUNCTION ----------
                async function init() {
                    console.log('üöÄ Initializing homepage...');
                    
                    try {
                        // Setup basic functionality immediately
                        setupEventListeners();
                        guestBanner.init();
                        initImageLoader();
                        setupSearch();
                        
                        // Then initialize auth and load data
                        await initializeAuth();
                        await loadRestaurantsData();
                        
                        console.log('‚úÖ Homepage initialization complete');
                        
                    } catch (error) {
                        console.error('‚ùå Initialization error:', error);
                        showNotification('Failed to initialize page', 'error');
                        
                        const featuredSlider = document.getElementById('featuredSlider');
                        const nearbySlider = document.getElementById('nearbySlider');
                        if (featuredSlider) {
                            featuredSlider.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Failed to load content</div>';
                            featuredSlider.classList.remove('skeleton-grid');
                        }
                        if (nearbySlider) {
                            nearbySlider.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Failed to load content</div>';
                            nearbySlider.classList.remove('skeleton-grid');
                        }
                    }
                }
                
                // Start initialization
                init();
                
            })();
        });
    </script>
</body>
</html>