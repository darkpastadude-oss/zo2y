<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zo2y - Game</title>
  <link rel="icon" href="/favicon.ico?v=3" type="image/x-icon" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <style>
    :root {
      --bg: #0b1633;
      --card: #132347;
      --muted: #8ca3c7;
      --accent: #f59e0b;
      --glass: rgba(255,255,255,0.03);
      --white: #ffffff;
      --border: rgba(255,255,255,0.1);
      --gradient: linear-gradient(135deg, #f59e0b 0%, #ffb84d 100%);
      --shadow: 0 10px 30px rgba(0,0,0,0.3);
      --success: #10b981;
      --error: #ef4444;
      --info: #3b82f6;
      --surface: rgba(19, 35, 71, 0.6);
      --radial-glow: radial-gradient(circle at 50% 0%, rgba(245, 158, 11, 0.15) 0%, transparent 70%);
      --text2: #9fb0cf;
      --input-bg: #0f1f40;
      --input-text: #ffffff;
      --btn-bg: var(--gradient);
      --btn-text: #0b1633;
      --nav-shadow: rgba(255,255,255,0.08);
      --nav-bg: #0f1f40;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--white);
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      inset: -20% 0 0 0;
      background: var(--radial-glow);
      pointer-events: none;
      z-index: -2;
    }
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0 12px, rgba(255, 184, 77, 0) 12px 24px);
      opacity: 0.25;
      pointer-events: none;
      z-index: -3;
    }
    a { color: inherit; text-decoration: none; }
    .nav {
      position: sticky;
      top: 0;
      z-index: 1000;
      padding: 14px 16px;
      backdrop-filter: blur(10px) saturate(180%);
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .nav-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      gap: 12px;
    }
    .logo {
      height: 40px;
      width: auto;
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
    }
    .logo:hover { transform: scale(1.05); }
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .nav-search {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .nav-search-input {
      width: 220px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      padding: 0 10px;
      font-size: 13px;
    }
    .nav-search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.14);
    }
    .nav-search-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
    }
    .nav-search-btn:hover { border-color: var(--accent); color: var(--accent); }
    .search-suggest {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
      z-index: 1200;
      display: none;
      max-height: 320px;
      overflow-y: auto;
    }
    .search-suggest.open { display: block; }
    .search-suggest-item {
      display: grid;
      grid-template-columns: 56px 1fr;
      gap: 10px;
      align-items: center;
      width: 100%;
      border: 0;
      background: transparent;
      color: var(--white);
      text-align: left;
      padding: 8px 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
    }
    .search-suggest-item:last-child { border-bottom: 0; }
    .search-suggest-item:hover,
    .search-suggest-item.active { background: rgba(245, 158, 11, 0.14); }
    .search-suggest-thumb {
      width: 56px;
      height: 34px;
      border-radius: 6px;
      object-fit: cover;
      background: #0f1f40;
      border: 1px solid var(--border);
    }
    .search-suggest-title {
      font-size: 13px;
      font-weight: 700;
      line-height: 1.25;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .search-suggest-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .nav a.ghost {
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      white-space: nowrap;
    }
    .nav a.ghost:hover { color: var(--accent); background: rgba(245, 158, 11, 0.05); }
    .account-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    .account-btn:hover { border-color: var(--accent); color: var(--accent); }
    .account-btn.logged-in {
      background: rgba(245, 158, 11, 0.15);
      border-color: rgba(245, 158, 11, 0.4);
      color: var(--accent);
    }
    .account-btn.logged-in:hover { background: rgba(245, 158, 11, 0.25); }
    .wrap { max-width: 1200px; margin: 24px auto 40px; padding: 0 20px; display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    .poster { width: 100%; border-radius: 14px; border: 1px solid var(--border); background: #0f1f40; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; }
    .title-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
    .title { margin: 0 0 8px; font-size: 28px; }
    .meta { color: var(--muted); font-size: 14px; margin-bottom: 16px; }
    .overview { line-height: 1.6; color: var(--muted); }
    .section-title { margin: 20px 0 8px; font-size: 16px; }
    .people-list { display: flex; flex-wrap: wrap; gap: 8px; }
    .person-chip { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 10px; }
    .meta-item { background: #0f1f40; border: 1px solid var(--border); border-radius: 10px; padding: 10px; font-size: 12px; color: var(--muted); }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); font-size: 12px; margin-right: 8px; }
    .video-frame { width: 100%; aspect-ratio: 16 / 9; border: 0; border-radius: 12px; background: #0f1f40; }
    .list-stack { display: grid; gap: 6px; }
    .list-row { display: flex; gap: 8px; align-items: baseline; color: var(--muted); font-size: 12px; }
    .list-label { color: var(--white); font-weight: 600; }
    .menu-wrapper { position: relative; }
    .menu-btn {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .menu-btn:hover { border-color: var(--accent); color: var(--accent); }
    .list-menu {
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      min-width: 220px;
      box-shadow: var(--shadow);
      display: none;
      z-index: 20;
    }
    .list-menu.open { display: block; }
    .list-menu-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 12, 28, 0.55);
      z-index: 10;
      display: none;
    }
    .list-menu-backdrop.active { display: block; }
    .list-menu-title { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    .list-action {
      width: 100%;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all 0.2s ease;
      margin-bottom: 6px;
    }
    .list-action:last-child { margin-bottom: 0; }
    .list-action:hover { border-color: var(--accent); color: var(--accent); }
    .list-action.active {
      background: rgba(239, 68, 68, 0.12);
      border-color: #f87171;
      color: #fecaca;
    }
    .list-action.active .list-action-state {
      color: #fff;
      background: #dc2626;
      border: 1px solid #ef4444;
      border-radius: 999px;
      padding: 2px 8px;
    }
    .section {
      max-width: 1200px;
      margin: 0 auto 60px;
      padding: 0 20px;
    }
    .section h2 { margin: 0 0 12px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--white);
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn.primary { background: var(--gradient); border: none; color: #0b1633; font-weight: 600; }
    .btn.secondary { background: #0f1f40; }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 2000;
      box-shadow: var(--shadow);
      animation: slideIn 0.3s ease;
    }
    .notification.success { background: var(--success); color: white; }
    .notification.error { background: var(--error); color: white; }
    .notification.info { background: var(--info); color: white; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }
    .modal.active { display: flex; }
    .modal-content {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: var(--shadow);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close {
      background: none;
      border: none;
      color: var(--white);
      font-size: 22px;
      cursor: pointer;
    }
    .modal-list {
      display: grid;
      gap: 8px;
      max-height: 240px;
      overflow: auto;
      margin-bottom: 12px;
    }
    .modal-list-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
    }
    .modal-list-actions { display: inline-flex; gap: 6px; align-items: center; }
    .list-edit-btn {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .list-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
    .modal-list-item.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }
    .modal-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .modal-input input {
      flex: 1;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0f1f40;
      color: var(--white);
      outline: none;
    }
    .icon-options { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .icon-option {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--white);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .icon-option.selected { border-color: var(--accent); color: var(--accent); }
    .reviews-stats {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      border: 1px solid var(--nav-shadow);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
      margin-bottom: 15px;
    }
    .stat-item { text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--accent); line-height: 1; }
    .stat-label { font-size: 0.85rem; color: var(--text2); margin-top: 5px; }
    .rating-breakdown { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
    .rating-row { display: flex; align-items: center; gap: 10px; }
    .rating-stars { color: #FF9800; font-size: 0.9rem; width: 60px; }
    .rating-bar { flex: 1; height: 8px; background: var(--nav-shadow); border-radius: 4px; overflow: hidden; }
    .rating-fill { height: 100%; background: #FF9800; border-radius: 4px; transition: width 0.5s ease; }
    .rating-count { font-size: 0.8rem; color: var(--text2); width: 30px; text-align: right; }
    .reviews-container { margin-bottom: 40px; }
    .review-card {
      background: var(--card);
      border: 1px solid var(--nav-shadow);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    .review-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .review-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 15px; }
    .reviewer-info { display: flex; align-items: center; gap: 10px; flex: 1; }
    .reviewer-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #FF6F00);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .reviewer-name { font-weight: 600; color: var(--white); margin-bottom: 2px; }
    .reviewer-link {
      color: var(--white);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    .reviewer-link:hover { color: var(--accent); text-decoration: underline; }
    .review-date { font-size: 0.8rem; color: var(--text2); }
    .review-rating { color: #FF9800; font-size: 1.1rem; white-space: nowrap; }
    .review-actions { display: flex; gap: 8px; margin-top: 12px; }
    .review-edit, .review-delete {
      background: none;
      border: 1px solid var(--nav-shadow);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text2);
    }
    .review-edit:hover { background: var(--accent); color: white; border-color: var(--accent); }
    .review-delete:hover { background: var(--error); color: white; border-color: var(--error); }
    .review-comment { color: var(--white); line-height: 1.5; margin-bottom: 0; }
    .review-form-section {
      background: var(--card);
      padding: 25px;
      border-radius: 12px;
      border: 1px solid var(--nav-shadow);
    }
    .rating-input { margin-bottom: 20px; }
    .rating-input label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--white); }
    .stars-rating { display: flex; gap: 4px; margin-bottom: 8px; }
    .star {
      font-size: 2rem;
      color: #4a5568;
      cursor: pointer;
      transition: all 0.2s ease;
      line-height: 1;
      min-width: 40px;
      text-align: center;
      user-select: none;
    }
    .star:hover, .star.active { color: #FF9800; transform: scale(1.05); }
    .rating-text { font-size: 0.9rem; color: var(--text2); font-style: italic; }
    .comment-input { margin-bottom: 20px; }
    .comment-input textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--nav-shadow);
      border-radius: 8px;
      background: var(--input-bg);
      color: var(--input-text);
      font-size: 0.95rem;
      resize: vertical;
      transition: all 0.3s ease;
      min-height: 100px;
      font-family: inherit;
    }
    .comment-input textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1); }
    .char-count { text-align: right; font-size: 0.8rem; color: var(--text2); margin-top: 4px; }
    .form-actions { display: flex; gap: 12px; align-items: center; }
    .submit-review-btn {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 120px;
      min-height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .submit-review-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255, 152, 0, 0.3); }
    .cancel-edit-btn { background: var(--nav-bg); color: var(--white); border: 1px solid var(--nav-shadow); min-height: 44px; }
    .auth-prompt { text-align: center; padding: 30px 20px; color: var(--text2); }
    .auth-icon { font-size: 3rem; margin-bottom: 15px; opacity: 0.7; }
    .auth-link { color: var(--accent); text-decoration: none; font-weight: 600; }
    .auth-link:hover { text-decoration: underline; }
    .reviews-loading, .reviews-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--text2);
      font-style: italic;
    }
    .reviews-empty { background: var(--card); border-radius: 12px; border: 1px solid var(--nav-shadow); }
    .reviews-sort-controls {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      margin-bottom: 20px;
      gap: 12px;
    }
    .sort-label { font-size: 0.9rem; color: var(--text2); }
    .sort-select {
      background: var(--card);
      border: 1px solid var(--nav-shadow);
      color: var(--white);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    .sort-select:hover { border-color: var(--accent); }
    .sort-select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1); }
    @media (max-width: 900px) {
      .nav-container { flex-wrap: wrap; }
      .nav-right { width: 100%; flex-wrap: wrap; justify-content: flex-end; }
      .nav-search { width: 100%; order: 10; }
      .nav-search-input { width: 100%; }
      .wrap { grid-template-columns: 1fr; }
      .poster {
        width: min(62vw, 240px);
        max-width: 240px;
        margin: 0 auto 6px;
        justify-self: center;
      }
    }
  </style>
</head>
<body>
  <header class="nav" role="banner">
    <div class="nav-container">
      <img src="images/logo.png" alt="Zo2y" class="logo" onclick="location.href='index.html'" width="160" height="40" decoding="async" fetchpriority="high">
      <div class="nav-right">
        <div class="nav-search">
          <input id="pageSearchInput" class="nav-search-input" type="search" placeholder="Search games..." aria-label="Search games">
          <button id="pageSearchBtn" class="nav-search-btn" type="button" aria-label="Search games"><i class="fas fa-search"></i></button>
          <div id="pageSearchSuggest" class="search-suggest"></div>
        </div>
        <a class="ghost" href="games.html">Games</a>
        <a class="ghost" href="restraunts.html">Restaurants</a>
        <a class="ghost" href="index.html">Home</a>
        <button class="account-btn" id="userAccountBtn"><i class="fas fa-user"></i><span>Account</span></button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <img id="poster" class="poster" src="images/placeholder.jpg" alt="Poster">
    <div class="card">
      <div class="title-row">
        <h1 id="title" class="title">Loading...</h1>
        <div class="menu-wrapper">
          <button class="menu-btn" id="movieMenuBtn" aria-label="Save to lists"><i class="fas fa-ellipsis-v"></i></button>
          <div class="list-menu" id="movieListMenu">
            <div class="list-menu-title">Save to list</div>
            <button class="list-action" data-list="favorites"><span><i class="fas fa-heart"></i> Favorites</span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="watched"><span><i class="fas fa-eye"></i> Played </span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="watchlist"><span><i class="fas fa-bookmark"></i> Backlog </span><span class="list-action-state">Add</span></button>
            <button class="list-action" data-list="custom"><span><i class="fas fa-list"></i> Custom Lists</span><span class="list-action-state">Open</span></button>
          </div>
        </div>
      </div>
      <div id="meta" class="meta"></div>
      <div id="tags"></div>
      <p id="overview" class="overview"></p>
      <div class="meta-grid" id="metaGrid"></div>
      <h3 class="section-title">Details</h3>
      <div id="details" class="list-stack"></div>
      <h3 class="section-title">Clip</h3>
      <div id="trailer"></div>
      <h3 class="section-title">Developers</h3>
      <div id="directors" class="people-list"></div>
      <h3 class="section-title">Publishers</h3>
      <div id="writers" class="people-list"></div>
      <h3 class="section-title">Platforms</h3>
      <div id="cast" class="people-list"></div>
    </div>
  </div>

  <section id="reviews-section" class="section reviews">
    <h2>Game Reviews</h2>
    <div class="reviews-sort-controls" id="reviewsSortControls" style="display: none;">
      <span class="sort-label">Sort by:</span>
      <select class="sort-select" id="sortSelect">
        <option value="latest">Latest</option>
        <option value="highest">Highest Rated</option>
        <option value="lowest">Lowest Rated</option>
      </select>
    </div>
    <div class="reviews-stats" id="reviewsStats">
      <div class="reviews-loading">Loading reviews...</div>
    </div>
    <div class="reviews-container" id="reviewsList"></div>
    <div class="review-form-section">
      <h3>Share Your Thoughts</h3>
      <form id="review-form" style="display: none;">
        <div class="rating-input">
          <label>Your Rating:</label>
          <div class="stars-rating">
            <span class="star" data-rating="1">★</span>
            <span class="star" data-rating="2">★</span>
            <span class="star" data-rating="3">★</span>
            <span class="star" data-rating="4">★</span>
            <span class="star" data-rating="5">★</span>
          </div>
          <span class="rating-text" id="ratingText">Select your rating</span>
        </div>
        <div class="comment-input">
          <textarea id="review-comment" placeholder="What did you think of this game?" rows="4" maxlength="500"></textarea>
          <div class="char-count">
            <span id="charCount">0</span>/500 characters
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn submit-review-btn">
            <span class="btn-text">Submit Review</span>
          </button>
          <button type="button" class="btn secondary cancel-edit-btn" style="display: none;">Cancel Edit</button>
        </div>
      </form>
      <div id="auth-prompt" class="auth-prompt">
        <div class="auth-icon"><i class="fas fa-lock"></i></div>
        <p>Please <a href="login.html" class="auth-link">sign in</a> to review games</p>
      </div>
    </div>
  </section>

  <div class="modal" id="movieListsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">Custom Game Lists</div>
        <button class="modal-close" id="closeGameListsBtn">&times;</button>
      </div>
      <div class="modal-list" id="movieListsContainer"></div>
      <div class="modal-input">
        <input type="text" id="newGameListName" placeholder="New list name..." maxlength="50">
        <button class="btn" id="createGameListBtn">Create</button>
      </div>
      <div class="icon-options" id="movieListIconOptions">
        <button class="icon-option selected" data-icon="fas fa-gamepad"><i class="fas fa-gamepad"></i></button>
        <button class="icon-option" data-icon="fas fa-heart"><i class="fas fa-heart"></i></button>
        <button class="icon-option" data-icon="fas fa-star"><i class="fas fa-star"></i></button>
        <button class="icon-option" data-icon="fas fa-bookmark"><i class="fas fa-bookmark"></i></button>
        <button class="icon-option" data-icon="fas fa-eye"><i class="fas fa-eye"></i></button>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
        <button class="btn" id="saveGameListsBtn">Save Changes</button>
      </div>
    </div>
  </div>

    <script src="js/list-utils.js"></script>
    <script src="js/igdb-client.js"></script>
    <script>
    (function () {
      const SUPABASE_URL = 'https://gfkhjbztayjyojsgdpgk.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdma2hqYnp0YXlqeW9qc2dkcGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAwOTYyNjQsImV4cCI6MjA3NTY3MjI2NH0.WUb2yDAwCeokdpWCPeH13FE8NhWF6G8e6ivTsgu6b2s';
      const IGDB_PROXY_BASE = '/api/igdb';
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const gameId = id ? Number(id) : null;
      let supabaseClient = null;
      let currentUser = null;
      let currentRating = 0;
      let editingReviewId = null;
      let reviews = [];
      let currentSort = 'latest';
      const listStatus = { favorites: false, watched: false, watchlist: false };
      let customLists = [];
      let modalSelectedLists = new Set();
      let selectedIcon = 'fas fa-gamepad';

      async function igdbFetch(path, params = {}) {
        if (window.ZO2Y_IGDB && typeof window.ZO2Y_IGDB.request === 'function') {
          return window.ZO2Y_IGDB.request(path, params);
        }
        const url = new URL(IGDB_PROXY_BASE + path, window.location.origin);
        Object.entries(params).forEach(([k, v]) => {
          if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
        });
        const res = await fetch(url.toString());
        if (!res.ok) throw new Error('IGDB error');
        return res.json();
      }

      function showNotification(message, type = 'info', duration = 3000) {
        const existing = document.querySelectorAll('.notification');
        existing.forEach(n => n.remove());
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), duration);
      }

      function renderListIcon(icon) {
        if (window.ListUtils) return ListUtils.renderListIcon(icon, 'fas fa-gamepad');
        if (!icon) return '<i class="fas fa-gamepad"></i>';
        if (icon.includes('fa-')) return `<i class="${icon}"></i>`;
        return icon;
      }

      async function initSupabase() {
        if (typeof supabase === 'undefined') {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        if (typeof supabase === 'undefined') return null;
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return supabaseClient;
      }

      async function initAuth() {
        if (!supabaseClient) return;
        const { data: { user } } = await supabaseClient.auth.getUser();
        currentUser = user || null;
        updateAccountButton();
        renderReviewForm();
        await loadListStatus();
        supabaseClient.auth.onAuthStateChange((_event, session) => {
          currentUser = session?.user || null;
          updateAccountButton();
          renderReviewForm();
          loadListStatus();
        });
      }

      function updateAccountButton() {
        const btn = document.getElementById('userAccountBtn');
        if (!btn) return;
        if (currentUser) {
          btn.classList.add('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Profile</span>';
          btn.onclick = () => window.location.href = 'profile.html';
        } else {
          btn.classList.remove('logged-in');
          btn.innerHTML = '<i class="fas fa-user"></i><span>Account</span>';
          btn.onclick = () => window.location.href = 'login.html';
        }
      }

      async function load() {
        if (!id) return;
        const data = await igdbFetch(`/games/${id}`);
        const description = data.description_raw || (data.description || '').replace(/<[^>]+>/g, '').trim();
        document.getElementById('title').textContent = data.name || 'Untitled';
        document.getElementById('overview').textContent = description || 'No description available.';
        document.getElementById('meta').textContent = `${data.released || ''}${data.playtime ? ` • ${data.playtime} hrs` : ''}`;
        document.getElementById('poster').src = data.cover || 'images/placeholder.jpg';
        const tags = document.getElementById('tags');
        if (tags && Array.isArray(data.genres)) {
          tags.innerHTML = data.genres.map(g => `<span class="tag">${g.name}</span>`).join('');
        }
        const metaGrid = document.getElementById('metaGrid');
        if (metaGrid) {
          const items = [];
          if (typeof data.rating === 'number') items.push(`Rating: ${data.rating.toFixed(1)} (${data.ratings_count || 0})`);
          if (typeof data.metacritic === 'number') items.push(`Metacritic: ${data.metacritic}`);
          if (data.esrb_rating?.name) items.push(`ESRB: ${data.esrb_rating.name}`);
          if (data.platforms?.length) items.push(`Platforms: ${data.platforms.map(p => p.platform?.name).filter(Boolean).slice(0, 4).join(', ')}`);
          if (data.released) items.push(`Released: ${data.released}`);
          metaGrid.innerHTML = items.map(i => `<div class="meta-item">${i}</div>`).join('');
        }
        const detailsEl = document.getElementById('details');
        if (detailsEl) {
          const detailRows = [];
          if (data.developers?.length) detailRows.push(`<div class="list-row"><span class="list-label">Developers:</span> ${data.developers.map(d => d.name).join(', ')}</div>`);
          if (data.publishers?.length) detailRows.push(`<div class="list-row"><span class="list-label">Publishers:</span> ${data.publishers.map(p => p.name).join(', ')}</div>`);
          if (data.stores?.length) detailRows.push(`<div class="list-row"><span class="list-label">Stores:</span> ${data.stores.map(s => s.store?.name).filter(Boolean).slice(0, 4).join(', ')}</div>`);
          if (data.website) detailRows.push(`<div class="list-row"><span class="list-label">Website:</span> <a class="tag" href="${data.website}" target="_blank" rel="noopener">Open</a></div>`);
          if (data.reddit_url) detailRows.push(`<div class="list-row"><span class="list-label">Reddit:</span> <a class="tag" href="${data.reddit_url}" target="_blank" rel="noopener">Open</a></div>`);
          detailsEl.innerHTML = detailRows.length ? detailRows.join('') : '<div class="list-row">No extra details available.</div>';
        }
        const trailerEl = document.getElementById('trailer');
        if (trailerEl) {
          if (data.clip?.clip) {
            trailerEl.innerHTML = `<video class="video-frame" controls src="${data.clip.clip}"></video>`;
          } else if (data.youtube_url) {
            const youtubeUrl = String(data.youtube_url || '');
            const match = youtubeUrl.match(/[?&]v=([^&]+)/) || youtubeUrl.match(/youtu\.be\/([^?&]+)/);
            const videoId = match ? match[1] : '';
            trailerEl.innerHTML = videoId
              ? `<iframe class="video-frame" src="https://www.youtube.com/embed/${encodeURIComponent(videoId)}" title="Game trailer" frameborder="0" allowfullscreen></iframe>`
              : '<div class="meta-item">No trailer available.</div>';
          } else {
            trailerEl.innerHTML = '<div class="meta-item">No trailer available.</div>';
          }
        }
        const developers = (data.developers || []).map(d => d.name);
        const publishers = (data.publishers || []).map(p => p.name);
        const platforms = (data.platforms || []).map(p => p.platform?.name).filter(Boolean);
        const directorsEl = document.getElementById('directors');
        if (directorsEl) {
          directorsEl.innerHTML = developers.length ? developers.map(n => `<span class="person-chip">${n}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
        const writersEl = document.getElementById('writers');
        if (writersEl) {
          writersEl.innerHTML = publishers.length ? publishers.map(n => `<span class="person-chip">${n}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
        const castEl = document.getElementById('cast');
        if (castEl) {
          castEl.innerHTML = platforms.length ? platforms.map(n => `<span class="person-chip">${n}</span>`).join('') : '<span class="person-chip">N/A</span>';
        }
      }

      function ensureListMenuBackdrop() {
        let backdrop = document.getElementById('listMenuBackdrop');
        if (!backdrop) {
          backdrop = document.createElement('div');
          backdrop.id = 'listMenuBackdrop';
          backdrop.className = 'list-menu-backdrop';
          backdrop.addEventListener('click', closeAllListMenus);
          document.body.appendChild(backdrop);
        }
        return backdrop;
      }

      function showListMenuBackdrop() {
        const backdrop = ensureListMenuBackdrop();
        backdrop.classList.add('active');
      }

      function hideListMenuBackdrop() {
        const backdrop = document.getElementById('listMenuBackdrop');
        if (backdrop) backdrop.classList.remove('active');
      }

      function closeAllListMenus() {
        const menu = document.getElementById('movieListMenu');
        if (menu) menu.classList.remove('open');
        hideListMenuBackdrop();
      }

      function wireListMenu() {
        const menuBtn = document.getElementById('movieMenuBtn');
        const menu = document.getElementById('movieListMenu');
        if (!menuBtn || !menu) return;
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const wasOpen = menu.classList.contains('open');
          closeAllListMenus();
          if (!wasOpen) {
            menu.classList.add('open');
            showListMenuBackdrop();
          }
        });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.menu-wrapper') && !e.target.closest('.list-menu')) {
            closeAllListMenus();
          }
        });
        menu.querySelectorAll('.list-action').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            const listType = btn.getAttribute('data-list');
            if (listType === 'custom') {
              closeAllListMenus();
              openGameListsModal();
              return;
            }
            await toggleList(listType);
            closeAllListMenus();
          });
        });
      }

      async function loadListStatus() {
        if (!supabaseClient || !currentUser || !gameId) return;
        const { data, error } = await supabaseClient
          .from('game_list_items')
          .select('list_type')
          .eq('user_id', currentUser.id)
          .eq('game_id', gameId);
        if (error) return;
        listStatus.favorites = false;
        listStatus.watched = false;
        listStatus.watchlist = false;
        (data || []).forEach(item => {
          if (listStatus[item.list_type] !== undefined) {
            listStatus[item.list_type] = true;
          }
        });
        updateListMenuUI();
      }

      async function loadCustomLists() {
        if (!supabaseClient || !currentUser || !window.ListUtils) return [];
        return await ListUtils.loadCustomLists(supabaseClient, currentUser.id, 'game');
      }

      async function openGameListsModal() {
        if (!currentUser) {
          showNotification('Please sign in to manage lists', 'info');
          return;
        }
        const modal = document.getElementById('movieListsModal');
        const container = document.getElementById('movieListsContainer');
        if (!modal || !container) return;
        container.innerHTML = '<div class="chip">Loading...</div>';
        customLists = await loadCustomLists();
        const listIds = customLists.map(l => l.id);
        modalSelectedLists = window.ListUtils
          ? await ListUtils.loadCustomListMembership(supabaseClient, currentUser.id, 'game', gameId, listIds)
          : new Set();
        container.innerHTML = '';
        if (!customLists.length) {
          container.innerHTML = '<div class="chip">No custom lists yet.</div>';
        } else {
          customLists.forEach(list => {
            const item = document.createElement('div');
            item.className = 'modal-list-item' + (modalSelectedLists.has(list.id) ? ' active' : '');
            item.innerHTML = `
              <span>${renderListIcon(list.icon)} ${list.title}</span>
              <span class="modal-list-actions">
                <span>${modalSelectedLists.has(list.id) ? 'Saved' : 'Add'}</span>
                <button class="list-edit-btn" aria-label="Rename list"><i class="fas fa-pen"></i></button>
              </span>
            `;
            item.onclick = () => {
              if (modalSelectedLists.has(list.id)) {
                modalSelectedLists.delete(list.id);
              } else {
                modalSelectedLists.add(list.id);
              }
              item.classList.toggle('active');
              item.querySelector('.modal-list-actions span').textContent = modalSelectedLists.has(list.id) ? 'Saved' : 'Add';
            };
            const editBtn = item.querySelector('.list-edit-btn');
            if (editBtn) {
              editBtn.onclick = (e) => {
                e.stopPropagation();
                renameGameList(list.id, list.title);
              };
            }
            container.appendChild(item);
          });
        }
        modal.classList.add('active');
      }

      async function saveGameListChanges() {
        if (!supabaseClient || !currentUser || !gameId) return;
        if (window.ListUtils) {
          await ListUtils.saveCustomListChanges(
            supabaseClient,
            currentUser.id,
            'game',
            gameId,
            [...modalSelectedLists]
          );
        }
        showNotification('Lists updated', 'success');
        closeGameListsModal();
      }

      function closeGameListsModal() {
        const modal = document.getElementById('movieListsModal');
        if (modal) modal.classList.remove('active');
      }

      async function createGameList() {
        const input = document.getElementById('newGameListName');
        if (!input || !input.value.trim()) return;
        if (!supabaseClient || !currentUser) return;
        const title = input.value.trim();
        const data = window.ListUtils
          ? await ListUtils.createCustomList(supabaseClient, currentUser.id, 'game', {
            title,
            icon: selectedIcon || 'fas fa-gamepad'
          })
          : null;
        if (!data) {
          showNotification('Could not create list', 'error');
          return;
        }
        input.value = '';
        customLists.unshift(data);
        openGameListsModal();
      }

      async function renameGameList(listId, currentTitle) {
        const nextTitle = prompt('Rename list', currentTitle || '');
        if (!nextTitle || !nextTitle.trim()) return;
        if (!supabaseClient || !currentUser) return;
        const ok = window.ListUtils
          ? await ListUtils.renameCustomList(supabaseClient, currentUser.id, 'game', listId, nextTitle.trim())
          : false;
        if (!ok) {
          showNotification('Could not rename list', 'error');
          return;
        }
        customLists = customLists.map(l => l.id === listId ? { ...l, title: nextTitle.trim() } : l);
        openGameListsModal();
      }

      function updateListMenuUI() {
        const menu = document.getElementById('movieListMenu');
        if (!menu) return;
        menu.querySelectorAll('.list-action').forEach(btn => {
          const listType = btn.getAttribute('data-list');
          const isActive = !!listStatus[listType];
          btn.classList.toggle('active', isActive);
          const state = btn.querySelector('.list-action-state');
          if (state) state.textContent = isActive ? 'Remove' : 'Add';
        });
      }

      async function toggleList(listType) {
        if (!currentUser) {
          showNotification('Please sign in to save games', 'info');
          return;
        }
        if (!gameId) return;
        const isInList = listStatus[listType];
        if (isInList) {
          const { error } = await supabaseClient
            .from('game_list_items')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('game_id', gameId)
            .eq('list_type', listType);
          if (!error) {
            listStatus[listType] = false;
            updateListMenuUI();
            showNotification('Removed from list', 'info');
          }
        } else {
          const { error } = await supabaseClient
            .from('game_list_items')
            .insert({ user_id: currentUser.id, game_id: gameId, list_type: listType });
          if (!error) {
            listStatus[listType] = true;
            updateListMenuUI();
            showNotification('Saved to list', 'success');
          }
        }
      }

      async function initReviewSystem() {
        if (!supabaseClient || !gameId) return;
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
          sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            sortAndRenderReviews();
          });
        }
        const reviewForm = document.getElementById('review-form');
        if (reviewForm) {
          reviewForm.addEventListener('submit', submitReview);
        }
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', () => resetReviewForm());
        }
        const commentTextarea = document.getElementById('review-comment');
        if (commentTextarea) {
          commentTextarea.addEventListener('input', () => {
            const count = document.getElementById('charCount');
            if (count) count.textContent = String(commentTextarea.value.length);
          });
        }
        document.querySelectorAll('.star').forEach(star => {
          star.addEventListener('click', () => {
            currentRating = parseInt(star.dataset.rating, 10);
            updateStarDisplay();
          });
        });
        await loadReviews();
      }

      function renderReviewForm() {
        const form = document.getElementById('review-form');
        const prompt = document.getElementById('auth-prompt');
        if (!form || !prompt) return;
        if (currentUser) {
          form.style.display = 'block';
          prompt.style.display = 'none';
        } else {
          form.style.display = 'none';
          prompt.style.display = 'block';
        }
      }

      async function loadReviews() {
        const container = document.getElementById('reviewsList');
        const statsContainer = document.getElementById('reviewsStats');
        if (!container || !statsContainer || !supabaseClient) return;
        container.innerHTML = '<div class="reviews-loading">Loading reviews...</div>';
        const { data, error } = await supabaseClient
          .from('game_reviews')
          .select('*')
          .eq('game_id', gameId)
          .order('created_at', { ascending: false });
        if (error) {
          container.innerHTML = '<div class="reviews-empty">Error loading reviews.</div>';
          statsContainer.innerHTML = '<div class="reviews-empty">Error loading stats.</div>';
          return;
        }
        reviews = data || [];
        if (reviews.length === 0) {
          container.innerHTML = '<div class="reviews-empty">No reviews yet. Be the first to share your thoughts!</div>';
          statsContainer.innerHTML = '<div class="reviews-empty">No reviews yet</div>';
          return;
        }
        const totalReviews = reviews.length;
        const averageRating = reviews.reduce((sum, review) => sum + review.rating, 0) / totalReviews;
        const ratingDistribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
        reviews.forEach(review => ratingDistribution[review.rating]++);
        statsContainer.innerHTML = `
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value">${averageRating.toFixed(1)}</div>
              <div class="stat-label">Average Rating</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${totalReviews}</div>
              <div class="stat-label">Total Reviews</div>
            </div>
            <div class="stat-item">
              <div class="stat-value">${Math.round((ratingDistribution[5] / totalReviews) * 100)}%</div>
              <div class="stat-label">5-Star Reviews</div>
            </div>
          </div>
          <div class="rating-breakdown">
            ${[5,4,3,2,1].map(stars => `
              <div class="rating-row">
                <div class="rating-stars">${'?'.repeat(stars)}</div>
                <div class="rating-bar">
                  <div class="rating-fill" style="width: ${(ratingDistribution[stars] / totalReviews) * 100}%"></div>
                </div>
                <div class="rating-count">${ratingDistribution[stars]}</div>
              </div>
            `).join('')}
          </div>
        `;
        document.getElementById('reviewsSortControls').style.display = 'flex';
        sortAndRenderReviews();
      }

      function sortAndRenderReviews() {
        if (!reviews || reviews.length === 0) return;
        let sorted = [...reviews];
        if (currentSort === 'highest') sorted.sort((a, b) => b.rating - a.rating);
        if (currentSort === 'lowest') sorted.sort((a, b) => a.rating - b.rating);
        displayReviews(sorted);
      }

      async function displayReviews(reviewsToDisplay) {
        const container = document.getElementById('reviewsList');
        if (!container) return;
        if (!reviewsToDisplay || reviewsToDisplay.length === 0) {
          container.innerHTML = '<div class="reviews-empty">No reviews yet.</div>';
          return;
        }
        const userIds = [...new Set(reviewsToDisplay.map(r => r.user_id))];
        let userMap = {};
        if (userIds.length && supabaseClient) {
          let users = [];
          const profileSelects = [
            'user_id, id, username, full_name',
            'user_id, username, full_name',
            'user_id, username',
            'user_id, full_name',
            'id, username, full_name',
            'id, username',
            'id, full_name'
          ];
          for (const cols of profileSelects) {
            const { data, error } = await supabaseClient
              .from('user_profiles')
              .select(cols)
              .in(cols.includes('user_id') ? 'user_id' : 'id', userIds);
            if (!error) {
              users = data || [];
              break;
            }
          }
          (users || []).forEach(u => {
            const key = u.user_id || u.id;
            if (key) userMap[key] = u;
          });
        }
        const escapeHtml = (v) => String(v ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
        container.innerHTML = reviewsToDisplay.map(review => {
          const user = userMap[review.user_id];
          const reviewUsernameRaw = String(review?.username || review?.user_name || '').trim();
          const isAutoUsername = /^user-[a-f0-9]{6,}$/i.test(reviewUsernameRaw);
          const reviewUsername = isAutoUsername ? '' : reviewUsernameRaw;
          const username = String(user?.username || reviewUsername).trim();
          const fallbackName = String(user?.full_name || '').trim();
          const displayName = username ? `@${username}` : (fallbackName || 'User');
          const initialsBase = username || fallbackName || 'User';
          const initials = initialsBase.split(/\s+/).map(n => n[0]).slice(0, 2).join('').toUpperCase();
          const profileHref = `profile.html?id=${encodeURIComponent(review.user_id)}`;
          const canEditDelete = currentUser && currentUser.id === review.user_id;
          return `
            <div class="review-card" id="review-${review.id}">
              <div class="review-header">
                <div class="reviewer-info">
                  <a class="reviewer-avatar reviewer-link" href="${profileHref}" aria-label="View ${escapeHtml(displayName)} profile">${escapeHtml(initials)}</a>
                  <div>
                    <div class="reviewer-name"><a class="reviewer-link" href="${profileHref}">${escapeHtml(displayName)}</a></div>
                    <div class="review-date">${new Date(review.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}</div>
                  </div>
                </div>
                <div class="review-rating">${'\u2605'.repeat(review.rating)}${'\u2606'.repeat(5 - review.rating)}</div>
              </div>
              <p class="review-comment">${escapeHtml(review.comment || '')}</p>
              ${canEditDelete ? `
                <div class="review-actions">
                  <button class="review-edit" onclick="editReview('${review.id}')">Edit</button>
                  <button class="review-delete" onclick="deleteReview('${review.id}')">Delete</button>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      }

      function updateStarDisplay() {
        const stars = document.querySelectorAll('.star');
        const ratingText = document.getElementById('ratingText');
        stars.forEach(star => {
          const starRating = parseInt(star.dataset.rating, 10);
          star.classList.toggle('active', starRating <= currentRating);
        });
        const ratingTexts = ['Select your rating', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
        if (ratingText) ratingText.textContent = ratingTexts[currentRating] || 'Select your rating';
      }

      async function submitReview(e) {
        e.preventDefault();
        if (!currentUser) {
          showNotification('Please sign in to submit a review', 'info');
          return;
        }
        const comment = document.getElementById('review-comment').value.trim();
        if (!currentRating) {
          showNotification('Please select a rating', 'info');
          return;
        }
        const payload = { game_id: gameId, user_id: currentUser.id, rating: currentRating, comment };
        let error = null;
        if (editingReviewId) {
          const { error: updateError } = await supabaseClient
            .from('game_reviews')
            .update(payload)
            .eq('id', editingReviewId);
          error = updateError;
        } else {
          const { error: insertError } = await supabaseClient
            .from('game_reviews')
            .insert(payload);
          error = insertError;
        }
        if (error) {
          showNotification('Error submitting review', 'error');
          return;
        }
        resetReviewForm();
        await loadReviews();
        showNotification('Review saved', 'success');
      }

      window.editReview = async function (reviewId) {
        if (!supabaseClient) return;
        const { data: review } = await supabaseClient
          .from('game_reviews')
          .select('*')
          .eq('id', reviewId)
          .single();
        if (!review) return;
        editingReviewId = reviewId;
        currentRating = review.rating;
        document.getElementById('review-comment').value = review.comment || '';
        updateStarDisplay();
        const submitText = document.querySelector('.submit-review-btn .btn-text');
        if (submitText) submitText.textContent = 'Update Review';
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) cancelBtn.style.display = 'inline-flex';
      };

      window.deleteReview = async function (reviewId) {
        if (!currentUser) {
          showNotification('Please sign in to delete reviews', 'info');
          return;
        }
        if (!confirm('Delete this review?')) return;
        const { error } = await supabaseClient
          .from('game_reviews')
          .delete()
          .eq('id', reviewId);
        if (error) {
          showNotification('Error deleting review', 'error');
          return;
        }
        await loadReviews();
        showNotification('Review deleted', 'success');
      };

      function resetReviewForm() {
        editingReviewId = null;
        currentRating = 0;
        const form = document.getElementById('review-form');
        if (form) form.reset();
        updateStarDisplay();
        const submitText = document.querySelector('.submit-review-btn .btn-text');
        if (submitText) submitText.textContent = 'Submit Review';
        const cancelBtn = document.querySelector('.cancel-edit-btn');
        if (cancelBtn) cancelBtn.style.display = 'none';
        const count = document.getElementById('charCount');
        if (count) count.textContent = '0';
      }

      function initPageSearch() {
        const input = document.getElementById('pageSearchInput');
        const btn = document.getElementById('pageSearchBtn');
        const suggest = document.getElementById('pageSearchSuggest');
        if (!input || !btn || !suggest) return;
        const esc = (v) => String(v ?? '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        let suggestions = [];
        let activeIndex = -1;
        let debounceTimer = null;
        const go = () => {
          const query = input.value.trim();
          const url = new URL('games.html', window.location.href);
          if (query) url.searchParams.set('search', query);
          window.location.href = `${url.pathname}${url.search}`;
        };
        const closeSuggest = () => {
          suggest.classList.remove('open');
          suggest.innerHTML = '';
          suggestions = [];
          activeIndex = -1;
        };
        const renderSuggest = () => {
          if (!suggestions.length) {
            closeSuggest();
            return;
          }
          suggest.innerHTML = suggestions.map((item, idx) => `
            <button class="search-suggest-item${idx === activeIndex ? ' active' : ''}" data-idx="${idx}" type="button">
              <img class="search-suggest-thumb" src="${esc(item.image || 'images/logo.png')}" alt="" loading="lazy" onerror="this.onerror=null;this.src='images/logo.png';">
              <span>
                <span class="search-suggest-title">${esc(item.title)}</span>
                <span class="search-suggest-sub">${esc(item.sub)}</span>
              </span>
            </button>
          `).join('');
          suggest.classList.add('open');
          suggest.querySelectorAll('.search-suggest-item').forEach((el) => {
            el.addEventListener('click', () => {
              const idx = Number(el.getAttribute('data-idx'));
              const selected = suggestions[idx];
              if (!selected) return;
              input.value = selected.title;
              closeSuggest();
              window.location.href = `game.html?id=${encodeURIComponent(selected.id)}`;
            });
          });
        };
        const fetchSuggest = async (query) => {
          const q = query.trim();
          if (q.length < 2) {
            closeSuggest();
            return;
          }
          try {
            const json = await igdbFetch('/games', { search: q, page_size: 6 });
            suggestions = (json.results || []).slice(0, 6).map((g) => ({
              id: g.id,
              title: g.name || 'Game',
              sub: g.released ? String(g.released).slice(0, 4) : 'Game',
              image: g.cover || ''
            }));
            activeIndex = -1;
            renderSuggest();
          } catch (_e) {
            closeSuggest();
          }
        };
        btn.addEventListener('click', go);
        input.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => fetchSuggest(input.value), 180);
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowDown') {
            if (!suggestions.length) return;
            e.preventDefault();
            activeIndex = (activeIndex + 1) % suggestions.length;
            renderSuggest();
            return;
          }
          if (e.key === 'ArrowUp') {
            if (!suggestions.length) return;
            e.preventDefault();
            activeIndex = activeIndex <= 0 ? suggestions.length - 1 : activeIndex - 1;
            renderSuggest();
            return;
          }
          if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIndex >= 0 && suggestions[activeIndex]) {
              window.location.href = `game.html?id=${encodeURIComponent(suggestions[activeIndex].id)}`;
              return;
            }
            go();
          }
          if (e.key === 'Escape') closeSuggest();
        });
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.nav-search')) closeSuggest();
        });
      }

      (async function init() {
        await initSupabase();
        initPageSearch();
        wireListMenu();
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') closeAllListMenus();
        });
        const closeListsBtn = document.getElementById('closeGameListsBtn');
        const saveListsBtn = document.getElementById('saveGameListsBtn');
        const createListBtn = document.getElementById('createGameListBtn');
        const iconOptions = document.querySelectorAll('#movieListIconOptions .icon-option');
        if (closeListsBtn) closeListsBtn.addEventListener('click', closeGameListsModal);
        if (saveListsBtn) saveListsBtn.addEventListener('click', saveGameListChanges);
        if (createListBtn) createListBtn.addEventListener('click', createGameList);
        iconOptions.forEach(btn => {
          btn.addEventListener('click', () => {
            iconOptions.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedIcon = btn.getAttribute('data-icon') || 'fas fa-gamepad';
          });
        });
        await initAuth();
        await load();
        await initReviewSystem();
      })();
    })();
  </script>
</body>
</html>

